<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>LZPACK.INC</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; =========================  LZ77  PACKER   =========================</span><span class="sc0">
</span><span class="sc1">; ==========================  Made in SMF  ==========================</span><span class="sc0">
</span><span class="sc1">; In : ESI=packed data</span><span class="sc0">
</span><span class="sc1">;      EDI=LpBuffer 4 unpacked data</span><span class="sc0">
</span><span class="sc1">; Out: Buffer=unpacked data</span><span class="sc0">
</span><span class="sc1">;====================== LZ77 family unpacker ==========================</span><span class="sc0">
</span><span class="sc5">unpack</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">jmp_</span><span class="sc0">  </span><span class="sc5">Errorret</span><span class="sc0">
</span><span class="sc5">@unpack</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">unlzlp</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc5">je_</span><span class="sc0">  </span><span class="sc5">unlzret</span><span class="sc0"> </span><span class="sc1">; zero = end of packed data</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">lzref</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">; simply copy some bytes from in to out</span><span class="sc0">
        </span><span class="sc5">jmp_</span><span class="sc0">  </span><span class="sc5">unlzlp</span><span class="sc0">
</span><span class="sc5">lzref</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; processing data reference</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0"> </span><span class="sc1">; load reference offset (low 8 bits)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">; copy some bytes from already unpacked data</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc5">jmp_</span><span class="sc0">  </span><span class="sc5">unlzlp</span><span class="sc0">
</span><span class="sc5">unlzret</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">jmp_</span><span class="sc0"> </span><span class="sc5">@unlzret</span><span class="sc0">
</span><span class="sc5">Errorret</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@unpack</span><span class="sc0">
    </span><span class="sc1">; ====================== unpacker end ============================</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@unlzret</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
           </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;dwSizepackedData=LZPack(plength,packed,unplen,unpacked)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ======================== LZ77 PACKER ==============================</span><span class="sc0">
</span><span class="sc1">;       packs buffer ([unpacked],size=[unplen]), to ([packed],size=[plength])</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;               registers alloc:</span><span class="sc0">
</span><span class="sc1">;                       al=first byte from source pointer</span><span class="sc0">
</span><span class="sc1">;                       edx=data register</span><span class="sc0">
</span><span class="sc1">;                       ebp=for saving search pointer</span><span class="sc0">
</span><span class="sc1">;                       ebx=for saving maximal length</span><span class="sc0">
</span><span class="sc1">;                       esi=source pointer</span><span class="sc0">
</span><span class="sc1">;                       edi=search pointer</span><span class="sc0">
</span><span class="sc1">;                       ecx=end of source pointer (bounds)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LZPack</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">StackFrame</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">128</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">StackFrame</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc1">;---------------</span><span class="sc0">
        </span><span class="sc5">unpacked</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">+</span><span class="sc5">StackFrame</span><span class="sc0">
        </span><span class="sc5">unplen</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">unpacked</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc5">packed</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">unplen</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc5">plength</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">packed</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc1">;---------------</span><span class="sc0">
        </span><span class="sc5">retEIP</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">plength</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc1">;---------------</span><span class="sc0">
        </span><span class="sc5">result</span><span class="sc0">   </span><span class="sc9">eqU</span><span class="sc0"> </span><span class="sc5">retEIP</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc5">buf</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">result</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc5">maxofs</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">buf</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc5">RegEBP</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">maxofs</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc5">Buffer</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">RegEBP</span><span class="sc4">-</span><span class="sc2">128</span><span class="sc0">
        </span><span class="sc1">;----------------------------------------</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">unpacked</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; seek source pointer to start of source</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">packed</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">result</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; zero result buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc1">;offset buffer ;!!!</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buf</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">nomatch</span><span class="sc0"> </span><span class="sc1">; start with storing first symbol to buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">result</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">packed</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">plength</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">StackFrame</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">lzloop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">unpacked</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4094</span><span class="sc0"> </span><span class="sc1">; window size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; maximal found length</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">shrwin</span><span class="sc0"> </span><span class="sc1">; if current pointer in source far then 4095 from start,</span><span class="sc0">
                </span><span class="sc1">; then search from (source-window_size)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; else search from start of source</span><span class="sc0">
</span><span class="sc5">shrwin</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; store source pointer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">unplen</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; now ecx points to last byte of source file</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">lzz0</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get byte from source pointer</span><span class="sc0">
</span><span class="sc5">lzbuf2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">findend</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">lzbuf2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RegEBP</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">lzbuf0</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">fcheck</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">lzbuf0</span><span class="sc0">
</span><span class="sc5">fcheck</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; restore source pointer</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2bh</span><span class="sc4">,</span><span class="sc2">0bdh</span><span class="sc4">,</span><span class="sc2">84h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc1">;sub edi,dword [ebp+RegEBP] ; calculate matched length</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">nomax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc4">,</span><span class="sc2">85h</span><span class="sc4">,</span><span class="sc2">84h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;mov eax,dword [ebp+RegEBP]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">maxofs</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0"> </span><span class="sc1">; if found reference longer than max_ref_len then stop search</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">findend</span><span class="sc0">
</span><span class="sc5">nomax</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">80H</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; restore search pointer</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">lzz0</span><span class="sc0">
</span><span class="sc5">findend</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">nomatch</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">flush</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">len_ok1</span><span class="sc0"> </span><span class="sc1">; if reference_length &lt;= 10</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">len_ok1</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">maxofs</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; (offset to maximal matched string) will be there</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; bit7 - denoting a reference</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">putb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">putb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">unplen</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">unpacked</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">  </span><span class="sc5">lzloop</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">lzdone</span><span class="sc0">

</span><span class="sc5">nomatch</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; store al to buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buf</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buf</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">127</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">nofull</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">flush</span><span class="sc0">
</span><span class="sc5">nofull</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">unplen</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">unpacked</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">lzloop</span><span class="sc0">
</span><span class="sc5">lzdone</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">flush</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">putb</span><span class="sc0">

</span><span class="sc1">; ================ FLUSH =======================</span><span class="sc0">
</span><span class="sc1">; flush temporary buffer (can't use esi,ebx,ebp)</span><span class="sc0">
</span><span class="sc5">flush</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buf</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc1">;offset buffer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ret1ptr</span><span class="sc0"> </span><span class="sc1">; buffer is empty</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">putb</span><span class="sc0"> </span><span class="sc1">; store length</span><span class="sc0">
</span><span class="sc5">flm1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">putb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">flm1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buf</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">ret1ptr</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">; ================ PUT BYTE al TO OUTPUT STREAM ================</span><span class="sc0">
</span><span class="sc1">;               can't use esi,ebx,ecx,edi,edx</span><span class="sc0">
</span><span class="sc5">putb</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">result</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">result</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">; ==========================================================================</span><span class="sc0">
</span></div></body>
</html>
