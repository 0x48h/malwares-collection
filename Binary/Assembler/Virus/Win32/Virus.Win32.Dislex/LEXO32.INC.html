<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;lexotan32 metamorphic engine</span><span class="sc0">

</span><span class="sc5">WORKSIZE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">128</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">

</span><span class="sc5">GAP</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">48</span><span class="sc0">

</span><span class="sc5">MAX_RECURSION</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">

</span><span class="sc1">;REMOVE_INT3 equ TRUE</span><span class="sc0">

</span><span class="sc5">grb</span><span class="sc0">    </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">routine</span><span class="sc0">
  </span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">__1</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__1</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">routine</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__nograble</span><span class="sc0">
  </span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">malloc</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">asize</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tmpmem</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tmpmem</span><span class="sc4">],</span><span class="sc5">asize</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">random_value</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd0</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">coin</span><span class="sc0">  </span><span class="sc9">macro</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc5">rnd_carry</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">doublecoin</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">
  </span><span class="sc9">LOCAL</span><span class="sc0"> </span><span class="sc5">zkipz</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc5">rnd_carry</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">zkipz</span><span class="sc0">
       </span><span class="sc5">rnd_carry</span><span class="sc0">
  </span><span class="sc5">zkipz</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">RND_V</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">rnd_carry</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">
       </span><span class="sc5">random_value</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">RND_V</span><span class="sc0">
  </span><span class="sc5">RND_V</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">RND_V</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">


</span><span class="sc5">mixbody</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0">

  </span><span class="sc5">ARG</span><span class="sc0"> </span><span class="sc5">tmpmem</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
  </span><span class="sc5">ARG</span><span class="sc0"> </span><span class="sc5">source1</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
  </span><span class="sc5">ARG</span><span class="sc0"> </span><span class="sc5">isize</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

  </span><span class="sc9">LOCAL</span><span class="sc0"> </span><span class="sc5">changes</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
  </span><span class="sc9">LOCAL</span><span class="sc0"> </span><span class="sc5">recurse</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
  </span><span class="sc9">LOCAL</span><span class="sc0"> </span><span class="sc5">is_nop</span><span class="sc4">:</span><span class="sc10">BYTE</span><span class="sc0">

       </span><span class="sc6">pushad</span><span class="sc0">

       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">recurse</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eip_table_cnt</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">jmp_table_cnt</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NOGARBLE</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">source1</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">source</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc5">malloc</span><span class="sc0"> </span><span class="sc5">WORKSIZE</span><span class="sc4">*</span><span class="sc2">20</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eip_table</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc5">malloc</span><span class="sc0"> </span><span class="sc5">WORKSIZE</span><span class="sc4">*</span><span class="sc2">10</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">jmp_table</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc5">malloc</span><span class="sc0"> </span><span class="sc5">WORKSIZE</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">outbuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">source</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fill_nops</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">WORKSIZE</span><span class="sc4">-</span><span class="sc5">GAP</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

  </span><span class="sc5">@@phase1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">isize</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">source</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;we already processed the whole buffer?</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">@@done_phase1</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">link_eip</span><span class="sc0">

</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">REMOVE_INT3</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0cch</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@skip_instr</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@no_shit</span><span class="sc0">
  </span><span class="sc5">@@skip_instr</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@phase1</span><span class="sc0">

  </span><span class="sc5">@@no_shit</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0f481h</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@no_xoresp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@commandword</span><span class="sc0">
  </span><span class="sc5">@@no_xoresp</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check4jmps</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@insert_nocode</span><span class="sc0">

  </span><span class="sc5">@@commandword</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">disasm</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">disasm_size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

  </span><span class="sc5">@@insert_nocode</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble</span><span class="sc0">

  </span><span class="sc5">@@change_eip</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc5">coin</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@@no_add_jmp</span><span class="sc0">

  </span><span class="sc5">@@do_change</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">change_eip</span><span class="sc0">

  </span><span class="sc5">@@no_add_jmp</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">outbuffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WORKSIZE</span><span class="sc4">-</span><span class="sc5">GAP</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;if too near end of buffer, a JMP is</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">@@do_change</span><span class="sc0">                   </span><span class="sc1">;essencial</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90909090h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GAP</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">scasd</span><span class="sc0">                       </span><span class="sc1">;check 48 bytes forward</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@do_change</span><span class="sc0">                  </span><span class="sc1">;uhh, a used area...</span><span class="sc0">

       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@phase1</span><span class="sc0">


  </span><span class="sc5">@@done_phase1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fix_damn_jmps</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fix_userlist</span><span class="sc0">

       </span><span class="sc5">malloc</span><span class="sc0"> </span><span class="sc5">WORKSIZE</span><span class="sc0">

       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">outbuffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">source</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">isize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WORKSIZE</span><span class="sc0">

  </span><span class="sc5">@@optimize</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">changes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;mark no changes done</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eip_table_cnt</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">jmp_table_cnt</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">is_nop</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">


       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">source</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">outbuffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fill_nops</span><span class="sc0">


  </span><span class="sc5">@@optimize_loop</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">isize</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">source</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">@@optimize_loop_done</span><span class="sc0">                 </span><span class="sc1">;all processed?</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">090h</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@nonop</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">is_nop</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@skip1s</span><span class="sc0">           </span><span class="sc1">;skip da NOP! (no increase coz is in row)</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">is_nop</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">link_eip</span><span class="sc0">            </span><span class="sc1">;first NOP in a row is linked...</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@skip1</span><span class="sc0">              </span><span class="sc1">;skip da NOP! (and increase no. of changes)</span><span class="sc0">
  </span><span class="sc5">@@nonop</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">is_nop</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">link_eip</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@no_jmpb</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@skip5</span><span class="sc0">              </span><span class="sc1">;the JMP jump to the next instruction?</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">is_signed</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@done_jmps</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0eb909090h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@optimize_loop</span><span class="sc0">

  </span><span class="sc5">@@no_jmpb</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ebh</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@no_jmp</span><span class="sc0">
  </span><span class="sc5">@@check_byte4_0</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@done_jmps</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@skip1</span><span class="sc0">

  </span><span class="sc5">@@skip6</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

  </span><span class="sc5">@@skip5</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
  </span><span class="sc5">@@skip4</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
  </span><span class="sc5">@@skip3</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">;skip instruction (4 bytes)</span><span class="sc0">

  </span><span class="sc5">@@skip1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">changes</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;changes were done, so, must</span><span class="sc0">
  </span><span class="sc5">@@skip1s</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@optimize_loop</span><span class="sc0">                      </span><span class="sc1">;have a next loop</span><span class="sc0">

  </span><span class="sc5">@@check_s_jcc</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@done_jmps</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@check_byte4_0</span><span class="sc0">

  </span><span class="sc5">@@no_jmp</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@check_s_jcc</span><span class="sc0">                </span><span class="sc1">;extended opcode?</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01111000000001111b</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@done_jmps</span><span class="sc0">                </span><span class="sc1">;make sure is a JMP?</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@skip6</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">is_signed</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@done_jmps</span><span class="sc0">                </span><span class="sc1">;and can be converted?</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">90909090h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@optimize_loop</span><span class="sc0">

  </span><span class="sc5">@@done_jmps</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check4jmps</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@optimize_loop</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">disasm</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">disasm_size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@optimize_loop</span><span class="sc0">


  </span><span class="sc5">@@optimize_loop_done</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fix_damn_jmps</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fix_userlist</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">source</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">outbuffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">source</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WORKSIZE</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
       </span><span class="sc6">std</span><span class="sc0">
       </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                       </span><span class="sc1">;scan for last NOP</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">scasw</span><span class="sc0">                            </span><span class="sc1">;increase EDI by 2</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">isize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;update new size of data</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">changes</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@optimize</span><span class="sc0">                 </span><span class="sc1">;if we didnt any change, we finished</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">outbuffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">isize</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">mixbody</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc5">check4jmps</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;default 32b displacement</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">                     </span><span class="sc1">;maybe a CALL?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@is_call</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">                     </span><span class="sc1">;is a JMP?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@no_jmp</span><span class="sc0">

  </span><span class="sc5">@@is_call</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">movsb</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
  </span><span class="sc5">@@do_jmp_table</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;ecx is where patch+4</span><span class="sc0">
  </span><span class="sc5">@@no8b</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">source</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;add to</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">jmp_table_cnt</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;offset of referenced instruction</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">jmp_table</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                          </span><span class="sc1">;save patch point</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">jmp_table_cnt</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@processed</span><span class="sc0">

  </span><span class="sc5">@@no_jmp</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@isnt_jcc_near</span><span class="sc0">                   </span><span class="sc1">;extended opcode?</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">011110000b</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                      </span><span class="sc1">;is a near JCC?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@isnt_jcc_near</span><span class="sc0">
       </span><span class="sc6">movsb</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@is_call</span><span class="sc0">

  </span><span class="sc5">@@isnt_jcc_near</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ebh</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@short_shit</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">011110000b</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@short_shit</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@processed2</span><span class="sc0">

  </span><span class="sc5">@@short_shit</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">movsx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@do_jmp_table</span><span class="sc0">

  </span><span class="sc5">@@processed</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">
  </span><span class="sc5">@@processed2</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">link_eip</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                         </span><span class="sc1">;save current edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eip_table</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;table base</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eip_table_cnt</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;index</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;place to put eip/eip</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">outbuffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">source</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                          </span><span class="sc1">;save esi</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eip_table_cnt</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">xref</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eip_table_cnt</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eip_table</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">@@xref_loop</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">js</span><span class="sc0"> </span><span class="sc5">@@found</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@xref_loop</span><span class="sc0">
  </span><span class="sc5">@@equal</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">@@found</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">change_eip</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">WORKSIZE</span><span class="sc4">-</span><span class="sc5">GAP</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">outbuffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;And check if is free</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90909090h</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@no_eip_change</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GAP</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">scasd</span><span class="sc0">                       </span><span class="sc1">;unused space?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@no_eip_change</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GAP</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_edi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;set the new eip</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                    </span><span class="sc1">;displacement</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">            </span><span class="sc1">;build JMP</span><span class="sc0">
  </span><span class="sc5">@@no_eip_change</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">fix_userlist</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">userlist</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">@@next_userptr</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@done_userlist</span><span class="sc0">               </span><span class="sc1">;no more pointers to process? exit...</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">xref</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;update ptr</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@next_userptr</span><span class="sc0">
  </span><span class="sc5">@@done_userlist</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">fix_damn_jmps</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">jmp_table_cnt</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">jmp_table</span><span class="sc4">]</span><span class="sc0">

  </span><span class="sc5">@@fix_jmp</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">jmp_table</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@done_fix_jmp</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">xref</span><span class="sc0">                        </span><span class="sc1">;translate old offset to new</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">outbuffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;calculate new relative distance</span><span class="sc0">
  </span><span class="sc5">@@near</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@short</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;and patch</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@fix_jmp</span><span class="sc0">
  </span><span class="sc5">@@short</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">             </span><span class="sc1">;patch 8b displacement</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@fix_jmp</span><span class="sc0">

  </span><span class="sc5">@@done_fix_jmp</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">rnd0</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">is_signed</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">movsx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">fill_nops</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WORKSIZE</span><span class="sc0">                     </span><span class="sc1">;fill outbuffer with NOPs</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">GetAnyReg</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc5">random_value</span><span class="sc0">                     </span><span class="sc1">;get random number between 0..7</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">                   </span><span class="sc1">;that correspond to the eax..edi range</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">ESP_</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">GetAnyReg</span><span class="sc0">                     </span><span class="sc1">;cant be ESP</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">Get8bitRegFree</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">registers</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01111b</span><span class="sc0">                  </span><span class="sc1">;just keep the e?x registers</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01111b</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@somefree</span><span class="sc0">                   </span><span class="sc1">;all are in use?</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                              </span><span class="sc1">;yeahh, error...</span><span class="sc0">
  </span><span class="sc5">@@somefree</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc5">random_value</span><span class="sc0">                     </span><span class="sc1">;choose a register that have 8 bits</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">011b</span><span class="sc0">                    </span><span class="sc1">;al,cl,dl,bl</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;is used? choose another</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@somefree</span><span class="sc0">
       </span><span class="sc5">coin</span><span class="sc0">                    </span><span class="sc1">;random flag</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@lowpart</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100b</span><span class="sc0">                     </span><span class="sc1">;turn to hi-part (ah,ch,dh,bh)</span><span class="sc0">
  </span><span class="sc5">@@lowpart</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">Get32bitRegFree</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc5">_EAX</span><span class="sc4">+</span><span class="sc5">_ECX</span><span class="sc4">+</span><span class="sc5">_EDX</span><span class="sc4">+</span><span class="sc5">_EBX</span><span class="sc4">+</span><span class="sc5">_EBP</span><span class="sc4">+</span><span class="sc5">_ESI</span><span class="sc4">+</span><span class="sc5">_EDI</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@retry</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
  </span><span class="sc5">@@retry</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetAnyReg</span><span class="sc0">                   </span><span class="sc1">;get a 32bit reg</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@retry</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">garble</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">recurse</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">recurse</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAX_RECURSION</span><span class="sc0">                </span><span class="sc1">;we cant left this routine go</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">__too_deep</span><span class="sc0">                       </span><span class="sc1">;very deep recursively</span><span class="sc0">

       </span><span class="sc5">random_value</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111b</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">__too_deep</span><span class="sc0">                       </span><span class="sc1">;no garbling this time</span><span class="sc0">

       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc5">_DOUBLE</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">__next_garble</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
  </span><span class="sc5">__next_garble</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">number_of_garbling_routines</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">number_of_garbling_routines</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">                          </span><span class="sc1">;in the table</span><span class="sc0">

       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;       grb change_eip</span><span class="sc0">
       </span><span class="sc5">grb</span><span class="sc0"> </span><span class="sc5">lea_dword</span><span class="sc0">
       </span><span class="sc5">grb</span><span class="sc0"> </span><span class="sc5">math_byte</span><span class="sc0">
       </span><span class="sc5">grb</span><span class="sc0"> </span><span class="sc5">math_dword</span><span class="sc0">
       </span><span class="sc5">grb</span><span class="sc0"> </span><span class="sc5">movr_byte</span><span class="sc0">
       </span><span class="sc5">grb</span><span class="sc0"> </span><span class="sc5">movr_dword</span><span class="sc0">
       </span><span class="sc5">grb</span><span class="sc0"> </span><span class="sc5">mov_dword</span><span class="sc0">
       </span><span class="sc5">grb</span><span class="sc0"> </span><span class="sc5">mov_word</span><span class="sc0">
       </span><span class="sc5">grb</span><span class="sc0"> </span><span class="sc5">mov_byte</span><span class="sc0">
       </span><span class="sc5">grb</span><span class="sc0"> </span><span class="sc5">inc_dec</span><span class="sc0">
       </span><span class="sc5">grb</span><span class="sc0"> </span><span class="sc5">mov_zs_x</span><span class="sc0">
 </span><span class="sc1">;       grb mem_read</span><span class="sc0">
 </span><span class="sc1">;       grb mem_readb</span><span class="sc0">
</span><span class="sc1">;       grb push_pop</span><span class="sc0">
</span><span class="sc1">;       grb cmp_jcc</span><span class="sc0">
</span><span class="sc1">;       grb cmp_jcc_rr</span><span class="sc0">
</span><span class="sc1">;       grb __make_jcc</span><span class="sc0">
</span><span class="sc1">;       grb push_pop_free</span><span class="sc0">
       </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

  </span><span class="sc5">__nograble</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">__next_garble</span><span class="sc0">

  </span><span class="sc5">__too_deep</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">recurse</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">          </span><span class="sc1">;actualize copy of edi in stack</span><span class="sc0">
  </span><span class="sc5">__error666</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">lea_dword</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get32bitRegFree</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8dh</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetAnyReg</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
  </span><span class="sc5">__store_rnd_dword</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc5">random_value</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
  </span><span class="sc5">__ret</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">math_byte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc5">FLAGS_</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">__ret</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000000011000000b</span><span class="sc0">               </span><span class="sc1">;make math operation</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get8bitRegFree</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">__ret</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
  </span><span class="sc5">__store_rnd_byte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc5">random_value</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">;byte</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">math_dword</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc5">FLAGS_</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">__ret</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08100h</span><span class="sc4">+(</span><span class="sc2">011000000b</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get32bitRegFree</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;patch reg into</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__store_rnd_dword</span><span class="sc0">


</span><span class="sc5">push_pop</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get32bitRegFree</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetAnyReg</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble</span><span class="sc0">                             </span><span class="sc1">;recurse into</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
  </span><span class="sc5">@@no_free4pop</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">movr_byte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get8bitRegFree</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">__ret</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08ah</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_reg_reg</span><span class="sc0">


</span><span class="sc5">movr_dword</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get32bitRegFree</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08bh</span><span class="sc0">
  </span><span class="sc5">_reg_reg</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetAnyReg</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;outbuffer</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">mov_dword</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get32bitRegFree</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__store_rnd_dword</span><span class="sc0">


</span><span class="sc5">mov_word</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get32bitRegFree</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b866h</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
  </span><span class="sc5">__store_rnd_word</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc5">random_value</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">mov_byte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get8bitRegFree</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">__ret</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b0h</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__store_rnd_byte</span><span class="sc0">


</span><span class="sc5">inc_dec</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc5">FLAGS_</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">__ret</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get32bitRegFree</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc5">coin</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@set_bit</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01000b</span><span class="sc0">                           </span><span class="sc1">;inc/dec</span><span class="sc0">
  </span><span class="sc5">@@set_bit</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">mov_zs_x</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get32bitRegFree</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc5">coin</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b60fh</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@zero</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0beh</span><span class="sc0">                            </span><span class="sc1">;z/s</span><span class="sc0">
  </span><span class="sc5">@@zero</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc5">coin</span><span class="sc0">
       </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;16/8</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetAnyReg</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">cmp_jcc</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc5">FLAGS_</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">__ret</span><span class="sc0">

       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc5">coin</span><span class="sc0">
       </span><span class="sc6">setc</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetAnyReg</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@no_eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3dh</span><span class="sc0">              </span><span class="sc1">;eax version of CMP</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@is_byte</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;byte...</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@is_byte</span><span class="sc0">

  </span><span class="sc5">@@no_eax</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
  </span><span class="sc5">@@sto_byte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@no_byte</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@@no_byte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">            </span><span class="sc1">;81/80</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc0">      </span><span class="sc1">;mod/rm</span><span class="sc0">

  </span><span class="sc5">@@is_byte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc5">random_value</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@dword</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__make_jcc</span><span class="sc0">
  </span><span class="sc5">@@dword</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__make_jcc</span><span class="sc0">


</span><span class="sc5">cmp_jcc_rr</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc5">FLAGS_</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">__ret</span><span class="sc0">
       </span><span class="sc5">random_value</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0011111100000011b</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">1100000000111000b</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;       jmp __make_jcc</span><span class="sc0">

  </span><span class="sc5">__make_jcc</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc5">FLAGS_</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">__ret</span><span class="sc0">
       </span><span class="sc5">random_value</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0111100000000b</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">800fh</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">;correct JCC</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">mem_readb</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get8bitRegFree</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">__ret</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">CRC_POLY</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__build_mem</span><span class="sc0">


</span><span class="sc5">mem_read</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get32bitRegFree</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

  </span><span class="sc5">__build_mem</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc5">FLAGS_</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">__ret</span><span class="sc0">

       </span><span class="sc5">random_value</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">011b</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;ecx==0/8/16/24</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03131B2Bh</span><span class="sc0">
       </span><span class="sc5">coin</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@@dis_set</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">333B858Bh</span><span class="sc0">
  </span><span class="sc5">@@dis_set</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">

       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;is byte?</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@blahh</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;use byte form</span><span class="sc0">
  </span><span class="sc5">@@blahh</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">101b</span><span class="sc0">

       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@no_eax</span><span class="sc0">                     </span><span class="sc1">;is eax?</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">08ah</span><span class="sc0">              </span><span class="sc1">;is mov?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@_eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">08bh</span><span class="sc0">              </span><span class="sc1">;is mov?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@@no_eax</span><span class="sc0">
  </span><span class="sc5">@@_eax</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0a1h</span><span class="sc4">-</span><span class="sc2">08bh</span><span class="sc0">             </span><span class="sc1">;use short eax form!</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@mem_address</span><span class="sc0">

  </span><span class="sc5">@@no_eax</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
  </span><span class="sc5">@@mem_address</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">data_size</span><span class="sc4">+</span><span class="sc5">virtual_data_size</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">DATA_OFS</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">push_pop_free</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">registers</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">_EAX</span><span class="sc4">+</span><span class="sc5">_ECX</span><span class="sc4">+</span><span class="sc5">_EDX</span><span class="sc4">+</span><span class="sc5">_EBX</span><span class="sc4">+</span><span class="sc5">_EBP</span><span class="sc4">+</span><span class="sc5">_ESI</span><span class="sc4">+</span><span class="sc5">_EDI</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@no_used_reg</span><span class="sc0">

  </span><span class="sc5">@@free_this</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetAnyReg</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@@free_this</span><span class="sc0">

       </span><span class="sc6">btr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">garble</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01111100011111000b</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5850h</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@skip_nops</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">9090h</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
  </span><span class="sc5">@@skip_nops</span><span class="sc4">:</span><span class="sc0">

  </span><span class="sc5">@@no_used_reg</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">registers</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">


</span></div></body>
</html>
